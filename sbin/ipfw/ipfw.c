begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1994 Ugen J.S.Antsilevich  * Idea and grammar partially left from:  * Copyright (c) 1993 Daniel Boulet  *  * Redistribution and use in source forms, with and without modification,  * are permitted provided that this entire comment appears intact.  *  * Redistribution in binary form may occur without any restrictions.  * Obviously, it would be nice if you gave credit where credit is due  * but requiring it would be too onerous.  *  * This software is provided ``AS IS'' without any warranties of any kind.  *  * NEW command line interface for IP firewall facility  *  * $Id: ipfw.c,v 1.18 1995/10/23 03:57:28 ugen Exp $  *  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<kvm.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_define
define|#
directive|define
name|IPFIREWALL
end_define

begin_include
include|#
directive|include
file|<netinet/ip_fw.h>
end_include

begin_define
define|#
directive|define
name|MAXSTR
value|25
end_define

begin_decl_stmt
name|char
name|progname
index|[
name|MAXSTR
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Program name for errors */
end_comment

begin_decl_stmt
name|char
name|proto_name
index|[
name|MAXSTR
index|]
init|=
literal|""
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Current line protocol   */
end_comment

begin_decl_stmt
name|int
name|s
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* main RAW socket 	   */
end_comment

begin_decl_stmt
name|int
name|do_resolv
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Would try to resolv all */
end_comment

begin_decl_stmt
name|int
name|do_short
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Compact output          */
end_comment

begin_decl_stmt
name|int
name|do_acct
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Show packet/byte count  */
end_comment

begin_decl_stmt
name|int
name|ports_ok
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* flag allowing ports     */
end_comment

begin_decl_stmt
name|u_short
name|flags
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* New entry flags 	   */
end_comment

begin_define
define|#
directive|define
name|FW
value|0x001
end_define

begin_comment
comment|/* Firewall action   */
end_comment

begin_define
define|#
directive|define
name|S_ANY
value|"any"
end_define

begin_define
define|#
directive|define
name|IS_TO
parameter_list|(
name|x
parameter_list|)
value|(!strcmp(x,"to"))
end_define

begin_define
define|#
directive|define
name|IS_FROM
parameter_list|(
name|x
parameter_list|)
value|(!strcmp(x,"from"))
end_define

begin_define
define|#
directive|define
name|IS_VIA
parameter_list|(
name|x
parameter_list|)
value|(!strcmp(x,"via") || !strcmp(x,"on"))
end_define

begin_define
define|#
directive|define
name|IS_IPOPT
parameter_list|(
name|x
parameter_list|)
value|(!strncmp(x,"ipop",4) || !strncmp(x,"opt",3))
end_define

begin_define
define|#
directive|define
name|IS_TCPFLG
parameter_list|(
name|x
parameter_list|)
value|(!strncmp(x,"tcpf",4) || !strncmp(x,"fla",3))
end_define

begin_define
define|#
directive|define
name|IS_TOKEN
parameter_list|(
name|x
parameter_list|)
value|(IS_TO(x) || IS_FROM(x) || IS_VIA(x) ||\ 				     IS_IPOPT(x) || IS_TCPFLG(x))
end_define

begin_define
define|#
directive|define
name|IPO_LSRR
value|"ls"
end_define

begin_define
define|#
directive|define
name|IPO_SSRR
value|"ss"
end_define

begin_define
define|#
directive|define
name|IPO_RR
value|"rr"
end_define

begin_define
define|#
directive|define
name|IPO_TS
value|"ts"
end_define

begin_define
define|#
directive|define
name|TCPF_FIN
value|"fin"
end_define

begin_define
define|#
directive|define
name|TCPF_SYN
value|"syn"
end_define

begin_define
define|#
directive|define
name|TCPF_RST
value|"rst"
end_define

begin_define
define|#
directive|define
name|TCPF_PUSH
value|"pus"
end_define

begin_define
define|#
directive|define
name|TCPF_ACK
value|"ack"
end_define

begin_define
define|#
directive|define
name|TCPF_URG
value|"urg"
end_define

begin_define
define|#
directive|define
name|CH_FW
value|"f"
end_define

begin_comment
comment|/* of "firewall" for chains in zero/flush       */
end_comment

begin_decl_stmt
name|char
name|action_tab
index|[]
index|[
name|MAXSTR
index|]
init|=
block|{
literal|"addf"
block|,
define|#
directive|define
name|A_ADDF
value|0
literal|"delf"
block|,
define|#
directive|define
name|A_DELF
value|1
literal|"chkf"
block|,
define|#
directive|define
name|A_CHKF
value|2
literal|"adda"
block|,
define|#
directive|define
name|A_ADDA
value|3
literal|"dela"
block|,
define|#
directive|define
name|A_DELA
value|4
literal|"clr"
block|,
define|#
directive|define
name|A_CLRA
value|5
literal|"f"
block|,
define|#
directive|define
name|A_FLUSH
value|6
literal|"z"
block|,
define|#
directive|define
name|A_ZERO
value|7
literal|"l"
block|,
define|#
directive|define
name|A_LIST
value|8
literal|"po"
block|,
define|#
directive|define
name|A_POLICY
value|9
literal|""
block|,
define|#
directive|define
name|A_NONE
value|10
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|type_tab
index|[]
index|[
name|MAXSTR
index|]
init|=
block|{
literal|"acc"
block|,
define|#
directive|define
name|T_ACCEPT
value|0
literal|"pas"
block|,
define|#
directive|define
name|T_PASS
value|1
literal|"log"
block|,
define|#
directive|define
name|T_LOG
value|2
literal|"rej"
block|,
define|#
directive|define
name|T_REJECT
value|3
literal|"lrej"
block|,
define|#
directive|define
name|T_LREJECT
value|4
literal|"den"
block|,
define|#
directive|define
name|T_DENY
value|5
literal|"lden"
block|,
define|#
directive|define
name|T_LDENY
value|6
literal|"sin"
block|,
define|#
directive|define
name|T_SINGLE
value|7
literal|""
block|,
define|#
directive|define
name|T_NONE
value|9
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|proto_tab
index|[]
index|[
name|MAXSTR
index|]
init|=
block|{
literal|"all"
block|,
define|#
directive|define
name|P_ALL
value|0
literal|"icmp"
block|,
define|#
directive|define
name|P_ICMP
value|1
literal|"tcp"
block|,
define|#
directive|define
name|P_TCP
value|2
literal|"udp"
block|,
define|#
directive|define
name|P_UDP
value|3
literal|""
define|#
directive|define
name|P_NONE
value|4
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|nlist
name|nlf
index|[]
init|=
block|{
define|#
directive|define
name|N_FCHAIN
value|0
block|{
literal|"_ip_fw_chain"
block|}
block|,
literal|""
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|nlist
name|nla
index|[]
init|=
block|{
define|#
directive|define
name|N_ACHAIN
value|0
block|{
literal|"_ip_acct_chain"
block|}
block|,
literal|""
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|mask_bits
parameter_list|(
name|m_ad
parameter_list|)
name|struct
name|in_addr
name|m_ad
decl_stmt|;
block|{
name|int
name|h_fnd
init|=
literal|0
decl_stmt|,
name|h_num
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|u_long
name|mask
decl_stmt|;
name|mask
operator|=
name|ntohl
argument_list|(
name|m_ad
operator|.
name|s_addr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
operator|*
name|CHAR_BIT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mask
operator|&
literal|1L
condition|)
block|{
name|h_fnd
operator|=
literal|1
expr_stmt|;
name|h_num
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|h_fnd
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|mask
operator|=
name|mask
operator|>>
literal|1
expr_stmt|;
block|}
return|return
name|h_num
return|;
block|}
end_function

begin_function
name|void
name|show_ipfw
parameter_list|(
name|chain
parameter_list|,
name|c_t
parameter_list|)
name|struct
name|ip_fw
modifier|*
name|chain
decl_stmt|;
name|int
name|c_t
decl_stmt|;
block|{
name|char
modifier|*
name|comma
decl_stmt|;
name|u_long
name|adrt
decl_stmt|;
name|struct
name|hostent
modifier|*
name|he
decl_stmt|;
name|int
name|i
decl_stmt|,
name|mb
decl_stmt|;
name|printf
argument_list|(
literal|"%05u "
argument_list|,
name|chain
operator|->
name|fw_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_acct
condition|)
block|{
name|printf
argument_list|(
literal|"%10u %10u "
argument_list|,
name|chain
operator|->
name|fw_bcnt
argument_list|,
name|chain
operator|->
name|fw_pcnt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_short
condition|)
block|{
if|if
condition|(
name|c_t
operator|==
name|FW
condition|)
block|{
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_ACCEPT
condition|)
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_PRN
condition|)
name|printf
argument_list|(
literal|" l"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" a"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_PRN
condition|)
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_ICMPRPL
condition|)
name|printf
argument_list|(
literal|"lr"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"ld"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_ICMPRPL
condition|)
name|printf
argument_list|(
literal|" r"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" d"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_PRN
condition|)
name|printf
argument_list|(
literal|"l"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_ACCEPT
condition|)
name|printf
argument_list|(
literal|"accept "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_ICMPRPL
condition|)
name|printf
argument_list|(
literal|"reject "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"deny "
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_short
condition|)
switch|switch
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_KIND
condition|)
block|{
case|case
name|IP_FW_F_ICMP
case|:
name|printf
argument_list|(
literal|"I "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IP_FW_F_TCP
case|:
name|printf
argument_list|(
literal|"T "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IP_FW_F_UDP
case|:
name|printf
argument_list|(
literal|"U "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IP_FW_F_ALL
case|:
name|printf
argument_list|(
literal|"A "
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
else|else
switch|switch
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_KIND
condition|)
block|{
case|case
name|IP_FW_F_ICMP
case|:
name|printf
argument_list|(
literal|"icmp "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IP_FW_F_TCP
case|:
name|printf
argument_list|(
literal|"tcp  "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IP_FW_F_UDP
case|:
name|printf
argument_list|(
literal|"udp  "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IP_FW_F_ALL
case|:
name|printf
argument_list|(
literal|"all  "
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|do_short
condition|)
name|printf
argument_list|(
literal|"["
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"from "
argument_list|)
expr_stmt|;
name|adrt
operator|=
name|ntohl
argument_list|(
name|chain
operator|->
name|fw_smsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|adrt
operator|==
name|ULONG_MAX
operator|&&
name|do_resolv
condition|)
block|{
name|adrt
operator|=
operator|(
name|chain
operator|->
name|fw_src
operator|.
name|s_addr
operator|)
expr_stmt|;
name|he
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|adrt
argument_list|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|he
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_src
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|adrt
operator|!=
name|ULONG_MAX
condition|)
block|{
name|mb
operator|=
name|mask_bits
argument_list|(
name|chain
operator|->
name|fw_smsk
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"any"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mb
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_src
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%d"
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_src
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_smsk
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_src
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|comma
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chain
operator|->
name|fw_nsp
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s%d"
argument_list|,
name|comma
argument_list|,
name|chain
operator|->
name|fw_pts
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
operator|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_SRNG
operator|)
condition|)
name|comma
operator|=
literal|":"
expr_stmt|;
else|else
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|do_short
condition|)
name|printf
argument_list|(
literal|"]["
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" to "
argument_list|)
expr_stmt|;
name|adrt
operator|=
name|ntohl
argument_list|(
name|chain
operator|->
name|fw_dmsk
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|adrt
operator|==
name|ULONG_MAX
operator|&&
name|do_resolv
condition|)
block|{
name|adrt
operator|=
operator|(
name|chain
operator|->
name|fw_dst
operator|.
name|s_addr
operator|)
expr_stmt|;
name|he
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|adrt
argument_list|,
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|he
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|he
operator|->
name|h_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|adrt
operator|!=
name|ULONG_MAX
condition|)
block|{
name|mb
operator|=
name|mask_bits
argument_list|(
name|chain
operator|->
name|fw_dmsk
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"any"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mb
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_dst
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/%d"
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_dst
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_dmsk
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_dst
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|comma
operator|=
literal|" "
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chain
operator|->
name|fw_ndp
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s%d"
argument_list|,
name|comma
argument_list|,
name|chain
operator|->
name|fw_pts
index|[
name|chain
operator|->
name|fw_nsp
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|chain
operator|->
name|fw_nsp
operator|&&
operator|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_DRNG
operator|)
condition|)
name|comma
operator|=
literal|":"
expr_stmt|;
else|else
name|comma
operator|=
literal|","
expr_stmt|;
block|}
if|if
condition|(
name|chain
operator|->
name|fw_flg
operator|&
name|IP_FW_F_IFNAME
operator|&&
name|chain
operator|->
name|fw_via_name
index|[
literal|0
index|]
condition|)
block|{
name|char
name|ifnb
index|[
name|FW_IFNLEN
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|do_short
condition|)
name|printf
argument_list|(
literal|"]["
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" via "
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|ifnb
argument_list|,
name|chain
operator|->
name|fw_via_name
argument_list|,
name|FW_IFNLEN
argument_list|)
expr_stmt|;
name|ifnb
index|[
name|FW_IFNLEN
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"%s%d"
argument_list|,
name|ifnb
argument_list|,
name|chain
operator|->
name|fw_via_unit
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chain
operator|->
name|fw_via_ip
operator|.
name|s_addr
condition|)
block|{
if|if
condition|(
name|do_short
condition|)
name|printf
argument_list|(
literal|"]["
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" via "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|inet_ntoa
argument_list|(
name|chain
operator|->
name|fw_via_ip
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_short
condition|)
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|||
name|chain
operator|->
name|fw_ipnopt
condition|)
block|{
if|if
condition|(
name|do_short
condition|)
block|{
name|printf
argument_list|(
literal|"["
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_SSRR
condition|)
name|printf
argument_list|(
literal|"S"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_SSRR
condition|)
name|printf
argument_list|(
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_LSRR
condition|)
name|printf
argument_list|(
literal|"L"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_LSRR
condition|)
name|printf
argument_list|(
literal|"l"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_RR
condition|)
name|printf
argument_list|(
literal|"R"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_RR
condition|)
name|printf
argument_list|(
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_TS
condition|)
name|printf
argument_list|(
literal|"T"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_TS
condition|)
name|printf
argument_list|(
literal|"t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|_opt_printed
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|PRINTOPT
parameter_list|(
name|x
parameter_list|)
value|{if (_opt_printed) printf(",");\ 				printf(x); _opt_printed = 1;}
name|printf
argument_list|(
literal|" ipopt "
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_SSRR
condition|)
name|PRINTOPT
argument_list|(
literal|"ssrr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_SSRR
condition|)
name|PRINTOPT
argument_list|(
literal|"!ssrr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_LSRR
condition|)
name|PRINTOPT
argument_list|(
literal|"lsrr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_LSRR
condition|)
name|PRINTOPT
argument_list|(
literal|"!lsrr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_RR
condition|)
name|PRINTOPT
argument_list|(
literal|"rr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_RR
condition|)
name|PRINTOPT
argument_list|(
literal|"!rr"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipopt
operator|&
name|IP_FW_IPOPT_TS
condition|)
name|PRINTOPT
argument_list|(
literal|"ts"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_ipnopt
operator|&
name|IP_FW_IPOPT_TS
condition|)
name|PRINTOPT
argument_list|(
literal|"!ts"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|||
name|chain
operator|->
name|fw_tcpnf
condition|)
block|{
if|if
condition|(
name|do_short
condition|)
block|{
name|printf
argument_list|(
literal|"[*"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_FIN
condition|)
name|printf
argument_list|(
literal|"F"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_FIN
condition|)
name|printf
argument_list|(
literal|"f"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_SYN
condition|)
name|printf
argument_list|(
literal|"S"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_SYN
condition|)
name|printf
argument_list|(
literal|"s"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_RST
condition|)
name|printf
argument_list|(
literal|"R"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_RST
condition|)
name|printf
argument_list|(
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_PUSH
condition|)
name|printf
argument_list|(
literal|"P"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_PUSH
condition|)
name|printf
argument_list|(
literal|"p"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_ACK
condition|)
name|printf
argument_list|(
literal|"A"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_ACK
condition|)
name|printf
argument_list|(
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_URG
condition|)
name|printf
argument_list|(
literal|"U"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_URG
condition|)
name|printf
argument_list|(
literal|"u"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|_flg_printed
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|PRINTFLG
parameter_list|(
name|x
parameter_list|)
value|{if (_flg_printed) printf(",");\ 				printf(x); _flg_printed = 1;}
name|printf
argument_list|(
literal|" tcpflg "
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_FIN
condition|)
name|PRINTFLG
argument_list|(
literal|"fin"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_FIN
condition|)
name|PRINTFLG
argument_list|(
literal|"!fin"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_SYN
condition|)
name|PRINTFLG
argument_list|(
literal|"syn"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_SYN
condition|)
name|PRINTFLG
argument_list|(
literal|"!syn"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_RST
condition|)
name|PRINTFLG
argument_list|(
literal|"rst"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_RST
condition|)
name|PRINTFLG
argument_list|(
literal|"!rst"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_PUSH
condition|)
name|PRINTFLG
argument_list|(
literal|"push"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_PUSH
condition|)
name|PRINTFLG
argument_list|(
literal|"!push"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_ACK
condition|)
name|PRINTFLG
argument_list|(
literal|"ack"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_ACK
condition|)
name|PRINTFLG
argument_list|(
literal|"!ack"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpf
operator|&
name|IP_FW_TCPF_URG
condition|)
name|PRINTFLG
argument_list|(
literal|"urg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|fw_tcpnf
operator|&
name|IP_FW_TCPF_URG
condition|)
name|PRINTFLG
argument_list|(
literal|"!urg"
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|list
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|kvm_t
modifier|*
name|kd
decl_stmt|;
specifier|static
name|char
name|errb
index|[
name|_POSIX2_LINE_MAX
index|]
decl_stmt|;
name|struct
name|ip_fw
name|b
decl_stmt|,
modifier|*
name|btmp
decl_stmt|;
name|struct
name|ip_fw_chain
modifier|*
name|fcp
decl_stmt|,
name|fc
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|kd
operator|=
name|kvm_openfiles
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|O_RDONLY
argument_list|,
name|errb
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: kvm_openfiles: %s\n"
argument_list|,
name|progname
argument_list|,
name|kvm_geterr
argument_list|(
name|kd
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
operator|||
operator|!
name|strncmp
argument_list|(
operator|*
name|av
argument_list|,
name|CH_FW
argument_list|,
name|strlen
argument_list|(
name|CH_FW
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|kvm_nlist
argument_list|(
name|kd
argument_list|,
name|nlf
argument_list|)
operator|<
literal|0
operator|||
name|nlf
index|[
literal|0
index|]
operator|.
name|n_type
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: kvm_nlist: no namelist in %s\n"
argument_list|,
name|progname
argument_list|,
name|getbootfile
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|kvm_read
argument_list|(
name|kd
argument_list|,
operator|(
name|u_long
operator|)
name|nlf
index|[
name|N_FCHAIN
index|]
operator|.
name|n_value
argument_list|,
operator|&
name|fcp
argument_list|,
sizeof|sizeof
name|fcp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FireWall chain entries:\n"
argument_list|)
expr_stmt|;
while|while
condition|(
name|fcp
operator|!=
name|NULL
condition|)
block|{
name|kvm_read
argument_list|(
name|kd
argument_list|,
operator|(
name|u_long
operator|)
name|fcp
argument_list|,
operator|&
name|fc
argument_list|,
sizeof|sizeof
name|fc
argument_list|)
expr_stmt|;
name|kvm_read
argument_list|(
name|kd
argument_list|,
operator|(
name|u_long
operator|)
name|fc
operator|.
name|rule
argument_list|,
operator|&
name|b
argument_list|,
sizeof|sizeof
name|b
argument_list|)
expr_stmt|;
name|show_ipfw
argument_list|(
operator|&
name|b
argument_list|,
name|FW
argument_list|)
expr_stmt|;
name|fcp
operator|=
name|fc
operator|.
name|chain
operator|.
name|le_next
expr_stmt|;
block|}
block|}
block|}
end_block

begin_function
name|int
name|get_num
parameter_list|(
name|str
parameter_list|,
name|tab
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|char
name|tab
index|[]
index|[
name|MAXSTR
index|]
decl_stmt|;
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|tab
index|[
name|i
index|]
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|str
argument_list|)
operator|>=
name|strlen
argument_list|(
name|tab
index|[
name|i
index|]
argument_list|)
condition|)
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|str
argument_list|,
name|tab
index|[
name|i
index|]
argument_list|,
name|strlen
argument_list|(
name|tab
index|[
name|i
index|]
argument_list|)
argument_list|)
condition|)
return|return
name|i
return|;
name|i
operator|++
expr_stmt|;
block|}
return|return
name|i
return|;
block|}
end_function

begin_function
name|void
name|show_usage
parameter_list|(
name|str
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
block|{
if|if
condition|(
name|str
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: ERROR - %s\n"
argument_list|,
name|progname
argument_list|,
name|str
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: ERROR - bad arguments\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"See man %s(8) for proper usage.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_short
name|get_port
parameter_list|(
name|str
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
block|{
name|struct
name|servent
modifier|*
name|sptr
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|int
name|port
decl_stmt|,
name|slen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|slen
operator|>
literal|0
operator|)
operator|&&
operator|(
name|strspn
argument_list|(
name|str
argument_list|,
literal|"0123456789"
argument_list|)
operator|==
name|slen
operator|)
condition|)
block|{
name|port
operator|=
name|strtol
argument_list|(
name|str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: illegal port number :%s\n"
argument_list|,
name|progname
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|port
operator|<=
literal|0
operator|)
operator|||
operator|(
name|port
operator|>
name|USHRT_MAX
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: port number out of range :%d\n"
argument_list|,
name|progname
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|u_short
operator|)
name|port
operator|)
return|;
block|}
else|else
block|{
name|sptr
operator|=
name|getservbyname
argument_list|(
name|str
argument_list|,
name|proto_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sptr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: unknown service :%s\n"
argument_list|,
name|progname
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|(
name|u_short
operator|)
name|ntohs
argument_list|(
name|sptr
operator|->
name|s_port
argument_list|)
operator|)
return|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|findchar
parameter_list|(
name|str
parameter_list|,
name|c
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|char
name|c
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|len
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
name|c
condition|)
return|return
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|str
index|[
name|i
index|]
operator|)
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|set_entry_ports
parameter_list|(
name|str
parameter_list|,
name|ports
parameter_list|,
name|a_max
parameter_list|,
name|is_range
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|u_short
modifier|*
name|ports
decl_stmt|;
name|int
name|a_max
decl_stmt|;
name|int
modifier|*
name|is_range
decl_stmt|;
block|{
name|char
modifier|*
name|s_pr2
decl_stmt|,
modifier|*
name|s_h
decl_stmt|,
modifier|*
name|s_t
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|u_short
name|p1
decl_stmt|,
name|p2
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
operator|(
name|void
operator|)
name|strtok
argument_list|(
name|str
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|s_pr2
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|s_pr2
condition|)
block|{
name|p1
operator|=
name|get_port
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|p2
operator|=
name|get_port
argument_list|(
name|s_pr2
argument_list|)
expr_stmt|;
if|if
condition|(
name|a_max
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: too many ports.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ports
index|[
literal|0
index|]
operator|=
name|p1
expr_stmt|;
name|ports
index|[
literal|1
index|]
operator|=
name|p2
expr_stmt|;
operator|*
name|is_range
operator|=
literal|1
expr_stmt|;
return|return
literal|2
return|;
block|}
name|s_h
operator|=
name|str
expr_stmt|;
while|while
condition|(
operator|(
name|cp
operator|=
name|findchar
argument_list|(
name|s_h
argument_list|,
literal|','
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|i
operator|>
name|a_max
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: too many ports.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|s_t
operator|=
operator|(
operator|++
name|cp
operator|)
operator|)
operator|==
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad port list.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ports
index|[
name|i
operator|++
index|]
operator|=
name|get_port
argument_list|(
name|s_h
argument_list|)
expr_stmt|;
name|s_h
operator|=
name|s_t
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|>
name|a_max
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: too many ports.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ports
index|[
name|i
index|]
operator|=
name|get_port
argument_list|(
name|s_h
argument_list|)
expr_stmt|;
operator|*
name|is_range
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|i
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|set_entry_ip
parameter_list|(
name|str
parameter_list|,
name|addr
parameter_list|,
name|mask
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|addr
decl_stmt|,
decl|*
name|mask
decl_stmt|;
end_function

begin_block
block|{
name|char
modifier|*
name|sm_bit
decl_stmt|,
modifier|*
name|sm_oct
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|n_bit
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hptr
decl_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|str
argument_list|,
name|S_ANY
argument_list|,
name|strlen
argument_list|(
name|S_ANY
argument_list|)
argument_list|)
condition|)
block|{
name|addr
operator|->
name|s_addr
operator|=
literal|0L
expr_stmt|;
name|mask
operator|->
name|s_addr
operator|=
literal|0L
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mask
condition|)
block|{
operator|(
name|void
operator|)
name|strtok
argument_list|(
name|str
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|sm_bit
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strtok
argument_list|(
name|str
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|sm_oct
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|str
argument_list|,
name|addr
argument_list|)
condition|)
block|{
if|if
condition|(
name|do_resolv
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|hptr
operator|=
name|gethostbyname
argument_list|(
name|str
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Unknown host name : %s\n"
argument_list|,
name|progname
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|->
name|s_addr
operator|=
operator|*
operator|(
operator|(
name|u_long
operator|*
operator|)
name|hptr
operator|->
name|h_addr
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Bad IP : %s\n"
argument_list|,
name|progname
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 		 * This is in case mask we 		 * want to set IP only 		 */
if|if
condition|(
operator|!
name|mask
condition|)
return|return;
name|mask
operator|->
name|s_addr
operator|=
name|htonl
argument_list|(
name|ULONG_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm_bit
condition|)
block|{
name|n_bit
operator|=
name|strtol
argument_list|(
name|sm_bit
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|end
operator|!=
literal|'\0'
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n_bit
operator|<
literal|0
operator|||
name|n_bit
operator|>
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
operator|*
name|CHAR_BIT
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n_bit
operator|>
literal|0
condition|)
name|mask
operator|->
name|s_addr
operator|=
name|htonl
argument_list|(
name|ULONG_MAX
operator|<<
operator|(
sizeof|sizeof
argument_list|(
name|u_long
argument_list|)
operator|*
name|CHAR_BIT
operator|-
name|n_bit
operator|)
argument_list|)
expr_stmt|;
else|else
name|mask
operator|->
name|s_addr
operator|=
literal|0L
expr_stmt|;
block|}
if|if
condition|(
name|sm_oct
condition|)
block|{
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|sm_oct
argument_list|,
name|mask
argument_list|)
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*  	 * Ugh..better of corse do it in kernel so no error possible 	 * but faster here so this way it goes... 	 */
name|addr
operator|->
name|s_addr
operator|=
name|mask
operator|->
name|s_addr
operator|&
name|addr
operator|->
name|s_addr
expr_stmt|;
block|}
end_block

begin_function
name|int
name|set_entry_ifname
parameter_list|(
name|str
parameter_list|,
name|frwl
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|struct
name|ip_fw
modifier|*
name|frwl
decl_stmt|;
block|{
name|char
name|name
index|[
name|IFNAMSIZ
index|]
decl_stmt|,
name|buf
index|[
name|IFNAMSIZ
index|]
decl_stmt|,
modifier|*
name|sptr
decl_stmt|;
name|short
name|unit
decl_stmt|;
name|int
name|i
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|sptr
operator|=
name|str
expr_stmt|;
while|while
condition|(
name|isalpha
argument_list|(
operator|*
name|sptr
operator|++
argument_list|)
condition|)
block|{
name|i
operator|++
expr_stmt|;
block|}
operator|*
name|sptr
operator|--
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|strncpy
argument_list|(
name|name
argument_list|,
name|str
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|name
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|unit
operator|=
operator|(
name|short
operator|)
name|atoi
argument_list|(
name|sptr
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s%d"
argument_list|,
name|name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|str
argument_list|,
name|buf
argument_list|)
condition|)
return|return
literal|1
return|;
name|strncpy
argument_list|(
name|frwl
operator|->
name|fw_via_name
argument_list|,
name|name
argument_list|,
name|FW_IFNLEN
argument_list|)
expr_stmt|;
name|frwl
operator|->
name|fw_via_unit
operator|=
name|unit
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|set_entry_ipopts
parameter_list|(
name|str
parameter_list|,
name|frwl
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|struct
name|ip_fw
modifier|*
name|frwl
decl_stmt|;
block|{
name|char
modifier|*
name|t_str
decl_stmt|,
modifier|*
name|p_str
decl_stmt|;
name|u_char
modifier|*
name|optr
decl_stmt|;
name|p_str
operator|=
name|str
expr_stmt|;
while|while
condition|(
operator|(
name|t_str
operator|=
name|strtok
argument_list|(
name|p_str
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|p_str
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|t_str
index|[
literal|0
index|]
operator|==
literal|'!'
condition|)
block|{
name|optr
operator|=
operator|&
operator|(
name|frwl
operator|->
name|fw_ipnopt
operator|)
expr_stmt|;
name|t_str
operator|++
expr_stmt|;
block|}
else|else
name|optr
operator|=
operator|&
operator|(
name|frwl
operator|->
name|fw_ipopt
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|IPO_LSRR
argument_list|,
name|strlen
argument_list|(
name|IPO_LSRR
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|optr
operator|)
operator||=
name|IP_FW_IPOPT_LSRR
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|IPO_SSRR
argument_list|,
name|strlen
argument_list|(
name|IPO_SSRR
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|optr
operator|)
operator||=
name|IP_FW_IPOPT_SSRR
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|IPO_RR
argument_list|,
name|strlen
argument_list|(
name|IPO_RR
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|optr
operator|)
operator||=
name|IP_FW_IPOPT_RR
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|IPO_TS
argument_list|,
name|strlen
argument_list|(
name|IPO_TS
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|optr
operator|)
operator||=
name|IP_FW_IPOPT_TS
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad ip option.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|set_entry_tcpflgs
parameter_list|(
name|str
parameter_list|,
name|frwl
parameter_list|)
name|char
modifier|*
name|str
decl_stmt|;
name|struct
name|ip_fw
modifier|*
name|frwl
decl_stmt|;
block|{
name|char
modifier|*
name|t_str
decl_stmt|,
modifier|*
name|p_str
decl_stmt|;
name|u_char
modifier|*
name|fptr
decl_stmt|;
name|p_str
operator|=
name|str
expr_stmt|;
while|while
condition|(
operator|(
name|t_str
operator|=
name|strtok
argument_list|(
name|p_str
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|p_str
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|t_str
index|[
literal|0
index|]
operator|==
literal|'!'
condition|)
block|{
name|fptr
operator|=
operator|&
operator|(
name|frwl
operator|->
name|fw_tcpnf
operator|)
expr_stmt|;
name|t_str
operator|++
expr_stmt|;
block|}
else|else
name|fptr
operator|=
operator|&
operator|(
name|frwl
operator|->
name|fw_tcpf
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|TCPF_FIN
argument_list|,
name|strlen
argument_list|(
name|TCPF_FIN
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|fptr
operator|)
operator||=
name|IP_FW_TCPF_FIN
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|TCPF_SYN
argument_list|,
name|strlen
argument_list|(
name|TCPF_SYN
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|fptr
operator|)
operator||=
name|IP_FW_TCPF_SYN
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|TCPF_RST
argument_list|,
name|strlen
argument_list|(
name|TCPF_RST
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|fptr
operator|)
operator||=
name|IP_FW_TCPF_RST
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|TCPF_PUSH
argument_list|,
name|strlen
argument_list|(
name|TCPF_PUSH
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|fptr
operator|)
operator||=
name|IP_FW_TCPF_PUSH
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|TCPF_ACK
argument_list|,
name|strlen
argument_list|(
name|TCPF_ACK
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|fptr
operator|)
operator||=
name|IP_FW_TCPF_ACK
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|t_str
argument_list|,
name|TCPF_URG
argument_list|,
name|strlen
argument_list|(
name|TCPF_URG
argument_list|)
argument_list|)
condition|)
operator|*
operator|(
name|fptr
operator|)
operator||=
name|IP_FW_TCPF_URG
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad tcp flag.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|set_entry
parameter_list|(
name|av
parameter_list|,
name|frwl
parameter_list|)
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
name|struct
name|ip_fw
modifier|*
name|frwl
decl_stmt|;
block|{
name|int
name|ir
decl_stmt|;
name|int
name|got_from
init|=
literal|0
decl_stmt|,
name|got_to
init|=
literal|0
decl_stmt|,
name|got_via
init|=
literal|0
decl_stmt|,
name|got_ipopt
init|=
literal|0
decl_stmt|,
name|got_tcpflg
init|=
literal|0
decl_stmt|;
define|#
directive|define
name|T_FROM
value|1
define|#
directive|define
name|T_TO
value|2
define|#
directive|define
name|T_VIA
value|3
define|#
directive|define
name|T_IPOPT
value|4
define|#
directive|define
name|T_TCPFLG
value|5
name|int
name|token
decl_stmt|;
comment|/* 	 * This section actually creates 	 * generic entry which matches everything 	 * in this sorry world... 	 */
name|frwl
operator|->
name|fw_nsp
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_ndp
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_ipopt
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_ipnopt
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_tcpf
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_tcpnf
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_via_ip
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
name|frwl
operator|->
name|fw_src
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
name|frwl
operator|->
name|fw_dst
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
name|frwl
operator|->
name|fw_smsk
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
name|frwl
operator|->
name|fw_dmsk
operator|.
name|s_addr
operator|=
literal|0L
expr_stmt|;
name|get_next
label|:
name|token
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IS_FROM
argument_list|(
operator|*
name|av
argument_list|)
condition|)
block|{
name|token
operator|=
name|T_FROM
expr_stmt|;
if|if
condition|(
name|got_from
condition|)
block|{
name|show_usage
argument_list|(
literal|"Redefined 'from'."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
literal|"Missing 'from' specification."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|set_entry_ip
argument_list|(
operator|*
name|av
argument_list|,
operator|&
operator|(
name|frwl
operator|->
name|fw_src
operator|)
argument_list|,
operator|&
operator|(
name|frwl
operator|->
name|fw_smsk
operator|)
argument_list|)
expr_stmt|;
name|got_from
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_TO
argument_list|(
operator|*
name|av
argument_list|)
condition|)
block|{
name|token
operator|=
name|T_TO
expr_stmt|;
if|if
condition|(
name|got_to
condition|)
block|{
name|show_usage
argument_list|(
literal|"Redefined 'to'."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
literal|"Missing 'to' specification."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|set_entry_ip
argument_list|(
operator|*
name|av
argument_list|,
operator|&
operator|(
name|frwl
operator|->
name|fw_dst
operator|)
argument_list|,
operator|&
operator|(
name|frwl
operator|->
name|fw_dmsk
operator|)
argument_list|)
expr_stmt|;
name|got_to
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_VIA
argument_list|(
operator|*
name|av
argument_list|)
condition|)
block|{
name|token
operator|=
name|T_VIA
expr_stmt|;
if|if
condition|(
name|got_via
condition|)
block|{
name|show_usage
argument_list|(
literal|"Redefined 'via'."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
literal|"Missing 'via' specification."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 	 	 * Try first to set interface name 		 * from arguments.set_entry_ip() will exit on 		 * wrong argument. 		 */
if|if
condition|(
name|set_entry_ifname
argument_list|(
operator|*
name|av
argument_list|,
name|frwl
argument_list|)
condition|)
name|set_entry_ip
argument_list|(
operator|*
name|av
argument_list|,
operator|&
operator|(
name|frwl
operator|->
name|fw_via_ip
operator|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|flags
operator||=
name|IP_FW_F_IFNAME
expr_stmt|;
name|got_via
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_IPOPT
argument_list|(
operator|*
name|av
argument_list|)
condition|)
block|{
name|token
operator|=
name|T_IPOPT
expr_stmt|;
if|if
condition|(
name|got_ipopt
condition|)
block|{
name|show_usage
argument_list|(
literal|"Redefined 'ipoptions'."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
literal|"Missing 'ipoptions' specification."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|set_entry_ipopts
argument_list|(
operator|*
name|av
argument_list|,
name|frwl
argument_list|)
expr_stmt|;
name|got_ipopt
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|IS_TCPFLG
argument_list|(
operator|*
name|av
argument_list|)
condition|)
block|{
name|token
operator|=
name|T_TCPFLG
expr_stmt|;
if|if
condition|(
name|got_tcpflg
condition|)
block|{
name|show_usage
argument_list|(
literal|"Redefined 'tcpflags'."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
literal|"Missing 'tcpflags' specification."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|set_entry_tcpflgs
argument_list|(
operator|*
name|av
argument_list|,
name|frwl
argument_list|)
expr_stmt|;
name|got_tcpflg
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|IS_TOKEN
argument_list|(
operator|*
name|av
argument_list|)
condition|)
goto|goto
name|get_next
goto|;
if|if
condition|(
name|ports_ok
operator|&&
name|token
operator|==
name|T_FROM
condition|)
block|{
name|ir
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_nsp
operator|=
name|set_entry_ports
argument_list|(
operator|*
name|av
argument_list|,
name|frwl
operator|->
name|fw_pts
argument_list|,
name|IP_FW_MAX_PORTS
argument_list|,
operator|&
name|ir
argument_list|)
expr_stmt|;
if|if
condition|(
name|ir
condition|)
name|flags
operator||=
name|IP_FW_F_SRNG
expr_stmt|;
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
block|}
if|if
condition|(
name|ports_ok
operator|&&
name|token
operator|==
name|T_TO
condition|)
block|{
name|ir
operator|=
literal|0
expr_stmt|;
name|frwl
operator|->
name|fw_ndp
operator|=
name|set_entry_ports
argument_list|(
operator|*
name|av
argument_list|,
operator|&
operator|(
name|frwl
operator|->
name|fw_pts
index|[
name|frwl
operator|->
name|fw_nsp
index|]
operator|)
argument_list|,
operator|(
name|IP_FW_MAX_PORTS
operator|-
name|frwl
operator|->
name|fw_nsp
operator|)
argument_list|,
operator|&
name|ir
argument_list|)
expr_stmt|;
if|if
condition|(
name|ir
condition|)
name|flags
operator||=
name|IP_FW_F_DRNG
expr_stmt|;
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
return|return;
block|}
block|}
if|if
condition|(
name|token
operator|==
literal|0
condition|)
block|{
name|show_usage
argument_list|(
literal|"Unknown token."
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
goto|goto
name|get_next
goto|;
block|}
end_function

begin_macro
name|flush
argument_list|(
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|*
name|av
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_FW_FLUSH
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: setsockopt failed.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"All firewall entries flushed.\n"
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
operator|!
name|strncmp
argument_list|(
operator|*
name|av
argument_list|,
name|CH_FW
argument_list|,
name|strlen
argument_list|(
name|CH_FW
argument_list|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_FW_FLUSH
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: setsockopt failed.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"All firewall entries flushed.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_block

begin_macro
name|zero
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|IPPROTO_IP
argument_list|,
name|IP_FW_ZERO
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: setsockopt failed.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Accounting cleared.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_block

begin_macro
name|ipfw_main
argument_list|(
argument|ac
argument_list|,
argument|av
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ac
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|ch
decl_stmt|;
specifier|extern
name|int
name|optind
decl_stmt|;
name|int
name|ctl
decl_stmt|,
name|int_t
decl_stmt|,
name|is_check
init|=
literal|0
decl_stmt|,
name|int_notdef
init|=
literal|0
decl_stmt|;
name|struct
name|ip_fw
name|frwl
decl_stmt|;
name|strcpy
argument_list|(
name|progname
argument_list|,
operator|*
name|av
argument_list|)
expr_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_RAW
argument_list|,
name|IPPROTO_RAW
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Can't open raw socket.Must be root to use this programm. \n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ac
operator|==
literal|1
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|ac
argument_list|,
name|av
argument_list|,
literal|"ans"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'a'
case|:
name|do_acct
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|do_resolv
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|do_short
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
name|av
operator|+=
name|optind
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|get_num
argument_list|(
operator|*
name|av
argument_list|,
name|action_tab
argument_list|)
condition|)
block|{
case|case
name|A_ADDF
case|:
name|ctl
operator|=
name|IP_FW_ADD
expr_stmt|;
name|int_t
operator|=
name|FW
expr_stmt|;
break|break;
case|case
name|A_DELF
case|:
name|ctl
operator|=
name|IP_FW_DEL
expr_stmt|;
name|int_t
operator|=
name|FW
expr_stmt|;
break|break;
case|case
name|A_CHKF
case|:
name|int_t
operator|=
name|FW
expr_stmt|;
name|is_check
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|A_FLUSH
case|:
name|flush
argument_list|(
operator|++
name|av
argument_list|)
expr_stmt|;
return|return;
case|case
name|A_LIST
case|:
name|list
argument_list|(
operator|++
name|av
argument_list|)
expr_stmt|;
return|return;
case|case
name|A_ZERO
case|:
name|zero
argument_list|()
expr_stmt|;
return|return;
default|default:
name|int_t
operator|=
operator|(
name|FW
operator|)
expr_stmt|;
name|int_notdef
operator|=
literal|1
expr_stmt|;
block|}
comment|/*  main action switch  */
if|if
condition|(
name|is_check
condition|)
goto|goto
name|proto_switch
goto|;
if|if
condition|(
operator|!
name|int_notdef
condition|)
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|get_num
argument_list|(
operator|*
name|av
argument_list|,
name|type_tab
argument_list|)
condition|)
block|{
case|case
name|T_LREJECT
case|:
name|flags
operator||=
name|IP_FW_F_PRN
expr_stmt|;
case|case
name|T_REJECT
case|:
name|flags
operator||=
name|IP_FW_F_ICMPRPL
expr_stmt|;
if|if
condition|(
operator|!
name|int_t
operator|&
name|FW
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|int_t
operator|=
name|FW
expr_stmt|;
break|break;
case|case
name|T_LDENY
case|:
name|flags
operator||=
name|IP_FW_F_PRN
expr_stmt|;
case|case
name|T_DENY
case|:
name|flags
operator||=
literal|0
expr_stmt|;
comment|/* just to show it related to flags */
if|if
condition|(
operator|!
name|int_t
operator|&
name|FW
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|int_t
operator|=
name|FW
expr_stmt|;
break|break;
case|case
name|T_LOG
case|:
name|flags
operator||=
name|IP_FW_F_PRN
expr_stmt|;
case|case
name|T_ACCEPT
case|:
case|case
name|T_PASS
case|:
name|flags
operator||=
name|IP_FW_F_ACCEPT
expr_stmt|;
if|if
condition|(
operator|!
name|int_t
operator|&
name|FW
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|int_t
operator|=
name|FW
expr_stmt|;
break|break;
case|case
name|T_SINGLE
case|:
name|flags
operator||=
literal|0
expr_stmt|;
comment|/* just to show it related to flags */
break|break;
default|default:
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* type of switch */
if|if
condition|(
name|int_notdef
condition|)
block|{
if|if
condition|(
name|int_t
operator|==
name|FW
condition|)
name|ctl
operator|=
name|IP_FW_ADD
expr_stmt|;
block|}
name|proto_switch
label|:
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|get_num
argument_list|(
operator|*
name|av
argument_list|,
name|proto_tab
argument_list|)
condition|)
block|{
case|case
name|P_ALL
case|:
name|flags
operator||=
name|IP_FW_F_ALL
expr_stmt|;
break|break;
case|case
name|P_ICMP
case|:
name|flags
operator||=
name|IP_FW_F_ICMP
expr_stmt|;
break|break;
case|case
name|P_TCP
case|:
name|flags
operator||=
name|IP_FW_F_TCP
expr_stmt|;
name|ports_ok
operator|=
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|proto_name
argument_list|,
literal|"tcp"
argument_list|)
expr_stmt|;
break|break;
case|case
name|P_UDP
case|:
name|flags
operator||=
name|IP_FW_F_UDP
expr_stmt|;
name|ports_ok
operator|=
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|proto_name
argument_list|,
literal|"udp"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
operator|(
operator|++
name|av
operator|)
operator|==
name|NULL
condition|)
block|{
name|show_usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|set_entry
argument_list|(
name|av
argument_list|,
operator|&
name|frwl
argument_list|)
expr_stmt|;
name|frwl
operator|.
name|fw_flg
operator|=
name|flags
expr_stmt|;
if|if
condition|(
name|is_check
condition|)
block|{
ifndef|#
directive|ifndef
name|disabled
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: checking disabled.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
else|#
directive|else
name|struct
name|ip
modifier|*
name|pkt
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
decl_stmt|;
name|int
name|p_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
decl_stmt|;
name|pkt
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|malloc
argument_list|(
name|p_len
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|ip_v
operator|=
name|IPVERSION
expr_stmt|;
name|pkt
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
name|pkt
operator|+
literal|1
operator|)
expr_stmt|;
switch|switch
condition|(
name|get_num
argument_list|(
name|proto_name
argument_list|,
name|proto_tab
argument_list|)
condition|)
block|{
case|case
name|P_TCP
case|:
name|pkt
operator|->
name|ip_p
operator|=
name|IPPROTO_TCP
expr_stmt|;
break|break;
case|case
name|P_UDP
case|:
name|pkt
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: can check TCP/UDP packets\ 							only.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|frwl
operator|.
name|fw_nsp
operator|!=
literal|1
operator|||
name|frwl
operator|.
name|fw_ndp
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: check needs one src/dst port.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntohl
argument_list|(
name|frwl
operator|.
name|fw_smsk
operator|.
name|s_addr
argument_list|)
operator|!=
name|ULONG_MAX
operator|||
name|ntohl
argument_list|(
name|frwl
operator|.
name|fw_dmsk
operator|.
name|s_addr
argument_list|)
operator|!=
name|ULONG_MAX
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: can't check masked IP.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pkt
operator|->
name|ip_src
operator|.
name|s_addr
operator|=
name|frwl
operator|.
name|fw_src
operator|.
name|s_addr
expr_stmt|;
name|pkt
operator|->
name|ip_dst
operator|.
name|s_addr
operator|=
name|frwl
operator|.
name|fw_dst
operator|.
name|s_addr
expr_stmt|;
name|th
operator|->
name|th_sport
operator|=
name|htons
argument_list|(
name|frwl
operator|.
name|fw_pts
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|th
operator|->
name|th_dport
operator|=
name|htons
argument_list|(
name|frwl
operator|.
name|fw_pts
index|[
name|frwl
operator|.
name|fw_nsp
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|IPPROTO_IP
argument_list|,
name|ctl
argument_list|,
name|pkt
argument_list|,
name|p_len
argument_list|)
condition|)
name|printf
argument_list|(
literal|"Packet DENYED.\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Packet ACCEPTED.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|IPPROTO_IP
argument_list|,
name|ctl
argument_list|,
operator|&
name|frwl
argument_list|,
sizeof|sizeof
argument_list|(
name|frwl
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: setsockopt failed.\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|int
name|main
parameter_list|(
name|ac
parameter_list|,
name|av
parameter_list|)
name|int
name|ac
decl_stmt|;
name|char
modifier|*
modifier|*
name|av
decl_stmt|;
block|{
define|#
directive|define
name|MAX_ARGS
value|32
name|char
name|buf
index|[
name|_POSIX_ARG_MAX
index|]
decl_stmt|;
name|char
modifier|*
name|args
index|[
name|MAX_ARGS
index|]
decl_stmt|;
name|char
name|linename
index|[
literal|10
index|]
decl_stmt|;
name|int
name|lineno
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
if|if
condition|(
name|av
index|[
literal|1
index|]
operator|&&
operator|!
name|access
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
name|R_OK
argument_list|)
condition|)
block|{
name|f
operator|=
name|fopen
argument_list|(
name|av
index|[
literal|1
index|]
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
name|_POSIX_ARG_MAX
argument_list|,
name|f
argument_list|)
condition|)
block|{
if|if
condition|(
name|buf
index|[
name|strlen
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'\n'
condition|)
name|buf
index|[
name|strlen
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|lineno
operator|++
expr_stmt|;
name|sprintf
argument_list|(
name|linename
argument_list|,
literal|"Line %d"
argument_list|,
name|lineno
argument_list|)
expr_stmt|;
name|args
index|[
literal|0
index|]
operator|=
name|linename
expr_stmt|;
name|args
index|[
literal|1
index|]
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|args
index|[
literal|1
index|]
operator|==
literal|' '
condition|)
name|args
index|[
literal|1
index|]
operator|++
expr_stmt|;
name|i
operator|=
literal|2
expr_stmt|;
while|while
condition|(
name|args
index|[
name|i
index|]
operator|=
name|findchar
argument_list|(
name|args
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
literal|' '
argument_list|)
condition|)
block|{
operator|*
operator|(
name|args
index|[
name|i
index|]
operator|++
operator|)
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|args
index|[
name|i
index|]
operator|==
literal|' '
condition|)
name|args
index|[
name|i
index|]
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|args
index|[
name|i
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
name|i
operator|--
expr_stmt|;
name|args
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|ipfw_main
argument_list|(
name|i
argument_list|,
name|args
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
else|else
name|ipfw_main
argument_list|(
name|ac
argument_list|,
name|av
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


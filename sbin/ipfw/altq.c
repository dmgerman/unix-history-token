begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002-2003 Luigi Rizzo  * Copyright (c) 1996 Alex Nash, Paul Traina, Poul-Henning Kamp  * Copyright (c) 1994 Ugen J.S.Antsilevich  *  * Idea and grammar partially left from:  * Copyright (c) 1993 Daniel Boulet  *  * Redistribution and use in source forms, with and without modification,  * are permitted provided that this entire comment appears intact.  *  * Redistribution in binary form may occur without any restrictions.  * Obviously, it would be nice if you gave credit where credit is due  * but requiring it would be too onerous.  *  * This software is provided ``AS IS'' without any warranties of any kind.  *  * NEW command line interface for IP firewall facility  *  * $FreeBSD$  *  * altq interface  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|"ipfw2.h"
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_comment
comment|/* IFNAMSIZ */
end_comment

begin_include
include|#
directive|include
file|<net/pfvar.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_comment
comment|/* in_addr */
end_comment

begin_include
include|#
directive|include
file|<netinet/ip_fw.h>
end_include

begin_comment
comment|/*  * Map between current altq queue id numbers and names.  */
end_comment

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|pf_altq
argument_list|)
name|altq_entries
operator|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|altq_entries
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|altq_set_enabled
parameter_list|(
name|int
name|enabled
parameter_list|)
block|{
name|int
name|pffd
decl_stmt|;
name|pffd
operator|=
name|open
argument_list|(
literal|"/dev/pf"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|pffd
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
name|EX_UNAVAILABLE
argument_list|,
literal|"altq support opening pf(4) control device"
argument_list|)
expr_stmt|;
if|if
condition|(
name|enabled
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|pffd
argument_list|,
name|DIOCSTARTALTQ
argument_list|)
operator|!=
literal|0
operator|&&
name|errno
operator|!=
name|EEXIST
condition|)
name|err
argument_list|(
name|EX_UNAVAILABLE
argument_list|,
literal|"enabling altq"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|pffd
argument_list|,
name|DIOCSTOPALTQ
argument_list|)
operator|!=
literal|0
operator|&&
name|errno
operator|!=
name|ENOENT
condition|)
name|err
argument_list|(
name|EX_UNAVAILABLE
argument_list|,
literal|"disabling altq"
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|pffd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|altq_fetch
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pfioc_altq
name|pfioc
decl_stmt|;
name|struct
name|pf_altq
modifier|*
name|altq
decl_stmt|;
name|int
name|pffd
decl_stmt|;
name|unsigned
name|int
name|mnr
decl_stmt|;
specifier|static
name|int
name|altq_fetched
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|altq_fetched
condition|)
return|return;
name|altq_fetched
operator|=
literal|1
expr_stmt|;
name|pffd
operator|=
name|open
argument_list|(
literal|"/dev/pf"
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|pffd
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"altq support opening pf(4) control device"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
operator|&
name|pfioc
argument_list|,
sizeof|sizeof
argument_list|(
name|pfioc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pffd
argument_list|,
name|DIOCGETALTQS
argument_list|,
operator|&
name|pfioc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"altq support getting queue list"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pffd
argument_list|)
expr_stmt|;
return|return;
block|}
name|mnr
operator|=
name|pfioc
operator|.
name|nr
expr_stmt|;
for|for
control|(
name|pfioc
operator|.
name|nr
operator|=
literal|0
init|;
name|pfioc
operator|.
name|nr
operator|<
name|mnr
condition|;
name|pfioc
operator|.
name|nr
operator|++
control|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|pffd
argument_list|,
name|DIOCGETALTQ
argument_list|,
operator|&
name|pfioc
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EBUSY
condition|)
break|break;
name|warn
argument_list|(
literal|"altq support getting queue list"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pffd
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pfioc
operator|.
name|altq
operator|.
name|qid
operator|==
literal|0
condition|)
continue|continue;
name|altq
operator|=
name|safe_calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|altq
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|altq
operator|=
name|pfioc
operator|.
name|altq
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|altq_entries
argument_list|,
name|altq
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|pffd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_int32_t
name|altq_name_to_qid
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|pf_altq
modifier|*
name|altq
decl_stmt|;
name|altq_fetch
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|altq
argument_list|,
argument|&altq_entries
argument_list|,
argument|entries
argument_list|)
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
name|altq
operator|->
name|qname
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|altq
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EX_DATAERR
argument_list|,
literal|"altq has no queue named `%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|altq
operator|->
name|qid
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|altq_qid_to_name
parameter_list|(
name|u_int32_t
name|qid
parameter_list|)
block|{
name|struct
name|pf_altq
modifier|*
name|altq
decl_stmt|;
name|altq_fetch
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|altq
argument_list|,
argument|&altq_entries
argument_list|,
argument|entries
argument_list|)
if|if
condition|(
name|qid
operator|==
name|altq
operator|->
name|qid
condition|)
break|break;
if|if
condition|(
name|altq
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|altq
operator|->
name|qname
return|;
block|}
end_function

begin_function
name|void
name|print_altq_cmd
parameter_list|(
name|struct
name|buf_pr
modifier|*
name|bp
parameter_list|,
name|ipfw_insn_altq
modifier|*
name|altqptr
parameter_list|)
block|{
if|if
condition|(
name|altqptr
condition|)
block|{
specifier|const
name|char
modifier|*
name|qname
decl_stmt|;
name|qname
operator|=
name|altq_qid_to_name
argument_list|(
name|altqptr
operator|->
name|qid
argument_list|)
expr_stmt|;
if|if
condition|(
name|qname
operator|==
name|NULL
condition|)
name|bprintf
argument_list|(
name|bp
argument_list|,
literal|" altq ?<%u>"
argument_list|,
name|altqptr
operator|->
name|qid
argument_list|)
expr_stmt|;
else|else
name|bprintf
argument_list|(
name|bp
argument_list|,
literal|" altq %s"
argument_list|,
name|qname
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


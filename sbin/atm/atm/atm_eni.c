begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * ===================================  * HARP  |  Host ATM Research Platform  * ===================================  *  *  * This Host ATM Research Platform ("HARP") file (the "Software") is  * made available by Network Computing Services, Inc. ("NetworkCS")  * "AS IS".  NetworkCS does not provide maintenance, improvements or  * support of any kind.  *  * NETWORKCS MAKES NO WARRANTIES OR REPRESENTATIONS, EXPRESS OR IMPLIED,  * INCLUDING, BUT NOT LIMITED TO, IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS FOR A PARTICULAR PURPOSE, AS TO ANY ELEMENT OF THE  * SOFTWARE OR ANY SUPPORT PROVIDED IN CONNECTION WITH THIS SOFTWARE.  * In no event shall NetworkCS be responsible for any damages, including  * but not limited to consequential damages, arising from or relating to  * any use of the Software or related support.  *  * Copyright 1994-1998 Network Computing Services, Inc.  *  * Copies of this Software may be made, however, the above copyright  * notice must be reproduced on all copies.  *  *	@(#) $FreeBSD$  *  */
end_comment

begin_comment
comment|/*  * User configuration and display program  * --------------------------------------  *  * Routines for Efficient-specific subcommands  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netatm/port.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_if.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sap.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_sys.h>
end_include

begin_include
include|#
directive|include
file|<netatm/atm_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<dev/hea/eni_stats.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<libatm.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"atm.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_expr_stmt
name|__RCSID
argument_list|(
literal|"@(#) $FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Local constants  */
end_comment

begin_define
define|#
directive|define
name|SHOW_PHY
value|1
end_define

begin_define
define|#
directive|define
name|SHOW_ATM
value|2
end_define

begin_define
define|#
directive|define
name|SHOW_AAL0
value|4
end_define

begin_define
define|#
directive|define
name|SHOW_AAL5
value|8
end_define

begin_define
define|#
directive|define
name|SHOW_DRIVER
value|64
end_define

begin_comment
comment|/*  * Headers for statistics  */
end_comment

begin_define
define|#
directive|define
name|ATM_STATS_HDR
define|\
value|"%s ATM Layer Statistics\n\   Cells In   Cells Out\n"
end_define

begin_define
define|#
directive|define
name|AAL0_STATS_HDR
define|\
value|"%s AAL 0 Statistics\n\   Cells In   Cells Out  Cell Drops\n"
end_define

begin_define
define|#
directive|define
name|AAL5_STATS_HDR
define|\
value|"%s AAL 5 Statistics\n\                         CRC/Len                              CRC   Proto  PDU\n\   Cells In   Cells Out  Errs   Drops    PDUs In   PDUs Out   Errs  Errs   Drops\n"
end_define

begin_define
define|#
directive|define
name|DRIVER_STATS_HDR_1
define|\
value|"%s Device Driver Statistics\n\   Buf    Buf    Buf    Buf  Can't    VCC    VCC     No     No  No RX     RX\n\   Req     No     No  Alrdy   Find    PDU  Range  Resrc     RX    DMA  Queue\n\  Size  Descr    Mem   Free  Descr   Size  Error     In   Bufs   Room   Full\n"
end_define

begin_define
define|#
directive|define
name|DRIVER_STATS_HDR_2
define|\
value|"%s Device Driver Statistics\n\    No    ATM  No RX  No TX    Seg           Max       No     No    No TX\n\    RX  IntrQ    DMA    DMA    Not    Seg    Seg       TX  Resrc      DMA\n\   VCC   Full   Room   Addr  Align    Pad    Out      Buf    Out     Room\n"
end_define

begin_define
define|#
directive|define
name|OC3_STATS_HDR
define|\
value|"%s OC-3c Statistics\n\ Section     Path    Line      Line     Path     Corr   Uncorr\n\ BIP8        BIP8    BIP24     FEBE     FEBE     HCS    HCS\n\ Errs        Errs    Errs      Errs     Errs     Errs   Errs\n"
end_define

begin_comment
comment|/*  * Process show ENI statistics command  *  * The statistics printed are vendor-specific, depending on the brand of  * the interface card.  *   * Command format:   *	atm show stats interface [<interface-name> [phy | dev | atm | 		aal0 | aal5 | driver ]]  *  * Arguments:  *	intf	interface to print statistics for  *	argc	number of remaining arguments to command  *	argv	pointer to remaining argument strings  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|show_eni_stats
parameter_list|(
name|intf
parameter_list|,
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
name|intf
decl_stmt|;
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|buf_len
decl_stmt|,
name|stats_type
decl_stmt|;
name|struct
name|atminfreq
name|air
decl_stmt|;
name|struct
name|air_vinfo_rsp
modifier|*
name|stats
decl_stmt|;
comment|/* 	 * Get statistics type qualifier 	 */
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"phy"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|stats_type
operator|=
name|SHOW_PHY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"atm"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|stats_type
operator|=
name|SHOW_ATM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"aal0"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|stats_type
operator|=
name|SHOW_AAL0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"aal5"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|stats_type
operator|=
name|SHOW_AAL5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
literal|"driver"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|stats_type
operator|=
name|SHOW_DRIVER
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Illegal or unsupported statistics type\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
comment|/* 	 * Get vendor-specific statistics from the kernel 	 */
name|UM_ZERO
argument_list|(
operator|&
name|air
argument_list|,
sizeof|sizeof
argument_list|(
name|air
argument_list|)
argument_list|)
expr_stmt|;
name|air
operator|.
name|air_opcode
operator|=
name|AIOCS_INF_VST
expr_stmt|;
name|strcpy
argument_list|(
name|air
operator|.
name|air_vinfo_intf
argument_list|,
name|intf
argument_list|)
expr_stmt|;
name|buf_len
operator|=
name|do_info_ioctl
argument_list|(
operator|&
name|air
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|+
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf_len
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|prog
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|ENOPROTOOPT
case|:
case|case
name|EOPNOTSUPP
case|:
name|perror
argument_list|(
literal|"Internal error"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ENXIO
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not an ATM device\n"
argument_list|,
name|intf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|perror
argument_list|(
literal|"ioctl (AIOCINFO)"
argument_list|)
expr_stmt|;
break|break;
block|}
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|stats
operator|=
operator|(
expr|struct
name|air_vinfo_rsp
operator|*
operator|)
name|air
operator|.
name|air_buf_addr
expr_stmt|;
comment|/* 	 * Print the statistics 	 */
if|if
condition|(
name|buf_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|Eni_stats
argument_list|)
condition|)
block|{
name|UM_FREE
argument_list|(
name|stats
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|stats_type
condition|)
block|{
case|case
name|SHOW_PHY
case|:
name|print_eni_oc3
argument_list|(
name|stats
argument_list|)
expr_stmt|;
break|break;
case|case
name|SHOW_ATM
case|:
name|print_eni_atm
argument_list|(
name|stats
argument_list|)
expr_stmt|;
break|break;
case|case
name|SHOW_AAL0
case|:
name|print_eni_aal0
argument_list|(
name|stats
argument_list|)
expr_stmt|;
break|break;
case|case
name|SHOW_AAL5
case|:
name|print_eni_aal5
argument_list|(
name|stats
argument_list|)
expr_stmt|;
break|break;
case|case
name|SHOW_DRIVER
case|:
name|print_eni_driver
argument_list|(
name|stats
argument_list|)
expr_stmt|;
break|break;
block|}
name|UM_FREE
argument_list|(
name|stats
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print ENI OC-3c statistics  *   * Arguments:  *	vi	pointer to vendor-specific statistics to print  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|print_eni_oc3
parameter_list|(
name|vi
parameter_list|)
name|struct
name|air_vinfo_rsp
modifier|*
name|vi
decl_stmt|;
block|{
name|Eni_stats
modifier|*
name|stats
decl_stmt|;
comment|/* 	 * Bump stats pointer past header info 	 */
name|stats
operator|=
operator|(
name|Eni_stats
operator|*
operator|)
operator|(
operator|(
name|u_long
operator|)
name|vi
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Print a header 	 */
name|printf
argument_list|(
name|OC3_STATS_HDR
argument_list|,
name|get_adapter_name
argument_list|(
name|vi
operator|->
name|avsp_intf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Print the OC-3c info 	 */
name|printf
argument_list|(
literal|"%7ld  %7ld  %7ld  %7ld  %7ld  %7ld  %7ld\n"
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_sect_bip8
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_path_bip8
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_line_bip24
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_line_febe
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_path_febe
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_hec_corr
argument_list|,
name|stats
operator|->
name|eni_st_oc3
operator|.
name|oc3_hec_uncorr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print ENI ATM statistics  *   * Arguments:  *	vi	pointer to vendor-specific statistics to print  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|print_eni_atm
parameter_list|(
name|vi
parameter_list|)
name|struct
name|air_vinfo_rsp
modifier|*
name|vi
decl_stmt|;
block|{
name|Eni_stats
modifier|*
name|stats
decl_stmt|;
comment|/* 	 * Bump stats pointer past header info 	 */
name|stats
operator|=
operator|(
name|Eni_stats
operator|*
operator|)
operator|(
operator|(
name|u_long
operator|)
name|vi
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Print a header 	 */
name|printf
argument_list|(
name|ATM_STATS_HDR
argument_list|,
name|get_adapter_name
argument_list|(
name|vi
operator|->
name|avsp_intf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Print the ATM layer info 	 */
name|printf
argument_list|(
literal|"%10ld  %10ld\n"
argument_list|,
name|stats
operator|->
name|eni_st_atm
operator|.
name|atm_rcvd
argument_list|,
name|stats
operator|->
name|eni_st_atm
operator|.
name|atm_xmit
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print ENI AAL 0 statistics  *   * Arguments:  *	vi	pointer to vendor-specific statistics to print  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|print_eni_aal0
parameter_list|(
name|vi
parameter_list|)
name|struct
name|air_vinfo_rsp
modifier|*
name|vi
decl_stmt|;
block|{
name|Eni_stats
modifier|*
name|stats
decl_stmt|;
comment|/* 	 * Bump stats pointer past header info 	 */
name|stats
operator|=
operator|(
name|Eni_stats
operator|*
operator|)
operator|(
operator|(
name|u_long
operator|)
name|vi
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Print a header 	 */
name|printf
argument_list|(
name|AAL0_STATS_HDR
argument_list|,
name|get_adapter_name
argument_list|(
name|vi
operator|->
name|avsp_intf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Print the AAL 0 info 	 */
name|printf
argument_list|(
literal|"%10ld  %10ld  %10ld\n"
argument_list|,
name|stats
operator|->
name|eni_st_aal0
operator|.
name|aal0_rcvd
argument_list|,
name|stats
operator|->
name|eni_st_aal0
operator|.
name|aal0_xmit
argument_list|,
name|stats
operator|->
name|eni_st_aal0
operator|.
name|aal0_drops
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print ENI AAL 5 statistics  *   * Arguments:  *	vi	pointer to vendor-specific statistics to print  *  * Returns:  *	none  *  */
end_comment

begin_function
name|void
name|print_eni_aal5
parameter_list|(
name|vi
parameter_list|)
name|struct
name|air_vinfo_rsp
modifier|*
name|vi
decl_stmt|;
block|{
name|Eni_stats
modifier|*
name|stats
decl_stmt|;
comment|/* 	 * Bump stats pointer past header info 	 */
name|stats
operator|=
operator|(
name|Eni_stats
operator|*
operator|)
operator|(
operator|(
name|u_long
operator|)
name|vi
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|)
expr_stmt|;
comment|/* 	 * Print a header 	 */
name|printf
argument_list|(
name|AAL5_STATS_HDR
argument_list|,
name|get_adapter_name
argument_list|(
name|vi
operator|->
name|avsp_intf
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Print the AAL 5 info 	 */
name|printf
argument_list|(
literal|"%10ld  %10ld  %5ld  %5ld  %9ld  %9ld  %5ld  %5ld  %5ld\n"
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_rcvd
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_xmit
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_crc_len
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_drops
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_pdu_rcvd
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_pdu_xmit
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_pdu_crc
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_pdu_errs
argument_list|,
name|stats
operator|->
name|eni_st_aal5
operator|.
name|aal5_pdu_drops
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print Efficient device driver statistics  *  * Arguments:  *      vi      pointer to vendor-specific statistics to print  *  * Returns:  *      none  *  */
end_comment

begin_function
name|void
name|print_eni_driver
parameter_list|(
name|vi
parameter_list|)
name|struct
name|air_vinfo_rsp
modifier|*
name|vi
decl_stmt|;
block|{
name|Eni_stats
modifier|*
name|stats
decl_stmt|;
comment|/*          * Bump stats pointer past header info          */
name|stats
operator|=
operator|(
name|Eni_stats
operator|*
operator|)
operator|(
operator|(
name|u_long
operator|)
name|vi
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|air_vinfo_rsp
argument_list|)
operator|)
expr_stmt|;
comment|/*          * Print 1st header          */
name|printf
argument_list|(
name|DRIVER_STATS_HDR_1
argument_list|,
name|get_adapter_name
argument_list|(
name|vi
operator|->
name|avsp_intf
argument_list|)
argument_list|)
expr_stmt|;
comment|/*          * Print the driver info          */
name|printf
argument_list|(
literal|"%5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %5ld\n"
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_mm_toobig
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_mm_nodesc
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_mm_nobuf
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_mm_notuse
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_mm_notfnd
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_vc_maxpdu
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_vc_badrng
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_norsc
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_nobufs
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_nodma
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_rxq
argument_list|)
expr_stmt|;
comment|/*          * Print 2nd header          */
name|printf
argument_list|(
name|DRIVER_STATS_HDR_2
argument_list|,
name|get_adapter_name
argument_list|(
name|vi
operator|->
name|avsp_intf
argument_list|)
argument_list|)
expr_stmt|;
comment|/*          * Print the driver info          */
name|printf
argument_list|(
literal|"%5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %5ld  %7ld  %5ld  %7ld\n"
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_novcc
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_intrq
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_rv_segdma
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_segdma
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_segnoal
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_seglen
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_maxpdu
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_nobuf
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_norsc
argument_list|,
name|stats
operator|->
name|eni_st_drv
operator|.
name|drv_xm_nodma
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


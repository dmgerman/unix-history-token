begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002 Marcel Moolenaar  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/uuid.h>
end_include

begin_comment
comment|/*  * Hack to make this compile on non-ia64 machines.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__ia64__
end_ifdef

begin_include
include|#
directive|include
file|<machine/mca.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"../../sys/ia64/include/mca.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<uuid.h>
end_include

begin_define
define|#
directive|define
name|BCD
parameter_list|(
name|x
parameter_list|)
value|((x>> 4) * 10 + (x& 15))
end_define

begin_decl_stmt
specifier|static
name|char
name|hw_mca_count
index|[]
init|=
literal|"hw.mca.count"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|hw_mca_first
index|[]
init|=
literal|"hw.mca.first"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|hw_mca_last
index|[]
init|=
literal|"hw.mca.last"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|hw_mca_recid
index|[]
init|=
literal|"hw.mca.%d"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|default_dumpfile
index|[]
init|=
literal|"/var/log/mca.log"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|fl_dump
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|severity
parameter_list|(
name|int
name|error
parameter_list|)
block|{
switch|switch
condition|(
name|error
condition|)
block|{
case|case
name|MCA_RH_ERROR_RECOVERABLE
case|:
return|return
operator|(
literal|"recoverable"
operator|)
return|;
case|case
name|MCA_RH_ERROR_FATAL
case|:
return|return
operator|(
literal|"fatal"
operator|)
return|;
case|case
name|MCA_RH_ERROR_CORRECTED
case|:
return|return
operator|(
literal|"corrected"
operator|)
return|;
block|}
return|return
operator|(
literal|"unknown"
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|uuid
parameter_list|(
name|uuid_t
modifier|*
name|id
parameter_list|)
block|{
specifier|static
name|char
name|buffer
index|[
literal|64
index|]
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|uuid_to_string
argument_list|(
name|id
argument_list|,
operator|&
name|s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|buffer
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|show_value
parameter_list|(
name|int
name|indent
parameter_list|,
specifier|const
name|char
modifier|*
name|var
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|indent
expr_stmt|;
while|while
condition|(
name|indent
operator|--
condition|)
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|len
operator|+=
name|printf
argument_list|(
literal|"<%s>"
argument_list|,
name|var
argument_list|)
expr_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|len
operator|+=
name|vprintf
argument_list|(
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|len
operator|+=
name|printf
argument_list|(
literal|"</%s>\n"
argument_list|,
name|var
argument_list|)
expr_stmt|;
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|show_header
parameter_list|(
name|struct
name|mca_record_header
modifier|*
name|rh
parameter_list|)
block|{
name|printf
argument_list|(
literal|"<header>\n"
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"seqnr"
argument_list|,
literal|"%lld"
argument_list|,
operator|(
name|long
name|long
operator|)
name|rh
operator|->
name|rh_seqnr
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"revision"
argument_list|,
literal|"%d.%d"
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_major
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_minor
argument_list|)
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"severity"
argument_list|,
literal|"%s"
argument_list|,
name|severity
argument_list|(
name|rh
operator|->
name|rh_error
argument_list|)
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"length"
argument_list|,
literal|"%lld"
argument_list|,
operator|(
name|long
name|long
operator|)
name|rh
operator|->
name|rh_length
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"date"
argument_list|,
literal|"%d%02d/%02d/%02d"
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_CENT
index|]
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_YEAR
index|]
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_MON
index|]
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_MDAY
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"time"
argument_list|,
literal|"%02d:%02d:%02d"
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_HOUR
index|]
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_MIN
index|]
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|rh
operator|->
name|rh_time
index|[
name|MCA_RH_TIME_SEC
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rh
operator|->
name|rh_flags
operator|&
name|MCA_RH_FLAGS_PLATFORM_ID
condition|)
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"platform"
argument_list|,
literal|"%s"
argument_list|,
name|uuid
argument_list|(
operator|&
name|rh
operator|->
name|rh_platform
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"</header>\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rh
operator|->
name|rh_length
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_cpu_mod
parameter_list|(
specifier|const
name|char
modifier|*
name|what
parameter_list|,
name|int
name|idx
parameter_list|,
name|struct
name|mca_cpu_mod
modifier|*
name|cpu_mod
parameter_list|)
block|{
name|printf
argument_list|(
literal|"<%s-%d>\n"
argument_list|,
name|what
argument_list|,
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_mod
operator|->
name|cpu_mod_flags
operator|&
name|MCA_CPU_MOD_FLAGS_INFO
condition|)
name|show_value
argument_list|(
literal|8
argument_list|,
literal|"info"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu_mod
operator|->
name|cpu_mod_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_mod
operator|->
name|cpu_mod_flags
operator|&
name|MCA_CPU_MOD_FLAGS_REQID
condition|)
name|show_value
argument_list|(
literal|8
argument_list|,
literal|"requester"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu_mod
operator|->
name|cpu_mod_reqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_mod
operator|->
name|cpu_mod_flags
operator|&
name|MCA_CPU_MOD_FLAGS_RSPID
condition|)
name|show_value
argument_list|(
literal|8
argument_list|,
literal|"responder"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu_mod
operator|->
name|cpu_mod_rspid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_mod
operator|->
name|cpu_mod_flags
operator|&
name|MCA_CPU_MOD_FLAGS_TGTID
condition|)
name|show_value
argument_list|(
literal|8
argument_list|,
literal|"target"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu_mod
operator|->
name|cpu_mod_tgtid
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu_mod
operator|->
name|cpu_mod_flags
operator|&
name|MCA_CPU_MOD_FLAGS_IP
condition|)
name|show_value
argument_list|(
literal|8
argument_list|,
literal|"ip"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu_mod
operator|->
name|cpu_mod_ip
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"</%s-%d>\n"
argument_list|,
name|what
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_cpu
parameter_list|(
name|struct
name|mca_cpu_record
modifier|*
name|cpu
parameter_list|)
block|{
name|char
name|var
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|mca_cpu_mod
modifier|*
name|mod
decl_stmt|;
name|struct
name|mca_cpu_cpuid
modifier|*
name|cpuid
decl_stmt|;
name|struct
name|mca_cpu_psi
modifier|*
name|psi
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|printf
argument_list|(
literal|"<cpu>\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu
operator|->
name|cpu_flags
operator|&
name|MCA_CPU_FLAGS_ERRMAP
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"errmap"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu
operator|->
name|cpu_errmap
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu
operator|->
name|cpu_flags
operator|&
name|MCA_CPU_FLAGS_STATE
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"state"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu
operator|->
name|cpu_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu
operator|->
name|cpu_flags
operator|&
name|MCA_CPU_FLAGS_CR_LID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"cr_lid"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpu
operator|->
name|cpu_cr_lid
argument_list|)
expr_stmt|;
name|mod
operator|=
operator|(
expr|struct
name|mca_cpu_mod
operator|*
operator|)
operator|(
name|cpu
operator|+
literal|1
operator|)
expr_stmt|;
name|n
operator|=
name|MCA_CPU_FLAGS_CACHE
argument_list|(
name|cpu
operator|->
name|cpu_flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|show_cpu_mod
argument_list|(
literal|"cache"
argument_list|,
name|i
argument_list|,
name|mod
operator|++
argument_list|)
expr_stmt|;
name|n
operator|=
name|MCA_CPU_FLAGS_TLB
argument_list|(
name|cpu
operator|->
name|cpu_flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|show_cpu_mod
argument_list|(
literal|"tlb"
argument_list|,
name|i
argument_list|,
name|mod
operator|++
argument_list|)
expr_stmt|;
name|n
operator|=
name|MCA_CPU_FLAGS_BUS
argument_list|(
name|cpu
operator|->
name|cpu_flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|show_cpu_mod
argument_list|(
literal|"bus"
argument_list|,
name|i
argument_list|,
name|mod
operator|++
argument_list|)
expr_stmt|;
name|n
operator|=
name|MCA_CPU_FLAGS_REG
argument_list|(
name|cpu
operator|->
name|cpu_flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|show_cpu_mod
argument_list|(
literal|"reg"
argument_list|,
name|i
argument_list|,
name|mod
operator|++
argument_list|)
expr_stmt|;
name|n
operator|=
name|MCA_CPU_FLAGS_MS
argument_list|(
name|cpu
operator|->
name|cpu_flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|show_cpu_mod
argument_list|(
literal|"ms"
argument_list|,
name|i
argument_list|,
name|mod
operator|++
argument_list|)
expr_stmt|;
name|cpuid
operator|=
operator|(
expr|struct
name|mca_cpu_cpuid
operator|*
operator|)
name|mod
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|var
argument_list|,
literal|"cpuid-%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
name|var
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|cpuid
operator|->
name|cpuid
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|psi
operator|=
operator|(
expr|struct
name|mca_cpu_psi
operator|*
operator|)
operator|(
name|cpuid
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* TODO: Dump PSI */
name|printf
argument_list|(
literal|"</cpu>\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_memory
parameter_list|(
name|struct
name|mca_mem_record
modifier|*
name|mem
parameter_list|)
block|{
name|printf
argument_list|(
literal|"<memory>\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_STATUS
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"status"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_ADDR
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"address"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_ADDRMASK
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"mask"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_addrmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_NODE
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"node"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_CARD
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"card"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_card
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_MODULE
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"module"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_module
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_BANK
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"bank"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_bank
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_DEVICE
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"device"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_device
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_ROW
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"row"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_row
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_COLUMN
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"column"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_column
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_BITPOS
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"bit"
argument_list|,
literal|"0x%04x"
argument_list|,
name|mem
operator|->
name|mem_bitpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_REQID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"requester"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_reqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_RSPID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"responder"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_rspid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_TGTID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"target"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_tgtid
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_BUSDATA
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"status"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|mem
operator|->
name|mem_busdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|mem
operator|->
name|mem_flags
operator|&
name|MCA_MEM_FLAGS_OEM_ID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"oem"
argument_list|,
literal|"%s"
argument_list|,
name|uuid
argument_list|(
operator|&
name|mem
operator|->
name|mem_oem_id
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO: Dump OEM data */
name|printf
argument_list|(
literal|"</memory>\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_sel
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"    # SEL\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_pci_bus
parameter_list|(
name|struct
name|mca_pcibus_record
modifier|*
name|pcibus
parameter_list|)
block|{
name|printf
argument_list|(
literal|"<pci-bus>\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_STATUS
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"status"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_ERROR
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"error"
argument_list|,
literal|"0x%04x"
argument_list|,
name|pcibus
operator|->
name|pcibus_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_BUS
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"bus"
argument_list|,
literal|"0x%04x"
argument_list|,
name|pcibus
operator|->
name|pcibus_bus
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_ADDR
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"address"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_DATA
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"data"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_CMD
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"cmd"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_REQID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"requester"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_reqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_RSPID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"responder"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_rspid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_TGTID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"target"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcibus
operator|->
name|pcibus_tgtid
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcibus
operator|->
name|pcibus_flags
operator|&
name|MCA_PCIBUS_FLAGS_OEM_ID
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"oem"
argument_list|,
literal|"%s"
argument_list|,
name|uuid
argument_list|(
operator|&
name|pcibus
operator|->
name|pcibus_oem_id
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO: Dump OEM data */
name|printf
argument_list|(
literal|"</pci-bus>\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_smbios
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"    # SMBIOS\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_pci_dev
parameter_list|(
name|struct
name|mca_pcidev_record
modifier|*
name|pcidev
parameter_list|)
block|{
name|printf
argument_list|(
literal|"<pci-dev>\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcidev
operator|->
name|pcidev_flags
operator|&
name|MCA_PCIDEV_FLAGS_STATUS
condition|)
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"status"
argument_list|,
literal|"0x%016llx"
argument_list|,
operator|(
name|long
name|long
operator|)
name|pcidev
operator|->
name|pcidev_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcidev
operator|->
name|pcidev_flags
operator|&
name|MCA_PCIDEV_FLAGS_INFO
condition|)
block|{
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"vendor"
argument_list|,
literal|"0x%04x"
argument_list|,
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_vendor
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"device"
argument_list|,
literal|"0x%04x"
argument_list|,
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_device
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"class"
argument_list|,
literal|"0x%06x"
argument_list|,
name|MCA_PCIDEV_INFO_CLASS
argument_list|(
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_ccfn
argument_list|)
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"function"
argument_list|,
literal|"0x%02x"
argument_list|,
name|MCA_PCIDEV_INFO_FUNCTION
argument_list|(
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_ccfn
argument_list|)
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"slot"
argument_list|,
literal|"0x%02x"
argument_list|,
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_slot
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"bus"
argument_list|,
literal|"0x%04x"
argument_list|,
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_bus
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|6
argument_list|,
literal|"segment"
argument_list|,
literal|"0x%04x"
argument_list|,
name|pcidev
operator|->
name|pcidev_info
operator|.
name|info_segment
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: dump registers */
comment|/* TODO: Dump OEM data */
name|printf
argument_list|(
literal|"</pci-dev>\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_generic
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"    # GENERIC\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|show_section
parameter_list|(
name|struct
name|mca_section_header
modifier|*
name|sh
parameter_list|)
block|{
specifier|static
name|uuid_t
name|uuid_cpu
init|=
name|MCA_UUID_CPU
decl_stmt|;
specifier|static
name|uuid_t
name|uuid_memory
init|=
name|MCA_UUID_MEMORY
decl_stmt|;
specifier|static
name|uuid_t
name|uuid_sel
init|=
name|MCA_UUID_SEL
decl_stmt|;
specifier|static
name|uuid_t
name|uuid_pci_bus
init|=
name|MCA_UUID_PCI_BUS
decl_stmt|;
specifier|static
name|uuid_t
name|uuid_smbios
init|=
name|MCA_UUID_SMBIOS
decl_stmt|;
specifier|static
name|uuid_t
name|uuid_pci_dev
init|=
name|MCA_UUID_PCI_DEV
decl_stmt|;
specifier|static
name|uuid_t
name|uuid_generic
init|=
name|MCA_UUID_GENERIC
decl_stmt|;
name|printf
argument_list|(
literal|"<section>\n"
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"uuid"
argument_list|,
literal|"%s"
argument_list|,
name|uuid
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|)
argument_list|)
expr_stmt|;
name|show_value
argument_list|(
literal|4
argument_list|,
literal|"revision"
argument_list|,
literal|"%d.%d"
argument_list|,
name|BCD
argument_list|(
name|sh
operator|->
name|sh_major
argument_list|)
argument_list|,
name|BCD
argument_list|(
name|sh
operator|->
name|sh_minor
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_cpu
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_cpu
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|sh
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_memory
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_memory
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|sh
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_sel
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_sel
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_pci_bus
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_pci_bus
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|sh
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_smbios
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_smbios
argument_list|()
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_pci_dev
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_pci_dev
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|(
name|sh
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|uuid_equal
argument_list|(
operator|&
name|sh
operator|->
name|sh_uuid
argument_list|,
operator|&
name|uuid_generic
argument_list|,
name|NULL
argument_list|)
condition|)
name|show_generic
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"</section>\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|sh
operator|->
name|sh_length
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show
parameter_list|(
name|char
modifier|*
name|data
parameter_list|)
block|{
name|size_t
name|reclen
decl_stmt|,
name|seclen
decl_stmt|;
name|printf
argument_list|(
literal|"<record>\n"
argument_list|)
expr_stmt|;
name|reclen
operator|=
name|show_header
argument_list|(
operator|(
name|void
operator|*
operator|)
name|data
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|mca_record_header
argument_list|)
expr_stmt|;
name|data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|mca_record_header
argument_list|)
expr_stmt|;
while|while
condition|(
name|reclen
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|mca_section_header
argument_list|)
condition|)
block|{
name|seclen
operator|=
name|show_section
argument_list|(
operator|(
name|void
operator|*
operator|)
name|data
argument_list|)
expr_stmt|;
name|reclen
operator|-=
name|seclen
expr_stmt|;
name|data
operator|+=
name|seclen
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"</record>\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|showall
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|mca_record_header
modifier|*
name|rh
decl_stmt|;
name|size_t
name|reclen
decl_stmt|;
do|do
block|{
if|if
condition|(
name|buflen
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|mca_record_header
argument_list|)
condition|)
return|return;
name|rh
operator|=
operator|(
name|void
operator|*
operator|)
name|buf
expr_stmt|;
name|reclen
operator|=
name|rh
operator|->
name|rh_length
expr_stmt|;
if|if
condition|(
name|buflen
operator|<
name|reclen
condition|)
return|return;
name|show
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
name|reclen
expr_stmt|;
name|buflen
operator|-=
name|reclen
expr_stmt|;
block|}
do|while
condition|(
literal|1
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|dump
parameter_list|(
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|mca_record_header
modifier|*
name|rh
decl_stmt|;
specifier|const
name|char
modifier|*
name|fn
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|rh
operator|=
operator|(
name|void
operator|*
operator|)
name|data
expr_stmt|;
name|fn
operator|=
operator|(
name|file
operator|)
condition|?
name|file
else|:
name|default_dumpfile
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|fn
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_APPEND
argument_list|,
literal|0660
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"open(%s)"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|void
operator|*
operator|)
name|rh
argument_list|,
name|rh
operator|->
name|rh_length
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|2
argument_list|,
literal|"write(%s)"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: mca [-df]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
name|mib
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|error
decl_stmt|,
name|fd
decl_stmt|;
name|int
name|count
decl_stmt|,
name|first
decl_stmt|,
name|last
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"df:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'d'
case|:
comment|/* dump */
name|fl_dump
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
if|if
condition|(
name|file
condition|)
name|free
argument_list|(
name|file
argument_list|)
expr_stmt|;
comment|/* XXX complain! */
name|file
operator|=
name|strdup
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
operator|||
name|fl_dump
condition|)
block|{
name|len
operator|=
sizeof|sizeof
argument_list|(
name|count
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|hw_mca_count
argument_list|,
operator|&
name|count
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|hw_mca_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|0
argument_list|,
literal|"no error records found"
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|first
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|hw_mca_first
argument_list|,
operator|&
name|first
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|hw_mca_first
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|last
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|hw_mca_last
argument_list|,
operator|&
name|last
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|hw_mca_last
argument_list|)
expr_stmt|;
while|while
condition|(
name|count
operator|&&
name|first
operator|<=
name|last
condition|)
block|{
name|sprintf
argument_list|(
name|mib
argument_list|,
name|hw_mca_recid
argument_list|,
name|first
argument_list|)
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|mib
argument_list|,
name|NULL
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOENT
condition|)
block|{
name|first
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|error
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s(1)"
argument_list|,
name|mib
argument_list|)
expr_stmt|;
name|buf
operator|=
name|malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"buffer"
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctlbyname
argument_list|(
name|mib
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s(2)"
argument_list|,
name|mib
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl_dump
condition|)
name|dump
argument_list|(
name|buf
argument_list|)
expr_stmt|;
else|else
name|show
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|first
operator|++
expr_stmt|;
name|count
operator|--
expr_stmt|;
block|}
block|}
else|else
block|{
name|fd
operator|=
name|open
argument_list|(
name|file
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"open(%s)"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|len
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0LL
argument_list|,
name|SEEK_END
argument_list|)
expr_stmt|;
name|buf
operator|=
name|mmap
argument_list|(
name|NULL
argument_list|,
name|len
argument_list|,
name|PROT_READ
argument_list|,
literal|0U
argument_list|,
name|fd
argument_list|,
literal|0LL
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|MAP_FAILED
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"mmap(%s)"
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|showall
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|munmap
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


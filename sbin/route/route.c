begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983, 1989, 1991, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983, 1989, 1991, 1993\n\ 	The Regents of the University of California.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#)route.c	8.6 (Berkeley) 4/28/95";
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ifaddrs.h>
end_include

begin_struct
struct|struct
name|fibl
block|{
name|TAILQ_ENTRY
argument_list|(
argument|fibl
argument_list|)
name|fl_next
expr_stmt|;
name|int
name|fl_num
decl_stmt|;
name|int
name|fl_error
decl_stmt|;
name|int
name|fl_errno
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
name|keytab
block|{
specifier|const
name|char
modifier|*
name|kt_cp
decl_stmt|;
name|int
name|kt_i
decl_stmt|;
block|}
decl|const
name|keywords
index|[]
init|=
block|{
include|#
directive|include
file|"keywords.h"
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|sockaddr_storage
name|so
index|[
name|RTAX_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|pid
decl_stmt|,
name|rtm_addrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nflag
decl_stmt|,
name|af
decl_stmt|,
name|qflag
decl_stmt|,
name|tflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|verbose
decl_stmt|,
name|aflen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|locking
decl_stmt|,
name|lockrest
decl_stmt|,
name|debugonly
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|rt_metrics
name|rt_metrics
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_long
name|rtm_inits
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uid_t
name|uid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|defaultfib
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|numfibs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|domain
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bool
name|domain_initialized
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|rtm_seq
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|rt_line
index|[
name|NI_MAXHOST
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|net_line
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|struct
name|rt_msghdr
name|m_rtm
decl_stmt|;
name|char
name|m_space
index|[
literal|512
index|]
decl_stmt|;
block|}
name|m_rtmsg
struct|;
end_struct

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument|fibl_head_t
argument_list|,
argument|fibl
argument_list|)
name|fibl_head
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|void
name|printb
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|flushroutes
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|flushroutes_fib
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|getaddr
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
parameter_list|,
name|struct
name|hostent
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|keyword
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_function_decl
specifier|static
name|void
name|inet_makenetandmask
parameter_list|(
name|u_long
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
parameter_list|,
name|u_long
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function_decl
specifier|static
name|int
name|inet6_makenetandmask
parameter_list|(
name|struct
name|sockaddr_in6
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|interfaces
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|monitor
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
index|[]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|netname
parameter_list|(
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|newroute
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|newroute_fib
parameter_list|(
name|int
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pmsg_addrs
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|pmsg_common
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|prefixlen
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_getmsg
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_rtmsg
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|routename
parameter_list|(
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|rtmsg
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_metric
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|set_sofib
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sockaddr
parameter_list|(
name|char
modifier|*
parameter_list|,
name|struct
name|sockaddr
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sodump
parameter_list|(
name|struct
name|sockaddr
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fiboptlist_csv
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|fibl_head_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|fiboptlist_range
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|fibl_head_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|void
name|usage
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
name|__dead2
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|READ_TIMEOUT
value|10
end_define

begin_decl_stmt
specifier|static
specifier|volatile
name|sig_atomic_t
name|stop_read
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|stopit
parameter_list|(
name|int
name|sig
name|__unused
parameter_list|)
block|{
name|stop_read
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|)
block|{
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
name|warnx
argument_list|(
literal|"bad keyword: %s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"usage: route [-46dnqtv] command [[modifiers] args]"
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"46nqdtv"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'4'
case|:
ifdef|#
directive|ifdef
name|INET
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
else|#
directive|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"IPv4 support is not compiled in"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'6'
case|:
ifdef|#
directive|ifdef
name|INET6
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
else|#
directive|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"IPv6 support is not compiled in"
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|'n'
case|:
name|nflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|qflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|tflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|debugonly
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
name|pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|uid
operator|=
name|geteuid
argument_list|()
expr_stmt|;
if|if
condition|(
name|tflag
condition|)
name|s
operator|=
name|open
argument_list|(
name|_PATH_DEVNULL
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|s
operator|=
name|socket
argument_list|(
name|PF_ROUTE
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"socket"
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|numfibs
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctlbyname
argument_list|(
literal|"net.fibs"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|numfibs
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|numfibs
operator|=
operator|-
literal|1
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|defaultfib
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfibs
operator|!=
operator|-
literal|1
operator|&&
name|sysctlbyname
argument_list|(
literal|"net.my_fibnum"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|defaultfib
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|defaultfib
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|argv
operator|!=
name|NULL
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_GET
case|:
case|case
name|K_SHOW
case|:
name|uid
operator|=
literal|0
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_CHANGE
case|:
case|case
name|K_ADD
case|:
case|case
name|K_DEL
case|:
case|case
name|K_DELETE
case|:
name|newroute
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|K_MONITOR
case|:
name|monitor
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|K_FLUSH
case|:
name|flushroutes
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_function
specifier|static
name|int
name|set_sofib
parameter_list|(
name|int
name|fib
parameter_list|)
block|{
if|if
condition|(
name|fib
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_SETFIB
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|fib
argument_list|,
sizeof|sizeof
argument_list|(
name|fib
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|fiboptlist_range
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|struct
name|fibl_head_t
modifier|*
name|flh
parameter_list|)
block|{
name|struct
name|fibl
modifier|*
name|fl
decl_stmt|;
name|char
modifier|*
name|str0
decl_stmt|,
modifier|*
name|str
decl_stmt|,
modifier|*
name|token
decl_stmt|,
modifier|*
name|endptr
decl_stmt|;
name|int
name|fib
index|[
literal|2
index|]
decl_stmt|,
name|i
decl_stmt|,
name|error
decl_stmt|;
name|str0
operator|=
name|str
operator|=
name|strdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|token
operator|=
name|strsep
argument_list|(
operator|&
name|str
argument_list|,
literal|"-"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
name|errno
operator|=
literal|0
expr_stmt|;
name|fib
index|[
name|i
index|]
operator|=
name|strtol
argument_list|(
name|token
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|'\0'
operator|||
name|fib
index|[
name|i
index|]
operator|<
literal|0
operator|||
operator|(
name|numfibs
operator|!=
operator|-
literal|1
operator|&&
name|fib
index|[
name|i
index|]
operator|>
name|numfibs
operator|-
literal|1
operator|)
condition|)
name|errno
operator|=
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|errno
condition|)
name|error
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|error
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
goto|goto
name|fiboptlist_range_ret
goto|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|fib
index|[
literal|0
index|]
operator|>=
name|fib
index|[
literal|1
index|]
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|fiboptlist_range_ret
goto|;
block|}
for|for
control|(
name|i
operator|=
name|fib
index|[
literal|0
index|]
init|;
name|i
operator|<=
name|fib
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
name|fl
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|fiboptlist_range_ret
goto|;
block|}
name|fl
operator|->
name|fl_num
operator|=
name|i
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
name|flh
argument_list|,
name|fl
argument_list|,
name|fl_next
argument_list|)
expr_stmt|;
block|}
name|fiboptlist_range_ret
label|:
name|free
argument_list|(
name|str0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ALLSTRLEN
value|64
end_define

begin_function
specifier|static
name|int
name|fiboptlist_csv
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|struct
name|fibl_head_t
modifier|*
name|flh
parameter_list|)
block|{
name|struct
name|fibl
modifier|*
name|fl
decl_stmt|;
name|char
modifier|*
name|str0
decl_stmt|,
modifier|*
name|str
decl_stmt|,
modifier|*
name|token
decl_stmt|,
modifier|*
name|endptr
decl_stmt|;
name|int
name|fib
decl_stmt|,
name|error
decl_stmt|;
name|str0
operator|=
name|str
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
literal|"all"
argument_list|,
name|arg
argument_list|)
operator|==
literal|0
condition|)
block|{
name|str
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|ALLSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|fiboptlist_csv_ret
goto|;
block|}
if|if
condition|(
name|numfibs
operator|>
literal|1
condition|)
name|snprintf
argument_list|(
name|str
argument_list|,
name|ALLSTRLEN
operator|-
literal|1
argument_list|,
literal|"%d-%d"
argument_list|,
literal|0
argument_list|,
name|numfibs
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|snprintf
argument_list|(
name|str
argument_list|,
name|ALLSTRLEN
operator|-
literal|1
argument_list|,
literal|"%d"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"default"
argument_list|,
name|arg
argument_list|)
operator|==
literal|0
condition|)
block|{
name|str0
operator|=
name|str
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
name|ALLSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|fiboptlist_csv_ret
goto|;
block|}
name|snprintf
argument_list|(
name|str
argument_list|,
name|ALLSTRLEN
operator|-
literal|1
argument_list|,
literal|"%d"
argument_list|,
name|defaultfib
argument_list|)
expr_stmt|;
block|}
else|else
name|str0
operator|=
name|str
operator|=
name|strdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|token
operator|=
name|strsep
argument_list|(
operator|&
name|str
argument_list|,
literal|","
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
name|token
operator|!=
literal|'-'
operator|&&
name|strchr
argument_list|(
name|token
argument_list|,
literal|'-'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|fiboptlist_range
argument_list|(
name|token
argument_list|,
name|flh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fiboptlist_csv_ret
goto|;
block|}
else|else
block|{
name|errno
operator|=
literal|0
expr_stmt|;
name|fib
operator|=
name|strtol
argument_list|(
name|token
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|'\0'
operator|||
name|fib
operator|<
literal|0
operator|||
operator|(
name|numfibs
operator|!=
operator|-
literal|1
operator|&&
name|fib
operator|>
name|numfibs
operator|-
literal|1
operator|)
condition|)
name|errno
operator|=
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|errno
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|fiboptlist_csv_ret
goto|;
block|}
name|fl
operator|=
name|calloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|fiboptlist_csv_ret
goto|;
block|}
name|fl
operator|->
name|fl_num
operator|=
name|fib
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
name|flh
argument_list|,
name|fl
argument_list|,
name|fl_next
argument_list|)
expr_stmt|;
block|}
block|}
name|fiboptlist_csv_ret
label|:
if|if
condition|(
name|str0
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|str0
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Purge all entries in the routing tables not  * associated with network interfaces.  */
end_comment

begin_function
specifier|static
name|void
name|flushroutes
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|fibl
modifier|*
name|fl
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|uid
operator|!=
literal|0
operator|&&
operator|!
name|debugonly
operator|&&
operator|!
name|tflag
condition|)
name|errx
argument_list|(
name|EX_NOPERM
argument_list|,
literal|"must be root to alter routing table"
argument_list|)
expr_stmt|;
name|shutdown
argument_list|(
name|s
argument_list|,
name|SHUT_RD
argument_list|)
expr_stmt|;
comment|/* Don't want to read back our messages */
name|TAILQ_INIT
argument_list|(
operator|&
name|fibl_head
argument_list|)
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|argv
operator|!=
literal|'-'
condition|)
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
operator|+
literal|1
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|K_4
case|:
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|K_6
case|:
case|case
name|K_INET6
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
break|break;
case|case
name|K_FIB
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|error
operator|=
name|fiboptlist_csv
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
operator|&
name|fibl_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"invalid fib number: %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|fibl_head
argument_list|)
condition|)
block|{
name|error
operator|=
name|fiboptlist_csv
argument_list|(
literal|"default"
argument_list|,
operator|&
name|fibl_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"fiboptlist_csv failed."
argument_list|)
expr_stmt|;
block|}
name|TAILQ_FOREACH
argument_list|(
argument|fl
argument_list|,
argument|&fibl_head
argument_list|,
argument|fl_next
argument_list|)
name|flushroutes_fib
argument_list|(
name|fl
operator|->
name|fl_num
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|flushroutes_fib
parameter_list|(
name|int
name|fib
parameter_list|)
block|{
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|size_t
name|needed
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|next
decl_stmt|,
modifier|*
name|lim
decl_stmt|;
name|int
name|mib
index|[
literal|7
index|]
decl_stmt|,
name|rlen
decl_stmt|,
name|seqno
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|set_sofib
argument_list|(
name|fib
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|warn
argument_list|(
literal|"fib number %d is ignored"
argument_list|,
name|fib
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|retry
label|:
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|PF_ROUTE
expr_stmt|;
name|mib
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* protocol */
name|mib
index|[
literal|3
index|]
operator|=
name|AF_UNSPEC
expr_stmt|;
name|mib
index|[
literal|4
index|]
operator|=
name|NET_RT_DUMP
expr_stmt|;
name|mib
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* no flags */
name|mib
index|[
literal|6
index|]
operator|=
name|fib
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
name|nitems
argument_list|(
name|mib
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"route-sysctl-estimate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|needed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
name|nitems
argument_list|(
name|mib
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOMEM
operator|&&
name|count
operator|++
operator|<
literal|10
condition|)
block|{
name|warnx
argument_list|(
literal|"Routing table grew, retrying"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"route-sysctl-get"
argument_list|)
expr_stmt|;
block|}
name|lim
operator|=
name|buf
operator|+
name|needed
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Examining routing table from sysctl\n"
argument_list|)
expr_stmt|;
name|seqno
operator|=
literal|0
expr_stmt|;
comment|/* ??? */
for|for
control|(
name|next
operator|=
name|buf
init|;
name|next
operator|<
name|lim
condition|;
name|next
operator|+=
name|rtm
operator|->
name|rtm_msglen
control|)
block|{
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|next
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_GATEWAY
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|af
operator|!=
literal|0
condition|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|!=
name|af
condition|)
continue|continue;
block|}
if|if
condition|(
name|debugonly
condition|)
continue|continue;
name|rtm
operator|->
name|rtm_type
operator|=
name|RTM_DELETE
expr_stmt|;
name|rtm
operator|->
name|rtm_seq
operator|=
name|seqno
expr_stmt|;
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
name|next
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EPERM
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write to routing socket"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|<
operator|(
name|int
operator|)
name|rtm
operator|->
name|rtm_msglen
condition|)
block|{
name|warn
argument_list|(
literal|"write to routing socket"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
break|break;
block|}
name|seqno
operator|++
expr_stmt|;
if|if
condition|(
name|qflag
condition|)
continue|continue;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
else|else
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_HOST
condition|?
name|routename
argument_list|(
name|sa
argument_list|)
else|:
name|netname
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
operator|+
operator|(
name|char
operator|*
operator|)
name|sa
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fib
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"-fib %-3d "
argument_list|,
name|fib
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|routename
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
operator|!
name|domain_initialized
condition|)
block|{
name|domain_initialized
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|domain
argument_list|,
name|MAXHOSTNAMELEN
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|domain
argument_list|,
literal|'.'
argument_list|)
operator|)
condition|)
block|{
name|domain
index|[
name|MAXHOSTNAMELEN
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|domain
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|domain
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* If the address is zero-filled, use "default". */
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
literal|0
operator|&&
name|nflag
operator|==
literal|0
condition|)
return|return
operator|(
literal|"default"
operator|)
return|;
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
comment|/* If the address is zero-filled, use "default". */
if|if
condition|(
name|nflag
operator|==
literal|0
operator|&&
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
name|INADDR_ANY
condition|)
return|return
operator|(
literal|"default"
operator|)
return|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
comment|/* If the address is zero-filled, use "default". */
if|if
condition|(
name|nflag
operator|==
literal|0
operator|&&
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin6_addr
argument_list|)
condition|)
return|return
operator|(
literal|"default"
operator|)
return|;
break|break;
endif|#
directive|endif
block|}
endif|#
directive|endif
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
endif|#
directive|endif
block|{
name|struct
name|sockaddr_storage
name|ss
decl_stmt|;
name|int
name|error
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ss
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
literal|0
condition|)
name|ss
operator|.
name|ss_family
operator|=
name|sa
operator|->
name|sa_family
expr_stmt|;
else|else
name|memcpy
argument_list|(
operator|&
name|ss
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
comment|/* Expand sa->sa_len because it could be shortened. */
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
name|ss
operator|.
name|ss_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
name|ss
operator|.
name|ss_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|error
operator|=
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ss
argument_list|,
name|ss
operator|.
name|ss_len
argument_list|,
name|rt_line
argument_list|,
sizeof|sizeof
argument_list|(
name|rt_line
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|nflag
operator|==
literal|0
operator|)
condition|?
literal|0
else|:
name|NI_NUMERICHOST
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|warnx
argument_list|(
literal|"getnameinfo(): %s"
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|rt_line
argument_list|,
literal|"invalid"
argument_list|,
sizeof|sizeof
argument_list|(
name|rt_line
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Remove the domain part if any. */
name|p
operator|=
name|strchr
argument_list|(
name|rt_line
argument_list|,
literal|'.'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|p
operator|+
literal|1
argument_list|,
name|domain
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|rt_line
operator|)
return|;
break|break;
block|}
endif|#
directive|endif
case|case
name|AF_LINK
case|:
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
expr_stmt|;
if|if
condition|(
name|sdl
operator|->
name|sdl_nlen
operator|==
literal|0
operator|&&
name|sdl
operator|->
name|sdl_alen
operator|==
literal|0
operator|&&
name|sdl
operator|->
name|sdl_slen
operator|==
literal|0
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|rt_line
argument_list|,
sizeof|sizeof
argument_list|(
name|rt_line
argument_list|)
argument_list|,
literal|"link#%d"
argument_list|,
name|sdl
operator|->
name|sdl_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|rt_line
argument_list|)
condition|)
name|rt_line
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|rt_line
operator|)
return|;
block|}
else|else
return|return
operator|(
name|link_ntoa
argument_list|(
name|sdl
argument_list|)
operator|)
return|;
break|break;
default|default:
block|{
name|u_short
modifier|*
name|sp
init|=
operator|(
name|u_short
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
decl_stmt|;
name|u_short
modifier|*
name|splim
init|=
name|sp
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cps
init|=
name|rt_line
operator|+
name|sprintf
argument_list|(
name|rt_line
argument_list|,
literal|"(%d)"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cpe
init|=
name|rt_line
operator|+
sizeof|sizeof
argument_list|(
name|rt_line
argument_list|)
decl_stmt|;
while|while
condition|(
operator|++
name|sp
operator|<
name|splim
operator|&&
name|cps
operator|<
name|cpe
condition|)
comment|/* start with sa->sa_data */
if|if
condition|(
operator|(
name|n
operator|=
name|snprintf
argument_list|(
name|cps
argument_list|,
name|cpe
operator|-
name|cps
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|sp
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|cps
operator|+=
name|n
expr_stmt|;
else|else
operator|*
name|cps
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|rt_line
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the name of the network whose address is given.  * The address is assumed to be that of a net, not a host.  */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|netname
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
name|int
name|n
decl_stmt|;
ifdef|#
directive|ifdef
name|INET
name|struct
name|netent
modifier|*
name|np
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|cp
init|=
name|NULL
decl_stmt|;
name|u_long
name|i
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|i
operator|=
name|in
operator|.
name|s_addr
operator|=
name|ntohl
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
literal|0
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|nflag
condition|)
block|{
name|np
operator|=
name|getnetbyaddr
argument_list|(
name|i
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
operator|!=
name|NULL
condition|)
name|cp
operator|=
name|np
operator|->
name|n_name
expr_stmt|;
block|}
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|)
value|(unsigned)((x)& 0xff)
if|if
condition|(
name|cp
operator|!=
name|NULL
condition|)
name|strncpy
argument_list|(
name|net_line
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
name|net_line
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|net_line
argument_list|,
literal|"%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|net_line
argument_list|,
literal|"%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|net_line
argument_list|,
literal|"%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|net_line
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|C
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
name|int
name|niflags
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sin6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
if|if
condition|(
name|nflag
condition|)
name|niflags
operator||=
name|NI_NUMERICHOST
expr_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
name|sin6
operator|.
name|sin6_len
argument_list|,
name|net_line
argument_list|,
sizeof|sizeof
argument_list|(
name|net_line
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|niflags
argument_list|)
operator|!=
literal|0
condition|)
name|strncpy
argument_list|(
name|net_line
argument_list|,
literal|"invalid"
argument_list|,
sizeof|sizeof
argument_list|(
name|net_line
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|net_line
operator|)
return|;
block|}
endif|#
directive|endif
case|case
name|AF_LINK
case|:
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
expr_stmt|;
if|if
condition|(
name|sdl
operator|->
name|sdl_nlen
operator|==
literal|0
operator|&&
name|sdl
operator|->
name|sdl_alen
operator|==
literal|0
operator|&&
name|sdl
operator|->
name|sdl_slen
operator|==
literal|0
condition|)
block|{
name|n
operator|=
name|snprintf
argument_list|(
name|net_line
argument_list|,
sizeof|sizeof
argument_list|(
name|net_line
argument_list|)
argument_list|,
literal|"link#%d"
argument_list|,
name|sdl
operator|->
name|sdl_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|net_line
argument_list|)
condition|)
name|net_line
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|net_line
operator|)
return|;
block|}
else|else
return|return
operator|(
name|link_ntoa
argument_list|(
name|sdl
argument_list|)
operator|)
return|;
break|break;
default|default:
block|{
name|u_short
modifier|*
name|sp
init|=
operator|(
name|u_short
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
operator|->
name|sa_data
decl_stmt|;
name|u_short
modifier|*
name|splim
init|=
name|sp
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cps
init|=
name|net_line
operator|+
name|sprintf
argument_list|(
name|net_line
argument_list|,
literal|"af %d:"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cpe
init|=
name|net_line
operator|+
sizeof|sizeof
argument_list|(
name|net_line
argument_list|)
decl_stmt|;
while|while
condition|(
name|sp
operator|<
name|splim
operator|&&
name|cps
operator|<
name|cpe
condition|)
if|if
condition|(
operator|(
name|n
operator|=
name|snprintf
argument_list|(
name|cps
argument_list|,
name|cpe
operator|-
name|cps
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|sp
operator|++
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|cps
operator|+=
name|n
expr_stmt|;
else|else
operator|*
name|cps
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|net_line
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_metric
parameter_list|(
name|char
modifier|*
name|value
parameter_list|,
name|int
name|key
parameter_list|)
block|{
name|int
name|flag
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|endptr
decl_stmt|;
name|u_long
name|noval
decl_stmt|,
modifier|*
name|valp
init|=
operator|&
name|noval
decl_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
define|#
directive|define
name|caseof
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|case x: valp =&rt_metrics.z; flag = y; break
name|caseof
argument_list|(
name|K_MTU
argument_list|,
name|RTV_MTU
argument_list|,
name|rmx_mtu
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_HOPCOUNT
argument_list|,
name|RTV_HOPCOUNT
argument_list|,
name|rmx_hopcount
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_EXPIRE
argument_list|,
name|RTV_EXPIRE
argument_list|,
name|rmx_expire
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RECVPIPE
argument_list|,
name|RTV_RPIPE
argument_list|,
name|rmx_recvpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SENDPIPE
argument_list|,
name|RTV_SPIPE
argument_list|,
name|rmx_sendpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SSTHRESH
argument_list|,
name|RTV_SSTHRESH
argument_list|,
name|rmx_ssthresh
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTT
argument_list|,
name|RTV_RTT
argument_list|,
name|rmx_rtt
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTTVAR
argument_list|,
name|RTV_RTTVAR
argument_list|,
name|rmx_rttvar
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_WEIGHT
argument_list|,
name|RTV_WEIGHT
argument_list|,
name|rmx_weight
argument_list|)
expr_stmt|;
block|}
name|rtm_inits
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|lockrest
operator|||
name|locking
condition|)
name|rt_metrics
operator|.
name|rmx_locks
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|locking
condition|)
name|locking
operator|=
literal|0
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
operator|*
name|valp
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
operator|&&
operator|*
name|endptr
operator|!=
literal|'\0'
condition|)
name|errno
operator|=
name|EINVAL
expr_stmt|;
if|if
condition|(
name|errno
condition|)
name|err
argument_list|(
name|EX_USAGE
argument_list|,
literal|"%s"
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|&
name|RTV_EXPIRE
operator|&&
operator|(
name|value
index|[
literal|0
index|]
operator|==
literal|'+'
operator|||
name|value
index|[
literal|0
index|]
operator|==
literal|'-'
operator|)
condition|)
block|{
name|struct
name|timespec
name|ts
decl_stmt|;
name|clock_gettime
argument_list|(
name|CLOCK_REALTIME_FAST
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
operator|*
name|valp
operator|+=
name|ts
operator|.
name|tv_sec
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|F_ISHOST
value|0x01
end_define

begin_define
define|#
directive|define
name|F_FORCENET
value|0x02
end_define

begin_define
define|#
directive|define
name|F_FORCEHOST
value|0x04
end_define

begin_define
define|#
directive|define
name|F_PROXY
value|0x08
end_define

begin_define
define|#
directive|define
name|F_INTERFACE
value|0x10
end_define

begin_function
specifier|static
name|void
name|newroute
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|struct
name|sigaction
name|sa
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|fibl
modifier|*
name|fl
decl_stmt|;
name|char
modifier|*
name|cmd
decl_stmt|;
specifier|const
name|char
modifier|*
name|dest
decl_stmt|,
modifier|*
name|gateway
decl_stmt|,
modifier|*
name|errmsg
decl_stmt|;
name|int
name|key
decl_stmt|,
name|error
decl_stmt|,
name|flags
decl_stmt|,
name|nrflags
decl_stmt|,
name|fibnum
decl_stmt|;
if|if
condition|(
name|uid
operator|!=
literal|0
operator|&&
operator|!
name|debugonly
operator|&&
operator|!
name|tflag
condition|)
name|errx
argument_list|(
name|EX_NOPERM
argument_list|,
literal|"must be root to alter routing table"
argument_list|)
expr_stmt|;
name|dest
operator|=
name|NULL
expr_stmt|;
name|gateway
operator|=
name|NULL
expr_stmt|;
name|flags
operator|=
name|RTF_STATIC
expr_stmt|;
name|nrflags
operator|=
literal|0
expr_stmt|;
name|hp
operator|=
name|NULL
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|fibl_head
argument_list|)
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
literal|0
expr_stmt|;
name|sa
operator|.
name|sa_handler
operator|=
name|stopit
expr_stmt|;
if|if
condition|(
name|sigaction
argument_list|(
name|SIGALRM
argument_list|,
operator|&
name|sa
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|warn
argument_list|(
literal|"sigaction SIGALRM"
argument_list|)
expr_stmt|;
name|cmd
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|cmd
operator|!=
literal|'g'
operator|&&
operator|*
name|cmd
operator|!=
literal|'s'
condition|)
name|shutdown
argument_list|(
name|s
argument_list|,
name|SHUT_RD
argument_list|)
expr_stmt|;
comment|/* Don't want to read back our messages */
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|(
operator|++
name|argv
operator|)
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|key
operator|=
name|keyword
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET
case|case
name|K_4
case|:
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|K_6
case|:
case|case
name|K_INET6
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|K_SA
case|:
name|af
operator|=
name|PF_ROUTE
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFACE
case|:
case|case
name|K_INTERFACE
case|:
name|nrflags
operator||=
name|F_INTERFACE
expr_stmt|;
break|break;
case|case
name|K_NOSTATIC
case|:
name|flags
operator|&=
operator|~
name|RTF_STATIC
expr_stmt|;
break|break;
case|case
name|K_LOCK
case|:
name|locking
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_LOCKREST
case|:
name|lockrest
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_HOST
case|:
name|nrflags
operator||=
name|F_FORCEHOST
expr_stmt|;
break|break;
case|case
name|K_REJECT
case|:
name|flags
operator||=
name|RTF_REJECT
expr_stmt|;
break|break;
case|case
name|K_BLACKHOLE
case|:
name|flags
operator||=
name|RTF_BLACKHOLE
expr_stmt|;
break|break;
case|case
name|K_PROTO1
case|:
name|flags
operator||=
name|RTF_PROTO1
expr_stmt|;
break|break;
case|case
name|K_PROTO2
case|:
name|flags
operator||=
name|RTF_PROTO2
expr_stmt|;
break|break;
case|case
name|K_PROXY
case|:
name|nrflags
operator||=
name|F_PROXY
expr_stmt|;
break|break;
case|case
name|K_XRESOLVE
case|:
name|flags
operator||=
name|RTF_XRESOLVE
expr_stmt|;
break|break;
case|case
name|K_STATIC
case|:
name|flags
operator||=
name|RTF_STATIC
expr_stmt|;
break|break;
case|case
name|K_STICKY
case|:
name|flags
operator||=
name|RTF_STICKY
expr_stmt|;
break|break;
case|case
name|K_NOSTICK
case|:
name|flags
operator|&=
operator|~
name|RTF_STICKY
expr_stmt|;
break|break;
case|case
name|K_FIB
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|error
operator|=
name|fiboptlist_csv
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
operator|&
name|fibl_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"invalid fib number: %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFA
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_IFA
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFP
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_IFP
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_GENMASK
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_GENMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_GATEWAY
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_GATEWAY
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
name|gateway
operator|=
operator|*
name|argv
expr_stmt|;
break|break;
case|case
name|K_DST
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|getaddr
argument_list|(
name|RTAX_DST
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
operator|&
name|hp
argument_list|,
name|nrflags
argument_list|)
condition|)
name|nrflags
operator||=
name|F_ISHOST
expr_stmt|;
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
break|break;
case|case
name|K_NETMASK
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_NETMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_NET
case|:
name|nrflags
operator||=
name|F_FORCENET
expr_stmt|;
break|break;
case|case
name|K_PREFIXLEN
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|prefixlen
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|nrflags
operator|&=
operator|~
name|F_FORCENET
expr_stmt|;
name|nrflags
operator||=
name|F_ISHOST
expr_stmt|;
block|}
else|else
block|{
name|nrflags
operator||=
name|F_FORCENET
expr_stmt|;
name|nrflags
operator|&=
operator|~
name|F_ISHOST
expr_stmt|;
block|}
break|break;
case|case
name|K_MTU
case|:
case|case
name|K_HOPCOUNT
case|:
case|case
name|K_EXPIRE
case|:
case|case
name|K_RECVPIPE
case|:
case|case
name|K_SENDPIPE
case|:
case|case
name|K_SSTHRESH
case|:
case|case
name|K_RTT
case|:
case|case
name|K_RTTVAR
case|:
case|case
name|K_WEIGHT
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|set_metric
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_DST
operator|)
operator|==
literal|0
condition|)
block|{
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
if|if
condition|(
name|getaddr
argument_list|(
name|RTAX_DST
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|,
name|nrflags
argument_list|)
condition|)
name|nrflags
operator||=
name|F_ISHOST
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_GATEWAY
operator|)
operator|==
literal|0
condition|)
block|{
name|gateway
operator|=
operator|*
name|argv
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_GATEWAY
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|getaddr
argument_list|(
name|RTAX_NETMASK
argument_list|,
operator|*
name|argv
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
name|nrflags
operator||=
name|F_FORCENET
expr_stmt|;
block|}
block|}
block|}
comment|/* Do some sanity checks on resulting request */
if|if
condition|(
name|so
index|[
name|RTAX_DST
index|]
operator|.
name|ss_len
operator|==
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"destination parameter required"
argument_list|)
expr_stmt|;
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|so
index|[
name|RTAX_NETMASK
index|]
operator|.
name|ss_len
operator|!=
literal|0
operator|&&
name|so
index|[
name|RTAX_DST
index|]
operator|.
name|ss_family
operator|!=
name|so
index|[
name|RTAX_NETMASK
index|]
operator|.
name|ss_family
condition|)
block|{
name|warnx
argument_list|(
literal|"destination and netmask family need to be the same"
argument_list|)
expr_stmt|;
name|usage
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nrflags
operator|&
name|F_FORCEHOST
condition|)
block|{
name|nrflags
operator||=
name|F_ISHOST
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|af
operator|==
name|AF_INET6
condition|)
block|{
name|rtm_addrs
operator|&=
operator|~
name|RTA_NETMASK
expr_stmt|;
name|memset
argument_list|(
operator|&
name|so
index|[
name|RTAX_NETMASK
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|so
index|[
name|RTAX_NETMASK
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|nrflags
operator|&
name|F_FORCENET
condition|)
name|nrflags
operator|&=
operator|~
name|F_ISHOST
expr_stmt|;
name|flags
operator||=
name|RTF_UP
expr_stmt|;
if|if
condition|(
name|nrflags
operator|&
name|F_ISHOST
condition|)
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
if|if
condition|(
operator|(
name|nrflags
operator|&
name|F_INTERFACE
operator|)
operator|==
literal|0
condition|)
name|flags
operator||=
name|RTF_GATEWAY
expr_stmt|;
if|if
condition|(
name|nrflags
operator|&
name|F_PROXY
condition|)
name|flags
operator||=
name|RTF_ANNOUNCE
expr_stmt|;
if|if
condition|(
name|dest
operator|==
name|NULL
condition|)
name|dest
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|gateway
operator|==
name|NULL
condition|)
name|gateway
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|fibl_head
argument_list|)
condition|)
block|{
name|error
operator|=
name|fiboptlist_csv
argument_list|(
literal|"default"
argument_list|,
operator|&
name|fibl_head
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"fiboptlist_csv failed."
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|fl
argument_list|,
argument|&fibl_head
argument_list|,
argument|fl_next
argument_list|)
block|{
name|fl
operator|->
name|fl_error
operator|=
name|newroute_fib
argument_list|(
name|fl
operator|->
name|fl_num
argument_list|,
name|cmd
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|->
name|fl_error
condition|)
name|fl
operator|->
name|fl_errno
operator|=
name|errno
expr_stmt|;
name|error
operator|+=
name|fl
operator|->
name|fl_error
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'g'
operator|||
operator|*
name|cmd
operator|==
literal|'s'
condition|)
name|exit
argument_list|(
name|error
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|qflag
condition|)
block|{
name|fibnum
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|fl
argument_list|,
argument|&fibl_head
argument_list|,
argument|fl_next
argument_list|)
block|{
if|if
condition|(
name|fl
operator|->
name|fl_error
operator|==
literal|0
condition|)
name|fibnum
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|fibnum
operator|>
literal|0
condition|)
block|{
name|int
name|firstfib
init|=
literal|1
decl_stmt|;
name|printf
argument_list|(
literal|"%s %s %s"
argument_list|,
name|cmd
argument_list|,
operator|(
name|nrflags
operator|&
name|F_ISHOST
operator|)
condition|?
literal|"host"
else|:
literal|"net"
argument_list|,
name|dest
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|gateway
condition|)
name|printf
argument_list|(
literal|": gateway %s"
argument_list|,
name|gateway
argument_list|)
expr_stmt|;
if|if
condition|(
name|numfibs
operator|>
literal|1
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|fl
argument_list|,
argument|&fibl_head
argument_list|,
argument|fl_next
argument_list|)
block|{
if|if
condition|(
name|fl
operator|->
name|fl_error
operator|==
literal|0
operator|&&
name|fl
operator|->
name|fl_num
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|firstfib
condition|)
block|{
name|printf
argument_list|(
literal|" fib "
argument_list|)
expr_stmt|;
name|firstfib
operator|=
literal|0
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|fl
operator|->
name|fl_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|fibnum
operator|--
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|fibnum
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|fl
argument_list|,
argument|&fibl_head
argument_list|,
argument|fl_next
argument_list|)
block|{
if|if
condition|(
name|fl
operator|->
name|fl_error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s %s %s"
argument_list|,
name|cmd
argument_list|,
operator|(
name|nrflags
operator|&
name|F_ISHOST
operator|)
condition|?
literal|"host"
else|:
literal|"net"
argument_list|,
name|dest
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|gateway
condition|)
name|printf
argument_list|(
literal|": gateway %s"
argument_list|,
name|gateway
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|->
name|fl_num
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|" fib %d"
argument_list|,
name|fl
operator|->
name|fl_num
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|fl
operator|->
name|fl_errno
condition|)
block|{
case|case
name|ESRCH
case|:
name|errmsg
operator|=
literal|"not in table"
expr_stmt|;
break|break;
case|case
name|EBUSY
case|:
name|errmsg
operator|=
literal|"entry in use"
expr_stmt|;
break|break;
case|case
name|ENOBUFS
case|:
name|errmsg
operator|=
literal|"not enough memory"
expr_stmt|;
break|break;
case|case
name|EADDRINUSE
case|:
comment|/* 					 * handle recursion avoidance 					 * in rt_setgate() 					 */
name|errmsg
operator|=
literal|"gateway uses the same route"
expr_stmt|;
break|break;
case|case
name|EEXIST
case|:
name|errmsg
operator|=
literal|"route already in table"
expr_stmt|;
break|break;
default|default:
name|errmsg
operator|=
name|strerror
argument_list|(
name|fl
operator|->
name|fl_errno
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|": %s\n"
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
name|error
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
name|exit
argument_list|(
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|newroute_fib
parameter_list|(
name|int
name|fib
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
name|set_sofib
argument_list|(
name|fib
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|warn
argument_list|(
literal|"fib number %d is ignored"
argument_list|,
name|fib
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|rtmsg
argument_list|(
operator|*
name|cmd
argument_list|,
name|flags
argument_list|,
name|fib
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_function
specifier|static
name|void
name|inet_makenetandmask
parameter_list|(
name|u_long
name|net
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|sin
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|sin_mask
parameter_list|,
name|u_long
name|bits
parameter_list|)
block|{
name|u_long
name|mask
init|=
literal|0
decl_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
comment|/* 	 * MSB of net should be meaningful. 0/0 is exception. 	 */
if|if
condition|(
name|net
operator|>
literal|0
condition|)
while|while
condition|(
operator|(
name|net
operator|&
literal|0xff000000
operator|)
operator|==
literal|0
condition|)
name|net
operator|<<=
literal|8
expr_stmt|;
comment|/* 	 * If no /xx was specified we must calculate the 	 * CIDR address. 	 */
if|if
condition|(
operator|(
name|bits
operator|==
literal|0
operator|)
operator|&&
operator|(
name|net
operator|!=
literal|0
operator|)
condition|)
block|{
name|u_long
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0xff
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|net
operator|&
name|j
condition|)
block|{
break|break;
block|}
name|j
operator|<<=
literal|8
expr_stmt|;
block|}
comment|/* i holds the first non zero bit */
name|bits
operator|=
literal|32
operator|-
operator|(
name|i
operator|*
literal|8
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|bits
operator|!=
literal|0
condition|)
name|mask
operator|=
literal|0xffffffff
operator|<<
operator|(
literal|32
operator|-
name|bits
operator|)
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|net
argument_list|)
expr_stmt|;
name|sin_mask
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|sin_mask
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|sin_mask
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_comment
comment|/*  * XXX the function may need more improvement...  */
end_comment

begin_function
specifier|static
name|int
name|inet6_makenetandmask
parameter_list|(
name|struct
name|sockaddr_in6
modifier|*
name|sin6
parameter_list|,
specifier|const
name|char
modifier|*
name|plen
parameter_list|)
block|{
if|if
condition|(
name|plen
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|)
operator|&&
name|sin6
operator|->
name|sin6_scope_id
operator|==
literal|0
condition|)
name|plen
operator|=
literal|"0"
expr_stmt|;
block|}
if|if
condition|(
name|plen
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|plen
argument_list|,
literal|"128"
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
name|prefixlen
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Interpret an argument as a network address of some kind,  * returning 1 if a host address, 0 if a network address.  */
end_comment

begin_function
specifier|static
name|int
name|getaddr
parameter_list|(
name|int
name|idx
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|struct
name|hostent
modifier|*
modifier|*
name|hpp
parameter_list|,
name|int
name|nrflags
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|INET6
argument_list|)
name|char
modifier|*
name|q
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|idx
operator|<
literal|0
operator|||
name|idx
operator|>=
name|RTAX_MAX
condition|)
name|usage
argument_list|(
literal|"internal error"
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
literal|0
condition|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|INET6
argument_list|)
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
else|#
directive|else
name|af
operator|=
name|AF_LINK
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
ifndef|#
directive|ifndef
name|INET
name|hpp
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|rtm_addrs
operator||=
operator|(
literal|1
operator|<<
name|idx
operator|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|so
index|[
name|idx
index|]
expr_stmt|;
name|sa
operator|->
name|sa_family
operator|=
name|af
expr_stmt|;
name|sa
operator|->
name|sa_len
operator|=
name|aflen
expr_stmt|;
switch|switch
condition|(
name|idx
condition|)
block|{
case|case
name|RTAX_GATEWAY
case|:
if|if
condition|(
name|nrflags
operator|&
name|F_INTERFACE
condition|)
block|{
name|struct
name|ifaddrs
modifier|*
name|ifap
decl_stmt|,
modifier|*
name|ifa
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|sdl0
init|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|sdl
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|getifaddrs
argument_list|(
operator|&
name|ifap
argument_list|)
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"getifaddrs"
argument_list|)
expr_stmt|;
for|for
control|(
name|ifa
operator|=
name|ifap
init|;
name|ifa
operator|!=
name|NULL
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
control|)
block|{
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|str
argument_list|,
name|ifa
operator|->
name|ifa_name
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
expr_stmt|;
block|}
comment|/* If we found it, then use it */
if|if
condition|(
name|sdl
operator|!=
name|NULL
condition|)
block|{
comment|/* 				 * Note that we need to copy before calling 				 * freeifaddrs(). 				 */
name|memcpy
argument_list|(
name|sdl0
argument_list|,
name|sdl
argument_list|,
name|sdl
operator|->
name|sdl_len
argument_list|)
expr_stmt|;
block|}
name|freeifaddrs
argument_list|(
name|ifap
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdl
operator|!=
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
name|errx
argument_list|(
name|EX_DATAERR
argument_list|,
literal|"interface '%s' does not exist"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RTAX_IFP
case|:
name|sa
operator|->
name|sa_family
operator|=
name|AF_LINK
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|str
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Default is net 0.0.0.0/0 		 */
switch|switch
condition|(
name|idx
condition|)
block|{
case|case
name|RTAX_DST
case|:
name|nrflags
operator||=
name|F_FORCENET
expr_stmt|;
name|getaddr
argument_list|(
name|RTAX_NETMASK
argument_list|,
name|str
argument_list|,
literal|0
argument_list|,
name|nrflags
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|int
name|ecode
decl_stmt|;
name|q
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|idx
operator|==
name|RTAX_DST
operator|&&
operator|(
name|q
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|sa
operator|->
name|sa_family
expr_stmt|;
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
name|ecode
operator|=
name|getaddrinfo
argument_list|(
name|str
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
literal|0
operator|||
name|res
operator|->
name|ai_family
operator|!=
name|AF_INET6
operator|||
name|res
operator|->
name|ai_addrlen
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"%s: %s"
argument_list|,
name|str
argument_list|,
name|gai_strerror
argument_list|(
name|ecode
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sa
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
name|res
operator|->
name|ai_addrlen
argument_list|)
expr_stmt|;
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|!=
name|NULL
condition|)
operator|*
name|q
operator|++
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|idx
operator|==
name|RTAX_DST
condition|)
return|return
operator|(
name|inet6_makenetandmask
argument_list|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
argument_list|,
name|q
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
comment|/* INET6 */
case|case
name|AF_LINK
case|:
name|link_addr
argument_list|(
name|str
argument_list|,
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|PF_ROUTE
case|:
name|sockaddr
argument_list|(
name|str
argument_list|,
name|sa
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_storage
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
endif|#
directive|endif
default|default:
break|break;
block|}
ifdef|#
directive|ifdef
name|INET
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
expr_stmt|;
if|if
condition|(
name|hpp
operator|==
name|NULL
condition|)
name|hpp
operator|=
operator|&
name|hp
expr_stmt|;
operator|*
name|hpp
operator|=
name|NULL
expr_stmt|;
name|q
operator|=
name|strchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|!=
name|NULL
operator|&&
name|idx
operator|==
name|RTAX_DST
condition|)
block|{
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|=
name|inet_network
argument_list|(
name|str
argument_list|)
operator|)
operator|!=
name|INADDR_NONE
condition|)
block|{
name|inet_makenetandmask
argument_list|(
name|val
argument_list|,
name|sin
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|so
index|[
name|RTAX_NETMASK
index|]
argument_list|,
name|strtoul
argument_list|(
name|q
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|q
operator|=
literal|'/'
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|idx
operator|!=
name|RTAX_DST
operator|||
operator|(
name|nrflags
operator|&
name|F_FORCENET
operator|)
operator|==
literal|0
operator|)
operator|&&
name|inet_aton
argument_list|(
name|str
argument_list|,
operator|&
name|sin
operator|->
name|sin_addr
argument_list|)
condition|)
block|{
name|val
operator|=
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
name|idx
operator|!=
name|RTAX_DST
operator|||
name|nrflags
operator|&
name|F_FORCEHOST
operator|||
name|inet_lnaof
argument_list|(
name|sin
operator|->
name|sin_addr
argument_list|)
operator|!=
name|INADDR_ANY
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
block|{
name|val
operator|=
name|ntohl
argument_list|(
name|val
argument_list|)
expr_stmt|;
goto|goto
name|netdone
goto|;
block|}
block|}
if|if
condition|(
name|idx
operator|==
name|RTAX_DST
operator|&&
operator|(
name|nrflags
operator|&
name|F_FORCEHOST
operator|)
operator|==
literal|0
operator|&&
operator|(
operator|(
name|val
operator|=
name|inet_network
argument_list|(
name|str
argument_list|)
operator|)
operator|!=
name|INADDR_NONE
operator|||
operator|(
operator|(
name|np
operator|=
name|getnetbyname
argument_list|(
name|str
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|(
name|val
operator|=
name|np
operator|->
name|n_net
operator|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|netdone
label|:
name|inet_makenetandmask
argument_list|(
name|val
argument_list|,
name|sin
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|so
index|[
name|RTAX_NETMASK
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|hp
operator|=
name|gethostbyname
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
operator|!=
name|NULL
condition|)
block|{
operator|*
name|hpp
operator|=
name|hp
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|memmove
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_addr
argument_list|,
name|MIN
argument_list|(
operator|(
name|size_t
operator|)
name|hp
operator|->
name|h_length
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
operator|->
name|sin_addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
endif|#
directive|endif
name|errx
argument_list|(
name|EX_NOHOST
argument_list|,
literal|"bad address: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|prefixlen
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|len
init|=
name|atoi
argument_list|(
name|str
argument_list|)
decl_stmt|,
name|q
decl_stmt|,
name|r
decl_stmt|;
name|int
name|max
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
modifier|*
name|sin6
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|so
index|[
name|RTAX_NETMASK
index|]
decl_stmt|;
name|max
operator|=
literal|128
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin6
operator|->
name|sin6_addr
expr_stmt|;
name|sin6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sin6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin6
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|so
index|[
name|RTAX_NETMASK
index|]
decl_stmt|;
name|max
operator|=
literal|32
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|sin
operator|->
name|sin_addr
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"prefixlen not supported in this af"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|max
operator|<
name|len
condition|)
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"%s: invalid prefixlen"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|q
operator|=
name|len
operator|>>
literal|3
expr_stmt|;
name|r
operator|=
name|len
operator|&
literal|7
expr_stmt|;
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
literal|0
argument_list|,
name|max
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|>
literal|0
condition|)
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
literal|0xff
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|>
literal|0
condition|)
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|p
operator|+
name|q
operator|)
operator|=
operator|(
literal|0xff00
operator|>>
name|r
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|max
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
else|else
return|return
operator|(
name|len
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|interfaces
parameter_list|(
name|void
parameter_list|)
block|{
name|size_t
name|needed
decl_stmt|;
name|int
name|mib
index|[
literal|6
index|]
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|lim
decl_stmt|,
modifier|*
name|next
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|retry2
label|:
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|PF_ROUTE
expr_stmt|;
name|mib
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* protocol */
name|mib
index|[
literal|3
index|]
operator|=
name|AF_UNSPEC
expr_stmt|;
name|mib
index|[
literal|4
index|]
operator|=
name|NET_RT_IFLIST
expr_stmt|;
name|mib
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* no flags */
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
name|nitems
argument_list|(
name|mib
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"route-sysctl-estimate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|needed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
name|nitems
argument_list|(
name|mib
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOMEM
operator|&&
name|count
operator|++
operator|<
literal|10
condition|)
block|{
name|warnx
argument_list|(
literal|"Routing table grew, retrying"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|retry2
goto|;
block|}
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"actual retrieval of interface table"
argument_list|)
expr_stmt|;
block|}
name|lim
operator|=
name|buf
operator|+
name|needed
expr_stmt|;
for|for
control|(
name|next
operator|=
name|buf
init|;
name|next
operator|<
name|lim
condition|;
name|next
operator|+=
name|rtm
operator|->
name|rtm_msglen
control|)
block|{
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|next
expr_stmt|;
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|monitor
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|fib
decl_stmt|,
name|error
decl_stmt|;
name|char
name|msg
index|[
literal|2048
index|]
decl_stmt|,
modifier|*
name|endptr
decl_stmt|;
name|fib
operator|=
name|defaultfib
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|argv
operator|!=
literal|'-'
condition|)
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
operator|+
literal|1
argument_list|)
condition|)
block|{
case|case
name|K_FIB
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|fib
operator|=
name|strtol
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|'\0'
operator|||
name|fib
operator|<
literal|0
operator|||
operator|(
name|numfibs
operator|!=
operator|-
literal|1
operator|&&
name|fib
operator|>
name|numfibs
operator|-
literal|1
operator|)
condition|)
name|errno
operator|=
name|EINVAL
expr_stmt|;
block|}
if|if
condition|(
name|errno
condition|)
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"invalid fib number: %s"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
name|error
operator|=
name|set_sofib
argument_list|(
name|fib
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|errx
argument_list|(
name|EX_USAGE
argument_list|,
literal|"invalid fib number: %d"
argument_list|,
name|fib
argument_list|)
expr_stmt|;
name|verbose
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|debugonly
condition|)
block|{
name|interfaces
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|time_t
name|now
decl_stmt|;
name|n
operator|=
name|read
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\ngot message of size %d on %s"
argument_list|,
name|n
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|print_rtmsg
argument_list|(
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|rtmsg
parameter_list|(
name|int
name|cmd
parameter_list|,
name|int
name|flags
parameter_list|,
name|int
name|fib
parameter_list|)
block|{
name|int
name|rlen
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|m_rtmsg
operator|.
name|m_space
decl_stmt|;
name|int
name|l
decl_stmt|;
define|#
directive|define
name|NEXTADDR
parameter_list|(
name|w
parameter_list|,
name|u
parameter_list|)
define|\
value|if (rtm_addrs& (w)) {						\ 		l = SA_SIZE(&(u));					\ 		memmove(cp, (char *)&(u), l);				\ 		cp += l;						\ 		if (verbose)						\ 			sodump((struct sockaddr *)&(u), #w);		\ 	}
name|errno
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|m_rtmsg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
literal|'a'
condition|)
name|cmd
operator|=
name|RTM_ADD
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'c'
condition|)
name|cmd
operator|=
name|RTM_CHANGE
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'g'
operator|||
name|cmd
operator|==
literal|'s'
condition|)
block|{
name|cmd
operator|=
name|RTM_GET
expr_stmt|;
if|if
condition|(
name|so
index|[
name|RTAX_IFP
index|]
operator|.
name|ss_family
operator|==
literal|0
condition|)
block|{
name|so
index|[
name|RTAX_IFP
index|]
operator|.
name|ss_family
operator|=
name|AF_LINK
expr_stmt|;
name|so
index|[
name|RTAX_IFP
index|]
operator|.
name|ss_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
name|rtm_addrs
operator||=
name|RTA_IFP
expr_stmt|;
block|}
block|}
else|else
name|cmd
operator|=
name|RTM_DELETE
expr_stmt|;
define|#
directive|define
name|rtm
value|m_rtmsg.m_rtm
name|rtm
operator|.
name|rtm_type
operator|=
name|cmd
expr_stmt|;
name|rtm
operator|.
name|rtm_flags
operator|=
name|flags
expr_stmt|;
name|rtm
operator|.
name|rtm_version
operator|=
name|RTM_VERSION
expr_stmt|;
name|rtm
operator|.
name|rtm_seq
operator|=
operator|++
name|rtm_seq
expr_stmt|;
name|rtm
operator|.
name|rtm_addrs
operator|=
name|rtm_addrs
expr_stmt|;
name|rtm
operator|.
name|rtm_rmx
operator|=
name|rt_metrics
expr_stmt|;
name|rtm
operator|.
name|rtm_inits
operator|=
name|rtm_inits
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_DST
argument_list|,
name|so
index|[
name|RTAX_DST
index|]
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GATEWAY
argument_list|,
name|so
index|[
name|RTAX_GATEWAY
index|]
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_NETMASK
argument_list|,
name|so
index|[
name|RTAX_NETMASK
index|]
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GENMASK
argument_list|,
name|so
index|[
name|RTAX_GENMASK
index|]
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_IFP
argument_list|,
name|so
index|[
name|RTAX_IFP
index|]
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_IFA
argument_list|,
name|so
index|[
name|RTAX_IFA
index|]
argument_list|)
expr_stmt|;
name|rtm
operator|.
name|rtm_msglen
operator|=
name|l
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
operator|&
name|rtm
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugonly
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
name|l
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
switch|switch
condition|(
name|errno
condition|)
block|{
case|case
name|EPERM
case|:
name|err
argument_list|(
literal|1
argument_list|,
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESRCH
case|:
name|warnx
argument_list|(
literal|"route has not been found"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EEXIST
case|:
comment|/* Handled by newroute() */
break|break;
default|default:
name|warn
argument_list|(
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|cmd
operator|==
name|RTM_GET
condition|)
block|{
name|stop_read
operator|=
literal|0
expr_stmt|;
name|alarm
argument_list|(
name|READ_TIMEOUT
argument_list|)
expr_stmt|;
do|do
block|{
name|l
operator|=
name|read
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|l
operator|>
literal|0
operator|&&
name|stop_read
operator|==
literal|0
operator|&&
operator|(
name|rtm
operator|.
name|rtm_type
operator|!=
name|RTM_GET
operator|||
name|rtm
operator|.
name|rtm_seq
operator|!=
name|rtm_seq
operator|||
name|rtm
operator|.
name|rtm_pid
operator|!=
name|pid
operator|)
condition|)
do|;
if|if
condition|(
name|stop_read
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"read from routing socket timed out"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
else|else
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"read from routing socket"
argument_list|)
expr_stmt|;
else|else
name|print_getmsg
argument_list|(
operator|&
name|rtm
argument_list|,
name|l
argument_list|,
name|fib
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|rtm
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|msgtypes
index|[]
init|=
block|{
literal|""
block|,
literal|"RTM_ADD: Add Route"
block|,
literal|"RTM_DELETE: Delete Route"
block|,
literal|"RTM_CHANGE: Change Metrics or flags"
block|,
literal|"RTM_GET: Report Metrics"
block|,
literal|"RTM_LOSING: Kernel Suspects Partitioning"
block|,
literal|"RTM_REDIRECT: Told to use different route"
block|,
literal|"RTM_MISS: Lookup failed on this address"
block|,
literal|"RTM_LOCK: fix specified metrics"
block|,
literal|"RTM_OLDADD: caused by SIOCADDRT"
block|,
literal|"RTM_OLDDEL: caused by SIOCDELRT"
block|,
literal|"RTM_RESOLVE: Route created by cloning"
block|,
literal|"RTM_NEWADDR: address being added to iface"
block|,
literal|"RTM_DELADDR: address being removed from iface"
block|,
literal|"RTM_IFINFO: iface status change"
block|,
literal|"RTM_NEWMADDR: new multicast group membership on iface"
block|,
literal|"RTM_DELMADDR: multicast group membership removed from iface"
block|,
literal|"RTM_IFANNOUNCE: interface arrival/departure"
block|,
literal|"RTM_IEEE80211: IEEE 802.11 wireless event"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|metricnames
index|[]
init|=
literal|"\011weight\010rttvar\7rtt\6ssthresh\5sendpipe\4recvpipe\3expire"
literal|"\1mtu"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|routeflags
index|[]
init|=
literal|"\1UP\2GATEWAY\3HOST\4REJECT\5DYNAMIC\6MODIFIED\7DONE"
literal|"\012XRESOLVE\013LLINFO\014STATIC\015BLACKHOLE"
literal|"\017PROTO2\020PROTO1\021PRCLONING\022WASCLONED\023PROTO3"
literal|"\024FIXEDMTU\025PINNED\026LOCAL\027BROADCAST\030MULTICAST\035STICKY"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|ifnetflags
index|[]
init|=
literal|"\1UP\2BROADCAST\3DEBUG\4LOOPBACK\5PTP\6b6\7RUNNING\010NOARP"
literal|"\011PPROMISC\012ALLMULTI\013OACTIVE\014SIMPLEX\015LINK0\016LINK1"
literal|"\017LINK2\020MULTICAST"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|addrnames
index|[]
init|=
literal|"\1DST\2GATEWAY\3NETMASK\4GENMASK\5IFP\6IFA\7AUTHOR\010BRD"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
name|errfmt
index|[]
init|=
literal|"\n%s: truncated route message, only %zu bytes left\n"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|print_rtmsg
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
name|rtm
parameter_list|,
name|size_t
name|msglen
parameter_list|)
block|{
name|struct
name|if_msghdr
modifier|*
name|ifm
decl_stmt|;
name|struct
name|ifa_msghdr
modifier|*
name|ifam
decl_stmt|;
ifdef|#
directive|ifdef
name|RTM_NEWMADDR
name|struct
name|ifma_msghdr
modifier|*
name|ifmam
decl_stmt|;
endif|#
directive|endif
name|struct
name|if_announcemsghdr
modifier|*
name|ifan
decl_stmt|;
specifier|const
name|char
modifier|*
name|state
decl_stmt|;
if|if
condition|(
name|verbose
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"routing message version %d not understood\n"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rtm
operator|->
name|rtm_type
operator|<
name|nitems
argument_list|(
name|msgtypes
argument_list|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: "
argument_list|,
name|msgtypes
index|[
name|rtm
operator|->
name|rtm_type
index|]
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"unknown type %d: "
argument_list|,
name|rtm
operator|->
name|rtm_type
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"len %d, "
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
define|#
directive|define
name|REQUIRE
parameter_list|(
name|x
parameter_list|)
value|do {		\ 	if (msglen< sizeof(x))		\ 		goto badlen;		\ 	else				\ 		msglen -= sizeof(x);	\ 	} while (0)
switch|switch
condition|(
name|rtm
operator|->
name|rtm_type
condition|)
block|{
case|case
name|RTM_IFINFO
case|:
name|REQUIRE
argument_list|(
expr|struct
name|if_msghdr
argument_list|)
expr_stmt|;
name|ifm
operator|=
operator|(
expr|struct
name|if_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"if# %d, "
argument_list|,
name|ifm
operator|->
name|ifm_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifm
operator|->
name|ifm_data
operator|.
name|ifi_link_state
condition|)
block|{
case|case
name|LINK_STATE_DOWN
case|:
name|state
operator|=
literal|"down"
expr_stmt|;
break|break;
case|case
name|LINK_STATE_UP
case|:
name|state
operator|=
literal|"up"
expr_stmt|;
break|break;
default|default:
name|state
operator|=
literal|"unknown"
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"link: %s, flags:"
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|ifm
operator|->
name|ifm_flags
argument_list|,
name|ifnetflags
argument_list|)
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifm
operator|+
literal|1
operator|)
argument_list|,
name|ifm
operator|->
name|ifm_addrs
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_NEWADDR
case|:
case|case
name|RTM_DELADDR
case|:
name|REQUIRE
argument_list|(
expr|struct
name|ifa_msghdr
argument_list|)
expr_stmt|;
name|ifam
operator|=
operator|(
expr|struct
name|ifa_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"metric %d, flags:"
argument_list|,
name|ifam
operator|->
name|ifam_metric
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|ifam
operator|->
name|ifam_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifam
operator|+
literal|1
operator|)
argument_list|,
name|ifam
operator|->
name|ifam_addrs
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|RTM_NEWMADDR
case|case
name|RTM_NEWMADDR
case|:
case|case
name|RTM_DELMADDR
case|:
name|REQUIRE
argument_list|(
expr|struct
name|ifma_msghdr
argument_list|)
expr_stmt|;
name|ifmam
operator|=
operator|(
expr|struct
name|ifma_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifmam
operator|+
literal|1
operator|)
argument_list|,
name|ifmam
operator|->
name|ifmam_addrs
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|RTM_IFANNOUNCE
case|:
name|REQUIRE
argument_list|(
expr|struct
name|if_announcemsghdr
argument_list|)
expr_stmt|;
name|ifan
operator|=
operator|(
expr|struct
name|if_announcemsghdr
operator|*
operator|)
name|rtm
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"if# %d, what: "
argument_list|,
name|ifan
operator|->
name|ifan_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifan
operator|->
name|ifan_what
condition|)
block|{
case|case
name|IFAN_ARRIVAL
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"arrival"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFAN_DEPARTURE
case|:
name|printf
argument_list|(
literal|"departure"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"#%d"
argument_list|,
name|ifan
operator|->
name|ifan_what
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|rtm
operator|->
name|rtm_type
operator|<=
name|RTM_RESOLVE
condition|)
block|{
name|printf
argument_list|(
literal|"pid: %ld, seq %d, errno %d, flags:"
argument_list|,
operator|(
name|long
operator|)
name|rtm
operator|->
name|rtm_pid
argument_list|,
name|rtm
operator|->
name|rtm_seq
argument_list|,
name|rtm
operator|->
name|rtm_errno
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
name|pmsg_common
argument_list|(
name|rtm
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
block|}
else|else
name|printf
argument_list|(
literal|"type: %u, len: %zu\n"
argument_list|,
name|rtm
operator|->
name|rtm_type
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
block|}
return|return;
name|badlen
label|:
operator|(
name|void
operator|)
name|printf
argument_list|(
name|errfmt
argument_list|,
name|__func__
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|REQUIRE
block|}
end_function

begin_function
specifier|static
name|void
name|print_getmsg
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
name|rtm
parameter_list|,
name|int
name|msglen
parameter_list|,
name|int
name|fib
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sp
index|[
name|RTAX_MAX
index|]
decl_stmt|;
name|struct
name|timespec
name|ts
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|memset
argument_list|(
name|sp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sp
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"   route to: %s\n"
argument_list|,
name|routename
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|so
index|[
name|RTAX_DST
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
name|warnx
argument_list|(
literal|"routing message version %d not understood"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rtm
operator|->
name|rtm_msglen
operator|>
name|msglen
condition|)
block|{
name|warnx
argument_list|(
literal|"message length mismatch, in packet %d, returned %d"
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rtm
operator|->
name|rtm_errno
condition|)
block|{
name|errno
operator|=
name|rtm
operator|->
name|rtm_errno
expr_stmt|;
name|warn
argument_list|(
literal|"message indicates error %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
name|cp
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTAX_MAX
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|rtm
operator|->
name|rtm_addrs
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|sp
index|[
name|i
index|]
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
name|cp
operator|+=
name|SA_SIZE
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rtm
operator|->
name|rtm_addrs
operator|&
name|RTA_IFP
operator|)
operator|&&
operator|(
name|sp
index|[
name|RTAX_IFP
index|]
operator|->
name|sa_family
operator|!=
name|AF_LINK
operator|||
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sp
index|[
name|RTAX_IFP
index|]
operator|)
operator|->
name|sdl_nlen
operator|==
literal|0
operator|)
condition|)
name|sp
index|[
name|RTAX_IFP
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sp
index|[
name|RTAX_DST
index|]
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"destination: %s\n"
argument_list|,
name|routename
argument_list|(
name|sp
index|[
name|RTAX_DST
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
index|[
name|RTAX_NETMASK
index|]
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"       mask: %s\n"
argument_list|,
name|routename
argument_list|(
name|sp
index|[
name|RTAX_NETMASK
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
index|[
name|RTAX_GATEWAY
index|]
operator|&&
operator|(
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_GATEWAY
operator|)
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"    gateway: %s\n"
argument_list|,
name|routename
argument_list|(
name|sp
index|[
name|RTAX_GATEWAY
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fib
operator|>=
literal|0
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"        fib: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|fib
argument_list|)
expr_stmt|;
if|if
condition|(
name|sp
index|[
name|RTAX_IFP
index|]
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"  interface: %.*s\n"
argument_list|,
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sp
index|[
name|RTAX_IFP
index|]
operator|)
operator|->
name|sdl_nlen
argument_list|,
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sp
index|[
name|RTAX_IFP
index|]
operator|)
operator|->
name|sdl_data
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"      flags: "
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
define|#
directive|define
name|lock
parameter_list|(
name|f
parameter_list|)
value|((rtm->rtm_rmx.rmx_locks& __CONCAT(RTV_,f)) ? 'L' : ' ')
define|#
directive|define
name|msec
parameter_list|(
name|u
parameter_list|)
value|(((u) + 500) / 1000)
comment|/* usec to msec */
name|printf
argument_list|(
literal|"\n%9s %9s %9s %9s %9s %10s %9s\n"
argument_list|,
literal|"recvpipe"
argument_list|,
literal|"sendpipe"
argument_list|,
literal|"ssthresh"
argument_list|,
literal|"rtt,msec"
argument_list|,
literal|"mtu   "
argument_list|,
literal|"weight"
argument_list|,
literal|"expire"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8lu%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_recvpipe
argument_list|,
name|lock
argument_list|(
name|RPIPE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8lu%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_sendpipe
argument_list|,
name|lock
argument_list|(
name|SPIPE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8lu%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_ssthresh
argument_list|,
name|lock
argument_list|(
name|SSTHRESH
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8lu%c "
argument_list|,
name|msec
argument_list|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_rtt
argument_list|)
argument_list|,
name|lock
argument_list|(
name|RTT
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8lu%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_mtu
argument_list|,
name|lock
argument_list|(
name|MTU
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8lu%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_weight
argument_list|,
name|lock
argument_list|(
name|WEIGHT
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_expire
operator|>
literal|0
condition|)
name|clock_gettime
argument_list|(
name|CLOCK_REALTIME_FAST
argument_list|,
operator|&
name|ts
argument_list|)
expr_stmt|;
else|else
name|ts
operator|.
name|tv_sec
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c\n"
argument_list|,
call|(
name|long
call|)
argument_list|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_expire
operator|-
name|ts
operator|.
name|tv_sec
argument_list|)
argument_list|,
name|lock
argument_list|(
name|EXPIRE
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|lock
undef|#
directive|undef
name|msec
define|#
directive|define
name|RTA_IGN
value|(RTA_DST|RTA_GATEWAY|RTA_NETMASK|RTA_IFP|RTA_IFA|RTA_BRD)
if|if
condition|(
name|verbose
condition|)
name|pmsg_common
argument_list|(
name|rtm
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rtm
operator|->
name|rtm_addrs
operator|&
operator|~
name|RTA_IGN
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"sockaddrs: "
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|rtm
operator|->
name|rtm_addrs
argument_list|,
name|addrnames
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|RTA_IGN
block|}
end_function

begin_function
specifier|static
name|void
name|pmsg_common
parameter_list|(
name|struct
name|rt_msghdr
modifier|*
name|rtm
parameter_list|,
name|size_t
name|msglen
parameter_list|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nlocks: "
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_locks
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" inits: "
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|rtm
operator|->
name|rtm_inits
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
if|if
condition|(
name|msglen
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|rt_msghdr
argument_list|)
condition|)
name|pmsg_addrs
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
operator|)
argument_list|,
name|rtm
operator|->
name|rtm_addrs
argument_list|,
name|msglen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|rt_msghdr
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmsg_addrs
parameter_list|(
name|char
modifier|*
name|cp
parameter_list|,
name|int
name|addrs
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|addrs
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nsockaddrs: "
argument_list|)
expr_stmt|;
name|printb
argument_list|(
name|addrs
argument_list|,
name|addrnames
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RTAX_MAX
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|addrs
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|len
operator|<
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
name|errfmt
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|-=
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printb
parameter_list|(
name|int
name|b
parameter_list|,
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|gotsome
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
operator|(
name|i
operator|=
operator|*
name|str
operator|++
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|b
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|gotsome
operator|==
literal|0
condition|)
name|i
operator|=
literal|'<'
expr_stmt|;
else|else
name|i
operator|=
literal|','
expr_stmt|;
name|putchar
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|gotsome
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|=
operator|*
name|str
operator|)
operator|>
literal|32
condition|;
name|str
operator|++
control|)
name|putchar
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
operator|*
name|str
operator|>
literal|32
condition|)
name|str
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|gotsome
condition|)
name|putchar
argument_list|(
literal|'>'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|keyword
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|)
block|{
specifier|const
name|struct
name|keytab
modifier|*
name|kt
init|=
name|keywords
decl_stmt|;
while|while
condition|(
name|kt
operator|->
name|kt_cp
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|kt
operator|->
name|kt_cp
argument_list|,
name|cp
argument_list|)
operator|!=
literal|0
condition|)
name|kt
operator|++
expr_stmt|;
return|return
operator|(
name|kt
operator|->
name|kt_i
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sodump
parameter_list|(
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|,
specifier|const
name|char
modifier|*
name|which
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INET6
name|char
name|nbuf
index|[
name|INET6_ADDRSTRLEN
index|]
decl_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_LINK
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: link %s; "
argument_list|,
name|which
argument_list|,
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
argument_list|)
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: inet %s; "
argument_list|,
name|which
argument_list|,
name|inet_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: inet6 %s; "
argument_list|,
name|which
argument_list|,
name|inet_ntop
argument_list|(
name|sa
operator|->
name|sa_family
argument_list|,
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin6_addr
argument_list|,
name|nbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|nbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* States*/
end_comment

begin_define
define|#
directive|define
name|VIRGIN
value|0
end_define

begin_define
define|#
directive|define
name|GOTONE
value|1
end_define

begin_define
define|#
directive|define
name|GOTTWO
value|2
end_define

begin_comment
comment|/* Inputs */
end_comment

begin_define
define|#
directive|define
name|DIGIT
value|(4*0)
end_define

begin_define
define|#
directive|define
name|END
value|(4*1)
end_define

begin_define
define|#
directive|define
name|DELIM
value|(4*2)
end_define

begin_function
specifier|static
name|void
name|sockaddr
parameter_list|(
name|char
modifier|*
name|addr
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
name|sa
decl_stmt|;
name|char
modifier|*
name|cplim
init|=
name|cp
operator|+
name|size
decl_stmt|;
name|int
name|byte
init|=
literal|0
decl_stmt|,
name|state
init|=
name|VIRGIN
decl_stmt|,
name|new
init|=
literal|0
comment|/* foil gcc */
decl_stmt|;
name|memset
argument_list|(
name|cp
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'f'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'F'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|addr
operator|==
literal|'\0'
condition|)
name|state
operator||=
name|END
expr_stmt|;
else|else
name|state
operator||=
name|DELIM
expr_stmt|;
name|addr
operator|++
expr_stmt|;
switch|switch
condition|(
name|state
comment|/* | INPUT */
condition|)
block|{
case|case
name|GOTTWO
operator||
name|DIGIT
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|VIRGIN
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTONE
expr_stmt|;
name|byte
operator|=
name|new
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTTWO
expr_stmt|;
name|byte
operator|=
name|new
operator|+
operator|(
name|byte
operator|<<
literal|4
operator|)
expr_stmt|;
continue|continue;
default|default:
comment|/* | DELIM */
name|state
operator|=
name|VIRGIN
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|END
case|:
case|case
name|GOTTWO
operator||
name|END
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VIRGIN
operator||
name|END
case|:
break|break;
block|}
break|break;
block|}
do|while
condition|(
name|cp
operator|<
name|cplim
condition|)
do|;
name|sa
operator|->
name|sa_len
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sa
expr_stmt|;
block|}
end_function

end_unit


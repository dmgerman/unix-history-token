begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1983, 1989, 1991, 1993  *	The Regents of the University of California.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 4. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|copyright
index|[]
init|=
literal|"@(#) Copyright (c) 1983, 1989, 1991, 1993\n\ 	The Regents of the University of California.  All rights reserved.\n"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static char sccsid[] = "@(#)route.c	8.6 (Berkeley) 4/28/95";
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_include
include|#
directive|include
file|<netatalk/at.h>
end_include

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sysexits.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<ifaddrs.h>
end_include

begin_struct
struct|struct
name|keytab
block|{
name|char
modifier|*
name|kt_cp
decl_stmt|;
name|int
name|kt_i
decl_stmt|;
block|}
name|keywords
index|[]
init|=
block|{
include|#
directive|include
file|"keywords.h"
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|ortentry
name|route
decl_stmt|;
end_decl_stmt

begin_union
union|union
name|sockunion
block|{
name|struct
name|sockaddr
name|sa
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
endif|#
directive|endif
name|struct
name|sockaddr_at
name|sat
decl_stmt|;
name|struct
name|sockaddr_dl
name|sdl
decl_stmt|;
name|struct
name|sockaddr_inarp
name|sinarp
decl_stmt|;
name|struct
name|sockaddr_storage
name|ss
decl_stmt|;
comment|/* added to avoid memory overrun */
block|}
name|so_dst
union|,
name|so_gate
union|,
name|so_mask
union|,
name|so_genmask
union|,
name|so_ifa
union|,
name|so_ifp
union|;
end_union

begin_typedef
typedef|typedef
name|union
name|sockunion
modifier|*
name|sup
typedef|;
end_typedef

begin_decl_stmt
name|int
name|pid
decl_stmt|,
name|rtm_addrs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|forcehost
decl_stmt|,
name|forcenet
decl_stmt|,
name|doflush
decl_stmt|,
name|nflag
decl_stmt|,
name|af
decl_stmt|,
name|qflag
decl_stmt|,
name|tflag
decl_stmt|,
name|keyword
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iflag
decl_stmt|,
name|verbose
decl_stmt|,
name|aflen
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|locking
decl_stmt|,
name|lockrest
decl_stmt|,
name|debugonly
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|rt_metrics
name|rt_metrics
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_long
name|rtm_inits
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uid_t
name|uid
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|atalk_aton
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|at_addr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|atalk_ntoa
parameter_list|(
name|struct
name|at_addr
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|const
name|char
modifier|*
name|routename
argument_list|()
decl_stmt|,
modifier|*
name|netname
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|flushroutes
argument_list|()
decl_stmt|,
name|newroute
argument_list|()
decl_stmt|,
name|monitor
argument_list|()
decl_stmt|,
name|sockaddr
argument_list|()
decl_stmt|,
name|sodump
argument_list|()
decl_stmt|,
name|bprintf
argument_list|()
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|print_getmsg
argument_list|()
decl_stmt|,
name|print_rtmsg
argument_list|()
decl_stmt|,
name|pmsg_common
argument_list|()
decl_stmt|,
name|pmsg_addrs
argument_list|()
decl_stmt|,
name|mask_addr
argument_list|()
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function_decl
specifier|static
name|int
name|inet6_makenetandmask
parameter_list|(
name|struct
name|sockaddr_in6
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|getaddr
argument_list|()
decl_stmt|,
name|rtmsg
argument_list|()
decl_stmt|,
name|x25_makemask
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|prefixlen
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|iso_ntoa
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|void
name|usage
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
name|__dead2
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|usage
parameter_list|(
name|cp
parameter_list|)
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
block|{
if|if
condition|(
name|cp
condition|)
name|warnx
argument_list|(
literal|"bad keyword: %s"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: route [-dnqtv] command [[modifiers] args]\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EX_USAGE
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|ch
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"nqdtv"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'n'
case|:
name|nflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|qflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|tflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|debugonly
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
default|default:
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
name|pid
operator|=
name|getpid
argument_list|()
expr_stmt|;
name|uid
operator|=
name|geteuid
argument_list|()
expr_stmt|;
if|if
condition|(
name|tflag
condition|)
name|s
operator|=
name|open
argument_list|(
name|_PATH_DEVNULL
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|s
operator|=
name|socket
argument_list|(
name|PF_ROUTE
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"socket"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|argv
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_GET
case|:
name|uid
operator|=
literal|0
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_CHANGE
case|:
case|case
name|K_ADD
case|:
case|case
name|K_DELETE
case|:
name|newroute
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|K_MONITOR
case|:
name|monitor
argument_list|()
expr_stmt|;
comment|/* NOTREACHED */
case|case
name|K_FLUSH
case|:
name|flushroutes
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
comment|/* NOTREACHED */
block|}
end_function

begin_comment
comment|/*  * Purge all entries in the routing tables not  * associated with network interfaces.  */
end_comment

begin_function
name|void
name|flushroutes
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|size_t
name|needed
decl_stmt|;
name|int
name|mib
index|[
literal|6
index|]
decl_stmt|,
name|rlen
decl_stmt|,
name|seqno
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|next
decl_stmt|,
modifier|*
name|lim
decl_stmt|;
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
if|if
condition|(
name|uid
operator|&&
operator|!
name|debugonly
condition|)
block|{
name|errx
argument_list|(
name|EX_NOPERM
argument_list|,
literal|"must be root to alter routing table"
argument_list|)
expr_stmt|;
block|}
name|shutdown
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Don't want to read back our messages */
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|2
operator|&&
operator|*
operator|*
name|argv
operator|==
literal|'-'
condition|)
switch|switch
condition|(
name|keyword
argument_list|(
operator|*
name|argv
operator|+
literal|1
argument_list|)
condition|)
block|{
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|K_INET6
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|K_ATALK
case|:
name|af
operator|=
name|AF_APPLETALK
expr_stmt|;
break|break;
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad
goto|;
block|}
else|else
name|bad
label|:
name|usage
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
name|retry
label|:
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|PF_ROUTE
expr_stmt|;
name|mib
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* protocol */
name|mib
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
comment|/* wildcard address family */
name|mib
index|[
literal|4
index|]
operator|=
name|NET_RT_DUMP
expr_stmt|;
name|mib
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* no flags */
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|6
argument_list|,
name|NULL
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"route-sysctl-estimate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|needed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|6
argument_list|,
name|buf
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOMEM
operator|&&
name|count
operator|++
operator|<
literal|10
condition|)
block|{
name|warnx
argument_list|(
literal|"Routing table grew, retrying"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"route-sysctl-get"
argument_list|)
expr_stmt|;
block|}
name|lim
operator|=
name|buf
operator|+
name|needed
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"Examining routing table from sysctl\n"
argument_list|)
expr_stmt|;
name|seqno
operator|=
literal|0
expr_stmt|;
comment|/* ??? */
for|for
control|(
name|next
operator|=
name|buf
init|;
name|next
operator|<
name|lim
condition|;
name|next
operator|+=
name|rtm
operator|->
name|rtm_msglen
control|)
block|{
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|next
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_GATEWAY
operator|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|af
condition|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|!=
name|af
condition|)
continue|continue;
block|}
if|if
condition|(
name|debugonly
condition|)
continue|continue;
name|rtm
operator|->
name|rtm_type
operator|=
name|RTM_DELETE
expr_stmt|;
name|rtm
operator|->
name|rtm_seq
operator|=
name|seqno
expr_stmt|;
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
name|next
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EPERM
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"write to routing socket"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rlen
operator|<
operator|(
name|int
operator|)
name|rtm
operator|->
name|rtm_msglen
condition|)
block|{
name|warn
argument_list|(
literal|"write to routing socket"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"got only %d for rlen\n"
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
break|break;
block|}
name|seqno
operator|++
expr_stmt|;
if|if
condition|(
name|qflag
condition|)
continue|continue;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
else|else
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_HOST
condition|?
name|routename
argument_list|(
name|sa
argument_list|)
else|:
name|netname
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
operator|+
operator|(
name|char
operator|*
operator|)
name|sa
operator|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%-20.20s "
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|routename
parameter_list|(
name|sa
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
name|char
modifier|*
name|cp
decl_stmt|;
specifier|static
name|char
name|line
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
specifier|static
name|char
name|domain
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|int
name|first
init|=
literal|1
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|gethostname
argument_list|(
name|domain
argument_list|,
name|MAXHOSTNAMELEN
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|domain
argument_list|,
literal|'.'
argument_list|)
operator|)
condition|)
block|{
name|domain
index|[
name|MAXHOSTNAMELEN
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|domain
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|domain
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|line
argument_list|,
literal|"default"
argument_list|)
expr_stmt|;
else|else
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|cp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
name|INADDR_ANY
operator|||
name|sa
operator|->
name|sa_len
operator|<
literal|4
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
if|if
condition|(
name|cp
operator|==
literal|0
operator|&&
operator|!
name|nflag
condition|)
block|{
name|hp
operator|=
name|gethostbyaddr
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|in
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|hp
operator|->
name|h_name
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
name|domain
argument_list|)
condition|)
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
name|hp
operator|->
name|h_name
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cp
condition|)
block|{
name|strncpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|line
index|[
sizeof|sizeof
argument_list|(
name|line
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%s"
argument_list|,
name|inet_ntoa
argument_list|(
name|in
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
comment|/* use static var for safety */
name|int
name|niflags
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sin6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
ifdef|#
directive|ifdef
name|__KAME__
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
operator|&&
operator|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|||
name|IN6_IS_ADDR_MC_LINKLOCAL
argument_list|(
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|)
operator|&&
name|sin6
operator|.
name|sin6_scope_id
operator|==
literal|0
condition|)
block|{
name|sin6
operator|.
name|sin6_scope_id
operator|=
name|ntohs
argument_list|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|nflag
condition|)
name|niflags
operator||=
name|NI_NUMERICHOST
expr_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
name|sin6
operator|.
name|sin6_len
argument_list|,
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|niflags
argument_list|)
operator|!=
literal|0
condition|)
name|strncpy
argument_list|(
name|line
argument_list|,
literal|"invalid"
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|line
operator|)
return|;
block|}
endif|#
directive|endif
case|case
name|AF_APPLETALK
case|:
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
literal|"atalk %s"
argument_list|,
name|atalk_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_at
operator|*
operator|)
name|sa
operator|)
operator|->
name|sat_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"(%d)"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cpe
init|=
name|line
operator|+
sizeof|sizeof
argument_list|(
name|line
argument_list|)
decl_stmt|;
while|while
condition|(
operator|++
name|s
operator|<
name|slim
operator|&&
name|cp
operator|<
name|cpe
condition|)
comment|/* start with sa->sa_data */
if|if
condition|(
operator|(
name|n
operator|=
name|snprintf
argument_list|(
name|cp
argument_list|,
name|cpe
operator|-
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|cp
operator|+=
name|n
expr_stmt|;
else|else
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the name of the network whose address is given.  * The address is assumed to be that of a net or subnet, not a host.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|netname
parameter_list|(
name|sa
parameter_list|)
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
name|char
modifier|*
name|cp
init|=
literal|0
decl_stmt|;
specifier|static
name|char
name|line
index|[
name|MAXHOSTNAMELEN
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
init|=
literal|0
decl_stmt|;
name|u_long
name|net
decl_stmt|,
name|mask
decl_stmt|;
name|u_long
name|i
decl_stmt|;
name|int
name|n
decl_stmt|,
name|subnetshift
decl_stmt|;
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|in
decl_stmt|;
name|in
operator|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
expr_stmt|;
name|i
operator|=
name|in
operator|.
name|s_addr
operator|=
name|ntohl
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|.
name|s_addr
operator|==
literal|0
condition|)
name|cp
operator|=
literal|"default"
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|nflag
condition|)
block|{
if|if
condition|(
name|IN_CLASSA
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
name|subnetshift
operator|=
literal|8
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IN_CLASSB
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
name|subnetshift
operator|=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
name|subnetshift
operator|=
literal|4
expr_stmt|;
block|}
comment|/* 			 * If there are more bits than the standard mask 			 * would suggest, subnets must be in use. 			 * Guess at the subnet mask, assuming reasonable 			 * width subnet fields. 			 */
while|while
condition|(
name|in
operator|.
name|s_addr
operator|&
operator|~
name|mask
condition|)
name|mask
operator|=
operator|(
name|long
operator|)
name|mask
operator|>>
name|subnetshift
expr_stmt|;
name|net
operator|=
name|in
operator|.
name|s_addr
operator|&
name|mask
expr_stmt|;
while|while
condition|(
operator|(
name|mask
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
name|mask
operator|>>=
literal|1
operator|,
name|net
operator|>>=
literal|1
expr_stmt|;
name|np
operator|=
name|getnetbyaddr
argument_list|(
name|net
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
if|if
condition|(
name|np
condition|)
name|cp
operator|=
name|np
operator|->
name|n_name
expr_stmt|;
block|}
define|#
directive|define
name|C
parameter_list|(
name|x
parameter_list|)
value|(unsigned)((x)& 0xff)
if|if
condition|(
name|cp
condition|)
name|strncpy
argument_list|(
name|line
argument_list|,
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xffff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|in
operator|.
name|s_addr
operator|&
literal|0xff
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"%u.%u.%u.%u"
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|24
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|16
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
operator|>>
literal|8
argument_list|)
argument_list|,
name|C
argument_list|(
name|in
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|C
break|break;
block|}
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
comment|/* use static var for safety */
name|int
name|niflags
init|=
literal|0
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sin6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sin6
argument_list|,
name|sa
argument_list|,
name|sa
operator|->
name|sa_len
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
ifdef|#
directive|ifdef
name|__KAME__
if|if
condition|(
name|sa
operator|->
name|sa_len
operator|==
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
operator|&&
operator|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|||
name|IN6_IS_ADDR_MC_LINKLOCAL
argument_list|(
operator|&
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|)
operator|&&
name|sin6
operator|.
name|sin6_scope_id
operator|==
literal|0
condition|)
block|{
name|sin6
operator|.
name|sin6_scope_id
operator|=
name|ntohs
argument_list|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|nflag
condition|)
name|niflags
operator||=
name|NI_NUMERICHOST
expr_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin6
argument_list|,
name|sin6
operator|.
name|sin6_len
argument_list|,
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|niflags
argument_list|)
operator|!=
literal|0
condition|)
name|strncpy
argument_list|(
name|line
argument_list|,
literal|"invalid"
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|line
operator|)
return|;
block|}
endif|#
directive|endif
case|case
name|AF_APPLETALK
case|:
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|line
argument_list|,
sizeof|sizeof
argument_list|(
name|line
argument_list|)
argument_list|,
literal|"atalk %s"
argument_list|,
name|atalk_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_at
operator|*
operator|)
name|sa
operator|)
operator|->
name|sat_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LINK
case|:
return|return
operator|(
name|link_ntoa
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
argument_list|)
operator|)
return|;
default|default:
block|{
name|u_short
modifier|*
name|s
init|=
operator|(
name|u_short
operator|*
operator|)
name|sa
operator|->
name|sa_data
decl_stmt|;
name|u_short
modifier|*
name|slim
init|=
name|s
operator|+
operator|(
operator|(
name|sa
operator|->
name|sa_len
operator|+
literal|1
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|line
operator|+
name|sprintf
argument_list|(
name|line
argument_list|,
literal|"af %d:"
argument_list|,
name|sa
operator|->
name|sa_family
argument_list|)
decl_stmt|;
name|char
modifier|*
name|cpe
init|=
name|line
operator|+
sizeof|sizeof
argument_list|(
name|line
argument_list|)
decl_stmt|;
while|while
condition|(
name|s
operator|<
name|slim
operator|&&
name|cp
operator|<
name|cpe
condition|)
if|if
condition|(
operator|(
name|n
operator|=
name|snprintf
argument_list|(
name|cp
argument_list|,
name|cpe
operator|-
name|cp
argument_list|,
literal|" %x"
argument_list|,
operator|*
name|s
operator|++
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|cp
operator|+=
name|n
expr_stmt|;
else|else
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|line
operator|)
return|;
block|}
end_function

begin_function
name|void
name|set_metric
parameter_list|(
name|value
parameter_list|,
name|key
parameter_list|)
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|key
decl_stmt|;
block|{
name|int
name|flag
init|=
literal|0
decl_stmt|;
name|u_long
name|noval
decl_stmt|,
modifier|*
name|valp
init|=
operator|&
name|noval
decl_stmt|;
switch|switch
condition|(
name|key
condition|)
block|{
define|#
directive|define
name|caseof
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|case x: valp =&rt_metrics.z; flag = y; break
name|caseof
argument_list|(
name|K_MTU
argument_list|,
name|RTV_MTU
argument_list|,
name|rmx_mtu
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_HOPCOUNT
argument_list|,
name|RTV_HOPCOUNT
argument_list|,
name|rmx_hopcount
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_EXPIRE
argument_list|,
name|RTV_EXPIRE
argument_list|,
name|rmx_expire
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RECVPIPE
argument_list|,
name|RTV_RPIPE
argument_list|,
name|rmx_recvpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SENDPIPE
argument_list|,
name|RTV_SPIPE
argument_list|,
name|rmx_sendpipe
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_SSTHRESH
argument_list|,
name|RTV_SSTHRESH
argument_list|,
name|rmx_ssthresh
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTT
argument_list|,
name|RTV_RTT
argument_list|,
name|rmx_rtt
argument_list|)
expr_stmt|;
name|caseof
argument_list|(
name|K_RTTVAR
argument_list|,
name|RTV_RTTVAR
argument_list|,
name|rmx_rttvar
argument_list|)
expr_stmt|;
block|}
name|rtm_inits
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|lockrest
operator|||
name|locking
condition|)
name|rt_metrics
operator|.
name|rmx_locks
operator||=
name|flag
expr_stmt|;
if|if
condition|(
name|locking
condition|)
name|locking
operator|=
literal|0
expr_stmt|;
operator|*
name|valp
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|newroute
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
modifier|*
name|cmd
decl_stmt|,
modifier|*
name|dest
init|=
literal|""
decl_stmt|,
modifier|*
name|gateway
init|=
literal|""
decl_stmt|,
modifier|*
name|err
decl_stmt|;
name|int
name|ishost
init|=
literal|0
decl_stmt|,
name|proxy
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|,
name|attempts
decl_stmt|,
name|oerrno
decl_stmt|,
name|flags
init|=
name|RTF_STATIC
decl_stmt|;
name|int
name|key
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|uid
condition|)
block|{
name|errx
argument_list|(
name|EX_NOPERM
argument_list|,
literal|"must be root to alter routing table"
argument_list|)
expr_stmt|;
block|}
name|cmd
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|cmd
operator|!=
literal|'g'
condition|)
name|shutdown
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Don't want to read back our messages */
while|while
condition|(
operator|--
name|argc
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
operator|*
operator|(
operator|++
name|argv
operator|)
operator|==
literal|'-'
condition|)
block|{
switch|switch
condition|(
name|key
operator|=
name|keyword
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
condition|)
block|{
case|case
name|K_LINK
case|:
name|af
operator|=
name|AF_LINK
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_INET
case|:
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|K_INET6
case|:
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|K_ATALK
case|:
name|af
operator|=
name|AF_APPLETALK
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_at
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_SA
case|:
name|af
operator|=
name|PF_ROUTE
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|union
name|sockunion
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFACE
case|:
case|case
name|K_INTERFACE
case|:
name|iflag
operator|++
expr_stmt|;
break|break;
case|case
name|K_NOSTATIC
case|:
name|flags
operator|&=
operator|~
name|RTF_STATIC
expr_stmt|;
break|break;
case|case
name|K_LLINFO
case|:
name|flags
operator||=
name|RTF_LLINFO
expr_stmt|;
break|break;
case|case
name|K_LOCK
case|:
name|locking
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_LOCKREST
case|:
name|lockrest
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_HOST
case|:
name|forcehost
operator|++
expr_stmt|;
break|break;
case|case
name|K_REJECT
case|:
name|flags
operator||=
name|RTF_REJECT
expr_stmt|;
break|break;
case|case
name|K_BLACKHOLE
case|:
name|flags
operator||=
name|RTF_BLACKHOLE
expr_stmt|;
break|break;
case|case
name|K_PROTO1
case|:
name|flags
operator||=
name|RTF_PROTO1
expr_stmt|;
break|break;
case|case
name|K_PROTO2
case|:
name|flags
operator||=
name|RTF_PROTO2
expr_stmt|;
break|break;
case|case
name|K_PROXY
case|:
name|proxy
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|K_CLONING
case|:
name|flags
operator||=
name|RTF_CLONING
expr_stmt|;
break|break;
case|case
name|K_XRESOLVE
case|:
name|flags
operator||=
name|RTF_XRESOLVE
expr_stmt|;
break|break;
case|case
name|K_STATIC
case|:
name|flags
operator||=
name|RTF_STATIC
expr_stmt|;
break|break;
case|case
name|K_IFA
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_IFA
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_IFP
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_IFP
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_GENMASK
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GENMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_GATEWAY
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GATEWAY
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|K_DST
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|ishost
operator|=
name|getaddr
argument_list|(
name|RTA_DST
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
break|break;
case|case
name|K_NETMASK
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
operator|*
operator|++
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|K_NET
case|:
name|forcenet
operator|++
expr_stmt|;
break|break;
case|case
name|K_PREFIXLEN
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|prefixlen
argument_list|(
operator|*
operator|++
name|argv
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|forcenet
operator|=
literal|0
expr_stmt|;
name|ishost
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|forcenet
operator|=
literal|1
expr_stmt|;
name|ishost
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|K_MTU
case|:
case|case
name|K_HOPCOUNT
case|:
case|case
name|K_EXPIRE
case|:
case|case
name|K_RECVPIPE
case|:
case|case
name|K_SENDPIPE
case|:
case|case
name|K_SSTHRESH
case|:
case|case
name|K_RTT
case|:
case|case
name|K_RTTVAR
case|:
if|if
condition|(
operator|!
operator|--
name|argc
condition|)
name|usage
argument_list|(
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|set_metric
argument_list|(
operator|*
operator|++
name|argv
argument_list|,
name|key
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|1
operator|+
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_DST
operator|)
operator|==
literal|0
condition|)
block|{
name|dest
operator|=
operator|*
name|argv
expr_stmt|;
name|ishost
operator|=
name|getaddr
argument_list|(
name|RTA_DST
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_GATEWAY
operator|)
operator|==
literal|0
condition|)
block|{
name|gateway
operator|=
operator|*
name|argv
expr_stmt|;
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_GATEWAY
argument_list|,
operator|*
name|argv
argument_list|,
operator|&
name|hp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
operator|*
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|forcenet
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|forcehost
condition|)
block|{
name|ishost
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|af
operator|==
name|AF_INET6
condition|)
block|{
name|rtm_addrs
operator|&=
operator|~
name|RTA_NETMASK
expr_stmt|;
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|so_mask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|so_mask
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|forcenet
condition|)
name|ishost
operator|=
literal|0
expr_stmt|;
name|flags
operator||=
name|RTF_UP
expr_stmt|;
if|if
condition|(
name|ishost
condition|)
name|flags
operator||=
name|RTF_HOST
expr_stmt|;
if|if
condition|(
name|iflag
operator|==
literal|0
condition|)
name|flags
operator||=
name|RTF_GATEWAY
expr_stmt|;
if|if
condition|(
name|proxy
condition|)
block|{
name|so_dst
operator|.
name|sinarp
operator|.
name|sin_other
operator|=
name|SIN_PROXY
expr_stmt|;
name|flags
operator||=
name|RTF_ANNOUNCE
expr_stmt|;
block|}
for|for
control|(
name|attempts
operator|=
literal|1
init|;
condition|;
name|attempts
operator|++
control|)
block|{
name|errno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|=
name|rtmsg
argument_list|(
operator|*
name|cmd
argument_list|,
name|flags
argument_list|)
operator|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|errno
operator|!=
name|ENETUNREACH
operator|&&
name|errno
operator|!=
name|ESRCH
condition|)
break|break;
if|if
condition|(
name|af
operator|==
name|AF_INET
operator|&&
operator|*
name|gateway
operator|&&
name|hp
operator|&&
name|hp
operator|->
name|h_addr_list
index|[
literal|1
index|]
condition|)
block|{
name|hp
operator|->
name|h_addr_list
operator|++
expr_stmt|;
name|memmove
argument_list|(
operator|&
name|so_gate
operator|.
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_addr_list
index|[
literal|0
index|]
argument_list|,
name|MIN
argument_list|(
name|hp
operator|->
name|h_length
argument_list|,
sizeof|sizeof
argument_list|(
name|so_gate
operator|.
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'g'
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|qflag
condition|)
block|{
name|oerrno
operator|=
name|errno
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s %s %s"
argument_list|,
name|cmd
argument_list|,
name|ishost
condition|?
literal|"host"
else|:
literal|"net"
argument_list|,
name|dest
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|gateway
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|": gateway %s"
argument_list|,
name|gateway
argument_list|)
expr_stmt|;
if|if
condition|(
name|attempts
operator|>
literal|1
operator|&&
name|ret
operator|==
literal|0
operator|&&
name|af
operator|==
name|AF_INET
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|route
operator|.
name|rt_gateway
operator|)
operator|->
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|oerrno
condition|)
block|{
case|case
name|ESRCH
case|:
name|err
operator|=
literal|"not in table"
expr_stmt|;
break|break;
case|case
name|EBUSY
case|:
name|err
operator|=
literal|"entry in use"
expr_stmt|;
break|break;
case|case
name|ENOBUFS
case|:
name|err
operator|=
literal|"not enough memory"
expr_stmt|;
break|break;
case|case
name|EADDRINUSE
case|:
comment|/* handle recursion avoidance in rt_setgate() */
name|err
operator|=
literal|"gateway uses the same route"
expr_stmt|;
break|break;
case|case
name|EEXIST
case|:
name|err
operator|=
literal|"route already in table"
expr_stmt|;
break|break;
default|default:
name|err
operator|=
name|strerror
argument_list|(
name|oerrno
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|": %s\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
block|}
name|exit
argument_list|(
name|ret
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|inet_makenetandmask
parameter_list|(
name|net
parameter_list|,
name|sin
parameter_list|,
name|bits
parameter_list|)
name|u_long
name|net
decl_stmt|,
name|bits
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
block|{
name|u_long
name|addr
decl_stmt|,
name|mask
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
if|if
condition|(
name|net
operator|==
literal|0
condition|)
name|mask
operator|=
name|addr
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|net
operator|<
literal|128
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSA_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|net
operator|<
literal|65536
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSB_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|net
operator|<
literal|16777216L
condition|)
block|{
name|addr
operator|=
name|net
operator|<<
name|IN_CLASSC_NSHIFT
expr_stmt|;
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
name|net
expr_stmt|;
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSA_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSA_NET
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSB_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSB_NET
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|addr
operator|&
name|IN_CLASSC_HOST
operator|)
operator|==
literal|0
condition|)
name|mask
operator|=
name|IN_CLASSC_NET
expr_stmt|;
else|else
name|mask
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|bits
condition|)
name|mask
operator|=
literal|0xffffffff
operator|<<
operator|(
literal|32
operator|-
name|bits
operator|)
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|sin
operator|=
operator|&
name|so_mask
operator|.
name|sin
expr_stmt|;
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
name|mask
argument_list|)
expr_stmt|;
name|sin
operator|->
name|sin_len
operator|=
literal|0
expr_stmt|;
name|sin
operator|->
name|sin_family
operator|=
literal|0
expr_stmt|;
name|cp
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
operator|&
name|sin
operator|->
name|sin_addr
operator|+
literal|1
operator|)
expr_stmt|;
while|while
condition|(
operator|*
operator|--
name|cp
operator|==
literal|0
operator|&&
name|cp
operator|>
operator|(
name|char
operator|*
operator|)
name|sin
condition|)
empty_stmt|;
name|sin
operator|->
name|sin_len
operator|=
literal|1
operator|+
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sin
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_comment
comment|/*  * XXX the function may need more improvement...  */
end_comment

begin_function
specifier|static
name|int
name|inet6_makenetandmask
parameter_list|(
name|sin6
parameter_list|,
name|plen
parameter_list|)
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
name|char
modifier|*
name|plen
decl_stmt|;
block|{
name|struct
name|in6_addr
name|in6
decl_stmt|;
if|if
condition|(
operator|!
name|plen
condition|)
block|{
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|)
operator|&&
name|sin6
operator|->
name|sin6_scope_id
operator|==
literal|0
condition|)
block|{
name|plen
operator|=
literal|"0"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|0
index|]
operator|&
literal|0xe0
operator|)
operator|==
literal|0x20
condition|)
block|{
comment|/* aggregatable global unicast - RFC2374 */
name|memset
argument_list|(
operator|&
name|in6
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|in6
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|memcmp
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|8
index|]
argument_list|,
operator|&
name|in6
operator|.
name|s6_addr
index|[
literal|8
index|]
argument_list|,
literal|8
argument_list|)
condition|)
name|plen
operator|=
literal|"64"
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|plen
operator|||
name|strcmp
argument_list|(
name|plen
argument_list|,
literal|"128"
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
operator|(
name|void
operator|)
name|prefixlen
argument_list|(
name|plen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Interpret an argument as a network address of some kind,  * returning 1 if a host address, 0 if a network address.  */
end_comment

begin_function
name|int
name|getaddr
parameter_list|(
name|which
parameter_list|,
name|s
parameter_list|,
name|hpp
parameter_list|)
name|int
name|which
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|struct
name|hostent
modifier|*
modifier|*
name|hpp
decl_stmt|;
block|{
name|sup
name|su
decl_stmt|;
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
name|struct
name|netent
modifier|*
name|np
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|;
name|int
name|afamily
decl_stmt|;
comment|/* local copy of af so we can change it */
if|if
condition|(
name|af
operator|==
literal|0
condition|)
block|{
name|af
operator|=
name|AF_INET
expr_stmt|;
name|aflen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
name|afamily
operator|=
name|af
expr_stmt|;
name|rtm_addrs
operator||=
name|which
expr_stmt|;
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|RTA_DST
case|:
name|su
operator|=
operator|&
name|so_dst
expr_stmt|;
break|break;
case|case
name|RTA_GATEWAY
case|:
name|su
operator|=
operator|&
name|so_gate
expr_stmt|;
if|if
condition|(
name|iflag
condition|)
block|{
name|struct
name|ifaddrs
modifier|*
name|ifap
decl_stmt|,
modifier|*
name|ifa
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|sdl
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|getifaddrs
argument_list|(
operator|&
name|ifap
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getifaddrs"
argument_list|)
expr_stmt|;
for|for
control|(
name|ifa
operator|=
name|ifap
init|;
name|ifa
condition|;
name|ifa
operator|=
name|ifa
operator|->
name|ifa_next
control|)
block|{
if|if
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
name|ifa
operator|->
name|ifa_name
argument_list|)
condition|)
continue|continue;
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
expr_stmt|;
block|}
comment|/* If we found it, then use it */
if|if
condition|(
name|sdl
condition|)
block|{
comment|/* 				 * Copy is safe since we have a 				 * sockaddr_storage member in sockunion{}. 				 * Note that we need to copy before calling 				 * freeifaddrs(). 				 */
name|memcpy
argument_list|(
operator|&
name|su
operator|->
name|sdl
argument_list|,
name|sdl
argument_list|,
name|sdl
operator|->
name|sdl_len
argument_list|)
expr_stmt|;
block|}
name|freeifaddrs
argument_list|(
name|ifap
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdl
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
break|break;
case|case
name|RTA_NETMASK
case|:
name|su
operator|=
operator|&
name|so_mask
expr_stmt|;
break|break;
case|case
name|RTA_GENMASK
case|:
name|su
operator|=
operator|&
name|so_genmask
expr_stmt|;
break|break;
case|case
name|RTA_IFP
case|:
name|su
operator|=
operator|&
name|so_ifp
expr_stmt|;
name|afamily
operator|=
name|AF_LINK
expr_stmt|;
break|break;
case|case
name|RTA_IFA
case|:
name|su
operator|=
operator|&
name|so_ifa
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
literal|"internal error"
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
name|aflen
expr_stmt|;
name|su
operator|->
name|sa
operator|.
name|sa_family
operator|=
name|afamily
expr_stmt|;
comment|/* cases that don't want it have left already */
if|if
condition|(
name|strcmp
argument_list|(
name|s
argument_list|,
literal|"default"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Default is net 0.0.0.0/0  		 */
switch|switch
condition|(
name|which
condition|)
block|{
case|case
name|RTA_DST
case|:
name|forcenet
operator|++
expr_stmt|;
if|#
directive|if
literal|0
block|bzero(su, sizeof(*su));
comment|/* for readability */
endif|#
directive|endif
operator|(
name|void
operator|)
name|getaddr
argument_list|(
name|RTA_NETMASK
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
literal|0
block|case RTA_NETMASK: 		case RTA_GENMASK: 			bzero(su, sizeof(*su));
comment|/* for readability */
endif|#
directive|endif
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
switch|switch
condition|(
name|afamily
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|addrinfo
name|hints
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|int
name|ecode
decl_stmt|;
name|q
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|which
operator|==
name|RTA_DST
operator|&&
operator|(
name|q
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|'/'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
name|memset
argument_list|(
operator|&
name|hints
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|hints
argument_list|)
argument_list|)
expr_stmt|;
name|hints
operator|.
name|ai_family
operator|=
name|afamily
expr_stmt|;
comment|/*AF_INET6*/
name|hints
operator|.
name|ai_socktype
operator|=
name|SOCK_DGRAM
expr_stmt|;
comment|/*dummy*/
name|ecode
operator|=
name|getaddrinfo
argument_list|(
name|s
argument_list|,
name|NULL
argument_list|,
operator|&
name|hints
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|ecode
operator|!=
literal|0
operator|||
name|res
operator|->
name|ai_family
operator|!=
name|AF_INET6
operator|||
name|res
operator|->
name|ai_addrlen
operator|!=
sizeof|sizeof
argument_list|(
name|su
operator|->
name|sin6
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: %s\n"
argument_list|,
name|s
argument_list|,
name|gai_strerror
argument_list|(
name|ecode
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|su
operator|->
name|sin6
argument_list|,
name|res
operator|->
name|ai_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|su
operator|->
name|sin6
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__KAME__
if|if
condition|(
operator|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
name|su
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|||
name|IN6_IS_ADDR_MC_LINKLOCAL
argument_list|(
operator|&
name|su
operator|->
name|sin6
operator|.
name|sin6_addr
argument_list|)
operator|)
operator|&&
name|su
operator|->
name|sin6
operator|.
name|sin6_scope_id
condition|)
block|{
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|&
name|su
operator|->
name|sin6
operator|.
name|sin6_addr
operator|.
name|s6_addr
index|[
literal|2
index|]
operator|=
name|htons
argument_list|(
name|su
operator|->
name|sin6
operator|.
name|sin6_scope_id
argument_list|)
expr_stmt|;
name|su
operator|->
name|sin6
operator|.
name|sin6_scope_id
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
name|freeaddrinfo
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|!=
name|NULL
condition|)
operator|*
name|q
operator|++
operator|=
literal|'/'
expr_stmt|;
if|if
condition|(
name|which
operator|==
name|RTA_DST
condition|)
return|return
operator|(
name|inet6_makenetandmask
argument_list|(
operator|&
name|su
operator|->
name|sin6
argument_list|,
name|q
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
comment|/* INET6 */
case|case
name|AF_APPLETALK
case|:
if|if
condition|(
operator|!
name|atalk_aton
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sat
operator|.
name|sat_addr
argument_list|)
condition|)
name|errx
argument_list|(
name|EX_NOHOST
argument_list|,
literal|"bad address: %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
return|return
operator|(
name|forcehost
operator|||
name|su
operator|->
name|sat
operator|.
name|sat_addr
operator|.
name|s_node
operator|!=
literal|0
operator|)
return|;
case|case
name|AF_LINK
case|:
name|link_addr
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sdl
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|PF_ROUTE
case|:
name|su
operator|->
name|sa
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|su
argument_list|)
expr_stmt|;
name|sockaddr
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sa
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|AF_INET
case|:
default|default:
break|break;
block|}
if|if
condition|(
name|hpp
operator|==
name|NULL
condition|)
name|hpp
operator|=
operator|&
name|hp
expr_stmt|;
operator|*
name|hpp
operator|=
name|NULL
expr_stmt|;
name|q
operator|=
name|strchr
argument_list|(
name|s
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|&&
name|which
operator|==
name|RTA_DST
condition|)
block|{
operator|*
name|q
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|=
name|inet_network
argument_list|(
name|s
argument_list|)
operator|)
operator|!=
name|INADDR_NONE
condition|)
block|{
name|inet_makenetandmask
argument_list|(
name|val
argument_list|,
operator|&
name|su
operator|->
name|sin
argument_list|,
name|strtoul
argument_list|(
name|q
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|q
operator|=
literal|'/'
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|which
operator|!=
name|RTA_DST
operator|||
name|forcenet
operator|==
literal|0
operator|)
operator|&&
name|inet_aton
argument_list|(
name|s
argument_list|,
operator|&
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
condition|)
block|{
name|val
operator|=
name|su
operator|->
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
if|if
condition|(
name|which
operator|!=
name|RTA_DST
operator|||
name|forcehost
operator|||
name|inet_lnaof
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
operator|!=
name|INADDR_ANY
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
block|{
name|val
operator|=
name|ntohl
argument_list|(
name|val
argument_list|)
expr_stmt|;
goto|goto
name|netdone
goto|;
block|}
block|}
if|if
condition|(
name|which
operator|==
name|RTA_DST
operator|&&
name|forcehost
operator|==
literal|0
operator|&&
operator|(
operator|(
name|val
operator|=
name|inet_network
argument_list|(
name|s
argument_list|)
operator|)
operator|!=
name|INADDR_NONE
operator|||
operator|(
operator|(
name|np
operator|=
name|getnetbyname
argument_list|(
name|s
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|(
name|val
operator|=
name|np
operator|->
name|n_net
operator|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|netdone
label|:
name|inet_makenetandmask
argument_list|(
name|val
argument_list|,
operator|&
name|su
operator|->
name|sin
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|hp
operator|=
name|gethostbyname
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|hp
condition|)
block|{
operator|*
name|hpp
operator|=
name|hp
expr_stmt|;
name|su
operator|->
name|sin
operator|.
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|memmove
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|,
name|hp
operator|->
name|h_addr
argument_list|,
name|MIN
argument_list|(
name|hp
operator|->
name|h_length
argument_list|,
sizeof|sizeof
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|errx
argument_list|(
name|EX_NOHOST
argument_list|,
literal|"bad address: %s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|prefixlen
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|len
init|=
name|atoi
argument_list|(
name|s
argument_list|)
decl_stmt|,
name|q
decl_stmt|,
name|r
decl_stmt|;
name|int
name|max
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
name|rtm_addrs
operator||=
name|RTA_NETMASK
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|max
operator|=
literal|128
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
operator|.
name|sin6
operator|.
name|sin6_addr
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|AF_INET
case|:
name|max
operator|=
literal|32
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
operator|.
name|sin
operator|.
name|sin_addr
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"prefixlen not supported in this af\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/*NOTREACHED*/
block|}
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|max
operator|<
name|len
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: bad value\n"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|q
operator|=
name|len
operator|>>
literal|3
expr_stmt|;
name|r
operator|=
name|len
operator|&
literal|7
expr_stmt|;
name|so_mask
operator|.
name|sa
operator|.
name|sa_family
operator|=
name|af
expr_stmt|;
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|=
name|aflen
expr_stmt|;
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
literal|0
argument_list|,
name|max
operator|/
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|>
literal|0
condition|)
name|memset
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p
argument_list|,
literal|0xff
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|>
literal|0
condition|)
operator|*
operator|(
operator|(
name|u_char
operator|*
operator|)
name|p
operator|+
name|q
operator|)
operator|=
operator|(
literal|0xff00
operator|>>
name|r
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|len
operator|==
name|max
condition|)
return|return
operator|-
literal|1
return|;
else|else
return|return
name|len
return|;
block|}
end_function

begin_function
name|void
name|interfaces
parameter_list|()
block|{
name|size_t
name|needed
decl_stmt|;
name|int
name|mib
index|[
literal|6
index|]
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|lim
decl_stmt|,
modifier|*
name|next
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|retry2
label|:
name|mib
index|[
literal|0
index|]
operator|=
name|CTL_NET
expr_stmt|;
name|mib
index|[
literal|1
index|]
operator|=
name|PF_ROUTE
expr_stmt|;
name|mib
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* protocol */
name|mib
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
comment|/* wildcard address family */
name|mib
index|[
literal|4
index|]
operator|=
name|NET_RT_IFLIST
expr_stmt|;
name|mib
index|[
literal|5
index|]
operator|=
literal|0
expr_stmt|;
comment|/* no flags */
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|6
argument_list|,
name|NULL
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"route-sysctl-estimate"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|needed
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
name|EX_OSERR
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sysctl
argument_list|(
name|mib
argument_list|,
literal|6
argument_list|,
name|buf
argument_list|,
operator|&
name|needed
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOMEM
operator|&&
name|count
operator|++
operator|<
literal|10
condition|)
block|{
name|warnx
argument_list|(
literal|"Routing table grew, retrying"
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
goto|goto
name|retry2
goto|;
block|}
name|err
argument_list|(
name|EX_OSERR
argument_list|,
literal|"actual retrieval of interface table"
argument_list|)
expr_stmt|;
block|}
name|lim
operator|=
name|buf
operator|+
name|needed
expr_stmt|;
for|for
control|(
name|next
operator|=
name|buf
init|;
name|next
operator|<
name|lim
condition|;
name|next
operator|+=
name|rtm
operator|->
name|rtm_msglen
control|)
block|{
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|next
expr_stmt|;
name|print_rtmsg
argument_list|(
name|rtm
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|monitor
parameter_list|()
block|{
name|int
name|n
decl_stmt|;
name|char
name|msg
index|[
literal|2048
index|]
decl_stmt|;
name|verbose
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|debugonly
condition|)
block|{
name|interfaces
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|time_t
name|now
decl_stmt|;
name|n
operator|=
name|read
argument_list|(
name|s
argument_list|,
name|msg
argument_list|,
literal|2048
argument_list|)
expr_stmt|;
name|now
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\ngot message of size %d on %s"
argument_list|,
name|n
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
name|print_rtmsg
argument_list|(
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|msg
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
block|{
name|struct
name|rt_msghdr
name|m_rtm
decl_stmt|;
name|char
name|m_space
index|[
literal|512
index|]
decl_stmt|;
block|}
name|m_rtmsg
struct|;
end_struct

begin_function
name|int
name|rtmsg
parameter_list|(
name|cmd
parameter_list|,
name|flags
parameter_list|)
name|int
name|cmd
decl_stmt|,
name|flags
decl_stmt|;
block|{
specifier|static
name|int
name|seq
decl_stmt|;
name|int
name|rlen
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|m_rtmsg
operator|.
name|m_space
decl_stmt|;
name|int
name|l
decl_stmt|;
define|#
directive|define
name|NEXTADDR
parameter_list|(
name|w
parameter_list|,
name|u
parameter_list|)
define|\
value|if (rtm_addrs& (w)) {\ 	    l = SA_SIZE(&(u.sa)); memmove(cp,&(u), l); cp += l;\ 	    if (verbose) sodump(&(u),"u");\ 	}
name|errno
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
operator|&
name|m_rtmsg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
literal|'a'
condition|)
name|cmd
operator|=
name|RTM_ADD
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'c'
condition|)
name|cmd
operator|=
name|RTM_CHANGE
expr_stmt|;
elseif|else
if|if
condition|(
name|cmd
operator|==
literal|'g'
condition|)
block|{
name|cmd
operator|=
name|RTM_GET
expr_stmt|;
if|if
condition|(
name|so_ifp
operator|.
name|sa
operator|.
name|sa_family
operator|==
literal|0
condition|)
block|{
name|so_ifp
operator|.
name|sa
operator|.
name|sa_family
operator|=
name|AF_LINK
expr_stmt|;
name|so_ifp
operator|.
name|sa
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
name|rtm_addrs
operator||=
name|RTA_IFP
expr_stmt|;
block|}
block|}
else|else
name|cmd
operator|=
name|RTM_DELETE
expr_stmt|;
define|#
directive|define
name|rtm
value|m_rtmsg.m_rtm
name|rtm
operator|.
name|rtm_type
operator|=
name|cmd
expr_stmt|;
name|rtm
operator|.
name|rtm_flags
operator|=
name|flags
expr_stmt|;
name|rtm
operator|.
name|rtm_version
operator|=
name|RTM_VERSION
expr_stmt|;
name|rtm
operator|.
name|rtm_seq
operator|=
operator|++
name|seq
expr_stmt|;
name|rtm
operator|.
name|rtm_addrs
operator|=
name|rtm_addrs
expr_stmt|;
name|rtm
operator|.
name|rtm_rmx
operator|=
name|rt_metrics
expr_stmt|;
name|rtm
operator|.
name|rtm_inits
operator|=
name|rtm_inits
expr_stmt|;
if|if
condition|(
name|rtm_addrs
operator|&
name|RTA_NETMASK
condition|)
name|mask_addr
argument_list|()
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_DST
argument_list|,
name|so_dst
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GATEWAY
argument_list|,
name|so_gate
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_NETMASK
argument_list|,
name|so_mask
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_GENMASK
argument_list|,
name|so_genmask
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_IFP
argument_list|,
name|so_ifp
argument_list|)
expr_stmt|;
name|NEXTADDR
argument_list|(
name|RTA_IFA
argument_list|,
name|so_ifa
argument_list|)
expr_stmt|;
name|rtm
operator|.
name|rtm_msglen
operator|=
name|l
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|print_rtmsg
argument_list|(
operator|&
name|rtm
argument_list|,
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|debugonly
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|rlen
operator|=
name|write
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
name|l
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EPERM
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
name|warn
argument_list|(
literal|"writing to routing socket"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|cmd
operator|==
name|RTM_GET
condition|)
block|{
do|do
block|{
name|l
operator|=
name|read
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|m_rtmsg
argument_list|,
sizeof|sizeof
argument_list|(
name|m_rtmsg
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|l
operator|>
literal|0
operator|&&
operator|(
name|rtm
operator|.
name|rtm_seq
operator|!=
name|seq
operator|||
name|rtm
operator|.
name|rtm_pid
operator|!=
name|pid
operator|)
condition|)
do|;
if|if
condition|(
name|l
operator|<
literal|0
condition|)
name|warn
argument_list|(
literal|"read from routing socket"
argument_list|)
expr_stmt|;
else|else
name|print_getmsg
argument_list|(
operator|&
name|rtm
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|rtm
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|mask_addr
parameter_list|()
block|{
name|int
name|olen
init|=
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
decl_stmt|;
name|char
modifier|*
name|cp1
init|=
name|olen
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
decl_stmt|,
modifier|*
name|cp2
decl_stmt|;
for|for
control|(
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|=
literal|0
init|;
name|cp1
operator|>
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
condition|;
control|)
if|if
condition|(
operator|*
operator|--
name|cp1
operator|!=
literal|0
condition|)
block|{
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|=
literal|1
operator|+
name|cp1
operator|-
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|rtm_addrs
operator|&
name|RTA_DST
operator|)
operator|==
literal|0
condition|)
return|return;
switch|switch
condition|(
name|so_dst
operator|.
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
endif|#
directive|endif
case|case
name|AF_APPLETALK
case|:
case|case
literal|0
case|:
return|return;
block|}
name|cp1
operator|=
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|+
literal|1
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_dst
expr_stmt|;
name|cp2
operator|=
name|so_dst
operator|.
name|sa
operator|.
name|sa_len
operator|+
literal|1
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_dst
expr_stmt|;
while|while
condition|(
name|cp2
operator|>
name|cp1
condition|)
operator|*
operator|--
name|cp2
operator|=
literal|0
expr_stmt|;
name|cp2
operator|=
name|so_mask
operator|.
name|sa
operator|.
name|sa_len
operator|+
literal|1
operator|+
operator|(
name|char
operator|*
operator|)
operator|&
name|so_mask
expr_stmt|;
while|while
condition|(
name|cp1
operator|>
name|so_dst
operator|.
name|sa
operator|.
name|sa_data
condition|)
operator|*
operator|--
name|cp1
operator|&=
operator|*
operator|--
name|cp2
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|msgtypes
index|[]
init|=
block|{
literal|""
block|,
literal|"RTM_ADD: Add Route"
block|,
literal|"RTM_DELETE: Delete Route"
block|,
literal|"RTM_CHANGE: Change Metrics or flags"
block|,
literal|"RTM_GET: Report Metrics"
block|,
literal|"RTM_LOSING: Kernel Suspects Partitioning"
block|,
literal|"RTM_REDIRECT: Told to use different route"
block|,
literal|"RTM_MISS: Lookup failed on this address"
block|,
literal|"RTM_LOCK: fix specified metrics"
block|,
literal|"RTM_OLDADD: caused by SIOCADDRT"
block|,
literal|"RTM_OLDDEL: caused by SIOCDELRT"
block|,
literal|"RTM_RESOLVE: Route created by cloning"
block|,
literal|"RTM_NEWADDR: address being added to iface"
block|,
literal|"RTM_DELADDR: address being removed from iface"
block|,
literal|"RTM_IFINFO: iface status change"
block|,
literal|"RTM_NEWMADDR: new multicast group membership on iface"
block|,
literal|"RTM_DELMADDR: multicast group membership removed from iface"
block|,
literal|"RTM_IFANNOUNCE: interface arrival/departure"
block|,
literal|0
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|metricnames
index|[]
init|=
literal|"\011pksent\010rttvar\7rtt\6ssthresh\5sendpipe\4recvpipe\3expire\2hopcount"
literal|"\1mtu"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|routeflags
index|[]
init|=
literal|"\1UP\2GATEWAY\3HOST\4REJECT\5DYNAMIC\6MODIFIED\7DONE\010MASK_PRESENT"
literal|"\011CLONING\012XRESOLVE\013LLINFO\014STATIC\015BLACKHOLE\016b016"
literal|"\017PROTO2\020PROTO1\021PRCLONING\022WASCLONED\023PROTO3\024CHAINDELETE"
literal|"\025PINNED\026LOCAL\027BROADCAST\030MULTICAST"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ifnetflags
index|[]
init|=
literal|"\1UP\2BROADCAST\3DEBUG\4LOOPBACK\5PTP\6b6\7RUNNING\010NOARP"
literal|"\011PPROMISC\012ALLMULTI\013OACTIVE\014SIMPLEX\015LINK0\016LINK1"
literal|"\017LINK2\020MULTICAST"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|addrnames
index|[]
init|=
literal|"\1DST\2GATEWAY\3NETMASK\4GENMASK\5IFP\6IFA\7AUTHOR\010BRD"
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|print_rtmsg
parameter_list|(
name|rtm
parameter_list|,
name|msglen
parameter_list|)
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|int
name|msglen
decl_stmt|;
block|{
name|struct
name|if_msghdr
modifier|*
name|ifm
decl_stmt|;
name|struct
name|ifa_msghdr
modifier|*
name|ifam
decl_stmt|;
ifdef|#
directive|ifdef
name|RTM_NEWMADDR
name|struct
name|ifma_msghdr
modifier|*
name|ifmam
decl_stmt|;
endif|#
directive|endif
name|struct
name|if_announcemsghdr
modifier|*
name|ifan
decl_stmt|;
name|char
modifier|*
name|state
decl_stmt|;
if|if
condition|(
name|verbose
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"routing message version %d not understood\n"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|msgtypes
index|[
name|rtm
operator|->
name|rtm_type
index|]
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: "
argument_list|,
name|msgtypes
index|[
name|rtm
operator|->
name|rtm_type
index|]
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"#%d: "
argument_list|,
name|rtm
operator|->
name|rtm_type
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"len %d, "
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|rtm
operator|->
name|rtm_type
condition|)
block|{
case|case
name|RTM_IFINFO
case|:
name|ifm
operator|=
operator|(
expr|struct
name|if_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"if# %d, "
argument_list|,
name|ifm
operator|->
name|ifm_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifm
operator|->
name|ifm_data
operator|.
name|ifi_link_state
condition|)
block|{
case|case
name|LINK_STATE_DOWN
case|:
name|state
operator|=
literal|"down"
expr_stmt|;
break|break;
case|case
name|LINK_STATE_UP
case|:
name|state
operator|=
literal|"up"
expr_stmt|;
break|break;
default|default:
name|state
operator|=
literal|"unknown"
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"link: %s, flags:"
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|ifm
operator|->
name|ifm_flags
argument_list|,
name|ifnetflags
argument_list|)
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifm
operator|+
literal|1
operator|)
argument_list|,
name|ifm
operator|->
name|ifm_addrs
argument_list|)
expr_stmt|;
break|break;
case|case
name|RTM_NEWADDR
case|:
case|case
name|RTM_DELADDR
case|:
name|ifam
operator|=
operator|(
expr|struct
name|ifa_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"metric %d, flags:"
argument_list|,
name|ifam
operator|->
name|ifam_metric
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|ifam
operator|->
name|ifam_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifam
operator|+
literal|1
operator|)
argument_list|,
name|ifam
operator|->
name|ifam_addrs
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|RTM_NEWMADDR
case|case
name|RTM_NEWMADDR
case|:
case|case
name|RTM_DELMADDR
case|:
name|ifmam
operator|=
operator|(
expr|struct
name|ifma_msghdr
operator|*
operator|)
name|rtm
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ifmam
operator|+
literal|1
operator|)
argument_list|,
name|ifmam
operator|->
name|ifmam_addrs
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
case|case
name|RTM_IFANNOUNCE
case|:
name|ifan
operator|=
operator|(
expr|struct
name|if_announcemsghdr
operator|*
operator|)
name|rtm
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"if# %d, what: "
argument_list|,
name|ifan
operator|->
name|ifan_index
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ifan
operator|->
name|ifan_what
condition|)
block|{
case|case
name|IFAN_ARRIVAL
case|:
name|printf
argument_list|(
literal|"arrival"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFAN_DEPARTURE
case|:
name|printf
argument_list|(
literal|"departure"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"#%d"
argument_list|,
name|ifan
operator|->
name|ifan_what
argument_list|)
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"pid: %ld, seq %d, errno %d, flags:"
argument_list|,
operator|(
name|long
operator|)
name|rtm
operator|->
name|rtm_pid
argument_list|,
name|rtm
operator|->
name|rtm_seq
argument_list|,
name|rtm
operator|->
name|rtm_errno
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
name|pmsg_common
argument_list|(
name|rtm
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|print_getmsg
parameter_list|(
name|rtm
parameter_list|,
name|msglen
parameter_list|)
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
name|int
name|msglen
decl_stmt|;
block|{
name|struct
name|sockaddr
modifier|*
name|dst
init|=
name|NULL
decl_stmt|,
modifier|*
name|gate
init|=
name|NULL
decl_stmt|,
modifier|*
name|mask
init|=
name|NULL
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"   route to: %s\n"
argument_list|,
name|routename
argument_list|(
operator|&
name|so_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
block|{
name|warnx
argument_list|(
literal|"routing message version %d not understood"
argument_list|,
name|rtm
operator|->
name|rtm_version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rtm
operator|->
name|rtm_msglen
operator|>
name|msglen
condition|)
block|{
name|warnx
argument_list|(
literal|"message length mismatch, in packet %d, returned %d"
argument_list|,
name|rtm
operator|->
name|rtm_msglen
argument_list|,
name|msglen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rtm
operator|->
name|rtm_errno
condition|)
block|{
name|errno
operator|=
name|rtm
operator|->
name|rtm_errno
expr_stmt|;
name|warn
argument_list|(
literal|"message indicates error %d"
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
name|cp
operator|=
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_addrs
condition|)
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
condition|;
name|i
operator|<<=
literal|1
control|)
if|if
condition|(
name|i
operator|&
name|rtm
operator|->
name|rtm_addrs
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
name|RTA_DST
case|:
name|dst
operator|=
name|sa
expr_stmt|;
break|break;
case|case
name|RTA_GATEWAY
case|:
name|gate
operator|=
name|sa
expr_stmt|;
break|break;
case|case
name|RTA_NETMASK
case|:
name|mask
operator|=
name|sa
expr_stmt|;
break|break;
case|case
name|RTA_IFP
case|:
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_LINK
operator|&&
operator|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
operator|)
operator|->
name|sdl_nlen
condition|)
name|ifp
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
expr_stmt|;
break|break;
block|}
name|cp
operator|+=
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dst
operator|&&
name|mask
condition|)
name|mask
operator|->
name|sa_family
operator|=
name|dst
operator|->
name|sa_family
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|dst
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"destination: %s\n"
argument_list|,
name|routename
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
condition|)
block|{
name|int
name|savenflag
init|=
name|nflag
decl_stmt|;
name|nflag
operator|=
literal|1
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"       mask: %s\n"
argument_list|,
name|routename
argument_list|(
name|mask
argument_list|)
argument_list|)
expr_stmt|;
name|nflag
operator|=
name|savenflag
expr_stmt|;
block|}
if|if
condition|(
name|gate
operator|&&
name|rtm
operator|->
name|rtm_flags
operator|&
name|RTF_GATEWAY
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"    gateway: %s\n"
argument_list|,
name|routename
argument_list|(
name|gate
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
condition|)
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"  interface: %.*s\n"
argument_list|,
name|ifp
operator|->
name|sdl_nlen
argument_list|,
name|ifp
operator|->
name|sdl_data
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"      flags: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_flags
argument_list|,
name|routeflags
argument_list|)
expr_stmt|;
define|#
directive|define
name|lock
parameter_list|(
name|f
parameter_list|)
value|((rtm->rtm_rmx.rmx_locks& __CONCAT(RTV_,f)) ? 'L' : ' ')
define|#
directive|define
name|msec
parameter_list|(
name|u
parameter_list|)
value|(((u) + 500) / 1000)
comment|/* usec to msec */
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\n%s\n"
argument_list|,
literal|"\  recvpipe  sendpipe  ssthresh  rtt,msec    rttvar  hopcount      mtu     expire"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_recvpipe
argument_list|,
name|lock
argument_list|(
name|RPIPE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_sendpipe
argument_list|,
name|lock
argument_list|(
name|SPIPE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_ssthresh
argument_list|,
name|lock
argument_list|(
name|SSTHRESH
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|msec
argument_list|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_rtt
argument_list|)
argument_list|,
name|lock
argument_list|(
name|RTT
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|msec
argument_list|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_rttvar
argument_list|)
argument_list|,
name|lock
argument_list|(
name|RTTVAR
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_hopcount
argument_list|,
name|lock
argument_list|(
name|HOPCOUNT
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c "
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_mtu
argument_list|,
name|lock
argument_list|(
name|MTU
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_expire
condition|)
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_expire
operator|-=
name|time
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%8ld%c\n"
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_expire
argument_list|,
name|lock
argument_list|(
name|EXPIRE
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|lock
undef|#
directive|undef
name|msec
define|#
directive|define
name|RTA_IGN
value|(RTA_DST|RTA_GATEWAY|RTA_NETMASK|RTA_IFP|RTA_IFA|RTA_BRD)
if|if
condition|(
name|verbose
condition|)
name|pmsg_common
argument_list|(
name|rtm
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rtm
operator|->
name|rtm_addrs
operator|&
operator|~
name|RTA_IGN
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"sockaddrs: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_addrs
argument_list|,
name|addrnames
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
undef|#
directive|undef
name|RTA_IGN
block|}
end_function

begin_function
name|void
name|pmsg_common
parameter_list|(
name|rtm
parameter_list|)
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nlocks: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_rmx
operator|.
name|rmx_locks
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" inits: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|rtm
operator|->
name|rtm_inits
argument_list|,
name|metricnames
argument_list|)
expr_stmt|;
name|pmsg_addrs
argument_list|(
operator|(
operator|(
name|char
operator|*
operator|)
operator|(
name|rtm
operator|+
literal|1
operator|)
operator|)
argument_list|,
name|rtm
operator|->
name|rtm_addrs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pmsg_addrs
parameter_list|(
name|cp
parameter_list|,
name|addrs
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|addrs
decl_stmt|;
block|{
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|addrs
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"\nsockaddrs: "
argument_list|)
expr_stmt|;
name|bprintf
argument_list|(
name|stdout
argument_list|,
name|addrs
argument_list|,
name|addrnames
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
condition|;
name|i
operator|<<=
literal|1
control|)
if|if
condition|(
name|i
operator|&
name|addrs
condition|)
block|{
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|cp
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|routename
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|SA_SIZE
argument_list|(
name|sa
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bprintf
parameter_list|(
name|fp
parameter_list|,
name|b
parameter_list|,
name|s
parameter_list|)
name|FILE
modifier|*
name|fp
decl_stmt|;
name|int
name|b
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
name|gotsome
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|b
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
operator|(
name|i
operator|=
operator|*
name|s
operator|++
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|b
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|gotsome
operator|==
literal|0
condition|)
name|i
operator|=
literal|'<'
expr_stmt|;
else|else
name|i
operator|=
literal|','
expr_stmt|;
operator|(
name|void
operator|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|gotsome
operator|=
literal|1
expr_stmt|;
for|for
control|(
init|;
operator|(
name|i
operator|=
operator|*
name|s
operator|)
operator|>
literal|32
condition|;
name|s
operator|++
control|)
operator|(
name|void
operator|)
name|putc
argument_list|(
name|i
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
else|else
while|while
condition|(
operator|*
name|s
operator|>
literal|32
condition|)
name|s
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|gotsome
condition|)
operator|(
name|void
operator|)
name|putc
argument_list|(
literal|'>'
argument_list|,
name|fp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|keyword
parameter_list|(
name|cp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|;
block|{
name|struct
name|keytab
modifier|*
name|kt
init|=
name|keywords
decl_stmt|;
while|while
condition|(
name|kt
operator|->
name|kt_cp
operator|&&
name|strcmp
argument_list|(
name|kt
operator|->
name|kt_cp
argument_list|,
name|cp
argument_list|)
condition|)
name|kt
operator|++
expr_stmt|;
return|return
name|kt
operator|->
name|kt_i
return|;
block|}
end_function

begin_function
name|void
name|sodump
parameter_list|(
name|su
parameter_list|,
name|which
parameter_list|)
name|sup
name|su
decl_stmt|;
name|char
modifier|*
name|which
decl_stmt|;
block|{
switch|switch
condition|(
name|su
operator|->
name|sa
operator|.
name|sa_family
condition|)
block|{
case|case
name|AF_LINK
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: link %s; "
argument_list|,
name|which
argument_list|,
name|link_ntoa
argument_list|(
operator|&
name|su
operator|->
name|sdl
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_INET
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: inet %s; "
argument_list|,
name|which
argument_list|,
name|inet_ntoa
argument_list|(
name|su
operator|->
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_APPLETALK
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s: atalk %s; "
argument_list|,
name|which
argument_list|,
name|atalk_ntoa
argument_list|(
name|su
operator|->
name|sat
operator|.
name|sat_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* States*/
end_comment

begin_define
define|#
directive|define
name|VIRGIN
value|0
end_define

begin_define
define|#
directive|define
name|GOTONE
value|1
end_define

begin_define
define|#
directive|define
name|GOTTWO
value|2
end_define

begin_comment
comment|/* Inputs */
end_comment

begin_define
define|#
directive|define
name|DIGIT
value|(4*0)
end_define

begin_define
define|#
directive|define
name|END
value|(4*1)
end_define

begin_define
define|#
directive|define
name|DELIM
value|(4*2)
end_define

begin_function
name|void
name|sockaddr
parameter_list|(
name|addr
parameter_list|,
name|sa
parameter_list|)
name|char
modifier|*
name|addr
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
block|{
name|char
modifier|*
name|cp
init|=
operator|(
name|char
operator|*
operator|)
name|sa
decl_stmt|;
name|int
name|size
init|=
name|sa
operator|->
name|sa_len
decl_stmt|;
name|char
modifier|*
name|cplim
init|=
name|cp
operator|+
name|size
decl_stmt|;
name|int
name|byte
init|=
literal|0
decl_stmt|,
name|state
init|=
name|VIRGIN
decl_stmt|,
name|new
init|=
literal|0
comment|/* foil gcc */
decl_stmt|;
name|memset
argument_list|(
name|cp
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|cp
operator|++
expr_stmt|;
do|do
block|{
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'0'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'a'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'f'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|addr
operator|>=
literal|'A'
operator|)
operator|&&
operator|(
operator|*
name|addr
operator|<=
literal|'F'
operator|)
condition|)
block|{
name|new
operator|=
operator|*
name|addr
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|addr
operator|==
literal|0
condition|)
name|state
operator||=
name|END
expr_stmt|;
else|else
name|state
operator||=
name|DELIM
expr_stmt|;
name|addr
operator|++
expr_stmt|;
switch|switch
condition|(
name|state
comment|/* | INPUT */
condition|)
block|{
case|case
name|GOTTWO
operator||
name|DIGIT
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/*FALLTHROUGH*/
case|case
name|VIRGIN
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTONE
expr_stmt|;
name|byte
operator|=
name|new
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|DIGIT
case|:
name|state
operator|=
name|GOTTWO
expr_stmt|;
name|byte
operator|=
name|new
operator|+
operator|(
name|byte
operator|<<
literal|4
operator|)
expr_stmt|;
continue|continue;
default|default:
comment|/* | DELIM */
name|state
operator|=
name|VIRGIN
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
name|byte
operator|=
literal|0
expr_stmt|;
continue|continue;
case|case
name|GOTONE
operator||
name|END
case|:
case|case
name|GOTTWO
operator||
name|END
case|:
operator|*
name|cp
operator|++
operator|=
name|byte
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|VIRGIN
operator||
name|END
case|:
break|break;
block|}
break|break;
block|}
do|while
condition|(
name|cp
operator|<
name|cplim
condition|)
do|;
name|sa
operator|->
name|sa_len
operator|=
name|cp
operator|-
operator|(
name|char
operator|*
operator|)
name|sa
expr_stmt|;
block|}
end_function

begin_function
name|int
name|atalk_aton
parameter_list|(
specifier|const
name|char
modifier|*
name|text
parameter_list|,
name|struct
name|at_addr
modifier|*
name|addr
parameter_list|)
block|{
name|u_int
name|net
decl_stmt|,
name|node
decl_stmt|;
if|if
condition|(
name|sscanf
argument_list|(
name|text
argument_list|,
literal|"%u.%u"
argument_list|,
operator|&
name|net
argument_list|,
operator|&
name|node
argument_list|)
operator|!=
literal|2
operator|||
name|net
operator|>
literal|0xffff
operator|||
name|node
operator|>
literal|0xff
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|addr
operator|->
name|s_net
operator|=
name|htons
argument_list|(
name|net
argument_list|)
expr_stmt|;
name|addr
operator|->
name|s_node
operator|=
name|node
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|atalk_ntoa
parameter_list|(
name|struct
name|at_addr
name|at
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%u.%u"
argument_list|,
name|ntohs
argument_list|(
name|at
operator|.
name|s_net
argument_list|)
argument_list|,
name|at
operator|.
name|s_node
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

end_unit


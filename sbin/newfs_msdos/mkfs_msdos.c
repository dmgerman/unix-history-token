begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1998 Robert Nordier  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS  * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE  * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN  * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/fdcio.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|"mkfs_msdos.h"
end_include

begin_define
define|#
directive|define
name|MAXU16
value|0xffff
end_define

begin_comment
comment|/* maximum unsigned 16-bit quantity */
end_comment

begin_define
define|#
directive|define
name|BPN
value|4
end_define

begin_comment
comment|/* bits per nibble */
end_comment

begin_define
define|#
directive|define
name|NPB
value|2
end_define

begin_comment
comment|/* nibbles per byte */
end_comment

begin_define
define|#
directive|define
name|DOSMAGIC
value|0xaa55
end_define

begin_comment
comment|/* DOS magic number */
end_comment

begin_define
define|#
directive|define
name|MINBPS
value|512
end_define

begin_comment
comment|/* minimum bytes per sector */
end_comment

begin_define
define|#
directive|define
name|MAXSPC
value|128
end_define

begin_comment
comment|/* maximum sectors per cluster */
end_comment

begin_define
define|#
directive|define
name|MAXNFT
value|16
end_define

begin_comment
comment|/* maximum number of FATs */
end_comment

begin_define
define|#
directive|define
name|DEFBLK
value|4096
end_define

begin_comment
comment|/* default block size */
end_comment

begin_define
define|#
directive|define
name|DEFBLK16
value|2048
end_define

begin_comment
comment|/* default block size FAT16 */
end_comment

begin_define
define|#
directive|define
name|DEFRDE
value|512
end_define

begin_comment
comment|/* default root directory entries */
end_comment

begin_define
define|#
directive|define
name|RESFTE
value|2
end_define

begin_comment
comment|/* reserved FAT entries */
end_comment

begin_define
define|#
directive|define
name|MINCLS12
value|1U
end_define

begin_comment
comment|/* minimum FAT12 clusters */
end_comment

begin_define
define|#
directive|define
name|MINCLS16
value|0xff5U
end_define

begin_comment
comment|/* minimum FAT16 clusters */
end_comment

begin_define
define|#
directive|define
name|MINCLS32
value|0xfff5U
end_define

begin_comment
comment|/* minimum FAT32 clusters */
end_comment

begin_define
define|#
directive|define
name|MAXCLS12
value|0xff4U
end_define

begin_comment
comment|/* maximum FAT12 clusters */
end_comment

begin_define
define|#
directive|define
name|MAXCLS16
value|0xfff4U
end_define

begin_comment
comment|/* maximum FAT16 clusters */
end_comment

begin_define
define|#
directive|define
name|MAXCLS32
value|0xffffff4U
end_define

begin_comment
comment|/* maximum FAT32 clusters */
end_comment

begin_define
define|#
directive|define
name|mincls
parameter_list|(
name|fat
parameter_list|)
value|((fat) == 12 ? MINCLS12 :	\ 		      (fat) == 16 ? MINCLS16 :	\ 				    MINCLS32)
end_define

begin_define
define|#
directive|define
name|maxcls
parameter_list|(
name|fat
parameter_list|)
value|((fat) == 12 ? MAXCLS12 :	\ 		      (fat) == 16 ? MAXCLS16 :	\ 				    MAXCLS32)
end_define

begin_define
define|#
directive|define
name|mk1
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|)
define|\
value|(p) = (u_int8_t)(x)
end_define

begin_define
define|#
directive|define
name|mk2
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|)
define|\
value|(p)[0] = (u_int8_t)(x),			\     (p)[1] = (u_int8_t)((x)>> 010)
end_define

begin_define
define|#
directive|define
name|mk4
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|)
define|\
value|(p)[0] = (u_int8_t)(x),			\     (p)[1] = (u_int8_t)((x)>> 010),		\     (p)[2] = (u_int8_t)((x)>> 020),		\     (p)[3] = (u_int8_t)((x)>> 030)
end_define

begin_struct
struct|struct
name|bs
block|{
name|u_int8_t
name|bsJump
index|[
literal|3
index|]
decl_stmt|;
comment|/* bootstrap entry point */
name|u_int8_t
name|bsOemName
index|[
literal|8
index|]
decl_stmt|;
comment|/* OEM name and version */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|bsbpb
block|{
name|u_int8_t
name|bpbBytesPerSec
index|[
literal|2
index|]
decl_stmt|;
comment|/* bytes per sector */
name|u_int8_t
name|bpbSecPerClust
decl_stmt|;
comment|/* sectors per cluster */
name|u_int8_t
name|bpbResSectors
index|[
literal|2
index|]
decl_stmt|;
comment|/* reserved sectors */
name|u_int8_t
name|bpbFATs
decl_stmt|;
comment|/* number of FATs */
name|u_int8_t
name|bpbRootDirEnts
index|[
literal|2
index|]
decl_stmt|;
comment|/* root directory entries */
name|u_int8_t
name|bpbSectors
index|[
literal|2
index|]
decl_stmt|;
comment|/* total sectors */
name|u_int8_t
name|bpbMedia
decl_stmt|;
comment|/* media descriptor */
name|u_int8_t
name|bpbFATsecs
index|[
literal|2
index|]
decl_stmt|;
comment|/* sectors per FAT */
name|u_int8_t
name|bpbSecPerTrack
index|[
literal|2
index|]
decl_stmt|;
comment|/* sectors per track */
name|u_int8_t
name|bpbHeads
index|[
literal|2
index|]
decl_stmt|;
comment|/* drive heads */
name|u_int8_t
name|bpbHiddenSecs
index|[
literal|4
index|]
decl_stmt|;
comment|/* hidden sectors */
name|u_int8_t
name|bpbHugeSectors
index|[
literal|4
index|]
decl_stmt|;
comment|/* big total sectors */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|bsxbpb
block|{
name|u_int8_t
name|bpbBigFATsecs
index|[
literal|4
index|]
decl_stmt|;
comment|/* big sectors per FAT */
name|u_int8_t
name|bpbExtFlags
index|[
literal|2
index|]
decl_stmt|;
comment|/* FAT control flags */
name|u_int8_t
name|bpbFSVers
index|[
literal|2
index|]
decl_stmt|;
comment|/* file system version */
name|u_int8_t
name|bpbRootClust
index|[
literal|4
index|]
decl_stmt|;
comment|/* root directory start cluster */
name|u_int8_t
name|bpbFSInfo
index|[
literal|2
index|]
decl_stmt|;
comment|/* file system info sector */
name|u_int8_t
name|bpbBackup
index|[
literal|2
index|]
decl_stmt|;
comment|/* backup boot sector */
name|u_int8_t
name|bpbReserved
index|[
literal|12
index|]
decl_stmt|;
comment|/* reserved */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|bsx
block|{
name|u_int8_t
name|exDriveNumber
decl_stmt|;
comment|/* drive number */
name|u_int8_t
name|exReserved1
decl_stmt|;
comment|/* reserved */
name|u_int8_t
name|exBootSignature
decl_stmt|;
comment|/* extended boot signature */
name|u_int8_t
name|exVolumeID
index|[
literal|4
index|]
decl_stmt|;
comment|/* volume ID number */
name|u_int8_t
name|exVolumeLabel
index|[
literal|11
index|]
decl_stmt|;
comment|/* volume label */
name|u_int8_t
name|exFileSysType
index|[
literal|8
index|]
decl_stmt|;
comment|/* file system type */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|de
block|{
name|u_int8_t
name|deName
index|[
literal|11
index|]
decl_stmt|;
comment|/* name and extension */
name|u_int8_t
name|deAttributes
decl_stmt|;
comment|/* attributes */
name|u_int8_t
name|rsvd
index|[
literal|10
index|]
decl_stmt|;
comment|/* reserved */
name|u_int8_t
name|deMTime
index|[
literal|2
index|]
decl_stmt|;
comment|/* last-modified time */
name|u_int8_t
name|deMDate
index|[
literal|2
index|]
decl_stmt|;
comment|/* last-modified date */
name|u_int8_t
name|deStartCluster
index|[
literal|2
index|]
decl_stmt|;
comment|/* starting cluster */
name|u_int8_t
name|deFileSize
index|[
literal|4
index|]
decl_stmt|;
comment|/* size */
block|}
name|__packed
struct|;
end_struct

begin_struct
struct|struct
name|bpb
block|{
name|u_int
name|bpbBytesPerSec
decl_stmt|;
comment|/* bytes per sector */
name|u_int
name|bpbSecPerClust
decl_stmt|;
comment|/* sectors per cluster */
name|u_int
name|bpbResSectors
decl_stmt|;
comment|/* reserved sectors */
name|u_int
name|bpbFATs
decl_stmt|;
comment|/* number of FATs */
name|u_int
name|bpbRootDirEnts
decl_stmt|;
comment|/* root directory entries */
name|u_int
name|bpbSectors
decl_stmt|;
comment|/* total sectors */
name|u_int
name|bpbMedia
decl_stmt|;
comment|/* media descriptor */
name|u_int
name|bpbFATsecs
decl_stmt|;
comment|/* sectors per FAT */
name|u_int
name|bpbSecPerTrack
decl_stmt|;
comment|/* sectors per track */
name|u_int
name|bpbHeads
decl_stmt|;
comment|/* drive heads */
name|u_int
name|bpbHiddenSecs
decl_stmt|;
comment|/* hidden sectors */
name|u_int
name|bpbHugeSectors
decl_stmt|;
comment|/* big total sectors */
name|u_int
name|bpbBigFATsecs
decl_stmt|;
comment|/* big sectors per FAT */
name|u_int
name|bpbRootClust
decl_stmt|;
comment|/* root directory start cluster */
name|u_int
name|bpbFSInfo
decl_stmt|;
comment|/* file system info sector */
name|u_int
name|bpbBackup
decl_stmt|;
comment|/* backup boot sector */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BPBGAP
value|0, 0, 0, 0, 0, 0
end_define

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|struct
name|bpb
name|bpb
decl_stmt|;
block|}
decl|const
name|stdfmt
index|[]
init|=
block|{
block|{
literal|"160"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|64
block|,
literal|320
block|,
literal|0xfe
block|,
literal|1
block|,
literal|8
block|,
literal|1
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"180"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|64
block|,
literal|360
block|,
literal|0xfc
block|,
literal|2
block|,
literal|9
block|,
literal|1
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"320"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|640
block|,
literal|0xff
block|,
literal|1
block|,
literal|8
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"360"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|720
block|,
literal|0xfd
block|,
literal|2
block|,
literal|9
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"640"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|1280
block|,
literal|0xfb
block|,
literal|2
block|,
literal|8
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"720"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|1440
block|,
literal|0xf9
block|,
literal|3
block|,
literal|9
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"1200"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|224
block|,
literal|2400
block|,
literal|0xf9
block|,
literal|7
block|,
literal|15
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"1232"
block|,
block|{
literal|1024
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|192
block|,
literal|1232
block|,
literal|0xfe
block|,
literal|2
block|,
literal|8
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"1440"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|224
block|,
literal|2880
block|,
literal|0xf0
block|,
literal|9
block|,
literal|18
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"2880"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|240
block|,
literal|5760
block|,
literal|0xf0
block|,
literal|9
block|,
literal|36
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|u_int8_t
name|bootcode
index|[]
init|=
block|{
literal|0xfa
block|,
comment|/* cli		    */
literal|0x31
block|,
literal|0xc0
block|,
comment|/* xor	   ax,ax    */
literal|0x8e
block|,
literal|0xd0
block|,
comment|/* mov	   ss,ax    */
literal|0xbc
block|,
literal|0x00
block|,
literal|0x7c
block|,
comment|/* mov	   sp,7c00h */
literal|0xfb
block|,
comment|/* sti		    */
literal|0x8e
block|,
literal|0xd8
block|,
comment|/* mov	   ds,ax    */
literal|0xe8
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* call    $ + 3    */
literal|0x5e
block|,
comment|/* pop	   si	    */
literal|0x83
block|,
literal|0xc6
block|,
literal|0x19
block|,
comment|/* add	   si,+19h  */
literal|0xbb
block|,
literal|0x07
block|,
literal|0x00
block|,
comment|/* mov	   bx,0007h */
literal|0xfc
block|,
comment|/* cld		    */
literal|0xac
block|,
comment|/* lodsb	    */
literal|0x84
block|,
literal|0xc0
block|,
comment|/* test    al,al    */
literal|0x74
block|,
literal|0x06
block|,
comment|/* jz	   $ + 8    */
literal|0xb4
block|,
literal|0x0e
block|,
comment|/* mov	   ah,0eh   */
literal|0xcd
block|,
literal|0x10
block|,
comment|/* int	   10h	    */
literal|0xeb
block|,
literal|0xf5
block|,
comment|/* jmp	   $ - 9    */
literal|0x30
block|,
literal|0xe4
block|,
comment|/* xor	   ah,ah    */
literal|0xcd
block|,
literal|0x16
block|,
comment|/* int	   16h	    */
literal|0xcd
block|,
literal|0x19
block|,
comment|/* int	   19h	    */
literal|0x0d
block|,
literal|0x0a
block|,
literal|'N'
block|,
literal|'o'
block|,
literal|'n'
block|,
literal|'-'
block|,
literal|'s'
block|,
literal|'y'
block|,
literal|'s'
block|,
literal|'t'
block|,
literal|'e'
block|,
literal|'m'
block|,
literal|' '
block|,
literal|'d'
block|,
literal|'i'
block|,
literal|'s'
block|,
literal|'k'
block|,
literal|0x0d
block|,
literal|0x0a
block|,
literal|'P'
block|,
literal|'r'
block|,
literal|'e'
block|,
literal|'s'
block|,
literal|'s'
block|,
literal|' '
block|,
literal|'a'
block|,
literal|'n'
block|,
literal|'y'
block|,
literal|' '
block|,
literal|'k'
block|,
literal|'e'
block|,
literal|'y'
block|,
literal|' '
block|,
literal|'t'
block|,
literal|'o'
block|,
literal|' '
block|,
literal|'r'
block|,
literal|'e'
block|,
literal|'b'
block|,
literal|'o'
block|,
literal|'o'
block|,
literal|'t'
block|,
literal|0x0d
block|,
literal|0x0a
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|volatile
name|sig_atomic_t
name|got_siginfo
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|infohandler
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|check_mounted
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|mode_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|getstdfmt
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|bpb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|getdiskinfo
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|bpb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_bpb
parameter_list|(
name|struct
name|bpb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ckgeom
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|u_int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mklabel
parameter_list|(
name|u_int8_t
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oklabel
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|setstr
parameter_list|(
name|u_int8_t
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|mkfs_msdos
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
specifier|const
name|char
modifier|*
name|dtype
parameter_list|,
specifier|const
name|struct
name|msdos_options
modifier|*
name|op
parameter_list|)
block|{
name|char
name|buf
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|struct
name|sigaction
name|si_sa
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|bpb
name|bpb
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|struct
name|bs
modifier|*
name|bs
decl_stmt|;
name|struct
name|bsbpb
modifier|*
name|bsbpb
decl_stmt|;
name|struct
name|bsxbpb
modifier|*
name|bsxbpb
decl_stmt|;
name|struct
name|bsx
modifier|*
name|bsx
decl_stmt|;
name|struct
name|de
modifier|*
name|de
decl_stmt|;
name|u_int8_t
modifier|*
name|img
decl_stmt|;
specifier|const
name|char
modifier|*
name|bname
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|u_int
name|fat
decl_stmt|,
name|bss
decl_stmt|,
name|rds
decl_stmt|,
name|cls
decl_stmt|,
name|dir
decl_stmt|,
name|lsn
decl_stmt|,
name|x
decl_stmt|,
name|x1
decl_stmt|,
name|x2
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|fd1
decl_stmt|,
name|rv
decl_stmt|;
name|struct
name|msdos_options
name|o
init|=
operator|*
name|op
decl_stmt|;
name|img
operator|=
name|NULL
expr_stmt|;
name|rv
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|block_size
operator|&&
name|o
operator|.
name|sectors_per_cluster
condition|)
block|{
name|warnx
argument_list|(
literal|"Cannot specify both block size and sectors per cluster"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|OEM_string
operator|&&
name|strlen
argument_list|(
name|o
operator|.
name|OEM_string
argument_list|)
operator|>
literal|8
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: bad OEM string"
argument_list|,
name|o
operator|.
name|OEM_string
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|create_size
condition|)
block|{
if|if
condition|(
name|o
operator|.
name|no_create
condition|)
block|{
name|warnx
argument_list|(
literal|"create (-C) is incompatible with -N"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|O_RDWR
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"failed to create %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ftruncate
argument_list|(
name|fd
argument_list|,
name|o
operator|.
name|create_size
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"failed to initialize %jd bytes"
argument_list|,
operator|(
name|intmax_t
operator|)
name|o
operator|.
name|create_size
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|o
operator|.
name|no_create
condition|?
name|O_RDONLY
else|:
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|sb
argument_list|)
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|create_size
condition|)
block|{
if|if
condition|(
operator|!
name|S_ISREG
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
condition|)
name|warnx
argument_list|(
literal|"warning, %s is not a regular file"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|S_ISCHR
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
condition|)
name|warnx
argument_list|(
literal|"warning, %s is not a character device"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|o
operator|.
name|no_create
condition|)
if|if
condition|(
name|check_mounted
argument_list|(
name|fname
argument_list|,
name|sb
operator|.
name|st_mode
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|o
operator|.
name|offset
operator|&&
name|o
operator|.
name|offset
operator|!=
name|lseek
argument_list|(
name|fd
argument_list|,
name|o
operator|.
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"cannot seek to %jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|o
operator|.
name|offset
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|memset
argument_list|(
operator|&
name|bpb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bpb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|floppy
condition|)
block|{
if|if
condition|(
name|getstdfmt
argument_list|(
name|o
operator|.
name|floppy
argument_list|,
operator|&
name|bpb
argument_list|)
operator|==
operator|-
literal|1
condition|)
goto|goto
name|done
goto|;
name|bpb
operator|.
name|bpbHugeSectors
operator|=
name|bpb
operator|.
name|bpbSectors
expr_stmt|;
name|bpb
operator|.
name|bpbSectors
operator|=
literal|0
expr_stmt|;
name|bpb
operator|.
name|bpbBigFATsecs
operator|=
name|bpb
operator|.
name|bpbFATsecs
expr_stmt|;
name|bpb
operator|.
name|bpbFATsecs
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|o
operator|.
name|drive_heads
condition|)
name|bpb
operator|.
name|bpbHeads
operator|=
name|o
operator|.
name|drive_heads
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|sectors_per_track
condition|)
name|bpb
operator|.
name|bpbSecPerTrack
operator|=
name|o
operator|.
name|sectors_per_track
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|bytes_per_sector
condition|)
name|bpb
operator|.
name|bpbBytesPerSec
operator|=
name|o
operator|.
name|bytes_per_sector
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|size
condition|)
name|bpb
operator|.
name|bpbHugeSectors
operator|=
name|o
operator|.
name|size
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|hidden_sectors_set
condition|)
name|bpb
operator|.
name|bpbHiddenSecs
operator|=
name|o
operator|.
name|hidden_sectors
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|o
operator|.
name|floppy
operator|||
operator|(
name|o
operator|.
name|drive_heads
operator|&&
name|o
operator|.
name|sectors_per_track
operator|&&
name|o
operator|.
name|bytes_per_sector
operator|&&
name|o
operator|.
name|size
operator|&&
name|o
operator|.
name|hidden_sectors_set
operator|)
operator|)
condition|)
block|{
name|getdiskinfo
argument_list|(
name|fd
argument_list|,
name|fname
argument_list|,
name|dtype
argument_list|,
name|o
operator|.
name|hidden_sectors_set
argument_list|,
operator|&
name|bpb
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bpbHugeSectors
operator|-=
operator|(
name|o
operator|.
name|offset
operator|/
name|bpb
operator|.
name|bpbBytesPerSec
operator|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|bpbSecPerClust
operator|==
literal|0
condition|)
block|{
comment|/* set defaults */
if|if
condition|(
name|bpb
operator|.
name|bpbHugeSectors
operator|<=
literal|6000
condition|)
comment|/* about 3MB -> 512 bytes */
name|bpb
operator|.
name|bpbSecPerClust
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bpbHugeSectors
operator|<=
operator|(
literal|1
operator|<<
literal|17
operator|)
condition|)
comment|/* 64M -> 4k */
name|bpb
operator|.
name|bpbSecPerClust
operator|=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bpbHugeSectors
operator|<=
operator|(
literal|1
operator|<<
literal|19
operator|)
condition|)
comment|/* 256M -> 8k */
name|bpb
operator|.
name|bpbSecPerClust
operator|=
literal|16
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bpbHugeSectors
operator|<=
operator|(
literal|1
operator|<<
literal|21
operator|)
condition|)
comment|/* 1G -> 16k */
name|bpb
operator|.
name|bpbSecPerClust
operator|=
literal|32
expr_stmt|;
else|else
name|bpb
operator|.
name|bpbSecPerClust
operator|=
literal|64
expr_stmt|;
comment|/* otherwise 32k */
block|}
block|}
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"bytes/sector (%u) is not a power of 2"
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|bpb
operator|.
name|bpbBytesPerSec
operator|<
name|MINBPS
condition|)
block|{
name|warnx
argument_list|(
literal|"bytes/sector (%u) is too small; minimum is %u"
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|,
name|MINBPS
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|volume_label
operator|&&
operator|!
name|oklabel
argument_list|(
name|o
operator|.
name|volume_label
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: bad volume label"
argument_list|,
name|o
operator|.
name|volume_label
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|!
operator|(
name|fat
operator|=
name|o
operator|.
name|fat_type
operator|)
condition|)
block|{
if|if
condition|(
name|o
operator|.
name|floppy
condition|)
name|fat
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|o
operator|.
name|directory_entries
operator|&&
operator|(
name|o
operator|.
name|info_sector
operator|||
name|o
operator|.
name|backup_sector
operator|)
condition|)
name|fat
operator|=
literal|32
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fat
operator|==
literal|32
operator|&&
name|o
operator|.
name|directory_entries
operator|)
operator|||
operator|(
name|fat
operator|!=
literal|32
operator|&&
operator|(
name|o
operator|.
name|info_sector
operator|||
name|o
operator|.
name|backup_sector
operator|)
operator|)
condition|)
block|{
name|warnx
argument_list|(
literal|"-%c is not a legal FAT%s option"
argument_list|,
name|fat
operator|==
literal|32
condition|?
literal|'e'
else|:
name|o
operator|.
name|info_sector
condition|?
literal|'i'
else|:
literal|'k'
argument_list|,
name|fat
operator|==
literal|32
condition|?
literal|"32"
else|:
literal|"12/16"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|floppy
operator|&&
name|fat
operator|==
literal|32
condition|)
name|bpb
operator|.
name|bpbRootDirEnts
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|fat
operator|!=
literal|0
operator|&&
name|fat
operator|!=
literal|12
operator|&&
name|fat
operator|!=
literal|16
operator|&&
name|fat
operator|!=
literal|32
condition|)
block|{
name|warnx
argument_list|(
literal|"%d: bad FAT type"
argument_list|,
name|fat
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|block_size
condition|)
block|{
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|o
operator|.
name|block_size
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"block size (%u) is not a power of 2"
argument_list|,
name|o
operator|.
name|block_size
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|block_size
operator|<
name|bpb
operator|.
name|bpbBytesPerSec
condition|)
block|{
name|warnx
argument_list|(
literal|"block size (%u) is too small; minimum is %u"
argument_list|,
name|o
operator|.
name|block_size
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|o
operator|.
name|block_size
operator|>
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|MAXSPC
condition|)
block|{
name|warnx
argument_list|(
literal|"block size (%u) is too large; maximum is %u"
argument_list|,
name|o
operator|.
name|block_size
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|MAXSPC
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bpb
operator|.
name|bpbSecPerClust
operator|=
name|o
operator|.
name|block_size
operator|/
name|bpb
operator|.
name|bpbBytesPerSec
expr_stmt|;
block|}
if|if
condition|(
name|o
operator|.
name|sectors_per_cluster
condition|)
block|{
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|o
operator|.
name|sectors_per_cluster
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"sectors/cluster (%u) is not a power of 2"
argument_list|,
name|o
operator|.
name|sectors_per_cluster
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bpb
operator|.
name|bpbSecPerClust
operator|=
name|o
operator|.
name|sectors_per_cluster
expr_stmt|;
block|}
if|if
condition|(
name|o
operator|.
name|reserved_sectors
condition|)
name|bpb
operator|.
name|bpbResSectors
operator|=
name|o
operator|.
name|reserved_sectors
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|num_FAT
condition|)
block|{
if|if
condition|(
name|o
operator|.
name|num_FAT
operator|>
name|MAXNFT
condition|)
block|{
name|warnx
argument_list|(
literal|"number of FATs (%u) is too large; maximum is %u"
argument_list|,
name|o
operator|.
name|num_FAT
argument_list|,
name|MAXNFT
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bpb
operator|.
name|bpbFATs
operator|=
name|o
operator|.
name|num_FAT
expr_stmt|;
block|}
if|if
condition|(
name|o
operator|.
name|directory_entries
condition|)
name|bpb
operator|.
name|bpbRootDirEnts
operator|=
name|o
operator|.
name|directory_entries
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|media_descriptor_set
condition|)
block|{
if|if
condition|(
name|o
operator|.
name|media_descriptor
operator|<
literal|0xf0
condition|)
block|{
name|warnx
argument_list|(
literal|"illegal media descriptor (%#x)"
argument_list|,
name|o
operator|.
name|media_descriptor
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bpb
operator|.
name|bpbMedia
operator|=
name|o
operator|.
name|media_descriptor
expr_stmt|;
block|}
if|if
condition|(
name|o
operator|.
name|sectors_per_fat
condition|)
name|bpb
operator|.
name|bpbBigFATsecs
operator|=
name|o
operator|.
name|sectors_per_fat
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|info_sector
condition|)
name|bpb
operator|.
name|bpbFSInfo
operator|=
name|o
operator|.
name|info_sector
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|backup_sector
condition|)
name|bpb
operator|.
name|bpbBackup
operator|=
name|o
operator|.
name|backup_sector
expr_stmt|;
name|bss
operator|=
literal|1
expr_stmt|;
name|bname
operator|=
name|NULL
expr_stmt|;
name|fd1
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|bootstrap
condition|)
block|{
name|bname
operator|=
name|o
operator|.
name|bootstrap
expr_stmt|;
if|if
condition|(
operator|!
name|strchr
argument_list|(
name|bname
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"/boot/%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bname
operator|=
name|strdup
argument_list|(
name|buf
argument_list|)
operator|)
condition|)
block|{
name|warn
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
if|if
condition|(
operator|(
name|fd1
operator|=
name|open
argument_list|(
name|bname
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|||
name|fstat
argument_list|(
name|fd1
argument_list|,
operator|&
name|sb
argument_list|)
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|!
name|S_ISREG
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
operator|||
name|sb
operator|.
name|st_size
operator|%
name|bpb
operator|.
name|bpbBytesPerSec
operator|||
name|sb
operator|.
name|st_size
operator|<
name|bpb
operator|.
name|bpbBytesPerSec
operator|||
name|sb
operator|.
name|st_size
operator|>
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|MAXU16
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: inappropriate file type or format"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bss
operator|=
name|sb
operator|.
name|st_size
operator|/
name|bpb
operator|.
name|bpbBytesPerSec
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbFATs
condition|)
name|bpb
operator|.
name|bpbFATs
operator|=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|fat
condition|)
block|{
if|if
condition|(
name|bpb
operator|.
name|bpbHugeSectors
operator|<
operator|(
name|bpb
operator|.
name|bpbResSectors
condition|?
name|bpb
operator|.
name|bpbResSectors
else|:
name|bss
operator|)
operator|+
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
operator|(
name|bpb
operator|.
name|bpbSecPerClust
condition|?
name|MINCLS16
else|:
name|MAXCLS12
operator|+
literal|1
operator|)
operator|)
operator|*
operator|(
name|bpb
operator|.
name|bpbSecPerClust
condition|?
literal|16
else|:
literal|12
operator|)
operator|/
name|BPN
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|NPB
argument_list|)
operator|*
name|bpb
operator|.
name|bpbFATs
operator|+
name|howmany
argument_list|(
name|bpb
operator|.
name|bpbRootDirEnts
condition|?
name|bpb
operator|.
name|bpbRootDirEnts
else|:
name|DEFRDE
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|de
argument_list|)
argument_list|)
operator|+
operator|(
name|bpb
operator|.
name|bpbSecPerClust
condition|?
name|MINCLS16
else|:
name|MAXCLS12
operator|+
literal|1
operator|)
operator|*
operator|(
name|bpb
operator|.
name|bpbSecPerClust
condition|?
name|bpb
operator|.
name|bpbSecPerClust
else|:
name|howmany
argument_list|(
name|DEFBLK
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
operator|)
condition|)
name|fat
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bpbRootDirEnts
operator|||
name|bpb
operator|.
name|bpbHugeSectors
operator|<
operator|(
name|bpb
operator|.
name|bpbResSectors
condition|?
name|bpb
operator|.
name|bpbResSectors
else|:
name|bss
operator|)
operator|+
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
name|MAXCLS16
operator|)
operator|*
literal|2
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
operator|*
name|bpb
operator|.
name|bpbFATs
operator|+
name|howmany
argument_list|(
name|DEFRDE
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|de
argument_list|)
argument_list|)
operator|+
operator|(
name|MAXCLS16
operator|+
literal|1
operator|)
operator|*
operator|(
name|bpb
operator|.
name|bpbSecPerClust
condition|?
name|bpb
operator|.
name|bpbSecPerClust
else|:
name|howmany
argument_list|(
literal|8192
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
operator|)
condition|)
name|fat
operator|=
literal|16
expr_stmt|;
else|else
name|fat
operator|=
literal|32
expr_stmt|;
block|}
name|x
operator|=
name|bss
expr_stmt|;
if|if
condition|(
name|fat
operator|==
literal|32
condition|)
block|{
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbFSInfo
condition|)
block|{
if|if
condition|(
name|x
operator|==
name|MAXU16
operator|||
name|x
operator|==
name|bpb
operator|.
name|bpbBackup
condition|)
block|{
name|warnx
argument_list|(
literal|"no room for info sector"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bpb
operator|.
name|bpbFSInfo
operator|=
name|x
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|.
name|bpbFSInfo
operator|!=
name|MAXU16
operator|&&
name|x
operator|<=
name|bpb
operator|.
name|bpbFSInfo
condition|)
name|x
operator|=
name|bpb
operator|.
name|bpbFSInfo
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbBackup
condition|)
block|{
if|if
condition|(
name|x
operator|==
name|MAXU16
condition|)
block|{
name|warnx
argument_list|(
literal|"no room for backup sector"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|bpb
operator|.
name|bpbBackup
operator|=
name|x
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bpbBackup
operator|!=
name|MAXU16
operator|&&
name|bpb
operator|.
name|bpbBackup
operator|==
name|bpb
operator|.
name|bpbFSInfo
condition|)
block|{
name|warnx
argument_list|(
literal|"backup sector would overwrite info sector"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|bpb
operator|.
name|bpbBackup
operator|!=
name|MAXU16
operator|&&
name|x
operator|<=
name|bpb
operator|.
name|bpbBackup
condition|)
name|x
operator|=
name|bpb
operator|.
name|bpbBackup
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbResSectors
condition|)
name|bpb
operator|.
name|bpbResSectors
operator|=
name|fat
operator|==
literal|32
condition|?
name|MAX
argument_list|(
name|x
argument_list|,
name|MAX
argument_list|(
literal|16384
operator|/
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|,
literal|4
argument_list|)
argument_list|)
else|:
name|x
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bpbResSectors
operator|<
name|x
condition|)
block|{
name|warnx
argument_list|(
literal|"too few reserved sectors (need %d have %d)"
argument_list|,
name|x
argument_list|,
name|bpb
operator|.
name|bpbResSectors
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|fat
operator|!=
literal|32
operator|&&
operator|!
name|bpb
operator|.
name|bpbRootDirEnts
condition|)
name|bpb
operator|.
name|bpbRootDirEnts
operator|=
name|DEFRDE
expr_stmt|;
name|rds
operator|=
name|howmany
argument_list|(
name|bpb
operator|.
name|bpbRootDirEnts
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|de
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbSecPerClust
condition|)
for|for
control|(
name|bpb
operator|.
name|bpbSecPerClust
operator|=
name|howmany
argument_list|(
name|fat
operator|==
literal|16
condition|?
name|DEFBLK16
else|:
name|DEFBLK
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
init|;
name|bpb
operator|.
name|bpbSecPerClust
operator|<
name|MAXSPC
operator|&&
name|bpb
operator|.
name|bpbResSectors
operator|+
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
name|maxcls
argument_list|(
name|fat
argument_list|)
operator|)
operator|*
operator|(
name|fat
operator|/
name|BPN
operator|)
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|NPB
argument_list|)
operator|*
name|bpb
operator|.
name|bpbFATs
operator|+
name|rds
operator|+
call|(
name|u_int64_t
call|)
argument_list|(
name|maxcls
argument_list|(
name|fat
argument_list|)
operator|+
literal|1
argument_list|)
operator|*
name|bpb
operator|.
name|bpbSecPerClust
operator|<=
name|bpb
operator|.
name|bpbHugeSectors
condition|;
name|bpb
operator|.
name|bpbSecPerClust
operator|<<=
literal|1
control|)
continue|continue;
if|if
condition|(
name|fat
operator|!=
literal|32
operator|&&
name|bpb
operator|.
name|bpbBigFATsecs
operator|>
name|MAXU16
condition|)
block|{
name|warnx
argument_list|(
literal|"too many sectors/FAT for FAT12/16"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|x1
operator|=
name|bpb
operator|.
name|bpbResSectors
operator|+
name|rds
expr_stmt|;
name|x
operator|=
name|bpb
operator|.
name|bpbBigFATsecs
condition|?
name|bpb
operator|.
name|bpbBigFATsecs
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|x1
operator|+
operator|(
name|u_int64_t
operator|)
name|x
operator|*
name|bpb
operator|.
name|bpbFATs
operator|>
name|bpb
operator|.
name|bpbHugeSectors
condition|)
block|{
name|warnx
argument_list|(
literal|"meta data exceeds file system size"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|x1
operator|+=
name|x
operator|*
name|bpb
operator|.
name|bpbFATs
expr_stmt|;
name|x
operator|=
call|(
name|u_int64_t
call|)
argument_list|(
name|bpb
operator|.
name|bpbHugeSectors
operator|-
name|x1
argument_list|)
operator|*
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|NPB
operator|/
operator|(
name|bpb
operator|.
name|bpbSecPerClust
operator|*
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|NPB
operator|+
name|fat
operator|/
name|BPN
operator|*
name|bpb
operator|.
name|bpbFATs
operator|)
expr_stmt|;
name|x2
operator|=
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
name|MIN
argument_list|(
name|x
argument_list|,
name|maxcls
argument_list|(
name|fat
argument_list|)
argument_list|)
operator|)
operator|*
operator|(
name|fat
operator|/
name|BPN
operator|)
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|NPB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbBigFATsecs
condition|)
block|{
name|bpb
operator|.
name|bpbBigFATsecs
operator|=
name|x2
expr_stmt|;
name|x1
operator|+=
operator|(
name|bpb
operator|.
name|bpbBigFATsecs
operator|-
literal|1
operator|)
operator|*
name|bpb
operator|.
name|bpbFATs
expr_stmt|;
block|}
name|cls
operator|=
operator|(
name|bpb
operator|.
name|bpbHugeSectors
operator|-
name|x1
operator|)
operator|/
name|bpb
operator|.
name|bpbSecPerClust
expr_stmt|;
name|x
operator|=
operator|(
name|u_int64_t
operator|)
name|bpb
operator|.
name|bpbBigFATsecs
operator|*
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|NPB
operator|/
operator|(
name|fat
operator|/
name|BPN
operator|)
operator|-
name|RESFTE
expr_stmt|;
if|if
condition|(
name|cls
operator|>
name|x
condition|)
name|cls
operator|=
name|x
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|bpbBigFATsecs
operator|<
name|x2
condition|)
name|warnx
argument_list|(
literal|"warning: sectors/FAT limits file system to %u clusters"
argument_list|,
name|cls
argument_list|)
expr_stmt|;
if|if
condition|(
name|cls
operator|<
name|mincls
argument_list|(
name|fat
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%u clusters too few clusters for FAT%u, need %u"
argument_list|,
name|cls
argument_list|,
name|fat
argument_list|,
name|mincls
argument_list|(
name|fat
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|cls
operator|>
name|maxcls
argument_list|(
name|fat
argument_list|)
condition|)
block|{
name|cls
operator|=
name|maxcls
argument_list|(
name|fat
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bpbHugeSectors
operator|=
name|x1
operator|+
operator|(
name|cls
operator|+
literal|1
operator|)
operator|*
name|bpb
operator|.
name|bpbSecPerClust
operator|-
literal|1
expr_stmt|;
name|warnx
argument_list|(
literal|"warning: FAT type limits file system to %u sectors"
argument_list|,
name|bpb
operator|.
name|bpbHugeSectors
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: %u sector%s in %u FAT%u cluster%s "
literal|"(%u bytes/cluster)\n"
argument_list|,
name|fname
argument_list|,
name|cls
operator|*
name|bpb
operator|.
name|bpbSecPerClust
argument_list|,
name|cls
operator|*
name|bpb
operator|.
name|bpbSecPerClust
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|,
name|cls
argument_list|,
name|fat
argument_list|,
name|cls
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
operator|*
name|bpb
operator|.
name|bpbSecPerClust
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|bpbMedia
condition|)
name|bpb
operator|.
name|bpbMedia
operator|=
operator|!
name|bpb
operator|.
name|bpbHiddenSecs
condition|?
literal|0xf0
else|:
literal|0xf8
expr_stmt|;
if|if
condition|(
name|fat
operator|==
literal|32
condition|)
name|bpb
operator|.
name|bpbRootClust
operator|=
name|RESFTE
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|bpbHugeSectors
operator|<=
name|MAXU16
condition|)
block|{
name|bpb
operator|.
name|bpbSectors
operator|=
name|bpb
operator|.
name|bpbHugeSectors
expr_stmt|;
name|bpb
operator|.
name|bpbHugeSectors
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|fat
operator|!=
literal|32
condition|)
block|{
name|bpb
operator|.
name|bpbFATsecs
operator|=
name|bpb
operator|.
name|bpbBigFATsecs
expr_stmt|;
name|bpb
operator|.
name|bpbBigFATsecs
operator|=
literal|0
expr_stmt|;
block|}
name|print_bpb
argument_list|(
operator|&
name|bpb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|o
operator|.
name|no_create
condition|)
block|{
if|if
condition|(
name|o
operator|.
name|timestamp_set
condition|)
block|{
name|tv
operator|.
name|tv_sec
operator|=
name|now
operator|=
name|o
operator|.
name|timestamp
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|tm
operator|=
name|gmtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|now
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|img
operator|=
name|malloc
argument_list|(
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
operator|)
condition|)
block|{
name|warn
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|dir
operator|=
name|bpb
operator|.
name|bpbResSectors
operator|+
operator|(
name|bpb
operator|.
name|bpbFATsecs
condition|?
name|bpb
operator|.
name|bpbFATsecs
else|:
name|bpb
operator|.
name|bpbBigFATsecs
operator|)
operator|*
name|bpb
operator|.
name|bpbFATs
expr_stmt|;
name|memset
argument_list|(
operator|&
name|si_sa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|si_sa
argument_list|)
argument_list|)
expr_stmt|;
name|si_sa
operator|.
name|sa_handler
operator|=
name|infohandler
expr_stmt|;
if|if
condition|(
name|sigaction
argument_list|(
name|SIGINFO
argument_list|,
operator|&
name|si_sa
argument_list|,
name|NULL
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"sigaction SIGINFO"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
for|for
control|(
name|lsn
operator|=
literal|0
init|;
name|lsn
operator|<
name|dir
operator|+
operator|(
name|fat
operator|==
literal|32
condition|?
name|bpb
operator|.
name|bpbSecPerClust
else|:
name|rds
operator|)
condition|;
name|lsn
operator|++
control|)
block|{
if|if
condition|(
name|got_siginfo
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: writing sector %u of %u (%u%%)\n"
argument_list|,
name|fname
argument_list|,
name|lsn
argument_list|,
operator|(
name|dir
operator|+
operator|(
name|fat
operator|==
literal|32
condition|?
name|bpb
operator|.
name|bpbSecPerClust
else|:
name|rds
operator|)
operator|)
argument_list|,
operator|(
name|lsn
operator|*
literal|100
operator|)
operator|/
operator|(
name|dir
operator|+
operator|(
name|fat
operator|==
literal|32
condition|?
name|bpb
operator|.
name|bpbSecPerClust
else|:
name|rds
operator|)
operator|)
argument_list|)
expr_stmt|;
name|got_siginfo
operator|=
literal|0
expr_stmt|;
block|}
name|x
operator|=
name|lsn
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|bootstrap
operator|&&
name|fat
operator|==
literal|32
operator|&&
name|bpb
operator|.
name|bpbBackup
operator|!=
name|MAXU16
operator|&&
name|bss
operator|<=
name|bpb
operator|.
name|bpbBackup
operator|&&
name|x
operator|>=
name|bpb
operator|.
name|bpbBackup
condition|)
block|{
name|x
operator|-=
name|bpb
operator|.
name|bpbBackup
expr_stmt|;
if|if
condition|(
operator|!
name|x
operator|&&
name|lseek
argument_list|(
name|fd1
argument_list|,
name|o
operator|.
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
if|if
condition|(
name|o
operator|.
name|bootstrap
operator|&&
name|x
operator|<
name|bss
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|fd1
argument_list|,
name|img
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
name|unsigned
operator|)
name|n
operator|!=
name|bpb
operator|.
name|bpbBytesPerSec
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't read sector %u"
argument_list|,
name|bname
argument_list|,
name|x
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
name|memset
argument_list|(
name|img
argument_list|,
literal|0
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lsn
operator|||
operator|(
name|fat
operator|==
literal|32
operator|&&
name|bpb
operator|.
name|bpbBackup
operator|!=
name|MAXU16
operator|&&
name|lsn
operator|==
name|bpb
operator|.
name|bpbBackup
operator|)
condition|)
block|{
name|x1
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|bs
argument_list|)
expr_stmt|;
name|bsbpb
operator|=
operator|(
expr|struct
name|bsbpb
operator|*
operator|)
operator|(
name|img
operator|+
name|x1
operator|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbBytesPerSec
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bsbpb
operator|->
name|bpbSecPerClust
argument_list|,
name|bpb
operator|.
name|bpbSecPerClust
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbResSectors
argument_list|,
name|bpb
operator|.
name|bpbResSectors
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bsbpb
operator|->
name|bpbFATs
argument_list|,
name|bpb
operator|.
name|bpbFATs
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbRootDirEnts
argument_list|,
name|bpb
operator|.
name|bpbRootDirEnts
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbSectors
argument_list|,
name|bpb
operator|.
name|bpbSectors
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bsbpb
operator|->
name|bpbMedia
argument_list|,
name|bpb
operator|.
name|bpbMedia
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbFATsecs
argument_list|,
name|bpb
operator|.
name|bpbFATsecs
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbSecPerTrack
argument_list|,
name|bpb
operator|.
name|bpbSecPerTrack
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bpbHeads
argument_list|,
name|bpb
operator|.
name|bpbHeads
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|bsbpb
operator|->
name|bpbHiddenSecs
argument_list|,
name|bpb
operator|.
name|bpbHiddenSecs
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|bsbpb
operator|->
name|bpbHugeSectors
argument_list|,
name|bpb
operator|.
name|bpbHugeSectors
argument_list|)
expr_stmt|;
name|x1
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|bsbpb
argument_list|)
expr_stmt|;
if|if
condition|(
name|fat
operator|==
literal|32
condition|)
block|{
name|bsxbpb
operator|=
operator|(
expr|struct
name|bsxbpb
operator|*
operator|)
operator|(
name|img
operator|+
name|x1
operator|)
expr_stmt|;
name|mk4
argument_list|(
name|bsxbpb
operator|->
name|bpbBigFATsecs
argument_list|,
name|bpb
operator|.
name|bpbBigFATsecs
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|bpbExtFlags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|bpbFSVers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|bsxbpb
operator|->
name|bpbRootClust
argument_list|,
name|bpb
operator|.
name|bpbRootClust
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|bpbFSInfo
argument_list|,
name|bpb
operator|.
name|bpbFSInfo
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|bpbBackup
argument_list|,
name|bpb
operator|.
name|bpbBackup
argument_list|)
expr_stmt|;
name|x1
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|bsxbpb
argument_list|)
expr_stmt|;
block|}
name|bsx
operator|=
operator|(
expr|struct
name|bsx
operator|*
operator|)
operator|(
name|img
operator|+
name|x1
operator|)
expr_stmt|;
name|mk1
argument_list|(
name|bsx
operator|->
name|exBootSignature
argument_list|,
literal|0x29
argument_list|)
expr_stmt|;
if|if
condition|(
name|o
operator|.
name|volume_id_set
condition|)
name|x
operator|=
name|o
operator|.
name|volume_id
expr_stmt|;
else|else
name|x
operator|=
operator|(
operator|(
call|(
name|u_int
call|)
argument_list|(
literal|1
operator|+
name|tm
operator|->
name|tm_mon
argument_list|)
operator|<<
literal|8
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_mday
operator|)
operator|+
operator|(
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_sec
operator|<<
literal|8
operator||
call|(
name|u_int
call|)
argument_list|(
name|tv
operator|.
name|tv_usec
operator|/
literal|10
argument_list|)
operator|)
operator|)
operator|<<
literal|16
operator||
operator|(
call|(
name|u_int
call|)
argument_list|(
literal|1900
operator|+
name|tm
operator|->
name|tm_year
argument_list|)
operator|+
operator|(
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_hour
operator|<<
literal|8
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_min
operator|)
operator|)
expr_stmt|;
name|mk4
argument_list|(
name|bsx
operator|->
name|exVolumeID
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|mklabel
argument_list|(
name|bsx
operator|->
name|exVolumeLabel
argument_list|,
name|o
operator|.
name|volume_label
condition|?
name|o
operator|.
name|volume_label
else|:
literal|"NO NAME"
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"FAT%u"
argument_list|,
name|fat
argument_list|)
expr_stmt|;
name|setstr
argument_list|(
name|bsx
operator|->
name|exFileSysType
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|bsx
operator|->
name|exFileSysType
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|o
operator|.
name|bootstrap
condition|)
block|{
name|x1
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|bsx
argument_list|)
expr_stmt|;
name|bs
operator|=
operator|(
expr|struct
name|bs
operator|*
operator|)
name|img
expr_stmt|;
name|mk1
argument_list|(
name|bs
operator|->
name|bsJump
index|[
literal|0
index|]
argument_list|,
literal|0xeb
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bs
operator|->
name|bsJump
index|[
literal|1
index|]
argument_list|,
name|x1
operator|-
literal|2
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bs
operator|->
name|bsJump
index|[
literal|2
index|]
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|setstr
argument_list|(
name|bs
operator|->
name|bsOemName
argument_list|,
name|o
operator|.
name|OEM_string
condition|?
name|o
operator|.
name|OEM_string
else|:
literal|"BSD4.4  "
argument_list|,
sizeof|sizeof
argument_list|(
name|bs
operator|->
name|bsOemName
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|img
operator|+
name|x1
argument_list|,
name|bootcode
argument_list|,
sizeof|sizeof
argument_list|(
name|bootcode
argument_list|)
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|2
argument_list|,
name|DOSMAGIC
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|fat
operator|==
literal|32
operator|&&
name|bpb
operator|.
name|bpbFSInfo
operator|!=
name|MAXU16
operator|&&
operator|(
name|lsn
operator|==
name|bpb
operator|.
name|bpbFSInfo
operator|||
operator|(
name|bpb
operator|.
name|bpbBackup
operator|!=
name|MAXU16
operator|&&
name|lsn
operator|==
name|bpb
operator|.
name|bpbBackup
operator|+
name|bpb
operator|.
name|bpbFSInfo
operator|)
operator|)
condition|)
block|{
name|mk4
argument_list|(
name|img
argument_list|,
literal|0x41615252
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|28
argument_list|,
literal|0x61417272
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|24
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|20
argument_list|,
name|bpb
operator|.
name|bpbRootClust
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|2
argument_list|,
name|DOSMAGIC
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lsn
operator|>=
name|bpb
operator|.
name|bpbResSectors
operator|&&
name|lsn
operator|<
name|dir
operator|&&
operator|!
operator|(
operator|(
name|lsn
operator|-
name|bpb
operator|.
name|bpbResSectors
operator|)
operator|%
operator|(
name|bpb
operator|.
name|bpbFATsecs
condition|?
name|bpb
operator|.
name|bpbFATsecs
else|:
name|bpb
operator|.
name|bpbBigFATsecs
operator|)
operator|)
condition|)
block|{
name|mk1
argument_list|(
name|img
index|[
literal|0
index|]
argument_list|,
name|bpb
operator|.
name|bpbMedia
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|1
init|;
name|x
operator|<
name|fat
operator|*
operator|(
name|fat
operator|==
literal|32
condition|?
literal|3
else|:
literal|2
operator|)
operator|/
literal|8
condition|;
name|x
operator|++
control|)
name|mk1
argument_list|(
name|img
index|[
name|x
index|]
argument_list|,
name|fat
operator|==
literal|32
operator|&&
name|x
operator|%
literal|4
operator|==
literal|3
condition|?
literal|0x0f
else|:
literal|0xff
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lsn
operator|==
name|dir
operator|&&
name|o
operator|.
name|volume_label
condition|)
block|{
name|de
operator|=
operator|(
expr|struct
name|de
operator|*
operator|)
name|img
expr_stmt|;
name|mklabel
argument_list|(
name|de
operator|->
name|deName
argument_list|,
name|o
operator|.
name|volume_label
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|de
operator|->
name|deAttributes
argument_list|,
literal|050
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_hour
operator|<<
literal|11
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_min
operator|<<
literal|5
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_sec
operator|>>
literal|1
expr_stmt|;
name|mk2
argument_list|(
name|de
operator|->
name|deMTime
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|x
operator|=
call|(
name|u_int
call|)
argument_list|(
name|tm
operator|->
name|tm_year
operator|-
literal|80
argument_list|)
operator|<<
literal|9
operator||
call|(
name|u_int
call|)
argument_list|(
name|tm
operator|->
name|tm_mon
operator|+
literal|1
argument_list|)
operator|<<
literal|5
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_mday
expr_stmt|;
name|mk2
argument_list|(
name|de
operator|->
name|deMDate
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|img
argument_list|,
name|bpb
operator|.
name|bpbBytesPerSec
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"%s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|(
name|unsigned
operator|)
name|n
operator|!=
name|bpb
operator|.
name|bpbBytesPerSec
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: can't write sector %u"
argument_list|,
name|fname
argument_list|,
name|lsn
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
block|}
name|rv
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|free
argument_list|(
name|img
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_comment
comment|/*  * return -1 with error if file system is mounted.  */
end_comment

begin_function
specifier|static
name|int
name|check_mounted
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|mode_t
name|mode
parameter_list|)
block|{
name|struct
name|statfs
modifier|*
name|mp
decl_stmt|;
specifier|const
name|char
modifier|*
name|s1
decl_stmt|,
modifier|*
name|s2
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|n
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|n
operator|=
name|getmntinfo
argument_list|(
operator|&
name|mp
argument_list|,
name|MNT_NOWAIT
argument_list|)
operator|)
condition|)
block|{
name|warn
argument_list|(
literal|"getmntinfo"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|_PATH_DEV
argument_list|)
expr_stmt|;
name|s1
operator|=
name|fname
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|s1
argument_list|,
name|_PATH_DEV
argument_list|,
name|len
argument_list|)
condition|)
name|s1
operator|+=
name|len
expr_stmt|;
name|r
operator|=
name|S_ISCHR
argument_list|(
name|mode
argument_list|)
operator|&&
name|s1
operator|!=
name|fname
operator|&&
operator|*
name|s1
operator|==
literal|'r'
expr_stmt|;
for|for
control|(
init|;
name|n
operator|--
condition|;
name|mp
operator|++
control|)
block|{
name|s2
operator|=
name|mp
operator|->
name|f_mntfromname
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|s2
argument_list|,
name|_PATH_DEV
argument_list|,
name|len
argument_list|)
condition|)
name|s2
operator|+=
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|&&
name|s2
operator|!=
name|mp
operator|->
name|f_mntfromname
operator|&&
operator|!
name|strcmp
argument_list|(
name|s1
operator|+
literal|1
argument_list|,
name|s2
argument_list|)
operator|)
operator|||
operator|!
name|strcmp
argument_list|(
name|s1
argument_list|,
name|s2
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"%s is mounted on %s"
argument_list|,
name|fname
argument_list|,
name|mp
operator|->
name|f_mntonname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get a standard format.  */
end_comment

begin_function
specifier|static
name|int
name|getstdfmt
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|struct
name|bpb
modifier|*
name|bpb
parameter_list|)
block|{
name|u_int
name|x
decl_stmt|,
name|i
decl_stmt|;
name|x
operator|=
name|nitems
argument_list|(
name|stdfmt
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|x
operator|&&
name|strcmp
argument_list|(
name|fmt
argument_list|,
name|stdfmt
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|i
operator|==
name|x
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: unknown standard format"
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|bpb
operator|=
name|stdfmt
index|[
name|i
index|]
operator|.
name|bpb
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Get disk slice, partition, and geometry information.  */
end_comment

begin_function
specifier|static
name|int
name|getdiskinfo
parameter_list|(
name|int
name|fd
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
specifier|const
name|char
modifier|*
name|dtype
parameter_list|,
name|__unused
name|int
name|oflag
parameter_list|,
name|struct
name|bpb
modifier|*
name|bpb
parameter_list|)
block|{
name|struct
name|disklabel
modifier|*
name|lp
decl_stmt|,
name|dlp
decl_stmt|;
name|struct
name|fd_type
name|type
decl_stmt|;
name|off_t
name|ms
decl_stmt|,
name|hs
init|=
literal|0
decl_stmt|;
name|lp
operator|=
name|NULL
expr_stmt|;
comment|/* If the user specified a disk type, try to use that */
if|if
condition|(
name|dtype
operator|!=
name|NULL
condition|)
block|{
name|lp
operator|=
name|getdiskbyname
argument_list|(
name|dtype
argument_list|)
expr_stmt|;
block|}
comment|/* Maybe it's a floppy drive */
if|if
condition|(
name|lp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGMEDIASIZE
argument_list|,
operator|&
name|ms
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|st
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"cannot get disk size"
argument_list|)
expr_stmt|;
comment|/* create a fake geometry for a file image */
name|ms
operator|=
name|st
operator|.
name|st_size
expr_stmt|;
name|dlp
operator|.
name|d_secsize
operator|=
literal|512
expr_stmt|;
name|dlp
operator|.
name|d_nsectors
operator|=
literal|63
expr_stmt|;
name|dlp
operator|.
name|d_ntracks
operator|=
literal|255
expr_stmt|;
name|dlp
operator|.
name|d_secperunit
operator|=
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
expr_stmt|;
name|lp
operator|=
operator|&
name|dlp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|FD_GTYPE
argument_list|,
operator|&
name|type
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|dlp
operator|.
name|d_secsize
operator|=
literal|128
operator|<<
name|type
operator|.
name|secsize
expr_stmt|;
name|dlp
operator|.
name|d_nsectors
operator|=
name|type
operator|.
name|sectrac
expr_stmt|;
name|dlp
operator|.
name|d_ntracks
operator|=
name|type
operator|.
name|heads
expr_stmt|;
name|dlp
operator|.
name|d_secperunit
operator|=
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
expr_stmt|;
name|lp
operator|=
operator|&
name|dlp
expr_stmt|;
block|}
block|}
comment|/* Maybe it's a fixed drive */
if|if
condition|(
name|lp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|bpb
operator|->
name|bpbBytesPerSec
condition|)
name|dlp
operator|.
name|d_secsize
operator|=
name|bpb
operator|->
name|bpbBytesPerSec
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbBytesPerSec
operator|==
literal|0
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGSECTORSIZE
argument_list|,
operator|&
name|dlp
operator|.
name|d_secsize
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"cannot get sector size"
argument_list|)
expr_stmt|;
name|dlp
operator|.
name|d_secperunit
operator|=
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbSecPerTrack
operator|==
literal|0
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGFWSECTORS
argument_list|,
operator|&
name|dlp
operator|.
name|d_nsectors
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"cannot get number of sectors per track"
argument_list|)
expr_stmt|;
name|dlp
operator|.
name|d_nsectors
operator|=
literal|63
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|bpbHeads
operator|==
literal|0
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGFWHEADS
argument_list|,
operator|&
name|dlp
operator|.
name|d_ntracks
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"cannot get number of heads"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlp
operator|.
name|d_secperunit
operator|<=
literal|63
operator|*
literal|1
operator|*
literal|1024
condition|)
name|dlp
operator|.
name|d_ntracks
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|dlp
operator|.
name|d_secperunit
operator|<=
literal|63
operator|*
literal|16
operator|*
literal|1024
condition|)
name|dlp
operator|.
name|d_ntracks
operator|=
literal|16
expr_stmt|;
else|else
name|dlp
operator|.
name|d_ntracks
operator|=
literal|255
expr_stmt|;
block|}
name|hs
operator|=
operator|(
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
operator|)
operator|-
name|dlp
operator|.
name|d_secperunit
expr_stmt|;
name|lp
operator|=
operator|&
name|dlp
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|bpbBytesPerSec
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ckgeom
argument_list|(
name|fname
argument_list|,
name|lp
operator|->
name|d_secsize
argument_list|,
literal|"bytes/sector"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|bpb
operator|->
name|bpbBytesPerSec
operator|=
name|lp
operator|->
name|d_secsize
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|bpbSecPerTrack
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ckgeom
argument_list|(
name|fname
argument_list|,
name|lp
operator|->
name|d_nsectors
argument_list|,
literal|"sectors/track"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|bpb
operator|->
name|bpbSecPerTrack
operator|=
name|lp
operator|->
name|d_nsectors
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|bpbHeads
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ckgeom
argument_list|(
name|fname
argument_list|,
name|lp
operator|->
name|d_ntracks
argument_list|,
literal|"drive heads"
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|bpb
operator|->
name|bpbHeads
operator|=
name|lp
operator|->
name|d_ntracks
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|bpbHugeSectors
operator|==
literal|0
condition|)
name|bpb
operator|->
name|bpbHugeSectors
operator|=
name|lp
operator|->
name|d_secperunit
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbHiddenSecs
operator|==
literal|0
condition|)
name|bpb
operator|->
name|bpbHiddenSecs
operator|=
name|hs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Print out BPB values.  */
end_comment

begin_function
specifier|static
name|void
name|print_bpb
parameter_list|(
name|struct
name|bpb
modifier|*
name|bpb
parameter_list|)
block|{
name|printf
argument_list|(
literal|"BytesPerSec=%u SecPerClust=%u ResSectors=%u FATs=%u"
argument_list|,
name|bpb
operator|->
name|bpbBytesPerSec
argument_list|,
name|bpb
operator|->
name|bpbSecPerClust
argument_list|,
name|bpb
operator|->
name|bpbResSectors
argument_list|,
name|bpb
operator|->
name|bpbFATs
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbRootDirEnts
condition|)
name|printf
argument_list|(
literal|" RootDirEnts=%u"
argument_list|,
name|bpb
operator|->
name|bpbRootDirEnts
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbSectors
condition|)
name|printf
argument_list|(
literal|" Sectors=%u"
argument_list|,
name|bpb
operator|->
name|bpbSectors
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Media=%#x"
argument_list|,
name|bpb
operator|->
name|bpbMedia
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbFATsecs
condition|)
name|printf
argument_list|(
literal|" FATsecs=%u"
argument_list|,
name|bpb
operator|->
name|bpbFATsecs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" SecPerTrack=%u Heads=%u HiddenSecs=%u"
argument_list|,
name|bpb
operator|->
name|bpbSecPerTrack
argument_list|,
name|bpb
operator|->
name|bpbHeads
argument_list|,
name|bpb
operator|->
name|bpbHiddenSecs
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bpbHugeSectors
condition|)
name|printf
argument_list|(
literal|" HugeSectors=%u"
argument_list|,
name|bpb
operator|->
name|bpbHugeSectors
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|->
name|bpbFATsecs
condition|)
block|{
name|printf
argument_list|(
literal|" FATsecs=%u RootCluster=%u"
argument_list|,
name|bpb
operator|->
name|bpbBigFATsecs
argument_list|,
name|bpb
operator|->
name|bpbRootClust
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" FSInfo="
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|bpb
operator|->
name|bpbFSInfo
operator|==
name|MAXU16
condition|?
literal|"%#x"
else|:
literal|"%u"
argument_list|,
name|bpb
operator|->
name|bpbFSInfo
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Backup="
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|bpb
operator|->
name|bpbBackup
operator|==
name|MAXU16
condition|?
literal|"%#x"
else|:
literal|"%u"
argument_list|,
name|bpb
operator|->
name|bpbBackup
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Check a disk geometry value.  */
end_comment

begin_function
specifier|static
name|int
name|ckgeom
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|u_int
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|val
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: no default %s"
argument_list|,
name|fname
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|val
operator|>
name|MAXU16
condition|)
block|{
name|warnx
argument_list|(
literal|"%s: illegal %s %d"
argument_list|,
name|fname
argument_list|,
name|msg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Check a volume label.  */
end_comment

begin_function
specifier|static
name|int
name|oklabel
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|)
block|{
name|int
name|c
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|(
name|u_char
operator|)
operator|*
name|src
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|' '
operator|+
operator|!
name|i
operator|||
name|strchr
argument_list|(
literal|"\"*+,./:;<=>?[\\]|"
argument_list|,
name|c
argument_list|)
condition|)
break|break;
block|}
return|return
name|i
operator|&&
operator|!
name|c
return|;
block|}
end_function

begin_comment
comment|/*  * Make a volume label.  */
end_comment

begin_function
specifier|static
name|void
name|mklabel
parameter_list|(
name|u_int8_t
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|)
block|{
name|int
name|c
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|*
name|src
condition|?
name|toupper
argument_list|(
operator|*
name|src
operator|++
argument_list|)
else|:
literal|' '
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
operator|!
name|i
operator|&&
name|c
operator|==
literal|'\xe5'
condition|?
literal|5
else|:
name|c
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Copy string, padding with spaces.  */
end_comment

begin_function
specifier|static
name|void
name|setstr
parameter_list|(
name|u_int8_t
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
condition|)
operator|*
name|dest
operator|++
operator|=
operator|*
name|src
condition|?
operator|*
name|src
operator|++
else|:
literal|' '
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|infohandler
parameter_list|(
name|int
name|sig
name|__unused
parameter_list|)
block|{
name|got_siginfo
operator|=
literal|1
expr_stmt|;
block|}
end_function

end_unit


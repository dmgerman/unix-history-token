begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1998 Robert Nordier  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in  *    the documentation and/or other materials provided with the  *    distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR(S) ``AS IS'' AND ANY EXPRESS  * OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE  * GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER  * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN  * IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/fdcio.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<paths.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_define
define|#
directive|define
name|MAXU16
value|0xffff
end_define

begin_comment
comment|/* maximum unsigned 16-bit quantity */
end_comment

begin_define
define|#
directive|define
name|BPN
value|4
end_define

begin_comment
comment|/* bits per nibble */
end_comment

begin_define
define|#
directive|define
name|NPB
value|2
end_define

begin_comment
comment|/* nibbles per byte */
end_comment

begin_define
define|#
directive|define
name|DOSMAGIC
value|0xaa55
end_define

begin_comment
comment|/* DOS magic number */
end_comment

begin_define
define|#
directive|define
name|MINBPS
value|512
end_define

begin_comment
comment|/* minimum bytes per sector */
end_comment

begin_define
define|#
directive|define
name|MAXSPC
value|128
end_define

begin_comment
comment|/* maximum sectors per cluster */
end_comment

begin_define
define|#
directive|define
name|MAXNFT
value|16
end_define

begin_comment
comment|/* maximum number of FATs */
end_comment

begin_define
define|#
directive|define
name|DEFBLK
value|4096
end_define

begin_comment
comment|/* default block size */
end_comment

begin_define
define|#
directive|define
name|DEFBLK16
value|2048
end_define

begin_comment
comment|/* default block size FAT16 */
end_comment

begin_define
define|#
directive|define
name|DEFRDE
value|512
end_define

begin_comment
comment|/* default root directory entries */
end_comment

begin_define
define|#
directive|define
name|RESFTE
value|2
end_define

begin_comment
comment|/* reserved FAT entries */
end_comment

begin_define
define|#
directive|define
name|MINCLS12
value|1
end_define

begin_comment
comment|/* minimum FAT12 clusters */
end_comment

begin_define
define|#
directive|define
name|MINCLS16
value|0x1000
end_define

begin_comment
comment|/* minimum FAT16 clusters */
end_comment

begin_define
define|#
directive|define
name|MINCLS32
value|2
end_define

begin_comment
comment|/* minimum FAT32 clusters */
end_comment

begin_define
define|#
directive|define
name|MAXCLS12
value|0xfed
end_define

begin_comment
comment|/* maximum FAT12 clusters */
end_comment

begin_define
define|#
directive|define
name|MAXCLS16
value|0xfff5
end_define

begin_comment
comment|/* maximum FAT16 clusters */
end_comment

begin_define
define|#
directive|define
name|MAXCLS32
value|0xffffff5
end_define

begin_comment
comment|/* maximum FAT32 clusters */
end_comment

begin_define
define|#
directive|define
name|mincls
parameter_list|(
name|fat
parameter_list|)
value|((fat) == 12 ? MINCLS12 :	\ 		      (fat) == 16 ? MINCLS16 :	\ 				    MINCLS32)
end_define

begin_define
define|#
directive|define
name|maxcls
parameter_list|(
name|fat
parameter_list|)
value|((fat) == 12 ? MAXCLS12 :	\ 		      (fat) == 16 ? MAXCLS16 :	\ 				    MAXCLS32)
end_define

begin_define
define|#
directive|define
name|mk1
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|)
define|\
value|(p) = (u_int8_t)(x)
end_define

begin_define
define|#
directive|define
name|mk2
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|)
define|\
value|(p)[0] = (u_int8_t)(x),			\     (p)[1] = (u_int8_t)((x)>> 010)
end_define

begin_define
define|#
directive|define
name|mk4
parameter_list|(
name|p
parameter_list|,
name|x
parameter_list|)
define|\
value|(p)[0] = (u_int8_t)(x),			\     (p)[1] = (u_int8_t)((x)>> 010),		\     (p)[2] = (u_int8_t)((x)>> 020),		\     (p)[3] = (u_int8_t)((x)>> 030)
end_define

begin_define
define|#
directive|define
name|argto1
parameter_list|(
name|arg
parameter_list|,
name|lo
parameter_list|,
name|msg
parameter_list|)
value|argtou(arg, lo, 0xff, msg)
end_define

begin_define
define|#
directive|define
name|argto2
parameter_list|(
name|arg
parameter_list|,
name|lo
parameter_list|,
name|msg
parameter_list|)
value|argtou(arg, lo, 0xffff, msg)
end_define

begin_define
define|#
directive|define
name|argto4
parameter_list|(
name|arg
parameter_list|,
name|lo
parameter_list|,
name|msg
parameter_list|)
value|argtou(arg, lo, 0xffffffff, msg)
end_define

begin_define
define|#
directive|define
name|argtox
parameter_list|(
name|arg
parameter_list|,
name|lo
parameter_list|,
name|msg
parameter_list|)
value|argtou(arg, lo, UINT_MAX, msg)
end_define

begin_struct
struct|struct
name|bs
block|{
name|u_int8_t
name|jmp
index|[
literal|3
index|]
decl_stmt|;
comment|/* bootstrap entry point */
name|u_int8_t
name|oem
index|[
literal|8
index|]
decl_stmt|;
comment|/* OEM name and version */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bsbpb
block|{
name|u_int8_t
name|bps
index|[
literal|2
index|]
decl_stmt|;
comment|/* bytes per sector */
name|u_int8_t
name|spc
decl_stmt|;
comment|/* sectors per cluster */
name|u_int8_t
name|res
index|[
literal|2
index|]
decl_stmt|;
comment|/* reserved sectors */
name|u_int8_t
name|nft
decl_stmt|;
comment|/* number of FATs */
name|u_int8_t
name|rde
index|[
literal|2
index|]
decl_stmt|;
comment|/* root directory entries */
name|u_int8_t
name|sec
index|[
literal|2
index|]
decl_stmt|;
comment|/* total sectors */
name|u_int8_t
name|mid
decl_stmt|;
comment|/* media descriptor */
name|u_int8_t
name|spf
index|[
literal|2
index|]
decl_stmt|;
comment|/* sectors per FAT */
name|u_int8_t
name|spt
index|[
literal|2
index|]
decl_stmt|;
comment|/* sectors per track */
name|u_int8_t
name|hds
index|[
literal|2
index|]
decl_stmt|;
comment|/* drive heads */
name|u_int8_t
name|hid
index|[
literal|4
index|]
decl_stmt|;
comment|/* hidden sectors */
name|u_int8_t
name|bsec
index|[
literal|4
index|]
decl_stmt|;
comment|/* big total sectors */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bsxbpb
block|{
name|u_int8_t
name|bspf
index|[
literal|4
index|]
decl_stmt|;
comment|/* big sectors per FAT */
name|u_int8_t
name|xflg
index|[
literal|2
index|]
decl_stmt|;
comment|/* FAT control flags */
name|u_int8_t
name|vers
index|[
literal|2
index|]
decl_stmt|;
comment|/* file system version */
name|u_int8_t
name|rdcl
index|[
literal|4
index|]
decl_stmt|;
comment|/* root directory start cluster */
name|u_int8_t
name|infs
index|[
literal|2
index|]
decl_stmt|;
comment|/* file system info sector */
name|u_int8_t
name|bkbs
index|[
literal|2
index|]
decl_stmt|;
comment|/* backup boot sector */
name|u_int8_t
name|rsvd
index|[
literal|12
index|]
decl_stmt|;
comment|/* reserved */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bsx
block|{
name|u_int8_t
name|drv
decl_stmt|;
comment|/* drive number */
name|u_int8_t
name|rsvd
decl_stmt|;
comment|/* reserved */
name|u_int8_t
name|sig
decl_stmt|;
comment|/* extended boot signature */
name|u_int8_t
name|volid
index|[
literal|4
index|]
decl_stmt|;
comment|/* volume ID number */
name|u_int8_t
name|label
index|[
literal|11
index|]
decl_stmt|;
comment|/* volume label */
name|u_int8_t
name|type
index|[
literal|8
index|]
decl_stmt|;
comment|/* file system type */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|de
block|{
name|u_int8_t
name|namext
index|[
literal|11
index|]
decl_stmt|;
comment|/* name and extension */
name|u_int8_t
name|attr
decl_stmt|;
comment|/* attributes */
name|u_int8_t
name|rsvd
index|[
literal|10
index|]
decl_stmt|;
comment|/* reserved */
name|u_int8_t
name|time
index|[
literal|2
index|]
decl_stmt|;
comment|/* creation time */
name|u_int8_t
name|date
index|[
literal|2
index|]
decl_stmt|;
comment|/* creation date */
name|u_int8_t
name|clus
index|[
literal|2
index|]
decl_stmt|;
comment|/* starting cluster */
name|u_int8_t
name|size
index|[
literal|4
index|]
decl_stmt|;
comment|/* size */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bpb
block|{
name|u_int
name|bps
decl_stmt|;
comment|/* bytes per sector */
name|u_int
name|spc
decl_stmt|;
comment|/* sectors per cluster */
name|u_int
name|res
decl_stmt|;
comment|/* reserved sectors */
name|u_int
name|nft
decl_stmt|;
comment|/* number of FATs */
name|u_int
name|rde
decl_stmt|;
comment|/* root directory entries */
name|u_int
name|sec
decl_stmt|;
comment|/* total sectors */
name|u_int
name|mid
decl_stmt|;
comment|/* media descriptor */
name|u_int
name|spf
decl_stmt|;
comment|/* sectors per FAT */
name|u_int
name|spt
decl_stmt|;
comment|/* sectors per track */
name|u_int
name|hds
decl_stmt|;
comment|/* drive heads */
name|u_int
name|hid
decl_stmt|;
comment|/* hidden sectors */
name|u_int
name|bsec
decl_stmt|;
comment|/* big total sectors */
name|u_int
name|bspf
decl_stmt|;
comment|/* big sectors per FAT */
name|u_int
name|rdcl
decl_stmt|;
comment|/* root directory start cluster */
name|u_int
name|infs
decl_stmt|;
comment|/* file system info sector */
name|u_int
name|bkbs
decl_stmt|;
comment|/* backup boot sector */
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BPBGAP
value|0, 0, 0, 0, 0, 0
end_define

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|struct
name|bpb
name|bpb
decl_stmt|;
block|}
decl|const
name|stdfmt
index|[]
init|=
block|{
block|{
literal|"160"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|64
block|,
literal|320
block|,
literal|0xfe
block|,
literal|1
block|,
literal|8
block|,
literal|1
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"180"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|64
block|,
literal|360
block|,
literal|0xfc
block|,
literal|2
block|,
literal|9
block|,
literal|1
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"320"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|640
block|,
literal|0xff
block|,
literal|1
block|,
literal|8
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"360"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|720
block|,
literal|0xfd
block|,
literal|2
block|,
literal|9
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"640"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|1280
block|,
literal|0xfb
block|,
literal|2
block|,
literal|8
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"720"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|112
block|,
literal|1440
block|,
literal|0xf9
block|,
literal|3
block|,
literal|9
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"1200"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|224
block|,
literal|2400
block|,
literal|0xf9
block|,
literal|7
block|,
literal|15
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"1232"
block|,
block|{
literal|1024
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|192
block|,
literal|1232
block|,
literal|0xfe
block|,
literal|2
block|,
literal|8
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"1440"
block|,
block|{
literal|512
block|,
literal|1
block|,
literal|1
block|,
literal|2
block|,
literal|224
block|,
literal|2880
block|,
literal|0xf0
block|,
literal|9
block|,
literal|18
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|,
block|{
literal|"2880"
block|,
block|{
literal|512
block|,
literal|2
block|,
literal|1
block|,
literal|2
block|,
literal|240
block|,
literal|5760
block|,
literal|0xf0
block|,
literal|9
block|,
literal|36
block|,
literal|2
block|,
name|BPBGAP
block|}
block|}
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|u_int8_t
name|bootcode
index|[]
init|=
block|{
literal|0xfa
block|,
comment|/* cli		    */
literal|0x31
block|,
literal|0xc0
block|,
comment|/* xor	   ax,ax    */
literal|0x8e
block|,
literal|0xd0
block|,
comment|/* mov	   ss,ax    */
literal|0xbc
block|,
literal|0x00
block|,
literal|0x7c
block|,
comment|/* mov	   sp,7c00h */
literal|0xfb
block|,
comment|/* sti		    */
literal|0x8e
block|,
literal|0xd8
block|,
comment|/* mov	   ds,ax    */
literal|0xe8
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* call    $ + 3    */
literal|0x5e
block|,
comment|/* pop	   si	    */
literal|0x83
block|,
literal|0xc6
block|,
literal|0x19
block|,
comment|/* add	   si,+19h  */
literal|0xbb
block|,
literal|0x07
block|,
literal|0x00
block|,
comment|/* mov	   bx,0007h */
literal|0xfc
block|,
comment|/* cld		    */
literal|0xac
block|,
comment|/* lodsb	    */
literal|0x84
block|,
literal|0xc0
block|,
comment|/* test    al,al    */
literal|0x74
block|,
literal|0x06
block|,
comment|/* jz	   $ + 8    */
literal|0xb4
block|,
literal|0x0e
block|,
comment|/* mov	   ah,0eh   */
literal|0xcd
block|,
literal|0x10
block|,
comment|/* int	   10h	    */
literal|0xeb
block|,
literal|0xf5
block|,
comment|/* jmp	   $ - 9    */
literal|0x30
block|,
literal|0xe4
block|,
comment|/* xor	   ah,ah    */
literal|0xcd
block|,
literal|0x16
block|,
comment|/* int	   16h	    */
literal|0xcd
block|,
literal|0x19
block|,
comment|/* int	   19h	    */
literal|0x0d
block|,
literal|0x0a
block|,
literal|'N'
block|,
literal|'o'
block|,
literal|'n'
block|,
literal|'-'
block|,
literal|'s'
block|,
literal|'y'
block|,
literal|'s'
block|,
literal|'t'
block|,
literal|'e'
block|,
literal|'m'
block|,
literal|' '
block|,
literal|'d'
block|,
literal|'i'
block|,
literal|'s'
block|,
literal|'k'
block|,
literal|0x0d
block|,
literal|0x0a
block|,
literal|'P'
block|,
literal|'r'
block|,
literal|'e'
block|,
literal|'s'
block|,
literal|'s'
block|,
literal|' '
block|,
literal|'a'
block|,
literal|'n'
block|,
literal|'y'
block|,
literal|' '
block|,
literal|'k'
block|,
literal|'e'
block|,
literal|'y'
block|,
literal|' '
block|,
literal|'t'
block|,
literal|'o'
block|,
literal|' '
block|,
literal|'r'
block|,
literal|'e'
block|,
literal|'b'
block|,
literal|'o'
block|,
literal|'o'
block|,
literal|'t'
block|,
literal|0x0d
block|,
literal|0x0a
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|check_mounted
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|mode_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|getstdfmt
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|bpb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|getdiskinfo
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|bpb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_bpb
parameter_list|(
name|struct
name|bpb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|ckgeom
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|u_int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|argtou
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|u_int
parameter_list|,
name|u_int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|off_t
name|argtooff
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|oklabel
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mklabel
parameter_list|(
name|u_int8_t
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|setstr
parameter_list|(
name|u_int8_t
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Construct a FAT12, FAT16, or FAT32 file system.  */
end_comment

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|opts
index|[]
init|=
literal|"@:NB:C:F:I:L:O:S:a:b:c:e:f:h:i:k:m:n:o:r:s:u:"
decl_stmt|;
specifier|const
name|char
modifier|*
name|opt_B
init|=
name|NULL
decl_stmt|,
modifier|*
name|opt_L
init|=
name|NULL
decl_stmt|,
modifier|*
name|opt_O
init|=
name|NULL
decl_stmt|,
modifier|*
name|opt_f
init|=
name|NULL
decl_stmt|;
name|u_int
name|opt_F
init|=
literal|0
decl_stmt|,
name|opt_I
init|=
literal|0
decl_stmt|,
name|opt_S
init|=
literal|0
decl_stmt|,
name|opt_a
init|=
literal|0
decl_stmt|,
name|opt_b
init|=
literal|0
decl_stmt|,
name|opt_c
init|=
literal|0
decl_stmt|;
name|u_int
name|opt_e
init|=
literal|0
decl_stmt|,
name|opt_h
init|=
literal|0
decl_stmt|,
name|opt_i
init|=
literal|0
decl_stmt|,
name|opt_k
init|=
literal|0
decl_stmt|,
name|opt_m
init|=
literal|0
decl_stmt|,
name|opt_n
init|=
literal|0
decl_stmt|;
name|u_int
name|opt_o
init|=
literal|0
decl_stmt|,
name|opt_r
init|=
literal|0
decl_stmt|,
name|opt_s
init|=
literal|0
decl_stmt|,
name|opt_u
init|=
literal|0
decl_stmt|;
name|int
name|opt_N
init|=
literal|0
decl_stmt|;
name|int
name|Iflag
init|=
literal|0
decl_stmt|,
name|mflag
init|=
literal|0
decl_stmt|,
name|oflag
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|struct
name|stat
name|sb
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|bpb
name|bpb
decl_stmt|;
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
name|struct
name|bs
modifier|*
name|bs
decl_stmt|;
name|struct
name|bsbpb
modifier|*
name|bsbpb
decl_stmt|;
name|struct
name|bsxbpb
modifier|*
name|bsxbpb
decl_stmt|;
name|struct
name|bsx
modifier|*
name|bsx
decl_stmt|;
name|struct
name|de
modifier|*
name|de
decl_stmt|;
name|u_int8_t
modifier|*
name|img
decl_stmt|;
specifier|const
name|char
modifier|*
name|fname
decl_stmt|,
modifier|*
name|dtype
decl_stmt|,
modifier|*
name|bname
decl_stmt|;
name|ssize_t
name|n
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|u_int
name|fat
decl_stmt|,
name|bss
decl_stmt|,
name|rds
decl_stmt|,
name|cls
decl_stmt|,
name|dir
decl_stmt|,
name|lsn
decl_stmt|,
name|x
decl_stmt|,
name|x1
decl_stmt|,
name|x2
decl_stmt|;
name|int
name|ch
decl_stmt|,
name|fd
decl_stmt|,
name|fd1
decl_stmt|;
name|off_t
name|opt_create
init|=
literal|0
decl_stmt|,
name|opt_ofs
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|opts
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'@'
case|:
name|opt_ofs
operator|=
name|argtooff
argument_list|(
name|optarg
argument_list|,
literal|"offset"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|opt_N
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|opt_B
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|opt_create
operator|=
name|argtooff
argument_list|(
name|optarg
argument_list|,
literal|"create size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
if|if
condition|(
name|strcmp
argument_list|(
name|optarg
argument_list|,
literal|"12"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|optarg
argument_list|,
literal|"16"
argument_list|)
operator|&&
name|strcmp
argument_list|(
name|optarg
argument_list|,
literal|"32"
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: bad FAT type"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|opt_F
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|opt_I
operator|=
name|argto4
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|"volume ID"
argument_list|)
expr_stmt|;
name|Iflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
if|if
condition|(
operator|!
name|oklabel
argument_list|(
name|optarg
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: bad volume label"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|opt_L
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
if|if
condition|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|>
literal|8
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: bad OEM string"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|opt_O
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|opt_S
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"bytes/sector"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
name|opt_a
operator|=
name|argto4
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"sectors/FAT"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|opt_b
operator|=
name|argtox
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"block size"
argument_list|)
expr_stmt|;
name|opt_c
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|opt_c
operator|=
name|argto1
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"sectors/cluster"
argument_list|)
expr_stmt|;
name|opt_b
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|opt_e
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"directory entries"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|opt_f
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|opt_h
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"drive heads"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|opt_i
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"info sector"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|opt_k
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"backup sector"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|opt_m
operator|=
name|argto1
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|"media descriptor"
argument_list|)
expr_stmt|;
name|mflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|opt_n
operator|=
name|argto1
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"number of FATs"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|opt_o
operator|=
name|argto4
argument_list|(
name|optarg
argument_list|,
literal|0
argument_list|,
literal|"hidden sectors"
argument_list|)
expr_stmt|;
name|oflag
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|opt_r
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"reserved sectors"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|opt_s
operator|=
name|argto4
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"file system size"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|opt_u
operator|=
name|argto2
argument_list|(
name|optarg
argument_list|,
literal|1
argument_list|,
literal|"sectors/track"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
operator|||
name|argc
operator|>
literal|2
condition|)
name|usage
argument_list|()
expr_stmt|;
name|fname
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|strchr
argument_list|(
name|fname
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|_PATH_DEV
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fname
operator|=
name|strdup
argument_list|(
name|buf
argument_list|)
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|dtype
operator|=
operator|*
name|argv
expr_stmt|;
if|if
condition|(
name|opt_create
condition|)
block|{
name|off_t
name|pos
decl_stmt|;
if|if
condition|(
name|opt_N
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"create (-C) is incompatible with -N"
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|O_RDWR
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"failed to create %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|pos
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
name|opt_create
operator|-
literal|1
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
literal|"\0"
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"failed to initialize %jd bytes"
argument_list|,
operator|(
name|intmax_t
operator|)
name|opt_create
argument_list|)
expr_stmt|;
name|pos
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|fname
argument_list|,
name|opt_N
condition|?
name|O_RDONLY
else|:
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|||
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|sb
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opt_N
condition|)
name|check_mounted
argument_list|(
name|fname
argument_list|,
name|sb
operator|.
name|st_mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|S_ISCHR
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
condition|)
name|warnx
argument_list|(
literal|"warning, %s is not a character device"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_ofs
operator|&&
name|opt_ofs
operator|!=
name|lseek
argument_list|(
name|fd
argument_list|,
name|opt_ofs
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"cannot seek to %jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|opt_ofs
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|bpb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bpb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_f
condition|)
block|{
name|getstdfmt
argument_list|(
name|opt_f
argument_list|,
operator|&
name|bpb
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bsec
operator|=
name|bpb
operator|.
name|sec
expr_stmt|;
name|bpb
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
name|bpb
operator|.
name|bspf
operator|=
name|bpb
operator|.
name|spf
expr_stmt|;
name|bpb
operator|.
name|spf
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|opt_h
condition|)
name|bpb
operator|.
name|hds
operator|=
name|opt_h
expr_stmt|;
if|if
condition|(
name|opt_u
condition|)
name|bpb
operator|.
name|spt
operator|=
name|opt_u
expr_stmt|;
if|if
condition|(
name|opt_S
condition|)
name|bpb
operator|.
name|bps
operator|=
name|opt_S
expr_stmt|;
if|if
condition|(
name|opt_s
condition|)
name|bpb
operator|.
name|bsec
operator|=
name|opt_s
expr_stmt|;
if|if
condition|(
name|oflag
condition|)
name|bpb
operator|.
name|hid
operator|=
name|opt_o
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|opt_f
operator|||
operator|(
name|opt_h
operator|&&
name|opt_u
operator|&&
name|opt_S
operator|&&
name|opt_s
operator|&&
name|oflag
operator|)
operator|)
condition|)
block|{
name|off_t
name|delta
decl_stmt|;
name|getdiskinfo
argument_list|(
name|fd
argument_list|,
name|fname
argument_list|,
name|dtype
argument_list|,
name|oflag
argument_list|,
operator|&
name|bpb
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bsec
operator|-=
operator|(
name|opt_ofs
operator|/
name|bpb
operator|.
name|bps
operator|)
expr_stmt|;
name|delta
operator|=
name|bpb
operator|.
name|bsec
operator|%
name|bpb
operator|.
name|spt
expr_stmt|;
if|if
condition|(
name|delta
operator|!=
literal|0
condition|)
block|{
name|warnx
argument_list|(
literal|"trim %d sectors to adjust to a multiple of %d"
argument_list|,
operator|(
name|int
operator|)
name|delta
argument_list|,
name|bpb
operator|.
name|spt
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bsec
operator|-=
name|delta
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|.
name|spc
operator|==
literal|0
condition|)
block|{
comment|/* set defaults */
if|if
condition|(
name|bpb
operator|.
name|bsec
operator|<=
literal|6000
condition|)
comment|/* about 3MB -> 512 bytes */
name|bpb
operator|.
name|spc
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bsec
operator|<=
operator|(
literal|1
operator|<<
literal|17
operator|)
condition|)
comment|/* 64M -> 4k */
name|bpb
operator|.
name|spc
operator|=
literal|8
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bsec
operator|<=
operator|(
literal|1
operator|<<
literal|19
operator|)
condition|)
comment|/* 256M -> 8k */
name|bpb
operator|.
name|spc
operator|=
literal|16
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bsec
operator|<=
operator|(
literal|1
operator|<<
literal|21
operator|)
condition|)
comment|/* 1G -> 16k */
name|bpb
operator|.
name|spc
operator|=
literal|32
expr_stmt|;
else|else
name|bpb
operator|.
name|spc
operator|=
literal|64
expr_stmt|;
comment|/* otherwise 32k */
block|}
block|}
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|bpb
operator|.
name|bps
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bytes/sector (%u) is not a power of 2"
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|bps
operator|<
name|MINBPS
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"bytes/sector (%u) is too small; minimum is %u"
argument_list|,
name|bpb
operator|.
name|bps
argument_list|,
name|MINBPS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fat
operator|=
name|opt_F
operator|)
condition|)
block|{
if|if
condition|(
name|opt_f
condition|)
name|fat
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|opt_e
operator|&&
operator|(
name|opt_i
operator|||
name|opt_k
operator|)
condition|)
name|fat
operator|=
literal|32
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fat
operator|==
literal|32
operator|&&
name|opt_e
operator|)
operator|||
operator|(
name|fat
operator|!=
literal|32
operator|&&
operator|(
name|opt_i
operator|||
name|opt_k
operator|)
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"-%c is not a legal FAT%s option"
argument_list|,
name|fat
operator|==
literal|32
condition|?
literal|'e'
else|:
name|opt_i
condition|?
literal|'i'
else|:
literal|'k'
argument_list|,
name|fat
operator|==
literal|32
condition|?
literal|"32"
else|:
literal|"12/16"
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_f
operator|&&
name|fat
operator|==
literal|32
condition|)
name|bpb
operator|.
name|rde
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|opt_b
condition|)
block|{
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|opt_b
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"block size (%u) is not a power of 2"
argument_list|,
name|opt_b
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_b
operator|<
name|bpb
operator|.
name|bps
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"block size (%u) is too small; minimum is %u"
argument_list|,
name|opt_b
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_b
operator|>
name|bpb
operator|.
name|bps
operator|*
name|MAXSPC
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"block size (%u) is too large; maximum is %u"
argument_list|,
name|opt_b
argument_list|,
name|bpb
operator|.
name|bps
operator|*
name|MAXSPC
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|spc
operator|=
name|opt_b
operator|/
name|bpb
operator|.
name|bps
expr_stmt|;
block|}
if|if
condition|(
name|opt_c
condition|)
block|{
if|if
condition|(
operator|!
name|powerof2
argument_list|(
name|opt_c
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"sectors/cluster (%u) is not a power of 2"
argument_list|,
name|opt_c
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|spc
operator|=
name|opt_c
expr_stmt|;
block|}
if|if
condition|(
name|opt_r
condition|)
name|bpb
operator|.
name|res
operator|=
name|opt_r
expr_stmt|;
if|if
condition|(
name|opt_n
condition|)
block|{
if|if
condition|(
name|opt_n
operator|>
name|MAXNFT
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"number of FATs (%u) is too large; maximum is %u"
argument_list|,
name|opt_n
argument_list|,
name|MAXNFT
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|nft
operator|=
name|opt_n
expr_stmt|;
block|}
if|if
condition|(
name|opt_e
condition|)
name|bpb
operator|.
name|rde
operator|=
name|opt_e
expr_stmt|;
if|if
condition|(
name|mflag
condition|)
block|{
if|if
condition|(
name|opt_m
operator|<
literal|0xf0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"illegal media descriptor (%#x)"
argument_list|,
name|opt_m
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|mid
operator|=
name|opt_m
expr_stmt|;
block|}
if|if
condition|(
name|opt_a
condition|)
name|bpb
operator|.
name|bspf
operator|=
name|opt_a
expr_stmt|;
if|if
condition|(
name|opt_i
condition|)
name|bpb
operator|.
name|infs
operator|=
name|opt_i
expr_stmt|;
if|if
condition|(
name|opt_k
condition|)
name|bpb
operator|.
name|bkbs
operator|=
name|opt_k
expr_stmt|;
name|bss
operator|=
literal|1
expr_stmt|;
name|bname
operator|=
name|NULL
expr_stmt|;
name|fd1
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|opt_B
condition|)
block|{
name|bname
operator|=
name|opt_B
expr_stmt|;
if|if
condition|(
operator|!
name|strchr
argument_list|(
name|bname
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"/boot/%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bname
operator|=
name|strdup
argument_list|(
name|buf
argument_list|)
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fd1
operator|=
name|open
argument_list|(
name|bname
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|||
name|fstat
argument_list|(
name|fd1
argument_list|,
operator|&
name|sb
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|S_ISREG
argument_list|(
name|sb
operator|.
name|st_mode
argument_list|)
operator|||
name|sb
operator|.
name|st_size
operator|%
name|bpb
operator|.
name|bps
operator|||
name|sb
operator|.
name|st_size
operator|<
name|bpb
operator|.
name|bps
operator|||
name|sb
operator|.
name|st_size
operator|>
name|bpb
operator|.
name|bps
operator|*
name|MAXU16
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: inappropriate file type or format"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
name|bss
operator|=
name|sb
operator|.
name|st_size
operator|/
name|bpb
operator|.
name|bps
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bpb
operator|.
name|nft
condition|)
name|bpb
operator|.
name|nft
operator|=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|fat
condition|)
block|{
if|if
condition|(
name|bpb
operator|.
name|bsec
operator|<
operator|(
name|bpb
operator|.
name|res
condition|?
name|bpb
operator|.
name|res
else|:
name|bss
operator|)
operator|+
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
operator|(
name|bpb
operator|.
name|spc
condition|?
name|MINCLS16
else|:
name|MAXCLS12
operator|+
literal|1
operator|)
operator|)
operator|*
operator|(
operator|(
name|bpb
operator|.
name|spc
condition|?
literal|16
else|:
literal|12
operator|)
operator|/
name|BPN
operator|)
argument_list|,
name|bpb
operator|.
name|bps
operator|*
name|NPB
argument_list|)
operator|*
name|bpb
operator|.
name|nft
operator|+
name|howmany
argument_list|(
name|bpb
operator|.
name|rde
condition|?
name|bpb
operator|.
name|rde
else|:
name|DEFRDE
argument_list|,
name|bpb
operator|.
name|bps
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|de
argument_list|)
argument_list|)
operator|+
operator|(
name|bpb
operator|.
name|spc
condition|?
name|MINCLS16
else|:
name|MAXCLS12
operator|+
literal|1
operator|)
operator|*
operator|(
name|bpb
operator|.
name|spc
condition|?
name|bpb
operator|.
name|spc
else|:
name|howmany
argument_list|(
name|DEFBLK
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
operator|)
condition|)
name|fat
operator|=
literal|12
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|rde
operator|||
name|bpb
operator|.
name|bsec
operator|<
operator|(
name|bpb
operator|.
name|res
condition|?
name|bpb
operator|.
name|res
else|:
name|bss
operator|)
operator|+
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
name|MAXCLS16
operator|)
operator|*
literal|2
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
operator|*
name|bpb
operator|.
name|nft
operator|+
name|howmany
argument_list|(
name|DEFRDE
argument_list|,
name|bpb
operator|.
name|bps
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|de
argument_list|)
argument_list|)
operator|+
operator|(
name|MAXCLS16
operator|+
literal|1
operator|)
operator|*
operator|(
name|bpb
operator|.
name|spc
condition|?
name|bpb
operator|.
name|spc
else|:
name|howmany
argument_list|(
literal|8192
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
operator|)
condition|)
name|fat
operator|=
literal|16
expr_stmt|;
else|else
name|fat
operator|=
literal|32
expr_stmt|;
block|}
name|x
operator|=
name|bss
expr_stmt|;
if|if
condition|(
name|fat
operator|==
literal|32
condition|)
block|{
if|if
condition|(
operator|!
name|bpb
operator|.
name|infs
condition|)
block|{
if|if
condition|(
name|x
operator|==
name|MAXU16
operator|||
name|x
operator|==
name|bpb
operator|.
name|bkbs
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no room for info sector"
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|infs
operator|=
name|x
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|.
name|infs
operator|!=
name|MAXU16
operator|&&
name|x
operator|<=
name|bpb
operator|.
name|infs
condition|)
name|x
operator|=
name|bpb
operator|.
name|infs
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|bkbs
condition|)
block|{
if|if
condition|(
name|x
operator|==
name|MAXU16
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"no room for backup sector"
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bkbs
operator|=
name|x
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bpb
operator|.
name|bkbs
operator|!=
name|MAXU16
operator|&&
name|bpb
operator|.
name|bkbs
operator|==
name|bpb
operator|.
name|infs
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"backup sector would overwrite info sector"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|bkbs
operator|!=
name|MAXU16
operator|&&
name|x
operator|<=
name|bpb
operator|.
name|bkbs
condition|)
name|x
operator|=
name|bpb
operator|.
name|bkbs
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bpb
operator|.
name|res
condition|)
name|bpb
operator|.
name|res
operator|=
name|fat
operator|==
literal|32
condition|?
name|MAX
argument_list|(
name|x
argument_list|,
name|MAX
argument_list|(
literal|16384
operator|/
name|bpb
operator|.
name|bps
argument_list|,
literal|4
argument_list|)
argument_list|)
else|:
name|x
expr_stmt|;
elseif|else
if|if
condition|(
name|bpb
operator|.
name|res
operator|<
name|x
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"too few reserved sectors"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fat
operator|!=
literal|32
operator|&&
operator|!
name|bpb
operator|.
name|rde
condition|)
name|bpb
operator|.
name|rde
operator|=
name|DEFRDE
expr_stmt|;
name|rds
operator|=
name|howmany
argument_list|(
name|bpb
operator|.
name|rde
argument_list|,
name|bpb
operator|.
name|bps
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|de
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|spc
condition|)
for|for
control|(
name|bpb
operator|.
name|spc
operator|=
name|howmany
argument_list|(
name|fat
operator|==
literal|16
condition|?
name|DEFBLK16
else|:
name|DEFBLK
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
init|;
name|bpb
operator|.
name|spc
operator|<
name|MAXSPC
operator|&&
name|bpb
operator|.
name|res
operator|+
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
name|maxcls
argument_list|(
name|fat
argument_list|)
operator|)
operator|*
operator|(
name|fat
operator|/
name|BPN
operator|)
argument_list|,
name|bpb
operator|.
name|bps
operator|*
name|NPB
argument_list|)
operator|*
name|bpb
operator|.
name|nft
operator|+
name|rds
operator|+
call|(
name|u_int64_t
call|)
argument_list|(
name|maxcls
argument_list|(
name|fat
argument_list|)
operator|+
literal|1
argument_list|)
operator|*
name|bpb
operator|.
name|spc
operator|<=
name|bpb
operator|.
name|bsec
condition|;
name|bpb
operator|.
name|spc
operator|<<=
literal|1
control|)
empty_stmt|;
if|if
condition|(
name|fat
operator|!=
literal|32
operator|&&
name|bpb
operator|.
name|bspf
operator|>
name|MAXU16
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"too many sectors/FAT for FAT12/16"
argument_list|)
expr_stmt|;
name|x1
operator|=
name|bpb
operator|.
name|res
operator|+
name|rds
expr_stmt|;
name|x
operator|=
name|bpb
operator|.
name|bspf
condition|?
name|bpb
operator|.
name|bspf
else|:
literal|1
expr_stmt|;
if|if
condition|(
name|x1
operator|+
operator|(
name|u_int64_t
operator|)
name|x
operator|*
name|bpb
operator|.
name|nft
operator|>
name|bpb
operator|.
name|bsec
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"meta data exceeds file system size"
argument_list|)
expr_stmt|;
name|x1
operator|+=
name|x
operator|*
name|bpb
operator|.
name|nft
expr_stmt|;
name|x
operator|=
call|(
name|u_int64_t
call|)
argument_list|(
name|bpb
operator|.
name|bsec
operator|-
name|x1
argument_list|)
operator|*
name|bpb
operator|.
name|bps
operator|*
name|NPB
operator|/
operator|(
name|bpb
operator|.
name|spc
operator|*
name|bpb
operator|.
name|bps
operator|*
name|NPB
operator|+
name|fat
operator|/
name|BPN
operator|*
name|bpb
operator|.
name|nft
operator|)
expr_stmt|;
name|x2
operator|=
name|howmany
argument_list|(
operator|(
name|RESFTE
operator|+
name|MIN
argument_list|(
name|x
argument_list|,
name|maxcls
argument_list|(
name|fat
argument_list|)
argument_list|)
operator|)
operator|*
operator|(
name|fat
operator|/
name|BPN
operator|)
argument_list|,
name|bpb
operator|.
name|bps
operator|*
name|NPB
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|bspf
condition|)
block|{
name|bpb
operator|.
name|bspf
operator|=
name|x2
expr_stmt|;
name|x1
operator|+=
operator|(
name|bpb
operator|.
name|bspf
operator|-
literal|1
operator|)
operator|*
name|bpb
operator|.
name|nft
expr_stmt|;
block|}
name|cls
operator|=
operator|(
name|bpb
operator|.
name|bsec
operator|-
name|x1
operator|)
operator|/
name|bpb
operator|.
name|spc
expr_stmt|;
name|x
operator|=
operator|(
name|u_int64_t
operator|)
name|bpb
operator|.
name|bspf
operator|*
name|bpb
operator|.
name|bps
operator|*
name|NPB
operator|/
operator|(
name|fat
operator|/
name|BPN
operator|)
operator|-
name|RESFTE
expr_stmt|;
if|if
condition|(
name|cls
operator|>
name|x
condition|)
name|cls
operator|=
name|x
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|bspf
operator|<
name|x2
condition|)
name|warnx
argument_list|(
literal|"warning: sectors/FAT limits file system to %u clusters"
argument_list|,
name|cls
argument_list|)
expr_stmt|;
if|if
condition|(
name|cls
operator|<
name|mincls
argument_list|(
name|fat
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%u clusters too few clusters for FAT%u, need %u"
argument_list|,
name|cls
argument_list|,
name|fat
argument_list|,
name|mincls
argument_list|(
name|fat
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cls
operator|>
name|maxcls
argument_list|(
name|fat
argument_list|)
condition|)
block|{
name|cls
operator|=
name|maxcls
argument_list|(
name|fat
argument_list|)
expr_stmt|;
name|bpb
operator|.
name|bsec
operator|=
name|x1
operator|+
operator|(
name|cls
operator|+
literal|1
operator|)
operator|*
name|bpb
operator|.
name|spc
operator|-
literal|1
expr_stmt|;
name|warnx
argument_list|(
literal|"warning: FAT type limits file system to %u sectors"
argument_list|,
name|bpb
operator|.
name|bsec
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: %u sector%s in %u FAT%u cluster%s "
literal|"(%u bytes/cluster)\n"
argument_list|,
name|fname
argument_list|,
name|cls
operator|*
name|bpb
operator|.
name|spc
argument_list|,
name|cls
operator|*
name|bpb
operator|.
name|spc
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|,
name|cls
argument_list|,
name|fat
argument_list|,
name|cls
operator|==
literal|1
condition|?
literal|""
else|:
literal|"s"
argument_list|,
name|bpb
operator|.
name|bps
operator|*
name|bpb
operator|.
name|spc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|.
name|mid
condition|)
name|bpb
operator|.
name|mid
operator|=
operator|!
name|bpb
operator|.
name|hid
condition|?
literal|0xf0
else|:
literal|0xf8
expr_stmt|;
if|if
condition|(
name|fat
operator|==
literal|32
condition|)
name|bpb
operator|.
name|rdcl
operator|=
name|RESFTE
expr_stmt|;
if|if
condition|(
name|bpb
operator|.
name|hid
operator|+
name|bpb
operator|.
name|bsec
operator|<=
name|MAXU16
condition|)
block|{
name|bpb
operator|.
name|sec
operator|=
name|bpb
operator|.
name|bsec
expr_stmt|;
name|bpb
operator|.
name|bsec
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|fat
operator|!=
literal|32
condition|)
block|{
name|bpb
operator|.
name|spf
operator|=
name|bpb
operator|.
name|bspf
expr_stmt|;
name|bpb
operator|.
name|bspf
operator|=
literal|0
expr_stmt|;
block|}
name|print_bpb
argument_list|(
operator|&
name|bpb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opt_N
condition|)
block|{
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|now
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
name|tm
operator|=
name|localtime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|img
operator|=
name|malloc
argument_list|(
name|bpb
operator|.
name|bps
argument_list|)
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dir
operator|=
name|bpb
operator|.
name|res
operator|+
operator|(
name|bpb
operator|.
name|spf
condition|?
name|bpb
operator|.
name|spf
else|:
name|bpb
operator|.
name|bspf
operator|)
operator|*
name|bpb
operator|.
name|nft
expr_stmt|;
for|for
control|(
name|lsn
operator|=
literal|0
init|;
name|lsn
operator|<
name|dir
operator|+
operator|(
name|fat
operator|==
literal|32
condition|?
name|bpb
operator|.
name|spc
else|:
name|rds
operator|)
condition|;
name|lsn
operator|++
control|)
block|{
name|x
operator|=
name|lsn
expr_stmt|;
if|if
condition|(
name|opt_B
operator|&&
name|fat
operator|==
literal|32
operator|&&
name|bpb
operator|.
name|bkbs
operator|!=
name|MAXU16
operator|&&
name|bss
operator|<=
name|bpb
operator|.
name|bkbs
operator|&&
name|x
operator|>=
name|bpb
operator|.
name|bkbs
condition|)
block|{
name|x
operator|-=
name|bpb
operator|.
name|bkbs
expr_stmt|;
if|if
condition|(
operator|!
name|x
operator|&&
name|lseek
argument_list|(
name|fd1
argument_list|,
name|opt_ofs
argument_list|,
name|SEEK_SET
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opt_B
operator|&&
name|x
operator|<
name|bss
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|fd1
argument_list|,
name|img
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|bname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unsigned
operator|)
name|n
operator|!=
name|bpb
operator|.
name|bps
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: can't read sector %u"
argument_list|,
name|bname
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
else|else
name|memset
argument_list|(
name|img
argument_list|,
literal|0
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lsn
operator|||
operator|(
name|fat
operator|==
literal|32
operator|&&
name|bpb
operator|.
name|bkbs
operator|!=
name|MAXU16
operator|&&
name|lsn
operator|==
name|bpb
operator|.
name|bkbs
operator|)
condition|)
block|{
name|x1
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|bs
argument_list|)
expr_stmt|;
name|bsbpb
operator|=
operator|(
expr|struct
name|bsbpb
operator|*
operator|)
operator|(
name|img
operator|+
name|x1
operator|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|bps
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bsbpb
operator|->
name|spc
argument_list|,
name|bpb
operator|.
name|spc
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|res
argument_list|,
name|bpb
operator|.
name|res
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bsbpb
operator|->
name|nft
argument_list|,
name|bpb
operator|.
name|nft
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|rde
argument_list|,
name|bpb
operator|.
name|rde
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|sec
argument_list|,
name|bpb
operator|.
name|sec
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bsbpb
operator|->
name|mid
argument_list|,
name|bpb
operator|.
name|mid
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|spf
argument_list|,
name|bpb
operator|.
name|spf
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|spt
argument_list|,
name|bpb
operator|.
name|spt
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsbpb
operator|->
name|hds
argument_list|,
name|bpb
operator|.
name|hds
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|bsbpb
operator|->
name|hid
argument_list|,
name|bpb
operator|.
name|hid
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|bsbpb
operator|->
name|bsec
argument_list|,
name|bpb
operator|.
name|bsec
argument_list|)
expr_stmt|;
name|x1
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|bsbpb
argument_list|)
expr_stmt|;
if|if
condition|(
name|fat
operator|==
literal|32
condition|)
block|{
name|bsxbpb
operator|=
operator|(
expr|struct
name|bsxbpb
operator|*
operator|)
operator|(
name|img
operator|+
name|x1
operator|)
expr_stmt|;
name|mk4
argument_list|(
name|bsxbpb
operator|->
name|bspf
argument_list|,
name|bpb
operator|.
name|bspf
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|xflg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|vers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|bsxbpb
operator|->
name|rdcl
argument_list|,
name|bpb
operator|.
name|rdcl
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|infs
argument_list|,
name|bpb
operator|.
name|infs
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|bsxbpb
operator|->
name|bkbs
argument_list|,
name|bpb
operator|.
name|bkbs
argument_list|)
expr_stmt|;
name|x1
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|bsxbpb
argument_list|)
expr_stmt|;
block|}
name|bsx
operator|=
operator|(
expr|struct
name|bsx
operator|*
operator|)
operator|(
name|img
operator|+
name|x1
operator|)
expr_stmt|;
name|mk1
argument_list|(
name|bsx
operator|->
name|sig
argument_list|,
literal|0x29
argument_list|)
expr_stmt|;
if|if
condition|(
name|Iflag
condition|)
name|x
operator|=
name|opt_I
expr_stmt|;
else|else
name|x
operator|=
operator|(
operator|(
call|(
name|u_int
call|)
argument_list|(
literal|1
operator|+
name|tm
operator|->
name|tm_mon
argument_list|)
operator|<<
literal|8
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_mday
operator|)
operator|+
operator|(
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_sec
operator|<<
literal|8
operator||
call|(
name|u_int
call|)
argument_list|(
name|tv
operator|.
name|tv_usec
operator|/
literal|10
argument_list|)
operator|)
operator|)
operator|<<
literal|16
operator||
operator|(
call|(
name|u_int
call|)
argument_list|(
literal|1900
operator|+
name|tm
operator|->
name|tm_year
argument_list|)
operator|+
operator|(
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_hour
operator|<<
literal|8
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_min
operator|)
operator|)
expr_stmt|;
name|mk4
argument_list|(
name|bsx
operator|->
name|volid
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|mklabel
argument_list|(
name|bsx
operator|->
name|label
argument_list|,
name|opt_L
condition|?
name|opt_L
else|:
literal|"NO NAME"
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"FAT%u"
argument_list|,
name|fat
argument_list|)
expr_stmt|;
name|setstr
argument_list|(
name|bsx
operator|->
name|type
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|bsx
operator|->
name|type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opt_B
condition|)
block|{
name|x1
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|bsx
argument_list|)
expr_stmt|;
name|bs
operator|=
operator|(
expr|struct
name|bs
operator|*
operator|)
name|img
expr_stmt|;
name|mk1
argument_list|(
name|bs
operator|->
name|jmp
index|[
literal|0
index|]
argument_list|,
literal|0xeb
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bs
operator|->
name|jmp
index|[
literal|1
index|]
argument_list|,
name|x1
operator|-
literal|2
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|bs
operator|->
name|jmp
index|[
literal|2
index|]
argument_list|,
literal|0x90
argument_list|)
expr_stmt|;
name|setstr
argument_list|(
name|bs
operator|->
name|oem
argument_list|,
name|opt_O
condition|?
name|opt_O
else|:
literal|"BSD  4.4"
argument_list|,
sizeof|sizeof
argument_list|(
name|bs
operator|->
name|oem
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|img
operator|+
name|x1
argument_list|,
name|bootcode
argument_list|,
sizeof|sizeof
argument_list|(
name|bootcode
argument_list|)
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|2
argument_list|,
name|DOSMAGIC
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|fat
operator|==
literal|32
operator|&&
name|bpb
operator|.
name|infs
operator|!=
name|MAXU16
operator|&&
operator|(
name|lsn
operator|==
name|bpb
operator|.
name|infs
operator|||
operator|(
name|bpb
operator|.
name|bkbs
operator|!=
name|MAXU16
operator|&&
name|lsn
operator|==
name|bpb
operator|.
name|bkbs
operator|+
name|bpb
operator|.
name|infs
operator|)
operator|)
condition|)
block|{
name|mk4
argument_list|(
name|img
argument_list|,
literal|0x41615252
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|28
argument_list|,
literal|0x61417272
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|24
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|mk4
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|20
argument_list|,
name|bpb
operator|.
name|rdcl
argument_list|)
expr_stmt|;
name|mk2
argument_list|(
name|img
operator|+
name|MINBPS
operator|-
literal|2
argument_list|,
name|DOSMAGIC
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lsn
operator|>=
name|bpb
operator|.
name|res
operator|&&
name|lsn
operator|<
name|dir
operator|&&
operator|!
operator|(
operator|(
name|lsn
operator|-
name|bpb
operator|.
name|res
operator|)
operator|%
operator|(
name|bpb
operator|.
name|spf
condition|?
name|bpb
operator|.
name|spf
else|:
name|bpb
operator|.
name|bspf
operator|)
operator|)
condition|)
block|{
name|mk1
argument_list|(
name|img
index|[
literal|0
index|]
argument_list|,
name|bpb
operator|.
name|mid
argument_list|)
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|1
init|;
name|x
operator|<
name|fat
operator|*
operator|(
name|fat
operator|==
literal|32
condition|?
literal|3
else|:
literal|2
operator|)
operator|/
literal|8
condition|;
name|x
operator|++
control|)
name|mk1
argument_list|(
name|img
index|[
name|x
index|]
argument_list|,
name|fat
operator|==
literal|32
operator|&&
name|x
operator|%
literal|4
operator|==
literal|3
condition|?
literal|0x0f
else|:
literal|0xff
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|lsn
operator|==
name|dir
operator|&&
name|opt_L
condition|)
block|{
name|de
operator|=
operator|(
expr|struct
name|de
operator|*
operator|)
name|img
expr_stmt|;
name|mklabel
argument_list|(
name|de
operator|->
name|namext
argument_list|,
name|opt_L
argument_list|)
expr_stmt|;
name|mk1
argument_list|(
name|de
operator|->
name|attr
argument_list|,
literal|050
argument_list|)
expr_stmt|;
name|x
operator|=
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_hour
operator|<<
literal|11
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_min
operator|<<
literal|5
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_sec
operator|>>
literal|1
expr_stmt|;
name|mk2
argument_list|(
name|de
operator|->
name|time
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|x
operator|=
call|(
name|u_int
call|)
argument_list|(
name|tm
operator|->
name|tm_year
operator|-
literal|80
argument_list|)
operator|<<
literal|9
operator||
call|(
name|u_int
call|)
argument_list|(
name|tm
operator|->
name|tm_mon
operator|+
literal|1
argument_list|)
operator|<<
literal|5
operator||
operator|(
name|u_int
operator|)
name|tm
operator|->
name|tm_mday
expr_stmt|;
name|mk2
argument_list|(
name|de
operator|->
name|date
argument_list|,
name|x
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|n
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|img
argument_list|,
name|bpb
operator|.
name|bps
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"%s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unsigned
operator|)
name|n
operator|!=
name|bpb
operator|.
name|bps
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: can't write sector %u"
argument_list|,
name|fname
argument_list|,
name|lsn
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Exit with error if file system is mounted.  */
end_comment

begin_function
specifier|static
name|void
name|check_mounted
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|mode_t
name|mode
parameter_list|)
block|{
name|struct
name|statfs
modifier|*
name|mp
decl_stmt|;
specifier|const
name|char
modifier|*
name|s1
decl_stmt|,
modifier|*
name|s2
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|n
decl_stmt|,
name|r
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|n
operator|=
name|getmntinfo
argument_list|(
operator|&
name|mp
argument_list|,
name|MNT_NOWAIT
argument_list|)
operator|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"getmntinfo"
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|_PATH_DEV
argument_list|)
expr_stmt|;
name|s1
operator|=
name|fname
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|s1
argument_list|,
name|_PATH_DEV
argument_list|,
name|len
argument_list|)
condition|)
name|s1
operator|+=
name|len
expr_stmt|;
name|r
operator|=
name|S_ISCHR
argument_list|(
name|mode
argument_list|)
operator|&&
name|s1
operator|!=
name|fname
operator|&&
operator|*
name|s1
operator|==
literal|'r'
expr_stmt|;
for|for
control|(
init|;
name|n
operator|--
condition|;
name|mp
operator|++
control|)
block|{
name|s2
operator|=
name|mp
operator|->
name|f_mntfromname
expr_stmt|;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|s2
argument_list|,
name|_PATH_DEV
argument_list|,
name|len
argument_list|)
condition|)
name|s2
operator|+=
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|&&
name|s2
operator|!=
name|mp
operator|->
name|f_mntfromname
operator|&&
operator|!
name|strcmp
argument_list|(
name|s1
operator|+
literal|1
argument_list|,
name|s2
argument_list|)
operator|)
operator|||
operator|!
name|strcmp
argument_list|(
name|s1
argument_list|,
name|s2
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s is mounted on %s"
argument_list|,
name|fname
argument_list|,
name|mp
operator|->
name|f_mntonname
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Get a standard format.  */
end_comment

begin_function
specifier|static
name|void
name|getstdfmt
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
name|struct
name|bpb
modifier|*
name|bpb
parameter_list|)
block|{
name|u_int
name|x
decl_stmt|,
name|i
decl_stmt|;
name|x
operator|=
sizeof|sizeof
argument_list|(
name|stdfmt
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|stdfmt
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|x
operator|&&
name|strcmp
argument_list|(
name|fmt
argument_list|,
name|stdfmt
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|i
operator|==
name|x
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: unknown standard format"
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
operator|*
name|bpb
operator|=
name|stdfmt
index|[
name|i
index|]
operator|.
name|bpb
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get disk slice, partition, and geometry information.  */
end_comment

begin_function
specifier|static
name|void
name|getdiskinfo
parameter_list|(
name|int
name|fd
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
specifier|const
name|char
modifier|*
name|dtype
parameter_list|,
name|__unused
name|int
name|oflag
parameter_list|,
name|struct
name|bpb
modifier|*
name|bpb
parameter_list|)
block|{
name|struct
name|disklabel
modifier|*
name|lp
decl_stmt|,
name|dlp
decl_stmt|;
name|struct
name|fd_type
name|type
decl_stmt|;
name|off_t
name|ms
decl_stmt|,
name|hs
init|=
literal|0
decl_stmt|;
name|lp
operator|=
name|NULL
expr_stmt|;
comment|/* If the user specified a disk type, try to use that */
if|if
condition|(
name|dtype
operator|!=
name|NULL
condition|)
block|{
name|lp
operator|=
name|getdiskbyname
argument_list|(
name|dtype
argument_list|)
expr_stmt|;
block|}
comment|/* Maybe it's a floppy drive */
if|if
condition|(
name|lp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGMEDIASIZE
argument_list|,
operator|&
name|ms
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
if|if
condition|(
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|st
argument_list|)
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"Cannot get disk size"
argument_list|)
expr_stmt|;
comment|/* create a fake geometry for a file image */
name|ms
operator|=
name|st
operator|.
name|st_size
expr_stmt|;
name|dlp
operator|.
name|d_secsize
operator|=
literal|512
expr_stmt|;
name|dlp
operator|.
name|d_nsectors
operator|=
literal|63
expr_stmt|;
name|dlp
operator|.
name|d_ntracks
operator|=
literal|255
expr_stmt|;
name|dlp
operator|.
name|d_secperunit
operator|=
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
expr_stmt|;
name|lp
operator|=
operator|&
name|dlp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|FD_GTYPE
argument_list|,
operator|&
name|type
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|dlp
operator|.
name|d_secsize
operator|=
literal|128
operator|<<
name|type
operator|.
name|secsize
expr_stmt|;
name|dlp
operator|.
name|d_nsectors
operator|=
name|type
operator|.
name|sectrac
expr_stmt|;
name|dlp
operator|.
name|d_ntracks
operator|=
name|type
operator|.
name|heads
expr_stmt|;
name|dlp
operator|.
name|d_secperunit
operator|=
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
expr_stmt|;
name|lp
operator|=
operator|&
name|dlp
expr_stmt|;
block|}
block|}
comment|/* Maybe it's a fixed drive */
if|if
condition|(
name|lp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGDINFO
argument_list|,
operator|&
name|dlp
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|bpb
operator|->
name|bps
operator|==
literal|0
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGSECTORSIZE
argument_list|,
operator|&
name|dlp
operator|.
name|d_secsize
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Cannot get sector size, %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX Should we use bpb->bps if it's set? */
name|dlp
operator|.
name|d_secperunit
operator|=
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|spt
operator|==
literal|0
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGFWSECTORS
argument_list|,
operator|&
name|dlp
operator|.
name|d_nsectors
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"Cannot get number of sectors per track, %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|dlp
operator|.
name|d_nsectors
operator|=
literal|63
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|hds
operator|==
literal|0
operator|&&
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGFWHEADS
argument_list|,
operator|&
name|dlp
operator|.
name|d_ntracks
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|warnx
argument_list|(
literal|"Cannot get number of heads, %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlp
operator|.
name|d_secperunit
operator|<=
literal|63
operator|*
literal|1
operator|*
literal|1024
condition|)
name|dlp
operator|.
name|d_ntracks
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|dlp
operator|.
name|d_secperunit
operator|<=
literal|63
operator|*
literal|16
operator|*
literal|1024
condition|)
name|dlp
operator|.
name|d_ntracks
operator|=
literal|16
expr_stmt|;
else|else
name|dlp
operator|.
name|d_ntracks
operator|=
literal|255
expr_stmt|;
block|}
block|}
name|hs
operator|=
operator|(
name|ms
operator|/
name|dlp
operator|.
name|d_secsize
operator|)
operator|-
name|dlp
operator|.
name|d_secperunit
expr_stmt|;
name|lp
operator|=
operator|&
name|dlp
expr_stmt|;
block|}
if|if
condition|(
name|bpb
operator|->
name|bps
operator|==
literal|0
condition|)
name|bpb
operator|->
name|bps
operator|=
name|ckgeom
argument_list|(
name|fname
argument_list|,
name|lp
operator|->
name|d_secsize
argument_list|,
literal|"bytes/sector"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|spt
operator|==
literal|0
condition|)
name|bpb
operator|->
name|spt
operator|=
name|ckgeom
argument_list|(
name|fname
argument_list|,
name|lp
operator|->
name|d_nsectors
argument_list|,
literal|"sectors/track"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|hds
operator|==
literal|0
condition|)
name|bpb
operator|->
name|hds
operator|=
name|ckgeom
argument_list|(
name|fname
argument_list|,
name|lp
operator|->
name|d_ntracks
argument_list|,
literal|"drive heads"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bsec
operator|==
literal|0
condition|)
name|bpb
operator|->
name|bsec
operator|=
name|lp
operator|->
name|d_secperunit
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|hid
operator|==
literal|0
condition|)
name|bpb
operator|->
name|hid
operator|=
name|hs
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print out BPB values.  */
end_comment

begin_function
specifier|static
name|void
name|print_bpb
parameter_list|(
name|struct
name|bpb
modifier|*
name|bpb
parameter_list|)
block|{
name|printf
argument_list|(
literal|"bps=%u spc=%u res=%u nft=%u"
argument_list|,
name|bpb
operator|->
name|bps
argument_list|,
name|bpb
operator|->
name|spc
argument_list|,
name|bpb
operator|->
name|res
argument_list|,
name|bpb
operator|->
name|nft
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|rde
condition|)
name|printf
argument_list|(
literal|" rde=%u"
argument_list|,
name|bpb
operator|->
name|rde
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|sec
condition|)
name|printf
argument_list|(
literal|" sec=%u"
argument_list|,
name|bpb
operator|->
name|sec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" mid=%#x"
argument_list|,
name|bpb
operator|->
name|mid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|spf
condition|)
name|printf
argument_list|(
literal|" spf=%u"
argument_list|,
name|bpb
operator|->
name|spf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" spt=%u hds=%u hid=%u"
argument_list|,
name|bpb
operator|->
name|spt
argument_list|,
name|bpb
operator|->
name|hds
argument_list|,
name|bpb
operator|->
name|hid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bpb
operator|->
name|bsec
condition|)
name|printf
argument_list|(
literal|" bsec=%u"
argument_list|,
name|bpb
operator|->
name|bsec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bpb
operator|->
name|spf
condition|)
block|{
name|printf
argument_list|(
literal|" bspf=%u rdcl=%u"
argument_list|,
name|bpb
operator|->
name|bspf
argument_list|,
name|bpb
operator|->
name|rdcl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" infs="
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|bpb
operator|->
name|infs
operator|==
name|MAXU16
condition|?
literal|"%#x"
else|:
literal|"%u"
argument_list|,
name|bpb
operator|->
name|infs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" bkbs="
argument_list|)
expr_stmt|;
name|printf
argument_list|(
name|bpb
operator|->
name|bkbs
operator|==
name|MAXU16
condition|?
literal|"%#x"
else|:
literal|"%u"
argument_list|,
name|bpb
operator|->
name|bkbs
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Check a disk geometry value.  */
end_comment

begin_function
specifier|static
name|u_int
name|ckgeom
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|u_int
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|val
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: no default %s"
argument_list|,
name|fname
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>
name|MAXU16
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: illegal %s %d"
argument_list|,
name|fname
argument_list|,
name|msg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_comment
comment|/*  * Convert and check a numeric option argument.  */
end_comment

begin_function
specifier|static
name|u_int
name|argtou
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|u_int
name|lo
parameter_list|,
name|u_int
name|hi
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|u_long
name|x
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|x
operator|=
name|strtoul
argument_list|(
name|arg
argument_list|,
operator|&
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|||
operator|!
operator|*
name|arg
operator|||
operator|*
name|s
operator|||
name|x
operator|<
name|lo
operator|||
name|x
operator|>
name|hi
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: bad %s"
argument_list|,
name|arg
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
name|x
return|;
block|}
end_function

begin_comment
comment|/*  * Same for off_t, with optional skmgpP suffix  */
end_comment

begin_function
specifier|static
name|off_t
name|argtooff
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|off_t
name|x
decl_stmt|;
name|x
operator|=
name|strtoll
argument_list|(
name|arg
argument_list|,
operator|&
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* allow at most one extra char */
if|if
condition|(
name|errno
operator|||
name|x
operator|<
literal|0
operator|||
operator|(
name|s
index|[
literal|0
index|]
operator|&&
name|s
index|[
literal|1
index|]
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: bad %s"
argument_list|,
name|arg
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|s
condition|)
block|{
comment|/* the extra char is the multiplier */
switch|switch
condition|(
operator|*
name|s
condition|)
block|{
default|default:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: bad %s"
argument_list|,
name|arg
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* notreached */
case|case
literal|'s'
case|:
comment|/* sector */
case|case
literal|'S'
case|:
name|x
operator|<<=
literal|9
expr_stmt|;
comment|/* times 512 */
break|break;
case|case
literal|'k'
case|:
comment|/* kilobyte */
case|case
literal|'K'
case|:
name|x
operator|<<=
literal|10
expr_stmt|;
comment|/* times 1024 */
break|break;
case|case
literal|'m'
case|:
comment|/* megabyte */
case|case
literal|'M'
case|:
name|x
operator|<<=
literal|20
expr_stmt|;
comment|/* times 1024*1024 */
break|break;
case|case
literal|'g'
case|:
comment|/* gigabyte */
case|case
literal|'G'
case|:
name|x
operator|<<=
literal|30
expr_stmt|;
comment|/* times 1024*1024*1024 */
break|break;
case|case
literal|'p'
case|:
comment|/* partition start */
case|case
literal|'P'
case|:
comment|/* partition start */
case|case
literal|'l'
case|:
comment|/* partition length */
case|case
literal|'L'
case|:
comment|/* partition length */
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: not supported yet %s"
argument_list|,
name|arg
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* notreached */
block|}
block|}
return|return
name|x
return|;
block|}
end_function

begin_comment
comment|/*  * Check a volume label.  */
end_comment

begin_function
specifier|static
name|int
name|oklabel
parameter_list|(
specifier|const
name|char
modifier|*
name|src
parameter_list|)
block|{
name|int
name|c
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|(
name|u_char
operator|)
operator|*
name|src
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|' '
operator|+
operator|!
name|i
operator|||
name|strchr
argument_list|(
literal|"\"*+,./:;<=>?[\\]|"
argument_list|,
name|c
argument_list|)
condition|)
break|break;
block|}
return|return
name|i
operator|&&
operator|!
name|c
return|;
block|}
end_function

begin_comment
comment|/*  * Make a volume label.  */
end_comment

begin_function
specifier|static
name|void
name|mklabel
parameter_list|(
name|u_int8_t
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|)
block|{
name|int
name|c
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|*
name|src
condition|?
name|toupper
argument_list|(
operator|*
name|src
operator|++
argument_list|)
else|:
literal|' '
expr_stmt|;
operator|*
name|dest
operator|++
operator|=
operator|!
name|i
operator|&&
name|c
operator|==
literal|'\xe5'
condition|?
literal|5
else|:
name|c
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Copy string, padding with spaces.  */
end_comment

begin_function
specifier|static
name|void
name|setstr
parameter_list|(
name|u_int8_t
modifier|*
name|dest
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
condition|)
operator|*
name|dest
operator|++
operator|=
operator|*
name|src
condition|?
operator|*
name|src
operator|++
else|:
literal|' '
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Print usage message.  */
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage: newfs_msdos [ -options ] special [disktype]\n"
literal|"where the options are:\n"
literal|"\t-@ create file system at specified offset\n"
literal|"\t-B get bootstrap from file\n"
literal|"\t-C create image file with specified size\n"
literal|"\t-F FAT type (12, 16, or 32)\n"
literal|"\t-I volume ID\n"
literal|"\t-L volume label\n"
literal|"\t-N don't create file system: just print out parameters\n"
literal|"\t-O OEM string\n"
literal|"\t-S bytes/sector\n"
literal|"\t-a sectors/FAT\n"
literal|"\t-b block size\n"
literal|"\t-c sectors/cluster\n"
literal|"\t-e root directory entries\n"
literal|"\t-f standard format\n"
literal|"\t-h drive heads\n"
literal|"\t-i file system info sector\n"
literal|"\t-k backup boot sector\n"
literal|"\t-m media descriptor\n"
literal|"\t-n number of FATs\n"
literal|"\t-o hidden sectors\n"
literal|"\t-r reserved sectors\n"
literal|"\t-s file system size (sectors)\n"
literal|"\t-u sectors/track\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


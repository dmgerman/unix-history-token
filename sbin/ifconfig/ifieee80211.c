begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2001 The Aerospace Corporation.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of The Aerospace Corporation may not be used to endorse or  *    promote products derived from this software.  *  * THIS SOFTWARE IS PROVIDED BY THE AEROSPACE CORPORATION ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AEROSPACE CORPORATION BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1997, 1998, 2000 The NetBSD Foundation, Inc.  * All rights reserved.  *  * This code is derived from software contributed to The NetBSD Foundation  * by Jason R. Thorpe of the Numerical Aerospace Simulation Facility,  * NASA Ames Research Center.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by the NetBSD  *	Foundation, Inc. and its contributors.  * 4. Neither the name of The NetBSD Foundation nor the names of its  *    contributors may be used to endorse or promote products derived  *    from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS  * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_crypto.h>
end_include

begin_include
include|#
directive|include
file|<net80211/ieee80211_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<inttypes.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|"ifconfig.h"
end_include

begin_function_decl
specifier|static
name|void
name|set80211
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|val
parameter_list|,
name|int
name|len
parameter_list|,
name|u_int8_t
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|const
name|char
modifier|*
name|get_string
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|sep
parameter_list|,
name|u_int8_t
modifier|*
name|buf
parameter_list|,
name|int
modifier|*
name|lenp
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_string
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|isanyarg
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
return|return
operator|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"any"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211ssid
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|ssid
decl_stmt|;
name|int
name|len
decl_stmt|;
name|u_int8_t
name|data
index|[
name|IEEE80211_NWID_LEN
index|]
decl_stmt|;
name|ssid
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|2
operator|&&
name|isdigit
argument_list|(
name|val
index|[
literal|0
index|]
argument_list|)
operator|&&
name|val
index|[
literal|1
index|]
operator|==
literal|':'
condition|)
block|{
name|ssid
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
operator|-
literal|1
expr_stmt|;
name|val
operator|+=
literal|2
expr_stmt|;
block|}
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_string
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
name|data
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_SSID
argument_list|,
name|ssid
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211stationname
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|u_int8_t
name|data
index|[
literal|33
index|]
decl_stmt|;
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|get_string
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
name|data
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_STATIONNAME
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert IEEE channel number to MHz frequency.  */
end_comment

begin_function
specifier|static
name|u_int
name|ieee80211_ieee2mhz
parameter_list|(
name|u_int
name|chan
parameter_list|)
block|{
if|if
condition|(
name|chan
operator|==
literal|14
condition|)
return|return
literal|2484
return|;
if|if
condition|(
name|chan
operator|<
literal|14
condition|)
comment|/* 0-13 */
return|return
literal|2407
operator|+
name|chan
operator|*
literal|5
return|;
if|if
condition|(
name|chan
operator|<
literal|27
condition|)
comment|/* 15-26 */
return|return
literal|2512
operator|+
operator|(
operator|(
name|chan
operator|-
literal|15
operator|)
operator|*
literal|20
operator|)
return|;
return|return
literal|5000
operator|+
operator|(
name|chan
operator|*
literal|5
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|mapgsm
parameter_list|(
name|u_int
name|freq
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|freq
operator|*=
literal|10
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|IEEE80211_CHAN_QUARTER
condition|)
name|freq
operator|+=
literal|5
expr_stmt|;
elseif|else
if|if
condition|(
name|flags
operator|&
name|IEEE80211_CHAN_HALF
condition|)
name|freq
operator|+=
literal|10
expr_stmt|;
else|else
name|freq
operator|+=
literal|20
expr_stmt|;
comment|/* NB: there is no 907/20 wide but leave room */
return|return
operator|(
name|freq
operator|-
literal|906
operator|*
literal|10
operator|)
operator|/
literal|5
return|;
block|}
end_function

begin_function
specifier|static
name|__inline
name|int
name|mappsb
parameter_list|(
name|u_int
name|freq
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
return|return
literal|37
operator|+
operator|(
operator|(
name|freq
operator|*
literal|10
operator|)
operator|+
operator|(
operator|(
name|freq
operator|%
literal|5
operator|)
operator|==
literal|2
condition|?
literal|5
else|:
literal|0
operator|)
operator|-
literal|49400
operator|)
operator|/
literal|5
return|;
block|}
end_function

begin_comment
comment|/*  * Convert MHz frequency to IEEE channel number.  */
end_comment

begin_function
specifier|static
name|u_int
name|ieee80211_mhz2ieee
parameter_list|(
name|u_int
name|freq
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
if|if
condition|(
operator|(
name|flags
operator|&
name|IEEE80211_CHAN_GSM
operator|)
operator|||
operator|(
literal|907
operator|<=
name|freq
operator|&&
name|freq
operator|<=
literal|922
operator|)
condition|)
return|return
name|mapgsm
argument_list|(
name|freq
argument_list|,
name|flags
argument_list|)
return|;
if|if
condition|(
name|freq
operator|==
literal|2484
condition|)
return|return
literal|14
return|;
if|if
condition|(
name|freq
operator|<
literal|2484
condition|)
return|return
operator|(
name|freq
operator|-
literal|2407
operator|)
operator|/
literal|5
return|;
if|if
condition|(
name|freq
operator|<
literal|5000
condition|)
block|{
if|if
condition|(
name|flags
operator|&
operator|(
name|IEEE80211_CHAN_HALF
operator||
name|IEEE80211_CHAN_QUARTER
operator|)
condition|)
return|return
name|mappsb
argument_list|(
name|freq
argument_list|,
name|flags
argument_list|)
return|;
elseif|else
if|if
condition|(
name|freq
operator|>
literal|4900
condition|)
return|return
operator|(
name|freq
operator|-
literal|4000
operator|)
operator|/
literal|5
return|;
else|else
return|return
literal|15
operator|+
operator|(
operator|(
name|freq
operator|-
literal|2512
operator|)
operator|/
literal|20
operator|)
return|;
block|}
return|return
operator|(
name|freq
operator|-
literal|5000
operator|)
operator|/
literal|5
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211channel
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|isanyarg
argument_list|(
name|val
argument_list|)
condition|)
block|{
name|int
name|v
init|=
name|atoi
argument_list|(
name|val
argument_list|)
decl_stmt|;
if|if
condition|(
name|v
operator|>
literal|255
condition|)
comment|/* treat as frequency */
name|v
operator|=
name|ieee80211_mhz2ieee
argument_list|(
name|v
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_CHANNEL
argument_list|,
name|v
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_CHANNEL
argument_list|,
name|IEEE80211_CHAN_ANY
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211authmode
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_AUTH_NONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"open"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_AUTH_OPEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"shared"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_AUTH_SHARED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"8021x"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_AUTH_8021X
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"wpa"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_AUTH_WPA
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown authmode"
argument_list|)
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_AUTHMODE
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211powersavemode
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_POWERSAVE_OFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_POWERSAVE_ON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"cam"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_POWERSAVE_CAM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"psp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_POWERSAVE_PSP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"psp-cam"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_POWERSAVE_PSP_CAM
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown powersavemode"
argument_list|)
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_POWERSAVE
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211powersave
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
if|if
condition|(
name|d
operator|==
literal|0
condition|)
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_POWERSAVE
argument_list|,
name|IEEE80211_POWERSAVE_OFF
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_POWERSAVE
argument_list|,
name|IEEE80211_POWERSAVE_ON
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211powersavesleep
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_POWERSAVESLEEP
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211wepmode
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_WEP_OFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_WEP_ON
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"mixed"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_WEP_MIXED
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown wep mode"
argument_list|)
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEP
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211wep
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEP
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|isundefarg
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
return|return
operator|(
name|strcmp
argument_list|(
name|arg
argument_list|,
literal|"-"
argument_list|)
operator|==
literal|0
operator|||
name|strncasecmp
argument_list|(
name|arg
argument_list|,
literal|"undef"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211weptxkey
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
if|if
condition|(
name|isundefarg
argument_list|(
name|val
argument_list|)
condition|)
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPTXKEY
argument_list|,
name|IEEE80211_KEYIX_NONE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPTXKEY
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211wepkey
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|key
init|=
literal|0
decl_stmt|;
name|int
name|len
decl_stmt|;
name|u_int8_t
name|data
index|[
name|IEEE80211_KEYBUF_SIZE
index|]
decl_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
name|val
index|[
literal|0
index|]
argument_list|)
operator|&&
name|val
index|[
literal|1
index|]
operator|==
literal|':'
condition|)
block|{
name|key
operator|=
name|atoi
argument_list|(
name|val
argument_list|)
operator|-
literal|1
expr_stmt|;
name|val
operator|+=
literal|2
expr_stmt|;
block|}
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|get_string
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
name|data
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPKEY
argument_list|,
name|key
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This function is purely a NetBSD compatability interface.  The NetBSD  * interface is too inflexible, but it's there so we'll support it since  * it's not all that hard.  */
end_comment

begin_function
specifier|static
name|void
name|set80211nwkey
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|txkey
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|;
name|u_int8_t
name|data
index|[
name|IEEE80211_KEYBUF_SIZE
index|]
decl_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEP
argument_list|,
name|IEEE80211_WEP_ON
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|isdigit
argument_list|(
name|val
index|[
literal|0
index|]
argument_list|)
operator|&&
name|val
index|[
literal|1
index|]
operator|==
literal|':'
condition|)
block|{
name|txkey
operator|=
name|val
index|[
literal|0
index|]
operator|-
literal|'0'
operator|-
literal|1
expr_stmt|;
name|val
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|val
operator|=
name|get_string
argument_list|(
name|val
argument_list|,
literal|","
argument_list|,
name|data
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPKEY
argument_list|,
name|i
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|get_string
argument_list|(
name|val
argument_list|,
name|NULL
argument_list|,
name|data
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|txkey
operator|=
literal|0
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPKEY
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPKEY
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WEPTXKEY
argument_list|,
name|txkey
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211rtsthreshold
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_RTSTHRESHOLD
argument_list|,
name|isundefarg
argument_list|(
name|val
argument_list|)
condition|?
name|IEEE80211_RTS_MAX
else|:
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211protmode
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_PROTMODE_OFF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"cts"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_PROTMODE_CTS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"rtscts"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_PROTMODE_RTSCTS
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown protection mode"
argument_list|)
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_PROTMODE
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211txpower
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_TXPOWER
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|IEEE80211_ROAMING_DEVICE
value|0
end_define

begin_define
define|#
directive|define
name|IEEE80211_ROAMING_AUTO
value|1
end_define

begin_define
define|#
directive|define
name|IEEE80211_ROAMING_MANUAL
value|2
end_define

begin_function
specifier|static
name|void
name|set80211roaming
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|int
name|mode
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"device"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_ROAMING_DEVICE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"auto"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_ROAMING_AUTO
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|val
argument_list|,
literal|"manual"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|IEEE80211_ROAMING_MANUAL
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown roaming mode"
argument_list|)
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_ROAMING
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211wme
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211hidessid
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_HIDESSID
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211apbridge
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_APBRIDGE
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211chanlist
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|struct
name|ieee80211req_chanlist
name|chanlist
decl_stmt|;
define|#
directive|define
name|MAXCHAN
value|(sizeof(chanlist.ic_channels)*NBBY)
name|char
modifier|*
name|temp
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
name|temp
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|val
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|temp
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|chanlist
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chanlist
argument_list|)
argument_list|)
expr_stmt|;
name|cp
operator|=
name|temp
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|first
decl_stmt|,
name|last
decl_stmt|,
name|f
decl_stmt|;
name|tp
operator|=
name|strchr
argument_list|(
name|cp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|tp
operator|!=
name|NULL
condition|)
operator|*
name|tp
operator|++
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"%u-%u"
argument_list|,
operator|&
name|first
argument_list|,
operator|&
name|last
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
if|if
condition|(
name|first
operator|>
name|MAXCHAN
condition|)
name|errx
argument_list|(
operator|-
literal|1
argument_list|,
literal|"channel %u out of range, max %zu"
argument_list|,
name|first
argument_list|,
name|MAXCHAN
argument_list|)
expr_stmt|;
name|setbit
argument_list|(
name|chanlist
operator|.
name|ic_channels
argument_list|,
name|first
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
name|first
operator|>
name|MAXCHAN
condition|)
name|errx
argument_list|(
operator|-
literal|1
argument_list|,
literal|"channel %u out of range, max %zu"
argument_list|,
name|first
argument_list|,
name|MAXCHAN
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|>
name|MAXCHAN
condition|)
name|errx
argument_list|(
operator|-
literal|1
argument_list|,
literal|"channel %u out of range, max %zu"
argument_list|,
name|last
argument_list|,
name|MAXCHAN
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
operator|>
name|last
condition|)
name|errx
argument_list|(
operator|-
literal|1
argument_list|,
literal|"void channel range, %u> %u"
argument_list|,
name|first
argument_list|,
name|last
argument_list|)
expr_stmt|;
for|for
control|(
name|f
operator|=
name|first
init|;
name|f
operator|<=
name|last
condition|;
name|f
operator|++
control|)
name|setbit
argument_list|(
name|chanlist
operator|.
name|ic_channels
argument_list|,
name|f
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tp
operator|==
name|NULL
condition|)
break|break;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|tp
argument_list|)
condition|)
name|tp
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|isdigit
argument_list|(
operator|*
name|tp
argument_list|)
condition|)
break|break;
name|cp
operator|=
name|tp
expr_stmt|;
block|}
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_CHANLIST
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chanlist
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|chanlist
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|MAXCHAN
block|}
end_function

begin_function
specifier|static
name|void
name|set80211bssid
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
if|if
condition|(
operator|!
name|isanyarg
argument_list|(
name|val
argument_list|)
condition|)
block|{
name|char
modifier|*
name|temp
decl_stmt|;
name|struct
name|sockaddr_dl
name|sdl
decl_stmt|;
name|temp
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|val
argument_list|)
operator|+
literal|2
argument_list|)
expr_stmt|;
comment|/* ':' and '\0' */
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
name|temp
index|[
literal|0
index|]
operator|=
literal|':'
expr_stmt|;
name|strcpy
argument_list|(
name|temp
operator|+
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|sdl
operator|.
name|sdl_len
operator|=
sizeof|sizeof
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
name|link_addr
argument_list|(
name|temp
argument_list|,
operator|&
name|sdl
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdl
operator|.
name|sdl_alen
operator|!=
name|IEEE80211_ADDR_LEN
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malformed link-level address"
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_BSSID
argument_list|,
literal|0
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|,
name|LLADDR
argument_list|(
operator|&
name|sdl
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint8_t
name|zerobssid
index|[
name|IEEE80211_ADDR_LEN
index|]
decl_stmt|;
name|memset
argument_list|(
name|zerobssid
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|zerobssid
argument_list|)
argument_list|)
expr_stmt|;
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_BSSID
argument_list|,
literal|0
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|,
name|zerobssid
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|getac
parameter_list|(
specifier|const
name|char
modifier|*
name|ac
parameter_list|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"ac_be"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"be"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|WME_AC_BE
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"ac_bk"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"bk"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|WME_AC_BK
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"ac_vi"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"vi"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|WME_AC_VI
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"ac_vo"
argument_list|)
operator|==
literal|0
operator|||
name|strcasecmp
argument_list|(
name|ac
argument_list|,
literal|"vo"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|WME_AC_VO
return|;
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown wme access class %s"
argument_list|,
name|ac
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211cwmin
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_CWMIN
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211cwmax
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_CWMAX
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211aifs
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_AIFS
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211txoplimit
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_TXOPLIMIT
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211acm
argument_list|,
argument|ac
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_ACM
argument_list|,
literal|1
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211noacm
argument_list|,
argument|ac
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_ACM
argument_list|,
literal|0
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211ackpolicy
argument_list|,
argument|ac
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_ACKPOLICY
argument_list|,
literal|1
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211noackpolicy
argument_list|,
argument|ac
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_ACKPOLICY
argument_list|,
literal|0
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211bsscwmin
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_CWMIN
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
operator||
name|IEEE80211_WMEPARAM_BSS
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211bsscwmax
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_CWMAX
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
operator||
name|IEEE80211_WMEPARAM_BSS
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211bssaifs
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_AIFS
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
operator||
name|IEEE80211_WMEPARAM_BSS
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|set80211bsstxoplimit
argument_list|,
argument|ac
argument_list|,
argument|val
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_WME_TXOPLIMIT
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
name|getac
argument_list|(
name|ac
argument_list|)
operator||
name|IEEE80211_WMEPARAM_BSS
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211dtimperiod
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_DTIM_PERIOD
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211bintval
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_BEACON_INTERVAL
argument_list|,
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|void
name|set80211macmac
argument_list|(
argument|int s
argument_list|,
argument|int op
argument_list|,
argument|const char *val
argument_list|)
block|{
name|char
operator|*
name|temp
block|; 	struct
name|sockaddr_dl
name|sdl
block|;
name|temp
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|val
argument_list|)
operator|+
literal|2
argument_list|)
block|;
comment|/* ':' and '\0' */
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
name|temp
index|[
literal|0
index|]
operator|=
literal|':'
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|strcpy
argument_list|(
name|temp
operator|+
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|sdl
operator|.
name|sdl_len
operator|=
sizeof|sizeof
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|link_addr
argument_list|(
name|temp
argument_list|,
operator|&
name|sdl
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|free
argument_list|(
name|temp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|sdl
operator|.
name|sdl_alen
operator|!=
name|IEEE80211_ADDR_LEN
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malformed link-level address"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|set80211
argument_list|(
name|s
argument_list|,
name|op
argument_list|,
literal|0
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|,
name|LLADDR
argument_list|(
operator|&
name|sdl
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211addmac
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|set80211macmac
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_ADDMAC
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211delmac
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|set80211macmac
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_DELMAC
argument_list|,
name|val
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211kickmac
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|char
operator|*
name|temp
block|; 	struct
name|sockaddr_dl
name|sdl
block|; 	struct
name|ieee80211req_mlme
name|mlme
block|;
name|temp
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|val
argument_list|)
operator|+
literal|2
argument_list|)
block|;
comment|/* ':' and '\0' */
if|if
condition|(
name|temp
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malloc failed"
argument_list|)
expr_stmt|;
name|temp
index|[
literal|0
index|]
operator|=
literal|':'
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|strcpy
argument_list|(
name|temp
operator|+
literal|1
argument_list|,
name|val
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|sdl
operator|.
name|sdl_len
operator|=
sizeof|sizeof
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|link_addr
argument_list|(
name|temp
argument_list|,
operator|&
name|sdl
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|free
argument_list|(
name|temp
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|sdl
operator|.
name|sdl_alen
operator|!=
name|IEEE80211_ADDR_LEN
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"malformed link-level address"
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|memset
argument_list|(
operator|&
name|mlme
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mlme
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|mlme
operator|.
name|im_op
operator|=
name|IEEE80211_MLME_DEAUTH
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|mlme
operator|.
name|im_reason
operator|=
name|IEEE80211_REASON_AUTH_EXPIRE
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|memcpy
argument_list|(
name|mlme
operator|.
name|im_macaddr
argument_list|,
name|LLADDR
argument_list|(
operator|&
name|sdl
argument_list|)
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_MLME
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mlme
argument_list|)
argument_list|,
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|mlme
argument_list|)
expr_stmt|;
end_expr_stmt

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211maccmd
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_MACCMD
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|set80211pureg
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_PUREG
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211burst
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|rafp
parameter_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_BURST
argument_list|,
name|d
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211mcastrate
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_MCAST_RATE
argument_list|,
operator|(
name|int
operator|)
literal|2
operator|*
name|atof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211fragthreshold
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_FRAGTHRESHOLD
argument_list|,
name|isundefarg
argument_list|(
name|val
argument_list|)
operator|?
name|IEEE80211_FRAG_MAX
operator|:
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211bmissthreshold
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|set80211
argument_list|(
name|s
argument_list|,
name|IEEE80211_IOC_BMISSTHRESHOLD
argument_list|,
name|isundefarg
argument_list|(
name|val
argument_list|)
condition|?
name|IEEE80211_HWBMISS_MAX
else|:
name|atoi
argument_list|(
name|val
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
block|; }
specifier|static
name|int
name|getmaxrate
argument_list|(
argument|uint8_t rates[
literal|15
argument|]
argument_list|,
argument|uint8_t nrates
argument_list|)
block|{
name|int
name|i
block|,
name|maxrate
operator|=
operator|-
literal|1
block|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nrates
condition|;
name|i
operator|++
control|)
block|{
name|int
name|rate
init|=
name|rates
index|[
name|i
index|]
operator|&
name|IEEE80211_RATE_VAL
decl_stmt|;
if|if
condition|(
name|rate
operator|>
name|maxrate
condition|)
name|maxrate
operator|=
name|rate
expr_stmt|;
block|}
end_expr_stmt

begin_return
return|return
name|maxrate
operator|/
literal|2
return|;
end_return

begin_function
unit|}  static
specifier|const
name|char
modifier|*
name|getcaps
parameter_list|(
name|int
name|capinfo
parameter_list|)
block|{
specifier|static
name|char
name|capstring
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|capstring
decl_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_ESS
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'E'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_IBSS
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'I'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_CF_POLLABLE
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'c'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_CF_POLLREQ
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'C'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_PRIVACY
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'P'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_SHORT_PREAMBLE
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'S'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_PBCC
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'B'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_CHNL_AGILITY
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'A'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_SHORT_SLOTTIME
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'s'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_RSN
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'R'
expr_stmt|;
if|if
condition|(
name|capinfo
operator|&
name|IEEE80211_CAPINFO_DSSSOFDM
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'D'
expr_stmt|;
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
return|return
name|capstring
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|getflags
parameter_list|(
name|int
name|flags
parameter_list|)
block|{
comment|/* XXX need these publicly defined or similar */
define|#
directive|define
name|IEEE80211_NODE_AUTH
value|0x0001
comment|/* authorized for data */
define|#
directive|define
name|IEEE80211_NODE_QOS
value|0x0002
comment|/* QoS enabled */
define|#
directive|define
name|IEEE80211_NODE_ERP
value|0x0004
comment|/* ERP enabled */
define|#
directive|define
name|IEEE80211_NODE_PWR_MGT
value|0x0010
comment|/* power save mode enabled */
specifier|static
name|char
name|flagstring
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|cp
init|=
name|flagstring
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|IEEE80211_NODE_AUTH
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'A'
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|IEEE80211_NODE_QOS
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'Q'
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|IEEE80211_NODE_ERP
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'E'
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|IEEE80211_NODE_PWR_MGT
condition|)
operator|*
name|cp
operator|++
operator|=
literal|'P'
expr_stmt|;
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
return|return
name|flagstring
return|;
undef|#
directive|undef
name|IEEE80211_NODE_AUTH
undef|#
directive|undef
name|IEEE80211_NODE_QOS
undef|#
directive|undef
name|IEEE80211_NODE_ERP
undef|#
directive|undef
name|IEEE80211_NODE_PWR_MGT
block|}
end_function

begin_function
specifier|static
name|void
name|printie
parameter_list|(
specifier|const
name|char
modifier|*
name|tag
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|ie
parameter_list|,
name|size_t
name|ielen
parameter_list|,
name|int
name|maxlen
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|maxlen
operator|-=
name|strlen
argument_list|(
name|tag
argument_list|)
operator|+
literal|2
expr_stmt|;
if|if
condition|(
literal|2
operator|*
name|ielen
operator|>
name|maxlen
condition|)
name|maxlen
operator|--
expr_stmt|;
name|printf
argument_list|(
literal|"<"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|ielen
operator|>
literal|0
condition|;
name|ie
operator|++
operator|,
name|ielen
operator|--
control|)
block|{
if|if
condition|(
name|maxlen
operator|--
operator|<=
literal|0
condition|)
break|break;
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
name|ie
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ielen
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"-"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Copy the ssid string contents into buf, truncating to fit.  If the  * ssid is entirely printable then just copy intact.  Otherwise convert  * to hexadecimal.  If the result is truncated then replace the last  * three characters with "...".  */
end_comment

begin_function
specifier|static
name|int
name|copy_essid
parameter_list|(
name|char
name|buf
index|[]
parameter_list|,
name|size_t
name|bufsize
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
name|essid
parameter_list|,
name|size_t
name|essid_len
parameter_list|)
block|{
specifier|const
name|u_int8_t
modifier|*
name|p
decl_stmt|;
name|size_t
name|maxlen
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|essid_len
operator|>
name|bufsize
condition|)
name|maxlen
operator|=
name|bufsize
expr_stmt|;
else|else
name|maxlen
operator|=
name|essid_len
expr_stmt|;
comment|/* determine printable or not */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|p
operator|=
name|essid
init|;
name|i
operator|<
name|maxlen
condition|;
name|i
operator|++
operator|,
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|<
literal|' '
operator|||
operator|*
name|p
operator|>
literal|0x7e
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|!=
name|maxlen
condition|)
block|{
comment|/* not printable, print as hex */
if|if
condition|(
name|bufsize
operator|<
literal|3
condition|)
return|return
literal|0
return|;
name|strlcpy
argument_list|(
name|buf
argument_list|,
literal|"0x"
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
name|bufsize
operator|-=
literal|2
expr_stmt|;
name|p
operator|=
name|essid
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxlen
operator|&&
name|bufsize
operator|>=
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
operator|&
name|buf
index|[
literal|2
operator|+
literal|2
operator|*
name|i
index|]
argument_list|,
literal|"%02x"
argument_list|,
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|bufsize
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
name|essid_len
condition|)
name|memcpy
argument_list|(
operator|&
name|buf
index|[
literal|2
operator|+
literal|2
operator|*
name|i
operator|-
literal|3
index|]
argument_list|,
literal|"..."
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* printable, truncate as needed */
name|memcpy
argument_list|(
name|buf
argument_list|,
name|essid
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxlen
operator|!=
name|essid_len
condition|)
name|memcpy
argument_list|(
operator|&
name|buf
index|[
name|maxlen
operator|-
literal|3
index|]
argument_list|,
literal|"..."
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
return|return
name|maxlen
return|;
block|}
end_function

begin_comment
comment|/* unaligned little endian access */
end_comment

begin_define
define|#
directive|define
name|LE_READ_4
parameter_list|(
name|p
parameter_list|)
define|\
value|((u_int32_t)					\ 	 ((((const u_int8_t *)(p))[0]      ) |		\ 	  (((const u_int8_t *)(p))[1]<<  8) |		\ 	  (((const u_int8_t *)(p))[2]<< 16) |		\ 	  (((const u_int8_t *)(p))[3]<< 24)))
end_define

begin_function
specifier|static
name|int
name|__inline
name|iswpaoui
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|frm
parameter_list|)
block|{
return|return
name|frm
index|[
literal|1
index|]
operator|>
literal|3
operator|&&
name|LE_READ_4
argument_list|(
name|frm
operator|+
literal|2
argument_list|)
operator|==
operator|(
operator|(
name|WPA_OUI_TYPE
operator|<<
literal|24
operator|)
operator||
name|WPA_OUI
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__inline
name|iswmeoui
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|frm
parameter_list|)
block|{
return|return
name|frm
index|[
literal|1
index|]
operator|>
literal|3
operator|&&
name|LE_READ_4
argument_list|(
name|frm
operator|+
literal|2
argument_list|)
operator|==
operator|(
operator|(
name|WME_OUI_TYPE
operator|<<
literal|24
operator|)
operator||
name|WME_OUI
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__inline
name|isatherosoui
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|frm
parameter_list|)
block|{
return|return
name|frm
index|[
literal|1
index|]
operator|>
literal|3
operator|&&
name|LE_READ_4
argument_list|(
name|frm
operator|+
literal|2
argument_list|)
operator|==
operator|(
operator|(
name|ATH_OUI_TYPE
operator|<<
literal|24
operator|)
operator||
name|ATH_OUI
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|printies
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|vp
parameter_list|,
name|int
name|ielen
parameter_list|,
name|int
name|maxcols
parameter_list|)
block|{
while|while
condition|(
name|ielen
operator|>
literal|0
condition|)
block|{
switch|switch
condition|(
name|vp
index|[
literal|0
index|]
condition|)
block|{
case|case
name|IEEE80211_ELEMID_VENDOR
case|:
if|if
condition|(
name|iswpaoui
argument_list|(
name|vp
argument_list|)
condition|)
name|printie
argument_list|(
literal|" WPA"
argument_list|,
name|vp
argument_list|,
literal|2
operator|+
name|vp
index|[
literal|1
index|]
argument_list|,
name|maxcols
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iswmeoui
argument_list|(
name|vp
argument_list|)
condition|)
name|printie
argument_list|(
literal|" WME"
argument_list|,
name|vp
argument_list|,
literal|2
operator|+
name|vp
index|[
literal|1
index|]
argument_list|,
name|maxcols
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|isatherosoui
argument_list|(
name|vp
argument_list|)
condition|)
name|printie
argument_list|(
literal|" ATH"
argument_list|,
name|vp
argument_list|,
literal|2
operator|+
name|vp
index|[
literal|1
index|]
argument_list|,
name|maxcols
argument_list|)
expr_stmt|;
else|else
name|printie
argument_list|(
literal|" VEN"
argument_list|,
name|vp
argument_list|,
literal|2
operator|+
name|vp
index|[
literal|1
index|]
argument_list|,
name|maxcols
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_ELEMID_RSN
case|:
name|printie
argument_list|(
literal|" RSN"
argument_list|,
name|vp
argument_list|,
literal|2
operator|+
name|vp
index|[
literal|1
index|]
argument_list|,
name|maxcols
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printie
argument_list|(
literal|" ???"
argument_list|,
name|vp
argument_list|,
literal|2
operator|+
name|vp
index|[
literal|1
index|]
argument_list|,
name|maxcols
argument_list|)
expr_stmt|;
break|break;
block|}
name|ielen
operator|-=
literal|2
operator|+
name|vp
index|[
literal|1
index|]
expr_stmt|;
name|vp
operator|+=
literal|2
operator|+
name|vp
index|[
literal|1
index|]
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|list_scan
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|uint8_t
name|buf
index|[
literal|24
operator|*
literal|1024
index|]
decl_stmt|;
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|char
name|ssid
index|[
name|IEEE80211_NWID_LEN
operator|+
literal|1
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|cp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|ssidmax
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_SCAN_RESULTS
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
name|buf
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to get scan results"
argument_list|)
expr_stmt|;
name|len
operator|=
name|ireq
operator|.
name|i_len
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211req_scan_result
argument_list|)
condition|)
return|return;
name|ssidmax
operator|=
name|verbose
condition|?
name|IEEE80211_NWID_LEN
else|:
literal|14
expr_stmt|;
name|printf
argument_list|(
literal|"%-*.*s  %-17.17s  %4s %4s  %-5s %3s %4s\n"
argument_list|,
name|ssidmax
argument_list|,
name|ssidmax
argument_list|,
literal|"SSID"
argument_list|,
literal|"BSSID"
argument_list|,
literal|"CHAN"
argument_list|,
literal|"RATE"
argument_list|,
literal|"S:N"
argument_list|,
literal|"INT"
argument_list|,
literal|"CAPS"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|buf
expr_stmt|;
do|do
block|{
name|struct
name|ieee80211req_scan_result
modifier|*
name|sr
decl_stmt|;
name|uint8_t
modifier|*
name|vp
decl_stmt|;
name|sr
operator|=
operator|(
expr|struct
name|ieee80211req_scan_result
operator|*
operator|)
name|cp
expr_stmt|;
name|vp
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|(
name|sr
operator|+
literal|1
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%-*.*s  %s  %3d  %3dM %2d:%-2d  %3d %-4.4s"
argument_list|,
name|ssidmax
argument_list|,
name|copy_essid
argument_list|(
name|ssid
argument_list|,
name|ssidmax
argument_list|,
name|vp
argument_list|,
name|sr
operator|->
name|isr_ssid_len
argument_list|)
argument_list|,
name|ssid
argument_list|,
name|ether_ntoa
argument_list|(
operator|(
specifier|const
expr|struct
name|ether_addr
operator|*
operator|)
name|sr
operator|->
name|isr_bssid
argument_list|)
argument_list|,
name|ieee80211_mhz2ieee
argument_list|(
name|sr
operator|->
name|isr_freq
argument_list|,
name|sr
operator|->
name|isr_flags
argument_list|)
argument_list|,
name|getmaxrate
argument_list|(
name|sr
operator|->
name|isr_rates
argument_list|,
name|sr
operator|->
name|isr_nrates
argument_list|)
argument_list|,
name|sr
operator|->
name|isr_rssi
argument_list|,
name|sr
operator|->
name|isr_noise
argument_list|,
name|sr
operator|->
name|isr_intval
argument_list|,
name|getcaps
argument_list|(
name|sr
operator|->
name|isr_capinfo
argument_list|)
argument_list|)
expr_stmt|;
name|printies
argument_list|(
name|vp
operator|+
name|sr
operator|->
name|isr_ssid_len
argument_list|,
name|sr
operator|->
name|isr_ie_len
argument_list|,
literal|24
argument_list|)
expr_stmt|;
empty_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|sr
operator|->
name|isr_len
operator|,
name|len
operator|-=
name|sr
operator|->
name|isr_len
expr_stmt|;
block|}
do|while
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211req_scan_result
argument_list|)
condition|)
do|;
block|}
end_function

begin_include
include|#
directive|include
file|<net80211/ieee80211_freebsd.h>
end_include

begin_function
specifier|static
name|void
name|scan_and_wait
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|int
name|sroute
decl_stmt|;
name|sroute
operator|=
name|socket
argument_list|(
name|PF_ROUTE
argument_list|,
name|SOCK_RAW
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sroute
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_ROUTE,SOCK_RAW)"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_SCAN_REQ
expr_stmt|;
comment|/* NB: only root can trigger a scan so ignore errors */
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCS80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|char
name|buf
index|[
literal|2048
index|]
decl_stmt|;
name|struct
name|if_announcemsghdr
modifier|*
name|ifan
decl_stmt|;
name|struct
name|rt_msghdr
modifier|*
name|rtm
decl_stmt|;
do|do
block|{
if|if
condition|(
name|read
argument_list|(
name|sroute
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"read(PF_ROUTE)"
argument_list|)
expr_stmt|;
break|break;
block|}
name|rtm
operator|=
operator|(
expr|struct
name|rt_msghdr
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|rtm
operator|->
name|rtm_version
operator|!=
name|RTM_VERSION
condition|)
break|break;
name|ifan
operator|=
operator|(
expr|struct
name|if_announcemsghdr
operator|*
operator|)
name|rtm
expr_stmt|;
block|}
do|while
condition|(
name|rtm
operator|->
name|rtm_type
operator|!=
name|RTM_IEEE80211
operator|||
name|ifan
operator|->
name|ifan_what
operator|!=
name|RTM_IEEE80211_SCAN
condition|)
do|;
block|}
name|close
argument_list|(
name|sroute
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211scan
argument_list|,
argument|val
argument_list|,
argument|d
argument_list|)
block|{
name|scan_and_wait
argument_list|(
name|s
argument_list|)
block|;
name|list_scan
argument_list|(
name|s
argument_list|)
block|; }
specifier|static
expr|enum
name|ieee80211_opmode
name|get80211opmode
argument_list|(
argument|int s
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|list_stations
parameter_list|(
name|int
name|s
parameter_list|)
block|{
union|union
block|{
name|struct
name|ieee80211req_sta_req
name|req
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|24
operator|*
literal|1024
index|]
decl_stmt|;
block|}
name|u
union|;
name|enum
name|ieee80211_opmode
name|opmode
init|=
name|get80211opmode
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|uint8_t
modifier|*
name|cp
decl_stmt|;
name|int
name|len
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
comment|/* broadcast address =>'s get all stations */
operator|(
name|void
operator|)
name|memset
argument_list|(
name|u
operator|.
name|req
operator|.
name|is_u
operator|.
name|macaddr
argument_list|,
literal|0xff
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|opmode
operator|==
name|IEEE80211_M_STA
condition|)
block|{
comment|/* 		 * Get information about the associated AP. 		 */
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_BSSID
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
name|u
operator|.
name|req
operator|.
name|is_u
operator|.
name|macaddr
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
name|IEEE80211_ADDR_LEN
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_STA_INFO
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
operator|&
name|u
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|u
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to get station information"
argument_list|)
expr_stmt|;
name|len
operator|=
name|ireq
operator|.
name|i_len
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211req_sta_info
argument_list|)
condition|)
return|return;
name|printf
argument_list|(
literal|"%-17.17s %4s %4s %4s %4s %4s %6s %6s %4s %4s\n"
argument_list|,
literal|"ADDR"
argument_list|,
literal|"AID"
argument_list|,
literal|"CHAN"
argument_list|,
literal|"RATE"
argument_list|,
literal|"RSSI"
argument_list|,
literal|"IDLE"
argument_list|,
literal|"TXSEQ"
argument_list|,
literal|"RXSEQ"
argument_list|,
literal|"CAPS"
argument_list|,
literal|"FLAG"
argument_list|)
expr_stmt|;
name|cp
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|u
operator|.
name|req
operator|.
name|info
expr_stmt|;
do|do
block|{
name|struct
name|ieee80211req_sta_info
modifier|*
name|si
decl_stmt|;
name|uint8_t
modifier|*
name|vp
decl_stmt|;
name|si
operator|=
operator|(
expr|struct
name|ieee80211req_sta_info
operator|*
operator|)
name|cp
expr_stmt|;
if|if
condition|(
name|si
operator|->
name|isi_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|si
argument_list|)
condition|)
break|break;
name|vp
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|(
name|si
operator|+
literal|1
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s %4u %4d %3dM %4d %4d %6d %6d %-4.4s %-4.4s"
argument_list|,
name|ether_ntoa
argument_list|(
operator|(
specifier|const
expr|struct
name|ether_addr
operator|*
operator|)
name|si
operator|->
name|isi_macaddr
argument_list|)
argument_list|,
name|IEEE80211_AID
argument_list|(
name|si
operator|->
name|isi_associd
argument_list|)
argument_list|,
name|ieee80211_mhz2ieee
argument_list|(
name|si
operator|->
name|isi_freq
argument_list|,
name|si
operator|->
name|isi_flags
argument_list|)
argument_list|,
operator|(
name|si
operator|->
name|isi_rates
index|[
name|si
operator|->
name|isi_txrate
index|]
operator|&
name|IEEE80211_RATE_VAL
operator|)
operator|/
literal|2
argument_list|,
name|si
operator|->
name|isi_rssi
argument_list|,
name|si
operator|->
name|isi_inact
argument_list|,
name|si
operator|->
name|isi_txseqs
index|[
literal|0
index|]
argument_list|,
name|si
operator|->
name|isi_rxseqs
index|[
literal|0
index|]
argument_list|,
name|getcaps
argument_list|(
name|si
operator|->
name|isi_capinfo
argument_list|)
argument_list|,
name|getflags
argument_list|(
name|si
operator|->
name|isi_state
argument_list|)
argument_list|)
expr_stmt|;
name|printies
argument_list|(
name|vp
argument_list|,
name|si
operator|->
name|isi_ie_len
argument_list|,
literal|24
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|cp
operator|+=
name|si
operator|->
name|isi_len
operator|,
name|len
operator|-=
name|si
operator|->
name|isi_len
expr_stmt|;
block|}
do|while
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211req_sta_info
argument_list|)
condition|)
do|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_chaninfo
parameter_list|(
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|c
parameter_list|)
block|{
define|#
directive|define
name|IEEE80211_IS_CHAN_PASSIVE
parameter_list|(
name|_c
parameter_list|)
define|\
value|(((_c)->ic_flags& IEEE80211_CHAN_PASSIVE))
name|char
name|buf
index|[
literal|14
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_FHSS
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" FHSS"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_A
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_HALF
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11a/10Mhz"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_QUARTER
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11a/5Mhz"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11a"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IEEE80211_IS_CHAN_ANYG
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_HALF
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11g/10Mhz"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_QUARTER
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11g/5Mhz"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11g"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|IEEE80211_IS_CHAN_B
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" 11b"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IEEE80211_IS_CHAN_T
argument_list|(
name|c
argument_list|)
condition|)
name|strlcat
argument_list|(
name|buf
argument_list|,
literal|" Turbo"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Channel %3u : %u%c Mhz%-14.14s"
argument_list|,
name|ieee80211_mhz2ieee
argument_list|(
name|c
operator|->
name|ic_freq
argument_list|,
name|c
operator|->
name|ic_flags
argument_list|)
argument_list|,
name|c
operator|->
name|ic_freq
argument_list|,
name|IEEE80211_IS_CHAN_PASSIVE
argument_list|(
name|c
argument_list|)
condition|?
literal|'*'
else|:
literal|' '
argument_list|,
name|buf
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|IEEE80211_IS_CHAN_PASSIVE
block|}
end_function

begin_function
specifier|static
name|void
name|list_channels
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|allchans
parameter_list|)
block|{
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|struct
name|ieee80211req_chaninfo
name|chans
decl_stmt|;
name|struct
name|ieee80211req_chaninfo
name|achans
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|c
decl_stmt|;
name|int
name|i
decl_stmt|,
name|half
decl_stmt|,
name|ieee
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_CHANINFO
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
operator|&
name|chans
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|chans
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to get channel information"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|allchans
condition|)
block|{
name|struct
name|ieee80211req_chanlist
name|active
decl_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_CHANLIST
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
operator|&
name|active
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|active
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to get active channel list"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|achans
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|achans
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chans
operator|.
name|ic_nchans
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|&
name|chans
operator|.
name|ic_chans
index|[
name|i
index|]
expr_stmt|;
name|ieee
operator|=
name|ieee80211_mhz2ieee
argument_list|(
name|c
operator|->
name|ic_freq
argument_list|,
name|c
operator|->
name|ic_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|isset
argument_list|(
name|active
operator|.
name|ic_channels
argument_list|,
name|ieee
argument_list|)
operator|||
name|allchans
condition|)
name|achans
operator|.
name|ic_chans
index|[
name|achans
operator|.
name|ic_nchans
operator|++
index|]
operator|=
operator|*
name|c
expr_stmt|;
block|}
block|}
else|else
name|achans
operator|=
name|chans
expr_stmt|;
name|half
operator|=
name|achans
operator|.
name|ic_nchans
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|achans
operator|.
name|ic_nchans
operator|%
literal|2
condition|)
name|half
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|achans
operator|.
name|ic_nchans
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|print_chaninfo
argument_list|(
operator|&
name|achans
operator|.
name|ic_chans
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|print_chaninfo
argument_list|(
operator|&
name|achans
operator|.
name|ic_chans
index|[
name|half
operator|+
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|achans
operator|.
name|ic_nchans
operator|%
literal|2
condition|)
block|{
name|print_chaninfo
argument_list|(
operator|&
name|achans
operator|.
name|ic_chans
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|list_keys
parameter_list|(
name|int
name|s
parameter_list|)
block|{ }
end_function

begin_define
define|#
directive|define
name|IEEE80211_C_BITS
define|\
value|"\020\1WEP\2TKIP\3AES\4AES_CCM\6CKIP\11IBSS\12PMGT\13HOSTAP\14AHDEMO" \ "\15SWRETRY\16TXPMGT\17SHSLOT\20SHPREAMBLE\21MONITOR\22TKIPMIC\30WPA1" \ "\31WPA2\32BURST\33WME"
end_define

begin_function
specifier|static
name|void
name|list_capabilities
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|u_int32_t
name|caps
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_DRIVER_CAPS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to get driver capabilities"
argument_list|)
expr_stmt|;
name|caps
operator|=
operator|(
operator|(
operator|(
name|u_int16_t
operator|)
name|ireq
operator|.
name|i_val
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|u_int16_t
operator|)
name|ireq
operator|.
name|i_len
operator|)
expr_stmt|;
name|printb
argument_list|(
name|name
argument_list|,
name|caps
argument_list|,
name|IEEE80211_C_BITS
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|list_wme
parameter_list|(
name|int
name|s
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|acnames
index|[]
init|=
block|{
literal|"AC_BE"
block|,
literal|"AC_BK"
block|,
literal|"AC_VI"
block|,
literal|"AC_VO"
block|}
decl_stmt|;
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|int
name|ac
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ac
operator|=
name|WME_AC_BE
init|;
name|ac
operator|<=
name|WME_AC_VO
condition|;
name|ac
operator|++
control|)
block|{
name|again
label|:
if|if
condition|(
name|ireq
operator|.
name|i_len
operator|&
name|IEEE80211_WMEPARAM_BSS
condition|)
name|printf
argument_list|(
literal|"\t%s"
argument_list|,
literal|"     "
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t%s"
argument_list|,
name|acnames
index|[
name|ac
index|]
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
operator|(
name|ireq
operator|.
name|i_len
operator|&
name|IEEE80211_WMEPARAM_BSS
operator|)
operator||
name|ac
expr_stmt|;
comment|/* show WME BSS parameters */
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME_CWMIN
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|" cwmin %2u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME_CWMAX
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|" cwmax %2u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME_AIFS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|" aifs %2u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME_TXOPLIMIT
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|" txopLimit %3u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME_ACM
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
condition|)
name|printf
argument_list|(
literal|" acm"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" -acm"
argument_list|)
expr_stmt|;
block|}
comment|/* !BSS only */
if|if
condition|(
operator|(
name|ireq
operator|.
name|i_len
operator|&
name|IEEE80211_WMEPARAM_BSS
operator|)
operator|==
literal|0
condition|)
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME_ACKPOLICY
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|ireq
operator|.
name|i_val
condition|)
name|printf
argument_list|(
literal|" -ack"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" ack"
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ireq
operator|.
name|i_len
operator|&
name|IEEE80211_WMEPARAM_BSS
operator|)
operator|==
literal|0
condition|)
block|{
name|ireq
operator|.
name|i_len
operator||=
name|IEEE80211_WMEPARAM_BSS
expr_stmt|;
goto|goto
name|again
goto|;
block|}
else|else
name|ireq
operator|.
name|i_len
operator|&=
operator|~
name|IEEE80211_WMEPARAM_BSS
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|list_mac
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|struct
name|ieee80211req_maclist
modifier|*
name|acllist
decl_stmt|;
name|int
name|i
decl_stmt|,
name|nacls
decl_stmt|,
name|policy
decl_stmt|;
name|char
name|c
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX ?? */
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_MACCMD
expr_stmt|;
name|ireq
operator|.
name|i_val
operator|=
name|IEEE80211_MACCMD_POLICY
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
name|printf
argument_list|(
literal|"No acl policy loaded\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get mac policy"
argument_list|)
expr_stmt|;
block|}
name|policy
operator|=
name|ireq
operator|.
name|i_val
expr_stmt|;
name|ireq
operator|.
name|i_val
operator|=
name|IEEE80211_MACCMD_LIST
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get mac acl list size"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ireq
operator|.
name|i_len
operator|==
literal|0
condition|)
comment|/* NB: no acls */
return|return;
name|ireq
operator|.
name|i_data
operator|=
name|malloc
argument_list|(
name|ireq
operator|.
name|i_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ireq
operator|.
name|i_data
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"out of memory for acl list"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get mac acl list"
argument_list|)
expr_stmt|;
if|if
condition|(
name|policy
operator|==
name|IEEE80211_MACCMD_POLICY_OPEN
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"policy: open\n"
argument_list|)
expr_stmt|;
name|c
operator|=
literal|'*'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|policy
operator|==
name|IEEE80211_MACCMD_POLICY_ALLOW
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"policy: allow\n"
argument_list|)
expr_stmt|;
name|c
operator|=
literal|'+'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|policy
operator|==
name|IEEE80211_MACCMD_POLICY_DENY
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"policy: deny\n"
argument_list|)
expr_stmt|;
name|c
operator|=
literal|'-'
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"policy: unknown (%u)\n"
argument_list|,
name|policy
argument_list|)
expr_stmt|;
name|c
operator|=
literal|'?'
expr_stmt|;
block|}
name|nacls
operator|=
name|ireq
operator|.
name|i_len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|acllist
argument_list|)
expr_stmt|;
name|acllist
operator|=
operator|(
expr|struct
name|ieee80211req_maclist
operator|*
operator|)
name|ireq
operator|.
name|i_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nacls
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%c%s\n"
argument_list|,
name|c
argument_list|,
name|ether_ntoa
argument_list|(
operator|(
specifier|const
expr|struct
name|ether_addr
operator|*
operator|)
name|acllist
index|[
name|i
index|]
operator|.
name|ml_macaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|set80211list
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
block|{
define|#
directive|define
name|iseq
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|(strncasecmp(a,b,sizeof(b)-1) == 0)
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"sta"
argument_list|)
condition|)
name|list_stations
argument_list|(
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"scan"
argument_list|)
operator|||
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"ap"
argument_list|)
condition|)
name|list_scan
argument_list|(
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"chan"
argument_list|)
operator|||
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"freq"
argument_list|)
condition|)
name|list_channels
argument_list|(
name|s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"active"
argument_list|)
condition|)
name|list_channels
argument_list|(
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"keys"
argument_list|)
condition|)
name|list_keys
argument_list|(
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"caps"
argument_list|)
condition|)
name|list_capabilities
argument_list|(
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"wme"
argument_list|)
condition|)
name|list_wme
argument_list|(
name|s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|iseq
argument_list|(
name|arg
argument_list|,
literal|"mac"
argument_list|)
condition|)
name|list_mac
argument_list|(
name|s
argument_list|)
expr_stmt|;
else|else
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Don't know how to list %s for %s"
argument_list|,
name|arg
argument_list|,
name|name
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|iseq
block|}
end_expr_stmt

begin_function
specifier|static
name|enum
name|ieee80211_opmode
name|get80211opmode
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|struct
name|ifmediareq
name|ifmr
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ifmr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifmr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ifmr
operator|.
name|ifm_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifmr
operator|.
name|ifm_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFMEDIA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifmr
argument_list|)
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ifmr
operator|.
name|ifm_current
operator|&
name|IFM_IEEE80211_ADHOC
condition|)
return|return
name|IEEE80211_M_IBSS
return|;
comment|/* XXX ahdemo */
if|if
condition|(
name|ifmr
operator|.
name|ifm_current
operator|&
name|IFM_IEEE80211_HOSTAP
condition|)
return|return
name|IEEE80211_M_HOSTAP
return|;
if|if
condition|(
name|ifmr
operator|.
name|ifm_current
operator|&
name|IFM_IEEE80211_MONITOR
condition|)
return|return
name|IEEE80211_M_MONITOR
return|;
block|}
return|return
name|IEEE80211_M_STA
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|getchaninfo
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|chan
parameter_list|)
block|{
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
specifier|static
name|struct
name|ieee80211req_chaninfo
name|chans
decl_stmt|;
specifier|static
name|struct
name|ieee80211_channel
name|undef
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|c
decl_stmt|;
name|int
name|i
decl_stmt|,
name|freq
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_CHANINFO
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
operator|&
name|chans
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|chans
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to get channel information"
argument_list|)
expr_stmt|;
name|freq
operator|=
name|ieee80211_ieee2mhz
argument_list|(
name|chan
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chans
operator|.
name|ic_nchans
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
operator|&
name|chans
operator|.
name|ic_chans
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|ic_freq
operator|==
name|freq
condition|)
return|return
name|c
return|;
block|}
return|return
operator|&
name|undef
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void printcipher(int s, struct ieee80211req *ireq, int keylenop) { 	switch (ireq->i_val) { 	case IEEE80211_CIPHER_WEP: 		ireq->i_type = keylenop; 		if (ioctl(s, SIOCG80211, ireq) != -1) 			printf("WEP-%s",  			    ireq->i_len<= 5 ? "40" : 			    ireq->i_len<= 13 ? "104" : "128"); 		else 			printf("WEP"); 		break; 	case IEEE80211_CIPHER_TKIP: 		printf("TKIP"); 		break; 	case IEEE80211_CIPHER_AES_OCB: 		printf("AES-OCB"); 		break; 	case IEEE80211_CIPHER_AES_CCM: 		printf("AES-CCM"); 		break; 	case IEEE80211_CIPHER_CKIP: 		printf("CKIP"); 		break; 	case IEEE80211_CIPHER_NONE: 		printf("NONE"); 		break; 	default: 		printf("UNKNOWN (0x%x)", ireq->i_val); 		break; 	} }
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAXCOL
value|78
end_define

begin_decl_stmt
specifier|static
name|int
name|col
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|spacer
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|LINE_BREAK
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|spacer
operator|!=
literal|'\t'
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|spacer
operator|=
literal|'\t'
expr_stmt|;
block|}
name|col
operator|=
literal|8
expr_stmt|;
comment|/* 8-col tab */
block|}
end_function

begin_function
specifier|static
name|void
name|LINE_CHECK
parameter_list|(
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|int
name|n
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|n
operator|=
name|vsnprintf
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|col
operator|+=
literal|1
operator|+
name|n
expr_stmt|;
if|if
condition|(
name|col
operator|>
name|MAXCOL
condition|)
block|{
name|LINE_BREAK
argument_list|()
expr_stmt|;
name|col
operator|+=
name|n
expr_stmt|;
block|}
name|buf
index|[
literal|0
index|]
operator|=
name|spacer
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|spacer
operator|=
literal|' '
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|printkey
parameter_list|(
specifier|const
name|struct
name|ieee80211req_key
modifier|*
name|ik
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|zerodata
index|[
name|IEEE80211_KEYBUF_SIZE
index|]
decl_stmt|;
name|int
name|keylen
init|=
name|ik
operator|->
name|ik_keylen
decl_stmt|;
name|int
name|printcontents
decl_stmt|;
name|printcontents
operator|=
name|printkeys
operator|&&
operator|(
name|memcmp
argument_list|(
name|ik
operator|->
name|ik_keydata
argument_list|,
name|zerodata
argument_list|,
name|keylen
argument_list|)
operator|!=
literal|0
operator|||
name|verbose
operator|)
expr_stmt|;
if|if
condition|(
name|printcontents
condition|)
name|LINE_BREAK
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|ik
operator|->
name|ik_type
condition|)
block|{
case|case
name|IEEE80211_CIPHER_WEP
case|:
comment|/* compatibility */
name|LINE_CHECK
argument_list|(
literal|"wepkey %u:%s"
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
name|keylen
operator|<=
literal|5
condition|?
literal|"40-bit"
else|:
name|keylen
operator|<=
literal|13
condition|?
literal|"104-bit"
else|:
literal|"128-bit"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_TKIP
case|:
if|if
condition|(
name|keylen
operator|>
literal|128
operator|/
literal|8
condition|)
name|keylen
operator|-=
literal|128
operator|/
literal|8
expr_stmt|;
comment|/* ignore MIC for now */
name|LINE_CHECK
argument_list|(
literal|"TKIP %u:%u-bit"
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
literal|8
operator|*
name|keylen
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_AES_OCB
case|:
name|LINE_CHECK
argument_list|(
literal|"AES-OCB %u:%u-bit"
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
literal|8
operator|*
name|keylen
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_AES_CCM
case|:
name|LINE_CHECK
argument_list|(
literal|"AES-CCM %u:%u-bit"
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
literal|8
operator|*
name|keylen
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_CKIP
case|:
name|LINE_CHECK
argument_list|(
literal|"CKIP %u:%u-bit"
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
literal|8
operator|*
name|keylen
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_CIPHER_NONE
case|:
name|LINE_CHECK
argument_list|(
literal|"NULL %u:%u-bit"
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
literal|8
operator|*
name|keylen
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LINE_CHECK
argument_list|(
literal|"UNKNOWN (0x%x) %u:%u-bit"
argument_list|,
name|ik
operator|->
name|ik_type
argument_list|,
name|ik
operator|->
name|ik_keyix
operator|+
literal|1
argument_list|,
literal|8
operator|*
name|keylen
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|printcontents
condition|)
block|{
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"<"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|keylen
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|ik
operator|->
name|ik_keydata
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ik
operator|->
name|ik_type
operator|!=
name|IEEE80211_CIPHER_WEP
operator|&&
operator|(
name|ik
operator|->
name|ik_keyrsc
operator|!=
literal|0
operator|||
name|verbose
operator|)
condition|)
name|printf
argument_list|(
literal|" rsc %ju"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|ik
operator|->
name|ik_keyrsc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ik
operator|->
name|ik_type
operator|!=
name|IEEE80211_CIPHER_WEP
operator|&&
operator|(
name|ik
operator|->
name|ik_keytsc
operator|!=
literal|0
operator|||
name|verbose
operator|)
condition|)
name|printf
argument_list|(
literal|" tsc %ju"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|ik
operator|->
name|ik_keytsc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ik
operator|->
name|ik_flags
operator|!=
literal|0
operator|&&
name|verbose
condition|)
block|{
specifier|const
name|char
modifier|*
name|sep
init|=
literal|" "
decl_stmt|;
if|if
condition|(
name|ik
operator|->
name|ik_flags
operator|&
name|IEEE80211_KEY_XMIT
condition|)
name|printf
argument_list|(
literal|"%stx"
argument_list|,
name|sep
argument_list|)
operator|,
name|sep
operator|=
literal|"+"
expr_stmt|;
if|if
condition|(
name|ik
operator|->
name|ik_flags
operator|&
name|IEEE80211_KEY_RECV
condition|)
name|printf
argument_list|(
literal|"%srx"
argument_list|,
name|sep
argument_list|)
operator|,
name|sep
operator|=
literal|"+"
expr_stmt|;
if|if
condition|(
name|ik
operator|->
name|ik_flags
operator|&
name|IEEE80211_KEY_DEFAULT
condition|)
name|printf
argument_list|(
literal|"%sdef"
argument_list|,
name|sep
argument_list|)
operator|,
name|sep
operator|=
literal|"+"
expr_stmt|;
block|}
name|LINE_BREAK
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_status
parameter_list|(
name|int
name|s
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|zerobssid
index|[
name|IEEE80211_ADDR_LEN
index|]
decl_stmt|;
name|enum
name|ieee80211_opmode
name|opmode
init|=
name|get80211opmode
argument_list|(
name|s
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|,
name|wpa
decl_stmt|,
name|wme
decl_stmt|;
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
name|u_int8_t
name|data
index|[
literal|32
index|]
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|c
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
operator|&
name|data
expr_stmt|;
name|wpa
operator|=
literal|0
expr_stmt|;
comment|/* unknown/not set */
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_SSID
expr_stmt|;
name|ireq
operator|.
name|i_val
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* If we can't get the SSID, this isn't an 802.11 device. */
return|return;
block|}
name|num
operator|=
literal|0
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_NUMSSIDS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|>=
literal|0
condition|)
name|num
operator|=
name|ireq
operator|.
name|i_val
expr_stmt|;
name|printf
argument_list|(
literal|"\tssid "
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|>
literal|1
condition|)
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_SSID
expr_stmt|;
for|for
control|(
name|ireq
operator|.
name|i_val
operator|=
literal|0
init|;
name|ireq
operator|.
name|i_val
operator|<
name|num
condition|;
name|ireq
operator|.
name|i_val
operator|++
control|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|>=
literal|0
operator|&&
name|ireq
operator|.
name|i_len
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|" %d:"
argument_list|,
name|ireq
operator|.
name|i_val
operator|+
literal|1
argument_list|)
expr_stmt|;
name|print_string
argument_list|(
name|data
argument_list|,
name|ireq
operator|.
name|i_len
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|print_string
argument_list|(
name|data
argument_list|,
name|ireq
operator|.
name|i_len
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_CHANNEL
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|end
goto|;
name|c
operator|=
name|getchaninfo
argument_list|(
name|s
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|" channel %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" (%u)"
argument_list|,
name|c
operator|->
name|ic_freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|" channel UNDEF"
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_BSSID
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
name|IEEE80211_ADDR_LEN
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|>=
literal|0
operator|&&
operator|(
name|memcmp
argument_list|(
name|ireq
operator|.
name|i_data
argument_list|,
name|zerobssid
argument_list|,
sizeof|sizeof
argument_list|(
name|zerobssid
argument_list|)
argument_list|)
operator|!=
literal|0
operator|||
name|verbose
operator|)
condition|)
name|printf
argument_list|(
literal|" bssid %s"
argument_list|,
name|ether_ntoa
argument_list|(
name|ireq
operator|.
name|i_data
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_STATIONNAME
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"\n\tstationname "
argument_list|)
expr_stmt|;
name|print_string
argument_list|(
name|data
argument_list|,
name|ireq
operator|.
name|i_len
argument_list|)
expr_stmt|;
block|}
name|spacer
operator|=
literal|' '
expr_stmt|;
comment|/* force first break */
name|LINE_BREAK
argument_list|()
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_AUTHMODE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ireq
operator|.
name|i_val
condition|)
block|{
case|case
name|IEEE80211_AUTH_NONE
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode NONE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_AUTH_OPEN
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode OPEN"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_AUTH_SHARED
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode SHARED"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_AUTH_8021X
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode 802.1x"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_AUTH_WPA
case|:
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WPA
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|wpa
operator|=
name|ireq
operator|.
name|i_val
expr_stmt|;
if|if
condition|(
operator|!
name|wpa
condition|)
name|wpa
operator|=
literal|1
expr_stmt|;
comment|/* default to WPA1 */
switch|switch
condition|(
name|wpa
condition|)
block|{
case|case
literal|2
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode WPA2/802.11i"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode WPA1+WPA2/802.11i"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LINE_CHECK
argument_list|(
literal|"authmode WPA"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|IEEE80211_AUTH_AUTO
case|:
name|LINE_CHECK
argument_list|(
literal|"authmode AUTO"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LINE_CHECK
argument_list|(
literal|"authmode UNKNOWN (0x%x)"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WEP
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_WEP_NOSUP
condition|)
block|{
name|int
name|firstkey
decl_stmt|,
name|wepmode
decl_stmt|;
name|wepmode
operator|=
name|ireq
operator|.
name|i_val
expr_stmt|;
switch|switch
condition|(
name|wepmode
condition|)
block|{
case|case
name|IEEE80211_WEP_OFF
case|:
name|LINE_CHECK
argument_list|(
literal|"privacy OFF"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_WEP_ON
case|:
name|LINE_CHECK
argument_list|(
literal|"privacy ON"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_WEP_MIXED
case|:
name|LINE_CHECK
argument_list|(
literal|"privacy MIXED"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LINE_CHECK
argument_list|(
literal|"privacy UNKNOWN (0x%x)"
argument_list|,
name|wepmode
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * If we get here then we've got WEP support so we need 		 * to print WEP status. 		 */
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WEPTXKEY
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"WEP support, but no tx key!"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
operator|-
literal|1
condition|)
name|LINE_CHECK
argument_list|(
literal|"deftxkey %d"
argument_list|,
name|ireq
operator|.
name|i_val
operator|+
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wepmode
operator|!=
name|IEEE80211_WEP_OFF
operator|||
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"deftxkey UNDEF"
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_NUMWEPKEYS
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"WEP support, but no NUMWEPKEYS support!"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
name|num
operator|=
name|ireq
operator|.
name|i_val
expr_stmt|;
name|firstkey
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ieee80211req_key
name|ik
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ik
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ik
argument_list|)
argument_list|)
expr_stmt|;
name|ik
operator|.
name|ik_keyix
operator|=
name|i
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WPAKEY
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
operator|&
name|ik
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
sizeof|sizeof
argument_list|(
name|ik
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|warn
argument_list|(
literal|"WEP support, but can get keys!"
argument_list|)
expr_stmt|;
goto|goto
name|end
goto|;
block|}
if|if
condition|(
name|ik
operator|.
name|ik_keylen
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
name|LINE_BREAK
argument_list|()
expr_stmt|;
name|printkey
argument_list|(
operator|&
name|ik
argument_list|)
expr_stmt|;
name|firstkey
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_POWERSAVE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
operator|&&
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_POWERSAVE_NOSUP
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_POWERSAVE_OFF
operator|||
name|verbose
condition|)
block|{
switch|switch
condition|(
name|ireq
operator|.
name|i_val
condition|)
block|{
case|case
name|IEEE80211_POWERSAVE_OFF
case|:
name|LINE_CHECK
argument_list|(
literal|"powersavemode OFF"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_POWERSAVE_CAM
case|:
name|LINE_CHECK
argument_list|(
literal|"powersavemode CAM"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_POWERSAVE_PSP
case|:
name|LINE_CHECK
argument_list|(
literal|"powersavemode PSP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_POWERSAVE_PSP_CAM
case|:
name|LINE_CHECK
argument_list|(
literal|"powersavemode PSP-CAM"
argument_list|)
expr_stmt|;
break|break;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_POWERSAVESLEEP
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|LINE_CHECK
argument_list|(
literal|"powersavesleep %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_TXPOWMAX
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|LINE_CHECK
argument_list|(
literal|"txpowmax %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_TXPOWER
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|LINE_CHECK
argument_list|(
literal|"txpower %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_RTSTHRESHOLD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_RTS_MAX
operator|||
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"rtsthreshold %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_MCAST_RATE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
literal|2
operator|*
literal|1
operator|||
name|verbose
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|==
literal|11
condition|)
name|LINE_CHECK
argument_list|(
literal|"mcastrate 5.5"
argument_list|)
expr_stmt|;
else|else
name|LINE_CHECK
argument_list|(
literal|"mcastrate %d"
argument_list|,
name|ireq
operator|.
name|i_val
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_FRAGTHRESHOLD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_FRAG_MAX
operator|||
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"fragthreshold %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_BMISSTHRESHOLD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_HWBMISS_MAX
operator|||
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"bmiss %d"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IEEE80211_IS_CHAN_ANYG
argument_list|(
name|c
argument_list|)
operator|||
name|verbose
condition|)
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_PUREG
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
condition|)
name|LINE_CHECK
argument_list|(
literal|"pureg"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"-pureg"
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_PROTMODE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ireq
operator|.
name|i_val
condition|)
block|{
case|case
name|IEEE80211_PROTMODE_OFF
case|:
name|LINE_CHECK
argument_list|(
literal|"protmode OFF"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_PROTMODE_CTS
case|:
name|LINE_CHECK
argument_list|(
literal|"protmode CTS"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_PROTMODE_RTSCTS
case|:
name|LINE_CHECK
argument_list|(
literal|"protmode RTSCTS"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LINE_CHECK
argument_list|(
literal|"protmode UNKNOWN (0x%x)"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_WME
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|wme
operator|=
name|ireq
operator|.
name|i_val
expr_stmt|;
if|if
condition|(
name|wme
condition|)
name|LINE_CHECK
argument_list|(
literal|"wme"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"-wme"
argument_list|)
expr_stmt|;
block|}
else|else
name|wme
operator|=
literal|0
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_BURST
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
condition|)
name|LINE_CHECK
argument_list|(
literal|"burst"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"-burst"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|opmode
operator|==
name|IEEE80211_M_HOSTAP
condition|)
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_HIDESSID
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
condition|)
name|LINE_CHECK
argument_list|(
literal|"ssid HIDE"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"ssid SHOW"
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_APBRIDGE
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|ireq
operator|.
name|i_val
condition|)
name|LINE_CHECK
argument_list|(
literal|"-apbridge"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"apbridge"
argument_list|)
expr_stmt|;
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_DTIM_PERIOD
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
name|LINE_CHECK
argument_list|(
literal|"dtimperiod %u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_ROAMING
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
operator|!=
name|IEEE80211_ROAMING_AUTO
operator|||
name|verbose
condition|)
block|{
switch|switch
condition|(
name|ireq
operator|.
name|i_val
condition|)
block|{
case|case
name|IEEE80211_ROAMING_DEVICE
case|:
name|LINE_CHECK
argument_list|(
literal|"roaming DEVICE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_ROAMING_AUTO
case|:
name|LINE_CHECK
argument_list|(
literal|"roaming AUTO"
argument_list|)
expr_stmt|;
break|break;
case|case
name|IEEE80211_ROAMING_MANUAL
case|:
name|LINE_CHECK
argument_list|(
literal|"roaming MANUAL"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|LINE_CHECK
argument_list|(
literal|"roaming UNKNOWN (0x%x)"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
block|}
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_BEACON_INTERVAL
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
condition|)
name|LINE_CHECK
argument_list|(
literal|"bintval %u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"bintval %u"
argument_list|,
name|ireq
operator|.
name|i_val
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wme
operator|&&
name|verbose
condition|)
block|{
name|LINE_BREAK
argument_list|()
expr_stmt|;
name|list_wme
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa
condition|)
block|{
name|ireq
operator|.
name|i_type
operator|=
name|IEEE80211_IOC_COUNTERMEASURES
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCG80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|ireq
operator|.
name|i_val
condition|)
name|LINE_CHECK
argument_list|(
literal|"countermeasures"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|verbose
condition|)
name|LINE_CHECK
argument_list|(
literal|"-countermeasures"
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* XXX not interesting with WPA done in user space */
block|ireq.i_type = IEEE80211_IOC_KEYMGTALGS; 		if (ioctl(s, SIOCG80211,&ireq) != -1) { 		}  		ireq.i_type = IEEE80211_IOC_MCASTCIPHER; 		if (ioctl(s, SIOCG80211,&ireq) != -1) { 			LINE_CHECK("mcastcipher "); 			printcipher(s,&ireq, IEEE80211_IOC_MCASTKEYLEN); 			spacer = ' '; 		}  		ireq.i_type = IEEE80211_IOC_UCASTCIPHER; 		if (ioctl(s, SIOCG80211,&ireq) != -1) { 			LINE_CHECK("ucastcipher "); 			printcipher(s,&ireq, IEEE80211_IOC_UCASTKEYLEN); 		}  		if (wpa& 2) { 			ireq.i_type = IEEE80211_IOC_RSNCAPS; 			if (ioctl(s, SIOCG80211,&ireq) != -1) { 				LINE_CHECK("RSN caps 0x%x", ireq.i_val); 				spacer = ' '; 			} 		}  		ireq.i_type = IEEE80211_IOC_UCASTCIPHERS; 		if (ioctl(s, SIOCG80211,&ireq) != -1) { 		}
endif|#
directive|endif
name|LINE_BREAK
argument_list|()
expr_stmt|;
block|}
name|LINE_BREAK
argument_list|()
expr_stmt|;
name|end
label|:
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|set80211
parameter_list|(
name|int
name|s
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|val
parameter_list|,
name|int
name|len
parameter_list|,
name|u_int8_t
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ieee80211req
name|ireq
decl_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
operator|&
name|ireq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|ireq
operator|.
name|i_name
argument_list|)
argument_list|)
expr_stmt|;
name|ireq
operator|.
name|i_type
operator|=
name|type
expr_stmt|;
name|ireq
operator|.
name|i_val
operator|=
name|val
expr_stmt|;
name|ireq
operator|.
name|i_len
operator|=
name|len
expr_stmt|;
name|ireq
operator|.
name|i_data
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCS80211
argument_list|,
operator|&
name|ireq
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"SIOCS80211"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_string
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|sep
parameter_list|,
name|u_int8_t
modifier|*
name|buf
parameter_list|,
name|int
modifier|*
name|lenp
parameter_list|)
block|{
name|int
name|len
decl_stmt|;
name|int
name|hexstr
decl_stmt|;
name|u_int8_t
modifier|*
name|p
decl_stmt|;
name|len
operator|=
operator|*
name|lenp
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
name|hexstr
operator|=
operator|(
name|val
index|[
literal|0
index|]
operator|==
literal|'0'
operator|&&
name|tolower
argument_list|(
operator|(
name|u_char
operator|)
name|val
index|[
literal|1
index|]
argument_list|)
operator|==
literal|'x'
operator|)
expr_stmt|;
if|if
condition|(
name|hexstr
condition|)
name|val
operator|+=
literal|2
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|*
name|val
operator|==
literal|'\0'
condition|)
break|break;
if|if
condition|(
name|sep
operator|!=
name|NULL
operator|&&
name|strchr
argument_list|(
name|sep
argument_list|,
operator|*
name|val
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|val
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|hexstr
condition|)
block|{
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|(
name|u_char
operator|)
name|val
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"bad hexadecimal digits"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|isxdigit
argument_list|(
operator|(
name|u_char
operator|)
name|val
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|warnx
argument_list|(
literal|"odd count hexadecimal digits"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|p
operator|>=
name|buf
operator|+
name|len
condition|)
block|{
if|if
condition|(
name|hexstr
condition|)
name|warnx
argument_list|(
literal|"hexadecimal digits too long"
argument_list|)
expr_stmt|;
else|else
name|warnx
argument_list|(
literal|"string too long"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|hexstr
condition|)
block|{
define|#
directive|define
name|tohex
parameter_list|(
name|x
parameter_list|)
value|(isdigit(x) ? (x) - '0' : tolower(x) - 'a' + 10)
operator|*
name|p
operator|++
operator|=
operator|(
name|tohex
argument_list|(
operator|(
name|u_char
operator|)
name|val
index|[
literal|0
index|]
argument_list|)
operator|<<
literal|4
operator|)
operator||
name|tohex
argument_list|(
operator|(
name|u_char
operator|)
name|val
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|tohex
name|val
operator|+=
literal|2
expr_stmt|;
block|}
else|else
operator|*
name|p
operator|++
operator|=
operator|*
name|val
operator|++
expr_stmt|;
block|}
name|len
operator|=
name|p
operator|-
name|buf
expr_stmt|;
comment|/* The string "-" is treated as the empty string. */
if|if
condition|(
operator|!
name|hexstr
operator|&&
name|len
operator|==
literal|1
operator|&&
name|buf
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
operator|*
name|lenp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|len
operator|<
operator|*
name|lenp
condition|)
name|memset
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
operator|*
name|lenp
operator|-
name|len
argument_list|)
expr_stmt|;
operator|*
name|lenp
operator|=
name|len
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_string
parameter_list|(
specifier|const
name|u_int8_t
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|hasspc
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|hasspc
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isprint
argument_list|(
name|buf
index|[
name|i
index|]
argument_list|)
operator|&&
name|buf
index|[
name|i
index|]
operator|!=
literal|'\0'
condition|)
break|break;
if|if
condition|(
name|isspace
argument_list|(
name|buf
index|[
name|i
index|]
argument_list|)
condition|)
name|hasspc
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
name|len
condition|)
block|{
if|if
condition|(
name|hasspc
operator|||
name|len
operator|==
literal|0
operator|||
name|buf
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|printf
argument_list|(
literal|"\"%.*s\""
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%.*s"
argument_list|,
name|len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|cmd
name|ieee80211_cmds
index|[]
init|=
block|{
name|DEF_CMD_ARG
argument_list|(
literal|"ssid"
argument_list|,
name|set80211ssid
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"nwid"
argument_list|,
name|set80211ssid
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"stationname"
argument_list|,
name|set80211stationname
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"station"
argument_list|,
name|set80211stationname
argument_list|)
block|,
comment|/* BSD/OS */
name|DEF_CMD_ARG
argument_list|(
literal|"channel"
argument_list|,
name|set80211channel
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"authmode"
argument_list|,
name|set80211authmode
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"powersavemode"
argument_list|,
name|set80211powersavemode
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"powersave"
argument_list|,
literal|1
argument_list|,
name|set80211powersave
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-powersave"
argument_list|,
literal|0
argument_list|,
name|set80211powersave
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"powersavesleep"
argument_list|,
name|set80211powersavesleep
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"wepmode"
argument_list|,
name|set80211wepmode
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"wep"
argument_list|,
literal|1
argument_list|,
name|set80211wep
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-wep"
argument_list|,
literal|0
argument_list|,
name|set80211wep
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"deftxkey"
argument_list|,
name|set80211weptxkey
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"weptxkey"
argument_list|,
name|set80211weptxkey
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"wepkey"
argument_list|,
name|set80211wepkey
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"nwkey"
argument_list|,
name|set80211nwkey
argument_list|)
block|,
comment|/* NetBSD */
name|DEF_CMD
argument_list|(
literal|"-nwkey"
argument_list|,
literal|0
argument_list|,
name|set80211wep
argument_list|)
block|,
comment|/* NetBSD */
name|DEF_CMD_ARG
argument_list|(
literal|"rtsthreshold"
argument_list|,
name|set80211rtsthreshold
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"protmode"
argument_list|,
name|set80211protmode
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"txpower"
argument_list|,
name|set80211txpower
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"roaming"
argument_list|,
name|set80211roaming
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"wme"
argument_list|,
literal|1
argument_list|,
name|set80211wme
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-wme"
argument_list|,
literal|0
argument_list|,
name|set80211wme
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"hidessid"
argument_list|,
literal|1
argument_list|,
name|set80211hidessid
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-hidessid"
argument_list|,
literal|0
argument_list|,
name|set80211hidessid
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"apbridge"
argument_list|,
literal|1
argument_list|,
name|set80211apbridge
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-apbridge"
argument_list|,
literal|0
argument_list|,
name|set80211apbridge
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"chanlist"
argument_list|,
name|set80211chanlist
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"bssid"
argument_list|,
name|set80211bssid
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"ap"
argument_list|,
name|set80211bssid
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"scan"
argument_list|,
literal|0
argument_list|,
name|set80211scan
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"list"
argument_list|,
name|set80211list
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"cwmin"
argument_list|,
name|set80211cwmin
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"cwmax"
argument_list|,
name|set80211cwmax
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"aifs"
argument_list|,
name|set80211aifs
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"txoplimit"
argument_list|,
name|set80211txoplimit
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"acm"
argument_list|,
name|set80211acm
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-acm"
argument_list|,
name|set80211noacm
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"ack"
argument_list|,
name|set80211ackpolicy
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-ack"
argument_list|,
name|set80211noackpolicy
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"bss:cwmin"
argument_list|,
name|set80211bsscwmin
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"bss:cwmax"
argument_list|,
name|set80211bsscwmax
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"bss:aifs"
argument_list|,
name|set80211bssaifs
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"bss:txoplimit"
argument_list|,
name|set80211bsstxoplimit
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"dtimperiod"
argument_list|,
name|set80211dtimperiod
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"bintval"
argument_list|,
name|set80211bintval
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"mac:open"
argument_list|,
name|IEEE80211_MACCMD_POLICY_OPEN
argument_list|,
name|set80211maccmd
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"mac:allow"
argument_list|,
name|IEEE80211_MACCMD_POLICY_ALLOW
argument_list|,
name|set80211maccmd
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"mac:deny"
argument_list|,
name|IEEE80211_MACCMD_POLICY_DENY
argument_list|,
name|set80211maccmd
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"mac:flush"
argument_list|,
name|IEEE80211_MACCMD_FLUSH
argument_list|,
name|set80211maccmd
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"mac:detach"
argument_list|,
name|IEEE80211_MACCMD_DETACH
argument_list|,
name|set80211maccmd
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"mac:add"
argument_list|,
name|set80211addmac
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"mac:del"
argument_list|,
name|set80211delmac
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"mac:kick"
argument_list|,
name|set80211kickmac
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"pureg"
argument_list|,
literal|1
argument_list|,
name|set80211pureg
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-pureg"
argument_list|,
literal|0
argument_list|,
name|set80211pureg
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"mcastrate"
argument_list|,
name|set80211mcastrate
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"fragthreshold"
argument_list|,
name|set80211fragthreshold
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"burst"
argument_list|,
literal|1
argument_list|,
name|set80211burst
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-burst"
argument_list|,
literal|0
argument_list|,
name|set80211burst
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"bmiss"
argument_list|,
name|set80211bmissthreshold
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"bmissthreshold"
argument_list|,
name|set80211bmissthreshold
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|afswtch
name|af_ieee80211
init|=
block|{
operator|.
name|af_name
operator|=
literal|"af_ieee80211"
block|,
operator|.
name|af_af
operator|=
name|AF_UNSPEC
block|,
operator|.
name|af_other_status
operator|=
name|ieee80211_status
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__constructor
name|void
name|ieee80211_ctor
parameter_list|(
name|void
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|ieee80211_cmds
argument_list|)
condition|;
name|i
operator|++
control|)
name|cmd_register
argument_list|(
operator|&
name|ieee80211_cmds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|af_register
argument_list|(
operator|&
name|af_ieee80211
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|N
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2001 Wasabi Systems, Inc.  * All rights reserved.  *  * Written by Jason R. Thorpe for Wasabi Systems, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *      This product includes software developed for the NetBSD Project by  *      Wasabi Systems, Inc.  * 4. The name of Wasabi Systems, Inc. may not be used to endorse  *    or promote products derived from this software without specific prior  *    written permission.  *  * THIS SOFTWARE IS PROVIDED BY WASABI SYSTEMS, INC. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL WASABI SYSTEMS, INC  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_bridgevar.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"ifconfig.h"
end_include

begin_function_decl
specifier|extern
name|void
name|printb
parameter_list|(
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|unsigned
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|bits
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|get_val
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|u_long
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|do_cmd
parameter_list|(
name|int
parameter_list|,
name|u_long
parameter_list|,
name|void
modifier|*
parameter_list|,
name|size_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|do_bridgeflag
parameter_list|(
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|bridge_status
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|rt_addrinfo
modifier|*
name|info
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_int16_t
name|pri
decl_stmt|;
name|u_int8_t
name|ht
decl_stmt|,
name|fd
decl_stmt|,
name|ma
decl_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGPRI
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|pri
operator|=
name|param
operator|.
name|ifbrp_prio
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGHT
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|ht
operator|=
name|param
operator|.
name|ifbrp_hellotime
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGFD
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|fd
operator|=
name|param
operator|.
name|ifbrp_fwddelay
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGMA
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|ma
operator|=
name|param
operator|.
name|ifbrp_maxage
expr_stmt|;
name|printf
argument_list|(
literal|"\tpriority %u hellotime %u fwddelay %u maxage %u\n"
argument_list|,
name|pri
argument_list|,
name|ht
argument_list|,
name|fd
argument_list|,
name|ma
argument_list|)
expr_stmt|;
name|bridge_interfaces
argument_list|(
name|s
argument_list|,
literal|"\tmember: "
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|bridge_interfaces
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|stpstates
index|[]
init|=
block|{
literal|"disabled"
block|,
literal|"listening"
block|,
literal|"learning"
block|,
literal|"forwarding"
block|,
literal|"blocking"
block|, 	}
decl_stmt|;
name|struct
name|ifbifconf
name|bifc
decl_stmt|;
name|struct
name|ifbreq
modifier|*
name|req
decl_stmt|;
name|char
modifier|*
name|inbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|ninbuf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
init|=
literal|8192
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ninbuf
operator|=
name|realloc
argument_list|(
name|inbuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ninbuf
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to allocate interface buffer"
argument_list|)
expr_stmt|;
name|bifc
operator|.
name|ifbic_len
operator|=
name|len
expr_stmt|;
name|bifc
operator|.
name|ifbic_buf
operator|=
name|inbuf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGIFS
argument_list|,
operator|&
name|bifc
argument_list|,
sizeof|sizeof
argument_list|(
name|bifc
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get interface list"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bifc
operator|.
name|ifbic_len
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|*=
literal|2
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bifc
operator|.
name|ifbic_len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|req
operator|=
name|bifc
operator|.
name|ifbic_req
operator|+
name|i
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s "
argument_list|,
name|prefix
argument_list|,
name|req
operator|->
name|ifbr_ifsname
argument_list|)
expr_stmt|;
name|printb
argument_list|(
literal|"flags"
argument_list|,
name|req
operator|->
name|ifbr_ifsflags
argument_list|,
name|IFBIFBITS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|flags
condition|)
continue|continue;
name|printf
argument_list|(
literal|"%s\t"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"port %u priority %u"
argument_list|,
name|req
operator|->
name|ifbr_portno
argument_list|,
name|req
operator|->
name|ifbr_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_STP
condition|)
block|{
name|printf
argument_list|(
literal|" path cost %u"
argument_list|,
name|req
operator|->
name|ifbr_path_cost
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ifbr_state
operator|<
sizeof|sizeof
argument_list|(
name|stpstates
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|stpstates
index|[
literal|0
index|]
argument_list|)
condition|)
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|stpstates
index|[
name|req
operator|->
name|ifbr_state
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<unknown state %d>"
argument_list|,
name|req
operator|->
name|ifbr_state
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|inbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bridge_addresses
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|ifbaconf
name|ifbac
decl_stmt|;
name|struct
name|ifbareq
modifier|*
name|ifba
decl_stmt|;
name|char
modifier|*
name|inbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|ninbuf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
init|=
literal|8192
decl_stmt|;
name|struct
name|ether_addr
name|ea
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ninbuf
operator|=
name|realloc
argument_list|(
name|inbuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ninbuf
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to allocate address buffer"
argument_list|)
expr_stmt|;
name|ifbac
operator|.
name|ifbac_len
operator|=
name|len
expr_stmt|;
name|ifbac
operator|.
name|ifbac_buf
operator|=
name|inbuf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGRTS
argument_list|,
operator|&
name|ifbac
argument_list|,
sizeof|sizeof
argument_list|(
name|ifbac
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get address cache"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifbac
operator|.
name|ifbac_len
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ifba
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|*=
literal|2
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ifbac
operator|.
name|ifbac_len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|ifba
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ifba
operator|=
name|ifbac
operator|.
name|ifbac_req
operator|+
name|i
expr_stmt|;
name|memcpy
argument_list|(
name|ea
operator|.
name|octet
argument_list|,
name|ifba
operator|->
name|ifba_dst
argument_list|,
sizeof|sizeof
argument_list|(
name|ea
operator|.
name|octet
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s %s %lu "
argument_list|,
name|prefix
argument_list|,
name|ether_ntoa
argument_list|(
operator|&
name|ea
argument_list|)
argument_list|,
name|ifba
operator|->
name|ifba_ifsname
argument_list|,
name|ifba
operator|->
name|ifba_expire
argument_list|)
expr_stmt|;
name|printb
argument_list|(
literal|"flags"
argument_list|,
name|ifba
operator|->
name|ifba_flags
argument_list|,
name|IFBAFBITS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|inbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_add
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGADD
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGADD %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_delete
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGDEL
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGDEL %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_discover
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_DISCOVER
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unsetbridge_discover
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_DISCOVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_learn
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_LEARNING
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unsetbridge_learn
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_LEARNING
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_span
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGADDS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGADDS %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unsetbridge_span
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGDELS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGDELS %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_stp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_STP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unsetbridge_stp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_STP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_flush
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_ifsflags
operator|=
name|IFBF_FLUSHDYN
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGFLUSH
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGFLUSH"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_flushall
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_ifsflags
operator|=
name|IFBF_FLUSHALL
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGFLUSH
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGFLUSH"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_static
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|mac
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbareq
name|req
decl_stmt|;
name|struct
name|ether_addr
modifier|*
name|ea
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifba_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifba_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|ea
operator|=
name|ether_aton
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ea
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: invalid address: %s"
argument_list|,
name|val
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|,
name|ea
operator|->
name|octet
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifba_flags
operator|=
name|IFBAF_STATIC
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSADDR
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSADDR %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_deladdr
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbareq
name|req
decl_stmt|;
name|struct
name|ether_addr
modifier|*
name|ea
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|ea
operator|=
name|ether_aton
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ea
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid address: %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|,
name|ea
operator|->
name|octet
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGDADDR
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGDADDR %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_addr
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|bridge_addresses
argument_list|(
name|s
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_maxaddr
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xffffffff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_csize
operator|=
name|val
operator|&
literal|0xffffffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSCACHE
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSCACHE %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_hellotime
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_hellotime
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSHT
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSHT %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_fwddelay
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_fwddelay
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSFD
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSFD %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_maxage
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_maxage
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSMA
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSMA %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_priority
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xffff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_prio
operator|=
name|val
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSPRI
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSPRI %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_ifpriority
parameter_list|(
specifier|const
name|char
modifier|*
name|ifn
parameter_list|,
specifier|const
name|char
modifier|*
name|pri
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|pri
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|pri
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|ifn
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_priority
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSIFPRIO
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSIFPRIO %s"
argument_list|,
name|pri
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_ifpathcost
parameter_list|(
specifier|const
name|char
modifier|*
name|ifn
parameter_list|,
specifier|const
name|char
modifier|*
name|cost
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|cost
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|cost
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|ifn
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_path_cost
operator|=
name|val
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSIFCOST
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSIFCOST %s"
argument_list|,
name|cost
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|setbridge_timeout
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xffffffff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_ctime
operator|=
name|val
operator|&
literal|0xffffffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSTO
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSTO %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|get_val
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
name|u_long
modifier|*
name|valp
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|cp
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|||
name|endptr
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|||
name|errno
operator|==
name|ERANGE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
name|valp
operator|=
name|val
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|do_cmd
parameter_list|(
name|int
name|sock
parameter_list|,
name|u_long
name|op
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|size_t
name|argsize
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ifd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|op
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
name|argsize
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
name|arg
expr_stmt|;
return|return
operator|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|set
condition|?
name|SIOCSDRVSPEC
else|:
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|do_bridgeflag
parameter_list|(
name|int
name|sock
parameter_list|,
specifier|const
name|char
modifier|*
name|ifs
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|ifs
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|sock
argument_list|,
name|BRDGGIFFLGS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get bridge flags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
condition|)
name|req
operator|.
name|ifbr_ifsflags
operator||=
name|flag
expr_stmt|;
else|else
name|req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|flag
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|sock
argument_list|,
name|BRDGSIFFLGS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to set bridge flags"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2001 Wasabi Systems, Inc.  * All rights reserved.  *  * Written by Jason R. Thorpe for Wasabi Systems, Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed for the NetBSD Project by  *	Wasabi Systems, Inc.  * 4. The name of Wasabi Systems, Inc. may not be used to endorse  *    or promote products derived from this software without specific prior  *    written permission.  *  * THIS SOFTWARE IS PROVIDED BY WASABI SYSTEMS, INC. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL WASABI SYSTEMS, INC  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
init|=
literal|"$FreeBSD$"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not lint */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_bridgevar.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"ifconfig.h"
end_include

begin_define
define|#
directive|define
name|PV2ID
parameter_list|(
name|pv
parameter_list|,
name|epri
parameter_list|,
name|eaddr
parameter_list|)
value|do {		\ 		epri     = pv>> 48;		\ 		eaddr[0] = pv>> 40;		\ 		eaddr[1] = pv>> 32;		\ 		eaddr[2] = pv>> 24;		\ 		eaddr[3] = pv>> 16;		\ 		eaddr[4] = pv>> 8;		\ 		eaddr[5] = pv>> 0;		\ } while (0)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|stpstates
index|[]
init|=
block|{
literal|"disabled"
block|,
literal|"listening"
block|,
literal|"learning"
block|,
literal|"forwarding"
block|,
literal|"blocking"
block|,
literal|"discarding"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|stpproto
index|[]
init|=
block|{
literal|"stp"
block|,
literal|"-"
block|,
literal|"rstp"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|stproles
index|[]
init|=
block|{
literal|"disabled"
block|,
literal|"root"
block|,
literal|"designated"
block|,
literal|"alternate"
block|,
literal|"backup"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|get_val
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
name|u_long
modifier|*
name|valp
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|cp
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|||
name|endptr
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|||
name|errno
operator|==
name|ERANGE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
name|valp
operator|=
name|val
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_cmd
parameter_list|(
name|int
name|sock
parameter_list|,
name|u_long
name|op
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|size_t
name|argsize
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ifd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|op
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
name|argsize
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
name|arg
expr_stmt|;
return|return
operator|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|set
condition|?
name|SIOCSDRVSPEC
else|:
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|do_bridgeflag
parameter_list|(
name|int
name|sock
parameter_list|,
specifier|const
name|char
modifier|*
name|ifs
parameter_list|,
name|int
name|flag
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|ifs
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|sock
argument_list|,
name|BRDGGIFFLGS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get bridge flags"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set
condition|)
name|req
operator|.
name|ifbr_ifsflags
operator||=
name|flag
expr_stmt|;
else|else
name|req
operator|.
name|ifbr_ifsflags
operator|&=
operator|~
name|flag
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|sock
argument_list|,
name|BRDGSIFFLGS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to set bridge flags"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bridge_interfaces
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|ifbifconf
name|bifc
decl_stmt|;
name|struct
name|ifbreq
modifier|*
name|req
decl_stmt|;
name|char
modifier|*
name|inbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|ninbuf
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|pad
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
init|=
literal|8192
decl_stmt|;
name|pad
operator|=
name|strdup
argument_list|(
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|pad
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"strdup"
argument_list|)
expr_stmt|;
comment|/* replace the prefix with whitespace */
for|for
control|(
name|p
operator|=
name|pad
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
name|isprint
argument_list|(
operator|*
name|p
argument_list|)
condition|)
operator|*
name|p
operator|=
literal|' '
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|ninbuf
operator|=
name|realloc
argument_list|(
name|inbuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ninbuf
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to allocate interface buffer"
argument_list|)
expr_stmt|;
name|bifc
operator|.
name|ifbic_len
operator|=
name|len
expr_stmt|;
name|bifc
operator|.
name|ifbic_buf
operator|=
name|inbuf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGIFS
argument_list|,
operator|&
name|bifc
argument_list|,
sizeof|sizeof
argument_list|(
name|bifc
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get interface list"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|bifc
operator|.
name|ifbic_len
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|*=
literal|2
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bifc
operator|.
name|ifbic_len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|req
operator|=
name|bifc
operator|.
name|ifbic_req
operator|+
name|i
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s "
argument_list|,
name|prefix
argument_list|,
name|req
operator|->
name|ifbr_ifsname
argument_list|)
expr_stmt|;
name|printb
argument_list|(
literal|"flags"
argument_list|,
name|req
operator|->
name|ifbr_ifsflags
argument_list|,
name|IFBIFBITS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ifbr_ifsflags
operator|&
name|IFBIF_STP
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|pad
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"port %u priority %u"
argument_list|,
name|req
operator|->
name|ifbr_portno
argument_list|,
name|req
operator|->
name|ifbr_priority
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" path cost %u"
argument_list|,
name|req
operator|->
name|ifbr_path_cost
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ifbr_proto
operator|<
sizeof|sizeof
argument_list|(
name|stpproto
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|stpproto
index|[
literal|0
index|]
argument_list|)
condition|)
name|printf
argument_list|(
literal|" proto %s"
argument_list|,
name|stpproto
index|[
name|req
operator|->
name|ifbr_proto
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<unknown proto %d>"
argument_list|,
name|req
operator|->
name|ifbr_proto
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n%s"
argument_list|,
name|pad
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ifbr_role
operator|<
sizeof|sizeof
argument_list|(
name|stproles
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|stproles
index|[
literal|0
index|]
argument_list|)
condition|)
name|printf
argument_list|(
literal|"role %s"
argument_list|,
name|stproles
index|[
name|req
operator|->
name|ifbr_role
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<unknown role %d>"
argument_list|,
name|req
operator|->
name|ifbr_role
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|ifbr_state
operator|<
sizeof|sizeof
argument_list|(
name|stpstates
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|stpstates
index|[
literal|0
index|]
argument_list|)
condition|)
name|printf
argument_list|(
literal|" state %s"
argument_list|,
name|stpstates
index|[
name|req
operator|->
name|ifbr_state
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"<unknown state %d>"
argument_list|,
name|req
operator|->
name|ifbr_state
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
name|inbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bridge_addresses
parameter_list|(
name|int
name|s
parameter_list|,
specifier|const
name|char
modifier|*
name|prefix
parameter_list|)
block|{
name|struct
name|ifbaconf
name|ifbac
decl_stmt|;
name|struct
name|ifbareq
modifier|*
name|ifba
decl_stmt|;
name|char
modifier|*
name|inbuf
init|=
name|NULL
decl_stmt|,
modifier|*
name|ninbuf
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
init|=
literal|8192
decl_stmt|;
name|struct
name|ether_addr
name|ea
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ninbuf
operator|=
name|realloc
argument_list|(
name|inbuf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ninbuf
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to allocate address buffer"
argument_list|)
expr_stmt|;
name|ifbac
operator|.
name|ifbac_len
operator|=
name|len
expr_stmt|;
name|ifbac
operator|.
name|ifbac_buf
operator|=
name|inbuf
operator|=
name|ninbuf
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGRTS
argument_list|,
operator|&
name|ifbac
argument_list|,
sizeof|sizeof
argument_list|(
name|ifbac
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"unable to get address cache"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifbac
operator|.
name|ifbac_len
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ifba
argument_list|)
operator|)
operator|<
name|len
condition|)
break|break;
name|len
operator|*=
literal|2
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ifbac
operator|.
name|ifbac_len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|ifba
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ifba
operator|=
name|ifbac
operator|.
name|ifbac_req
operator|+
name|i
expr_stmt|;
name|memcpy
argument_list|(
name|ea
operator|.
name|octet
argument_list|,
name|ifba
operator|->
name|ifba_dst
argument_list|,
sizeof|sizeof
argument_list|(
name|ea
operator|.
name|octet
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s%s Vlan%d %s %lu "
argument_list|,
name|prefix
argument_list|,
name|ether_ntoa
argument_list|(
operator|&
name|ea
argument_list|)
argument_list|,
name|ifba
operator|->
name|ifba_vlan
argument_list|,
name|ifba
operator|->
name|ifba_ifsname
argument_list|,
name|ifba
operator|->
name|ifba_expire
argument_list|)
expr_stmt|;
name|printb
argument_list|(
literal|"flags"
argument_list|,
name|ifba
operator|->
name|ifba_flags
argument_list|,
name|IFBAFBITS
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|inbuf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bridge_status
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|struct
name|ifbropreq
name|ifbp
decl_stmt|;
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_int16_t
name|pri
decl_stmt|;
name|u_int8_t
name|ht
decl_stmt|,
name|fd
decl_stmt|,
name|ma
decl_stmt|,
name|hc
decl_stmt|,
name|pro
decl_stmt|;
name|u_int8_t
name|lladdr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|u_int16_t
name|bprio
decl_stmt|;
name|u_int32_t
name|csize
decl_stmt|,
name|ctime
decl_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGCACHE
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|csize
operator|=
name|param
operator|.
name|ifbrp_csize
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGGTO
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|ctime
operator|=
name|param
operator|.
name|ifbrp_ctime
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGPARAM
argument_list|,
operator|&
name|ifbp
argument_list|,
sizeof|sizeof
argument_list|(
name|ifbp
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|pri
operator|=
name|ifbp
operator|.
name|ifbop_priority
expr_stmt|;
name|pro
operator|=
name|ifbp
operator|.
name|ifbop_protocol
expr_stmt|;
name|ht
operator|=
name|ifbp
operator|.
name|ifbop_hellotime
expr_stmt|;
name|fd
operator|=
name|ifbp
operator|.
name|ifbop_fwddelay
expr_stmt|;
name|hc
operator|=
name|ifbp
operator|.
name|ifbop_holdcount
expr_stmt|;
name|ma
operator|=
name|ifbp
operator|.
name|ifbop_maxage
expr_stmt|;
name|PV2ID
argument_list|(
name|ifbp
operator|.
name|ifbop_bridgeid
argument_list|,
name|bprio
argument_list|,
name|lladdr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tid %s priority %u hellotime %u fwddelay %u\n"
argument_list|,
name|ether_ntoa
argument_list|(
operator|(
expr|struct
name|ether_addr
operator|*
operator|)
name|lladdr
argument_list|)
argument_list|,
name|pri
argument_list|,
name|ht
argument_list|,
name|fd
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tmaxage %u holdcnt %u proto %s maxaddr %u timeout %u\n"
argument_list|,
name|ma
argument_list|,
name|hc
argument_list|,
name|stpproto
index|[
name|pro
index|]
argument_list|,
name|csize
argument_list|,
name|ctime
argument_list|)
expr_stmt|;
name|PV2ID
argument_list|(
name|ifbp
operator|.
name|ifbop_designated_root
argument_list|,
name|bprio
argument_list|,
name|lladdr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\troot id %s priority %d ifcost %u port %u\n"
argument_list|,
name|ether_ntoa
argument_list|(
operator|(
expr|struct
name|ether_addr
operator|*
operator|)
name|lladdr
argument_list|)
argument_list|,
name|bprio
argument_list|,
name|ifbp
operator|.
name|ifbop_root_path_cost
argument_list|,
name|ifbp
operator|.
name|ifbop_root_port
operator|&
literal|0xfff
argument_list|)
expr_stmt|;
name|bridge_interfaces
argument_list|(
name|s
argument_list|,
literal|"\tmember: "
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_add
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGADD
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGADD %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_delete
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGDEL
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGDEL %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_discover
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_DISCOVER
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_discover
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_DISCOVER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_learn
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_LEARNING
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_learn
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_LEARNING
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_sticky
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_STICKY
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_sticky
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_STICKY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_span
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGADDS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGADDS %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_span
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGDELS
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGDELS %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_stp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_STP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_stp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_STP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_edge
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_EDGE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_edge
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_EDGE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_autoedge
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_AUTOEDGE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_autoedge
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_AUTOEDGE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_ptp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_PTP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_ptp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_PTP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_autoptp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_AUTOPTP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unsetbridge_autoptp
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|do_bridgeflag
argument_list|(
name|s
argument_list|,
name|val
argument_list|,
name|IFBIF_BSTP_AUTOPTP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_flush
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_ifsflags
operator|=
name|IFBF_FLUSHDYN
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGFLUSH
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGFLUSH"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_flushall
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_ifsflags
operator|=
name|IFBF_FLUSHALL
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGFLUSH
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGFLUSH"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_static
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
specifier|const
name|char
modifier|*
name|mac
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbareq
name|req
decl_stmt|;
name|struct
name|ether_addr
modifier|*
name|ea
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifba_ifsname
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifba_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|ea
operator|=
name|ether_aton
argument_list|(
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|ea
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"%s: invalid address: %s"
argument_list|,
name|val
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|,
name|ea
operator|->
name|octet
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifba_flags
operator|=
name|IFBAF_STATIC
expr_stmt|;
name|req
operator|.
name|ifba_vlan
operator|=
literal|1
expr_stmt|;
comment|/* XXX allow user to specify */
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSADDR
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSADDR %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_deladdr
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbareq
name|req
decl_stmt|;
name|struct
name|ether_addr
modifier|*
name|ea
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|ea
operator|=
name|ether_aton
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ea
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid address: %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|,
name|ea
operator|->
name|octet
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifba_dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGDADDR
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGDADDR %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_addr
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|bridge_addresses
argument_list|(
name|s
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_maxaddr
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xffffffff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_csize
operator|=
name|val
operator|&
literal|0xffffffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSCACHE
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSCACHE %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_hellotime
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_hellotime
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSHT
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSHT %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_fwddelay
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_fwddelay
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSFD
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSFD %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_maxage
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_maxage
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSMA
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSMA %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_priority
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xffff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_prio
operator|=
name|val
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSPRI
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSPRI %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_protocol
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"stp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|param
operator|.
name|ifbrp_proto
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|arg
argument_list|,
literal|"rstp"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|param
operator|.
name|ifbrp_proto
operator|=
literal|2
expr_stmt|;
block|}
else|else
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unknown stp protocol"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSPROTO
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSPROTO %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_holdcount
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_txhc
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSTXHC
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSTXHC %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_ifpriority
parameter_list|(
specifier|const
name|char
modifier|*
name|ifn
parameter_list|,
specifier|const
name|char
modifier|*
name|pri
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|pri
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|pri
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|ifn
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_priority
operator|=
name|val
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSIFPRIO
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSIFPRIO %s"
argument_list|,
name|pri
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_ifpathcost
parameter_list|(
specifier|const
name|char
modifier|*
name|ifn
parameter_list|,
specifier|const
name|char
modifier|*
name|cost
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbreq
name|req
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|memset
argument_list|(
operator|&
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|cost
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|cost
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|,
name|ifn
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|ifbr_ifsname
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|ifbr_path_cost
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSIFCOST
argument_list|,
operator|&
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSIFCOST %s"
argument_list|,
name|cost
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setbridge_timeout
parameter_list|(
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifbrparam
name|param
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xffffffff
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|param
operator|.
name|ifbrp_ctime
operator|=
name|val
operator|&
literal|0xffffffff
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|BRDGSTO
argument_list|,
operator|&
name|param
argument_list|,
sizeof|sizeof
argument_list|(
name|param
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"BRDGSTO %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|cmd
name|bridge_cmds
index|[]
init|=
block|{
name|DEF_CMD_ARG
argument_list|(
literal|"addm"
argument_list|,
name|setbridge_add
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"deletem"
argument_list|,
name|setbridge_delete
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"discover"
argument_list|,
name|setbridge_discover
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-discover"
argument_list|,
name|unsetbridge_discover
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"learn"
argument_list|,
name|setbridge_learn
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-learn"
argument_list|,
name|unsetbridge_learn
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"sticky"
argument_list|,
name|setbridge_sticky
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-sticky"
argument_list|,
name|unsetbridge_sticky
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"span"
argument_list|,
name|setbridge_span
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-span"
argument_list|,
name|unsetbridge_span
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"stp"
argument_list|,
name|setbridge_stp
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-stp"
argument_list|,
name|unsetbridge_stp
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"edge"
argument_list|,
name|setbridge_edge
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-edge"
argument_list|,
name|unsetbridge_edge
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"autoedge"
argument_list|,
name|setbridge_autoedge
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-autoedge"
argument_list|,
name|unsetbridge_autoedge
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"ptp"
argument_list|,
name|setbridge_ptp
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-ptp"
argument_list|,
name|unsetbridge_ptp
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"autoptp"
argument_list|,
name|setbridge_autoptp
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"-autoptp"
argument_list|,
name|unsetbridge_autoptp
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"flush"
argument_list|,
literal|0
argument_list|,
name|setbridge_flush
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"flushall"
argument_list|,
literal|0
argument_list|,
name|setbridge_flushall
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"static"
argument_list|,
name|setbridge_static
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"deladdr"
argument_list|,
name|setbridge_deladdr
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"addr"
argument_list|,
literal|1
argument_list|,
name|setbridge_addr
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"maxaddr"
argument_list|,
name|setbridge_maxaddr
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"hellotime"
argument_list|,
name|setbridge_hellotime
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"fwddelay"
argument_list|,
name|setbridge_fwddelay
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"maxage"
argument_list|,
name|setbridge_maxage
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"priority"
argument_list|,
name|setbridge_priority
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"proto"
argument_list|,
name|setbridge_protocol
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"holdcnt"
argument_list|,
name|setbridge_holdcount
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"ifpriority"
argument_list|,
name|setbridge_ifpriority
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"ifpathcost"
argument_list|,
name|setbridge_ifpathcost
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"timeout"
argument_list|,
name|setbridge_timeout
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|afswtch
name|af_bridge
init|=
block|{
operator|.
name|af_name
operator|=
literal|"af_bridge"
block|,
operator|.
name|af_af
operator|=
name|AF_UNSPEC
block|,
operator|.
name|af_other_status
operator|=
name|bridge_status
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__constructor
name|void
name|bridge_ctor
parameter_list|(
name|void
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|bridge_cmds
argument_list|)
condition|;
name|i
operator|++
control|)
name|cmd_register
argument_list|(
operator|&
name|bridge_cmds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|af_register
argument_list|(
operator|&
name|af_bridge
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|N
block|}
end_function

end_unit


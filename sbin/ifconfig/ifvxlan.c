begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014, Bryan Venteicher<bryanv@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<stdint.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vxlan.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|"ifconfig.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|ifvxlanparam
name|params
init|=
block|{
operator|.
name|vxlp_vni
operator|=
name|VXLAN_VNI_MAX
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|get_val
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
name|u_long
modifier|*
name|valp
parameter_list|)
block|{
name|char
modifier|*
name|endptr
decl_stmt|;
name|u_long
name|val
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|val
operator|=
name|strtoul
argument_list|(
name|cp
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|||
name|endptr
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|||
name|errno
operator|==
name|ERANGE
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
name|valp
operator|=
name|val
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_cmd
parameter_list|(
name|int
name|sock
parameter_list|,
name|u_long
name|op
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|size_t
name|argsize
parameter_list|,
name|int
name|set
parameter_list|)
block|{
name|struct
name|ifdrv
name|ifd
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifd
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|,
name|ifr
operator|.
name|ifr_name
argument_list|,
sizeof|sizeof
argument_list|(
name|ifd
operator|.
name|ifd_name
argument_list|)
argument_list|)
expr_stmt|;
name|ifd
operator|.
name|ifd_cmd
operator|=
name|op
expr_stmt|;
name|ifd
operator|.
name|ifd_len
operator|=
name|argsize
expr_stmt|;
name|ifd
operator|.
name|ifd_data
operator|=
name|arg
expr_stmt|;
return|return
operator|(
name|ioctl
argument_list|(
name|sock
argument_list|,
name|set
condition|?
name|SIOCSDRVSPEC
else|:
name|SIOCGDRVSPEC
argument_list|,
operator|&
name|ifd
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_exists
parameter_list|(
name|int
name|sock
parameter_list|)
block|{
name|struct
name|ifvxlancfg
name|cfg
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|cfg
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|do_cmd
argument_list|(
name|sock
argument_list|,
name|VXLAN_CMD_GET_CONFIG
argument_list|,
operator|&
name|cfg
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|!=
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_status
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|struct
name|ifvxlancfg
name|cfg
decl_stmt|;
name|char
name|src
index|[
name|NI_MAXHOST
index|]
decl_stmt|,
name|dst
index|[
name|NI_MAXHOST
index|]
decl_stmt|;
name|char
name|srcport
index|[
name|NI_MAXSERV
index|]
decl_stmt|,
name|dstport
index|[
name|NI_MAXSERV
index|]
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|lsa
decl_stmt|,
modifier|*
name|rsa
decl_stmt|;
name|int
name|vni
decl_stmt|,
name|mc
decl_stmt|,
name|ipv6
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|cfg
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_GET_CONFIG
argument_list|,
operator|&
name|cfg
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|vni
operator|=
name|cfg
operator|.
name|vxlc_vni
expr_stmt|;
name|lsa
operator|=
operator|&
name|cfg
operator|.
name|vxlc_local_sa
operator|.
name|sa
expr_stmt|;
name|rsa
operator|=
operator|&
name|cfg
operator|.
name|vxlc_remote_sa
operator|.
name|sa
expr_stmt|;
name|ipv6
operator|=
name|rsa
operator|->
name|sa_family
operator|==
name|AF_INET6
expr_stmt|;
comment|/* Just report nothing if the network identity isn't set yet. */
if|if
condition|(
name|vni
operator|>=
name|VXLAN_VNI_MAX
condition|)
return|return;
if|if
condition|(
name|getnameinfo
argument_list|(
name|lsa
argument_list|,
name|lsa
operator|->
name|sa_len
argument_list|,
name|src
argument_list|,
sizeof|sizeof
argument_list|(
name|src
argument_list|)
argument_list|,
name|srcport
argument_list|,
sizeof|sizeof
argument_list|(
name|srcport
argument_list|)
argument_list|,
name|NI_NUMERICHOST
operator||
name|NI_NUMERICSERV
argument_list|)
operator|!=
literal|0
condition|)
name|src
index|[
literal|0
index|]
operator|=
name|srcport
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|getnameinfo
argument_list|(
name|rsa
argument_list|,
name|rsa
operator|->
name|sa_len
argument_list|,
name|dst
argument_list|,
sizeof|sizeof
argument_list|(
name|dst
argument_list|)
argument_list|,
name|dstport
argument_list|,
sizeof|sizeof
argument_list|(
name|dstport
argument_list|)
argument_list|,
name|NI_NUMERICHOST
operator||
name|NI_NUMERICSERV
argument_list|)
operator|!=
literal|0
condition|)
name|dst
index|[
literal|0
index|]
operator|=
name|dstport
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|ipv6
condition|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|rsa
decl_stmt|;
name|mc
operator|=
name|IN_MULTICAST
argument_list|(
name|ntohl
argument_list|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|sockaddr_in6
modifier|*
name|sin6
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|rsa
decl_stmt|;
name|mc
operator|=
name|IN6_IS_ADDR_MULTICAST
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\tvxlan vni %d"
argument_list|,
name|vni
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" local %s%s%s:%s"
argument_list|,
name|ipv6
condition|?
literal|"["
else|:
literal|""
argument_list|,
name|src
argument_list|,
name|ipv6
condition|?
literal|"]"
else|:
literal|""
argument_list|,
name|srcport
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s %s%s%s:%s"
argument_list|,
name|mc
condition|?
literal|"group"
else|:
literal|"remote"
argument_list|,
name|ipv6
condition|?
literal|"["
else|:
literal|""
argument_list|,
name|dst
argument_list|,
name|ipv6
condition|?
literal|"]"
else|:
literal|""
argument_list|,
name|dstport
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\n\t\tconfig: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%slearning portrange %d-%d ttl %d"
argument_list|,
name|cfg
operator|.
name|vxlc_learn
condition|?
literal|""
else|:
literal|"no"
argument_list|,
name|cfg
operator|.
name|vxlc_port_min
argument_list|,
name|cfg
operator|.
name|vxlc_port_max
argument_list|,
name|cfg
operator|.
name|vxlc_ttl
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\t\tftable: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cnt %d max %d timeout %d"
argument_list|,
name|cfg
operator|.
name|vxlc_ftable_cnt
argument_list|,
name|cfg
operator|.
name|vxlc_ftable_max
argument_list|,
name|cfg
operator|.
name|vxlc_ftable_timeout
argument_list|)
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|_LOCAL_ADDR46
define|\
value|(VXLAN_PARAM_WITH_LOCAL_ADDR4 | VXLAN_PARAM_WITH_LOCAL_ADDR6)
end_define

begin_define
define|#
directive|define
name|_REMOTE_ADDR46
define|\
value|(VXLAN_PARAM_WITH_REMOTE_ADDR4 | VXLAN_PARAM_WITH_REMOTE_ADDR6)
end_define

begin_function
specifier|static
name|void
name|vxlan_check_params
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|(
name|params
operator|.
name|vxlp_with
operator|&
name|_LOCAL_ADDR46
operator|)
operator|==
name|_LOCAL_ADDR46
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"cannot specify both local IPv4 and IPv6 addresses"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|.
name|vxlp_with
operator|&
name|_REMOTE_ADDR46
operator|)
operator|==
name|_REMOTE_ADDR46
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"cannot specify both remote IPv4 and IPv6 addresses"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|.
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_LOCAL_ADDR4
operator|&&
name|params
operator|.
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_REMOTE_ADDR6
operator|)
operator|||
operator|(
name|params
operator|.
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_LOCAL_ADDR6
operator|&&
name|params
operator|.
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_REMOTE_ADDR4
operator|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"cannot mix IPv4 and IPv6 addresses"
argument_list|)
expr_stmt|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|_LOCAL_ADDR46
end_undef

begin_undef
undef|#
directive|undef
name|_REMOTE_ADDR46
end_undef

begin_function
specifier|static
name|void
name|vxlan_cb
parameter_list|(
name|int
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{  }
end_function

begin_function
specifier|static
name|void
name|vxlan_create
parameter_list|(
name|int
name|s
parameter_list|,
name|struct
name|ifreq
modifier|*
name|ifr
parameter_list|)
block|{
name|vxlan_check_params
argument_list|()
expr_stmt|;
name|ifr
operator|->
name|ifr_data
operator|=
operator|(
name|caddr_t
operator|)
operator|&
name|params
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCIFCREATE2
argument_list|,
name|ifr
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"SIOCIFCREATE2"
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_vni
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
block|{ 	struct
name|ifvxlancmd
name|cmd
block|;
name|u_long
name|val
block|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
name|val
operator|>=
name|VXLAN_VNI_MAX
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid network identifier: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_VNI
expr_stmt|;
name|params
operator|.
name|vxlp_vni
operator|=
name|val
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cmd
operator|.
name|vxlcmd_vni
operator|=
name|val
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_VNI
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_VNI"
argument_list|)
expr_stmt|;
end_if

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_local
argument_list|,
argument|addr
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|getaddrinfo
argument_list|(
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ai
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"error in parsing local address string: %s"
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
name|ai
operator|->
name|ai_addr
expr_stmt|;
switch|switch
condition|(
name|ai
operator|->
name|ai_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|addr
init|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
decl_stmt|;
if|if
condition|(
name|IN_MULTICAST
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|.
name|s_addr
argument_list|)
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"local address cannot be multicast"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_addr
operator|=
name|addr
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|in6_addr
modifier|*
name|addr
init|=
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin6_addr
decl_stmt|;
if|if
condition|(
name|IN6_IS_ADDR_MULTICAST
argument_list|(
name|addr
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"local address cannot be multicast"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
operator|*
name|addr
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"local address %s not supported"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
name|freeaddrinfo
argument_list|(
name|ai
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
if|if
condition|(
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_LOCAL_ADDR4
expr_stmt|;
name|params
operator|.
name|vxlp_local_in4
operator|=
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_addr
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_LOCAL_ADDR6
expr_stmt|;
name|params
operator|.
name|vxlp_local_in6
operator|=
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_addr
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_LOCAL_ADDR
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_LOCAL_ADDR"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_remote
argument_list|,
argument|addr
argument_list|,
argument|d
argument_list|)
block|{ 	struct
name|ifvxlancmd
name|cmd
block|; 	struct
name|addrinfo
operator|*
name|ai
block|; 	struct
name|sockaddr
operator|*
name|sa
block|;
name|int
name|error
block|;
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
block|;
if|if
condition|(
operator|(
name|error
operator|=
name|getaddrinfo
argument_list|(
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ai
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"error in parsing remote address string: %s"
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
name|ai
operator|->
name|ai_addr
expr_stmt|;
end_expr_stmt

begin_switch
switch|switch
condition|(
name|ai
operator|->
name|ai_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|addr
init|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
decl_stmt|;
if|if
condition|(
name|IN_MULTICAST
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|.
name|s_addr
argument_list|)
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"remote address cannot be multicast"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_addr
operator|=
name|addr
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|in6_addr
modifier|*
name|addr
init|=
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin6_addr
decl_stmt|;
if|if
condition|(
name|IN6_IS_ADDR_MULTICAST
argument_list|(
name|addr
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"remote address cannot be multicast"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
operator|*
name|addr
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"remote address %s not supported"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_switch

begin_expr_stmt
name|freeaddrinfo
argument_list|(
name|ai
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
if|if
condition|(
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_REMOTE_ADDR4
expr_stmt|;
name|params
operator|.
name|vxlp_remote_in4
operator|=
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_addr
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_REMOTE_ADDR6
expr_stmt|;
name|params
operator|.
name|vxlp_remote_in6
operator|=
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_addr
expr_stmt|;
block|}
return|return;
block|}
end_if

begin_if
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_REMOTE_ADDR
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_REMOTE_ADDR"
argument_list|)
expr_stmt|;
end_if

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_group
argument_list|,
argument|addr
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
name|struct
name|addrinfo
modifier|*
name|ai
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|getaddrinfo
argument_list|(
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|ai
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"error in parsing group address string: %s"
argument_list|,
name|gai_strerror
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|=
name|ai
operator|->
name|ai_addr
expr_stmt|;
switch|switch
condition|(
name|ai
operator|->
name|ai_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|struct
name|in_addr
name|addr
init|=
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin_addr
decl_stmt|;
if|if
condition|(
operator|!
name|IN_MULTICAST
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|.
name|s_addr
argument_list|)
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"group address must be multicast"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_addr
operator|=
name|addr
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|in6_addr
modifier|*
name|addr
init|=
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|sa
operator|)
operator|->
name|sin6_addr
decl_stmt|;
if|if
condition|(
operator|!
name|IN6_IS_ADDR_MULTICAST
argument_list|(
name|addr
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"group address must be multicast"
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
operator|*
name|addr
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
default|default:
name|errx
argument_list|(
literal|1
argument_list|,
literal|"group address %s not supported"
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
name|freeaddrinfo
argument_list|(
name|ai
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
if|if
condition|(
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_REMOTE_ADDR4
expr_stmt|;
name|params
operator|.
name|vxlp_remote_in4
operator|=
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in4
operator|.
name|sin_addr
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_REMOTE_ADDR6
expr_stmt|;
name|params
operator|.
name|vxlp_remote_in6
operator|=
name|cmd
operator|.
name|vxlcmd_sa
operator|.
name|in6
operator|.
name|sin6_addr
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_REMOTE_ADDR
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_REMOTE_ADDR"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_local_port
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
block|{ 	struct
name|ifvxlancmd
name|cmd
block|;
name|u_long
name|val
block|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
name|val
operator|>=
name|UINT16_MAX
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid local port: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_LOCAL_PORT
expr_stmt|;
name|params
operator|.
name|vxlp_local_port
operator|=
name|val
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cmd
operator|.
name|vxlcmd_port
operator|=
name|val
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_LOCAL_PORT
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_LOCAL_PORT"
argument_list|)
expr_stmt|;
end_if

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_remote_port
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
name|val
operator|>=
name|UINT16_MAX
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid remote port: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_REMOTE_PORT
expr_stmt|;
name|params
operator|.
name|vxlp_remote_port
operator|=
name|val
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_port
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_REMOTE_PORT
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_REMOTE_PORT"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC2
argument_list|(
argument|setvxlan_port_range
argument_list|,
argument|arg1
argument_list|,
argument|arg2
argument_list|)
block|{ 	struct
name|ifvxlancmd
name|cmd
block|;
name|u_long
name|min
block|,
name|max
block|;
if|if
condition|(
name|get_val
argument_list|(
name|arg1
argument_list|,
operator|&
name|min
argument_list|)
operator|<
literal|0
operator|||
name|min
operator|>=
name|UINT16_MAX
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid port range minimum: %s"
argument_list|,
name|arg1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|get_val
argument_list|(
name|arg2
argument_list|,
operator|&
name|max
argument_list|)
operator|<
literal|0
operator|||
name|max
operator|>=
name|UINT16_MAX
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid port range maximum: %s"
argument_list|,
name|arg2
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
name|max
operator|<
name|min
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid port range"
argument_list|)
expr_stmt|;
end_if

begin_if
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_PORT_RANGE
expr_stmt|;
name|params
operator|.
name|vxlp_min_port
operator|=
name|min
expr_stmt|;
name|params
operator|.
name|vxlp_max_port
operator|=
name|max
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cmd
operator|.
name|vxlcmd_port_min
operator|=
name|min
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cmd
operator|.
name|vxlcmd_port_max
operator|=
name|max
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_PORT_RANGE
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_PORT_RANGE"
argument_list|)
expr_stmt|;
end_if

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_timeout
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
name|u_long
name|val
decl_stmt|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xFFFFFFFF
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid timeout value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_FTABLE_TIMEOUT
expr_stmt|;
name|params
operator|.
name|vxlp_ftable_timeout
operator|=
name|val
operator|&
literal|0xFFFFFFFF
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|vxlcmd_ftable_timeout
operator|=
name|val
operator|&
literal|0xFFFFFFFF
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_FTABLE_TIMEOUT
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_FTABLE_TIMEOUT"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_maxaddr
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
block|{ 	struct
name|ifvxlancmd
name|cmd
block|;
name|u_long
name|val
block|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|val
operator|&
operator|~
literal|0xFFFFFFFF
operator|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid maxaddr value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_FTABLE_MAX
expr_stmt|;
name|params
operator|.
name|vxlp_ftable_max
operator|=
name|val
operator|&
literal|0xFFFFFFFF
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cmd
operator|.
name|vxlcmd_ftable_max
operator|=
name|val
operator|&
literal|0xFFFFFFFF
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_FTABLE_MAX
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_FTABLE_MAX"
argument_list|)
expr_stmt|;
end_if

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_dev
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_MULTICAST_IF
expr_stmt|;
name|strlcpy
argument_list|(
name|params
operator|.
name|vxlp_mc_ifname
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|.
name|vxlp_mc_ifname
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|cmd
operator|.
name|vxlcmd_ifname
argument_list|,
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
operator|.
name|vxlcmd_ifname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_MULTICAST_IF
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_MULTICAST_IF"
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_ttl
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
block|{ 	struct
name|ifvxlancmd
name|cmd
block|;
name|u_long
name|val
block|;
if|if
condition|(
name|get_val
argument_list|(
name|arg
argument_list|,
operator|&
name|val
argument_list|)
operator|<
literal|0
operator|||
name|val
operator|>
literal|256
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"invalid TTL value: %s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_TTL
expr_stmt|;
name|params
operator|.
name|vxlp_ttl
operator|=
name|val
expr_stmt|;
return|return;
block|}
end_if

begin_expr_stmt
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|cmd
operator|.
name|vxlcmd_ttl
operator|=
name|val
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_TTL
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_TTL"
argument_list|)
expr_stmt|;
end_if

begin_macro
unit|}  static
name|DECL_CMD_FUNC
argument_list|(
argument|setvxlan_learn
argument_list|,
argument|arg
argument_list|,
argument|d
argument_list|)
end_macro

begin_block
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
if|if
condition|(
operator|!
name|vxlan_exists
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|params
operator|.
name|vxlp_with
operator||=
name|VXLAN_PARAM_WITH_LEARN
expr_stmt|;
name|params
operator|.
name|vxlp_learn
operator|=
name|d
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|!=
literal|0
condition|)
name|cmd
operator|.
name|vxlcmd_flags
operator||=
name|VXLAN_CMD_FLAG_LEARN
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_SET_LEARN
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_SET_LEARN"
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|setvxlan_flush
parameter_list|(
specifier|const
name|char
modifier|*
name|val
parameter_list|,
name|int
name|d
parameter_list|,
name|int
name|s
parameter_list|,
specifier|const
name|struct
name|afswtch
modifier|*
name|afp
parameter_list|)
block|{
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|!=
literal|0
condition|)
name|cmd
operator|.
name|vxlcmd_flags
operator||=
name|VXLAN_CMD_FLAG_FLUSH_ALL
expr_stmt|;
if|if
condition|(
name|do_cmd
argument_list|(
name|s
argument_list|,
name|VXLAN_CMD_FLUSH
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"VXLAN_CMD_FLUSH"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|cmd
name|vxlan_cmds
index|[]
init|=
block|{
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanid"
argument_list|,
name|setvxlan_vni
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanlocal"
argument_list|,
name|setvxlan_local
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanremote"
argument_list|,
name|setvxlan_remote
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlangroup"
argument_list|,
name|setvxlan_group
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanlocalport"
argument_list|,
name|setvxlan_local_port
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanremoteport"
argument_list|,
name|setvxlan_remote_port
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG2
argument_list|(
literal|"vxlanportrange"
argument_list|,
name|setvxlan_port_range
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlantimeout"
argument_list|,
name|setvxlan_timeout
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanmaxaddr"
argument_list|,
name|setvxlan_maxaddr
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlandev"
argument_list|,
name|setvxlan_dev
argument_list|)
block|,
name|DEF_CLONE_CMD_ARG
argument_list|(
literal|"vxlanttl"
argument_list|,
name|setvxlan_ttl
argument_list|)
block|,
name|DEF_CLONE_CMD
argument_list|(
literal|"vxlanlearn"
argument_list|,
literal|1
argument_list|,
name|setvxlan_learn
argument_list|)
block|,
name|DEF_CLONE_CMD
argument_list|(
literal|"-vxlanlearn"
argument_list|,
literal|0
argument_list|,
name|setvxlan_learn
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanvni"
argument_list|,
name|setvxlan_vni
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanlocal"
argument_list|,
name|setvxlan_local
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanremote"
argument_list|,
name|setvxlan_remote
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlangroup"
argument_list|,
name|setvxlan_group
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanlocalport"
argument_list|,
name|setvxlan_local_port
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanremoteport"
argument_list|,
name|setvxlan_remote_port
argument_list|)
block|,
name|DEF_CMD_ARG2
argument_list|(
literal|"vxlanportrange"
argument_list|,
name|setvxlan_port_range
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlantimeout"
argument_list|,
name|setvxlan_timeout
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanmaxaddr"
argument_list|,
name|setvxlan_maxaddr
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlandev"
argument_list|,
name|setvxlan_dev
argument_list|)
block|,
name|DEF_CMD_ARG
argument_list|(
literal|"vxlanttl"
argument_list|,
name|setvxlan_ttl
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"vxlanlearn"
argument_list|,
literal|1
argument_list|,
name|setvxlan_learn
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"-vxlanlearn"
argument_list|,
literal|0
argument_list|,
name|setvxlan_learn
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"vxlanflush"
argument_list|,
literal|0
argument_list|,
name|setvxlan_flush
argument_list|)
block|,
name|DEF_CMD
argument_list|(
literal|"vxlanflushall"
argument_list|,
literal|1
argument_list|,
name|setvxlan_flush
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|afswtch
name|af_vxlan
init|=
block|{
operator|.
name|af_name
operator|=
literal|"af_vxlan"
block|,
operator|.
name|af_af
operator|=
name|AF_UNSPEC
block|,
operator|.
name|af_other_status
operator|=
name|vxlan_status
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|__constructor
name|void
name|vxlan_ctor
parameter_list|(
name|void
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|vxlan_cmds
argument_list|)
condition|;
name|i
operator|++
control|)
name|cmd_register
argument_list|(
operator|&
name|vxlan_cmds
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|af_register
argument_list|(
operator|&
name|af_vxlan
argument_list|)
expr_stmt|;
name|callback_register
argument_list|(
name|vxlan_cb
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|clone_setdefcallback
argument_list|(
literal|"vxlan"
argument_list|,
name|vxlan_create
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|N
block|}
end_function

end_unit


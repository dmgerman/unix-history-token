begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Channel configuration utility for Cronyx serial adapters.  *  * Copyright (C) 1997-2002 Cronyx Engineering.  * Author: Serge Vakulenko,<vak@cronyx.ru>  *  * Copyright (C) 1999-2003 Cronyx Engineering.  * Author: Roman Kurakin,<rik@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * Cronyx Id: sconfig.c,v 1.2.2.4 2003/06/20 16:20:48 rik Exp $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<machine/cserial.h>
end_include

begin_define
define|#
directive|define
name|MAXCHAN
value|128
end_define

begin_decl_stmt
name|int
name|vflag
decl_stmt|,
name|eflag
decl_stmt|,
name|sflag
decl_stmt|,
name|mflag
decl_stmt|,
name|cflag
decl_stmt|,
name|fflag
decl_stmt|,
name|iflag
decl_stmt|,
name|aflag
decl_stmt|,
name|xflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tflag
decl_stmt|,
name|uflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|mask
index|[
literal|48
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|adapter_type
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0-sigma, 1-tau, 2-tau */
end_comment

begin_decl_stmt
name|char
name|chan_name
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Serial Adapter Configuration Utility\n"
literal|"Copyright (C) 1998-1999 Cronyx Engineering Ltd.\n"
literal|"See also man sconfig (8)\n"
literal|"Usage:\n"
literal|"\tsconfig [-aimsxeftuc] [device [parameters ...]]\n"
literal|"\n"
literal|"Options:\n"
literal|"\t<no options>\t\t -- print channel options\n"
literal|"\t-a\t\t\t -- print all settings of the channel\n"
literal|"\t-i\t\t\t -- print network interface status\n"
literal|"\t-m\t\t\t -- print modem signal status\n"
literal|"\t-s\t\t\t -- print channel statistics\n"
literal|"\t-x\t\t\t -- print extended channel statistics\n"
literal|"\t-e\t\t\t -- print short E1/G703 statistics\n"
literal|"\t-f\t\t\t -- print full E1/G703 statistics\n"
literal|"\t-t\t\t\t -- print short E3/T3/STS-1 statistics\n"
literal|"\t-u\t\t\t -- print full E3/T3/STS-1 statistics\n"
literal|"\t-c\t\t\t -- clear statistics\n"
literal|"\nParameters:\n"
literal|"\t<number>\t\t -- baud rate, internal clock\n"
literal|"\textclock\t\t -- external clock (default)\n"
literal|"\nProtocol options:\n"
literal|"\tasync\t\t\t -- asynchronous protocol\n"
ifdef|#
directive|ifdef
name|__linux__
literal|"\tsync\t\t\t -- synchronous protocol\n"
endif|#
directive|endif
literal|"\tcisco\t\t\t -- Cisco/HDLC protocol\n"
literal|"\tfr\t\t\t -- Frame Relay protocol\n"
ifdef|#
directive|ifdef
name|__linux__
literal|"\t    dlci<number>\t -- Add new DLCI\n"
endif|#
directive|endif
literal|"\tppp\t\t\t -- PPP protocol\n"
ifdef|#
directive|ifdef
name|__linux__
literal|"\trbrg\t\t\t -- Remote bridge\n"
literal|"\traw\t\t\t -- raw HDLC protocol\n"
literal|"\tpacket\t\t\t -- packetized HDLC protocol\n"
literal|"\tidle\t\t\t -- no protocol\n"
else|#
directive|else
literal|"\t    keepalive={on,of}\t -- Enable/disable keepalive\n"
endif|#
directive|endif
literal|"\nInterface options:\n"
literal|"\tport={rs232,v35,rs449}\t -- port type (for old models of Sigma)\n"
literal|"\tcfg={A,B,C}\t\t -- adapter configuration\n"
literal|"\tloop={on,off}\t\t -- internal loopback\n"
literal|"\trloop={on,off}\t\t -- remote loopback\n"
literal|"\tdpll={on,off}\t\t -- DPLL mode\n"
literal|"\tnrzi={on,off}\t\t -- NRZI encoding\n"
literal|"\tinvclk={on,off}\t\t -- invert receive and transmit clock\n"
literal|"\tinvrclk={on,off}\t -- invert receive clock\n"
literal|"\tinvtclk={on,off}\t -- invert transmit clock\n"
literal|"\thigain={on,off}\t\t -- E1 high non linear input sensitivity \n\t\t\t\t    (long line)\n"
literal|"\tmonitor={on,off}\t -- E1 high linear input sensitivity \n\t\t\t\t    (interception mode)\n"
literal|"\tphony={on,off}\t\t -- E1 telepnony mode\n"
literal|"\tunfram={on,off}\t\t -- E1 unframed mode\n"
literal|"\tscrambler={on,off}\t -- G.703 scrambling mode\n"
literal|"\tuse16={on,off}\t\t -- E1 timeslot 16 usage\n"
literal|"\tcrc4={on,off}\t\t -- E1 CRC4 mode\n"
literal|"\tsyn={int,rcv,rcvX}\t -- G.703 transmit clock\n"
literal|"\tts=...\t\t\t -- E1 timeslots\n"
literal|"\tpass=...\t\t -- E1 subchannel timeslots\n"
literal|"\tdir=<num>\t\t -- connect channel to link<num>\n"
comment|/*"\tcablen={on,off}\t\t -- T3/STS-1 high transmitter output for long cable\n"*/
literal|"\tdebug={0,1,2}\t\t -- enable/disable debug messages\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|scan_timeslots
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|char
modifier|*
name|e
decl_stmt|;
name|long
name|v
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|long
name|ts
decl_stmt|,
name|lastv
decl_stmt|;
name|ts
operator|=
name|lastv
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|v
operator|=
name|strtol
argument_list|(
name|s
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|s
condition|)
break|break;
if|if
condition|(
operator|*
name|e
operator|==
literal|'-'
condition|)
block|{
name|lastv
operator|=
name|v
expr_stmt|;
name|s
operator|=
name|e
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|e
operator|==
literal|','
condition|)
operator|++
name|e
expr_stmt|;
if|if
condition|(
name|lastv
condition|)
for|for
control|(
name|i
operator|=
name|lastv
init|;
name|i
operator|<
name|v
condition|;
operator|++
name|i
control|)
name|ts
operator||=
literal|1L
operator|<<
name|i
expr_stmt|;
name|ts
operator||=
literal|1L
operator|<<
name|v
expr_stmt|;
name|lastv
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|e
expr_stmt|;
block|}
return|return
name|ts
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppp_ok
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|int
name|s
decl_stmt|,
name|p
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|char
name|pttyname
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ppp_disc
init|=
name|N_PPP
decl_stmt|;
comment|/* 	 * Open a socket for doing the ioctl operations. 	 */
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error opening socket.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
literal|"ppp0"
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|>=
literal|0
condition|)
block|{
comment|/* Ok. */
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* open pseudo-tty and try to set PPP discipline */
name|sprintf
argument_list|(
name|pttyname
argument_list|,
literal|"/dev/ptyXX"
argument_list|)
expr_stmt|;
name|p1
operator|=
operator|&
name|pttyname
index|[
literal|8
index|]
expr_stmt|;
name|p2
operator|=
operator|&
name|pttyname
index|[
literal|9
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|stat
name|stb
decl_stmt|;
operator|*
name|p1
operator|=
literal|"pqrstuvwxyzabcde"
index|[
name|i
index|]
expr_stmt|;
operator|*
name|p2
operator|=
literal|'0'
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|pttyname
argument_list|,
operator|&
name|stb
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|p2
operator|=
literal|"0123456789abcdef"
index|[
name|j
index|]
expr_stmt|;
name|p
operator|=
name|open
argument_list|(
name|pttyname
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|p
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|ppp_disc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No PPP discipline in kernel.\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|close
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot get pseudo-tty.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
return|return
literal|1
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_timeslots
parameter_list|(
name|unsigned
name|long
name|s
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|32
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|(
name|s
operator|>>
name|i
operator|)
operator|&
literal|1
condition|)
block|{
name|int
name|prev
init|=
operator|(
name|i
operator|>
literal|1
operator|)
operator|&
operator|(
name|s
operator|>>
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
decl_stmt|;
name|int
name|next
init|=
operator|(
name|i
operator|<
literal|31
operator|)
operator|&
operator|(
name|s
operator|>>
operator|(
name|i
operator|+
literal|1
operator|)
operator|)
decl_stmt|;
if|if
condition|(
name|prev
condition|)
block|{
if|if
condition|(
name|next
condition|)
continue|continue;
operator|*
name|p
operator|++
operator|=
literal|'-'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|>
name|buf
condition|)
operator|*
name|p
operator|++
operator|=
literal|','
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|10
condition|)
operator|*
name|p
operator|++
operator|=
literal|'0'
operator|+
name|i
operator|/
literal|10
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'0'
operator|+
name|i
operator|%
literal|10
expr_stmt|;
block|}
operator|*
name|p
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_modems
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|TIOCMGET
argument_list|,
operator|&
name|status
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting modem status"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|need_header
condition|)
name|printf
argument_list|(
literal|"Channel\tLE\tDTR\tDSR\tRTS\tCTS\tCD\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\t%s\t%s\t%s\t%s\t%s\t%s\n"
argument_list|,
name|chan_name
argument_list|,
name|status
operator|&
name|TIOCM_LE
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_DTR
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_DSR
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_RTS
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_CTS
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_CD
condition|?
literal|"On"
else|:
literal|"-"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_ifconfig
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|char
name|protocol
index|[
literal|8
index|]
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPROTO
argument_list|,
operator|&
name|protocol
argument_list|)
operator|>=
literal|0
operator|&&
name|strcmp
argument_list|(
name|protocol
argument_list|,
literal|"fr"
argument_list|)
operator|==
literal|0
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"ifconfig %sd16 2>/dev/null"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"ifconfig %s 2>/dev/null"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_long
parameter_list|(
name|unsigned
name|long
name|val
parameter_list|)
block|{
specifier|static
name|char
name|s
index|[
literal|32
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"%lu"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|>
literal|7
operator|&&
operator|!
name|sflag
condition|)
block|{
name|s
index|[
literal|3
index|]
operator|=
name|s
index|[
literal|2
index|]
expr_stmt|;
name|s
index|[
literal|2
index|]
operator|=
name|s
index|[
literal|1
index|]
expr_stmt|;
name|s
index|[
literal|1
index|]
operator|=
literal|'.'
expr_stmt|;
name|s
index|[
literal|4
index|]
operator|=
literal|'e'
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
literal|5
argument_list|,
literal|"%02d"
argument_list|,
name|l
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|struct
name|serial_statistics
name|st
decl_stmt|;
name|unsigned
name|long
name|sarr
index|[
literal|9
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETSTAT
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting statistics"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|need_header
condition|)
block|{
if|if
condition|(
name|sflag
condition|)
block|{
name|printf
argument_list|(
literal|"        ------------Receive-----------      "
literal|"------------Transmit----------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Channel Interrupts  Packets     Errors      "
literal|"Interrupts  Packets     Errors\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"        --------Receive---------------  "
literal|"--------Transmit--------------  Modem\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Channel Intrs   Bytes   Packets Errors  "
literal|"Intrs   Bytes   Packets Errors  Intrs\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|sarr
index|[
literal|0
index|]
operator|=
name|st
operator|.
name|rintr
expr_stmt|;
name|sarr
index|[
literal|1
index|]
operator|=
name|st
operator|.
name|ibytes
expr_stmt|;
name|sarr
index|[
literal|2
index|]
operator|=
name|st
operator|.
name|ipkts
expr_stmt|;
name|sarr
index|[
literal|3
index|]
operator|=
name|st
operator|.
name|ierrs
expr_stmt|;
name|sarr
index|[
literal|4
index|]
operator|=
name|st
operator|.
name|tintr
expr_stmt|;
name|sarr
index|[
literal|5
index|]
operator|=
name|st
operator|.
name|obytes
expr_stmt|;
name|sarr
index|[
literal|6
index|]
operator|=
name|st
operator|.
name|opkts
expr_stmt|;
name|sarr
index|[
literal|7
index|]
operator|=
name|st
operator|.
name|oerrs
expr_stmt|;
name|sarr
index|[
literal|8
index|]
operator|=
name|st
operator|.
name|mintr
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sflag
condition|)
block|{
name|printf
argument_list|(
literal|"\t%-12lu%-12lu%-12lu%-12lu%-12lu%-12lu"
argument_list|,
name|sarr
index|[
literal|0
index|]
argument_list|,
name|sarr
index|[
literal|2
index|]
argument_list|,
name|sarr
index|[
literal|3
index|]
argument_list|,
name|sarr
index|[
literal|4
index|]
argument_list|,
name|sarr
index|[
literal|6
index|]
argument_list|,
name|sarr
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t%s"
argument_list|,
name|format_long
argument_list|(
name|sarr
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|clear_stats
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_CLRSTAT
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"clearing statistics"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_e1_status
parameter_list|(
name|unsigned
name|long
name|status
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_NOALARM
condition|)
return|return
literal|"Ok"
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_LOS
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_AIS
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",AIS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_LOF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_LOMF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOMF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_FARLOF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",FARLOF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_AIS16
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",AIS16"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_FARLOMF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",FARLOMF"
argument_list|)
expr_stmt|;
comment|/*	if (status& E1_TSTREQ)  strcat (buf, ",TSTREQ");*/
comment|/*	if (status& E1_TSTERR)  strcat (buf, ",TSTERR");*/
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|','
condition|)
return|return
name|buf
operator|+
literal|1
return|;
return|return
literal|"Unknown"
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_frac
parameter_list|(
name|int
name|leftalign
parameter_list|,
name|unsigned
name|long
name|numerator
parameter_list|,
name|unsigned
name|long
name|divider
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
if|if
condition|(
name|numerator
operator|<
literal|1
operator|||
name|divider
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
name|leftalign
condition|?
literal|"/-   "
else|:
literal|"    -"
argument_list|)
expr_stmt|;
return|return;
block|}
name|n
operator|=
call|(
name|int
call|)
argument_list|(
literal|0.5
operator|+
literal|1000.0
operator|*
name|numerator
operator|/
name|divider
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1000
condition|)
block|{
name|printf
argument_list|(
name|leftalign
condition|?
literal|"/.%-3d"
else|:
literal|" .%03d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
name|putchar
argument_list|(
name|leftalign
condition|?
literal|'/'
else|:
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|1000000
condition|)
name|n
operator|=
operator|(
name|n
operator|+
literal|500
operator|)
operator|/
literal|1000
operator|*
literal|1000
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|>=
literal|100000
condition|)
name|n
operator|=
operator|(
name|n
operator|+
literal|50
operator|)
operator|/
literal|100
operator|*
literal|100
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|>=
literal|10000
condition|)
name|n
operator|=
operator|(
name|n
operator|+
literal|5
operator|)
operator|/
literal|10
operator|*
literal|10
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|1000
case|:
name|printf
argument_list|(
literal|".999"
argument_list|)
expr_stmt|;
return|return;
case|case
literal|10000
case|:
name|n
operator|=
literal|9990
expr_stmt|;
break|break;
case|case
literal|100000
case|:
name|n
operator|=
literal|99900
expr_stmt|;
break|break;
case|case
literal|1000000
case|:
name|n
operator|=
literal|999000
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|n
operator|<
literal|10000
condition|)
name|printf
argument_list|(
literal|"%d.%d"
argument_list|,
name|n
operator|/
literal|1000
argument_list|,
name|n
operator|/
literal|10
operator|%
literal|100
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|<
literal|100000
condition|)
name|printf
argument_list|(
literal|"%d.%d"
argument_list|,
name|n
operator|/
literal|1000
argument_list|,
name|n
operator|/
literal|100
operator|%
literal|10
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|<
literal|1000000
condition|)
name|printf
argument_list|(
literal|"%d."
argument_list|,
name|n
operator|/
literal|1000
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|n
operator|/
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_e1_stats
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|struct
name|e1_statistics
name|st
decl_stmt|;
name|int
name|i
decl_stmt|,
name|maxi
decl_stmt|;
if|if
condition|(
name|need_header
condition|)
name|printf
argument_list|(
literal|"Chan\t Unav/Degr  Bpv/Fsyn  CRC/RCRC  Err/Lerr  Sev/Bur   Oof/Slp  Status\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETESTAT
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"%s\t"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
comment|/* Unavailable seconds, degraded minutes */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|uas
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
literal|60
operator|*
name|st
operator|.
name|currnt
operator|.
name|dm
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Bipolar violations, frame sync errors */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|bpv
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|fse
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* CRC errors, remote CRC errors (E-bit) */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|crce
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|rcrce
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Errored seconds, line errored seconds */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|es
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|les
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Severely errored seconds, bursty errored seconds */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|ses
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|bes
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Out of frame seconds, controlled slip seconds */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|oofs
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|css
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|format_e1_status
argument_list|(
name|st
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fflag
condition|)
block|{
comment|/* Print total statistics. */
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|uas
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
literal|60
operator|*
name|st
operator|.
name|total
operator|.
name|dm
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|bpv
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|fse
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|crce
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|rcrce
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|es
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|les
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|ses
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|bes
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|oofs
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|css
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -- Total\n"
argument_list|)
expr_stmt|;
comment|/* Print 24-hour history. */
name|maxi
operator|=
operator|(
name|st
operator|.
name|totsec
operator|-
name|st
operator|.
name|cursec
operator|)
operator|/
literal|900
expr_stmt|;
if|if
condition|(
name|maxi
operator|>
literal|48
condition|)
name|maxi
operator|=
literal|48
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxi
condition|;
operator|++
name|i
control|)
block|{
name|printf
argument_list|(
literal|"       "
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|uas
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
literal|60
operator|*
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|dm
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|bpv
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|fse
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|crce
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|rcrce
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|es
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|les
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|ses
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|bes
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|oofs
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|css
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|3
condition|)
name|printf
argument_list|(
literal|" -- %dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|15
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- %dh %dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|4
operator|*
literal|15
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_e3_status
parameter_list|(
name|unsigned
name|long
name|status
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E3_LOS
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E3_TXE
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",XMIT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|','
condition|)
return|return
name|buf
operator|+
literal|1
return|;
return|return
literal|"Ok"
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_e3_cv
parameter_list|(
name|unsigned
name|long
name|cv
parameter_list|,
name|unsigned
name|long
name|baud
parameter_list|,
name|unsigned
name|long
name|time
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|cv
operator|||
operator|!
name|baud
operator|||
operator|!
name|time
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"         -         "
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%10lu (%.1e)"
argument_list|,
name|cv
argument_list|,
operator|(
name|double
operator|)
name|cv
operator|/
name|baud
operator|/
name|time
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_e3_stats
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|struct
name|e3_statistics
name|st
decl_stmt|;
name|int
name|i
decl_stmt|,
name|maxi
decl_stmt|;
name|long
name|baud
decl_stmt|;
if|if
condition|(
name|need_header
condition|)
name|printf
argument_list|(
literal|"Chan\t--Code Violations---\t\t\t\t\t ----Status----\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETE3STAT
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
operator|||
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|st
operator|.
name|cursec
condition|)
name|st
operator|.
name|cursec
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"%s\t%s\t\t\t\t\t"
argument_list|,
name|chan_name
argument_list|,
name|format_e3_cv
argument_list|(
name|st
operator|.
name|ccv
argument_list|,
name|baud
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|format_e3_status
argument_list|(
name|st
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uflag
condition|)
block|{
comment|/* Print total statistics. */
name|printf
argument_list|(
literal|"\t%s\t\t\t\t\t"
argument_list|,
name|format_e3_cv
argument_list|(
name|st
operator|.
name|tcv
argument_list|,
name|baud
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -- Total\n"
argument_list|)
expr_stmt|;
comment|/* Print 24-hour history. */
name|maxi
operator|=
operator|(
name|st
operator|.
name|totsec
operator|-
name|st
operator|.
name|cursec
operator|)
operator|/
literal|900
expr_stmt|;
if|if
condition|(
name|maxi
operator|>
literal|48
condition|)
name|maxi
operator|=
literal|48
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxi
condition|;
operator|++
name|i
control|)
block|{
name|printf
argument_list|(
literal|"\t%s\t\t\t\t\t"
argument_list|,
name|format_e3_cv
argument_list|(
name|st
operator|.
name|icv
index|[
name|i
index|]
argument_list|,
name|baud
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|3
condition|)
name|printf
argument_list|(
literal|" -- %2dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|15
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- %2dh %2dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|4
operator|*
literal|15
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_chan
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|char
name|protocol
index|[
literal|8
index|]
decl_stmt|;
name|char
name|cfg
decl_stmt|;
name|int
name|loop
decl_stmt|,
name|dpll
decl_stmt|,
name|nrzi
decl_stmt|,
name|invclk
decl_stmt|,
name|clk
decl_stmt|,
name|higain
decl_stmt|,
name|phony
decl_stmt|,
name|use16
decl_stmt|,
name|crc4
decl_stmt|;
name|int
name|level
decl_stmt|,
name|keepalive
decl_stmt|,
name|debug
decl_stmt|,
name|port
decl_stmt|,
name|invrclk
decl_stmt|,
name|invtclk
decl_stmt|,
name|unfram
decl_stmt|,
name|monitor
decl_stmt|;
name|int
name|cable
decl_stmt|,
name|dir
decl_stmt|,
name|scrambler
decl_stmt|;
name|int
name|cablen
decl_stmt|,
name|rloop
decl_stmt|;
name|long
name|baud
decl_stmt|,
name|timeslots
decl_stmt|,
name|subchan
decl_stmt|;
name|int
name|protocol_valid
decl_stmt|,
name|baud_valid
decl_stmt|,
name|loop_valid
decl_stmt|,
name|use16_valid
decl_stmt|,
name|crc4_valid
decl_stmt|;
name|int
name|dpll_valid
decl_stmt|,
name|nrzi_valid
decl_stmt|,
name|invclk_valid
decl_stmt|,
name|clk_valid
decl_stmt|,
name|phony_valid
decl_stmt|;
name|int
name|timeslots_valid
decl_stmt|,
name|subchan_valid
decl_stmt|,
name|higain_valid
decl_stmt|,
name|level_valid
decl_stmt|;
name|int
name|keepalive_valid
decl_stmt|,
name|debug_valid
decl_stmt|,
name|cfg_valid
decl_stmt|,
name|port_valid
decl_stmt|;
name|int
name|invrclk_valid
decl_stmt|,
name|invtclk_valid
decl_stmt|,
name|unfram_valid
decl_stmt|,
name|monitor_valid
decl_stmt|;
name|int
name|cable_valid
decl_stmt|,
name|dir_valid
decl_stmt|,
name|scrambler_valid
decl_stmt|;
name|int
name|cablen_valid
decl_stmt|,
name|rloop_valid
decl_stmt|;
name|protocol_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPROTO
argument_list|,
operator|&
name|protocol
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|cfg_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCFG
argument_list|,
operator|&
name|cfg
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|baud_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|loop_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETLOOP
argument_list|,
operator|&
name|loop
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|dpll_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETDPLL
argument_list|,
operator|&
name|dpll
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|nrzi_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETNRZI
argument_list|,
operator|&
name|nrzi
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|invclk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETINVCLK
argument_list|,
operator|&
name|invclk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|invrclk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETINVRCLK
argument_list|,
operator|&
name|invrclk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|invtclk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETINVTCLK
argument_list|,
operator|&
name|invtclk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|clk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCLK
argument_list|,
operator|&
name|clk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|timeslots_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETTIMESLOTS
argument_list|,
operator|&
name|timeslots
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|subchan_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETSUBCHAN
argument_list|,
operator|&
name|subchan
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|higain_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETHIGAIN
argument_list|,
operator|&
name|higain
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|phony_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPHONY
argument_list|,
operator|&
name|phony
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|unfram_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETUNFRAM
argument_list|,
operator|&
name|unfram
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|monitor_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETMONITOR
argument_list|,
operator|&
name|monitor
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|use16_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETUSE16
argument_list|,
operator|&
name|use16
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|crc4_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCRC4
argument_list|,
operator|&
name|crc4
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|level_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETLEVEL
argument_list|,
operator|&
name|level
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|keepalive_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETKEEPALIVE
argument_list|,
operator|&
name|keepalive
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|debug_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETDEBUG
argument_list|,
operator|&
name|debug
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|port_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPORT
argument_list|,
operator|&
name|port
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|cable_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCABLE
argument_list|,
operator|&
name|cable
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|dir_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETDIR
argument_list|,
operator|&
name|dir
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|scrambler_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETSCRAMBLER
argument_list|,
operator|&
name|scrambler
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|cablen_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCABLEN
argument_list|,
operator|&
name|cablen
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|rloop_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETRLOOP
argument_list|,
operator|&
name|rloop
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_valid
condition|)
switch|switch
condition|(
name|port
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|" (rs232)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|" (v35)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|" (rs530)"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|cable_valid
condition|)
switch|switch
condition|(
name|cable
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|" (rs232)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|" (v35)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|" (rs530)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|" (x21)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|printf
argument_list|(
literal|" (rs485)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|printf
argument_list|(
literal|" (no cable)"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|debug_valid
operator|&&
name|debug
condition|)
name|printf
argument_list|(
literal|" debug=%d"
argument_list|,
name|debug
argument_list|)
expr_stmt|;
if|if
condition|(
name|protocol_valid
operator|&&
operator|*
name|protocol
condition|)
name|printf
argument_list|(
literal|" %.8s"
argument_list|,
name|protocol
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" idle"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cablen_valid
condition|)
name|printf
argument_list|(
literal|" cablen=%s"
argument_list|,
name|cablen
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|keepalive_valid
condition|)
name|printf
argument_list|(
literal|" keepalive=%s"
argument_list|,
name|keepalive
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_valid
condition|)
switch|switch
condition|(
name|cfg
condition|)
block|{
case|case
literal|'a'
case|:
name|printf
argument_list|(
literal|" cfg=A"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|printf
argument_list|(
literal|" cfg=B"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|printf
argument_list|(
literal|" cfg=C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|printf
argument_list|(
literal|" cfg=D"
argument_list|)
expr_stmt|;
break|break;
default|default  :
name|printf
argument_list|(
literal|" cfg=unknown"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dir_valid
condition|)
name|printf
argument_list|(
literal|" dir=%d"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|baud_valid
condition|)
block|{
if|if
condition|(
name|baud
condition|)
name|printf
argument_list|(
literal|" %ld"
argument_list|,
name|baud
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" extclock"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clk_valid
condition|)
switch|switch
condition|(
name|clk
condition|)
block|{
case|case
name|E1CLK_INTERNAL
case|:
name|printf
argument_list|(
literal|" syn=int"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE
case|:
name|printf
argument_list|(
literal|" syn=rcv"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN0
case|:
name|printf
argument_list|(
literal|" syn=rcv0"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN1
case|:
name|printf
argument_list|(
literal|" syn=rcv1"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN2
case|:
name|printf
argument_list|(
literal|" syn=rcv2"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN3
case|:
name|printf
argument_list|(
literal|" syn=rcv3"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" syn=%d"
argument_list|,
name|clk
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dpll_valid
condition|)
name|printf
argument_list|(
literal|" dpll=%s"
argument_list|,
name|dpll
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrzi_valid
condition|)
name|printf
argument_list|(
literal|" nrzi=%s"
argument_list|,
name|nrzi
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invclk_valid
condition|)
name|printf
argument_list|(
literal|" invclk=%s"
argument_list|,
name|invclk
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invrclk_valid
condition|)
name|printf
argument_list|(
literal|" invrclk=%s"
argument_list|,
name|invrclk
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invtclk_valid
condition|)
name|printf
argument_list|(
literal|" invtclk=%s"
argument_list|,
name|invtclk
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unfram_valid
condition|)
name|printf
argument_list|(
literal|" unfram=%s"
argument_list|,
name|unfram
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|use16_valid
condition|)
name|printf
argument_list|(
literal|" use16=%s"
argument_list|,
name|use16
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|aflag
condition|)
block|{
if|if
condition|(
name|crc4_valid
condition|)
name|printf
argument_list|(
literal|" crc4=%s"
argument_list|,
name|crc4
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|higain_valid
condition|)
name|printf
argument_list|(
literal|" higain=%s"
argument_list|,
name|higain
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|monitor_valid
condition|)
name|printf
argument_list|(
literal|" monitor=%s"
argument_list|,
name|monitor
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|phony_valid
condition|)
name|printf
argument_list|(
literal|" phony=%s"
argument_list|,
name|phony
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|scrambler_valid
condition|)
name|printf
argument_list|(
literal|" scrambler=%s"
argument_list|,
name|scrambler
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|loop_valid
condition|)
name|printf
argument_list|(
literal|" loop=%s"
argument_list|,
name|loop
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rloop_valid
condition|)
name|printf
argument_list|(
literal|" rloop=%s"
argument_list|,
name|rloop
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeslots_valid
condition|)
name|printf
argument_list|(
literal|" ts=%s"
argument_list|,
name|format_timeslots
argument_list|(
name|timeslots
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|subchan_valid
condition|)
name|printf
argument_list|(
literal|" pass=%s"
argument_list|,
name|format_timeslots
argument_list|(
name|subchan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|level_valid
condition|)
name|printf
argument_list|(
literal|" (level=-%.1fdB)"
argument_list|,
name|level
operator|/
literal|10.0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_chan
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|mode
decl_stmt|,
name|loop
decl_stmt|,
name|nrzi
decl_stmt|,
name|dpll
decl_stmt|,
name|invclk
decl_stmt|,
name|phony
decl_stmt|,
name|use16
decl_stmt|,
name|crc4
decl_stmt|,
name|unfram
decl_stmt|;
name|int
name|higain
decl_stmt|,
name|clk
decl_stmt|,
name|keepalive
decl_stmt|,
name|debug
decl_stmt|,
name|port
decl_stmt|,
name|dlci
decl_stmt|,
name|invrclk
decl_stmt|,
name|invtclk
decl_stmt|;
name|int
name|monitor
decl_stmt|,
name|dir
decl_stmt|,
name|scrambler
decl_stmt|,
name|rloop
decl_stmt|,
name|cablen
decl_stmt|;
name|long
name|baud
decl_stmt|,
name|timeslots
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|>=
literal|'0'
operator|&&
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|<=
literal|'9'
condition|)
block|{
name|baud
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"extclock"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|baud
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cfg="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"a"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"b"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"c"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"c"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"d"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid cfg\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"idle"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"\0\0\0\0\0\0\0"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"async"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_ASYNC
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
operator|>=
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"async\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"sync"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
operator|>=
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"sync\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"cisco"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"cisco\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"rbrg"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"rbrg\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"raw"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"raw\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"packet"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"packet\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"ppp"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* check that ppp line discipline is present */
if|if
condition|(
name|ppp_ok
argument_list|()
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"ppp\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"keepalive="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|keepalive
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|10
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETKEEPALIVE
argument_list|,
operator|&
name|keepalive
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"fr"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"fr\0\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"debug="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|debug
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETDEBUG
argument_list|,
operator|&
name|debug
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"loop="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|loop
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETLOOP
argument_list|,
operator|&
name|loop
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"rloop="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rloop
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETRLOOP
argument_list|,
operator|&
name|rloop
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"dpll="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dpll
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETDPLL
argument_list|,
operator|&
name|dpll
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"nrzi="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nrzi
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETNRZI
argument_list|,
operator|&
name|nrzi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"invclk="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|invclk
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETINVCLK
argument_list|,
operator|&
name|invclk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"invrclk="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|invrclk
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|8
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETINVRCLK
argument_list|,
operator|&
name|invrclk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"invtclk="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|invtclk
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|8
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETINVTCLK
argument_list|,
operator|&
name|invtclk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"higain="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|higain
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETHIGAIN
argument_list|,
operator|&
name|higain
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"phony="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phony
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPHONY
argument_list|,
operator|&
name|phony
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"unfram="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unfram
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETUNFRAM
argument_list|,
operator|&
name|unfram
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"scrambler="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|scrambler
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|10
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETSCRAMBLER
argument_list|,
operator|&
name|scrambler
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"monitor="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|monitor
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|8
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMONITOR
argument_list|,
operator|&
name|monitor
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"use16="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|use16
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETUSE16
argument_list|,
operator|&
name|use16
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"crc4="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|crc4
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCRC4
argument_list|,
operator|&
name|crc4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=int"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_INTERNAL
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv0"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN0
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv1"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN1
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv2"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN2
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv3"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN3
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"ts="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|timeslots
operator|=
name|scan_timeslots
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|3
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETTIMESLOTS
argument_list|,
operator|&
name|timeslots
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"pass="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|timeslots
operator|=
name|scan_timeslots
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETSUBCHAN
argument_list|,
operator|&
name|timeslots
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"dlci"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dlci
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_ADDDLCI
argument_list|,
operator|&
name|dlci
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"dir="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dir
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETDIR
argument_list|,
operator|&
name|dir
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"port="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"rs232"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|port
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPORT
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"v35"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|port
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPORT
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"rs449"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|port
operator|=
literal|2
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPORT
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid port type\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"reset"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"hwreset"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_HARDRESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cablen="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|loop
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCABLEN
argument_list|,
operator|&
name|cablen
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|get_mask
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/serial/ctl0"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"/dev/serial/ctl0"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|&
name|mask
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
else|#
directive|else
name|int
name|fd
decl_stmt|,
name|fd1
decl_stmt|,
name|fd2
decl_stmt|,
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fd
operator|=
operator|-
literal|1
init|;
name|i
operator|<
literal|12
operator|&&
name|fd
operator|<
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/cx%d"
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fd1
operator|=
operator|-
literal|1
init|;
name|i
operator|<
literal|3
operator|&&
name|fd1
operator|<
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/ct%d"
argument_list|,
name|i
operator|*
literal|2
argument_list|)
expr_stmt|;
name|fd1
operator|=
name|open
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fd2
operator|=
operator|-
literal|1
init|;
name|i
operator|<
literal|3
operator|&&
name|fd2
operator|<
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/cp%d"
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|fd2
operator|=
name|open
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fd
operator|<
literal|0
operator|)
operator|&&
operator|(
name|fd1
operator|<
literal|0
operator|)
operator|&&
operator|(
name|fd2
operator|<
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No Cronyx adapters installed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|&
name|mask
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fd1
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd1
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|(
name|mask
operator|+
literal|16
operator|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fd2
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd2
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|(
name|mask
operator|+
literal|32
operator|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|open_chan_ctl
parameter_list|(
name|int
name|num
parameter_list|)
block|{
name|char
name|device
index|[
literal|80
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/serial/ctl%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|adapter_type
condition|)
block|{
case|case
literal|0
case|:
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/cx%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/ct%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/cp%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENODEV
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"chan%d: not configured\n"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|else
name|perror
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|__linux__
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETNAME
argument_list|,
operator|&
name|chan_name
argument_list|)
operator|<
literal|0
condition|)
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"chan%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|adapter_type
condition|)
block|{
case|case
literal|0
case|:
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"cx%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"ct%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"cp%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
return|return
name|fd
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|need_header
decl_stmt|,
name|chan_num
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
operator|&&
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"help"
argument_list|)
operator|==
literal|0
condition|)
name|usage
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"mseftucviax"
argument_list|)
condition|)
block|{
case|case
name|EOF
case|:
break|break;
case|case
literal|'a'
case|:
operator|++
name|aflag
expr_stmt|;
continue|continue;
case|case
literal|'m'
case|:
operator|++
name|mflag
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
operator|++
name|sflag
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
operator|++
name|eflag
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
operator|++
name|eflag
expr_stmt|;
operator|++
name|fflag
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
operator|++
name|tflag
expr_stmt|;
continue|continue;
case|case
literal|'u'
case|:
operator|++
name|tflag
expr_stmt|;
operator|++
name|uflag
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
operator|++
name|cflag
expr_stmt|;
continue|continue;
case|case
literal|'v'
case|:
operator|++
name|vflag
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
operator|++
name|iflag
expr_stmt|;
continue|continue;
case|case
literal|'x'
case|:
operator|++
name|xflag
expr_stmt|;
continue|continue;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|0
condition|)
block|{
name|get_mask
argument_list|()
expr_stmt|;
name|need_header
operator|=
literal|1
expr_stmt|;
name|adapter_type
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|__linux__
for|for
control|(
init|;
name|adapter_type
operator|<
literal|3
condition|;
operator|++
name|adapter_type
control|)
endif|#
directive|endif
block|{
for|for
control|(
name|chan_num
operator|=
literal|0
init|;
name|chan_num
operator|<
name|MAXCHAN
condition|;
operator|++
name|chan_num
control|)
if|if
condition|(
name|mask
index|[
name|adapter_type
operator|*
literal|16
operator|+
name|chan_num
operator|/
literal|8
index|]
operator|&
literal|1
operator|<<
operator|(
name|chan_num
operator|&
literal|7
operator|)
condition|)
block|{
name|fd
operator|=
name|open_chan_ctl
argument_list|(
name|chan_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETVERSIONSTRING
argument_list|,
operator|&
name|buf
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Version: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|iflag
condition|)
block|{
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|print_ifconfig
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sflag
operator|||
name|xflag
condition|)
name|print_stats
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mflag
condition|)
name|print_modems
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|eflag
condition|)
name|print_e1_stats
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tflag
condition|)
name|print_e3_stats
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cflag
condition|)
name|clear_stats
argument_list|(
name|fd
argument_list|)
expr_stmt|;
else|else
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|need_header
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|p
operator|=
name|argv
index|[
literal|0
index|]
operator|+
name|strlen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
operator|>
name|argv
index|[
literal|0
index|]
operator|&&
name|p
index|[
operator|-
literal|1
index|]
operator|>=
literal|'0'
operator|&&
name|p
index|[
operator|-
literal|1
index|]
operator|<=
literal|'9'
condition|)
operator|--
name|p
expr_stmt|;
name|chan_num
operator|=
name|strtol
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|__linux__
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cx"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|adapter_type
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"ct"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|adapter_type
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cp"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|adapter_type
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Wrong channel name\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|fd
operator|=
name|open_chan_ctl
argument_list|(
name|chan_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETVERSIONSTRING
argument_list|,
operator|&
name|buf
argument_list|)
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"Version: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|iflag
condition|)
block|{
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|print_ifconfig
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sflag
operator|||
name|xflag
condition|)
block|{
name|print_stats
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|mflag
condition|)
block|{
name|print_modems
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|eflag
condition|)
block|{
name|print_e1_stats
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|tflag
condition|)
block|{
name|print_e3_stats
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|cflag
condition|)
block|{
name|clear_stats
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|setup_chan
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
else|else
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Channel configuration utility for Cronyx serial adapters.  *  * Copyright (C) 1997-2002 Cronyx Engineering.  * Author: Serge Vakulenko,<vak@cronyx.ru>  *  * Copyright (C) 1999-2003 Cronyx Engineering.  * Author: Roman Kurakin,<rik@cronyx.ru>  *  * This software is distributed with NO WARRANTIES, not even the implied  * warranties for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  *  * Authors grant any other persons or organisations permission to use  * or modify this software as long as this message is kept with the software,  * all derivative works or modified versions.  *  * $Id: sconfig.c,v 1.2.2.4 2003/06/20 16:20:48 rik Exp $  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<machine/cserial.h>
end_include

begin_define
define|#
directive|define
name|MAXCHAN
value|128
end_define

begin_decl_stmt
name|int
name|vflag
decl_stmt|,
name|eflag
decl_stmt|,
name|sflag
decl_stmt|,
name|mflag
decl_stmt|,
name|cflag
decl_stmt|,
name|fflag
decl_stmt|,
name|iflag
decl_stmt|,
name|aflag
decl_stmt|,
name|xflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tflag
decl_stmt|,
name|uflag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|mask
index|[
literal|48
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|adapter_type
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 0-sigma, 1-tau, 2-tau */
end_comment

begin_decl_stmt
name|char
name|chan_name
index|[
literal|16
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|optind
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Serial Adapter Configuration Utility\n"
literal|"Copyright (C) 1998-1999 Cronyx Engineering Ltd.\n"
literal|"See also man sconfig (8)\n"
literal|"Usage:\n"
literal|"\tsconfig [-aimsxeftuc] [device [parameters ...]]\n"
literal|"\n"
literal|"Options:\n"
literal|"\t<no options>\t\t -- print channel options\n"
literal|"\t-a\t\t\t -- print all settings of the channel\n"
literal|"\t-i\t\t\t -- print network interface status\n"
literal|"\t-m\t\t\t -- print modem signal status\n"
literal|"\t-s\t\t\t -- print channel statistics\n"
literal|"\t-x\t\t\t -- print extended channel statistics\n"
literal|"\t-e\t\t\t -- print short E1/G703 statistics\n"
literal|"\t-f\t\t\t -- print full E1/G703 statistics\n"
literal|"\t-t\t\t\t -- print short E3/T3/STS-1 statistics\n"
literal|"\t-u\t\t\t -- print full E3/T3/STS-1 statistics\n"
literal|"\t-c\t\t\t -- clear statistics\n"
literal|"\nParameters:\n"
literal|"\t<number>\t\t -- baud rate, internal clock\n"
literal|"\textclock\t\t -- external clock (default)\n"
literal|"\nProtocol options:\n"
literal|"\tasync\t\t\t -- asynchronous protocol\n"
ifdef|#
directive|ifdef
name|__linux__
literal|"\tsync\t\t\t -- synchronous protocol\n"
endif|#
directive|endif
literal|"\tcisco\t\t\t -- Cisco/HDLC protocol\n"
literal|"\tfr\t\t\t -- Frame Relay protocol\n"
ifdef|#
directive|ifdef
name|__linux__
literal|"\t    dlci<number>\t -- Add new DLCI\n"
endif|#
directive|endif
literal|"\tppp\t\t\t -- PPP protocol\n"
ifdef|#
directive|ifdef
name|__linux__
literal|"\trbrg\t\t\t -- Remote bridge\n"
literal|"\traw\t\t\t -- raw HDLC protocol\n"
literal|"\tpacket\t\t\t -- packetized HDLC protocol\n"
literal|"\tidle\t\t\t -- no protocol\n"
else|#
directive|else
literal|"\t    keepalive={on,of}\t -- Enable/disable keepalive\n"
endif|#
directive|endif
literal|"\nInterface options:\n"
literal|"\tport={rs232,v35,rs449}\t -- port type (for old models of Sigma)\n"
literal|"\tcfg={A,B,C}\t\t -- adapter configuration\n"
literal|"\tloop={on,off}\t\t -- internal loopback\n"
literal|"\trloop={on,off}\t\t -- remote loopback\n"
literal|"\tdpll={on,off}\t\t -- DPLL mode\n"
literal|"\tnrzi={on,off}\t\t -- NRZI encoding\n"
literal|"\tinvclk={on,off}\t\t -- invert receive and transmit clock\n"
literal|"\tinvrclk={on,off}\t -- invert receive clock\n"
literal|"\tinvtclk={on,off}\t -- invert transmit clock\n"
literal|"\thigain={on,off}\t\t -- E1 high non linear input sensitivity \n\t\t\t\t    (long line)\n"
literal|"\tmonitor={on,off}\t -- E1 high linear input sensitivity \n\t\t\t\t    (interception mode)\n"
literal|"\tphony={on,off}\t\t -- E1 telepnony mode\n"
literal|"\tunfram={on,off}\t\t -- E1 unframed mode\n"
literal|"\tscrambler={on,off}\t -- G.703 scrambling mode\n"
literal|"\tuse16={on,off}\t\t -- E1 timeslot 16 usage\n"
literal|"\tcrc4={on,off}\t\t -- E1 CRC4 mode\n"
literal|"\tsyn={int,rcv,rcvX}\t -- G.703 transmit clock\n"
literal|"\tts=...\t\t\t -- E1 timeslots\n"
literal|"\tpass=...\t\t -- E1 subchannel timeslots\n"
literal|"\tdir=<num>\t\t -- connect channel to link<num>\n"
comment|/*"\tcablen={on,off}\t\t -- T3/STS-1 high transmitter output for long cable\n"*/
literal|"\tdebug={0,1,2}\t\t -- enable/disable debug messages\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|scan_timeslots
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|char
modifier|*
name|e
decl_stmt|;
name|long
name|v
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unsigned
name|long
name|ts
decl_stmt|,
name|lastv
decl_stmt|;
name|ts
operator|=
name|lastv
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|v
operator|=
name|strtol
argument_list|(
name|s
argument_list|,
operator|&
name|e
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|s
condition|)
break|break;
if|if
condition|(
operator|*
name|e
operator|==
literal|'-'
condition|)
block|{
name|lastv
operator|=
name|v
expr_stmt|;
name|s
operator|=
name|e
operator|+
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|*
name|e
operator|==
literal|','
condition|)
operator|++
name|e
expr_stmt|;
if|if
condition|(
name|lastv
condition|)
for|for
control|(
name|i
operator|=
name|lastv
init|;
name|i
operator|<
name|v
condition|;
operator|++
name|i
control|)
name|ts
operator||=
literal|1L
operator|<<
name|i
expr_stmt|;
name|ts
operator||=
literal|1L
operator|<<
name|v
expr_stmt|;
name|lastv
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|e
expr_stmt|;
block|}
return|return
name|ts
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ppp_ok
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|int
name|s
decl_stmt|,
name|p
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|char
name|pttyname
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|p1
decl_stmt|,
modifier|*
name|p2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ppp_disc
init|=
name|N_PPP
decl_stmt|;
comment|/* 	 * Open a socket for doing the ioctl operations. 	 */
name|s
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error opening socket.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|strncpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
literal|"ppp0"
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|>=
literal|0
condition|)
block|{
comment|/* Ok. */
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* open pseudo-tty and try to set PPP discipline */
name|sprintf
argument_list|(
name|pttyname
argument_list|,
literal|"/dev/ptyXX"
argument_list|)
expr_stmt|;
name|p1
operator|=
operator|&
name|pttyname
index|[
literal|8
index|]
expr_stmt|;
name|p2
operator|=
operator|&
name|pttyname
index|[
literal|9
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|stat
name|stb
decl_stmt|;
operator|*
name|p1
operator|=
literal|"pqrstuvwxyzabcde"
index|[
name|i
index|]
expr_stmt|;
operator|*
name|p2
operator|=
literal|'0'
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|pttyname
argument_list|,
operator|&
name|stb
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|16
condition|;
name|j
operator|++
control|)
block|{
operator|*
name|p2
operator|=
literal|"0123456789abcdef"
index|[
name|j
index|]
expr_stmt|;
name|p
operator|=
name|open
argument_list|(
name|pttyname
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|p
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|ppp_disc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No PPP discipline in kernel.\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|close
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot get pseudo-tty.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
return|return
literal|1
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_timeslots
parameter_list|(
name|unsigned
name|long
name|s
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|char
modifier|*
name|p
init|=
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|32
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|(
name|s
operator|>>
name|i
operator|)
operator|&
literal|1
condition|)
block|{
name|int
name|prev
init|=
operator|(
name|i
operator|>
literal|1
operator|)
operator|&
operator|(
name|s
operator|>>
operator|(
name|i
operator|-
literal|1
operator|)
operator|)
decl_stmt|;
name|int
name|next
init|=
operator|(
name|i
operator|<
literal|31
operator|)
operator|&
operator|(
name|s
operator|>>
operator|(
name|i
operator|+
literal|1
operator|)
operator|)
decl_stmt|;
if|if
condition|(
name|prev
condition|)
block|{
if|if
condition|(
name|next
condition|)
continue|continue;
operator|*
name|p
operator|++
operator|=
literal|'-'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p
operator|>
name|buf
condition|)
operator|*
name|p
operator|++
operator|=
literal|','
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|10
condition|)
operator|*
name|p
operator|++
operator|=
literal|'0'
operator|+
name|i
operator|/
literal|10
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'0'
operator|+
name|i
operator|%
literal|10
expr_stmt|;
block|}
operator|*
name|p
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_modems
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|TIOCMGET
argument_list|,
operator|&
name|status
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting modem status"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|need_header
condition|)
name|printf
argument_list|(
literal|"Channel\tLE\tDTR\tDSR\tRTS\tCTS\tCD\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\t%s\t%s\t%s\t%s\t%s\t%s\n"
argument_list|,
name|chan_name
argument_list|,
name|status
operator|&
name|TIOCM_LE
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_DTR
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_DSR
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_RTS
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_CTS
condition|?
literal|"On"
else|:
literal|"-"
argument_list|,
name|status
operator|&
name|TIOCM_CD
condition|?
literal|"On"
else|:
literal|"-"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_ifconfig
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|char
name|protocol
index|[
literal|8
index|]
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPROTO
argument_list|,
operator|&
name|protocol
argument_list|)
operator|>=
literal|0
operator|&&
name|strcmp
argument_list|(
name|protocol
argument_list|,
literal|"fr"
argument_list|)
operator|==
literal|0
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"ifconfig %sd16 2>/dev/null"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"ifconfig %s 2>/dev/null"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
name|system
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_long
parameter_list|(
name|unsigned
name|long
name|val
parameter_list|)
block|{
specifier|static
name|char
name|s
index|[
literal|32
index|]
decl_stmt|;
name|int
name|l
decl_stmt|;
name|l
operator|=
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"%lu"
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|>
literal|7
operator|&&
operator|!
name|sflag
condition|)
block|{
name|s
index|[
literal|3
index|]
operator|=
name|s
index|[
literal|2
index|]
expr_stmt|;
name|s
index|[
literal|2
index|]
operator|=
name|s
index|[
literal|1
index|]
expr_stmt|;
name|s
index|[
literal|1
index|]
operator|=
literal|'.'
expr_stmt|;
name|s
index|[
literal|4
index|]
operator|=
literal|'e'
expr_stmt|;
name|sprintf
argument_list|(
name|s
operator|+
literal|5
argument_list|,
literal|"%02d"
argument_list|,
name|l
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_stats
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|struct
name|serial_statistics
name|st
decl_stmt|;
name|unsigned
name|long
name|sarr
index|[
literal|9
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETSTAT
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting statistics"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|need_header
condition|)
block|{
if|if
condition|(
name|sflag
condition|)
block|{
name|printf
argument_list|(
literal|"        ------------Receive-----------      "
literal|"------------Transmit----------\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Channel Interrupts  Packets     Errors      "
literal|"Interrupts  Packets     Errors\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"        --------Receive---------------  "
literal|"--------Transmit--------------  Modem\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Channel Intrs   Bytes   Packets Errors  "
literal|"Intrs   Bytes   Packets Errors  Intrs\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|sarr
index|[
literal|0
index|]
operator|=
name|st
operator|.
name|rintr
expr_stmt|;
name|sarr
index|[
literal|1
index|]
operator|=
name|st
operator|.
name|ibytes
expr_stmt|;
name|sarr
index|[
literal|2
index|]
operator|=
name|st
operator|.
name|ipkts
expr_stmt|;
name|sarr
index|[
literal|3
index|]
operator|=
name|st
operator|.
name|ierrs
expr_stmt|;
name|sarr
index|[
literal|4
index|]
operator|=
name|st
operator|.
name|tintr
expr_stmt|;
name|sarr
index|[
literal|5
index|]
operator|=
name|st
operator|.
name|obytes
expr_stmt|;
name|sarr
index|[
literal|6
index|]
operator|=
name|st
operator|.
name|opkts
expr_stmt|;
name|sarr
index|[
literal|7
index|]
operator|=
name|st
operator|.
name|oerrs
expr_stmt|;
name|sarr
index|[
literal|8
index|]
operator|=
name|st
operator|.
name|mintr
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|sflag
condition|)
block|{
name|printf
argument_list|(
literal|"\t%-12lu%-12lu%-12lu%-12lu%-12lu%-12lu"
argument_list|,
name|sarr
index|[
literal|0
index|]
argument_list|,
name|sarr
index|[
literal|2
index|]
argument_list|,
name|sarr
index|[
literal|3
index|]
argument_list|,
name|sarr
index|[
literal|4
index|]
argument_list|,
name|sarr
index|[
literal|6
index|]
argument_list|,
name|sarr
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|9
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"\t%s"
argument_list|,
name|format_long
argument_list|(
name|sarr
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|clear_stats
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_CLRSTAT
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"clearing statistics"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_e1_status
parameter_list|(
name|unsigned
name|long
name|status
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_NOALARM
condition|)
return|return
literal|"Ok"
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_LOS
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_AIS
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",AIS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_LOF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_LOMF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOMF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_FARLOF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",FARLOF"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_AIS16
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",AIS16"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E1_FARLOMF
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",FARLOMF"
argument_list|)
expr_stmt|;
comment|/*	if (status& E1_TSTREQ)  strcat (buf, ",TSTREQ");*/
comment|/*	if (status& E1_TSTERR)  strcat (buf, ",TSTERR");*/
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|','
condition|)
return|return
name|buf
operator|+
literal|1
return|;
return|return
literal|"Unknown"
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_frac
parameter_list|(
name|int
name|leftalign
parameter_list|,
name|unsigned
name|long
name|numerator
parameter_list|,
name|unsigned
name|long
name|divider
parameter_list|)
block|{
name|int
name|n
decl_stmt|;
if|if
condition|(
name|numerator
operator|<
literal|1
operator|||
name|divider
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
name|leftalign
condition|?
literal|"/-   "
else|:
literal|"    -"
argument_list|)
expr_stmt|;
return|return;
block|}
name|n
operator|=
call|(
name|int
call|)
argument_list|(
literal|0.5
operator|+
literal|1000.0
operator|*
name|numerator
operator|/
name|divider
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1000
condition|)
block|{
name|printf
argument_list|(
name|leftalign
condition|?
literal|"/.%-3d"
else|:
literal|" .%03d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
name|putchar
argument_list|(
name|leftalign
condition|?
literal|'/'
else|:
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>=
literal|1000000
condition|)
name|n
operator|=
operator|(
name|n
operator|+
literal|500
operator|)
operator|/
literal|1000
operator|*
literal|1000
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|>=
literal|100000
condition|)
name|n
operator|=
operator|(
name|n
operator|+
literal|50
operator|)
operator|/
literal|100
operator|*
literal|100
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|>=
literal|10000
condition|)
name|n
operator|=
operator|(
name|n
operator|+
literal|5
operator|)
operator|/
literal|10
operator|*
literal|10
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|1000
case|:
name|printf
argument_list|(
literal|".999"
argument_list|)
expr_stmt|;
return|return;
case|case
literal|10000
case|:
name|n
operator|=
literal|9990
expr_stmt|;
break|break;
case|case
literal|100000
case|:
name|n
operator|=
literal|99900
expr_stmt|;
break|break;
case|case
literal|1000000
case|:
name|n
operator|=
literal|999000
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|n
operator|<
literal|10000
condition|)
name|printf
argument_list|(
literal|"%d.%d"
argument_list|,
name|n
operator|/
literal|1000
argument_list|,
name|n
operator|/
literal|10
operator|%
literal|100
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|<
literal|100000
condition|)
name|printf
argument_list|(
literal|"%d.%d"
argument_list|,
name|n
operator|/
literal|1000
argument_list|,
name|n
operator|/
literal|100
operator|%
literal|10
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|<
literal|1000000
condition|)
name|printf
argument_list|(
literal|"%d."
argument_list|,
name|n
operator|/
literal|1000
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%d"
argument_list|,
name|n
operator|/
literal|1000
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_e1_stats
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|struct
name|e1_statistics
name|st
decl_stmt|;
name|int
name|i
decl_stmt|,
name|maxi
decl_stmt|;
if|if
condition|(
name|need_header
condition|)
name|printf
argument_list|(
literal|"Chan\t Unav/Degr  Bpv/Fsyn  CRC/RCRC  Err/Lerr  Sev/Bur   Oof/Slp  Status\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETESTAT
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|printf
argument_list|(
literal|"%s\t"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
comment|/* Unavailable seconds, degraded minutes */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|uas
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
literal|60
operator|*
name|st
operator|.
name|currnt
operator|.
name|dm
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Bipolar violations, frame sync errors */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|bpv
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|fse
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* CRC errors, remote CRC errors (E-bit) */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|crce
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|rcrce
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Errored seconds, line errored seconds */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|es
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|les
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Severely errored seconds, bursty errored seconds */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|ses
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|bes
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
comment|/* Out of frame seconds, controlled slip seconds */
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|oofs
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|currnt
operator|.
name|css
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|format_e1_status
argument_list|(
name|st
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fflag
condition|)
block|{
comment|/* Print total statistics. */
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|uas
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
literal|60
operator|*
name|st
operator|.
name|total
operator|.
name|dm
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|bpv
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|fse
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|crce
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|rcrce
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|es
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|les
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|ses
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|bes
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|total
operator|.
name|oofs
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|total
operator|.
name|css
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -- Total\n"
argument_list|)
expr_stmt|;
comment|/* Print 24-hour history. */
name|maxi
operator|=
operator|(
name|st
operator|.
name|totsec
operator|-
name|st
operator|.
name|cursec
operator|)
operator|/
literal|900
expr_stmt|;
if|if
condition|(
name|maxi
operator|>
literal|48
condition|)
name|maxi
operator|=
literal|48
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxi
condition|;
operator|++
name|i
control|)
block|{
name|printf
argument_list|(
literal|"       "
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|uas
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
literal|60
operator|*
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|dm
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|bpv
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|fse
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|crce
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|rcrce
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|es
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|les
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|ses
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|bes
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|0
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|oofs
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
name|print_frac
argument_list|(
literal|1
argument_list|,
name|st
operator|.
name|interval
index|[
name|i
index|]
operator|.
name|css
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|3
condition|)
name|printf
argument_list|(
literal|" -- %dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|15
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- %dh %dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|4
operator|*
literal|15
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_e3_status
parameter_list|(
name|unsigned
name|long
name|status
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E3_LOS
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",LOS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|E3_TXE
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",XMIT"
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|','
condition|)
return|return
name|buf
operator|+
literal|1
return|;
return|return
literal|"Ok"
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|format_e3_cv
parameter_list|(
name|unsigned
name|long
name|cv
parameter_list|,
name|unsigned
name|long
name|baud
parameter_list|,
name|unsigned
name|long
name|time
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|cv
operator|||
operator|!
name|baud
operator|||
operator|!
name|time
condition|)
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"         -         "
argument_list|)
expr_stmt|;
else|else
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%10lu (%.1e)"
argument_list|,
name|cv
argument_list|,
operator|(
name|double
operator|)
name|cv
operator|/
name|baud
operator|/
name|time
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_e3_stats
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|need_header
parameter_list|)
block|{
name|struct
name|e3_statistics
name|st
decl_stmt|;
name|int
name|i
decl_stmt|,
name|maxi
decl_stmt|;
name|long
name|baud
decl_stmt|;
if|if
condition|(
name|need_header
condition|)
name|printf
argument_list|(
literal|"Chan\t--Code Violations---\t\t\t\t\t ----Status----\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETE3STAT
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
operator|||
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|st
operator|.
name|cursec
condition|)
name|st
operator|.
name|cursec
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"%s\t%s\t\t\t\t\t"
argument_list|,
name|chan_name
argument_list|,
name|format_e3_cv
argument_list|(
name|st
operator|.
name|ccv
argument_list|,
name|baud
argument_list|,
name|st
operator|.
name|cursec
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|format_e3_status
argument_list|(
name|st
operator|.
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|uflag
condition|)
block|{
comment|/* Print total statistics. */
name|printf
argument_list|(
literal|"\t%s\t\t\t\t\t"
argument_list|,
name|format_e3_cv
argument_list|(
name|st
operator|.
name|tcv
argument_list|,
name|baud
argument_list|,
name|st
operator|.
name|totsec
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -- Total\n"
argument_list|)
expr_stmt|;
comment|/* Print 24-hour history. */
name|maxi
operator|=
operator|(
name|st
operator|.
name|totsec
operator|-
name|st
operator|.
name|cursec
operator|)
operator|/
literal|900
expr_stmt|;
if|if
condition|(
name|maxi
operator|>
literal|48
condition|)
name|maxi
operator|=
literal|48
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|maxi
condition|;
operator|++
name|i
control|)
block|{
name|printf
argument_list|(
literal|"\t%s\t\t\t\t\t"
argument_list|,
name|format_e3_cv
argument_list|(
name|st
operator|.
name|icv
index|[
name|i
index|]
argument_list|,
name|baud
argument_list|,
literal|15
operator|*
literal|60
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|3
condition|)
name|printf
argument_list|(
literal|" -- %2dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|15
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" -- %2dh %2dm\n"
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|%
literal|4
operator|*
literal|15
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_chan
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|char
name|protocol
index|[
literal|8
index|]
decl_stmt|;
name|char
name|cfg
decl_stmt|;
name|int
name|loop
decl_stmt|,
name|dpll
decl_stmt|,
name|nrzi
decl_stmt|,
name|invclk
decl_stmt|,
name|clk
decl_stmt|,
name|higain
decl_stmt|,
name|phony
decl_stmt|,
name|use16
decl_stmt|,
name|crc4
decl_stmt|;
name|int
name|level
decl_stmt|,
name|keepalive
decl_stmt|,
name|debug
decl_stmt|,
name|port
decl_stmt|,
name|invrclk
decl_stmt|,
name|invtclk
decl_stmt|,
name|unfram
decl_stmt|,
name|monitor
decl_stmt|;
name|int
name|cable
decl_stmt|,
name|dir
decl_stmt|,
name|scrambler
decl_stmt|;
name|int
name|cablen
decl_stmt|,
name|rloop
decl_stmt|;
name|long
name|baud
decl_stmt|,
name|timeslots
decl_stmt|,
name|subchan
decl_stmt|;
name|int
name|protocol_valid
decl_stmt|,
name|baud_valid
decl_stmt|,
name|loop_valid
decl_stmt|,
name|use16_valid
decl_stmt|,
name|crc4_valid
decl_stmt|;
name|int
name|dpll_valid
decl_stmt|,
name|nrzi_valid
decl_stmt|,
name|invclk_valid
decl_stmt|,
name|clk_valid
decl_stmt|,
name|phony_valid
decl_stmt|;
name|int
name|timeslots_valid
decl_stmt|,
name|subchan_valid
decl_stmt|,
name|higain_valid
decl_stmt|,
name|level_valid
decl_stmt|;
name|int
name|keepalive_valid
decl_stmt|,
name|debug_valid
decl_stmt|,
name|cfg_valid
decl_stmt|,
name|port_valid
decl_stmt|;
name|int
name|invrclk_valid
decl_stmt|,
name|invtclk_valid
decl_stmt|,
name|unfram_valid
decl_stmt|,
name|monitor_valid
decl_stmt|;
name|int
name|cable_valid
decl_stmt|,
name|dir_valid
decl_stmt|,
name|scrambler_valid
decl_stmt|;
name|int
name|cablen_valid
decl_stmt|,
name|rloop_valid
decl_stmt|;
name|protocol_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPROTO
argument_list|,
operator|&
name|protocol
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|cfg_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCFG
argument_list|,
operator|&
name|cfg
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|baud_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|loop_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETLOOP
argument_list|,
operator|&
name|loop
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|dpll_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETDPLL
argument_list|,
operator|&
name|dpll
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|nrzi_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETNRZI
argument_list|,
operator|&
name|nrzi
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|invclk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETINVCLK
argument_list|,
operator|&
name|invclk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|invrclk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETINVRCLK
argument_list|,
operator|&
name|invrclk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|invtclk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETINVTCLK
argument_list|,
operator|&
name|invtclk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|clk_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCLK
argument_list|,
operator|&
name|clk
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|timeslots_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETTIMESLOTS
argument_list|,
operator|&
name|timeslots
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|subchan_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETSUBCHAN
argument_list|,
operator|&
name|subchan
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|higain_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETHIGAIN
argument_list|,
operator|&
name|higain
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|phony_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPHONY
argument_list|,
operator|&
name|phony
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|unfram_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETUNFRAM
argument_list|,
operator|&
name|unfram
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|monitor_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETMONITOR
argument_list|,
operator|&
name|monitor
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|use16_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETUSE16
argument_list|,
operator|&
name|use16
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|crc4_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCRC4
argument_list|,
operator|&
name|crc4
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|level_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETLEVEL
argument_list|,
operator|&
name|level
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|keepalive_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETKEEPALIVE
argument_list|,
operator|&
name|keepalive
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|debug_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETDEBUG
argument_list|,
operator|&
name|debug
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|port_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETPORT
argument_list|,
operator|&
name|port
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|cable_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCABLE
argument_list|,
operator|&
name|cable
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|dir_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETDIR
argument_list|,
operator|&
name|dir
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|scrambler_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETSCRAMBLER
argument_list|,
operator|&
name|scrambler
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|cablen_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETCABLEN
argument_list|,
operator|&
name|cablen
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|rloop_valid
operator|=
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETRLOOP
argument_list|,
operator|&
name|rloop
argument_list|)
operator|>=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|chan_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_valid
condition|)
switch|switch
condition|(
name|port
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|" (rs232)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|" (v35)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|" (rs530)"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|cable_valid
condition|)
switch|switch
condition|(
name|cable
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|" (rs232)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|" (v35)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|" (rs530)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|printf
argument_list|(
literal|" (x21)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|printf
argument_list|(
literal|" (rs485)"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
name|printf
argument_list|(
literal|" (no cable)"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|debug_valid
operator|&&
name|debug
condition|)
name|printf
argument_list|(
literal|" debug=%d"
argument_list|,
name|debug
argument_list|)
expr_stmt|;
if|if
condition|(
name|protocol_valid
operator|&&
operator|*
name|protocol
condition|)
name|printf
argument_list|(
literal|" %.8s"
argument_list|,
name|protocol
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" idle"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cablen_valid
condition|)
name|printf
argument_list|(
literal|" cablen=%s"
argument_list|,
name|cablen
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|keepalive_valid
condition|)
name|printf
argument_list|(
literal|" keepalive=%s"
argument_list|,
name|keepalive
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg_valid
condition|)
switch|switch
condition|(
name|cfg
condition|)
block|{
case|case
literal|'a'
case|:
name|printf
argument_list|(
literal|" cfg=A"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|printf
argument_list|(
literal|" cfg=B"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|printf
argument_list|(
literal|" cfg=C"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|printf
argument_list|(
literal|" cfg=D"
argument_list|)
expr_stmt|;
break|break;
default|default  :
name|printf
argument_list|(
literal|" cfg=unknown"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dir_valid
condition|)
name|printf
argument_list|(
literal|" dir=%d"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|baud_valid
condition|)
block|{
if|if
condition|(
name|baud
condition|)
name|printf
argument_list|(
literal|" %ld"
argument_list|,
name|baud
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" extclock"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|clk_valid
condition|)
switch|switch
condition|(
name|clk
condition|)
block|{
case|case
name|E1CLK_INTERNAL
case|:
name|printf
argument_list|(
literal|" syn=int"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE
case|:
name|printf
argument_list|(
literal|" syn=rcv"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN0
case|:
name|printf
argument_list|(
literal|" syn=rcv0"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN1
case|:
name|printf
argument_list|(
literal|" syn=rcv1"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN2
case|:
name|printf
argument_list|(
literal|" syn=rcv2"
argument_list|)
expr_stmt|;
break|break;
case|case
name|E1CLK_RECEIVE_CHAN3
case|:
name|printf
argument_list|(
literal|" syn=rcv3"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|" syn=%d"
argument_list|,
name|clk
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dpll_valid
condition|)
name|printf
argument_list|(
literal|" dpll=%s"
argument_list|,
name|dpll
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nrzi_valid
condition|)
name|printf
argument_list|(
literal|" nrzi=%s"
argument_list|,
name|nrzi
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invclk_valid
condition|)
name|printf
argument_list|(
literal|" invclk=%s"
argument_list|,
name|invclk
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invrclk_valid
condition|)
name|printf
argument_list|(
literal|" invrclk=%s"
argument_list|,
name|invrclk
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|invtclk_valid
condition|)
name|printf
argument_list|(
literal|" invtclk=%s"
argument_list|,
name|invtclk
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unfram_valid
condition|)
name|printf
argument_list|(
literal|" unfram=%s"
argument_list|,
name|unfram
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|use16_valid
condition|)
name|printf
argument_list|(
literal|" use16=%s"
argument_list|,
name|use16
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|aflag
condition|)
block|{
if|if
condition|(
name|crc4_valid
condition|)
name|printf
argument_list|(
literal|" crc4=%s"
argument_list|,
name|crc4
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|higain_valid
condition|)
name|printf
argument_list|(
literal|" higain=%s"
argument_list|,
name|higain
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|monitor_valid
condition|)
name|printf
argument_list|(
literal|" monitor=%s"
argument_list|,
name|monitor
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|phony_valid
condition|)
name|printf
argument_list|(
literal|" phony=%s"
argument_list|,
name|phony
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|scrambler_valid
condition|)
name|printf
argument_list|(
literal|" scrambler=%s"
argument_list|,
name|scrambler
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|loop_valid
condition|)
name|printf
argument_list|(
literal|" loop=%s"
argument_list|,
name|loop
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rloop_valid
condition|)
name|printf
argument_list|(
literal|" rloop=%s"
argument_list|,
name|rloop
condition|?
literal|"on"
else|:
literal|"off"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|timeslots_valid
condition|)
name|printf
argument_list|(
literal|" ts=%s"
argument_list|,
name|format_timeslots
argument_list|(
name|timeslots
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|subchan_valid
condition|)
name|printf
argument_list|(
literal|" pass=%s"
argument_list|,
name|format_timeslots
argument_list|(
name|subchan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|level_valid
condition|)
name|printf
argument_list|(
literal|" (level=-%.1fdB)"
argument_list|,
name|level
operator|/
literal|10.0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|setup_chan
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|mode
decl_stmt|,
name|loop
decl_stmt|,
name|nrzi
decl_stmt|,
name|dpll
decl_stmt|,
name|invclk
decl_stmt|,
name|phony
decl_stmt|,
name|use16
decl_stmt|,
name|crc4
decl_stmt|,
name|unfram
decl_stmt|;
name|int
name|higain
decl_stmt|,
name|clk
decl_stmt|,
name|keepalive
decl_stmt|,
name|debug
decl_stmt|,
name|port
decl_stmt|,
name|dlci
decl_stmt|,
name|invrclk
decl_stmt|,
name|invtclk
decl_stmt|;
name|int
name|monitor
decl_stmt|,
name|dir
decl_stmt|,
name|scrambler
decl_stmt|,
name|rloop
decl_stmt|,
name|cablen
decl_stmt|;
name|long
name|baud
decl_stmt|,
name|timeslots
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|>=
literal|'0'
operator|&&
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|<=
literal|'9'
condition|)
block|{
name|baud
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"extclock"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|baud
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETBAUD
argument_list|,
operator|&
name|baud
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cfg="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"a"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"b"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"b"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"c"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"c"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"d"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCFG
argument_list|,
literal|"d"
argument_list|)
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid cfg\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"idle"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"\0\0\0\0\0\0\0"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"async"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_ASYNC
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
operator|>=
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"async\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"sync"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
operator|>=
literal|0
condition|)
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"sync\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"cisco"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"cisco\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"rbrg"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"rbrg\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"raw"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"raw\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"packet"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"packet\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"ppp"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* check that ppp line discipline is present */
if|if
condition|(
name|ppp_ok
argument_list|()
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"ppp\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"keepalive="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|keepalive
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|10
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETKEEPALIVE
argument_list|,
operator|&
name|keepalive
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"fr"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mode
operator|=
name|SERIAL_HDLC
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMODE
argument_list|,
operator|&
name|mode
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPROTO
argument_list|,
literal|"fr\0\0\0\0\0"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"debug="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|debug
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETDEBUG
argument_list|,
operator|&
name|debug
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"loop="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|loop
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETLOOP
argument_list|,
operator|&
name|loop
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"rloop="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|rloop
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETRLOOP
argument_list|,
operator|&
name|rloop
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"dpll="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dpll
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETDPLL
argument_list|,
operator|&
name|dpll
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"nrzi="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nrzi
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETNRZI
argument_list|,
operator|&
name|nrzi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"invclk="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|invclk
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETINVCLK
argument_list|,
operator|&
name|invclk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"invrclk="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|invrclk
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|8
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETINVRCLK
argument_list|,
operator|&
name|invrclk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"invtclk="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|invtclk
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|8
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETINVTCLK
argument_list|,
operator|&
name|invtclk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"higain="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|higain
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETHIGAIN
argument_list|,
operator|&
name|higain
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"phony="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|phony
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPHONY
argument_list|,
operator|&
name|phony
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"unfram="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unfram
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETUNFRAM
argument_list|,
operator|&
name|unfram
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"scrambler="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
name|scrambler
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|10
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETSCRAMBLER
argument_list|,
operator|&
name|scrambler
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"monitor="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|monitor
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|8
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETMONITOR
argument_list|,
operator|&
name|monitor
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"use16="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|use16
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|6
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETUSE16
argument_list|,
operator|&
name|use16
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"crc4="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|crc4
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCRC4
argument_list|,
operator|&
name|crc4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=int"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_INTERNAL
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv0"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN0
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv1"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN1
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv2"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN2
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"syn=rcv3"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|clk
operator|=
name|E1CLK_RECEIVE_CHAN3
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCLK
argument_list|,
operator|&
name|clk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"ts="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|timeslots
operator|=
name|scan_timeslots
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|3
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETTIMESLOTS
argument_list|,
operator|&
name|timeslots
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"pass="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|timeslots
operator|=
name|scan_timeslots
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETSUBCHAN
argument_list|,
operator|&
name|timeslots
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"dlci"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dlci
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_ADDDLCI
argument_list|,
operator|&
name|dlci
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"dir="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dir
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
index|]
operator|+
literal|4
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETDIR
argument_list|,
operator|&
name|dir
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"port="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"rs232"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|port
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPORT
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"v35"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|port
operator|=
literal|1
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPORT
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"rs449"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|5
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|port
operator|=
literal|2
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETPORT
argument_list|,
operator|&
name|port
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"invalid port type\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"reset"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_RESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
literal|"hwreset"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_HARDRESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cablen="
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|loop
operator|=
operator|(
name|strcasecmp
argument_list|(
literal|"on"
argument_list|,
name|argv
index|[
name|i
index|]
operator|+
literal|7
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_SETCABLEN
argument_list|,
operator|&
name|cablen
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|get_mask
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|int
name|fd
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
literal|"/dev/serial/ctl0"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"/dev/serial/ctl0"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|&
name|mask
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
else|#
directive|else
name|int
name|fd
decl_stmt|,
name|fd1
decl_stmt|,
name|fd2
decl_stmt|,
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fd
operator|=
operator|-
literal|1
init|;
name|i
operator|<
literal|12
operator|&&
name|fd
operator|<
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/cx%d"
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fd1
operator|=
operator|-
literal|1
init|;
name|i
operator|<
literal|3
operator|&&
name|fd1
operator|<
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/ct%d"
argument_list|,
name|i
operator|*
literal|2
argument_list|)
expr_stmt|;
name|fd1
operator|=
name|open
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|fd2
operator|=
operator|-
literal|1
init|;
name|i
operator|<
literal|3
operator|&&
name|fd2
operator|<
literal|0
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"/dev/cp%d"
argument_list|,
name|i
operator|*
literal|4
argument_list|)
expr_stmt|;
name|fd2
operator|=
name|open
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|fd
operator|<
literal|0
operator|)
operator|&&
operator|(
name|fd1
operator|<
literal|0
operator|)
operator|&&
operator|(
name|fd2
operator|<
literal|0
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No Cronyx adapters installed\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|&
name|mask
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fd1
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd1
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|(
name|mask
operator|+
literal|16
operator|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fd2
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|fd2
argument_list|,
name|SERIAL_GETREGISTERED
argument_list|,
operator|(
name|mask
operator|+
literal|32
operator|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"getting list of channels"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|fd2
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|open_chan_ctl
parameter_list|(
name|int
name|num
parameter_list|)
block|{
name|char
name|device
index|[
literal|80
index|]
decl_stmt|;
name|int
name|fd
decl_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/serial/ctl%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|adapter_type
condition|)
block|{
case|case
literal|0
case|:
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/cx%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/ct%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"/dev/cp%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENODEV
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"chan%d: not configured\n"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|else
name|perror
argument_list|(
name|device
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|__linux__
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETNAME
argument_list|,
operator|&
name|chan_name
argument_list|)
operator|<
literal|0
condition|)
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"chan%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
else|#
directive|else
switch|switch
condition|(
name|adapter_type
condition|)
block|{
case|case
literal|0
case|:
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"cx%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"ct%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|sprintf
argument_list|(
name|chan_name
argument_list|,
literal|"cp%d"
argument_list|,
name|num
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
return|return
name|fd
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|need_header
decl_stmt|,
name|chan_num
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
operator|&&
name|strcmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"help"
argument_list|)
operator|==
literal|0
condition|)
name|usage
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
switch|switch
condition|(
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"mseftucviax"
argument_list|)
condition|)
block|{
case|case
name|EOF
case|:
break|break;
case|case
literal|'a'
case|:
operator|++
name|aflag
expr_stmt|;
continue|continue;
case|case
literal|'m'
case|:
operator|++
name|mflag
expr_stmt|;
continue|continue;
case|case
literal|'s'
case|:
operator|++
name|sflag
expr_stmt|;
continue|continue;
case|case
literal|'e'
case|:
operator|++
name|eflag
expr_stmt|;
continue|continue;
case|case
literal|'f'
case|:
operator|++
name|eflag
expr_stmt|;
operator|++
name|fflag
expr_stmt|;
continue|continue;
case|case
literal|'t'
case|:
operator|++
name|tflag
expr_stmt|;
continue|continue;
case|case
literal|'u'
case|:
operator|++
name|tflag
expr_stmt|;
operator|++
name|uflag
expr_stmt|;
continue|continue;
case|case
literal|'c'
case|:
operator|++
name|cflag
expr_stmt|;
continue|continue;
case|case
literal|'v'
case|:
operator|++
name|vflag
expr_stmt|;
continue|continue;
case|case
literal|'i'
case|:
operator|++
name|iflag
expr_stmt|;
continue|continue;
case|case
literal|'x'
case|:
operator|++
name|xflag
expr_stmt|;
continue|continue;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<=
literal|0
condition|)
block|{
name|get_mask
argument_list|()
expr_stmt|;
name|need_header
operator|=
literal|1
expr_stmt|;
name|adapter_type
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|__linux__
for|for
control|(
init|;
name|adapter_type
operator|<
literal|3
condition|;
operator|++
name|adapter_type
control|)
endif|#
directive|endif
block|{
for|for
control|(
name|chan_num
operator|=
literal|0
init|;
name|chan_num
operator|<
name|MAXCHAN
condition|;
operator|++
name|chan_num
control|)
if|if
condition|(
name|mask
index|[
name|adapter_type
operator|*
literal|16
operator|+
name|chan_num
operator|/
literal|8
index|]
operator|&
literal|1
operator|<<
operator|(
name|chan_num
operator|&
literal|7
operator|)
condition|)
block|{
name|fd
operator|=
name|open_chan_ctl
argument_list|(
name|chan_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETVERSIONSTRING
argument_list|,
operator|&
name|buf
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Version: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|iflag
condition|)
block|{
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|print_ifconfig
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sflag
operator|||
name|xflag
condition|)
name|print_stats
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mflag
condition|)
name|print_modems
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|eflag
condition|)
name|print_e1_stats
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tflag
condition|)
name|print_e3_stats
argument_list|(
name|fd
argument_list|,
name|need_header
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cflag
condition|)
name|clear_stats
argument_list|(
name|fd
argument_list|)
expr_stmt|;
else|else
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|need_header
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|p
operator|=
name|argv
index|[
literal|0
index|]
operator|+
name|strlen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
name|p
operator|>
name|argv
index|[
literal|0
index|]
operator|&&
name|p
index|[
operator|-
literal|1
index|]
operator|>=
literal|'0'
operator|&&
name|p
index|[
operator|-
literal|1
index|]
operator|<=
literal|'9'
condition|)
operator|--
name|p
expr_stmt|;
name|chan_num
operator|=
name|strtol
argument_list|(
name|p
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|__linux__
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cx"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|adapter_type
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"ct"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|adapter_type
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
literal|"cp"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|adapter_type
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Wrong channel name\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|fd
operator|=
name|open_chan_ctl
argument_list|(
name|chan_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|SERIAL_GETVERSIONSTRING
argument_list|,
operator|&
name|buf
argument_list|)
operator|>=
literal|0
condition|)
name|printf
argument_list|(
literal|"Version: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|iflag
condition|)
block|{
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|print_ifconfig
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|sflag
operator|||
name|xflag
condition|)
block|{
name|print_stats
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|mflag
condition|)
block|{
name|print_modems
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|eflag
condition|)
block|{
name|print_e1_stats
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|tflag
condition|)
block|{
name|print_e3_stats
argument_list|(
name|fd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|cflag
condition|)
block|{
name|clear_stats
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
name|setup_chan
argument_list|(
name|fd
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|)
expr_stmt|;
else|else
name|print_chan
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


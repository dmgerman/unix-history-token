begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013 EMC Corp.  * All rights reserved.  *  * Copyright (C) 2012-2013 Intel Corporation  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<err.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdbool.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_if
if|#
directive|if
name|_BYTE_ORDER
operator|!=
name|_LITTLE_ENDIAN
end_if

begin_error
error|#
directive|error
literal|"Code only works on little endian machines"
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"nvmecontrol.h"
end_include

begin_define
define|#
directive|define
name|DEFAULT_SIZE
value|(4096)
end_define

begin_define
define|#
directive|define
name|MAX_FW_SLOTS
value|(7)
end_define

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|print_fn_t
function_decl|)
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_typedef

begin_struct
struct|struct
name|kv_name
block|{
name|uint32_t
name|key
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|kv_lookup
parameter_list|(
specifier|const
name|struct
name|kv_name
modifier|*
name|kv
parameter_list|,
name|size_t
name|kv_count
parameter_list|,
name|uint32_t
name|key
parameter_list|)
block|{
specifier|static
name|char
name|bad
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|kv_count
condition|;
name|i
operator|++
operator|,
name|kv
operator|++
control|)
if|if
condition|(
name|kv
operator|->
name|key
operator|==
name|key
condition|)
return|return
name|kv
operator|->
name|name
return|;
name|snprintf
argument_list|(
name|bad
argument_list|,
sizeof|sizeof
argument_list|(
name|bad
argument_list|)
argument_list|,
literal|"Attribute %#x"
argument_list|,
name|key
argument_list|)
expr_stmt|;
return|return
name|bad
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_bin
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
name|uint32_t
name|length
parameter_list|)
block|{
name|write
argument_list|(
name|STDOUT_FILENO
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * 128-bit integer augments to standard values. On i386 this  * doesn't exist, so we use 64-bit values. The 128-bit counters  * are crazy anyway, since for this purpose, you'd need a  * billion IOPs for billions of seconds to overflow them.  * So, on 32-bit i386, you'll get truncated values.  */
end_comment

begin_define
define|#
directive|define
name|UINT128_DIG
value|39
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|__i386__
end_ifdef

begin_typedef
typedef|typedef
name|uint64_t
name|uint128_t
typedef|;
end_typedef

begin_else
else|#
directive|else
end_else

begin_typedef
typedef|typedef
name|__uint128_t
name|uint128_t
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
specifier|inline
name|uint128_t
name|to128
parameter_list|(
name|void
modifier|*
name|p
parameter_list|)
block|{
return|return
operator|*
operator|(
name|uint128_t
operator|*
operator|)
name|p
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|uint128_to_str
parameter_list|(
name|uint128_t
name|u
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|char
modifier|*
name|end
init|=
name|buf
operator|+
name|buflen
operator|-
literal|1
decl_stmt|;
operator|*
name|end
operator|--
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|u
operator|==
literal|0
condition|)
operator|*
name|end
operator|--
operator|=
literal|'0'
expr_stmt|;
while|while
condition|(
name|u
operator|&&
name|end
operator|>=
name|buf
condition|)
block|{
operator|*
name|end
operator|--
operator|=
name|u
operator|%
literal|10
operator|+
literal|'0'
expr_stmt|;
name|u
operator|/=
literal|10
expr_stmt|;
block|}
name|end
operator|++
expr_stmt|;
if|if
condition|(
name|u
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|end
return|;
block|}
end_function

begin_comment
comment|/* "Missing" from endian.h */
end_comment

begin_function
specifier|static
name|__inline
name|uint64_t
name|le48dec
parameter_list|(
specifier|const
name|void
modifier|*
name|pp
parameter_list|)
block|{
name|uint8_t
specifier|const
modifier|*
name|p
init|=
operator|(
name|uint8_t
specifier|const
operator|*
operator|)
name|pp
decl_stmt|;
return|return
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|le16dec
argument_list|(
name|p
operator|+
literal|4
argument_list|)
operator|<<
literal|32
operator|)
operator||
name|le32dec
argument_list|(
name|p
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|get_log_buffer
parameter_list|(
name|uint32_t
name|size
parameter_list|)
block|{
name|void
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
operator|(
name|buf
operator|=
name|malloc
argument_list|(
name|size
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unable to malloc %u bytes"
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_function
name|void
name|read_logpage
parameter_list|(
name|int
name|fd
parameter_list|,
name|uint8_t
name|log_page
parameter_list|,
name|int
name|nsid
parameter_list|,
name|void
modifier|*
name|payload
parameter_list|,
name|uint32_t
name|payload_size
parameter_list|)
block|{
name|struct
name|nvme_pt_command
name|pt
decl_stmt|;
name|memset
argument_list|(
operator|&
name|pt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pt
argument_list|)
argument_list|)
expr_stmt|;
name|pt
operator|.
name|cmd
operator|.
name|opc
operator|=
name|NVME_OPC_GET_LOG_PAGE
expr_stmt|;
name|pt
operator|.
name|cmd
operator|.
name|nsid
operator|=
name|nsid
expr_stmt|;
name|pt
operator|.
name|cmd
operator|.
name|cdw10
operator|=
operator|(
operator|(
name|payload_size
operator|/
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
operator|-
literal|1
operator|)
operator|<<
literal|16
expr_stmt|;
name|pt
operator|.
name|cmd
operator|.
name|cdw10
operator||=
name|log_page
expr_stmt|;
name|pt
operator|.
name|buf
operator|=
name|payload
expr_stmt|;
name|pt
operator|.
name|len
operator|=
name|payload_size
expr_stmt|;
name|pt
operator|.
name|is_read
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|NVME_PASSTHROUGH_CMD
argument_list|,
operator|&
name|pt
argument_list|)
operator|<
literal|0
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"get log page request failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nvme_completion_is_error
argument_list|(
operator|&
name|pt
operator|.
name|cpl
argument_list|)
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"get log page request returned error"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_log_error
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|nentries
decl_stmt|;
name|struct
name|nvme_error_information_entry
modifier|*
name|entry
init|=
name|buf
decl_stmt|;
name|struct
name|nvme_status
modifier|*
name|status
decl_stmt|;
name|printf
argument_list|(
literal|"Error Information Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=====================\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|error_count
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No error entries found\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|nentries
operator|=
name|size
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|nvme_error_information_entry
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nentries
condition|;
name|i
operator|++
operator|,
name|entry
operator|++
control|)
block|{
if|if
condition|(
name|entry
operator|->
name|error_count
operator|==
literal|0
condition|)
break|break;
name|status
operator|=
operator|&
name|entry
operator|->
name|status
expr_stmt|;
name|printf
argument_list|(
literal|"Entry %02d\n"
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=========\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Error count:          %ju\n"
argument_list|,
name|entry
operator|->
name|error_count
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Submission queue ID:  %u\n"
argument_list|,
name|entry
operator|->
name|sqid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Command ID:           %u\n"
argument_list|,
name|entry
operator|->
name|cid
argument_list|)
expr_stmt|;
comment|/* TODO: Export nvme_status_string structures from kernel? */
name|printf
argument_list|(
literal|" Status:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Phase tag:           %d\n"
argument_list|,
name|status
operator|->
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Status code:         %d\n"
argument_list|,
name|status
operator|->
name|sc
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  Status code type:    %d\n"
argument_list|,
name|status
operator|->
name|sct
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  More:                %d\n"
argument_list|,
name|status
operator|->
name|m
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  DNR:                 %d\n"
argument_list|,
name|status
operator|->
name|dnr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Error location:       %u\n"
argument_list|,
name|entry
operator|->
name|error_location
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" LBA:                  %ju\n"
argument_list|,
name|entry
operator|->
name|lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Namespace ID:         %u\n"
argument_list|,
name|entry
operator|->
name|nsid
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Vendor specific info: %u\n"
argument_list|,
name|entry
operator|->
name|vendor_specific
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_temp
parameter_list|(
name|uint16_t
name|t
parameter_list|)
block|{
name|printf
argument_list|(
literal|"%u K, %2.2f C, %3.2f F\n"
argument_list|,
name|t
argument_list|,
operator|(
name|float
operator|)
name|t
operator|-
literal|273.15
argument_list|,
operator|(
name|float
operator|)
name|t
operator|*
literal|9
operator|/
literal|5
operator|-
literal|459.67
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_log_health
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|struct
name|nvme_health_information_page
modifier|*
name|health
init|=
name|buf
decl_stmt|;
name|char
name|cbuf
index|[
name|UINT128_DIG
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"SMART/Health Information Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"============================\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Critical Warning State:         0x%02x\n"
argument_list|,
name|health
operator|->
name|critical_warning
operator|.
name|raw
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Available spare:               %d\n"
argument_list|,
name|health
operator|->
name|critical_warning
operator|.
name|bits
operator|.
name|available_spare
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Temperature:                   %d\n"
argument_list|,
name|health
operator|->
name|critical_warning
operator|.
name|bits
operator|.
name|temperature
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Device reliability:            %d\n"
argument_list|,
name|health
operator|->
name|critical_warning
operator|.
name|bits
operator|.
name|device_reliability
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Read only:                     %d\n"
argument_list|,
name|health
operator|->
name|critical_warning
operator|.
name|bits
operator|.
name|read_only
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Volatile memory backup:        %d\n"
argument_list|,
name|health
operator|->
name|critical_warning
operator|.
name|bits
operator|.
name|volatile_memory_backup
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Temperature:                    "
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|health
operator|->
name|temperature
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Available spare:                %u\n"
argument_list|,
name|health
operator|->
name|available_spare
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Available spare threshold:      %u\n"
argument_list|,
name|health
operator|->
name|available_spare_threshold
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Percentage used:                %u\n"
argument_list|,
name|health
operator|->
name|percentage_used
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data units (512,000 byte) read: %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|data_units_read
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Data units written:             %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|data_units_written
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Host read commands:             %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|host_read_commands
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Host write commands:            %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|host_write_commands
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Controller busy time (minutes): %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|controller_busy_time
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Power cycles:                   %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|power_cycles
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Power on hours:                 %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|power_on_hours
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Unsafe shutdowns:               %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|unsafe_shutdowns
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Media errors:                   %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|media_errors
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"No. error info log entries:     %s\n"
argument_list|,
name|uint128_to_str
argument_list|(
name|to128
argument_list|(
name|health
operator|->
name|num_error_info_log_entries
argument_list|)
argument_list|,
name|cbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|cbuf
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Warning Temp Composite Time:    %d\n"
argument_list|,
name|health
operator|->
name|warning_temp_time
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Error Temp Composite Time:      %d\n"
argument_list|,
name|health
operator|->
name|error_temp_time
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|7
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|health
operator|->
name|temp_sensor
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
name|printf
argument_list|(
literal|"Temperature Sensor %d:           "
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|health
operator|->
name|temp_sensor
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_log_firmware
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|status
decl_stmt|;
name|struct
name|nvme_firmware_page
modifier|*
name|fw
init|=
name|buf
decl_stmt|;
name|printf
argument_list|(
literal|"Firmware Slot Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=================\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_FW_SLOTS
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"Slot %d: "
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|fw
operator|->
name|afi
operator|.
name|slot
operator|==
name|i
operator|+
literal|1
condition|)
name|status
operator|=
literal|"  Active"
expr_stmt|;
else|else
name|status
operator|=
literal|"Inactive"
expr_stmt|;
if|if
condition|(
name|fw
operator|->
name|revision
index|[
name|i
index|]
operator|==
literal|0LLU
condition|)
name|printf
argument_list|(
literal|"Empty\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|isprint
argument_list|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|&
name|fw
operator|->
name|revision
index|[
name|i
index|]
argument_list|)
condition|)
name|printf
argument_list|(
literal|"[%s] %.8s\n"
argument_list|,
name|status
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fw
operator|->
name|revision
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"[%s] %016jx\n"
argument_list|,
name|status
argument_list|,
name|fw
operator|->
name|revision
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Intel specific log pages from  * http://www.intel.com/content/dam/www/public/us/en/documents/product-specifications/ssd-dc-p3700-spec.pdf  *  * Though the version as of this date has a typo for the size of log page 0xca,  * offset 147: it is only 1 byte, not 6.  */
end_comment

begin_function
specifier|static
name|void
name|print_intel_temp_stats
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|struct
name|intel_log_temp_stats
modifier|*
name|temp
init|=
name|buf
decl_stmt|;
name|printf
argument_list|(
literal|"Intel Temperature Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=====================\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Current:                        "
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|temp
operator|->
name|current
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Overtemp Last Flags             %#jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|temp
operator|->
name|overtemp_flag_last
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Overtemp Lifetime Flags         %#jx\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|temp
operator|->
name|overtemp_flag_life
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max Temperature                 "
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|temp
operator|->
name|max_temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Min Temperature                 "
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|temp
operator|->
name|min_temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Max Operating Temperature       "
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|temp
operator|->
name|max_oper_temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Min Operating Temperature       "
argument_list|)
expr_stmt|;
name|print_temp
argument_list|(
name|temp
operator|->
name|min_oper_temp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Estimated Temperature Offset:   %ju C/K\n"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|temp
operator|->
name|est_offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Format from Table 22, section 5.7 IO Command Latency Statistics.  * Read and write stats pages have identical encoding.  */
end_comment

begin_function
specifier|static
name|void
name|print_intel_read_write_lat_log
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"Major:                         %d\n"
argument_list|,
name|le16dec
argument_list|(
name|walker
operator|+
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Minor:                         %d\n"
argument_list|,
name|le16dec
argument_list|(
name|walker
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%4dus-%4dus:                 %ju\n"
argument_list|,
name|i
operator|*
literal|32
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|32
argument_list|,
operator|(
name|uintmax_t
operator|)
name|le32dec
argument_list|(
name|walker
operator|+
literal|4
operator|+
name|i
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%4dms-%4dms:                 %ju\n"
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|(
name|uintmax_t
operator|)
name|le32dec
argument_list|(
name|walker
operator|+
literal|132
operator|+
name|i
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%4dms-%4dms:                 %ju\n"
argument_list|,
name|i
operator|*
literal|32
argument_list|,
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|32
argument_list|,
operator|(
name|uintmax_t
operator|)
name|le32dec
argument_list|(
name|walker
operator|+
literal|256
operator|+
name|i
operator|*
literal|4
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_intel_read_lat_log
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Intel Read Latency Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"======================\n"
argument_list|)
expr_stmt|;
name|print_intel_read_write_lat_log
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_intel_write_lat_log
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Intel Write Latency Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=======================\n"
argument_list|)
expr_stmt|;
name|print_intel_read_write_lat_log
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Table 19. 5.4 SMART Attributes  */
end_comment

begin_function
specifier|static
name|void
name|print_intel_add_smart
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|uint8_t
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|uint8_t
modifier|*
name|end
init|=
name|walker
operator|+
literal|150
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|uint64_t
name|raw
decl_stmt|;
name|uint8_t
name|normalized
decl_stmt|;
specifier|static
name|struct
name|kv_name
name|kv
index|[]
init|=
block|{
block|{
literal|0xab
block|,
literal|"Program Fail Count"
block|}
block|,
block|{
literal|0xac
block|,
literal|"Erase Fail Count"
block|}
block|,
block|{
literal|0xad
block|,
literal|"Wear Leveling Count"
block|}
block|,
block|{
literal|0xb8
block|,
literal|"End to End Error Count"
block|}
block|,
block|{
literal|0xc7
block|,
literal|"CRC Error Count"
block|}
block|,
block|{
literal|0xe2
block|,
literal|"Timed: Media Wear"
block|}
block|,
block|{
literal|0xe3
block|,
literal|"Timed: Host Read %"
block|}
block|,
block|{
literal|0xe4
block|,
literal|"Timed: Elapsed Time"
block|}
block|,
block|{
literal|0xea
block|,
literal|"Thermal Throttle Status"
block|}
block|,
block|{
literal|0xf0
block|,
literal|"Retry Buffer Overflows"
block|}
block|,
block|{
literal|0xf3
block|,
literal|"PLL Lock Loss Count"
block|}
block|,
block|{
literal|0xf4
block|,
literal|"NAND Bytes Written"
block|}
block|,
block|{
literal|0xf5
block|,
literal|"Host Bytes Written"
block|}
block|, 	}
decl_stmt|;
name|printf
argument_list|(
literal|"Additional SMART Data Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"=========================\n"
argument_list|)
expr_stmt|;
comment|/* 	 * walker[0] = Key 	 * walker[1,2] = reserved 	 * walker[3] = Normalized Value 	 * walker[4] = reserved 	 * walker[5..10] = Little Endian Raw value 	 *	(or other represenations) 	 * walker[11] = reserved 	 */
while|while
condition|(
name|walker
operator|<
name|end
condition|)
block|{
name|name
operator|=
name|kv_lookup
argument_list|(
name|kv
argument_list|,
name|nitems
argument_list|(
name|kv
argument_list|)
argument_list|,
operator|*
name|walker
argument_list|)
expr_stmt|;
name|normalized
operator|=
name|walker
index|[
literal|3
index|]
expr_stmt|;
name|raw
operator|=
name|le48dec
argument_list|(
name|walker
operator|+
literal|5
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|*
name|walker
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|0xad
case|:
name|printf
argument_list|(
literal|"%-32s: %3d min: %u max: %u ave: %u\n"
argument_list|,
name|name
argument_list|,
name|normalized
argument_list|,
name|le16dec
argument_list|(
name|walker
operator|+
literal|5
argument_list|)
argument_list|,
name|le16dec
argument_list|(
name|walker
operator|+
literal|7
argument_list|)
argument_list|,
name|le16dec
argument_list|(
name|walker
operator|+
literal|9
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe2
case|:
name|printf
argument_list|(
literal|"%-32s: %3d %.3f%%\n"
argument_list|,
name|name
argument_list|,
name|normalized
argument_list|,
name|raw
operator|/
literal|1024.0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xea
case|:
name|printf
argument_list|(
literal|"%-32s: %3d %d%% %d times\n"
argument_list|,
name|name
argument_list|,
name|normalized
argument_list|,
name|walker
index|[
literal|5
index|]
argument_list|,
name|le32dec
argument_list|(
name|walker
operator|+
literal|6
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%-32s: %3d %ju\n"
argument_list|,
name|name
argument_list|,
name|normalized
argument_list|,
operator|(
name|uintmax_t
operator|)
name|raw
argument_list|)
expr_stmt|;
break|break;
block|}
name|walker
operator|+=
literal|12
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * HGST's 0xc1 page. This is a grab bag of additional data. Please see  * https://www.hgst.com/sites/default/files/resources/US_SN150_ProdManual.pdf  * https://www.hgst.com/sites/default/files/resources/US_SN100_ProdManual.pdf  * Appendix A for details  */
end_comment

begin_typedef
typedef|typedef
name|void
function_decl|(
modifier|*
name|subprint_fn_t
function_decl|)
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_typedef

begin_struct
struct|struct
name|subpage_print
block|{
name|uint16_t
name|key
decl_stmt|;
name|subprint_fn_t
name|fn
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|print_hgst_info_write_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_read_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_verify_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_self_test
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_background_scan
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_erase_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_erase_counts
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_temp_history
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_ssd_perf
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|print_hgst_info_firmware_load
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|subpage_print
name|hgst_subpage
index|[]
init|=
block|{
block|{
literal|0x02
block|,
name|print_hgst_info_write_errors
block|}
block|,
block|{
literal|0x03
block|,
name|print_hgst_info_read_errors
block|}
block|,
block|{
literal|0x05
block|,
name|print_hgst_info_verify_errors
block|}
block|,
block|{
literal|0x10
block|,
name|print_hgst_info_self_test
block|}
block|,
block|{
literal|0x15
block|,
name|print_hgst_info_background_scan
block|}
block|,
block|{
literal|0x30
block|,
name|print_hgst_info_erase_errors
block|}
block|,
block|{
literal|0x31
block|,
name|print_hgst_info_erase_counts
block|}
block|,
block|{
literal|0x32
block|,
name|print_hgst_info_temp_history
block|}
block|,
block|{
literal|0x37
block|,
name|print_hgst_info_ssd_perf
block|}
block|,
block|{
literal|0x38
block|,
name|print_hgst_info_firmware_load
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Print a subpage that is basically just key value pairs */
end_comment

begin_function
specifier|static
name|void
name|print_hgst_info_subpage_gen
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|,
specifier|const
name|struct
name|kv_name
modifier|*
name|kv
parameter_list|,
name|size_t
name|kv_count
parameter_list|)
block|{
name|uint8_t
modifier|*
name|wsp
decl_stmt|,
modifier|*
name|esp
decl_stmt|;
name|uint16_t
name|ptype
decl_stmt|;
name|uint8_t
name|plen
decl_stmt|;
name|uint64_t
name|param
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wsp
operator|=
name|buf
expr_stmt|;
name|esp
operator|=
name|wsp
operator|+
name|size
expr_stmt|;
while|while
condition|(
name|wsp
operator|<
name|esp
condition|)
block|{
name|ptype
operator|=
name|le16dec
argument_list|(
name|wsp
argument_list|)
expr_stmt|;
name|wsp
operator|+=
literal|2
expr_stmt|;
name|wsp
operator|++
expr_stmt|;
comment|/* Flags, just ignore */
name|plen
operator|=
operator|*
name|wsp
operator|++
expr_stmt|;
name|param
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|plen
condition|;
name|i
operator|++
control|)
name|param
operator||=
operator|(
name|uint64_t
operator|)
operator|*
name|wsp
operator|++
operator|<<
operator|(
name|i
operator|*
literal|8
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %jd\n"
argument_list|,
name|kv_lookup
argument_list|(
name|kv
argument_list|,
name|kv_count
argument_list|,
name|ptype
argument_list|)
argument_list|,
operator|(
name|uintmax_t
operator|)
name|param
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_write_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
specifier|static
name|struct
name|kv_name
name|kv
index|[]
init|=
block|{
block|{
literal|0x0000
block|,
literal|"Corrected Without Delay"
block|}
block|,
block|{
literal|0x0001
block|,
literal|"Corrected Maybe Delayed"
block|}
block|,
block|{
literal|0x0002
block|,
literal|"Re-Writes"
block|}
block|,
block|{
literal|0x0003
block|,
literal|"Errors Corrected"
block|}
block|,
block|{
literal|0x0004
block|,
literal|"Correct Algorithm Used"
block|}
block|,
block|{
literal|0x0005
block|,
literal|"Bytes Processed"
block|}
block|,
block|{
literal|0x0006
block|,
literal|"Uncorrected Errors"
block|}
block|,
block|{
literal|0x8000
block|,
literal|"Flash Write Commands"
block|}
block|,
block|{
literal|0x8001
block|,
literal|"HGST Special"
block|}
block|, 	}
decl_stmt|;
name|printf
argument_list|(
literal|"Write Errors Subpage:\n"
argument_list|)
expr_stmt|;
name|print_hgst_info_subpage_gen
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|,
name|size
argument_list|,
name|kv
argument_list|,
name|nitems
argument_list|(
name|kv
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_read_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
specifier|static
name|struct
name|kv_name
name|kv
index|[]
init|=
block|{
block|{
literal|0x0000
block|,
literal|"Corrected Without Delay"
block|}
block|,
block|{
literal|0x0001
block|,
literal|"Corrected Maybe Delayed"
block|}
block|,
block|{
literal|0x0002
block|,
literal|"Re-Reads"
block|}
block|,
block|{
literal|0x0003
block|,
literal|"Errors Corrected"
block|}
block|,
block|{
literal|0x0004
block|,
literal|"Correct Algorithm Used"
block|}
block|,
block|{
literal|0x0005
block|,
literal|"Bytes Processed"
block|}
block|,
block|{
literal|0x0006
block|,
literal|"Uncorrected Errors"
block|}
block|,
block|{
literal|0x8000
block|,
literal|"Flash Read Commands"
block|}
block|,
block|{
literal|0x8001
block|,
literal|"XOR Recovered"
block|}
block|,
block|{
literal|0x8002
block|,
literal|"Total Corrected Bits"
block|}
block|, 	}
decl_stmt|;
name|printf
argument_list|(
literal|"Read Errors Subpage:\n"
argument_list|)
expr_stmt|;
name|print_hgst_info_subpage_gen
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|,
name|size
argument_list|,
name|kv
argument_list|,
name|nitems
argument_list|(
name|kv
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_verify_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
specifier|static
name|struct
name|kv_name
name|kv
index|[]
init|=
block|{
block|{
literal|0x0000
block|,
literal|"Corrected Without Delay"
block|}
block|,
block|{
literal|0x0001
block|,
literal|"Corrected Maybe Delayed"
block|}
block|,
block|{
literal|0x0002
block|,
literal|"Re-Reads"
block|}
block|,
block|{
literal|0x0003
block|,
literal|"Errors Corrected"
block|}
block|,
block|{
literal|0x0004
block|,
literal|"Correct Algorithm Used"
block|}
block|,
block|{
literal|0x0005
block|,
literal|"Bytes Processed"
block|}
block|,
block|{
literal|0x0006
block|,
literal|"Uncorrected Errors"
block|}
block|,
block|{
literal|0x8000
block|,
literal|"Commands Processed"
block|}
block|, 	}
decl_stmt|;
name|printf
argument_list|(
literal|"Verify Errors Subpage:\n"
argument_list|)
expr_stmt|;
name|print_hgst_info_subpage_gen
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|,
name|size
argument_list|,
name|kv
argument_list|,
name|nitems
argument_list|(
name|kv
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_self_test
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|uint16_t
name|code
decl_stmt|,
name|hrs
decl_stmt|;
name|uint32_t
name|lba
decl_stmt|;
name|printf
argument_list|(
literal|"Self Test Subpage:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|/
literal|20
condition|;
name|i
operator|++
control|)
block|{
comment|/* Each entry is 20 bytes */
name|code
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|walker
operator|++
expr_stmt|;
comment|/* Ignore fixed flags */
if|if
condition|(
operator|*
name|walker
operator|==
literal|0
condition|)
comment|/* Last entry is zero length */
break|break;
if|if
condition|(
operator|*
name|walker
operator|++
operator|!=
literal|0x10
condition|)
block|{
name|printf
argument_list|(
literal|"Bad length for self test report\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"Recent Test"
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Self-Test Results"
argument_list|,
operator|*
name|walker
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Self-Test Code"
argument_list|,
operator|(
operator|*
name|walker
operator|>>
literal|5
operator|)
operator|&
literal|0x7
argument_list|)
expr_stmt|;
name|walker
operator|++
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Self-Test Number"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|hrs
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|lba
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %u\n"
argument_list|,
literal|"Total Power On Hrs"
argument_list|,
name|hrs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#jx (%jd)\n"
argument_list|,
literal|"LBA"
argument_list|,
operator|(
name|uintmax_t
operator|)
name|lba
argument_list|,
operator|(
name|uintmax_t
operator|)
name|lba
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Sense Key"
argument_list|,
operator|*
name|walker
operator|++
operator|&
literal|0xf
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Additional Sense Code"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Additional Sense Qualifier"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"Vendor Specific Detail"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_background_scan
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
name|uint8_t
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|uint8_t
name|status
decl_stmt|;
name|uint16_t
name|code
decl_stmt|,
name|nscan
decl_stmt|,
name|progress
decl_stmt|;
name|uint32_t
name|pom
decl_stmt|,
name|nand
decl_stmt|;
name|printf
argument_list|(
literal|"Background Media Scan Subpage:\n"
argument_list|)
expr_stmt|;
comment|/* Decode the header */
name|code
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|walker
operator|++
expr_stmt|;
comment|/* Ignore fixed flags */
if|if
condition|(
operator|*
name|walker
operator|++
operator|!=
literal|0x10
condition|)
block|{
name|printf
argument_list|(
literal|"Bad length for background scan header\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|code
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Expceted code 0, found code %#x\n"
argument_list|,
name|code
argument_list|)
expr_stmt|;
return|return;
block|}
name|pom
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
name|walker
operator|++
expr_stmt|;
comment|/* Reserved */
name|status
operator|=
operator|*
name|walker
operator|++
expr_stmt|;
name|nscan
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|progress
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|walker
operator|+=
literal|6
expr_stmt|;
comment|/* Reserved */
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"Power On Minutes"
argument_list|,
name|pom
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %x (%s)\n"
argument_list|,
literal|"BMS Status"
argument_list|,
name|status
argument_list|,
name|status
operator|==
literal|0
condition|?
literal|"idle"
else|:
operator|(
name|status
operator|==
literal|1
condition|?
literal|"active"
else|:
operator|(
name|status
operator|==
literal|8
condition|?
literal|"suspended"
else|:
literal|"unknown"
operator|)
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"Number of BMS"
argument_list|,
name|nscan
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"Progress Current BMS"
argument_list|,
name|progress
argument_list|)
expr_stmt|;
comment|/* Report retirements */
if|if
condition|(
name|walker
operator|-
operator|(
name|uint8_t
operator|*
operator|)
name|buf
operator|!=
literal|20
condition|)
block|{
name|printf
argument_list|(
literal|"Coding error, offset not 20\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|size
operator|-=
literal|20
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"BMS retirements"
argument_list|,
name|size
operator|/
literal|0x18
argument_list|)
expr_stmt|;
while|while
condition|(
name|size
operator|>
literal|0
condition|)
block|{
name|code
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|walker
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|walker
operator|++
operator|!=
literal|0x14
condition|)
block|{
name|printf
argument_list|(
literal|"Bad length parameter\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pom
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
comment|/* 		 * Spec sheet says the following are hard coded, if true, just 		 * print the NAND retirement. 		 */
if|if
condition|(
name|walker
index|[
literal|0
index|]
operator|==
literal|0x41
operator|&&
name|walker
index|[
literal|1
index|]
operator|==
literal|0x0b
operator|&&
name|walker
index|[
literal|2
index|]
operator|==
literal|0x01
operator|&&
name|walker
index|[
literal|3
index|]
operator|==
literal|0x00
operator|&&
name|walker
index|[
literal|4
index|]
operator|==
literal|0x00
operator|&&
name|walker
index|[
literal|5
index|]
operator|==
literal|0x00
operator|&&
name|walker
index|[
literal|6
index|]
operator|==
literal|0x00
operator|&&
name|walker
index|[
literal|7
index|]
operator|==
literal|0x00
condition|)
block|{
name|walker
operator|+=
literal|8
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
comment|/* Skip reserved */
name|nand
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"Retirement number"
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %-28s: %#x\n"
argument_list|,
literal|"NAND (C/T)BBBPPP"
argument_list|,
name|nand
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Parameter %#x entry corrupt\n"
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|16
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_erase_errors
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
specifier|static
name|struct
name|kv_name
name|kv
index|[]
init|=
block|{
block|{
literal|0x0000
block|,
literal|"Corrected Without Delay"
block|}
block|,
block|{
literal|0x0001
block|,
literal|"Corrected Maybe Delayed"
block|}
block|,
block|{
literal|0x0002
block|,
literal|"Re-Erase"
block|}
block|,
block|{
literal|0x0003
block|,
literal|"Errors Corrected"
block|}
block|,
block|{
literal|0x0004
block|,
literal|"Correct Algorithm Used"
block|}
block|,
block|{
literal|0x0005
block|,
literal|"Bytes Processed"
block|}
block|,
block|{
literal|0x0006
block|,
literal|"Uncorrected Errors"
block|}
block|,
block|{
literal|0x8000
block|,
literal|"Flash Erase Commands"
block|}
block|,
block|{
literal|0x8001
block|,
literal|"Mfg Defect Count"
block|}
block|,
block|{
literal|0x8002
block|,
literal|"Grown Defect Count"
block|}
block|,
block|{
literal|0x8003
block|,
literal|"Erase Count -- User"
block|}
block|,
block|{
literal|0x8004
block|,
literal|"Erase Count -- System"
block|}
block|, 	}
decl_stmt|;
name|printf
argument_list|(
literal|"Erase Errors Subpage:\n"
argument_list|)
expr_stmt|;
name|print_hgst_info_subpage_gen
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|,
name|size
argument_list|,
name|kv
argument_list|,
name|nitems
argument_list|(
name|kv
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_erase_counts
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
parameter_list|)
block|{
comment|/* My drive doesn't export this -- so not coding up */
name|printf
argument_list|(
literal|"XXX: Erase counts subpage: %p, %#x %d\n"
argument_list|,
name|buf
argument_list|,
name|subtype
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_temp_history
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|uint8_t
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|uint32_t
name|min
decl_stmt|;
name|printf
argument_list|(
literal|"Temperature History:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d C\n"
argument_list|,
literal|"Current Temperature"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d C\n"
argument_list|,
literal|"Reference Temperature"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d C\n"
argument_list|,
literal|"Maximum Temperature"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d C\n"
argument_list|,
literal|"Minimum Temperature"
argument_list|,
operator|*
name|walker
operator|++
argument_list|)
expr_stmt|;
name|min
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d:%02d:00\n"
argument_list|,
literal|"Max Temperture Time"
argument_list|,
name|min
operator|/
literal|60
argument_list|,
name|min
operator|%
literal|60
argument_list|)
expr_stmt|;
name|min
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d:%02d:00\n"
argument_list|,
literal|"Over Temperture Duration"
argument_list|,
name|min
operator|/
literal|60
argument_list|,
name|min
operator|%
literal|60
argument_list|)
expr_stmt|;
name|min
operator|=
name|le32dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|4
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d:%02d:00\n"
argument_list|,
literal|"Min Temperture Time"
argument_list|,
name|min
operator|/
literal|60
argument_list|,
name|min
operator|%
literal|60
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_ssd_perf
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|uint8_t
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
name|printf
argument_list|(
literal|"SSD Performance Subpage Type %d:\n"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Read Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Read Blocks"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Cache Read Hits Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Cache Read Hits Blocks"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Read Commands Stalled"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Write Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Write Blocks"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Write Odd Start Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Write Odd End Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"Host Write Commands Stalled"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"NAND Read Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"NAND Read Blocks"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"NAND Write Commands"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"NAND Write Blocks"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|le64dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|8
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %ju\n"
argument_list|,
literal|"NAND Read Before Writes"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_firmware_load
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint16_t
name|subtype
name|__unused
parameter_list|,
name|uint8_t
name|res
name|__unused
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|uint8_t
modifier|*
name|walker
init|=
name|buf
decl_stmt|;
name|printf
argument_list|(
literal|"Firmware Load Subpage:\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"  %-30s: %d\n"
argument_list|,
literal|"Firmware Downloads"
argument_list|,
name|le32dec
argument_list|(
name|walker
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|kv_indirect
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|subtype
parameter_list|,
name|uint8_t
name|res
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|struct
name|subpage_print
modifier|*
name|sp
parameter_list|,
name|size_t
name|nsp
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsp
condition|;
name|i
operator|++
operator|,
name|sp
operator|++
control|)
block|{
if|if
condition|(
name|sp
operator|->
name|key
operator|==
name|subtype
condition|)
block|{
name|sp
operator|->
name|fn
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|,
name|res
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|printf
argument_list|(
literal|"No handler for page type %x\n"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_hgst_info_log
parameter_list|(
name|void
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|size
name|__unused
parameter_list|)
block|{
name|uint8_t
modifier|*
name|walker
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|subpage
decl_stmt|;
name|int
name|pages
decl_stmt|;
name|uint16_t
name|len
decl_stmt|;
name|uint8_t
name|subtype
decl_stmt|,
name|res
decl_stmt|;
name|printf
argument_list|(
literal|"HGST Extra Info Log\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"===================\n"
argument_list|)
expr_stmt|;
name|walker
operator|=
name|buf
expr_stmt|;
name|pages
operator|=
operator|*
name|walker
operator|++
expr_stmt|;
name|walker
operator|++
expr_stmt|;
name|len
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
literal|2
expr_stmt|;
name|end
operator|=
name|walker
operator|+
name|len
expr_stmt|;
comment|/* Length is exclusive of this header */
while|while
condition|(
name|walker
operator|<
name|end
condition|)
block|{
name|subpage
operator|=
name|walker
operator|+
literal|4
expr_stmt|;
name|subtype
operator|=
operator|*
name|walker
operator|++
operator|&
literal|0x3f
expr_stmt|;
comment|/* subtype */
name|res
operator|=
operator|*
name|walker
operator|++
expr_stmt|;
comment|/* Reserved */
name|len
operator|=
name|le16dec
argument_list|(
name|walker
argument_list|)
expr_stmt|;
name|walker
operator|+=
name|len
operator|+
literal|2
expr_stmt|;
comment|/* Length, not incl header */
if|if
condition|(
name|walker
operator|>
name|end
condition|)
block|{
name|printf
argument_list|(
literal|"Ooops! Off the end of the list\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|kv_indirect
argument_list|(
name|subpage
argument_list|,
name|subtype
argument_list|,
name|res
argument_list|,
name|len
argument_list|,
name|hgst_subpage
argument_list|,
name|nitems
argument_list|(
name|hgst_subpage
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Table of log page printer / sizing.  *  * This includes Intel specific pages that are widely implemented. Not  * sure how best to switch between different vendors.  */
end_comment

begin_struct
specifier|static
struct|struct
name|logpage_function
block|{
name|uint8_t
name|log_page
decl_stmt|;
specifier|const
name|char
modifier|*
name|vendor
decl_stmt|;
name|print_fn_t
name|print_fn
decl_stmt|;
name|size_t
name|size
decl_stmt|;
block|}
name|logfuncs
index|[]
init|=
block|{
block|{
name|NVME_LOG_ERROR
block|,
name|NULL
block|,
name|print_log_error
block|,
literal|0
block|}
block|,
block|{
name|NVME_LOG_HEALTH_INFORMATION
block|,
name|NULL
block|,
name|print_log_health
block|,
expr|sizeof
operator|(
expr|struct
name|nvme_health_information_page
operator|)
block|}
block|,
block|{
name|NVME_LOG_FIRMWARE_SLOT
block|,
name|NULL
block|,
name|print_log_firmware
block|,
expr|sizeof
operator|(
expr|struct
name|nvme_firmware_page
operator|)
block|}
block|,
block|{
name|HGST_INFO_LOG
block|,
literal|"hgst"
block|,
name|print_hgst_info_log
block|,
name|DEFAULT_SIZE
block|}
block|,
block|{
name|HGST_INFO_LOG
block|,
literal|"wdc"
block|,
name|print_hgst_info_log
block|,
name|DEFAULT_SIZE
block|}
block|,
block|{
name|INTEL_LOG_TEMP_STATS
block|,
literal|"intel"
block|,
name|print_intel_temp_stats
block|,
expr|sizeof
operator|(
expr|struct
name|intel_log_temp_stats
operator|)
block|}
block|,
block|{
name|INTEL_LOG_READ_LAT_LOG
block|,
literal|"intel"
block|,
name|print_intel_read_lat_log
block|,
name|DEFAULT_SIZE
block|}
block|,
block|{
name|INTEL_LOG_WRITE_LAT_LOG
block|,
literal|"intel"
block|,
name|print_intel_write_lat_log
block|,
name|DEFAULT_SIZE
block|}
block|,
block|{
name|INTEL_LOG_ADD_SMART
block|,
literal|"intel"
block|,
name|print_intel_add_smart
block|,
name|DEFAULT_SIZE
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|, }
struct|;
end_struct

begin_function
specifier|static
name|void
name|logpage_usage
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"usage:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|LOGPAGE_USAGE
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|logpage
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|fd
decl_stmt|,
name|nsid
decl_stmt|;
name|int
name|log_page
init|=
literal|0
decl_stmt|,
name|pageflag
init|=
name|false
decl_stmt|;
name|int
name|binflag
init|=
name|false
decl_stmt|,
name|hexflag
init|=
name|false
decl_stmt|,
name|ns_specified
decl_stmt|;
name|char
name|ch
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|char
name|cname
index|[
literal|64
index|]
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|void
modifier|*
name|buf
decl_stmt|;
specifier|const
name|char
modifier|*
name|vendor
init|=
name|NULL
decl_stmt|;
name|struct
name|logpage_function
modifier|*
name|f
decl_stmt|;
name|struct
name|nvme_controller_data
name|cdata
decl_stmt|;
name|print_fn_t
name|print_fn
decl_stmt|;
while|while
condition|(
operator|(
name|ch
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"bp:xv:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
literal|'b'
case|:
name|binflag
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
comment|/* TODO: Add human-readable ASCII page IDs */
name|log_page
operator|=
name|strtol
argument_list|(
name|optarg
argument_list|,
operator|&
name|p
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
operator|&&
operator|*
name|p
operator|!=
literal|'\0'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\"%s\" not valid log page id.\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|logpage_usage
argument_list|()
expr_stmt|;
block|}
name|pageflag
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|hexflag
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|vendor
operator|=
name|optarg
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|pageflag
condition|)
block|{
name|printf
argument_list|(
literal|"Missing page_id (-p).\n"
argument_list|)
expr_stmt|;
name|logpage_usage
argument_list|()
expr_stmt|;
block|}
comment|/* Check that a controller and/or namespace was specified. */
if|if
condition|(
name|optind
operator|>=
name|argc
condition|)
name|logpage_usage
argument_list|()
expr_stmt|;
if|if
condition|(
name|strstr
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
name|NVME_NS_PREFIX
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|ns_specified
operator|=
name|true
expr_stmt|;
name|parse_ns_str
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
name|cname
argument_list|,
operator|&
name|nsid
argument_list|)
expr_stmt|;
name|open_dev
argument_list|(
name|cname
argument_list|,
operator|&
name|fd
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ns_specified
operator|=
name|false
expr_stmt|;
name|nsid
operator|=
name|NVME_GLOBAL_NAMESPACE_TAG
expr_stmt|;
name|open_dev
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
operator|&
name|fd
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|read_controller_data
argument_list|(
name|fd
argument_list|,
operator|&
name|cdata
argument_list|)
expr_stmt|;
comment|/* 	 * The log page attribtues indicate whether or not the controller 	 * supports the SMART/Health information log page on a per 	 * namespace basis. 	 */
if|if
condition|(
name|ns_specified
condition|)
block|{
if|if
condition|(
name|log_page
operator|!=
name|NVME_LOG_HEALTH_INFORMATION
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"log page %d valid only at controller level"
argument_list|,
name|log_page
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdata
operator|.
name|lpa
operator|.
name|ns_smart
operator|==
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"controller does not support per namespace "
literal|"smart/health information"
argument_list|)
expr_stmt|;
block|}
name|print_fn
operator|=
name|print_hex
expr_stmt|;
name|size
operator|=
name|DEFAULT_SIZE
expr_stmt|;
if|if
condition|(
name|binflag
condition|)
name|print_fn
operator|=
name|print_bin
expr_stmt|;
if|if
condition|(
operator|!
name|binflag
operator|&&
operator|!
name|hexflag
condition|)
block|{
comment|/* 		 * See if there is a pretty print function for the specified log 		 * page.  If one isn't found, we just revert to the default 		 * (print_hex). If there was a vendor specified bt the user, and 		 * the page is vendor specific, don't match the print function 		 * unless the vendors match. 		 */
for|for
control|(
name|f
operator|=
name|logfuncs
init|;
name|f
operator|->
name|log_page
operator|>
literal|0
condition|;
name|f
operator|++
control|)
block|{
if|if
condition|(
name|f
operator|->
name|vendor
operator|!=
name|NULL
operator|&&
name|vendor
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|f
operator|->
name|vendor
argument_list|,
name|vendor
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|log_page
operator|!=
name|f
operator|->
name|log_page
condition|)
continue|continue;
name|print_fn
operator|=
name|f
operator|->
name|print_fn
expr_stmt|;
name|size
operator|=
name|f
operator|->
name|size
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|log_page
operator|==
name|NVME_LOG_ERROR
condition|)
block|{
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|nvme_error_information_entry
argument_list|)
expr_stmt|;
name|size
operator|*=
operator|(
name|cdata
operator|.
name|elpe
operator|+
literal|1
operator|)
expr_stmt|;
block|}
comment|/* Read the log page */
name|buf
operator|=
name|get_log_buffer
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|read_logpage
argument_list|(
name|fd
argument_list|,
name|log_page
argument_list|,
name|nsid
argument_list|,
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|print_fn
argument_list|(
name|buf
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1994, Paul Richards.  *   * All rights reserved.  *   * This software may be used, modified, copied, distributed, and sold, in both  * source and binary form provided that the above copyright and these terms  * are retained, verbatim, as the first lines of this file.  Under no  * circumstances is the author responsible for the proper functioning of this  * software, nor does the author assume any responsibility for damages  * incurred with its use.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<machine/console.h>
end_include

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_decl_stmt
specifier|static
name|char
name|color_termcap
index|[]
init|=
literal|"\ :pa#64:Co#8:Sf=\\E[3%dm:Sb=\\E[4%dm:op=\\E[37;40m:md=\\E[1m:mh=\\E[30;1m:"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|color_entry
index|[]
init|=
literal|"\ cons25|ansis|ansi80x25:"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|mono_termcap
index|[]
init|=
literal|"\ :us=\E[4m:ue=\E[m:"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|mono_entry
index|[]
init|=
literal|"\ cons25-m|ansis-mono|ansi80x25-mono:"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|common_termcap
index|[]
init|=
literal|"\ :ac=l\\332m\\300k\\277j\\331u\\264t\\303v\\301w\\302q\\304x\\263n\\305`^Da\\260f\\370g\\361~\\371.^Y-^Xh\\261I^U0\\333y\\363z\\362:\ :al=\\E[L:am:bs:cd=\\E[J:ce=\\E[K:cl=\\E[H\\E[J:cm=\\E[%i%d;%dH:co#80:\ :dc=\\E[P:dl=\\E[M:do=\\E[B:bt=\\E[Z:ho=\\E[H:ic=\\E[@:li#25:\ :ms:nd=\\E[C:pt:rs=\\E[x\\E[m\\Ec:so=\\E[7m:se=\\E[m:up=\\E[A:\ :k1=\\E[M:k2=\\E[N:k3=\\E[O:k4=\\E[P:k5=\\E[Q:k6=\\E[R:k7=\\E[S:k8=\\E[T:\ :k9=\\E[U:k;=\\E[V:F1=\\E[W:F2=\\E[X:\ :kb=^H:kh=\\E[H:ku=\\E[A:kd=\\E[B:kl=\\E[D:kr=\\E[C:\ :le=^H:eo:sf=\\E[S:sr=\\E[T:\ :kN=\\E[G:kP=\\E[I:@7=\\E[F:kI=\\E[L:kD=\\177:kB=\\E[Z:\ :IC=\\E[%d@:DC=\\E[%dP:SF=\\E[%dS:SR=\\E[%dT:AL=\\E[%dL:DL=\\E[%dM:\ :DO=\\E[%dB:LE=\\E[%dD:RI=\\E[%dC:UP=\\E[%dA:ec=\\E[%dX:cv=\\E[%dd:ch=\\E[%d`:bw:\ :mb=\\E[5m:mr=\\E[7m:me=\\E[m:bl=^G:ut:it#8:"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|emergency
parameter_list|(
name|int
name|color
parameter_list|)
block|{
name|char
name|tempbuf
index|[
sizeof|sizeof
argument_list|(
name|common_termcap
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|color_termcap
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|mono_entry
argument_list|)
index|]
decl_stmt|;
name|strcpy
argument_list|(
name|tempbuf
argument_list|,
name|color
condition|?
name|color_entry
else|:
name|mono_entry
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tempbuf
argument_list|,
name|common_termcap
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tempbuf
argument_list|,
name|color
condition|?
name|color_termcap
else|:
name|mono_termcap
argument_list|)
expr_stmt|;
if|if
condition|(
name|setenv
argument_list|(
literal|"TERMCAP"
argument_list|,
name|tempbuf
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|set_termcap
parameter_list|()
block|{
name|char
modifier|*
name|term
decl_stmt|;
name|term
operator|=
name|getenv
argument_list|(
literal|"TERM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|term
operator|==
name|NULL
condition|)
block|{
name|int
name|color_display
decl_stmt|,
name|no_termcap
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|access
argument_list|(
literal|"/etc/termcap.small"
argument_list|,
name|R_OK
argument_list|)
condition|)
block|{
name|no_termcap
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|setenv
argument_list|(
literal|"TERMCAP"
argument_list|,
literal|"/etc/termcap.small"
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ioctl
argument_list|(
name|STDERR_FILENO
argument_list|,
name|GIO_COLOR
argument_list|,
operator|&
name|color_display
argument_list|)
operator|<
literal|0
condition|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
comment|/* serial console */
if|if
condition|(
name|no_termcap
condition|)
return|return
operator|-
literal|1
return|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Enter your terminal type (must be present in /etc/termcap.small): "
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'\n'
condition|)
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|setenv
argument_list|(
literal|"TERM"
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|color_display
condition|)
block|{
comment|/* color console */
if|if
condition|(
name|setenv
argument_list|(
literal|"TERM"
argument_list|,
literal|"cons25"
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
comment|/* mono console */
if|if
condition|(
name|setenv
argument_list|(
literal|"TERM"
argument_list|,
literal|"cons25-m"
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|no_termcap
condition|)
block|{
if|if
condition|(
name|emergency
argument_list|(
name|color_display
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


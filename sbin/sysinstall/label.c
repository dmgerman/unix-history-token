begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * $Id: label.c,v 1.23.2.1 1994/11/21 03:12:01 phk Exp $  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_define
define|#
directive|define
name|DKTYPENAMES
end_define

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ffs/fs.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<ufs/ffs/fs.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_function
specifier|static
name|int
name|AskWhichPartition
parameter_list|(
name|char
modifier|*
name|prompt
parameter_list|)
block|{
name|char
name|buf
index|[
literal|10
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|buf
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|AskEm
argument_list|(
name|stdscr
argument_list|,
name|prompt
argument_list|,
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|'\n'
operator|&&
name|i
operator|!=
literal|'\r'
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|strchr
argument_list|(
literal|"abefghABEFGH"
argument_list|,
operator|*
name|buf
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|tolower
argument_list|(
operator|*
name|buf
argument_list|)
operator|-
literal|'a'
return|;
block|}
end_function

begin_function
name|void
name|DiskLabel
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|done
init|=
literal|0
decl_stmt|,
name|diskno
decl_stmt|,
name|k
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|struct
name|disklabel
modifier|*
name|lbl
decl_stmt|,
name|olbl
decl_stmt|;
name|struct
name|dos_partition
name|dp
index|[
name|NDOSPART
index|]
decl_stmt|;
name|u_long
name|cyl
decl_stmt|,
name|hd
decl_stmt|,
name|sec
decl_stmt|,
name|tsec
decl_stmt|;
name|u_long
name|l1
decl_stmt|,
name|l2
decl_stmt|,
name|l3
decl_stmt|,
name|l4
decl_stmt|;
name|char
modifier|*
name|yip
init|=
name|NULL
decl_stmt|;
name|u_long
name|allocated_space
decl_stmt|,
name|ourpart_size
decl_stmt|,
name|ourpart_offset
decl_stmt|;
operator|*
name|buf
operator|=
literal|0
expr_stmt|;
name|i
operator|=
name|AskEm
argument_list|(
name|stdscr
argument_list|,
literal|"Enter number of disk to Disklabel> "
argument_list|,
name|buf
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|Debug
argument_list|(
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|'\n'
operator|&&
name|i
operator|!=
literal|'\r'
condition|)
return|return;
name|diskno
operator|=
name|atoi
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|diskno
operator|>=
literal|0
operator|&&
name|diskno
operator|<
name|MAX_NO_DISKS
operator|&&
name|Dname
index|[
name|diskno
index|]
operator|)
condition|)
block|{
return|return;
block|}
name|olbl
operator|=
operator|*
name|Dlbl
index|[
name|diskno
index|]
expr_stmt|;
name|lbl
operator|=
operator|&
name|olbl
expr_stmt|;
name|cyl
operator|=
name|lbl
operator|->
name|d_ncylinders
expr_stmt|;
name|hd
operator|=
name|lbl
operator|->
name|d_ntracks
expr_stmt|;
name|sec
operator|=
name|lbl
operator|->
name|d_nsectors
expr_stmt|;
name|tsec
operator|=
name|lbl
operator|->
name|d_secperunit
expr_stmt|;
for|for
control|(
name|i
operator|=
name|lbl
operator|->
name|d_npartitions
init|;
name|i
operator|<
name|MAXPARTITIONS
condition|;
name|i
operator|++
control|)
block|{
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|=
literal|0
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|=
literal|0
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_fstype
operator|=
literal|0
expr_stmt|;
block|}
name|lbl
operator|->
name|d_npartitions
operator|=
name|MAXPARTITIONS
expr_stmt|;
if|if
condition|(
name|Dname
index|[
name|diskno
index|]
index|[
literal|0
index|]
operator|==
literal|'s'
operator|&&
name|Dname
index|[
name|diskno
index|]
index|[
literal|1
index|]
operator|==
literal|'d'
condition|)
name|lbl
operator|->
name|d_type
operator|=
name|DTYPE_SCSI
expr_stmt|;
else|else
name|lbl
operator|->
name|d_type
operator|=
name|DTYPE_ST506
expr_stmt|;
while|while
condition|(
operator|!
name|done
condition|)
block|{
name|clear
argument_list|()
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
if|if
condition|(
name|yip
condition|)
block|{
name|standout
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|24
argument_list|,
literal|0
argument_list|,
name|yip
argument_list|)
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
name|beep
argument_list|()
expr_stmt|;
name|yip
operator|=
name|NULL
expr_stmt|;
block|}
name|j
operator|=
literal|0
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s -- Diskspace editor -- DISKLABEL"
argument_list|,
name|TITLE
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|allocated_space
operator|=
literal|0
expr_stmt|;
name|ourpart_size
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|OURPART
index|]
operator|.
name|p_size
expr_stmt|;
name|ourpart_offset
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|OURPART
index|]
operator|.
name|p_offset
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Part  Start       End    Blocks     MB  Type    Action  Mountpoint"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXPARTITIONS
condition|;
name|i
operator|++
control|)
block|{
name|refresh
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%c "
argument_list|,
literal|'a'
operator|+
name|i
argument_list|)
expr_stmt|;
name|printw
argument_list|(
literal|" %8u  %8u  %8u  %5u  "
argument_list|,
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
argument_list|,
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|+
operator|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
condition|?
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|-
literal|1
else|:
literal|0
operator|)
argument_list|,
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
argument_list|,
operator|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|+
literal|1024
operator|)
operator|/
literal|2048
argument_list|)
expr_stmt|;
name|k
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_fstype
expr_stmt|;
if|if
condition|(
name|k
operator|>
name|FSMAXTYPES
condition|)
name|printw
argument_list|(
literal|"%04x   "
argument_list|,
name|k
argument_list|)
expr_stmt|;
else|else
name|printw
argument_list|(
literal|"%-7.7s "
argument_list|,
name|fstypenames
index|[
name|k
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|MP
index|[
name|diskno
index|]
index|[
name|i
index|]
condition|)
name|printw
argument_list|(
literal|"        "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|Ftype
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|i
index|]
index|]
argument_list|,
literal|"swap"
argument_list|)
condition|)
name|printw
argument_list|(
literal|"swap    "
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|Faction
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|i
index|]
index|]
condition|)
name|printw
argument_list|(
literal|"newfs   "
argument_list|)
expr_stmt|;
else|else
name|printw
argument_list|(
literal|"mount   "
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|OURPART
condition|)
name|printw
argument_list|(
literal|"<Entire FreeBSD slice>"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|==
name|RAWPART
condition|)
name|printw
argument_list|(
literal|"<Entire Disk>"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|i
index|]
index|]
condition|)
name|printw
argument_list|(
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|i
index|]
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|>=
name|ourpart_offset
operator|)
operator|&&
operator|(
operator|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|+
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|)
operator|<=
operator|(
name|ourpart_offset
operator|+
name|ourpart_size
operator|)
operator|)
condition|)
name|allocated_space
operator|+=
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
expr_stmt|;
block|}
block|}
name|mvprintw
argument_list|(
literal|17
argument_list|,
literal|0
argument_list|,
literal|"Total size:      %8lu blocks  %5luMb"
argument_list|,
name|ourpart_size
argument_list|,
operator|(
name|ourpart_size
operator|+
literal|1024
operator|)
operator|/
literal|2048
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|18
argument_list|,
literal|0
argument_list|,
literal|"Space allocated: %8lu blocks  %5luMb"
argument_list|,
name|allocated_space
argument_list|,
operator|(
name|allocated_space
operator|+
literal|1024
operator|)
operator|/
literal|2048
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|20
argument_list|,
literal|0
argument_list|,
literal|"Commands available:   "
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|lbl
argument_list|,
name|Dlbl
index|[
name|diskno
index|]
argument_list|,
sizeof|sizeof
expr|*
name|lbl
argument_list|)
condition|)
block|{
name|standout
argument_list|()
expr_stmt|;
name|printw
argument_list|(
literal|"Use (W)rite to save changes to disk"
argument_list|)
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
block|}
name|mvprintw
argument_list|(
literal|21
argument_list|,
literal|0
argument_list|,
literal|"(H)elp  (T)utorial  (E)dit  (A)ssign  (D)elete  (R)eread  (W)rite  (Q)uit"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|,
literal|"(P)reserve  (S)lice"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"Enter Command> "
argument_list|)
expr_stmt|;
name|i
operator|=
name|getch
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|'h'
case|:
case|case
literal|'H'
case|:
case|case
literal|'?'
case|:
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s -- Diskspace editor -- DISKLABEL -- Command Help  Basic commands:  (H)elp          - This screen (T)utorial      - More detailed information on MBRs, disklabels, etc. (E)dit          - Edit an existing disklabel entry (A)ssign	- Assign a filesystem (or swap) to a partition (D)elete        - Delete an existing disklabel entry (R)eread        - Re-read disklabel from disk, discarding any changes (W)rite         - Write updated disklabel information to disk (P)reserve      - Don't newfs the filesystem (preserve old contents) (S)lice         - Import foreign slice from MBR (for example, DOS) (Q)uit          - Exit from the disklabel editor              Press any key to return to Disklabel editor... "
argument_list|,
name|TITLE
argument_list|)
expr_stmt|;
name|getch
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
case|case
literal|'T'
case|:
name|ShowFile
argument_list|(
name|HELPME_FILE
argument_list|,
literal|"Help file for disklayout"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
case|case
literal|'D'
case|:
name|j
operator|=
name|AskWhichPartition
argument_list|(
literal|"Delete which partition> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition"
expr_stmt|;
break|break;
block|}
name|CleanMount
argument_list|(
name|diskno
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|=
name|FS_UNUSED
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_size
operator|=
literal|0
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_offset
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
case|case
literal|'P'
case|:
name|j
operator|=
name|AskWhichPartition
argument_list|(
literal|"Preserve which partition> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
condition|)
block|{
name|yip
operator|=
literal|"Unmounted partitions are preserved by default"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|==
name|FS_SWAP
condition|)
block|{
name|yip
operator|=
literal|"swap partitions cannot be preserved."
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|!=
name|FS_BSDFFS
condition|)
block|{
name|yip
operator|=
literal|"All non-ufs partitions are preserved by default."
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fixit
operator|&&
operator|!
name|strcmp
argument_list|(
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
argument_list|,
literal|"/"
argument_list|)
condition|)
block|{
name|yip
operator|=
literal|"/ cannot be preserved."
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fixit
operator|&&
operator|!
name|strcmp
argument_list|(
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
argument_list|,
literal|"/usr"
argument_list|)
condition|)
block|{
name|yip
operator|=
literal|"/usr cannot be preserved."
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fixit
operator|&&
operator|!
name|strcmp
argument_list|(
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
argument_list|,
literal|"/var"
argument_list|)
condition|)
block|{
name|yip
operator|=
literal|"/var cannot be preserved."
expr_stmt|;
break|break;
block|}
name|Faction
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
operator|=
literal|1
operator|-
name|Faction
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
case|case
literal|'S'
case|:
name|read_dospart
argument_list|(
name|Dfd
index|[
name|diskno
index|]
argument_list|,
operator|&
name|dp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|=
literal|0
expr_stmt|;
name|j
operator|=
name|AskEm
argument_list|(
name|stdscr
argument_list|,
literal|"Import which fdisk slice> "
argument_list|,
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|!=
literal|'\n'
operator|&&
name|j
operator|!=
literal|'\r'
condition|)
break|break;
name|i
operator|=
name|strtoul
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|1
operator|||
name|i
operator|>
literal|4
condition|)
block|{
name|yip
operator|=
literal|"Invalid slice, must be '1' to '4'"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|dp
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|dp_size
condition|)
block|{
name|yip
operator|=
literal|"empty slice cannot be imported"
expr_stmt|;
break|break;
block|}
name|j
operator|=
name|AskWhichPartition
argument_list|(
literal|"Import on which partition> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition"
expr_stmt|;
break|break;
block|}
name|CleanMount
argument_list|(
name|diskno
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_offset
operator|=
name|dp
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|dp_start
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_size
operator|=
name|dp
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|dp_size
expr_stmt|;
switch|switch
condition|(
name|dp
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|dp_typ
condition|)
block|{
case|case
literal|0x01
case|:
case|case
literal|0x04
case|:
case|case
literal|0x06
case|:
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|=
name|FS_MSDOS
expr_stmt|;
break|break;
default|default:
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|=
name|FS_OTHER
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'e'
case|:
case|case
literal|'E'
case|:
name|j
operator|=
name|AskWhichPartition
argument_list|(
literal|"Change size of which partition> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|!=
name|FS_BSDFFS
operator|&&
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|!=
name|FS_UNUSED
operator|&&
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|!=
name|FS_SWAP
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition type"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|lbl
operator|->
name|d_partitions
index|[
name|OURPART
index|]
operator|.
name|p_size
operator|==
literal|0
condition|)
block|{
name|yip
operator|=
literal|"No FreeBSD partition defined?"
expr_stmt|;
break|break;
block|}
name|l1
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|OURPART
index|]
operator|.
name|p_offset
expr_stmt|;
name|l2
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|OURPART
index|]
operator|.
name|p_offset
operator|+
name|lbl
operator|->
name|d_partitions
index|[
name|OURPART
index|]
operator|.
name|p_size
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXPARTITIONS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|OURPART
condition|)
continue|continue;
if|if
condition|(
name|i
operator|==
name|RAWPART
condition|)
continue|continue;
if|if
condition|(
name|i
operator|==
name|j
condition|)
continue|continue;
if|if
condition|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|>=
name|l2
condition|)
continue|continue;
if|if
condition|(
operator|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|+
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|)
operator|<=
name|l1
condition|)
continue|continue;
name|l3
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|-
name|l1
expr_stmt|;
name|l4
operator|=
name|l2
operator|-
operator|(
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_offset
operator|+
name|lbl
operator|->
name|d_partitions
index|[
name|i
index|]
operator|.
name|p_size
operator|)
expr_stmt|;
if|if
condition|(
name|l3
operator|>
literal|0
operator|&&
name|l3
operator|>=
name|l4
condition|)
name|l2
operator|=
name|l1
operator|+
name|l3
expr_stmt|;
elseif|else
if|if
condition|(
name|l4
operator|>
literal|0
operator|&&
name|l4
operator|>
name|l3
condition|)
name|l1
operator|=
name|l2
operator|-
name|l4
expr_stmt|;
else|else
name|l2
operator|=
name|l1
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|l2
operator|-
name|l1
operator|)
condition|)
block|{
name|yip
operator|=
literal|"Sizes unchanged - couldn't find room"
expr_stmt|;
break|break;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%lu"
argument_list|,
operator|(
name|l2
operator|-
name|l1
operator|+
literal|1024L
operator|)
operator|/
literal|2048L
argument_list|)
expr_stmt|;
name|i
operator|=
name|AskEm
argument_list|(
name|stdscr
argument_list|,
literal|"Size of partition in MB> "
argument_list|,
name|buf
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|l3
operator|=
name|strtol
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|*
literal|2048L
expr_stmt|;
if|if
condition|(
operator|!
name|l3
condition|)
block|{
name|yip
operator|=
literal|"Invalid size given"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|l3
operator|>
name|l2
operator|-
name|l1
condition|)
name|l3
operator|=
name|l2
operator|-
name|l1
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_size
operator|=
name|l3
expr_stmt|;
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_offset
operator|=
name|l1
expr_stmt|;
if|if
condition|(
name|j
operator|==
literal|1
condition|)
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|=
name|FS_SWAP
expr_stmt|;
else|else
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
operator|=
name|FS_BSDFFS
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
case|case
literal|'R'
case|:
name|olbl
operator|=
operator|*
name|Dlbl
index|[
name|diskno
index|]
expr_stmt|;
comment|/* XXX be more selective here */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXPARTITIONS
condition|;
name|i
operator|++
control|)
name|CleanMount
argument_list|(
name|diskno
argument_list|,
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
case|case
literal|'A'
case|:
if|if
condition|(
name|memcmp
argument_list|(
name|lbl
argument_list|,
name|Dlbl
index|[
name|diskno
index|]
argument_list|,
sizeof|sizeof
expr|*
name|lbl
argument_list|)
condition|)
block|{
name|yip
operator|=
literal|"Please (W)rite changed partition information first"
expr_stmt|;
break|break;
block|}
name|j
operator|=
name|AskWhichPartition
argument_list|(
literal|"Assign which partition> "
argument_list|)
expr_stmt|;
if|if
condition|(
name|j
operator|<
literal|0
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition"
expr_stmt|;
break|break;
block|}
name|k
operator|=
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_fstype
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|FS_BSDFFS
operator|&&
name|k
operator|!=
name|FS_MSDOS
operator|&&
name|k
operator|!=
name|FS_SWAP
condition|)
block|{
name|yip
operator|=
literal|"Invalid partition type"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|lbl
operator|->
name|d_partitions
index|[
name|j
index|]
operator|.
name|p_size
condition|)
block|{
name|yip
operator|=
literal|"Zero partition size"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|k
operator|==
name|FS_SWAP
condition|)
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"swap"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
condition|)
name|strcpy
argument_list|(
name|buf
argument_list|,
name|Fmount
index|[
name|MP
index|[
name|diskno
index|]
index|[
name|j
index|]
index|]
argument_list|)
expr_stmt|;
else|else
operator|*
name|buf
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|k
operator|!=
name|FS_SWAP
condition|)
block|{
name|i
operator|=
name|AskEm
argument_list|(
name|stdscr
argument_list|,
literal|"Directory mountpoint> "
argument_list|,
name|buf
argument_list|,
literal|28
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|'\n'
operator|&&
name|i
operator|!=
literal|'\r'
condition|)
break|break;
name|p
operator|=
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
operator|&&
name|p
operator|>=
name|buf
condition|)
operator|*
name|p
operator|--
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|&&
operator|*
name|buf
operator|!=
literal|'/'
condition|)
block|{
name|yip
operator|=
literal|"Mountpoint must start with a '/'"
expr_stmt|;
break|break;
block|}
block|}
name|CleanMount
argument_list|(
name|diskno
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|buf
condition|)
break|break;
name|p
operator|=
name|SetMount
argument_list|(
name|diskno
argument_list|,
name|j
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|yip
operator|=
name|p
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
case|case
literal|'W'
case|:
operator|*
name|Dlbl
index|[
name|diskno
index|]
operator|=
operator|*
name|lbl
expr_stmt|;
name|Dlbl
index|[
name|diskno
index|]
operator|->
name|d_magic
operator|=
name|DISKMAGIC
expr_stmt|;
name|Dlbl
index|[
name|diskno
index|]
operator|->
name|d_magic2
operator|=
name|DISKMAGIC
expr_stmt|;
name|Dlbl
index|[
name|diskno
index|]
operator|->
name|d_checksum
operator|=
literal|0
expr_stmt|;
name|Dlbl
index|[
name|diskno
index|]
operator|->
name|d_checksum
operator|=
name|dkcksum
argument_list|(
name|Dlbl
index|[
name|diskno
index|]
argument_list|)
expr_stmt|;
operator|*
name|lbl
operator|=
operator|*
name|Dlbl
index|[
name|diskno
index|]
expr_stmt|;
name|enable_label
argument_list|(
name|Dfd
index|[
name|diskno
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|Dfd
index|[
name|diskno
index|]
argument_list|,
name|DIOCSDINFO
argument_list|,
name|Dlbl
index|[
name|diskno
index|]
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Fatal
argument_list|(
literal|"Couldn't set label: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|Dfd
index|[
name|diskno
index|]
argument_list|,
name|DIOCWDINFO
argument_list|,
name|Dlbl
index|[
name|diskno
index|]
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Fatal
argument_list|(
literal|"Couldn't write label: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|disable_label
argument_list|(
name|Dfd
index|[
name|diskno
index|]
argument_list|)
expr_stmt|;
name|yip
operator|=
literal|"Label written successfully."
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
case|case
literal|'Q'
case|:
if|if
condition|(
operator|!
name|memcmp
argument_list|(
name|lbl
argument_list|,
name|Dlbl
index|[
name|diskno
index|]
argument_list|,
sizeof|sizeof
expr|*
name|lbl
argument_list|)
condition|)
return|return;
comment|/* XXX be more selective here */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAXPARTITIONS
condition|;
name|i
operator|++
control|)
name|CleanMount
argument_list|(
name|diskno
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return;
break|break;
block|}
block|}
block|}
end_function

end_unit


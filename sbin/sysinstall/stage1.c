begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* #define DEBUG  * Copyright (c) 1994, Paul Richards.  *  * All rights reserved.  *  * This software may be used, modified, copied, distributed, and  * sold, in both source and binary form provided that the above  * copyright and these terms are retained, verbatim, as the first  * lines of this file.  Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with  * its use.  */
end_comment

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|device_list
index|[]
init|=
block|{
literal|"wd"
block|,
literal|"sd"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|query_disks
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
name|disk
index|[
literal|15
index|]
decl_stmt|;
name|char
name|diskname
index|[
literal|5
index|]
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|struct
name|disklabel
name|dl
decl_stmt|;
name|int
name|fd
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NO_DISKS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|Dname
index|[
name|i
index|]
condition|)
block|{
name|close
argument_list|(
name|Dfd
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|Dfd
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|Dlbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|Dlbl
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|free
argument_list|(
name|Dname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|Dname
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|Ndisk
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|device_list
index|[
name|j
index|]
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|diskname
argument_list|,
literal|"%s%d"
argument_list|,
name|device_list
index|[
name|j
index|]
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|disk
argument_list|,
literal|"/dev/r%sd"
argument_list|,
name|diskname
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|disk
argument_list|,
operator|&
name|st
argument_list|)
operator|||
operator|!
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFCHR
operator|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|disk
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
continue|continue;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|DIOCGDINFO
argument_list|,
operator|&
name|dl
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|Dlbl
index|[
name|Ndisk
index|]
operator|=
name|Malloc
argument_list|(
sizeof|sizeof
name|dl
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|Dlbl
index|[
name|Ndisk
index|]
argument_list|,
operator|&
name|dl
argument_list|,
sizeof|sizeof
name|dl
argument_list|)
expr_stmt|;
name|Dname
index|[
name|Ndisk
index|]
operator|=
name|StrAlloc
argument_list|(
name|diskname
argument_list|)
expr_stmt|;
name|Dfd
index|[
name|Ndisk
index|]
operator|=
name|fd
expr_stmt|;
name|Ndisk
operator|++
expr_stmt|;
if|if
condition|(
name|Ndisk
operator|==
name|MAX_NO_DISKS
condition|)
return|return;
block|}
block|}
block|}
end_function

begin_function
name|int
name|stage1
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|int
name|ready
init|=
literal|0
decl_stmt|;
name|int
name|foundroot
init|=
literal|0
decl_stmt|,
name|foundusr
init|=
literal|0
decl_stmt|,
name|foundswap
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|complaint
init|=
literal|0
decl_stmt|;
name|query_disks
argument_list|()
expr_stmt|;
while|while
condition|(
operator|!
name|ready
condition|)
block|{
name|clear
argument_list|()
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
name|j
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|fixit
condition|)
block|{
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Suggested course of action:"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|(F)disk, (W)rite"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|possibly (F)disk, (B)oot"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|(D)isklabel, (A)ssign<root>"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|(A)ssign swap"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|(P)roceed"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Reboot"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Load cpio floppy"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Choose stand-alone shell"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Your old kernel, /etc/fstab"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|and /sbin/init files are"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|renamed since they will be"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|replaced from this floppy."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|You should now assign some"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|space to root, swap, and"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|(optionally) /usr partitions"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Root (/) should be a minimum"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|of 18MB with a 30MB /usr"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|or 50MB without a /usr."
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Swap space should be a"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|minimum of 12MB or RAM * 2"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|Be sure to also (A)ssign a"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|mount point to each one or"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|it will NOT be enabled."
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|We suggest that you invoke"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|(F)disk then (D)isklabel"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|in setting up your disk."
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|If installing on a drive"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|other than 0, read the"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|50
argument_list|,
literal|"|TROUBLESHOOTING doc first"
argument_list|)
expr_stmt|;
block|}
name|j
operator|=
literal|0
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%s -- Diskspace editor"
argument_list|,
name|TITLE
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Disks         Total   FreeBSD "
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NO_DISKS
operator|&&
name|Dname
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%2d: %-6s %5lu MB  %5lu MB"
argument_list|,
name|i
argument_list|,
name|Dname
index|[
name|i
index|]
argument_list|,
name|PartMb
argument_list|(
name|Dlbl
index|[
name|i
index|]
argument_list|,
name|RAWPART
argument_list|)
argument_list|,
name|PartMb
argument_list|(
name|Dlbl
index|[
name|i
index|]
argument_list|,
name|OURPART
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|j
operator|++
expr_stmt|;
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"Filesystems  Type        Size  Action Mountpoint"
argument_list|)
expr_stmt|;
name|j
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_NO_FS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|Fname
index|[
name|i
index|]
condition|)
continue|continue;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|Ftype
index|[
name|i
index|]
argument_list|,
literal|"swap"
argument_list|)
condition|)
block|{
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%2d: %-5s    %-5s   %5lu MB  %-6s %-s"
argument_list|,
name|i
argument_list|,
name|Fname
index|[
name|i
index|]
argument_list|,
name|Ftype
index|[
name|i
index|]
argument_list|,
name|Fsize
index|[
name|i
index|]
argument_list|,
literal|"swap"
argument_list|,
name|Fmount
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mvprintw
argument_list|(
name|j
operator|++
argument_list|,
literal|0
argument_list|,
literal|"%2d: %-5s    %-5s   %5lu MB  %-6s %-s"
argument_list|,
name|i
argument_list|,
name|Fname
index|[
name|i
index|]
argument_list|,
name|Ftype
index|[
name|i
index|]
argument_list|,
name|Fsize
index|[
name|i
index|]
argument_list|,
name|Faction
index|[
name|i
index|]
condition|?
literal|"newfs"
else|:
literal|"mount"
argument_list|,
name|Fmount
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|mvprintw
argument_list|(
literal|20
argument_list|,
literal|0
argument_list|,
literal|"Commands available:"
argument_list|)
expr_stmt|;
name|mvprintw
argument_list|(
literal|21
argument_list|,
literal|0
argument_list|,
literal|"(H)elp  (T)utorial  (F)disk  (D)isklabel  (P)roceed  (Q)uit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|complaint
condition|)
block|{
name|standout
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|22
argument_list|,
literal|0
argument_list|,
name|complaint
argument_list|)
expr_stmt|;
name|standend
argument_list|()
expr_stmt|;
name|complaint
operator|=
literal|0
expr_stmt|;
block|}
name|mvprintw
argument_list|(
literal|23
argument_list|,
literal|0
argument_list|,
literal|"Enter Command> "
argument_list|)
expr_stmt|;
name|i
operator|=
name|getch
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|'h'
case|:
case|case
literal|'H'
case|:
name|clear
argument_list|()
expr_stmt|;
name|mvprintw
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"%s -- Diskspace editor -- Command Help  (T)utorial	- Read a more detailed tutorial on how disklabels, MBRs, 		  etc. work. (P)roceed	- Proceed with system installation. (Q)uit		- Don't install anything. (F)disk		- Enter the FDISK (MBR) editor. (D)isklabel	- Enter the disklabel editor.  Press any key to return to Diskspace editor..."
argument_list|,
name|TITLE
argument_list|)
expr_stmt|;
name|getch
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
case|case
literal|'T'
case|:
name|ShowFile
argument_list|(
name|HELPME_FILE
argument_list|,
literal|"Help file for disklayout"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
case|case
literal|'P'
case|:
name|foundroot
operator|=
literal|0
operator|,
name|foundusr
operator|=
literal|0
operator|,
name|foundswap
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|Fmount
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|Fmount
index|[
name|i
index|]
argument_list|,
literal|"/"
argument_list|)
condition|)
name|foundroot
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|Fmount
index|[
name|i
index|]
argument_list|,
literal|"swap"
argument_list|)
condition|)
name|foundswap
operator|=
name|i
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|Fmount
index|[
name|i
index|]
argument_list|,
literal|"/usr"
argument_list|)
condition|)
name|foundusr
operator|=
name|i
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|foundroot
condition|)
block|{
name|complaint
operator|=
literal|"Please assign mountpoint for '/'"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|foundswap
condition|)
block|{
name|complaint
operator|=
literal|"Please assign mountpoint for swap"
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|fixit
operator|&&
operator|!
name|foundusr
operator|&&
name|Fsize
index|[
name|foundroot
index|]
operator|<
literal|60
condition|)
block|{
name|complaint
operator|=
literal|"Please assign mountpoint for /usr"
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dialog_yesno
argument_list|(
literal|"Last Chance!"
argument_list|,
literal|"Are you sure you want to proceed with the installation?\nLast chance before wiping your hard disk!"
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
break|break;
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|leave
goto|;
case|case
literal|'q'
case|:
case|case
literal|'Q'
case|:
name|ret
operator|=
literal|1
expr_stmt|;
goto|goto
name|leave
goto|;
case|case
literal|'f'
case|:
case|case
literal|'F'
case|:
name|Fdisk
argument_list|()
expr_stmt|;
name|query_disks
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
case|case
literal|'D'
case|:
name|DiskLabel
argument_list|()
expr_stmt|;
break|break;
default|default:
name|beep
argument_list|()
expr_stmt|;
block|}
block|}
name|leave
label|:
name|clear
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|Dname
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|close
argument_list|(
name|Dfd
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


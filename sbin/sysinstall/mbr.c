begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1994, Paul Richards.  *  * All rights reserved.  *  * This software may be used, modified, copied, distributed, and  * sold, in both source and binary form provided that the above  * copyright and these terms are retained, verbatim, as the first  * lines of this file.  Under no circumstances is the author  * responsible for the proper functioning of this software, nor does  * the author assume any responsibility for damages incurred with  * its use.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<dialog.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<fstab.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__i386__
end_ifdef

begin_comment
comment|/* temp measure delete nov 15 1994 */
end_comment

begin_define
define|#
directive|define
name|i386
value|1
end_define

begin_else
else|#
directive|else
end_else

begin_warning
warning|#
directive|warning
warning|FOO
end_warning

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/devconf.h>
end_include

begin_include
include|#
directive|include
file|<sys/disklabel.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|"sysinstall.h"
end_include

begin_include
include|#
directive|include
file|"disk.h"
end_include

begin_include
include|#
directive|include
file|"editor.h"
end_include

begin_include
include|#
directive|include
file|"mbr.h"
end_include

begin_function_decl
name|char
modifier|*
name|part_type
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|write_mbr
parameter_list|(
name|char
modifier|*
parameter_list|,
name|struct
name|mbr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|read_mbr
parameter_list|(
name|char
modifier|*
parameter_list|,
name|struct
name|mbr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|show_mbr
parameter_list|(
name|struct
name|mbr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|clear_mbr
parameter_list|(
name|struct
name|mbr
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|build_mbr
parameter_list|(
name|struct
name|mbr
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|struct
name|disklabel
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|char
name|boot1
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|disk
name|disk_list
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|part_type
name|part_types
index|[]
init|=
name|PARTITION_TYPES
expr|struct
name|field
operator|*
name|last_field
decl_stmt|;
end_decl_stmt

begin_function
name|char
modifier|*
name|part_type
parameter_list|(
name|int
name|type
parameter_list|)
block|{
name|int
name|num_types
init|=
operator|(
sizeof|sizeof
argument_list|(
name|part_types
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|part_type
argument_list|)
operator|)
decl_stmt|;
name|int
name|next_type
init|=
literal|0
decl_stmt|;
name|struct
name|part_type
modifier|*
name|ptr
init|=
name|part_types
decl_stmt|;
while|while
condition|(
name|next_type
operator|<
name|num_types
condition|)
block|{
if|if
condition|(
name|ptr
operator|->
name|type
operator|==
name|type
condition|)
return|return
operator|(
name|ptr
operator|->
name|name
operator|)
return|;
name|ptr
operator|++
expr_stmt|;
name|next_type
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|"Unknown"
operator|)
return|;
block|}
end_function

begin_function
name|int
name|read_mbr
parameter_list|(
name|char
modifier|*
name|device
parameter_list|,
name|struct
name|mbr
modifier|*
name|mbr
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_RDONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't open device %s to read master boot record\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't seek to track 0 of device %s to read master boot record\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|&
operator|(
name|mbr
operator|->
name|bootcode
operator|)
argument_list|,
name|MBRSIZE
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Failed to read master boot record from device %s\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|close
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't close device %s after reading master boot record\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|write_mbr
parameter_list|(
name|char
modifier|*
name|device
parameter_list|,
name|struct
name|mbr
modifier|*
name|mbr
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|device
argument_list|,
name|O_WRONLY
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't open device %s to write master boot record\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't seek to track 0 of device %s to write master boot record\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|enable_label
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't write enable MBR area of device %s\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|write
argument_list|(
name|fd
argument_list|,
name|mbr
operator|->
name|bootcode
argument_list|,
name|MBRSIZE
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Failed to write master boot record to device %s\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|disable_label
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't write disable MBR area of device %s\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|close
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't close device %s after reading master boot record\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|clear_mbr
parameter_list|(
name|struct
name|mbr
modifier|*
name|mbr
parameter_list|,
name|char
modifier|*
name|bootcode
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|fd
decl_stmt|;
comment|/*      * If installing to the whole disk      * then clobber any existing bootcode.      */
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"\nLoading MBR code from %s\n"
argument_list|,
name|bootcode
argument_list|)
expr_stmt|;
name|dialog_msgbox
argument_list|(
name|TITLE
argument_list|,
name|scratch
argument_list|,
literal|5
argument_list|,
literal|60
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|bootcode
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't open boot file %s\n"
argument_list|,
name|bootcode
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|mbr
operator|->
name|bootcode
argument_list|,
name|MBRSIZE
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't read from boot file %s\n"
argument_list|,
name|bootcode
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|close
argument_list|(
name|fd
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Couldn't close boot file %s\n"
argument_list|,
name|bootcode
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Create an empty partition table */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDOSPART
condition|;
name|i
operator|++
control|)
block|{
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_flag
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_shd
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ssect
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_scyl
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_typ
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ehd
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_esect
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ecyl
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_start
operator|=
literal|0
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_size
operator|=
literal|0
expr_stmt|;
block|}
name|mbr
operator|->
name|magic
operator|=
name|MBR_MAGIC
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dedicated_mbr
parameter_list|(
name|struct
name|mbr
modifier|*
name|mbr
parameter_list|,
name|char
modifier|*
name|bootcode
parameter_list|,
name|struct
name|disklabel
modifier|*
name|lbl
parameter_list|)
block|{
name|struct
name|dos_partition
modifier|*
name|dp
init|=
operator|&
name|mbr
operator|->
name|dospart
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|clear_mbr
argument_list|(
name|mbr
argument_list|,
name|bootcode
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|dp
operator|->
name|dp_scyl
operator|=
literal|0
expr_stmt|;
name|dp
operator|->
name|dp_shd
operator|=
literal|1
expr_stmt|;
name|dp
operator|->
name|dp_ssect
operator|=
literal|1
expr_stmt|;
name|dp
operator|->
name|dp_ecyl
operator|=
name|lbl
operator|->
name|d_ncylinders
operator|-
literal|1
expr_stmt|;
name|dp
operator|->
name|dp_ehd
operator|=
name|lbl
operator|->
name|d_ntracks
operator|-
literal|1
expr_stmt|;
name|dp
operator|->
name|dp_esect
operator|=
name|lbl
operator|->
name|d_nsectors
expr_stmt|;
name|dp
operator|->
name|dp_start
operator|=
operator|(
name|dp
operator|->
name|dp_scyl
operator|*
name|lbl
operator|->
name|d_ntracks
operator|*
name|lbl
operator|->
name|d_nsectors
operator|)
operator|+
operator|(
name|dp
operator|->
name|dp_shd
operator|*
name|lbl
operator|->
name|d_nsectors
operator|)
operator|+
name|dp
operator|->
name|dp_ssect
operator|-
literal|1
expr_stmt|;
name|dp
operator|->
name|dp_size
operator|=
operator|(
name|lbl
operator|->
name|d_nsectors
operator|*
name|lbl
operator|->
name|d_ntracks
operator|*
name|lbl
operator|->
name|d_ncylinders
operator|)
operator|-
name|dp
operator|->
name|dp_start
expr_stmt|;
name|dp
operator|->
name|dp_typ
operator|=
name|DOSPTYP_386BSD
expr_stmt|;
name|dp
operator|->
name|dp_flag
operator|=
name|ACTIVE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|get_geom_values
parameter_list|(
name|int
name|disk
parameter_list|)
block|{
name|WINDOW
modifier|*
name|window
decl_stmt|;
name|struct
name|disklabel
modifier|*
name|lbl
init|=
operator|&
name|disk_list
index|[
name|disk
index|]
operator|.
name|lbl
decl_stmt|;
name|int
name|key
init|=
literal|0
decl_stmt|;
name|int
name|cur_field
init|=
literal|0
decl_stmt|;
name|int
name|next
init|=
literal|0
decl_stmt|;
name|struct
name|field
name|field
index|[]
init|=
block|{
block|{
literal|2
block|,
literal|28
block|,
literal|06
block|,
literal|10
block|,
literal|01
block|,
literal|02
block|,
literal|01
block|,
operator|-
literal|1
block|,
literal|01
block|,
literal|"Unset"
block|}
block|,
block|{
literal|4
block|,
literal|28
block|,
literal|06
block|,
literal|10
block|,
literal|02
block|,
literal|00
block|,
literal|02
block|,
operator|-
literal|1
block|,
literal|02
block|,
literal|"Unset"
block|}
block|,
block|{
literal|6
block|,
literal|28
block|,
literal|06
block|,
literal|10
block|,
literal|00
block|,
literal|01
block|,
literal|00
block|,
operator|-
literal|1
block|,
literal|00
block|,
literal|"Unset"
block|}
block|,
block|{
literal|0
block|,
literal|07
block|,
literal|24
block|,
literal|24
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|"BIOS geometry parameters"
block|}
block|,
block|{
literal|2
block|,
literal|02
block|,
literal|20
block|,
literal|20
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|"Number of cylinders:"
block|}
block|,
block|{
literal|4
block|,
literal|02
block|,
literal|25
block|,
literal|25
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|"Number of tracks (heads):"
block|}
block|,
block|{
literal|6
block|,
literal|02
block|,
literal|18
block|,
literal|18
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
operator|-
literal|1
block|,
literal|"Number of sectors:"
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|window
operator|=
name|newwin
argument_list|(
literal|10
argument_list|,
literal|40
argument_list|,
literal|5
argument_list|,
literal|20
argument_list|)
operator|)
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Failed to open window for geometry editor"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
empty_stmt|;
name|keypad
argument_list|(
name|window
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|draw_box
argument_list|(
name|window
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|9
argument_list|,
literal|40
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
while|while
condition|(
name|key
operator|!=
name|ESC
condition|)
block|{
name|sprintf
argument_list|(
name|field
index|[
literal|0
index|]
operator|.
name|field
argument_list|,
literal|"%ld"
argument_list|,
name|lbl
operator|->
name|d_ncylinders
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|field
index|[
literal|1
index|]
operator|.
name|field
argument_list|,
literal|"%ld"
argument_list|,
name|lbl
operator|->
name|d_ntracks
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|field
index|[
literal|2
index|]
operator|.
name|field
argument_list|,
literal|"%ld"
argument_list|,
name|lbl
operator|->
name|d_nsectors
argument_list|)
expr_stmt|;
name|disp_fields
argument_list|(
name|window
argument_list|,
name|field
argument_list|,
sizeof|sizeof
argument_list|(
name|field
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|field
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|line_edit
argument_list|(
name|window
argument_list|,
name|field
index|[
name|cur_field
index|]
operator|.
name|y
argument_list|,
name|field
index|[
name|cur_field
index|]
operator|.
name|x
argument_list|,
name|field
index|[
name|cur_field
index|]
operator|.
name|width
argument_list|,
name|field
index|[
name|cur_field
index|]
operator|.
name|maxlen
argument_list|,
name|item_selected_attr
argument_list|,
literal|1
argument_list|,
name|field
index|[
name|cur_field
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|next
operator|=
name|change_field
argument_list|(
name|field
index|[
name|cur_field
index|]
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|==
operator|-
literal|1
condition|)
name|beep
argument_list|()
expr_stmt|;
else|else
name|cur_field
operator|=
name|next
expr_stmt|;
name|lbl
operator|->
name|d_ncylinders
operator|=
name|atoi
argument_list|(
name|field
index|[
literal|0
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|lbl
operator|->
name|d_ntracks
operator|=
name|atoi
argument_list|(
name|field
index|[
literal|1
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|lbl
operator|->
name|d_nsectors
operator|=
name|atoi
argument_list|(
name|field
index|[
literal|2
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
block|}
name|delwin
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|refresh
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|edit_mbr
parameter_list|(
name|int
name|disk
parameter_list|)
block|{
name|WINDOW
modifier|*
name|window
decl_stmt|;
name|int
name|cur_field
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|ok
decl_stmt|;
name|int
name|next
decl_stmt|;
name|int
name|key
init|=
literal|0
decl_stmt|;
name|struct
name|mbr
modifier|*
name|mbr
init|=
operator|&
name|disk_list
index|[
name|disk
index|]
operator|.
name|mbr
decl_stmt|;
comment|/* Confirm disk parameters */
ifdef|#
directive|ifdef
name|0
name|dialog_msgbox
argument_list|(
literal|"BIOS disk geometry values"
argument_list|,
literal|"In order to setup the boot area of the disk it is necessary to know the BIOS values for the disk geometry i.e. the number of cylinders, heads and sectors. These values may be different form the real geometry of the disk, depending on whether or not your system uses geometry translation. At this stage it is the entries from the BIOS that are needed. If you do not know these they can be found by rebooting the machine and entering th BIOS setup routine. See you BIOS manual for details"
argument_list|,
argument|-
literal|1
argument_list|,
argument|-
literal|1
argument_list|,
literal|1
argument_list|)
endif|#
directive|endif
if|if
condition|(
name|get_geom_values
argument_list|(
name|disk
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
comment|/* Read MBR from disk */
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"/dev/r%s%dd"
argument_list|,
name|disk_list
index|[
name|disk
index|]
operator|.
name|devconf
operator|->
name|dc_name
argument_list|,
name|disk_list
index|[
name|disk
index|]
operator|.
name|devconf
operator|->
name|dc_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|read_mbr
argument_list|(
name|scratch
argument_list|,
operator|&
name|disk_list
index|[
name|disk
index|]
operator|.
name|mbr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"The following error occured while trying\nto read the master boot record:\n\n%s\nIn order to install FreeBSD a new master boot record\nwill have to be written which will mean all current\ndata on the hard disk will be lost."
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
name|ok
condition|)
block|{
name|AskAbort
argument_list|(
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dialog_yesno
argument_list|(
name|TITLE
argument_list|,
literal|"Are you sure you wish to proceed ?"
argument_list|,
literal|10
argument_list|,
literal|75
argument_list|)
condition|)
block|{
name|dialog_clear
argument_list|()
expr_stmt|;
if|if
condition|(
name|dedicated_mbr
argument_list|(
name|mbr
argument_list|,
name|boot1
argument_list|,
operator|&
name|disk_list
index|[
name|disk
index|]
operator|.
name|lbl
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"\n\nCouldn't create new master boot record.\n\n%s"
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|ok
operator|=
literal|1
expr_stmt|;
block|}
name|dialog_clear
argument_list|()
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"Do you wish to dedicate the whole disk to FreeBSD?\n\nDoing so will overwrite any existing data on the disk."
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|dialog_yesno
argument_list|(
name|TITLE
argument_list|,
name|scratch
argument_list|,
literal|10
argument_list|,
literal|75
argument_list|)
condition|)
if|if
condition|(
name|dedicated_mbr
argument_list|(
name|mbr
argument_list|,
name|boot1
argument_list|,
operator|&
name|disk_list
index|[
name|disk
index|]
operator|.
name|lbl
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"\n\nCouldn't dedicate disk to FreeBSD.\n\n %s"
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* Fill in fields with mbr data */
if|if
condition|(
operator|!
operator|(
name|window
operator|=
name|newwin
argument_list|(
literal|24
argument_list|,
literal|79
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
name|sprintf
argument_list|(
name|errmsg
argument_list|,
literal|"Failed to open window for MBR editor\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
empty_stmt|;
name|keypad
argument_list|(
name|window
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
name|draw_box
argument_list|(
name|window
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|24
argument_list|,
literal|79
argument_list|,
name|dialog_attr
argument_list|,
name|border_attr
argument_list|)
expr_stmt|;
name|cur_field
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|key
operator|!=
name|ESC
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDOSPART
condition|;
name|i
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|1
index|]
operator|.
name|field
argument_list|,
literal|"%s"
argument_list|,
name|part_type
argument_list|(
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_typ
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|2
index|]
operator|.
name|field
argument_list|,
literal|"%ld"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_start
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|3
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_scyl
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|4
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_shd
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|5
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ssect
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|6
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|7
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ecyl
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|8
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ehd
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|9
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_esect
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|10
index|]
operator|.
name|field
argument_list|,
literal|"%ld"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_size
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|11
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|sectstoMb
argument_list|(
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_size
argument_list|,
literal|512
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|12
index|]
operator|.
name|field
argument_list|,
literal|"%d"
argument_list|,
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_flag
argument_list|)
expr_stmt|;
block|}
name|disp_fields
argument_list|(
name|window
argument_list|,
name|mbr_field
argument_list|,
sizeof|sizeof
argument_list|(
name|mbr_field
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|field
argument_list|)
argument_list|)
expr_stmt|;
name|key
operator|=
name|line_edit
argument_list|(
name|window
argument_list|,
name|mbr_field
index|[
name|cur_field
index|]
operator|.
name|y
argument_list|,
name|mbr_field
index|[
name|cur_field
index|]
operator|.
name|x
argument_list|,
name|mbr_field
index|[
name|cur_field
index|]
operator|.
name|width
argument_list|,
name|mbr_field
index|[
name|cur_field
index|]
operator|.
name|maxlen
argument_list|,
name|item_selected_attr
argument_list|,
literal|1
argument_list|,
name|mbr_field
index|[
name|cur_field
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
comment|/* Propagate changes to MBR */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NDOSPART
condition|;
name|i
operator|++
control|)
block|{
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_start
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|2
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_scyl
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|3
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_shd
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|4
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ssect
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|5
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ecyl
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|7
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_ehd
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|8
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_esect
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|9
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
name|mbr
operator|->
name|dospart
index|[
name|i
index|]
operator|.
name|dp_size
operator|=
name|atoi
argument_list|(
name|mbr_field
index|[
operator|(
name|i
operator|*
literal|12
operator|)
operator|+
literal|10
index|]
operator|.
name|field
argument_list|)
expr_stmt|;
block|}
name|next
operator|=
name|change_field
argument_list|(
name|mbr_field
index|[
name|cur_field
index|]
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|next
operator|==
operator|-
literal|1
condition|)
name|beep
argument_list|()
expr_stmt|;
else|else
name|cur_field
operator|=
name|next
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"Writing a new master boot record can erase the current disk contents.\n\n Are you sure you want to write the new MBR?"
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|dialog_yesno
argument_list|(
literal|"Write new MBR?"
argument_list|,
name|scratch
argument_list|,
literal|10
argument_list|,
literal|75
argument_list|)
condition|)
block|{
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"/dev/r%s%dd"
argument_list|,
name|disk_list
index|[
name|disk
index|]
operator|.
name|devconf
operator|->
name|dc_name
argument_list|,
name|disk_list
index|[
name|disk
index|]
operator|.
name|devconf
operator|->
name|dc_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_mbr
argument_list|(
name|scratch
argument_list|,
name|mbr
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|scratch
argument_list|,
literal|"The following error occured while trying to write the new MBR\n\n%s"
argument_list|,
name|errmsg
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
name|delwin
argument_list|(
name|window
argument_list|)
expr_stmt|;
name|dialog_clear
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*      list.c: vinum interface program, list routines  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1997, 1998  *	Nan Yang Computer Services Limited.  All rights reserved.  *  *  Parts copyright (c) 1997, 1998 Cybernet Corporation, NetMAX project.  *  *  Written by Greg Lehey  *  *  This software is distributed under the so-called ``Berkeley  *  License'':  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Nan Yang Computer  *      Services Limited.  * 4. Neither the name of the Company nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * This software is provided ``as is'', and any express or implied  * warranties, including, but not limited to, the implied warranties of  * merchantability and fitness for a particular purpose are disclaimed.  * In no event shall the company or contributors be liable for any  * direct, indirect, incidental, special, exemplary, or consequential  * damages (including, but not limited to, procurement of substitute  * goods or services; loss of use, data, or profits; or business  * interruption) however caused and on any theory of liability, whether  * in contract, strict liability, or tort (including negligence or  * otherwise) arising in any way out of the use of this software, even if  * advised of the possibility of such damage.  *  * $Id: list.c,v 1.25 2000/12/20 03:38:43 grog Exp grog $  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/utsname.h>
end_include

begin_include
include|#
directive|include
file|<dev/vinum/vinumhdr.h>
end_include

begin_include
include|#
directive|include
file|"vext.h"
end_include

begin_include
include|#
directive|include
file|<dev/vinum/request.h>
end_include

begin_include
include|#
directive|include
file|<devstat.h>
end_include

begin_comment
comment|/*  * When a subdisk is reviving or initializing, we  * check to see whether it is still progressing  * and print a warning if not.  We check every 50  * ms, up to a maximum of 5 seconds.  This is the  * counter value.  */
end_comment

begin_define
define|#
directive|define
name|STALLCOUNT
value|100
end_define

begin_comment
comment|/*  * Take a size in sectors and return a pointer to  * a string which represents the size best.  If lj  * is != 0, return left justified, otherwise in a  * fixed 10 character field suitable for columnar  * printing.  *  * Note this uses a static string: it's only  * intended to be used immediately for printing.  */
end_comment

begin_function
name|char
modifier|*
name|roughlength
parameter_list|(
name|int64_t
name|bytes
parameter_list|,
name|int
name|lj
parameter_list|)
block|{
specifier|static
name|char
name|description
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|bytes
operator|>
operator|(
name|int64_t
operator|)
name|MEGABYTE
operator|*
literal|10000
condition|)
comment|/* gigabytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%lld GB"
else|:
literal|"%10d GB"
argument_list|,
name|bytes
operator|/
name|GIGABYTE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bytes
operator|>
name|KILOBYTE
operator|*
literal|10000
condition|)
comment|/* megabytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%lld MB"
else|:
literal|"%10d MB"
argument_list|,
name|bytes
operator|/
name|MEGABYTE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bytes
operator|>
literal|10000
condition|)
comment|/* kilobytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%lld kB"
else|:
literal|"%10d kB"
argument_list|,
name|bytes
operator|/
name|KILOBYTE
argument_list|)
expr_stmt|;
else|else
comment|/* bytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%lld  B"
else|:
literal|"%10d  B"
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
return|return
name|description
return|;
block|}
end_function

begin_function
name|void
name|vinum_list
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|object
decl_stmt|;
name|int
name|i
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|sflag
operator|&
operator|(
operator|!
name|vflag
operator|)
condition|)
comment|/* just summary stats, */
name|printf
argument_list|(
literal|"Object\t\t  Reads\t\tBytes\tAverage\tRecover\t Writes"
literal|"\t\tBytes\tAverage\t  Mblock  Mstripe\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
name|listconfig
argument_list|()
expr_stmt|;
comment|/* list everything */
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|object
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
comment|/* look for it */
if|if
condition|(
name|vinum_li
argument_list|(
name|object
argument_list|,
name|type
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't find object: %s\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* List an object */
end_comment

begin_function
name|int
name|vinum_li
parameter_list|(
name|int
name|object
parameter_list|,
name|enum
name|objecttype
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|drive_object
case|:
name|vinum_ldi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
case|case
name|sd_object
case|:
name|vinum_lsi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
case|case
name|plex_object
case|:
name|vinum_lpi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
case|case
name|volume_object
case|:
name|vinum_lvi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|vinum_ldi
parameter_list|(
name|int
name|driveno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|time_t
name|t
decl_stmt|;
comment|/* because Bruce says so */
name|int
name|sdno
decl_stmt|;
comment|/* for recursion */
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|driveno
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|state
operator|!=
name|drive_unallocated
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"Drive %s:\tDevice %s\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|)
expr_stmt|;
name|t
operator|=
name|drive
operator|.
name|label
operator|.
name|date_of_birth
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tCreated on %s at %s"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|sysname
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|drive
operator|.
name|label
operator|.
name|last_update
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tConfig last updated %s"
argument_list|,
comment|/* care: \n at end */
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tSize: %16lld bytes (%lld MB)\n\t\tUsed: %16lld bytes (%lld MB)\n"
literal|"\t\tAvailable: %11qd bytes (%d MB)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|label
operator|.
name|drive_size
argument_list|,
comment|/* bytes used */
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|/
name|MEGABYTE
argument_list|)
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|-
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
argument_list|)
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|-
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
argument_list|)
operator|/
name|MEGABYTE
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
argument_list|,
call|(
name|int
call|)
argument_list|(
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tState: %s\n"
argument_list|,
name|drive_state
argument_list|(
name|drive
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|lasterror
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tLast error: %s\n"
argument_list|,
name|strerror
argument_list|(
name|drive
operator|.
name|lasterror
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\tLast error: none\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tActive requests:\t%d\n\t\tMaximum active:\t\t%d\n"
argument_list|,
name|drive
operator|.
name|active
argument_list|,
name|drive
operator|.
name|maxactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|Verbose
condition|)
block|{
comment|/* print the free list */
name|int
name|fe
decl_stmt|;
comment|/* freelist entry */
name|struct
name|drive_freelist
name|freelist
decl_stmt|;
struct|struct
name|ferq
block|{
comment|/* request to pass to ioctl */
name|int
name|driveno
decl_stmt|;
name|int
name|fe
decl_stmt|;
block|}
modifier|*
name|ferq
init|=
operator|(
expr|struct
name|ferq
operator|*
operator|)
operator|&
name|freelist
struct|;
name|printf
argument_list|(
literal|"\t\tFree list contains %d entries:\n\t\t   Offset\t     Size\n"
argument_list|,
name|drive
operator|.
name|freelist_entries
argument_list|)
expr_stmt|;
for|for
control|(
name|fe
operator|=
literal|0
init|;
name|fe
operator|<
name|drive
operator|.
name|freelist_entries
condition|;
name|fe
operator|++
control|)
block|{
name|ferq
operator|->
name|driveno
operator|=
name|drive
operator|.
name|driveno
expr_stmt|;
name|ferq
operator|->
name|fe
operator|=
name|fe
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETFREELIST
argument_list|,
operator|&
name|freelist
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get free list element %d: %s\n"
argument_list|,
name|fe
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|command_fail
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\t\t%9lld\t%9lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|freelist
operator|.
name|offset
argument_list|,
operator|(
name|long
name|long
operator|)
name|freelist
operator|.
name|sectors
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
block|{
name|printf
argument_list|(
literal|"D %-21s State: %s\tDevice %s\tAvail: %lld/%lld MB"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive_state
argument_list|(
name|drive
operator|.
name|state
argument_list|)
argument_list|,
name|drive
operator|.
name|devicename
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|/
name|MEGABYTE
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|" (%d%%)"
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|drive
operator|.
name|sectors_available
operator|*
literal|100
operator|*
name|DEV_BSIZE
operator|)
operator|/
operator|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|-
operator|(
name|DATASTART
operator|*
name|DEV_BSIZE
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|vflag
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16lld\n\t\tBytes read:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|drive
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16lld bytes\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|bytes_read
operator|/
name|drive
operator|.
name|reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16lld\n\t\tBytes written:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|drive
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|bytes_written
operator|/
name|drive
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* non-verbose stats */
name|printf
argument_list|(
literal|"%-15s\t%7lld\t%15lld\t"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\t\t"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|bytes_read
operator|/
name|drive
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t%15lld\t"
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|drive
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|drive
operator|.
name|bytes_written
operator|/
name|drive
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|sdno
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
operator|)
operator|&&
operator|(
name|sd
operator|.
name|driveno
operator|==
name|drive
operator|.
name|driveno
operator|)
condition|)
name|vinum_lsi
argument_list|(
name|sd
operator|.
name|sdno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|vinum_ld
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|driveno
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|driveno
operator|=
literal|0
init|;
name|driveno
operator|<
name|vinum_conf
operator|.
name|drives_allocated
condition|;
name|driveno
operator|++
control|)
name|vinum_ldi
argument_list|(
name|driveno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|driveno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|drive_object
condition|)
name|vinum_ldi
argument_list|(
name|driveno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a drive\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lvi
parameter_list|(
name|int
name|volno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|volno
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|state
operator|!=
name|volume_unallocated
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"Volume %s:\tSize: %lld bytes (%lld MB)\n"
literal|"\t\tState: %s\n\t\tFlags: %s%s%s\n"
argument_list|,
name|vol
operator|.
name|name
argument_list|,
operator|(
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|size
operator|)
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|size
operator|)
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|,
name|volume_state
argument_list|(
name|vol
operator|.
name|state
argument_list|)
argument_list|,
name|vol
operator|.
name|flags
operator|&
name|VF_OPEN
condition|?
literal|"open "
else|:
literal|""
argument_list|,
operator|(
name|vol
operator|.
name|flags
operator|&
name|VF_WRITETHROUGH
condition|?
literal|"writethrough "
else|:
literal|""
operator|)
argument_list|,
operator|(
name|vol
operator|.
name|flags
operator|&
name|VF_RAW
condition|?
literal|"raw"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t%d plexes\n\t\tRead policy: "
argument_list|,
name|vol
operator|.
name|plexes
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|preferred_plex
operator|<
literal|0
condition|)
comment|/* round robin */
name|printf
argument_list|(
literal|"round robin\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|vol
operator|.
name|plex
index|[
name|vol
operator|.
name|preferred_plex
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"plex %d (%s)\n"
argument_list|,
name|vol
operator|.
name|preferred_plex
argument_list|,
name|plex
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
comment|/* brief */
name|printf
argument_list|(
literal|"V %-21s State: %s\tPlexes: %7d\tSize: %s\n"
argument_list|,
name|vol
operator|.
name|name
argument_list|,
name|volume_state
argument_list|(
name|vol
operator|.
name|state
argument_list|)
argument_list|,
name|vol
operator|.
name|plexes
argument_list|,
name|roughlength
argument_list|(
name|vol
operator|.
name|size
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|vflag
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16lld\n\t\tRecovered:\t%16lld\n\t\tBytes read:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|recovered_reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|vol
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|vol
operator|.
name|bytes_read
operator|/
name|vol
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16lld\n\t\tBytes written:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|vol
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|vol
operator|.
name|bytes_written
operator|/
name|vol
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tActive requests:\t%8d\n"
argument_list|,
name|vol
operator|.
name|active
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* brief stats listing */
name|printf
argument_list|(
literal|"%-15s\t%7lld\t%15lld\t"
argument_list|,
name|vol
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\t"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|vol
operator|.
name|bytes_read
operator|/
name|vol
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t"
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|recovered_reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t%15lld\t"
argument_list|,
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|writes
argument_list|,
name|vol
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|vol
operator|.
name|bytes_written
operator|/
name|vol
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vol
operator|.
name|plexes
operator|>
literal|0
condition|)
block|{
name|int
name|plexno
decl_stmt|;
if|if
condition|(
name|Verbose
condition|)
block|{
comment|/* brief list */
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vol
operator|.
name|plexes
condition|;
name|plexno
operator|++
control|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|)
expr_stmt|;
comment|/* Just a brief summary here */
name|printf
argument_list|(
literal|"\t\tPlex %2d:\t%s\t(%s), %s\n"
argument_list|,
name|plexno
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|plex_org
argument_list|(
name|plex
operator|.
name|organization
argument_list|)
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|length
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
block|{
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vol
operator|.
name|plexes
condition|;
name|plexno
operator|++
control|)
name|vinum_lpi
argument_list|(
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* first show the plexes */
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vol
operator|.
name|plexes
condition|;
name|plexno
operator|++
control|)
block|{
comment|/* then the subdisks */
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|subdisks
operator|>
literal|0
condition|)
block|{
name|int
name|sdno
decl_stmt|;
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|plex
operator|.
name|subdisks
condition|;
name|sdno
operator|++
control|)
block|{
name|get_plex_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
name|vinum_lsi
argument_list|(
name|sd
operator|.
name|sdno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lv
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|volno
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
for|for
control|(
name|volno
operator|=
literal|0
init|;
name|volno
operator|<
name|vinum_conf
operator|.
name|volumes_allocated
condition|;
name|volno
operator|++
control|)
name|vinum_lvi
argument_list|(
name|volno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|volno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|volume_object
condition|)
name|vinum_lvi
argument_list|(
name|volno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a volume\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lpi
parameter_list|(
name|int
name|plexno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|plexno
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|state
operator|!=
name|plex_unallocated
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"Plex %s:\tSize:\t%9lld bytes (%lld MB)\n\t\tSubdisks: %8d\n"
argument_list|,
name|plex
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|length
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|length
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|,
name|plex
operator|.
name|subdisks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tState: %s\n\t\tOrganization: %s"
argument_list|,
name|plex_state
argument_list|(
name|plex
operator|.
name|state
argument_list|)
argument_list|,
name|plex_org
argument_list|(
name|plex
operator|.
name|organization
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isstriped
argument_list|(
operator|(
operator|&
name|plex
operator|)
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\tStripe size: %s\n"
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|stripesize
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|isparity
argument_list|(
operator|(
operator|&
name|plex
operator|)
argument_list|)
operator|)
operator|&&
operator|(
name|plex
operator|.
name|checkblock
operator|!=
literal|0
operator|)
condition|)
name|printf
argument_list|(
literal|"\t\tCheck block pointer:\t\t%s (%d%%)\n"
argument_list|,
name|roughlength
argument_list|(
operator|(
name|plex
operator|.
name|checkblock
operator|<<
name|DEV_BSHIFT
operator|)
operator|*
operator|(
name|plex
operator|.
name|subdisks
operator|-
literal|1
operator|)
argument_list|,
literal|0
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|plex
operator|.
name|checkblock
operator|*
literal|100
argument_list|)
operator|)
operator|*
operator|(
name|plex
operator|.
name|subdisks
operator|-
literal|1
operator|)
operator|/
name|plex
operator|.
name|length
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|volno
operator|>=
literal|0
condition|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|plex
operator|.
name|volno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tPart of volume %s\n"
argument_list|,
name|vol
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
block|{
comment|/* non-verbose list */
name|char
modifier|*
name|org
init|=
literal|""
decl_stmt|;
comment|/* organization */
switch|switch
condition|(
name|plex
operator|.
name|organization
condition|)
block|{
case|case
name|plex_disorg
case|:
comment|/* disorganized */
name|org
operator|=
literal|"??"
expr_stmt|;
break|break;
case|case
name|plex_concat
case|:
comment|/* concatenated plex */
name|org
operator|=
literal|"C"
expr_stmt|;
break|break;
case|case
name|plex_striped
case|:
comment|/* striped plex */
name|org
operator|=
literal|"S"
expr_stmt|;
break|break;
case|case
name|plex_raid4
case|:
comment|/* RAID4 plex */
name|org
operator|=
literal|"R4"
expr_stmt|;
break|break;
case|case
name|plex_raid5
case|:
comment|/* RAID5 plex */
name|org
operator|=
literal|"R5"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"P %-18s %2s State: %s\tSubdisks: %5d\tSize: %s"
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|org
argument_list|,
name|plex_state
argument_list|(
name|plex
operator|.
name|state
argument_list|)
argument_list|,
name|plex
operator|.
name|subdisks
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|length
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|vflag
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16lld\n\t\tBytes read:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|plex
operator|.
name|bytes_read
operator|/
name|plex
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16lld\n\t\tBytes written:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|plex
operator|.
name|bytes_written
operator|/
name|plex
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|plex
operator|.
name|reads
operator|+
name|plex
operator|.
name|writes
operator|)
operator|>
literal|0
operator|)
operator|&&
name|isstriped
argument_list|(
operator|(
operator|&
name|plex
operator|)
argument_list|)
condition|)
name|printf
argument_list|(
literal|"\t\tMultiblock:\t%16lld (%d%%)\n"
literal|"\t\tMultistripe:\t%16lld (%d%%)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|multiblock
argument_list|,
call|(
name|int
call|)
argument_list|(
name|plex
operator|.
name|multiblock
operator|*
literal|100
operator|/
operator|(
name|plex
operator|.
name|reads
operator|+
name|plex
operator|.
name|writes
operator|)
argument_list|)
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|multistripe
argument_list|,
call|(
name|int
call|)
argument_list|(
name|plex
operator|.
name|multistripe
operator|*
literal|100
operator|/
operator|(
name|plex
operator|.
name|reads
operator|+
name|plex
operator|.
name|writes
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|recovered_reads
condition|)
name|printf
argument_list|(
literal|"\t\tRecovered reads:%16lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|recovered_reads
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|degraded_writes
condition|)
name|printf
argument_list|(
literal|"\t\tDegraded writes:%16lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|degraded_writes
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|parityless_writes
condition|)
name|printf
argument_list|(
literal|"\t\tParityless writes:%14lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|parityless_writes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%-15s\t%7lld\t%15lld\t"
argument_list|,
name|plex
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\t"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|plex
operator|.
name|bytes_read
operator|/
name|plex
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|recovered_reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t%15lld\t"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\t"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|plex
operator|.
name|bytes_written
operator|/
name|plex
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t%7lld\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|multiblock
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|multistripe
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|plex
operator|.
name|subdisks
operator|>
literal|0
condition|)
block|{
name|int
name|sdno
decl_stmt|;
if|if
condition|(
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|plex
operator|.
name|subdisks
condition|;
name|sdno
operator|++
control|)
block|{
name|get_plex_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|plexno
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tSubdisk %d:\t%s\n\t\t  state: %s\tsize %11lld (%lld MB)\n"
argument_list|,
name|sdno
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|sd_state
argument_list|(
name|sd
operator|.
name|state
argument_list|)
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|organization
operator|==
name|plex_concat
condition|)
name|printf
argument_list|(
literal|"\t\t\toffset %9ld (0x%lx)\n"
argument_list|,
operator|(
name|long
operator|)
name|sd
operator|.
name|plexoffset
argument_list|,
operator|(
name|long
operator|)
name|sd
operator|.
name|plexoffset
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|plex
operator|.
name|subdisks
condition|;
name|sdno
operator|++
control|)
block|{
name|get_plex_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|plexno
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
name|vinum_lsi
argument_list|(
name|sd
operator|.
name|sdno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|vinum_lp
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|plexno
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vinum_conf
operator|.
name|plexes_allocated
condition|;
name|plexno
operator|++
control|)
name|vinum_lpi
argument_list|(
name|plexno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|plexno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|plex_object
condition|)
name|vinum_lpi
argument_list|(
name|plexno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a plex\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lsi
parameter_list|(
name|int
name|sdno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|long
name|long
name|revived
decl_stmt|;
comment|/* keep an eye on revive progress */
name|int
name|times
decl_stmt|;
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
condition|)
block|{
if|if
condition|(
name|vflag
condition|)
block|{
name|printf
argument_list|(
literal|"Subdisk %s:\n\t\tSize: %16lld bytes (%lld MB)\n\t\tState: %s\n"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|/
operator|(
name|MEGABYTE
operator|/
name|DEV_BSIZE
operator|)
argument_list|,
name|sd_state
argument_list|(
name|sd
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|flags
operator|&
name|VF_RETRYERRORS
condition|)
name|printf
argument_list|(
literal|"\t\tretryerrors\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|plexno
operator|>=
literal|0
condition|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|sd
operator|.
name|plexno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tPlex %s"
argument_list|,
name|plex
operator|.
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" at offset %lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|plexoffset
operator|*
name|DEV_BSIZE
argument_list|,
name|roughlength
argument_list|(
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|plexoffset
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sd
operator|.
name|state
operator|==
name|sd_reviving
condition|)
block|{
if|if
condition|(
name|sd
operator|.
name|reviver
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\t*** Start subdisk with 'start' command ***\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|printf
argument_list|(
literal|"\t\tReviver PID:\t%d\n"
argument_list|,
name|sd
operator|.
name|reviver
argument_list|)
expr_stmt|;
if|if
condition|(
name|kill
argument_list|(
name|sd
operator|.
name|reviver
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ESRCH
condition|)
comment|/* no process */
name|printf
argument_list|(
literal|"\t\t*** Revive process has died ***\n"
argument_list|)
expr_stmt|;
comment|/* Don't report a problem that "can't happen" */
block|}
else|else
block|{
name|revived
operator|=
name|sd
operator|.
name|revived
expr_stmt|;
comment|/* note how far we were */
comment|/* 			 * Wait for up to a second until we 			 * see some progress with the revive. 			 * Do it like this so we don't have 			 * annoying delays in the listing. 			 */
for|for
control|(
name|times
operator|=
literal|0
init|;
name|times
operator|<
name|STALLCOUNT
condition|;
name|times
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|revived
operator|!=
name|revived
condition|)
comment|/* progress? */
break|break;
name|usleep
argument_list|(
literal|50000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|times
operator|==
name|STALLCOUNT
condition|)
name|printf
argument_list|(
literal|"\t\t*** Revive has stalled ***\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"\t\tRevive pointer:\t\t%s (%d%%)\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|revived
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|sd
operator|.
name|revived
operator|*
literal|100
argument_list|)
operator|)
operator|/
name|sd
operator|.
name|sectors
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tRevive blocksize:\t%s\n"
literal|"\t\tRevive interval:\t%10d seconds\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|revive_blocksize
argument_list|,
literal|0
argument_list|)
argument_list|,
name|sd
operator|.
name|revive_interval
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sd
operator|.
name|state
operator|==
name|sd_initializing
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tInitialize pointer:\t%s (%d%%)\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|initialized
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|sd
operator|.
name|initialized
operator|*
literal|100
argument_list|)
operator|)
operator|/
name|sd
operator|.
name|sectors
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tInitialize blocksize:\t%s\n"
literal|"\t\tInitialize interval:\t%10d seconds\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|init_blocksize
argument_list|,
literal|0
argument_list|)
argument_list|,
name|sd
operator|.
name|init_interval
argument_list|)
expr_stmt|;
block|}
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|sd
operator|.
name|driveno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|driveoffset
operator|<
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tDrive %s (%s), no offset\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|drive
operator|.
name|devicename
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
comment|/* has a name */
name|printf
argument_list|(
literal|"\t\tDrive %s (%s) at offset %lld (%s)\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|sd
operator|.
name|driveoffset
operator|*
name|DEV_BSIZE
argument_list|)
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|driveoffset
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\tDrive %s (*missing*) at offset %lld (%s)\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|sd
operator|.
name|driveoffset
operator|*
name|DEV_BSIZE
argument_list|)
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|driveoffset
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
block|{
comment|/* brief listing, no stats */
if|if
condition|(
name|sd
operator|.
name|state
operator|==
name|sd_reviving
condition|)
name|printf
argument_list|(
literal|"S %-21s State: R %d%%\t"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|sd
operator|.
name|revived
operator|*
literal|100
argument_list|)
operator|)
operator|/
name|sd
operator|.
name|sectors
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sd
operator|.
name|state
operator|==
name|sd_initializing
condition|)
name|printf
argument_list|(
literal|"S %-21s State: I %d%%\t"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|sd
operator|.
name|initialized
operator|*
literal|100
argument_list|)
operator|)
operator|/
name|sd
operator|.
name|sectors
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"S %-21s State: %s\t"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|sd_state
argument_list|(
name|sd
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|plexno
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"(detached)\t"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"PO: %s "
argument_list|,
operator|&
operator|(
name|roughlength
argument_list|(
name|sd
operator|.
name|plexoffset
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
operator|)
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* what a kludge! */
name|printf
argument_list|(
literal|"Size: %s\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|sectors
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|state
operator|==
name|sd_reviving
condition|)
block|{
if|if
condition|(
name|sd
operator|.
name|reviver
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\t\t*** Start %s with 'start' command ***\n"
argument_list|,
name|sd
operator|.
name|name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|kill
argument_list|(
name|sd
operator|.
name|reviver
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ESRCH
condition|)
comment|/* no process */
name|printf
argument_list|(
literal|"\t\t\t*** Revive process for %s has died ***\n"
argument_list|,
name|sd
operator|.
name|name
argument_list|)
expr_stmt|;
comment|/* Don't report a problem that "can't happen" */
block|}
else|else
block|{
name|revived
operator|=
name|sd
operator|.
name|revived
expr_stmt|;
comment|/* note how far we were */
comment|/* 		     * Wait for up to a second until we 		     * see some progress with the revive. 		     * Do it like this so we don't have 		     * annoying delays in the listing. 		     */
for|for
control|(
name|times
operator|=
literal|0
init|;
name|times
operator|<
name|STALLCOUNT
condition|;
name|times
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|revived
operator|!=
name|revived
condition|)
comment|/* progress? */
break|break;
name|usleep
argument_list|(
literal|50000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|times
operator|==
name|STALLCOUNT
condition|)
name|printf
argument_list|(
literal|"\t\t\t*** Revive of %s has stalled ***\n"
argument_list|,
name|sd
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|vflag
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16lld\n\t\tBytes read:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|sd
operator|.
name|bytes_read
operator|/
name|sd
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16lld\n\t\tBytes written:\t%16lld (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16lld bytes\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|sd
operator|.
name|bytes_written
operator|/
name|sd
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%-15s\t%7lld\t%15lld\t"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|reads
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\t\t"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|sd
operator|.
name|bytes_read
operator|/
name|sd
operator|.
name|reads
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7lld\t%15lld\t"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|writes
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7lld\n"
argument_list|,
call|(
name|long
name|long
call|)
argument_list|(
name|sd
operator|.
name|bytes_written
operator|/
name|sd
operator|.
name|writes
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
name|vinum_ldi
argument_list|(
name|sd
operator|.
name|driveno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* make it more readable */
block|}
block|}
end_function

begin_function
name|void
name|vinum_ls
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|sdno
decl_stmt|;
comment|/* Structures to read kernel data into */
name|struct
name|_vinum_conf
name|vinum_conf
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|sdno
operator|++
control|)
name|vinum_lsi
argument_list|(
name|sdno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* specific subdisks */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|sdno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|sd_object
condition|)
name|vinum_lsi
argument_list|(
name|sdno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a subdisk\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* List the complete configuration.   * XXX Change this to specific lists */
end_comment

begin_function
name|void
name|listconfig
parameter_list|()
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"%d drives:\n"
argument_list|,
name|vinum_conf
operator|.
name|drives_used
argument_list|)
expr_stmt|;
if|if
condition|(
name|vinum_conf
operator|.
name|drives_used
operator|>
literal|0
condition|)
block|{
name|vinum_ld
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d volumes:\n"
argument_list|,
name|vinum_conf
operator|.
name|volumes_used
argument_list|)
expr_stmt|;
if|if
condition|(
name|vinum_conf
operator|.
name|volumes_used
operator|>
literal|0
condition|)
block|{
name|vinum_lv
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d plexes:\n"
argument_list|,
name|vinum_conf
operator|.
name|plexes_used
argument_list|)
expr_stmt|;
if|if
condition|(
name|vinum_conf
operator|.
name|plexes_used
operator|>
literal|0
condition|)
block|{
name|vinum_lp
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%d subdisks:\n"
argument_list|,
name|vinum_conf
operator|.
name|subdisks_used
argument_list|)
expr_stmt|;
if|if
condition|(
name|vinum_conf
operator|.
name|subdisks_used
operator|>
literal|0
condition|)
name|vinum_ls
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert a timeval to Tue Oct 13 13:54:14.0434324  * Return pointer to text */
end_comment

begin_function
name|char
modifier|*
name|timetext
parameter_list|(
name|struct
name|timeval
modifier|*
name|time
parameter_list|)
block|{
specifier|static
name|char
name|text
index|[
literal|30
index|]
decl_stmt|;
name|time_t
name|t
decl_stmt|;
comment|/* to keep Bruce happy */
name|t
operator|=
name|time
operator|->
name|tv_sec
expr_stmt|;
name|strcpy
argument_list|(
name|text
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* to the second */
name|sprintf
argument_list|(
operator|&
name|text
index|[
literal|19
index|]
argument_list|,
literal|".%06ld"
argument_list|,
name|time
operator|->
name|tv_usec
argument_list|)
expr_stmt|;
comment|/* and the microseconds */
return|return
operator|&
name|text
index|[
literal|11
index|]
return|;
block|}
end_function

begin_function
name|void
name|vinum_info
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|struct
name|meminfo
name|meminfo
decl_stmt|;
name|struct
name|mc
name|malloced
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
name|VINUMDEBUG
name|struct
name|rqinfo
name|rq
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"Flags: 0x%x\n"
argument_list|,
name|vinum_conf
operator|.
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_MEMINFO
argument_list|,
operator|&
name|meminfo
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get information"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"Total of %d blocks malloced, total memory: %d\nMaximum allocs: %8d, malloc table at 0x%08x\n"
argument_list|,
name|meminfo
operator|.
name|mallocs
argument_list|,
name|meminfo
operator|.
name|total_malloced
argument_list|,
name|meminfo
operator|.
name|highwater
argument_list|,
operator|(
name|int
operator|)
name|meminfo
operator|.
name|malloced
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d requests active, maximum %d active\n"
argument_list|,
name|vinum_conf
operator|.
name|active
argument_list|,
name|vinum_conf
operator|.
name|maxactive
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|&&
operator|(
operator|!
name|Verbose
operator|)
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meminfo
operator|.
name|mallocs
condition|;
name|i
operator|++
control|)
block|{
name|malloced
operator|.
name|seq
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_MALLOCINFO
argument_list|,
operator|&
name|malloced
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get information"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|i
operator|&
literal|63
operator|)
condition|)
name|printf
argument_list|(
literal|"Block\tSequence\t  size\t  address\t  line\t\tfile\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6d\t%6d\t\t%6d\t0x%08x\t%6d\t\t%s\n"
argument_list|,
name|i
argument_list|,
name|malloced
operator|.
name|seq
argument_list|,
name|malloced
operator|.
name|size
argument_list|,
operator|(
name|int
operator|)
name|malloced
operator|.
name|address
argument_list|,
name|malloced
operator|.
name|line
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|malloced
operator|.
name|file
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|VINUMDEBUG
if|if
condition|(
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\nTime\t\t Event\t     Buf\tDev\t  Offset\tBytes\tSD\tSDoff\tDoffset\tGoffset\n\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|RQINFO_SIZE
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
comment|/* go through the request list in order */
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|rq
operator|)
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_RQINFO
argument_list|,
operator|&
name|rq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get information"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Compress devminor into something printable. */
name|rq
operator|.
name|devminor
operator|=
operator|(
name|rq
operator|.
name|devminor
operator|&
literal|0xff
operator|)
operator||
operator|(
operator|(
name|rq
operator|.
name|devminor
operator|&
literal|0xfff0000
operator|)
operator|>>
literal|8
operator|)
expr_stmt|;
switch|switch
condition|(
name|rq
operator|.
name|type
condition|)
block|{
case|case
name|loginfo_unused
case|:
comment|/* never been used */
break|break;
case|case
name|loginfo_user_bp
case|:
comment|/* this is the bp when strategy is called */
name|printf
argument_list|(
literal|"%s %dVS %s %p\t%d.%-6d 0x%-9x\t%ld\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|type
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_bcount
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_sdiol
case|:
comment|/* subdisk I/O launch */
case|case
name|loginfo_user_bpl
case|:
comment|/* and this is the bp at launch time */
name|printf
argument_list|(
literal|"%s %dLR %s %p\t%d.%-6d 0x%-9x\t%ld\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|type
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_bcount
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_rqe
case|:
comment|/* user RQE */
name|printf
argument_list|(
literal|"%s 3RQ %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_iodone
case|:
comment|/* iodone called */
name|printf
argument_list|(
literal|"%s 4DN %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_raid5_data
case|:
comment|/* RAID-5 write data block */
name|printf
argument_list|(
literal|"%s 5RD %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_raid5_parity
case|:
comment|/* RAID-5 write parity block */
name|printf
argument_list|(
literal|"%s 6RP %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_sdio
case|:
comment|/* subdisk I/O */
name|printf
argument_list|(
literal|"%s %dVS %s %p\t\t  0x%-9x\t%ld\t%d\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|type
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|devminor
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_sdiodone
case|:
comment|/* subdisk I/O done */
name|printf
argument_list|(
literal|"%s %dSD %s %p\t\t  0x%-9x\t%ld\t%d\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|type
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|devminor
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_lockwait
case|:
name|printf
argument_list|(
literal|"%s Lockwait  %p\t  0x%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|stripe
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_lock
case|:
name|printf
argument_list|(
literal|"%s Lock      %p\t  0x%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|stripe
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_unlock
case|:
name|printf
argument_list|(
literal|"%s Unlock\t  %p\t  0x%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|stripe
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Print config file to a file.  This is a userland version  * of kernel format_config  */
end_comment

begin_function
name|void
name|vinum_printconfig
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|FILE
modifier|*
name|of
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: \tprintconfig [<outfile>]\n"
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
name|of
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
else|else
name|of
operator|=
name|stdout
expr_stmt|;
if|if
condition|(
name|of
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open %s: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|printconfig
argument_list|(
name|of
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
name|fclose
argument_list|(
name|of
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * The guts of printconfig.  This is called from  * vinum_printconfig and from vinum_create when  * called without an argument, in order to give  * the user something to edit.  */
end_comment

begin_function
name|void
name|printconfig
parameter_list|(
name|FILE
modifier|*
name|of
parameter_list|,
name|char
modifier|*
name|comment
parameter_list|)
block|{
name|struct
name|utsname
name|uname_s
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|volume
name|vol
decl_stmt|;
name|struct
name|plex
name|plex
decl_stmt|;
name|struct
name|sd
name|sd
decl_stmt|;
name|struct
name|drive
name|drive
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
name|uname
argument_list|(
operator|&
name|uname_s
argument_list|)
expr_stmt|;
comment|/* get our system name */
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* and the current time */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"# Vinum configuration of %s, saved at %s"
argument_list|,
name|uname_s
operator|.
name|nodename
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
comment|/* say who did it */
if|if
condition|(
name|comment
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
comment|/* abuse this for commented version */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"# Current configuration:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|drives_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|state
operator|!=
name|drive_unallocated
condition|)
block|{
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%sdrive %s device %s\n"
argument_list|,
name|comment
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|volumes_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|state
operator|!=
name|volume_unallocated
condition|)
block|{
if|if
condition|(
name|vol
operator|.
name|preferred_plex
operator|>=
literal|0
condition|)
comment|/* preferences, */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%svolume %s readpol prefer %s\n"
argument_list|,
name|comment
argument_list|,
name|vol
operator|.
name|name
argument_list|,
name|vinum_conf
operator|.
name|plex
index|[
name|vol
operator|.
name|preferred_plex
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
else|else
comment|/* default round-robin */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%svolume %s\n"
argument_list|,
name|comment
argument_list|,
name|vol
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Then the plex configuration */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|plexes_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|state
operator|!=
name|plex_unallocated
condition|)
block|{
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%splex name %s org %s "
argument_list|,
name|comment
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|plex_org
argument_list|(
name|plex
operator|.
name|organization
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isstriped
argument_list|(
operator|(
operator|&
name|plex
operator|)
argument_list|)
condition|)
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%ds "
argument_list|,
operator|(
name|int
operator|)
name|plex
operator|.
name|stripesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|volno
operator|>=
literal|0
condition|)
block|{
comment|/* we have a volume */
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|plex
operator|.
name|volno
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"vol %s "
argument_list|,
name|vol
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"detached "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* And finally the subdisk configuration */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
condition|)
block|{
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|sd
operator|.
name|driveno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|plexno
operator|>=
literal|0
condition|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|sd
operator|.
name|plexno
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%ssd name %s drive %s plex %s len %llds driveoffset %llds plexoffset %llds\n"
argument_list|,
name|comment
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|plex
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|driveoffset
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|plexoffset
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%ssd name %s drive %s detached len %llds driveoffset %llds\n"
argument_list|,
name|comment
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|driveoffset
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|list_defective_objects
parameter_list|()
block|{
name|int
name|o
decl_stmt|;
comment|/* object */
name|int
name|heading_needed
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|drives_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|drive
operator|.
name|state
operator|!=
name|drive_unallocated
operator|)
comment|/* drive exists */
operator|&&
operator|(
name|drive
operator|.
name|state
operator|!=
name|drive_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_ldi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|volumes_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vol
operator|.
name|state
operator|!=
name|volume_unallocated
operator|)
comment|/* volume exists */
operator|&&
operator|(
name|vol
operator|.
name|state
operator|!=
name|volume_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_lvi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|plexes_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|plex
operator|.
name|state
operator|!=
name|plex_unallocated
operator|)
comment|/* plex exists */
operator|&&
operator|(
name|plex
operator|.
name|state
operator|!=
name|plex_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_lpi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
operator|)
comment|/* sd exists */
operator|&&
operator|(
name|sd
operator|.
name|state
operator|!=
name|sd_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_lsi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
block|}
end_function

begin_comment
comment|/* Dump config from specified disk drives */
end_comment

begin_function
name|void
name|vinum_dumpconfig
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
comment|/* start everything */
name|int
name|devs
init|=
name|getnumdevs
argument_list|()
decl_stmt|;
name|struct
name|statinfo
name|statinfo
decl_stmt|;
name|char
modifier|*
name|namelist
decl_stmt|;
name|char
modifier|*
name|enamelist
decl_stmt|;
comment|/* end of name list */
name|int
name|i
decl_stmt|;
name|char
modifier|*
modifier|*
name|token
decl_stmt|;
comment|/* list of tokens */
name|int
name|tokens
decl_stmt|;
comment|/* and their number */
name|bzero
argument_list|(
operator|&
name|statinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|statinfo
argument_list|)
argument_list|)
expr_stmt|;
name|statinfo
operator|.
name|dinfo
operator|=
name|malloc
argument_list|(
name|devs
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|statinfo
argument_list|)
argument_list|)
expr_stmt|;
name|namelist
operator|=
name|malloc
argument_list|(
name|devs
operator|*
operator|(
name|DEVSTAT_NAME_LEN
operator|+
literal|8
operator|)
argument_list|)
expr_stmt|;
name|token
operator|=
name|malloc
argument_list|(
operator|(
name|devs
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|statinfo
operator|.
name|dinfo
operator|==
name|NULL
operator|)
operator|||
operator|(
name|namelist
operator|==
name|NULL
operator|)
operator|||
operator|(
name|token
operator|==
name|NULL
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate memory for drive list\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|bzero
argument_list|(
name|statinfo
operator|.
name|dinfo
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|devinfo
argument_list|)
argument_list|)
expr_stmt|;
name|tokens
operator|=
literal|0
expr_stmt|;
comment|/* no tokens yet */
if|if
condition|(
name|getdevs
argument_list|(
operator|&
name|statinfo
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* find out what devices we have */
name|perror
argument_list|(
literal|"Can't get device list"
argument_list|)
expr_stmt|;
return|return;
block|}
name|namelist
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* start with empty namelist */
name|enamelist
operator|=
name|namelist
expr_stmt|;
comment|/* point to the end of the list */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|devs
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|devstat
modifier|*
name|stat
init|=
operator|&
name|statinfo
operator|.
name|dinfo
operator|->
name|devices
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|stat
operator|->
name|device_type
operator|&
name|DEVSTAT_TYPE_MASK
operator|)
operator|==
name|DEVSTAT_TYPE_DIRECT
operator|)
comment|/* disk device */
operator|&&
operator|(
operator|(
name|stat
operator|->
name|device_type
operator|&
name|DEVSTAT_TYPE_PASS
operator|)
operator|==
literal|0
operator|)
comment|/* and not passthrough */
operator|&&
operator|(
operator|(
name|stat
operator|->
name|device_name
index|[
literal|0
index|]
operator|!=
literal|'\0'
operator|)
operator|)
condition|)
block|{
comment|/* and it has a name */
name|sprintf
argument_list|(
name|enamelist
argument_list|,
literal|"/dev/%s%d"
argument_list|,
name|stat
operator|->
name|device_name
argument_list|,
name|stat
operator|->
name|unit_number
argument_list|)
expr_stmt|;
name|token
index|[
name|tokens
index|]
operator|=
name|enamelist
expr_stmt|;
comment|/* point to it */
name|tokens
operator|++
expr_stmt|;
comment|/* one more token */
name|enamelist
operator|=
operator|&
name|enamelist
index|[
name|strlen
argument_list|(
name|enamelist
argument_list|)
operator|+
literal|1
index|]
expr_stmt|;
comment|/* and start beyond the end */
block|}
block|}
name|free
argument_list|(
name|statinfo
operator|.
name|dinfo
argument_list|)
expr_stmt|;
comment|/* don't need the list any more */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tokens
condition|;
name|i
operator|++
control|)
name|dumpconfig
argument_list|(
name|token
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|namelist
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|token
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* list specified drives */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|dumpconfig
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|DEVLEN
value|5
end_define

begin_function
name|void
name|dumpconfig
parameter_list|(
name|char
modifier|*
name|part
parameter_list|)
block|{
name|char
name|partname
index|[
name|MAXPATHLEN
index|]
decl_stmt|;
name|char
modifier|*
name|partid
decl_stmt|;
name|char
name|partition
decl_stmt|;
comment|/* UNIX partition */
name|int
name|slice
decl_stmt|;
name|int
name|founddrive
decl_stmt|;
comment|/* flag when we find a vinum drive */
name|struct
name|disklabel
name|label
decl_stmt|;
comment|/* label of this drive */
name|int
name|driveno
decl_stmt|;
comment|/* fd of drive */
name|int
name|found
decl_stmt|;
name|u_int64_t
name|drivelength
decl_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|part
argument_list|,
literal|"/dev/"
argument_list|,
name|DEVLEN
argument_list|)
operator|==
literal|0
condition|)
comment|/* starts with /dev */
name|memcpy
argument_list|(
name|partname
argument_list|,
name|part
argument_list|,
name|MAXPATHLEN
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* prepend */
name|strcpy
argument_list|(
name|partname
argument_list|,
literal|"/dev/"
argument_list|)
expr_stmt|;
name|strncat
argument_list|(
operator|&
name|partname
index|[
name|DEVLEN
index|]
argument_list|,
name|part
argument_list|,
name|MAXPATHLEN
operator|-
name|DEVLEN
argument_list|)
expr_stmt|;
block|}
name|partid
operator|=
operator|&
name|partname
index|[
name|strlen
argument_list|(
name|partname
argument_list|)
index|]
expr_stmt|;
name|founddrive
operator|=
literal|0
expr_stmt|;
comment|/* no vinum drive found yet on this spindle */
comment|/* first try the partition table */
for|for
control|(
name|slice
operator|=
literal|1
init|;
name|slice
operator|<
literal|5
condition|;
name|slice
operator|++
control|)
block|{
name|sprintf
argument_list|(
name|partid
argument_list|,
literal|"s%dc"
argument_list|,
name|slice
argument_list|)
expr_stmt|;
comment|/* c partition */
name|driveno
operator|=
name|open
argument_list|(
name|partname
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|driveno
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open %s: %s (%d)\n"
argument_list|,
name|partname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|driveno
argument_list|,
name|DIOCGDINFO
argument_list|,
operator|&
name|label
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get label from %s: %s (%d)\n"
argument_list|,
name|partname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|partition
operator|=
literal|'a'
init|;
name|partition
operator|<
literal|'i'
condition|;
name|partition
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|partition
operator|!=
literal|'c'
operator|)
comment|/* it's not the c partition */
operator|&&
operator|(
operator|(
name|label
operator|.
name|d_partitions
index|[
name|partition
operator|-
literal|'a'
index|]
operator|.
name|p_fstype
operator|==
name|FS_VINUM
operator|)
comment|/* and it's a Vinum partition */
operator|||
name|Verbose
operator|)
condition|)
block|{
comment|/* or we're just plain curious */
name|sprintf
argument_list|(
name|partid
argument_list|,
literal|"s%d%c"
argument_list|,
name|slice
argument_list|,
name|partition
argument_list|)
expr_stmt|;
name|found
operator|=
name|check_drive
argument_list|(
name|partname
argument_list|)
expr_stmt|;
comment|/* try to open it */
name|founddrive
operator||=
name|found
expr_stmt|;
comment|/* and note if we were successful at all */
if|if
condition|(
name|label
operator|.
name|d_partitions
index|[
name|partition
operator|-
literal|'a'
index|]
operator|.
name|p_fstype
operator|==
name|FS_VINUM
condition|)
block|{
comment|/* it's a Vinum partition */
name|drivelength
operator|=
operator|(
operator|(
name|u_int64_t
operator|)
name|label
operator|.
name|d_partitions
index|[
name|partition
operator|-
literal|'a'
index|]
operator|.
name|p_size
operator|)
operator|*
name|DEV_BSIZE
expr_stmt|;
name|printf
argument_list|(
literal|"Drive %s: %s (%lld bytes)\n"
argument_list|,
name|partname
argument_list|,
name|roughlength
argument_list|(
name|drivelength
argument_list|,
literal|1
argument_list|)
argument_list|,
name|drivelength
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|found
operator|)
operator|&&
name|vflag
condition|)
comment|/* we're talkative */
name|printf
argument_list|(
literal|"*** no configuration found ***\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|founddrive
operator|==
literal|0
condition|)
block|{
comment|/* didn't find anything, */
name|sprintf
argument_list|(
name|partid
argument_list|,
literal|"c"
argument_list|)
expr_stmt|;
comment|/* c partition */
name|driveno
operator|=
name|open
argument_list|(
name|partname
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|driveno
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENOENT
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open %s: %s (%d)\n"
argument_list|,
name|partname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|driveno
argument_list|,
name|DIOCGDINFO
argument_list|,
operator|&
name|label
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get label from %s: %s (%d)\n"
argument_list|,
name|partname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|partition
operator|=
literal|'a'
init|;
name|partition
operator|<
literal|'i'
condition|;
name|partition
operator|++
control|)
block|{
comment|/* try the compatibility partition */
if|if
condition|(
operator|(
name|partition
operator|!=
literal|'c'
operator|)
comment|/* it's not the c partition */
operator|&&
operator|(
operator|(
name|label
operator|.
name|d_partitions
index|[
name|partition
operator|-
literal|'a'
index|]
operator|.
name|p_fstype
operator|==
name|FS_VINUM
operator|)
comment|/* and it's a Vinum partition */
operator|||
name|Verbose
operator|)
condition|)
block|{
comment|/* or we're just plain curious */
name|sprintf
argument_list|(
name|partid
argument_list|,
literal|"%c"
argument_list|,
name|partition
argument_list|)
expr_stmt|;
name|found
operator|=
name|check_drive
argument_list|(
name|partname
argument_list|)
expr_stmt|;
comment|/* try to open it */
name|founddrive
operator||=
name|found
expr_stmt|;
comment|/* and note if we were successful at all */
if|if
condition|(
name|label
operator|.
name|d_partitions
index|[
name|partition
operator|-
literal|'a'
index|]
operator|.
name|p_fstype
operator|==
name|FS_VINUM
condition|)
block|{
comment|/* it's a Vinum partition */
name|drivelength
operator|=
operator|(
operator|(
name|u_int64_t
operator|)
name|label
operator|.
name|d_partitions
index|[
name|partition
operator|-
literal|'a'
index|]
operator|.
name|p_size
operator|)
operator|*
name|DEV_BSIZE
expr_stmt|;
name|printf
argument_list|(
literal|"Drive %s: %s (%lld bytes)\n"
argument_list|,
name|partname
argument_list|,
name|roughlength
argument_list|(
name|drivelength
argument_list|,
literal|1
argument_list|)
argument_list|,
name|drivelength
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|found
operator|)
operator|&&
name|vflag
condition|)
comment|/* we're talkative */
name|printf
argument_list|(
literal|"*** no configuration found ***\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Check a drive for a Vinum header.  If found,  * print configuration information from the drive.  *  * Return 1 if Vinum config found.  */
end_comment

begin_function
name|int
name|check_drive
parameter_list|(
name|char
modifier|*
name|devicename
parameter_list|)
block|{
name|int
name|fd
decl_stmt|;
name|char
name|vinumlabel
index|[
name|DEV_BSIZE
index|]
decl_stmt|;
comment|/* one sector for label */
name|struct
name|vinum_hdr
modifier|*
name|hdr
init|=
operator|(
expr|struct
name|vinum_hdr
operator|*
operator|)
name|vinumlabel
decl_stmt|;
comment|/* with this structure */
name|char
modifier|*
name|config_text
decl_stmt|;
comment|/* read the config info from disk into here */
name|time_t
name|t
decl_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|devicename
argument_list|,
name|O_RDONLY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|lseek
argument_list|(
name|fd
argument_list|,
name|VINUM_LABEL_OFFSET
argument_list|,
name|SEEK_SET
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't seek label for %s: %s (%d)\n"
argument_list|,
name|devicename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|vinumlabel
argument_list|,
name|DEV_BSIZE
argument_list|)
operator|!=
name|DEV_BSIZE
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINVAL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't read label from %s: %s (%d)\n"
argument_list|,
name|devicename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|hdr
operator|->
name|magic
operator|==
name|VINUM_MAGIC
operator|)
operator|||
operator|(
name|vflag
operator|&&
operator|(
name|hdr
operator|->
name|magic
operator|==
name|VINUM_NOMAGIC
operator|)
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Drive %s:\tDevice %s\n"
argument_list|,
name|hdr
operator|->
name|label
operator|.
name|name
argument_list|,
name|devicename
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|->
name|magic
operator|==
name|VINUM_NOMAGIC
condition|)
name|printf
argument_list|(
literal|"*** Drive has been obliterated ***\n"
argument_list|)
expr_stmt|;
name|t
operator|=
name|hdr
operator|->
name|label
operator|.
name|date_of_birth
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tCreated on %s at %s"
argument_list|,
name|hdr
operator|->
name|label
operator|.
name|sysname
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|hdr
operator|->
name|label
operator|.
name|last_update
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tConfig last updated %s"
argument_list|,
comment|/* care: \n at end */
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tSize: %16lld bytes (%lld MB)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|hdr
operator|->
name|label
operator|.
name|drive_size
argument_list|,
comment|/* bytes used */
call|(
name|long
name|long
call|)
argument_list|(
name|hdr
operator|->
name|label
operator|.
name|drive_size
operator|/
name|MEGABYTE
argument_list|)
argument_list|)
expr_stmt|;
name|config_text
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|MAXCONFIG
argument_list|)
expr_stmt|;
if|if
condition|(
name|config_text
operator|==
name|NULL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't allocate memory\n"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
name|config_text
argument_list|,
name|MAXCONFIG
argument_list|)
operator|!=
name|MAXCONFIG
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't read config from %s: %s (%d)\n"
argument_list|,
name|devicename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|,
name|errno
argument_list|)
expr_stmt|;
else|else
name|puts
argument_list|(
name|config_text
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|config_text
argument_list|)
expr_stmt|;
block|}
block|}
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Local Variables: */
end_comment

begin_comment
comment|/* fill-column: 50 */
end_comment

begin_comment
comment|/* End: */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*      list.c: vinum interface program, list routines  */
end_comment

begin_comment
comment|/*-  * Copyright (c) 1997, 1998  *	Nan Yang Computer Services Limited.  All rights reserved.  *  *  Parts copyright (c) 1997, 1998 Cybernet Corporation, NetMAX project.  *  *  Written by Greg Lehey  *  *  This software is distributed under the so-called ``Berkeley  *  License'':  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Nan Yang Computer  *      Services Limited.  * 4. Neither the name of the Company nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * This software is provided ``as is'', and any express or implied  * warranties, including, but not limited to, the implied warranties of  * merchantability and fitness for a particular purpose are disclaimed.  * In no event shall the company or contributors be liable for any  * direct, indirect, incidental, special, exemplary, or consequential  * damages (including, but not limited to, procurement of substitute  * goods or services; loss of use, data, or profits; or business  * interruption) however caused and on any theory of liability, whether  * in contract, strict liability, or tort (including negligence or  * otherwise) arising in any way out of the use of this software, even if  * advised of the possibility of such damage.  *  * $Id: list.c,v 1.19 1999/08/24 02:32:57 grog Exp $  */
end_comment

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|<setjmp.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/utsname.h>
end_include

begin_include
include|#
directive|include
file|<dev/vinum/vinumhdr.h>
end_include

begin_include
include|#
directive|include
file|"vext.h"
end_include

begin_include
include|#
directive|include
file|<dev/vinum/request.h>
end_include

begin_comment
comment|/* Take a size in sectors and return a pointer to a  * string which represents the size best.  * If lj is != 0, return left justified, otherwise  * in a fixed 10 character field suitable for  * columnar printing.  *  * Note this uses a static string: it's only intended to  * be used immediately for printing */
end_comment

begin_function
name|char
modifier|*
name|roughlength
parameter_list|(
name|long
name|long
name|bytes
parameter_list|,
name|int
name|lj
parameter_list|)
block|{
specifier|static
name|char
name|description
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|bytes
operator|>
operator|(
name|long
name|long
operator|)
name|MEGABYTE
operator|*
literal|10000
condition|)
comment|/* gigabytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%d GB"
else|:
literal|"%10d GB"
argument_list|,
name|bytes
operator|/
name|GIGABYTE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bytes
operator|>
name|KILOBYTE
operator|*
literal|10000
condition|)
comment|/* megabytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%d MB"
else|:
literal|"%10d MB"
argument_list|,
name|bytes
operator|/
name|MEGABYTE
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|bytes
operator|>
literal|10000
condition|)
comment|/* kilobytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%d kB"
else|:
literal|"%10d kB"
argument_list|,
name|bytes
operator|/
name|KILOBYTE
argument_list|)
expr_stmt|;
else|else
comment|/* bytes */
name|sprintf
argument_list|(
name|description
argument_list|,
name|lj
condition|?
literal|"%d  B"
else|:
literal|"%10d  B"
argument_list|,
name|bytes
argument_list|)
expr_stmt|;
return|return
name|description
return|;
block|}
end_function

begin_function
name|void
name|vinum_list
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|object
decl_stmt|;
name|int
name|i
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|sflag
operator|&
operator|(
operator|!
name|verbose
operator|)
condition|)
comment|/* just summary stats, */
name|printf
argument_list|(
literal|"Object\t\t  Reads\t\tBytes\tAverage\tRecover\t Writes\t\tBytes\tAverage\t  Mblock  Mstripe\n\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
name|listconfig
argument_list|()
expr_stmt|;
comment|/* list everything */
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|object
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
comment|/* look for it */
if|if
condition|(
name|vinum_li
argument_list|(
name|object
argument_list|,
name|type
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't find object: %s\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* List an object */
end_comment

begin_function
name|int
name|vinum_li
parameter_list|(
name|int
name|object
parameter_list|,
name|enum
name|objecttype
name|type
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|drive_object
case|:
name|vinum_ldi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
case|case
name|sd_object
case|:
name|vinum_lsi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
case|case
name|plex_object
case|:
name|vinum_lpi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
case|case
name|volume_object
case|:
name|vinum_lvi
argument_list|(
name|object
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|vinum_ldi
parameter_list|(
name|int
name|driveno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|time_t
name|t
decl_stmt|;
comment|/* because Bruce says so */
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|driveno
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|state
operator|!=
name|drive_unallocated
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Drive %s:\tDevice %s\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|)
expr_stmt|;
name|t
operator|=
name|drive
operator|.
name|label
operator|.
name|date_of_birth
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tCreated on %s at %s"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|sysname
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
name|drive
operator|.
name|label
operator|.
name|last_update
operator|.
name|tv_sec
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tConfig last updated %s"
argument_list|,
comment|/* care: \n at end */
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tSize: %16qd bytes (%qd MB)\n\t\tUsed: %16qd bytes (%qd MB)\n"
literal|"\t\tAvailable: %11qd bytes (%d MB)\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|drive_size
argument_list|,
comment|/* bytes used */
operator|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|/
name|MEGABYTE
operator|)
argument_list|,
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|-
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|-
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
operator|)
operator|/
name|MEGABYTE
argument_list|,
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
argument_list|,
call|(
name|int
call|)
argument_list|(
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tState: %s\n"
argument_list|,
name|drive_state
argument_list|(
name|drive
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|lasterror
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tLast error: %s\n"
argument_list|,
name|strerror
argument_list|(
name|drive
operator|.
name|lasterror
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\tLast error: none\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|Verbose
condition|)
block|{
comment|/* print the free list */
name|int
name|fe
decl_stmt|;
comment|/* freelist entry */
name|struct
name|drive_freelist
name|freelist
decl_stmt|;
struct|struct
name|ferq
block|{
comment|/* request to pass to ioctl */
name|int
name|driveno
decl_stmt|;
name|int
name|fe
decl_stmt|;
block|}
modifier|*
name|ferq
init|=
operator|(
expr|struct
name|ferq
operator|*
operator|)
operator|&
name|freelist
struct|;
name|printf
argument_list|(
literal|"\t\tFree list contains %d entries:\n\t\t   Offset\t     Size\n"
argument_list|,
name|drive
operator|.
name|freelist_entries
argument_list|)
expr_stmt|;
for|for
control|(
name|fe
operator|=
literal|0
init|;
name|fe
operator|<
name|drive
operator|.
name|freelist_entries
condition|;
name|fe
operator|++
control|)
block|{
name|ferq
operator|->
name|driveno
operator|=
name|drive
operator|.
name|driveno
expr_stmt|;
name|ferq
operator|->
name|fe
operator|=
name|fe
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETFREELIST
argument_list|,
operator|&
name|freelist
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't get free list element %d: %s\n"
argument_list|,
name|fe
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|longjmp
argument_list|(
name|command_fail
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\t\t%9qd\t%9lld\n"
argument_list|,
name|freelist
operator|.
name|offset
argument_list|,
name|freelist
operator|.
name|sectors
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
block|{
name|printf
argument_list|(
literal|"D %-21s State: %s\tDevice %s\tAvail: %qd/%qd MB"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive_state
argument_list|(
name|drive
operator|.
name|state
argument_list|)
argument_list|,
name|drive
operator|.
name|devicename
argument_list|,
name|drive
operator|.
name|sectors_available
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|,
operator|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|/
name|MEGABYTE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* can't print percentages */
else|else
name|printf
argument_list|(
literal|" (%d%%)\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|drive
operator|.
name|sectors_available
operator|*
literal|100
operator|*
name|DEV_BSIZE
operator|)
operator|/
operator|(
name|drive
operator|.
name|label
operator|.
name|drive_size
operator|-
operator|(
name|DATASTART
operator|*
name|DEV_BSIZE
operator|)
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|verbose
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16qd\n\t\tBytes read:\t%16qd (%s)\n"
argument_list|,
name|drive
operator|.
name|reads
argument_list|,
name|drive
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|drive
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16qd bytes\n"
argument_list|,
name|drive
operator|.
name|bytes_read
operator|/
name|drive
operator|.
name|reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16qd\n\t\tBytes written:\t%16qd (%s)\n"
argument_list|,
name|drive
operator|.
name|writes
argument_list|,
name|drive
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|drive
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16qd bytes\n"
argument_list|,
name|drive
operator|.
name|bytes_written
operator|/
name|drive
operator|.
name|writes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* non-verbose stats */
name|printf
argument_list|(
literal|"%-15s\t%7qd\t%15qd\t"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|reads
argument_list|,
name|drive
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\t\t"
argument_list|,
name|drive
operator|.
name|bytes_read
operator|/
name|drive
operator|.
name|reads
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t%15qd\t"
argument_list|,
name|drive
operator|.
name|writes
argument_list|,
name|drive
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\n"
argument_list|,
name|drive
operator|.
name|bytes_written
operator|/
name|drive
operator|.
name|writes
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_ld
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|driveno
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|driveno
operator|=
literal|0
init|;
name|driveno
operator|<
name|vinum_conf
operator|.
name|drives_allocated
condition|;
name|driveno
operator|++
control|)
name|vinum_ldi
argument_list|(
name|driveno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|driveno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|drive_object
condition|)
name|vinum_ldi
argument_list|(
name|driveno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a drive\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lvi
parameter_list|(
name|int
name|volno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|volno
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|state
operator|!=
name|volume_unallocated
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Volume %s:\tSize: %qd bytes (%qd MB)\n"
literal|"\t\tState: %s\n\t\tFlags: %s%s%s\n"
argument_list|,
name|vol
operator|.
name|name
argument_list|,
operator|(
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|size
operator|)
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
operator|(
name|long
name|long
operator|)
name|vol
operator|.
name|size
operator|)
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|,
name|volume_state
argument_list|(
name|vol
operator|.
name|state
argument_list|)
argument_list|,
name|vol
operator|.
name|flags
operator|&
name|VF_OPEN
condition|?
literal|"open "
else|:
literal|""
argument_list|,
operator|(
name|vol
operator|.
name|flags
operator|&
name|VF_WRITETHROUGH
condition|?
literal|"writethrough "
else|:
literal|""
operator|)
argument_list|,
operator|(
name|vol
operator|.
name|flags
operator|&
name|VF_RAW
condition|?
literal|"raw"
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t%d plexes\n\t\tRead policy: "
argument_list|,
name|vol
operator|.
name|plexes
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|preferred_plex
operator|<
literal|0
condition|)
comment|/* round robin */
name|printf
argument_list|(
literal|"round robin\n"
argument_list|)
expr_stmt|;
else|else
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|vol
operator|.
name|plex
index|[
name|vol
operator|.
name|preferred_plex
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"plex %d (%s)\n"
argument_list|,
name|vol
operator|.
name|preferred_plex
argument_list|,
name|plex
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
comment|/* brief */
name|printf
argument_list|(
literal|"V %-21s State: %s\tPlexes: %7d\tSize: %s\n"
argument_list|,
name|vol
operator|.
name|name
argument_list|,
name|volume_state
argument_list|(
name|vol
operator|.
name|state
argument_list|)
argument_list|,
name|vol
operator|.
name|plexes
argument_list|,
name|roughlength
argument_list|(
name|vol
operator|.
name|size
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|verbose
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16qd\n\t\tRecovered:\t%16qd\n\t\tBytes read:\t%16qd (%s)\n"
argument_list|,
name|vol
operator|.
name|reads
argument_list|,
name|vol
operator|.
name|recovered_reads
argument_list|,
name|vol
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|vol
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16qd bytes\n"
argument_list|,
name|vol
operator|.
name|bytes_read
operator|/
name|vol
operator|.
name|reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16qd\n\t\tBytes written:\t%16qd (%s)\n"
argument_list|,
name|vol
operator|.
name|writes
argument_list|,
name|vol
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|vol
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16qd bytes\n"
argument_list|,
name|vol
operator|.
name|bytes_written
operator|/
name|vol
operator|.
name|writes
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tActive requests:\t%8d\n"
argument_list|,
name|vol
operator|.
name|active
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* brief stats listing */
name|printf
argument_list|(
literal|"%-15s\t%7qd\t%15qd\t"
argument_list|,
name|vol
operator|.
name|name
argument_list|,
name|vol
operator|.
name|reads
argument_list|,
name|vol
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\t"
argument_list|,
name|vol
operator|.
name|bytes_read
operator|/
name|vol
operator|.
name|reads
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t"
argument_list|,
name|vol
operator|.
name|recovered_reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t%15qd\t"
argument_list|,
name|vol
operator|.
name|writes
argument_list|,
name|vol
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\n"
argument_list|,
name|vol
operator|.
name|bytes_written
operator|/
name|vol
operator|.
name|writes
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vol
operator|.
name|plexes
operator|>
literal|0
condition|)
block|{
name|int
name|plexno
decl_stmt|;
if|if
condition|(
name|Verbose
condition|)
block|{
comment|/* brief list */
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vol
operator|.
name|plexes
condition|;
name|plexno
operator|++
control|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|)
expr_stmt|;
comment|/* Just a brief summary here */
name|printf
argument_list|(
literal|"\t\tPlex %2d:\t%s\t(%s), %s\n"
argument_list|,
name|plexno
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|plex_org
argument_list|(
name|plex
operator|.
name|organization
argument_list|)
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|length
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
block|{
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vol
operator|.
name|plexes
condition|;
name|plexno
operator|++
control|)
name|vinum_lpi
argument_list|(
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* first show the plexes */
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vol
operator|.
name|plexes
condition|;
name|plexno
operator|++
control|)
block|{
comment|/* then the subdisks */
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|subdisks
operator|>
literal|0
condition|)
block|{
name|int
name|sdno
decl_stmt|;
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|plex
operator|.
name|subdisks
condition|;
name|sdno
operator|++
control|)
block|{
name|get_plex_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|vol
operator|.
name|plex
index|[
name|plexno
index|]
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
name|vinum_lsi
argument_list|(
name|sd
operator|.
name|sdno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|verbose
operator|==
literal|0
condition|)
comment|/* not verbose, but recursive */
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* leave a line at the end of each hierarchy */
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lv
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|volno
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
for|for
control|(
name|volno
operator|=
literal|0
init|;
name|volno
operator|<
name|vinum_conf
operator|.
name|volumes_allocated
condition|;
name|volno
operator|++
control|)
name|vinum_lvi
argument_list|(
name|volno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|volno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|volume_object
condition|)
name|vinum_lvi
argument_list|(
name|volno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a volume\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lpi
parameter_list|(
name|int
name|plexno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|plexno
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|state
operator|!=
name|plex_unallocated
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Plex %s:\tSize:\t%9qd bytes (%qd MB)\n\t\tSubdisks: %8d\n"
argument_list|,
name|plex
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|length
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|long
name|long
operator|)
name|plex
operator|.
name|length
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|,
name|plex
operator|.
name|subdisks
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tState: %s\n\t\tOrganization: %s"
argument_list|,
name|plex_state
argument_list|(
name|plex
operator|.
name|state
argument_list|)
argument_list|,
name|plex_org
argument_list|(
name|plex
operator|.
name|organization
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|plex
operator|.
name|organization
operator|==
name|plex_striped
operator|)
operator|||
operator|(
name|plex
operator|.
name|organization
operator|==
name|plex_raid5
operator|)
condition|)
name|printf
argument_list|(
literal|"\tStripe size: %s\n"
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|stripesize
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|volno
operator|>=
literal|0
condition|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|plex
operator|.
name|volno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tPart of volume %s\n"
argument_list|,
name|vol
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
block|{
name|char
modifier|*
name|org
init|=
literal|""
decl_stmt|;
comment|/* organization */
switch|switch
condition|(
name|plex
operator|.
name|organization
condition|)
block|{
case|case
name|plex_disorg
case|:
comment|/* disorganized */
name|org
operator|=
literal|"??"
expr_stmt|;
break|break;
case|case
name|plex_concat
case|:
comment|/* concatenated plex */
name|org
operator|=
literal|"C"
expr_stmt|;
break|break;
case|case
name|plex_striped
case|:
comment|/* striped plex */
name|org
operator|=
literal|"S"
expr_stmt|;
break|break;
case|case
name|plex_raid5
case|:
comment|/* RAID5 plex */
name|org
operator|=
literal|"R5"
expr_stmt|;
break|break;
block|}
name|printf
argument_list|(
literal|"P %-18s %2s State: %s\tSubdisks: %5d\tSize: %s\n"
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|org
argument_list|,
name|plex_state
argument_list|(
name|plex
operator|.
name|state
argument_list|)
argument_list|,
name|plex
operator|.
name|subdisks
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|length
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|verbose
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16qd\n\t\tBytes read:\t%16qd (%s)\n"
argument_list|,
name|plex
operator|.
name|reads
argument_list|,
name|plex
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16qd bytes\n"
argument_list|,
name|plex
operator|.
name|bytes_read
operator|/
name|plex
operator|.
name|reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16qd\n\t\tBytes written:\t%16qd (%s)\n"
argument_list|,
name|plex
operator|.
name|writes
argument_list|,
name|plex
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|plex
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16qd bytes\n"
argument_list|,
name|plex
operator|.
name|bytes_written
operator|/
name|plex
operator|.
name|writes
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|plex
operator|.
name|reads
operator|+
name|plex
operator|.
name|writes
operator|)
operator|>
literal|0
operator|)
operator|&&
operator|(
operator|(
name|plex
operator|.
name|organization
operator|==
name|plex_striped
operator|)
operator|||
operator|(
name|plex
operator|.
name|organization
operator|==
name|plex_raid5
operator|)
operator|)
condition|)
name|printf
argument_list|(
literal|"\t\tMultiblock:\t%16qd (%d%%)\n"
literal|"\t\tMultistripe:\t%16qd (%d%%)\n"
argument_list|,
name|plex
operator|.
name|multiblock
argument_list|,
call|(
name|int
call|)
argument_list|(
name|plex
operator|.
name|multiblock
operator|*
literal|100
operator|/
operator|(
name|plex
operator|.
name|reads
operator|+
name|plex
operator|.
name|writes
operator|)
argument_list|)
argument_list|,
name|plex
operator|.
name|multistripe
argument_list|,
call|(
name|int
call|)
argument_list|(
name|plex
operator|.
name|multistripe
operator|*
literal|100
operator|/
operator|(
name|plex
operator|.
name|reads
operator|+
name|plex
operator|.
name|writes
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|recovered_reads
condition|)
name|printf
argument_list|(
literal|"\t\tRecovered reads:%16qd\n"
argument_list|,
name|plex
operator|.
name|recovered_reads
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|degraded_writes
condition|)
name|printf
argument_list|(
literal|"\t\tDegraded writes:%16qd\n"
argument_list|,
name|plex
operator|.
name|degraded_writes
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|parityless_writes
condition|)
name|printf
argument_list|(
literal|"\t\tParityless writes:%14qd\n"
argument_list|,
name|plex
operator|.
name|parityless_writes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%-15s\t%7qd\t%15qd\t"
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|plex
operator|.
name|reads
argument_list|,
name|plex
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\t"
argument_list|,
name|plex
operator|.
name|bytes_read
operator|/
name|plex
operator|.
name|reads
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t"
argument_list|,
name|plex
operator|.
name|recovered_reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t%15qd\t"
argument_list|,
name|plex
operator|.
name|writes
argument_list|,
name|plex
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\t"
argument_list|,
name|plex
operator|.
name|bytes_written
operator|/
name|plex
operator|.
name|writes
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t%7qd\n"
argument_list|,
name|plex
operator|.
name|multiblock
argument_list|,
name|plex
operator|.
name|multistripe
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|plex
operator|.
name|subdisks
operator|>
literal|0
condition|)
block|{
name|int
name|sdno
decl_stmt|;
if|if
condition|(
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|plex
operator|.
name|subdisks
condition|;
name|sdno
operator|++
control|)
block|{
name|get_plex_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|plexno
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tSubdisk %d:\t%s\n\t\t  state: %s\tsize %11qd (%qd MB)\n"
argument_list|,
name|sdno
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|sd_state
argument_list|(
name|sd
operator|.
name|state
argument_list|)
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|*
name|DEV_BSIZE
operator|/
name|MEGABYTE
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|organization
operator|==
name|plex_concat
condition|)
name|printf
argument_list|(
literal|"\t\t\toffset %9ld (0x%lx)\n"
argument_list|,
operator|(
name|long
operator|)
name|sd
operator|.
name|plexoffset
argument_list|,
operator|(
name|long
operator|)
name|sd
operator|.
name|plexoffset
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|plex
operator|.
name|subdisks
condition|;
name|sdno
operator|++
control|)
block|{
name|get_plex_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|plexno
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
name|vinum_lsi
argument_list|(
name|sd
operator|.
name|sdno
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lp
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|plexno
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|plexno
operator|=
literal|0
init|;
name|plexno
operator|<
name|vinum_conf
operator|.
name|plexes_allocated
condition|;
name|plexno
operator|++
control|)
name|vinum_lpi
argument_list|(
name|plexno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|plexno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|plex_object
condition|)
name|vinum_lpi
argument_list|(
name|plexno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a plex\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vinum_lsi
parameter_list|(
name|int
name|sdno
parameter_list|,
name|int
name|recurse
parameter_list|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|sdno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
name|printf
argument_list|(
literal|"Subdisk %s:\n\t\tSize: %16qd bytes (%qd MB)\n\t\tState: %s\n"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|*
name|DEV_BSIZE
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|sectors
operator|/
operator|(
name|MEGABYTE
operator|/
name|DEV_BSIZE
operator|)
argument_list|,
name|sd_state
argument_list|(
name|sd
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|plexno
operator|>=
literal|0
condition|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|sd
operator|.
name|plexno
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tPlex %s"
argument_list|,
name|plex
operator|.
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" at offset %qd (%s)\n"
argument_list|,
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|plexoffset
operator|*
name|DEV_BSIZE
argument_list|,
name|roughlength
argument_list|(
operator|(
name|long
name|long
operator|)
name|sd
operator|.
name|plexoffset
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sd
operator|.
name|state
operator|==
name|sd_reviving
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tRevive pointer:\t\t%s (%d%%)\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|revived
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
call|(
name|u_int64_t
call|)
argument_list|(
name|sd
operator|.
name|revived
operator|*
literal|100
argument_list|)
operator|)
operator|/
name|sd
operator|.
name|sectors
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tRevive blocksize:\t%s\n"
literal|"\t\tRevive interval:\t%10d seconds\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|revive_blocksize
argument_list|,
literal|0
argument_list|)
argument_list|,
name|sd
operator|.
name|revive_interval
argument_list|)
expr_stmt|;
block|}
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|sd
operator|.
name|driveno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|driveoffset
operator|<
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tDrive %s (%s), no offset\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\tDrive %s (%s) at offset %qd (%s)\n"
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|,
name|sd
operator|.
name|driveoffset
operator|*
name|DEV_BSIZE
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|driveoffset
operator|*
name|DEV_BSIZE
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|sflag
condition|)
block|{
comment|/* brief listing, no stats */
name|printf
argument_list|(
literal|"S %-21s State: %s\t"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|sd_state
argument_list|(
name|sd
operator|.
name|state
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|plexno
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"(detached)\t"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"PO: %s "
argument_list|,
operator|&
operator|(
name|roughlength
argument_list|(
name|sd
operator|.
name|plexoffset
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
operator|)
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* what a kludge! */
name|printf
argument_list|(
literal|"Size: %s\n"
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|sectors
operator|<<
name|DEV_BSHIFT
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sflag
condition|)
block|{
if|if
condition|(
name|verbose
operator|||
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\t\tReads:  \t%16qd\n\t\tBytes read:\t%16qd (%s)\n"
argument_list|,
name|sd
operator|.
name|reads
argument_list|,
name|sd
operator|.
name|bytes_read
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|bytes_read
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage read:\t%16qd bytes\n"
argument_list|,
name|sd
operator|.
name|bytes_read
operator|/
name|sd
operator|.
name|reads
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tWrites: \t%16qd\n\t\tBytes written:\t%16qd (%s)\n"
argument_list|,
name|sd
operator|.
name|writes
argument_list|,
name|sd
operator|.
name|bytes_written
argument_list|,
name|roughlength
argument_list|(
name|sd
operator|.
name|bytes_written
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"\t\tAverage write:\t%16qd bytes\n"
argument_list|,
name|sd
operator|.
name|bytes_written
operator|/
name|sd
operator|.
name|writes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%-15s\t%7qd\t%15qd\t"
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|sd
operator|.
name|reads
argument_list|,
name|sd
operator|.
name|bytes_read
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|reads
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\t\t"
argument_list|,
name|sd
operator|.
name|bytes_read
operator|/
name|sd
operator|.
name|reads
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\t\t"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%7qd\t%15qd\t"
argument_list|,
name|sd
operator|.
name|writes
argument_list|,
name|sd
operator|.
name|bytes_written
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|writes
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"%7qd\n"
argument_list|,
name|sd
operator|.
name|bytes_written
operator|/
name|sd
operator|.
name|writes
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|recurse
condition|)
name|vinum_ldi
argument_list|(
name|sd
operator|.
name|driveno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
comment|/* make it more readable */
block|}
block|}
end_function

begin_function
name|void
name|vinum_ls
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|sdno
decl_stmt|;
comment|/* Structures to read kernel data into */
name|struct
name|_vinum_conf
name|vinum_conf
decl_stmt|;
name|enum
name|objecttype
name|type
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|sdno
operator|=
literal|0
init|;
name|sdno
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|sdno
operator|++
control|)
name|vinum_lsi
argument_list|(
name|sdno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* specific subdisks */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|sdno
operator|=
name|find_object
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|sd_object
condition|)
name|vinum_lsi
argument_list|(
name|sdno
argument_list|,
name|recurse
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s is not a subdisk\n"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* List the complete configuration.   * XXX Change this to specific lists */
end_comment

begin_function
name|void
name|listconfig
parameter_list|()
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|verbose
operator|||
operator|(
operator|!
name|sflag
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"Configuration summary\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Drives:\t\t%d (%d configured)\n"
argument_list|,
name|vinum_conf
operator|.
name|drives_used
argument_list|,
name|vinum_conf
operator|.
name|drives_allocated
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Volumes:\t%d (%d configured)\n"
argument_list|,
name|vinum_conf
operator|.
name|volumes_used
argument_list|,
name|vinum_conf
operator|.
name|volumes_allocated
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Plexes:\t\t%d (%d configured)\n"
argument_list|,
name|vinum_conf
operator|.
name|plexes_used
argument_list|,
name|vinum_conf
operator|.
name|plexes_allocated
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Subdisks:\t%d (%d configured)\n\n"
argument_list|,
name|vinum_conf
operator|.
name|subdisks_used
argument_list|,
name|vinum_conf
operator|.
name|subdisks_allocated
argument_list|)
expr_stmt|;
block|}
name|vinum_ld
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|vinum_lv
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|vinum_lp
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|vinum_ls
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert a timeval to Tue Oct 13 13:54:14.0434324  * Return pointer to text */
end_comment

begin_function
name|char
modifier|*
name|timetext
parameter_list|(
name|struct
name|timeval
modifier|*
name|time
parameter_list|)
block|{
specifier|static
name|char
name|text
index|[
literal|30
index|]
decl_stmt|;
name|time_t
name|t
decl_stmt|;
comment|/* to keep Bruce happy */
name|t
operator|=
name|time
operator|->
name|tv_sec
expr_stmt|;
name|strcpy
argument_list|(
name|text
argument_list|,
name|ctime
argument_list|(
operator|&
name|t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* to the second */
name|sprintf
argument_list|(
operator|&
name|text
index|[
literal|19
index|]
argument_list|,
literal|".%06ld"
argument_list|,
name|time
operator|->
name|tv_usec
argument_list|)
expr_stmt|;
comment|/* and the microseconds */
return|return
operator|&
name|text
index|[
literal|11
index|]
return|;
block|}
end_function

begin_function
name|void
name|vinum_info
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|struct
name|meminfo
name|meminfo
decl_stmt|;
name|struct
name|mc
name|malloced
decl_stmt|;
name|int
name|i
decl_stmt|;
if|#
directive|if
name|VINUMDEBUG
name|struct
name|rqinfo
name|rq
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"Flags: 0x%x\n"
argument_list|,
name|vinum_conf
operator|.
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_MEMINFO
argument_list|,
operator|&
name|meminfo
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get information"
argument_list|)
expr_stmt|;
return|return;
block|}
name|printf
argument_list|(
literal|"Total of %d blocks malloced, total memory: %d\nMaximum allocs: %8d, malloc table at 0x%08x\n"
argument_list|,
name|meminfo
operator|.
name|mallocs
argument_list|,
name|meminfo
operator|.
name|total_malloced
argument_list|,
name|meminfo
operator|.
name|highwater
argument_list|,
operator|(
name|int
operator|)
name|meminfo
operator|.
name|malloced
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
operator|&&
operator|(
operator|!
name|Verbose
operator|)
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|meminfo
operator|.
name|mallocs
condition|;
name|i
operator|++
control|)
block|{
name|malloced
operator|.
name|seq
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_MALLOCINFO
argument_list|,
operator|&
name|malloced
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get information"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
operator|(
name|i
operator|&
literal|63
operator|)
condition|)
name|printf
argument_list|(
literal|"Block\tSequence\t  size\t  address\t  line\t\tfile\n\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%6d\t%6d\t\t%6d\t0x%08x\t%6d\t\t%s\n"
argument_list|,
name|i
argument_list|,
name|malloced
operator|.
name|seq
argument_list|,
name|malloced
operator|.
name|size
argument_list|,
operator|(
name|int
operator|)
name|malloced
operator|.
name|address
argument_list|,
name|malloced
operator|.
name|line
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|malloced
operator|.
name|file
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|VINUMDEBUG
if|if
condition|(
name|Verbose
condition|)
block|{
name|printf
argument_list|(
literal|"\nTime\t\t Event\t     Buf\tDev\t  Offset\tBytes\tSD\tSDoff\tDoffset\tGoffset\n\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|RQINFO_SIZE
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
comment|/* go through the request list in order */
operator|*
operator|(
operator|(
name|int
operator|*
operator|)
operator|&
name|rq
operator|)
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_RQINFO
argument_list|,
operator|&
name|rq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get information"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|rq
operator|.
name|type
condition|)
block|{
case|case
name|loginfo_unused
case|:
comment|/* never been used */
break|break;
case|case
name|loginfo_user_bp
case|:
comment|/* this is the bp when strategy is called */
case|case
name|loginfo_sdio
case|:
comment|/* subdisk I/O */
name|printf
argument_list|(
literal|"%s %dVS %s %p\t%d.%-6d 0x%-9x\t%ld\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|type
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_bcount
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_user_bpl
case|:
comment|/* and this is the bp at launch time */
case|case
name|loginfo_sdiol
case|:
comment|/* subdisk I/O launch */
name|printf
argument_list|(
literal|"%s %dLR %s %p\t%d.%-6d 0x%-9x\t%ld\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|type
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|b
operator|.
name|b_bcount
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_rqe
case|:
comment|/* user RQE */
name|printf
argument_list|(
literal|"%s 3RQ %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_iodone
case|:
comment|/* iodone called */
name|printf
argument_list|(
literal|"%s 4DN %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_raid5_data
case|:
comment|/* RAID-5 write data block */
name|printf
argument_list|(
literal|"%s 5RD %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_raid5_parity
case|:
comment|/* RAID-5 write parity block */
name|printf
argument_list|(
literal|"%s 6RP %s %p\t%d.%-6d 0x%-9x\t%ld\t%d\t%x\t%x\t%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_flags
operator|&
name|B_READ
condition|?
literal|"Read "
else|:
literal|"Write"
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|devmajor
argument_list|,
name|rq
operator|.
name|devminor
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_blkno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|b
operator|.
name|b_bcount
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|sdoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|dataoffset
argument_list|,
name|rq
operator|.
name|info
operator|.
name|rqe
operator|.
name|groupoffset
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_lockwait
case|:
name|printf
argument_list|(
literal|"%s Lockwait  %p\t%d\t  0x%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|plexno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|stripe
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_lock
case|:
name|printf
argument_list|(
literal|"%s Lock      %p\t%d\t  0x%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|plexno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|stripe
argument_list|)
expr_stmt|;
break|break;
case|case
name|loginfo_unlock
case|:
name|printf
argument_list|(
literal|"%s Unlock\t  %p\t%d\t  0x%x\n"
argument_list|,
name|timetext
argument_list|(
operator|&
name|rq
operator|.
name|timestamp
argument_list|)
argument_list|,
name|rq
operator|.
name|bp
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|plexno
argument_list|,
name|rq
operator|.
name|info
operator|.
name|lockinfo
operator|.
name|stripe
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * Print config file to a file.  This is a userland version  * of kernel format_config  */
end_comment

begin_function
name|void
name|vinum_printconfig
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|argv0
index|[]
parameter_list|)
block|{
name|FILE
modifier|*
name|of
decl_stmt|;
if|if
condition|(
name|argc
operator|>
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: \tprintconfig [<outfile>]\n"
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
name|of
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
else|else
name|of
operator|=
name|stdout
expr_stmt|;
if|if
condition|(
name|of
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open %s: %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|printconfig
argument_list|(
name|of
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
name|fclose
argument_list|(
name|of
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * The guts of printconfig.  This is called from  * vinum_printconfig and from vinum_create when  * called without an argument, in order to give  * the user something to edit.  */
end_comment

begin_function
name|void
name|printconfig
parameter_list|(
name|FILE
modifier|*
name|of
parameter_list|,
name|char
modifier|*
name|comment
parameter_list|)
block|{
name|struct
name|utsname
name|uname_s
decl_stmt|;
name|time_t
name|now
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|volume
name|vol
decl_stmt|;
name|struct
name|plex
name|plex
decl_stmt|;
name|struct
name|sd
name|sd
decl_stmt|;
name|struct
name|drive
name|drive
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
name|uname
argument_list|(
operator|&
name|uname_s
argument_list|)
expr_stmt|;
comment|/* get our system name */
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
comment|/* and the current time */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"# Vinum configuration of %s, saved at %s"
argument_list|,
name|uname_s
operator|.
name|nodename
argument_list|,
name|ctime
argument_list|(
operator|&
name|now
argument_list|)
argument_list|)
expr_stmt|;
comment|/* say who did it */
if|if
condition|(
name|comment
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
comment|/* abuse this for commented version */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"# Current configuration:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|drives_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|drive
operator|.
name|state
operator|!=
name|drive_unallocated
condition|)
block|{
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%sdrive %s device %s\n"
argument_list|,
name|comment
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|drive
operator|.
name|devicename
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|volumes_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|vol
operator|.
name|state
operator|!=
name|volume_unallocated
condition|)
block|{
if|if
condition|(
name|vol
operator|.
name|preferred_plex
operator|>=
literal|0
condition|)
comment|/* preferences, */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%svolume %s readpol prefer %s\n"
argument_list|,
name|comment
argument_list|,
name|vol
operator|.
name|name
argument_list|,
name|vinum_conf
operator|.
name|plex
index|[
name|vol
operator|.
name|preferred_plex
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
else|else
comment|/* default round-robin */
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%svolume %s\n"
argument_list|,
name|comment
argument_list|,
name|vol
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Then the plex configuration */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|plexes_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|plex
operator|.
name|state
operator|!=
name|plex_unallocated
condition|)
block|{
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%splex name %s org %s "
argument_list|,
name|comment
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|plex_org
argument_list|(
name|plex
operator|.
name|organization
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|plex
operator|.
name|organization
operator|==
name|plex_striped
operator|)
operator|||
operator|(
name|plex
operator|.
name|organization
operator|==
name|plex_raid5
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%ds "
argument_list|,
operator|(
name|int
operator|)
name|plex
operator|.
name|stripesize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|plex
operator|.
name|volno
operator|>=
literal|0
condition|)
block|{
comment|/* we have a volume */
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|plex
operator|.
name|volno
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"vol %s "
argument_list|,
name|vol
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"detached "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* And finally the subdisk configuration */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|i
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
condition|)
block|{
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|sd
operator|.
name|driveno
argument_list|)
expr_stmt|;
if|if
condition|(
name|sd
operator|.
name|plexno
operator|>=
literal|0
condition|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|sd
operator|.
name|plexno
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%ssd name %s drive %s plex %s len %qds driveoffset %qds plexoffset %qds\n"
argument_list|,
name|comment
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|plex
operator|.
name|name
argument_list|,
name|sd
operator|.
name|sectors
argument_list|,
name|sd
operator|.
name|driveoffset
argument_list|,
name|sd
operator|.
name|plexoffset
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|of
argument_list|,
literal|"%ssd name %s drive %s detached len %qds driveoffset %qds\n"
argument_list|,
name|comment
argument_list|,
name|sd
operator|.
name|name
argument_list|,
name|drive
operator|.
name|label
operator|.
name|name
argument_list|,
name|sd
operator|.
name|sectors
argument_list|,
name|sd
operator|.
name|driveoffset
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|list_defective_objects
parameter_list|()
block|{
name|int
name|o
decl_stmt|;
comment|/* object */
name|int
name|heading_needed
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|superdev
argument_list|,
name|VINUM_GETCONFIG
argument_list|,
operator|&
name|vinum_conf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"Can't get vinum config"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|drives_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_drive_info
argument_list|(
operator|&
name|drive
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|drive
operator|.
name|state
operator|!=
name|drive_unallocated
operator|)
comment|/* drive exists */
operator|&&
operator|(
name|drive
operator|.
name|state
operator|!=
name|drive_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_ldi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|volumes_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_volume_info
argument_list|(
operator|&
name|vol
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vol
operator|.
name|state
operator|!=
name|volume_unallocated
operator|)
comment|/* volume exists */
operator|&&
operator|(
name|vol
operator|.
name|state
operator|!=
name|volume_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_lvi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|plexes_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_plex_info
argument_list|(
operator|&
name|plex
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|plex
operator|.
name|state
operator|!=
name|plex_unallocated
operator|)
comment|/* plex exists */
operator|&&
operator|(
name|plex
operator|.
name|state
operator|!=
name|plex_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_lpi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
for|for
control|(
name|o
operator|=
literal|0
init|;
name|o
operator|<
name|vinum_conf
operator|.
name|subdisks_allocated
condition|;
name|o
operator|++
control|)
block|{
name|get_sd_info
argument_list|(
operator|&
name|sd
argument_list|,
name|o
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|.
name|state
operator|!=
name|sd_unallocated
operator|)
comment|/* sd exists */
operator|&&
operator|(
name|sd
operator|.
name|state
operator|!=
name|sd_up
operator|)
condition|)
block|{
comment|/* but it's not up */
if|if
condition|(
name|heading_needed
condition|)
block|{
name|printf
argument_list|(
literal|"Warning: defective objects\n\n"
argument_list|)
expr_stmt|;
name|heading_needed
operator|=
literal|0
expr_stmt|;
block|}
name|vinum_lsi
argument_list|(
name|o
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* print info */
block|}
block|}
block|}
end_function

end_unit


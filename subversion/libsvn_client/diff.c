begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * diff.c: comparing  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_hash.h>
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_diff.h"
end_include

begin_include
include|#
directive|include
file|"svn_mergeinfo.h"
end_include

begin_include
include|#
directive|include
file|"svn_client.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_io.h"
end_include

begin_include
include|#
directive|include
file|"svn_utf.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_config.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"svn_subst.h"
end_include

begin_include
include|#
directive|include
file|"client.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_diff_private.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_subr_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_escape
end_escape

begin_comment
comment|/* Utilities */
end_comment

begin_define
define|#
directive|define
name|MAKE_ERR_BAD_RELATIVE_PATH
parameter_list|(
name|path
parameter_list|,
name|relative_to_dir
parameter_list|)
define|\
value|svn_error_createf(SVN_ERR_BAD_RELATIVE_PATH, NULL, \                           _("Path '%s' must be an immediate child of " \                             "the directory '%s'"), path, relative_to_dir)
end_define

begin_comment
comment|/* Calculate the repository relative path of DIFF_RELPATH, using RA_SESSION  * and WC_CTX, and return the result in *REPOS_RELPATH.  * ORIG_TARGET is the related original target passed to the diff command,  * and may be used to derive leading path components missing from PATH.  * ANCHOR is the local path where the diff editor is anchored.  * Do all allocations in POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|make_repos_relpath
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|repos_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|orig_target
parameter_list|,
name|svn_ra_session_t
modifier|*
name|ra_session
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|local_abspath
decl_stmt|;
specifier|const
name|char
modifier|*
name|orig_repos_relpath
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|ra_session
operator|||
operator|(
name|anchor
operator|&&
operator|!
name|svn_path_is_url
argument_list|(
name|orig_target
argument_list|)
operator|)
condition|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* We're doing a WC-WC diff, so we can retrieve all information we        * need from the working copy. */
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|local_abspath
argument_list|,
name|svn_dirent_join
argument_list|(
name|anchor
argument_list|,
name|diff_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|svn_wc__node_get_repos_info
argument_list|(
name|NULL
argument_list|,
name|repos_relpath
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|wc_ctx
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ra_session
operator|||
operator|!
name|err
operator|||
operator|(
name|err
operator|&&
name|err
operator|->
name|apr_err
operator|!=
name|SVN_ERR_WC_PATH_NOT_FOUND
operator|)
condition|)
block|{
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
comment|/* The path represents a local working copy path, but does not          exist. Fall through to calculate an in-repository location          based on the ra session */
comment|/* ### Maybe we should use the nearest existing ancestor instead? */
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
block|{
specifier|const
name|char
modifier|*
name|url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
comment|/* Would be nice if the RA layer could just provide the parent        repos_relpath of the ra session */
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|ra_session
argument_list|,
operator|&
name|url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_repos_root2
argument_list|(
name|ra_session
argument_list|,
operator|&
name|repos_root_url
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|orig_repos_relpath
operator|=
name|svn_uri_skip_ancestor
argument_list|(
name|repos_root_url
argument_list|,
name|url
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|repos_relpath
operator|=
name|svn_relpath_join
argument_list|(
name|orig_repos_relpath
argument_list|,
name|diff_relpath
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Adjust *INDEX_PATH, *ORIG_PATH_1 and *ORIG_PATH_2, representing the changed  * node and the two original targets passed to the diff command, to handle the  * case when we're dealing with different anchors. RELATIVE_TO_DIR is the  * directory the diff target should be considered relative to.  * ANCHOR is the local path where the diff editor is anchored. The resulting  * values are allocated in RESULT_POOL and temporary allocations are performed  * in SCRATCH_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|adjust_paths_for_diff_labels
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|index_path
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|orig_path_1
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|orig_path_2
parameter_list|,
specifier|const
name|char
modifier|*
name|relative_to_dir
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|new_path
init|=
operator|*
name|index_path
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_path1
init|=
operator|*
name|orig_path_1
decl_stmt|;
specifier|const
name|char
modifier|*
name|new_path2
init|=
operator|*
name|orig_path_2
decl_stmt|;
if|if
condition|(
name|anchor
condition|)
name|new_path
operator|=
name|svn_dirent_join
argument_list|(
name|anchor
argument_list|,
name|new_path
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|relative_to_dir
condition|)
block|{
comment|/* Possibly adjust the paths shown in the output (see issue #2723). */
specifier|const
name|char
modifier|*
name|child_path
init|=
name|svn_dirent_is_child
argument_list|(
name|relative_to_dir
argument_list|,
name|new_path
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
if|if
condition|(
name|child_path
condition|)
name|new_path
operator|=
name|child_path
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|relative_to_dir
argument_list|,
name|new_path
argument_list|)
condition|)
name|new_path
operator|=
literal|"."
expr_stmt|;
else|else
return|return
name|MAKE_ERR_BAD_RELATIVE_PATH
argument_list|(
name|new_path
argument_list|,
name|relative_to_dir
argument_list|)
return|;
name|child_path
operator|=
name|svn_dirent_is_child
argument_list|(
name|relative_to_dir
argument_list|,
name|new_path1
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
block|{
name|apr_size_t
name|len
decl_stmt|;
name|svn_boolean_t
name|is_url1
decl_stmt|;
name|svn_boolean_t
name|is_url2
decl_stmt|;
comment|/* ### Holy cow.  Due to anchor/target weirdness, we can't        simply join diff_cmd_baton->orig_path_1 with path, ditto for        orig_path_2.  That will work when they're directory URLs, but        not for file URLs.  Nor can we just use anchor1 and anchor2        from do_diff(), at least not without some more logic here.        What a nightmare.         For now, to distinguish the two paths, we'll just put the        unique portions of the original targets in parentheses after        the received path, with ellipses for handwaving.  This makes        the labels a bit clumsy, but at least distinctive.  Better        solutions are possible, they'll just take more thought. */
comment|/* ### BH: We can now just construct the repos_relpath, etc. as the            anchor is available. See also make_repos_relpath() */
name|is_url1
operator|=
name|svn_path_is_url
argument_list|(
name|new_path1
argument_list|)
expr_stmt|;
name|is_url2
operator|=
name|svn_path_is_url
argument_list|(
name|new_path2
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_url1
operator|&&
name|is_url2
condition|)
name|len
operator|=
name|strlen
argument_list|(
name|svn_uri_get_longest_ancestor
argument_list|(
name|new_path1
argument_list|,
name|new_path2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|is_url1
operator|&&
operator|!
name|is_url2
condition|)
name|len
operator|=
name|strlen
argument_list|(
name|svn_dirent_get_longest_ancestor
argument_list|(
name|new_path1
argument_list|,
name|new_path2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
literal|0
expr_stmt|;
comment|/* Path and URL */
name|new_path1
operator|+=
name|len
expr_stmt|;
name|new_path2
operator|+=
name|len
expr_stmt|;
block|}
comment|/* ### Should diff labels print paths in local style?  Is there      already a standard for this?  In any case, this code depends on      a particular style, so not calling svn_dirent_local_style() on the      paths below.*/
if|if
condition|(
name|new_path
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|new_path
operator|=
literal|"."
expr_stmt|;
if|if
condition|(
name|new_path1
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|new_path1
operator|=
name|new_path
expr_stmt|;
elseif|else
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|new_path1
argument_list|)
condition|)
name|new_path1
operator|=
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%s\t(%s)"
argument_list|,
name|new_path
argument_list|,
name|new_path1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|new_path1
index|[
literal|0
index|]
operator|==
literal|'/'
condition|)
name|new_path1
operator|=
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%s\t(...%s)"
argument_list|,
name|new_path
argument_list|,
name|new_path1
argument_list|)
expr_stmt|;
else|else
name|new_path1
operator|=
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%s\t(.../%s)"
argument_list|,
name|new_path
argument_list|,
name|new_path1
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_path2
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|new_path2
operator|=
name|new_path
expr_stmt|;
elseif|else
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|new_path2
argument_list|)
condition|)
name|new_path1
operator|=
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%s\t(%s)"
argument_list|,
name|new_path
argument_list|,
name|new_path2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|new_path2
index|[
literal|0
index|]
operator|==
literal|'/'
condition|)
name|new_path2
operator|=
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%s\t(...%s)"
argument_list|,
name|new_path
argument_list|,
name|new_path2
argument_list|)
expr_stmt|;
else|else
name|new_path2
operator|=
name|apr_psprintf
argument_list|(
name|result_pool
argument_list|,
literal|"%s\t(.../%s)"
argument_list|,
name|new_path
argument_list|,
name|new_path2
argument_list|)
expr_stmt|;
operator|*
name|index_path
operator|=
name|new_path
expr_stmt|;
operator|*
name|orig_path_1
operator|=
name|new_path1
expr_stmt|;
operator|*
name|orig_path_2
operator|=
name|new_path2
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Generate a label for the diff output for file PATH at revision REVNUM.    If REVNUM is invalid then it is assumed to be the current working    copy.  Assumes the paths are already in the desired style (local    vs internal).  Allocate the label in POOL. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|diff_label
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|svn_revnum_t
name|revnum
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|label
decl_stmt|;
if|if
condition|(
name|revnum
operator|!=
name|SVN_INVALID_REVNUM
condition|)
name|label
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"%s\t(revision %ld)"
argument_list|)
argument_list|,
name|path
argument_list|,
name|revnum
argument_list|)
expr_stmt|;
else|else
name|label
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"%s\t(working copy)"
argument_list|)
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return
name|label
return|;
block|}
end_function

begin_comment
comment|/* Print a git diff header for an addition within a diff between PATH1 and  * PATH2 to the stream OS using HEADER_ENCODING.  * All allocations are done in RESULT_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_git_diff_header_added
parameter_list|(
name|svn_stream_t
modifier|*
name|os
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"diff --git a/%s b/%s%s"
argument_list|,
name|path1
argument_list|,
name|path2
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"new file mode 10644"
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Print a git diff header for a deletion within a diff between PATH1 and  * PATH2 to the stream OS using HEADER_ENCODING.  * All allocations are done in RESULT_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_git_diff_header_deleted
parameter_list|(
name|svn_stream_t
modifier|*
name|os
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"diff --git a/%s b/%s%s"
argument_list|,
name|path1
argument_list|,
name|path2
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"deleted file mode 10644"
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Print a git diff header for a copy from COPYFROM_PATH to PATH to the stream  * OS using HEADER_ENCODING. All allocations are done in RESULT_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_git_diff_header_copied
parameter_list|(
name|svn_stream_t
modifier|*
name|os
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_rev
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"diff --git a/%s b/%s%s"
argument_list|,
name|copyfrom_path
argument_list|,
name|path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copyfrom_rev
operator|!=
name|SVN_INVALID_REVNUM
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"copy from %s@%ld%s"
argument_list|,
name|copyfrom_path
argument_list|,
name|copyfrom_rev
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"copy from %s%s"
argument_list|,
name|copyfrom_path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"copy to %s%s"
argument_list|,
name|path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Print a git diff header for a rename from COPYFROM_PATH to PATH to the  * stream OS using HEADER_ENCODING. All allocations are done in RESULT_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_git_diff_header_renamed
parameter_list|(
name|svn_stream_t
modifier|*
name|os
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"diff --git a/%s b/%s%s"
argument_list|,
name|copyfrom_path
argument_list|,
name|path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"rename from %s%s"
argument_list|,
name|copyfrom_path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"rename to %s%s"
argument_list|,
name|path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Print a git diff header for a modification within a diff between PATH1 and  * PATH2 to the stream OS using HEADER_ENCODING.  * All allocations are done in RESULT_POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_git_diff_header_modified
parameter_list|(
name|svn_stream_t
modifier|*
name|os
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|result_pool
argument_list|,
literal|"diff --git a/%s b/%s%s"
argument_list|,
name|path1
argument_list|,
name|path2
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Print a git diff header showing the OPERATION to the stream OS using  * HEADER_ENCODING. Return suitable diff labels for the git diff in *LABEL1  * and *LABEL2. REPOS_RELPATH1 and REPOS_RELPATH2 are relative to reposroot.  * are the paths passed to the original diff command. REV1 and REV2 are  * revisions being diffed. COPYFROM_PATH and COPYFROM_REV indicate where the  * diffed item was copied from.  * Use SCRATCH_POOL for temporary allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|print_git_diff_header
parameter_list|(
name|svn_stream_t
modifier|*
name|os
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|label1
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|label2
parameter_list|,
name|svn_diff_operation_kind_t
name|operation
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath1
parameter_list|,
specifier|const
name|char
modifier|*
name|repos_relpath2
parameter_list|,
name|svn_revnum_t
name|rev1
parameter_list|,
name|svn_revnum_t
name|rev2
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_rev
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
if|if
condition|(
name|operation
operator|==
name|svn_diff_op_deleted
condition|)
block|{
name|SVN_ERR
argument_list|(
name|print_git_diff_header_deleted
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|repos_relpath1
argument_list|,
name|repos_relpath2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|label1
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"a/%s"
argument_list|,
name|repos_relpath1
argument_list|)
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|label2
operator|=
name|diff_label
argument_list|(
literal|"/dev/null"
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|operation
operator|==
name|svn_diff_op_copied
condition|)
block|{
name|SVN_ERR
argument_list|(
name|print_git_diff_header_copied
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|copyfrom_path
argument_list|,
name|copyfrom_rev
argument_list|,
name|repos_relpath2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|label1
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"a/%s"
argument_list|,
name|copyfrom_path
argument_list|)
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|label2
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"b/%s"
argument_list|,
name|repos_relpath2
argument_list|)
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|operation
operator|==
name|svn_diff_op_added
condition|)
block|{
name|SVN_ERR
argument_list|(
name|print_git_diff_header_added
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|repos_relpath1
argument_list|,
name|repos_relpath2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|label1
operator|=
name|diff_label
argument_list|(
literal|"/dev/null"
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|label2
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"b/%s"
argument_list|,
name|repos_relpath2
argument_list|)
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|operation
operator|==
name|svn_diff_op_modified
condition|)
block|{
name|SVN_ERR
argument_list|(
name|print_git_diff_header_modified
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|repos_relpath1
argument_list|,
name|repos_relpath2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|label1
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"a/%s"
argument_list|,
name|repos_relpath1
argument_list|)
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|label2
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"b/%s"
argument_list|,
name|repos_relpath2
argument_list|)
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|operation
operator|==
name|svn_diff_op_moved
condition|)
block|{
name|SVN_ERR
argument_list|(
name|print_git_diff_header_renamed
argument_list|(
name|os
argument_list|,
name|header_encoding
argument_list|,
name|copyfrom_path
argument_list|,
name|repos_relpath2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|label1
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"a/%s"
argument_list|,
name|copyfrom_path
argument_list|)
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
operator|*
name|label2
operator|=
name|diff_label
argument_list|(
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"b/%s"
argument_list|,
name|repos_relpath2
argument_list|)
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* A helper func that writes out verbal descriptions of property diffs    to OUTSTREAM.   Of course, OUTSTREAM will probably be whatever was    passed to svn_client_diff6(), which is probably stdout.     ### FIXME needs proper docstring     If USE_GIT_DIFF_FORMAT is TRUE, pring git diff headers, which always    show paths relative to the repository root. RA_SESSION and WC_CTX are    needed to normalize paths relative the repository root, and are ignored    if USE_GIT_DIFF_FORMAT is FALSE.     ANCHOR is the local path where the diff editor is anchored. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|display_prop_diffs
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|propchanges
parameter_list|,
name|apr_hash_t
modifier|*
name|original_props
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|anchor
parameter_list|,
specifier|const
name|char
modifier|*
name|orig_path1
parameter_list|,
specifier|const
name|char
modifier|*
name|orig_path2
parameter_list|,
name|svn_revnum_t
name|rev1
parameter_list|,
name|svn_revnum_t
name|rev2
parameter_list|,
specifier|const
name|char
modifier|*
name|encoding
parameter_list|,
name|svn_stream_t
modifier|*
name|outstream
parameter_list|,
specifier|const
name|char
modifier|*
name|relative_to_dir
parameter_list|,
name|svn_boolean_t
name|show_diff_header
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
name|svn_ra_session_t
modifier|*
name|ra_session
parameter_list|,
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|repos_relpath1
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath2
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|index_path
init|=
name|diff_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|adjusted_path1
init|=
name|orig_path1
decl_stmt|;
specifier|const
name|char
modifier|*
name|adjusted_path2
init|=
name|orig_path2
decl_stmt|;
if|if
condition|(
name|use_git_diff_format
condition|)
block|{
name|SVN_ERR
argument_list|(
name|make_repos_relpath
argument_list|(
operator|&
name|repos_relpath1
argument_list|,
name|diff_relpath
argument_list|,
name|orig_path1
argument_list|,
name|ra_session
argument_list|,
name|wc_ctx
argument_list|,
name|anchor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|make_repos_relpath
argument_list|(
operator|&
name|repos_relpath2
argument_list|,
name|diff_relpath
argument_list|,
name|orig_path2
argument_list|,
name|ra_session
argument_list|,
name|wc_ctx
argument_list|,
name|anchor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* If we're creating a diff on the wc root, path would be empty. */
name|SVN_ERR
argument_list|(
name|adjust_paths_for_diff_labels
argument_list|(
operator|&
name|index_path
argument_list|,
operator|&
name|adjusted_path1
argument_list|,
operator|&
name|adjusted_path2
argument_list|,
name|relative_to_dir
argument_list|,
name|anchor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_diff_header
condition|)
block|{
specifier|const
name|char
modifier|*
name|label1
decl_stmt|;
specifier|const
name|char
modifier|*
name|label2
decl_stmt|;
name|label1
operator|=
name|diff_label
argument_list|(
name|adjusted_path1
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|label2
operator|=
name|diff_label
argument_list|(
name|adjusted_path2
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* ### Should we show the paths in platform specific format,        * ### diff_content_changed() does not! */
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|outstream
argument_list|,
argument|encoding
argument_list|,
argument|scratch_pool
argument_list|,
literal|"Index: %s"
argument|APR_EOL_STR                                           SVN_DIFF__EQUAL_STRING APR_EOL_STR
argument_list|,
argument|index_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_git_diff_format
condition|)
name|SVN_ERR
argument_list|(
name|print_git_diff_header
argument_list|(
name|outstream
argument_list|,
operator|&
name|label1
argument_list|,
operator|&
name|label2
argument_list|,
name|svn_diff_op_modified
argument_list|,
name|repos_relpath1
argument_list|,
name|repos_relpath2
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|NULL
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|encoding
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* --- label1        * +++ label2 */
name|SVN_ERR
argument_list|(
name|svn_diff__unidiff_write_header
argument_list|(
name|outstream
argument_list|,
name|encoding
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|outstream
argument_list|,
name|encoding
argument_list|,
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"%sProperty changes on: %s%s"
argument_list|)
argument_list|,
name|APR_EOL_STR
argument_list|,
name|use_git_diff_format
condition|?
name|repos_relpath1
else|:
name|index_path
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|outstream
argument_list|,
argument|encoding
argument_list|,
argument|scratch_pool
argument_list|,
argument|SVN_DIFF__UNDER_STRING APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_diff__display_prop_diffs
argument_list|(
name|outstream
argument_list|,
name|encoding
argument_list|,
name|propchanges
argument_list|,
name|original_props
argument_list|,
name|TRUE
comment|/* pretty_print_mergeinfo */
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/*-----------------------------------------------------------------*/
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Callbacks for 'svn diff', invoked by the repos-diff editor. ***/
end_comment

begin_struct
struct|struct
name|diff_cmd_baton
block|{
comment|/* If non-null, the external diff command to invoke. */
specifier|const
name|char
modifier|*
name|diff_cmd
decl_stmt|;
comment|/* This is allocated in this struct's pool or a higher-up pool. */
union|union
block|{
comment|/* If 'diff_cmd' is null, then this is the parsed options to        pass to the internal libsvn_diff implementation. */
name|svn_diff_file_options_t
modifier|*
name|for_internal
decl_stmt|;
comment|/* Else if 'diff_cmd' is non-null, then... */
struct|struct
block|{
comment|/* ...this is an argument array for the external command, and */
specifier|const
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
comment|/* ...this is the length of argv. */
name|int
name|argc
decl_stmt|;
block|}
name|for_external
struct|;
block|}
name|options
union|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
name|svn_stream_t
modifier|*
name|outstream
decl_stmt|;
name|svn_stream_t
modifier|*
name|errstream
decl_stmt|;
specifier|const
name|char
modifier|*
name|header_encoding
decl_stmt|;
comment|/* The original targets passed to the diff command.  We may need      these to construct distinctive diff labels when comparing the      same relative path in the same revision, under different anchors      (for example, when comparing a trunk against a branch). */
specifier|const
name|char
modifier|*
name|orig_path_1
decl_stmt|;
specifier|const
name|char
modifier|*
name|orig_path_2
decl_stmt|;
comment|/* These are the numeric representations of the revisions passed to      svn_client_diff6(), either may be SVN_INVALID_REVNUM.  We need these      because some of the svn_wc_diff_callbacks4_t don't get revision      arguments.       ### Perhaps we should change the callback signatures and eliminate      ### these?   */
name|svn_revnum_t
name|revnum1
decl_stmt|;
name|svn_revnum_t
name|revnum2
decl_stmt|;
comment|/* Set this if you want diff output even for binary files. */
name|svn_boolean_t
name|force_binary
decl_stmt|;
comment|/* The directory that diff target paths should be considered as      relative to for output generation (see issue #2723). */
specifier|const
name|char
modifier|*
name|relative_to_dir
decl_stmt|;
comment|/* Whether property differences are ignored. */
name|svn_boolean_t
name|ignore_properties
decl_stmt|;
comment|/* Whether to show only property changes. */
name|svn_boolean_t
name|properties_only
decl_stmt|;
comment|/* Whether we're producing a git-style diff. */
name|svn_boolean_t
name|use_git_diff_format
decl_stmt|;
comment|/* Whether addition of a file is summarized versus showing a full diff. */
name|svn_boolean_t
name|no_diff_added
decl_stmt|;
comment|/* Whether deletion of a file is summarized versus showing a full diff. */
name|svn_boolean_t
name|no_diff_deleted
decl_stmt|;
comment|/* Whether to ignore copyfrom information when showing adds */
name|svn_boolean_t
name|no_copyfrom_on_add
decl_stmt|;
comment|/* Empty files for creating diffs or NULL if not used yet */
specifier|const
name|char
modifier|*
name|empty_file
decl_stmt|;
name|svn_wc_context_t
modifier|*
name|wc_ctx
decl_stmt|;
comment|/* The RA session used during diffs involving the repository. */
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
comment|/* The anchor to prefix before wc paths */
specifier|const
name|char
modifier|*
name|anchor
decl_stmt|;
comment|/* Whether the local diff target of a repos->wc diff is a copy. */
name|svn_boolean_t
name|repos_wc_diff_target_is_copy
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* An helper for diff_dir_props_changed, diff_file_changed and diff_file_added  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_props_changed
parameter_list|(
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|svn_revnum_t
name|rev1
parameter_list|,
name|svn_revnum_t
name|rev2
parameter_list|,
name|svn_boolean_t
name|dir_was_added
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|propchanges
parameter_list|,
name|apr_hash_t
modifier|*
name|original_props
parameter_list|,
name|svn_boolean_t
name|show_diff_header
parameter_list|,
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_array_header_t
modifier|*
name|props
decl_stmt|;
comment|/* If property differences are ignored, there's nothing to do. */
if|if
condition|(
name|diff_cmd_baton
operator|->
name|ignore_properties
condition|)
return|return
name|SVN_NO_ERROR
return|;
name|SVN_ERR
argument_list|(
name|svn_categorize_props
argument_list|(
name|propchanges
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|props
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|->
name|nelts
operator|>
literal|0
condition|)
block|{
comment|/* We're using the revnums from the diff_cmd_baton since there's        * no revision argument to the svn_wc_diff_callback_t        * dir_props_changed(). */
name|SVN_ERR
argument_list|(
name|display_prop_diffs
argument_list|(
name|props
argument_list|,
name|original_props
argument_list|,
name|diff_relpath
argument_list|,
name|diff_cmd_baton
operator|->
name|anchor
argument_list|,
name|diff_cmd_baton
operator|->
name|orig_path_1
argument_list|,
name|diff_cmd_baton
operator|->
name|orig_path_2
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|diff_cmd_baton
operator|->
name|outstream
argument_list|,
name|diff_cmd_baton
operator|->
name|relative_to_dir
argument_list|,
name|show_diff_header
argument_list|,
name|diff_cmd_baton
operator|->
name|use_git_diff_format
argument_list|,
name|diff_cmd_baton
operator|->
name|ra_session
argument_list|,
name|diff_cmd_baton
operator|->
name|wc_ctx
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_dir_props_changed
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|state
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|svn_boolean_t
name|dir_was_added
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|propchanges
parameter_list|,
name|apr_hash_t
modifier|*
name|original_props
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
init|=
name|diff_baton
decl_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|diff_props_changed
argument_list|(
name|diff_relpath
argument_list|,
comment|/* ### These revs be filled                                              * ### with per node info */
name|dir_was_added
condition|?
literal|0
comment|/* Magic legacy value */
else|:
name|diff_cmd_baton
operator|->
name|revnum1
argument_list|,
name|diff_cmd_baton
operator|->
name|revnum2
argument_list|,
name|dir_was_added
argument_list|,
name|propchanges
argument_list|,
name|original_props
argument_list|,
name|TRUE
comment|/* show_diff_header */
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Show differences between TMPFILE1 and TMPFILE2. DIFF_RELPATH, REV1, and    REV2 are used in the headers to indicate the file and revisions.  If either    MIMETYPE1 or MIMETYPE2 indicate binary content, don't show a diff,    but instead print a warning message.     If FORCE_DIFF is TRUE, always write a diff, even for empty diffs.     Set *WROTE_HEADER to TRUE if a diff header was written */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_content_changed
parameter_list|(
name|svn_boolean_t
modifier|*
name|wrote_header
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile1
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile2
parameter_list|,
name|svn_revnum_t
name|rev1
parameter_list|,
name|svn_revnum_t
name|rev2
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype1
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype2
parameter_list|,
name|svn_diff_operation_kind_t
name|operation
parameter_list|,
name|svn_boolean_t
name|force_diff
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_rev
parameter_list|,
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|exitcode
decl_stmt|;
specifier|const
name|char
modifier|*
name|rel_to_dir
init|=
name|diff_cmd_baton
operator|->
name|relative_to_dir
decl_stmt|;
name|svn_stream_t
modifier|*
name|errstream
init|=
name|diff_cmd_baton
operator|->
name|errstream
decl_stmt|;
name|svn_stream_t
modifier|*
name|outstream
init|=
name|diff_cmd_baton
operator|->
name|outstream
decl_stmt|;
specifier|const
name|char
modifier|*
name|label1
decl_stmt|,
modifier|*
name|label2
decl_stmt|;
name|svn_boolean_t
name|mt1_binary
init|=
name|FALSE
decl_stmt|,
name|mt2_binary
init|=
name|FALSE
decl_stmt|;
specifier|const
name|char
modifier|*
name|index_path
init|=
name|diff_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|path1
init|=
name|diff_cmd_baton
operator|->
name|orig_path_1
decl_stmt|;
specifier|const
name|char
modifier|*
name|path2
init|=
name|diff_cmd_baton
operator|->
name|orig_path_2
decl_stmt|;
comment|/* If only property differences are shown, there's nothing to do. */
if|if
condition|(
name|diff_cmd_baton
operator|->
name|properties_only
condition|)
return|return
name|SVN_NO_ERROR
return|;
comment|/* Generate the diff headers. */
name|SVN_ERR
argument_list|(
name|adjust_paths_for_diff_labels
argument_list|(
operator|&
name|index_path
argument_list|,
operator|&
name|path1
argument_list|,
operator|&
name|path2
argument_list|,
name|rel_to_dir
argument_list|,
name|diff_cmd_baton
operator|->
name|anchor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|label1
operator|=
name|diff_label
argument_list|(
name|path1
argument_list|,
name|rev1
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|label2
operator|=
name|diff_label
argument_list|(
name|path2
argument_list|,
name|rev2
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
comment|/* Possible easy-out: if either mime-type is binary and force was not      specified, don't attempt to generate a viewable diff at all.      Print a warning and exit. */
if|if
condition|(
name|mimetype1
condition|)
name|mt1_binary
operator|=
name|svn_mime_type_is_binary
argument_list|(
name|mimetype1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mimetype2
condition|)
name|mt2_binary
operator|=
name|svn_mime_type_is_binary
argument_list|(
name|mimetype2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|diff_cmd_baton
operator|->
name|force_binary
operator|&&
operator|(
name|mt1_binary
operator|||
name|mt2_binary
operator|)
condition|)
block|{
comment|/* Print out the diff header. */
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|outstream
argument_list|,
argument|diff_cmd_baton->header_encoding
argument_list|,
argument|scratch_pool
argument_list|,
literal|"Index: %s"
argument|APR_EOL_STR                SVN_DIFF__EQUAL_STRING APR_EOL_STR
argument_list|,
argument|index_path
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Print git diff headers. */
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|outstream
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|scratch_pool
argument_list|,
name|_
argument_list|(
literal|"Cannot display: file marked as a binary type.%s"
argument_list|)
argument_list|,
name|APR_EOL_STR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mt1_binary
operator|&&
operator|!
name|mt2_binary
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|outstream
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|scratch_pool
argument_list|,
literal|"svn:mime-type = %s"
name|APR_EOL_STR
argument_list|,
name|mimetype1
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mt2_binary
operator|&&
operator|!
name|mt1_binary
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|outstream
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|scratch_pool
argument_list|,
literal|"svn:mime-type = %s"
name|APR_EOL_STR
argument_list|,
name|mimetype2
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|mt1_binary
operator|&&
name|mt2_binary
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|mimetype1
argument_list|,
name|mimetype2
argument_list|)
operator|==
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|outstream
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|scratch_pool
argument_list|,
literal|"svn:mime-type = %s"
name|APR_EOL_STR
argument_list|,
name|mimetype1
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
name|outstream
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|scratch_pool
argument_list|,
literal|"svn:mime-type = (%s, %s)"
name|APR_EOL_STR
argument_list|,
name|mimetype1
argument_list|,
name|mimetype2
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Exit early. */
return|return
name|SVN_NO_ERROR
return|;
block|}
if|if
condition|(
name|diff_cmd_baton
operator|->
name|diff_cmd
condition|)
block|{
name|apr_file_t
modifier|*
name|outfile
decl_stmt|;
name|apr_file_t
modifier|*
name|errfile
decl_stmt|;
specifier|const
name|char
modifier|*
name|outfilename
decl_stmt|;
specifier|const
name|char
modifier|*
name|errfilename
decl_stmt|;
name|svn_stream_t
modifier|*
name|stream
decl_stmt|;
comment|/* Print out the diff header. */
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|outstream
argument_list|,
argument|diff_cmd_baton->header_encoding
argument_list|,
argument|scratch_pool
argument_list|,
literal|"Index: %s"
argument|APR_EOL_STR                SVN_DIFF__EQUAL_STRING APR_EOL_STR
argument_list|,
argument|index_path
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### Do we want to add git diff headers here too? I'd say no. The        * ### 'Index' and '===' line is something subversion has added. The rest        * ### is up to the external diff application. We may be dealing with        * ### a non-git compatible diff application.*/
comment|/* We deal in streams, but svn_io_run_diff2() deals in file handles,          unfortunately, so we need to make these temporary files, and then          copy the contents to our stream. */
name|SVN_ERR
argument_list|(
name|svn_io_open_unique_file3
argument_list|(
operator|&
name|outfile
argument_list|,
operator|&
name|outfilename
argument_list|,
name|NULL
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_open_unique_file3
argument_list|(
operator|&
name|errfile
argument_list|,
operator|&
name|errfilename
argument_list|,
name|NULL
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_run_diff2
argument_list|(
literal|"."
argument_list|,
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_external
operator|.
name|argv
argument_list|,
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_external
operator|.
name|argc
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
operator|&
name|exitcode
argument_list|,
name|outfile
argument_list|,
name|errfile
argument_list|,
name|diff_cmd_baton
operator|->
name|diff_cmd
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|outfile
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_file_close
argument_list|(
name|errfile
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Now, open and copy our files to our output streams. */
name|SVN_ERR
argument_list|(
name|svn_stream_open_readonly
argument_list|(
operator|&
name|stream
argument_list|,
name|outfilename
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_copy3
argument_list|(
name|stream
argument_list|,
name|svn_stream_disown
argument_list|(
name|outstream
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_open_readonly
argument_list|(
operator|&
name|stream
argument_list|,
name|errfilename
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_copy3
argument_list|(
name|stream
argument_list|,
name|svn_stream_disown
argument_list|(
name|errstream
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We have a printed a diff for this path, mark it as visited. */
operator|*
name|wrote_header
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
comment|/* use libsvn_diff to generate the diff  */
block|{
name|svn_diff_t
modifier|*
name|diff
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_diff_file_diff_2
argument_list|(
operator|&
name|diff
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_internal
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|force_diff
operator|||
name|diff_cmd_baton
operator|->
name|use_git_diff_format
operator|||
name|svn_diff_contains_diffs
argument_list|(
name|diff
argument_list|)
condition|)
block|{
comment|/* Print out the diff header. */
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|outstream
argument_list|,
argument|diff_cmd_baton->header_encoding
argument_list|,
argument|scratch_pool
argument_list|,
literal|"Index: %s"
argument|APR_EOL_STR                    SVN_DIFF__EQUAL_STRING APR_EOL_STR
argument_list|,
argument|index_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_cmd_baton
operator|->
name|use_git_diff_format
condition|)
block|{
specifier|const
name|char
modifier|*
name|repos_relpath1
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_relpath2
decl_stmt|;
name|SVN_ERR
argument_list|(
name|make_repos_relpath
argument_list|(
operator|&
name|repos_relpath1
argument_list|,
name|diff_relpath
argument_list|,
name|diff_cmd_baton
operator|->
name|orig_path_1
argument_list|,
name|diff_cmd_baton
operator|->
name|ra_session
argument_list|,
name|diff_cmd_baton
operator|->
name|wc_ctx
argument_list|,
name|diff_cmd_baton
operator|->
name|anchor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|make_repos_relpath
argument_list|(
operator|&
name|repos_relpath2
argument_list|,
name|diff_relpath
argument_list|,
name|diff_cmd_baton
operator|->
name|orig_path_2
argument_list|,
name|diff_cmd_baton
operator|->
name|ra_session
argument_list|,
name|diff_cmd_baton
operator|->
name|wc_ctx
argument_list|,
name|diff_cmd_baton
operator|->
name|anchor
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|print_git_diff_header
argument_list|(
name|outstream
argument_list|,
operator|&
name|label1
argument_list|,
operator|&
name|label2
argument_list|,
name|operation
argument_list|,
name|repos_relpath1
argument_list|,
name|repos_relpath2
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|copyfrom_path
argument_list|,
name|copyfrom_rev
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Output the actual diff */
if|if
condition|(
name|force_diff
operator|||
name|svn_diff_contains_diffs
argument_list|(
name|diff
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_diff_file_output_unified3
argument_list|(
name|outstream
argument_list|,
name|diff
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
name|label1
argument_list|,
name|label2
argument_list|,
name|diff_cmd_baton
operator|->
name|header_encoding
argument_list|,
name|rel_to_dir
argument_list|,
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_internal
operator|->
name|show_c_function
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We have a printed a diff for this path, mark it as visited. */
operator|*
name|wrote_header
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
comment|/* ### todo: someday we'll need to worry about whether we're going      to need to write a diff plug-in mechanism that makes use of the      two paths, instead of just blindly running SVN_CLIENT_DIFF.  */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_file_opened
parameter_list|(
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_file_changed
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|content_state
parameter_list|,
name|svn_wc_notify_state_t
modifier|*
name|prop_state
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile1
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile2
parameter_list|,
name|svn_revnum_t
name|rev1
parameter_list|,
name|svn_revnum_t
name|rev2
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype1
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype2
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|prop_changes
parameter_list|,
name|apr_hash_t
modifier|*
name|original_props
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
init|=
name|diff_baton
decl_stmt|;
name|svn_boolean_t
name|wrote_header
init|=
name|FALSE
decl_stmt|;
comment|/* During repos->wc diff of a copy revision numbers obtained    * from the working copy are always SVN_INVALID_REVNUM. */
if|if
condition|(
name|diff_cmd_baton
operator|->
name|repos_wc_diff_target_is_copy
condition|)
block|{
if|if
condition|(
name|rev1
operator|==
name|SVN_INVALID_REVNUM
operator|&&
name|diff_cmd_baton
operator|->
name|revnum1
operator|!=
name|SVN_INVALID_REVNUM
condition|)
name|rev1
operator|=
name|diff_cmd_baton
operator|->
name|revnum1
expr_stmt|;
if|if
condition|(
name|rev2
operator|==
name|SVN_INVALID_REVNUM
operator|&&
name|diff_cmd_baton
operator|->
name|revnum2
operator|!=
name|SVN_INVALID_REVNUM
condition|)
name|rev2
operator|=
name|diff_cmd_baton
operator|->
name|revnum2
expr_stmt|;
block|}
if|if
condition|(
name|tmpfile1
condition|)
name|SVN_ERR
argument_list|(
name|diff_content_changed
argument_list|(
operator|&
name|wrote_header
argument_list|,
name|diff_relpath
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|mimetype1
argument_list|,
name|mimetype2
argument_list|,
name|svn_diff_op_modified
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_changes
operator|->
name|nelts
operator|>
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|diff_props_changed
argument_list|(
name|diff_relpath
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|FALSE
argument_list|,
name|prop_changes
argument_list|,
name|original_props
argument_list|,
operator|!
name|wrote_header
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Because the repos-diff editor passes at least one empty file to    each of these next two functions, they can be dumb wrappers around    the main workhorse routine. */
end_comment

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_file_added
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|content_state
parameter_list|,
name|svn_wc_notify_state_t
modifier|*
name|prop_state
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile1
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile2
parameter_list|,
name|svn_revnum_t
name|rev1
parameter_list|,
name|svn_revnum_t
name|rev2
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype1
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype2
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_revision
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|prop_changes
parameter_list|,
name|apr_hash_t
modifier|*
name|original_props
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
init|=
name|diff_baton
decl_stmt|;
name|svn_boolean_t
name|wrote_header
init|=
name|FALSE
decl_stmt|;
comment|/* During repos->wc diff of a copy revision numbers obtained    * from the working copy are always SVN_INVALID_REVNUM. */
if|if
condition|(
name|diff_cmd_baton
operator|->
name|repos_wc_diff_target_is_copy
condition|)
block|{
if|if
condition|(
name|rev1
operator|==
name|SVN_INVALID_REVNUM
operator|&&
name|diff_cmd_baton
operator|->
name|revnum1
operator|!=
name|SVN_INVALID_REVNUM
condition|)
name|rev1
operator|=
name|diff_cmd_baton
operator|->
name|revnum1
expr_stmt|;
if|if
condition|(
name|rev2
operator|==
name|SVN_INVALID_REVNUM
operator|&&
name|diff_cmd_baton
operator|->
name|revnum2
operator|!=
name|SVN_INVALID_REVNUM
condition|)
name|rev2
operator|=
name|diff_cmd_baton
operator|->
name|revnum2
expr_stmt|;
block|}
if|if
condition|(
name|diff_cmd_baton
operator|->
name|no_copyfrom_on_add
operator|&&
operator|(
name|copyfrom_path
operator|||
name|SVN_IS_VALID_REVNUM
argument_list|(
name|copyfrom_revision
argument_list|)
operator|)
condition|)
block|{
name|apr_hash_t
modifier|*
name|empty_hash
init|=
name|apr_hash_make
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
name|apr_array_header_t
modifier|*
name|new_changes
decl_stmt|;
comment|/* Rebase changes on having no left source. */
if|if
condition|(
operator|!
name|diff_cmd_baton
operator|->
name|empty_file
condition|)
name|SVN_ERR
argument_list|(
name|svn_io_open_unique_file3
argument_list|(
name|NULL
argument_list|,
operator|&
name|diff_cmd_baton
operator|->
name|empty_file
argument_list|,
name|NULL
argument_list|,
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|diff_cmd_baton
operator|->
name|pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_prop_diffs
argument_list|(
operator|&
name|new_changes
argument_list|,
name|svn_prop__patch
argument_list|(
name|original_props
argument_list|,
name|prop_changes
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|empty_hash
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|tmpfile1
operator|=
name|diff_cmd_baton
operator|->
name|empty_file
expr_stmt|;
name|prop_changes
operator|=
name|new_changes
expr_stmt|;
name|original_props
operator|=
name|empty_hash
expr_stmt|;
name|copyfrom_revision
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
block|}
if|if
condition|(
name|diff_cmd_baton
operator|->
name|no_diff_added
condition|)
block|{
specifier|const
name|char
modifier|*
name|index_path
init|=
name|diff_relpath
decl_stmt|;
if|if
condition|(
name|diff_cmd_baton
operator|->
name|anchor
condition|)
name|index_path
operator|=
name|svn_dirent_join
argument_list|(
name|diff_cmd_baton
operator|->
name|anchor
argument_list|,
name|diff_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|diff_cmd_baton->outstream
argument_list|,
argument|diff_cmd_baton->header_encoding
argument_list|,
argument|scratch_pool
argument_list|,
literal|"Index: %s (added)"
argument|APR_EOL_STR                 SVN_DIFF__EQUAL_STRING APR_EOL_STR
argument_list|,
argument|index_path
argument_list|)
argument_list|)
expr_stmt|;
name|wrote_header
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tmpfile1
operator|&&
name|copyfrom_path
condition|)
name|SVN_ERR
argument_list|(
name|diff_content_changed
argument_list|(
operator|&
name|wrote_header
argument_list|,
name|diff_relpath
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|mimetype1
argument_list|,
name|mimetype2
argument_list|,
name|svn_diff_op_copied
argument_list|,
name|TRUE
comment|/* force diff output */
argument_list|,
name|copyfrom_path
argument_list|,
name|copyfrom_revision
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tmpfile1
condition|)
name|SVN_ERR
argument_list|(
name|diff_content_changed
argument_list|(
operator|&
name|wrote_header
argument_list|,
name|diff_relpath
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|mimetype1
argument_list|,
name|mimetype2
argument_list|,
name|svn_diff_op_added
argument_list|,
name|TRUE
comment|/* force diff output */
argument_list|,
name|NULL
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prop_changes
operator|->
name|nelts
operator|>
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|diff_props_changed
argument_list|(
name|diff_relpath
argument_list|,
name|rev1
argument_list|,
name|rev2
argument_list|,
name|FALSE
argument_list|,
name|prop_changes
argument_list|,
name|original_props
argument_list|,
operator|!
name|wrote_header
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_file_deleted
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|state
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile1
parameter_list|,
specifier|const
name|char
modifier|*
name|tmpfile2
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype1
parameter_list|,
specifier|const
name|char
modifier|*
name|mimetype2
parameter_list|,
name|apr_hash_t
modifier|*
name|original_props
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
init|=
name|diff_baton
decl_stmt|;
if|if
condition|(
name|diff_cmd_baton
operator|->
name|no_diff_deleted
condition|)
block|{
specifier|const
name|char
modifier|*
name|index_path
init|=
name|diff_relpath
decl_stmt|;
if|if
condition|(
name|diff_cmd_baton
operator|->
name|anchor
condition|)
name|index_path
operator|=
name|svn_dirent_join
argument_list|(
name|diff_cmd_baton
operator|->
name|anchor
argument_list|,
name|diff_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_printf_from_utf8
argument_list|(
argument|diff_cmd_baton->outstream
argument_list|,
argument|diff_cmd_baton->header_encoding
argument_list|,
argument|scratch_pool
argument_list|,
literal|"Index: %s (deleted)"
argument|APR_EOL_STR                 SVN_DIFF__EQUAL_STRING APR_EOL_STR
argument_list|,
argument|index_path
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|svn_boolean_t
name|wrote_header
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|tmpfile1
condition|)
name|SVN_ERR
argument_list|(
name|diff_content_changed
argument_list|(
operator|&
name|wrote_header
argument_list|,
name|diff_relpath
argument_list|,
name|tmpfile1
argument_list|,
name|tmpfile2
argument_list|,
name|diff_cmd_baton
operator|->
name|revnum1
argument_list|,
name|diff_cmd_baton
operator|->
name|revnum2
argument_list|,
name|mimetype1
argument_list|,
name|mimetype2
argument_list|,
name|svn_diff_op_deleted
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|SVN_INVALID_REVNUM
argument_list|,
name|diff_cmd_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Should we also report the properties as deleted? */
block|}
comment|/* We don't list all the deleted properties. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_dir_added
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|state
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip_children
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
specifier|const
name|char
modifier|*
name|copyfrom_path
parameter_list|,
name|svn_revnum_t
name|copyfrom_revision
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/* Do nothing. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_dir_deleted
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|state
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/* Do nothing. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_dir_opened
parameter_list|(
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip
parameter_list|,
name|svn_boolean_t
modifier|*
name|skip_children
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|svn_revnum_t
name|rev
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/* Do nothing. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* An svn_wc_diff_callbacks4_t function. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_dir_closed
parameter_list|(
name|svn_wc_notify_state_t
modifier|*
name|contentstate
parameter_list|,
name|svn_wc_notify_state_t
modifier|*
name|propstate
parameter_list|,
name|svn_boolean_t
modifier|*
name|tree_conflicted
parameter_list|,
specifier|const
name|char
modifier|*
name|diff_relpath
parameter_list|,
name|svn_boolean_t
name|dir_was_added
parameter_list|,
name|void
modifier|*
name|diff_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
comment|/* Do nothing. */
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|svn_wc_diff_callbacks4_t
name|diff_callbacks
init|=
block|{
name|diff_file_opened
block|,
name|diff_file_changed
block|,
name|diff_file_added
block|,
name|diff_file_deleted
block|,
name|diff_dir_deleted
block|,
name|diff_dir_opened
block|,
name|diff_dir_added
block|,
name|diff_dir_props_changed
block|,
name|diff_dir_closed
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*-----------------------------------------------------------------*/
end_comment

begin_escape
end_escape

begin_comment
comment|/** The logic behind 'svn diff' and 'svn merge'.  */
end_comment

begin_comment
comment|/* Hi!  This is a comment left behind by Karl, and Ben is too afraid    to erase it at this time, because he's not fully confident that all    this knowledge has been grokked yet.     There are five cases:       1. path is not a URL and start_revision != end_revision       2. path is not a URL and start_revision == end_revision       3. path is a URL and start_revision != end_revision       4. path is a URL and start_revision == end_revision       5. path is not a URL and no revisions given     With only one distinct revision the working copy provides the    other.  When path is a URL there is no working copy. Thus       1: compare repository versions for URL coresponding to working copy      2: compare working copy against repository version      3: compare repository versions for URL      4: nothing to do.      5: compare working copy against text-base     Case 4 is not as stupid as it looks, for example it may occur if    the user specifies two dates that resolve to the same revision.  */
end_comment

begin_comment
comment|/** Check if paths PATH_OR_URL1 and PATH_OR_URL2 are urls and if the  * revisions REVISION1 and REVISION2 are local. If PEG_REVISION is not  * unspecified, ensure that at least one of the two revisions is not  * BASE or WORKING.  * If PATH_OR_URL1 can only be found in the repository, set *IS_REPOS1  * to TRUE. If PATH_OR_URL2 can only be found in the repository, set  * *IS_REPOS2 to TRUE. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|check_paths
parameter_list|(
name|svn_boolean_t
modifier|*
name|is_repos1
parameter_list|,
name|svn_boolean_t
modifier|*
name|is_repos2
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|)
block|{
name|svn_boolean_t
name|is_local_rev1
decl_stmt|,
name|is_local_rev2
decl_stmt|;
comment|/* Verify our revision arguments in light of the paths. */
if|if
condition|(
operator|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_unspecified
operator|)
operator|||
operator|(
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_unspecified
operator|)
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_CLIENT_BAD_REVISION
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Not all required revisions are specified"
argument_list|)
argument_list|)
return|;
comment|/* Revisions can be said to be local or remote.    * BASE and WORKING are local revisions.  */
name|is_local_rev1
operator|=
operator|(
operator|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_base
operator|)
operator|||
operator|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_working
operator|)
operator|)
expr_stmt|;
name|is_local_rev2
operator|=
operator|(
operator|(
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_base
operator|)
operator|||
operator|(
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_working
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|peg_revision
operator|->
name|kind
operator|!=
name|svn_opt_revision_unspecified
operator|&&
name|is_local_rev1
operator|&&
name|is_local_rev2
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_CLIENT_BAD_REVISION
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"At least one revision must be something other "
literal|"than BASE or WORKING when diffing a URL"
argument_list|)
argument_list|)
return|;
comment|/* Working copy paths with non-local revisions get turned into      URLs.  We don't do that here, though.  We simply record that it      needs to be done, which is information that helps us choose our      diff helper function.  */
operator|*
name|is_repos1
operator|=
operator|!
name|is_local_rev1
operator|||
name|svn_path_is_url
argument_list|(
name|path_or_url1
argument_list|)
expr_stmt|;
operator|*
name|is_repos2
operator|=
operator|!
name|is_local_rev2
operator|||
name|svn_path_is_url
argument_list|(
name|path_or_url2
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Raise an error if the diff target URL does not exist at REVISION.  * If REVISION does not equal OTHER_REVISION, mention both revisions in  * the error message. Use RA_SESSION to contact the repository.  * Use POOL for temporary allocations. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|check_diff_target_exists
parameter_list|(
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|svn_revnum_t
name|revision
parameter_list|,
name|svn_revnum_t
name|other_revision
parameter_list|,
name|svn_ra_session_t
modifier|*
name|ra_session
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_node_kind_t
name|kind
decl_stmt|;
specifier|const
name|char
modifier|*
name|session_url
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_session_url
argument_list|(
name|ra_session
argument_list|,
operator|&
name|session_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|url
argument_list|,
name|session_url
argument_list|)
operator|!=
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
name|ra_session
argument_list|,
name|url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|ra_session
argument_list|,
literal|""
argument_list|,
name|revision
argument_list|,
operator|&
name|kind
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_none
condition|)
block|{
if|if
condition|(
name|revision
operator|==
name|other_revision
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Diff target '%s' was not found in the "
literal|"repository at revision '%ld'"
argument_list|)
argument_list|,
name|url
argument_list|,
name|revision
argument_list|)
return|;
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Diff target '%s' was not found in the "
literal|"repository at revision '%ld' or '%ld'"
argument_list|)
argument_list|,
name|url
argument_list|,
name|revision
argument_list|,
name|other_revision
argument_list|)
return|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|url
argument_list|,
name|session_url
argument_list|)
operator|!=
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
name|ra_session
argument_list|,
name|session_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Return in *RESOLVED_URL the URL which PATH_OR_URL@PEG_REVISION has in  * REVISION. If the object has no location in REVISION, set *RESOLVED_URL  * to NULL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|resolve_pegged_diff_target_url
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|resolved_url
parameter_list|,
name|svn_ra_session_t
modifier|*
name|ra_session
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_error_t
modifier|*
name|err
decl_stmt|;
comment|/* Check if the PATH_OR_URL exists at REVISION. */
name|err
operator|=
name|svn_client__repos_locations
argument_list|(
name|resolved_url
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ra_session
argument_list|,
name|path_or_url
argument_list|,
name|peg_revision
argument_list|,
name|revision
argument_list|,
name|NULL
argument_list|,
name|ctx
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
if|if
condition|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_CLIENT_UNRELATED_RESOURCES
operator|||
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_FS_NOT_FOUND
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
operator|*
name|resolved_url
operator|=
name|NULL
expr_stmt|;
block|}
else|else
return|return
name|svn_error_trace
argument_list|(
name|err
argument_list|)
return|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/** Prepare a repos repos diff between PATH_OR_URL1 and  * PATH_OR_URL2@PEG_REVISION, in the revision range REVISION1:REVISION2.  * Return URLs and peg revisions in *URL1, *REV1 and in *URL2, *REV2.  * Return suitable anchors in *ANCHOR1 and *ANCHOR2, and targets in  * *TARGET1 and *TARGET2, based on *URL1 and *URL2.  * Indicate the corresponding node kinds in *KIND1 and *KIND2, and verify  * that at least one of the diff targets exists.  * Set *BASE_PATH corresponding to the URL opened in the new *RA_SESSION  * which is pointing at *ANCHOR1.  * Use client context CTX. Do all allocations in POOL. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_prepare_repos_repos
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|url1
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|url2
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|base_path
parameter_list|,
name|svn_revnum_t
modifier|*
name|rev1
parameter_list|,
name|svn_revnum_t
modifier|*
name|rev2
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|anchor1
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|anchor2
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target1
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|target2
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind1
parameter_list|,
name|svn_node_kind_t
modifier|*
name|kind2
parameter_list|,
name|svn_ra_session_t
modifier|*
modifier|*
name|ra_session
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|abspath_or_url2
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath_or_url1
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|wri_abspath
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|svn_path_is_url
argument_list|(
name|path_or_url2
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath_or_url2
argument_list|,
name|path_or_url2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_url
argument_list|(
name|url2
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath_or_url2
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|wri_abspath
operator|=
name|abspath_or_url2
expr_stmt|;
block|}
else|else
operator|*
name|url2
operator|=
name|abspath_or_url2
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|path_or_url2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_path_is_url
argument_list|(
name|path_or_url1
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath_or_url1
argument_list|,
name|path_or_url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_url
argument_list|(
name|url1
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath_or_url1
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|wri_abspath
operator|=
name|abspath_or_url1
expr_stmt|;
block|}
else|else
operator|*
name|url1
operator|=
name|abspath_or_url1
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|path_or_url1
argument_list|)
expr_stmt|;
comment|/* We need exactly one BASE_PATH, so we'll let the BASE_PATH      calculated for PATH_OR_URL2 override the one for PATH_OR_URL1      (since the diff will be "applied" to URL2 anyway). */
operator|*
name|base_path
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|url1
argument_list|,
name|path_or_url1
argument_list|)
operator|!=
literal|0
condition|)
operator|*
name|base_path
operator|=
name|path_or_url1
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|url2
argument_list|,
name|path_or_url2
argument_list|)
operator|!=
literal|0
condition|)
operator|*
name|base_path
operator|=
name|path_or_url2
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client_open_ra_session2
argument_list|(
name|ra_session
argument_list|,
operator|*
name|url2
argument_list|,
name|wri_abspath
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If we are performing a pegged diff, we need to find out what our      actual URLs will be. */
if|if
condition|(
name|peg_revision
operator|->
name|kind
operator|!=
name|svn_opt_revision_unspecified
condition|)
block|{
specifier|const
name|char
modifier|*
name|resolved_url1
decl_stmt|;
specifier|const
name|char
modifier|*
name|resolved_url2
decl_stmt|;
name|SVN_ERR
argument_list|(
name|resolve_pegged_diff_target_url
argument_list|(
operator|&
name|resolved_url2
argument_list|,
operator|*
name|ra_session
argument_list|,
name|path_or_url2
argument_list|,
name|peg_revision
argument_list|,
name|revision2
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
operator|*
name|ra_session
argument_list|,
operator|*
name|url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|resolve_pegged_diff_target_url
argument_list|(
operator|&
name|resolved_url1
argument_list|,
operator|*
name|ra_session
argument_list|,
name|path_or_url1
argument_list|,
name|peg_revision
argument_list|,
name|revision1
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Either or both URLs might have changed as a result of resolving        * the PATH_OR_URL@PEG_REVISION's history. If only one of the URLs        * could be resolved, use the same URL for URL1 and URL2, so we can        * show a diff that adds or removes the object (see issue #4153). */
if|if
condition|(
name|resolved_url2
condition|)
block|{
operator|*
name|url2
operator|=
name|resolved_url2
expr_stmt|;
if|if
condition|(
operator|!
name|resolved_url1
condition|)
operator|*
name|url1
operator|=
name|resolved_url2
expr_stmt|;
block|}
if|if
condition|(
name|resolved_url1
condition|)
block|{
operator|*
name|url1
operator|=
name|resolved_url1
expr_stmt|;
if|if
condition|(
operator|!
name|resolved_url2
condition|)
operator|*
name|url2
operator|=
name|resolved_url1
expr_stmt|;
block|}
comment|/* Reparent the session, since *URL2 might have changed as a result          the above call. */
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
operator|*
name|ra_session
argument_list|,
operator|*
name|url2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Resolve revision and get path kind for the second target. */
name|SVN_ERR
argument_list|(
name|svn_client__get_revision_number
argument_list|(
name|rev2
argument_list|,
name|NULL
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
operator|(
name|path_or_url2
operator|==
operator|*
name|url2
operator|)
condition|?
name|NULL
else|:
name|abspath_or_url2
argument_list|,
operator|*
name|ra_session
argument_list|,
name|revision2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
operator|*
name|ra_session
argument_list|,
literal|""
argument_list|,
operator|*
name|rev2
argument_list|,
name|kind2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Do the same for the first target. */
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
operator|*
name|ra_session
argument_list|,
operator|*
name|url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_revision_number
argument_list|(
name|rev1
argument_list|,
name|NULL
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
operator|(
name|strcmp
argument_list|(
name|path_or_url1
argument_list|,
operator|*
name|url1
argument_list|)
operator|==
literal|0
operator|)
condition|?
name|NULL
else|:
name|abspath_or_url1
argument_list|,
operator|*
name|ra_session
argument_list|,
name|revision1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
operator|*
name|ra_session
argument_list|,
literal|""
argument_list|,
operator|*
name|rev1
argument_list|,
name|kind1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Either both URLs must exist at their respective revisions,    * or one of them may be missing from one side of the diff. */
if|if
condition|(
operator|*
name|kind1
operator|==
name|svn_node_none
operator|&&
operator|*
name|kind2
operator|==
name|svn_node_none
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|url1
argument_list|,
operator|*
name|url2
argument_list|)
operator|==
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Diff target '%s' was not found in the "
literal|"repository at revisions '%ld' and '%ld'"
argument_list|)
argument_list|,
operator|*
name|url1
argument_list|,
operator|*
name|rev1
argument_list|,
operator|*
name|rev2
argument_list|)
return|;
else|else
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_NOT_FOUND
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Diff targets '%s' and '%s' were not found "
literal|"in the repository at revisions '%ld' and "
literal|"'%ld'"
argument_list|)
argument_list|,
operator|*
name|url1
argument_list|,
operator|*
name|url2
argument_list|,
operator|*
name|rev1
argument_list|,
operator|*
name|rev2
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|*
name|kind1
operator|==
name|svn_node_none
condition|)
name|SVN_ERR
argument_list|(
name|check_diff_target_exists
argument_list|(
operator|*
name|url1
argument_list|,
operator|*
name|rev2
argument_list|,
operator|*
name|rev1
argument_list|,
operator|*
name|ra_session
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|kind2
operator|==
name|svn_node_none
condition|)
name|SVN_ERR
argument_list|(
name|check_diff_target_exists
argument_list|(
operator|*
name|url2
argument_list|,
operator|*
name|rev1
argument_list|,
operator|*
name|rev2
argument_list|,
operator|*
name|ra_session
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_get_repos_root2
argument_list|(
operator|*
name|ra_session
argument_list|,
operator|&
name|repos_root_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Choose useful anchors and targets for our two URLs. */
operator|*
name|anchor1
operator|=
operator|*
name|url1
expr_stmt|;
operator|*
name|anchor2
operator|=
operator|*
name|url2
expr_stmt|;
operator|*
name|target1
operator|=
literal|""
expr_stmt|;
operator|*
name|target2
operator|=
literal|""
expr_stmt|;
comment|/* If none of the targets is the repository root open the parent directory      to allow describing replacement of the target itself */
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|url1
argument_list|,
name|repos_root_url
argument_list|)
operator|!=
literal|0
operator|&&
name|strcmp
argument_list|(
operator|*
name|url2
argument_list|,
name|repos_root_url
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|svn_uri_split
argument_list|(
name|anchor1
argument_list|,
name|target1
argument_list|,
operator|*
name|url1
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_uri_split
argument_list|(
name|anchor2
argument_list|,
name|target2
argument_list|,
operator|*
name|url2
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|base_path
operator|&&
operator|(
operator|*
name|kind1
operator|==
name|svn_node_file
operator|||
operator|*
name|kind2
operator|==
name|svn_node_file
operator|)
condition|)
operator|*
name|base_path
operator|=
name|svn_dirent_dirname
argument_list|(
operator|*
name|base_path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
operator|*
name|ra_session
argument_list|,
operator|*
name|anchor1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* A Theoretical Note From Ben, regarding do_diff().     This function is really svn_client_diff6().  If you read the public    API description for svn_client_diff6(), it sounds quite Grand.  It    sounds really generalized and abstract and beautiful: that it will    diff any two paths, be they working-copy paths or URLs, at any two    revisions.     Now, the *reality* is that we have exactly three 'tools' for doing    diffing, and thus this routine is built around the use of the three    tools.  Here they are, for clarity:       - svn_wc_diff:  assumes both paths are the same wcpath.                      compares wcpath@BASE vs. wcpath@WORKING       - svn_wc_get_diff_editor:  compares some URL@REV vs. wcpath@WORKING       - svn_client__get_diff_editor:  compares some URL1@REV1 vs. URL2@REV2     Since Subversion 1.8 we also have a variant of svn_wc_diff called    svn_client__arbitrary_nodes_diff, that allows handling WORKING-WORKING    comparisions between nodes in the working copy.     So the truth of the matter is, if the caller's arguments can't be    pigeonholed into one of these use-cases, we currently bail with a    friendly apology.     Perhaps someday a brave soul will truly make svn_client_diff6()    perfectly general.  For now, we live with the 90% case.  Certainly,    the commandline client only calls this function in legal ways.    When there are other users of svn_client.h, maybe this will become    a more pressing issue.  */
end_comment

begin_comment
comment|/* Return a "you can't do that" error, optionally wrapping another    error CHILD_ERR. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|unsupported_diff_error
parameter_list|(
name|svn_error_t
modifier|*
name|child_err
parameter_list|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|child_err
argument_list|,
name|_
argument_list|(
literal|"Sorry, svn_client_diff6 was called in a way "
literal|"that is not yet supported"
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Perform a diff between two working-copy paths.     PATH1 and PATH2 are both working copy paths.  REVISION1 and    REVISION2 are their respective revisions.     All other options are the same as those passed to svn_client_diff6(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_wc_wc
parameter_list|(
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|struct
name|diff_cmd_baton
modifier|*
name|callback_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|abspath1
decl_stmt|;
name|svn_error_t
modifier|*
name|err
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_path_is_url
argument_list|(
name|path1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_path_is_url
argument_list|(
name|path2
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath1
argument_list|,
name|path1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Currently we support only the case where path1 and path2 are the      same path. */
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|path1
argument_list|,
name|path2
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|!
operator|(
operator|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_base
operator|)
operator|&&
operator|(
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_working
operator|)
operator|)
operator|)
condition|)
return|return
name|unsupported_diff_error
argument_list|(
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Only diffs between a path's text-base "
literal|"and its working files are supported at this time"
argument_list|)
argument_list|)
argument_list|)
return|;
comment|/* Resolve named revisions to real numbers. */
name|err
operator|=
name|svn_client__get_revision_number
argument_list|(
operator|&
name|callback_baton
operator|->
name|revnum1
argument_list|,
name|NULL
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath1
argument_list|,
name|NULL
argument_list|,
name|revision1
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* In case of an added node, we have no base rev, and we show a revision    * number of 0. Note that this code is currently always asking for    * svn_opt_revision_base.    * ### TODO: get rid of this 0 for added nodes. */
if|if
condition|(
name|err
operator|&&
operator|(
name|err
operator|->
name|apr_err
operator|==
name|SVN_ERR_CLIENT_BAD_REVISION
operator|)
condition|)
block|{
name|svn_error_clear
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|callback_baton
operator|->
name|revnum1
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|callback_baton
operator|->
name|revnum2
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
comment|/* WC */
name|SVN_ERR
argument_list|(
name|svn_wc_read_kind2
argument_list|(
operator|&
name|kind
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath1
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|!=
name|svn_node_dir
condition|)
name|callback_baton
operator|->
name|anchor
operator|=
name|svn_dirent_dirname
argument_list|(
name|path1
argument_list|,
name|pool
argument_list|)
expr_stmt|;
else|else
name|callback_baton
operator|->
name|anchor
operator|=
name|path1
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_diff6
argument_list|(
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath1
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|changelists
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Perform a diff between two repository paths.     PATH_OR_URL1 and PATH_OR_URL2 may be either URLs or the working copy paths.    REVISION1 and REVISION2 are their respective revisions.    If PEG_REVISION is specified, PATH_OR_URL2 is the path at the peg revision,    and the actual two paths compared are determined by following copy    history from PATH_OR_URL2.     All other options are the same as those passed to svn_client_diff6(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_repos_repos
parameter_list|(
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|struct
name|diff_cmd_baton
modifier|*
name|callback_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_ra_session_t
modifier|*
name|extra_ra_session
decl_stmt|;
specifier|const
name|svn_ra_reporter3_t
modifier|*
name|reporter
decl_stmt|;
name|void
modifier|*
name|reporter_baton
decl_stmt|;
specifier|const
name|svn_delta_editor_t
modifier|*
name|diff_editor
decl_stmt|;
name|void
modifier|*
name|diff_edit_baton
decl_stmt|;
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|diff_processor
decl_stmt|;
specifier|const
name|char
modifier|*
name|url1
decl_stmt|;
specifier|const
name|char
modifier|*
name|url2
decl_stmt|;
specifier|const
name|char
modifier|*
name|base_path
decl_stmt|;
name|svn_revnum_t
name|rev1
decl_stmt|;
name|svn_revnum_t
name|rev2
decl_stmt|;
name|svn_node_kind_t
name|kind1
decl_stmt|;
name|svn_node_kind_t
name|kind2
decl_stmt|;
specifier|const
name|char
modifier|*
name|anchor1
decl_stmt|;
specifier|const
name|char
modifier|*
name|anchor2
decl_stmt|;
specifier|const
name|char
modifier|*
name|target1
decl_stmt|;
specifier|const
name|char
modifier|*
name|target2
decl_stmt|;
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
specifier|const
name|char
modifier|*
name|wri_abspath
init|=
name|NULL
decl_stmt|;
comment|/* Prepare info for the repos repos diff. */
name|SVN_ERR
argument_list|(
name|diff_prepare_repos_repos
argument_list|(
operator|&
name|url1
argument_list|,
operator|&
name|url2
argument_list|,
operator|&
name|base_path
argument_list|,
operator|&
name|rev1
argument_list|,
operator|&
name|rev2
argument_list|,
operator|&
name|anchor1
argument_list|,
operator|&
name|anchor2
argument_list|,
operator|&
name|target1
argument_list|,
operator|&
name|target2
argument_list|,
operator|&
name|kind1
argument_list|,
operator|&
name|kind2
argument_list|,
operator|&
name|ra_session
argument_list|,
name|ctx
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Find a WC path for the ra session */
if|if
condition|(
operator|!
name|svn_path_is_url
argument_list|(
name|path_or_url1
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|wri_abspath
argument_list|,
name|path_or_url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|svn_path_is_url
argument_list|(
name|path_or_url2
argument_list|)
condition|)
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|wri_abspath
argument_list|,
name|path_or_url2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up the repos_diff editor on BASE_PATH, if available.      Otherwise, we just use "". */
name|SVN_ERR
argument_list|(
name|svn_wc__wrap_diff_callbacks
argument_list|(
operator|&
name|diff_processor
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|TRUE
comment|/* walk_deleted_dirs */
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Get actual URLs. */
name|callback_baton
operator|->
name|orig_path_1
operator|=
name|url1
expr_stmt|;
name|callback_baton
operator|->
name|orig_path_2
operator|=
name|url2
expr_stmt|;
comment|/* Get numeric revisions. */
name|callback_baton
operator|->
name|revnum1
operator|=
name|rev1
expr_stmt|;
name|callback_baton
operator|->
name|revnum2
operator|=
name|rev2
expr_stmt|;
name|callback_baton
operator|->
name|ra_session
operator|=
name|ra_session
expr_stmt|;
name|callback_baton
operator|->
name|anchor
operator|=
name|base_path
expr_stmt|;
comment|/* The repository can bring in a new working copy, but not delete      everything. Luckily our new diff handler can just be reversed. */
if|if
condition|(
name|kind2
operator|==
name|svn_node_none
condition|)
block|{
specifier|const
name|char
modifier|*
name|str_tmp
decl_stmt|;
name|svn_revnum_t
name|rev_tmp
decl_stmt|;
name|str_tmp
operator|=
name|url2
expr_stmt|;
name|url2
operator|=
name|url1
expr_stmt|;
name|url1
operator|=
name|str_tmp
expr_stmt|;
name|rev_tmp
operator|=
name|rev2
expr_stmt|;
name|rev2
operator|=
name|rev1
expr_stmt|;
name|rev1
operator|=
name|rev_tmp
expr_stmt|;
name|str_tmp
operator|=
name|anchor2
expr_stmt|;
name|anchor2
operator|=
name|anchor1
expr_stmt|;
name|anchor1
operator|=
name|str_tmp
expr_stmt|;
name|str_tmp
operator|=
name|target2
expr_stmt|;
name|target2
operator|=
name|target1
expr_stmt|;
name|target1
operator|=
name|str_tmp
expr_stmt|;
name|diff_processor
operator|=
name|svn_diff__tree_processor_reverse_create
argument_list|(
name|diff_processor
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
comment|/* Filter the first path component using a filter processor, until we fixed      the diff processing to handle this directly */
if|if
condition|(
operator|(
name|kind1
operator|!=
name|svn_node_file
operator|&&
name|kind2
operator|!=
name|svn_node_file
operator|)
operator|&&
name|target1
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|diff_processor
operator|=
name|svn_diff__tree_processor_filter_create
argument_list|(
name|diff_processor
argument_list|,
name|target1
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
comment|/* Now, we open an extra RA session to the correct anchor      location for URL1.  This is used during the editor calls to fetch file      contents.  */
name|SVN_ERR
argument_list|(
name|svn_client_open_ra_session2
argument_list|(
operator|&
name|extra_ra_session
argument_list|,
name|anchor1
argument_list|,
name|wri_abspath
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_diff_editor2
argument_list|(
operator|&
name|diff_editor
argument_list|,
operator|&
name|diff_edit_baton
argument_list|,
name|extra_ra_session
argument_list|,
name|depth
argument_list|,
name|rev1
argument_list|,
name|TRUE
comment|/* text_deltas */
argument_list|,
name|diff_processor
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We want to switch our txn into URL2 */
name|SVN_ERR
argument_list|(
name|svn_ra_do_diff3
argument_list|(
name|ra_session
argument_list|,
operator|&
name|reporter
argument_list|,
operator|&
name|reporter_baton
argument_list|,
name|rev2
argument_list|,
name|target1
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|TRUE
comment|/* text_deltas */
argument_list|,
name|url2
argument_list|,
name|diff_editor
argument_list|,
name|diff_edit_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Drive the reporter; do the diff. */
name|SVN_ERR
argument_list|(
name|reporter
operator|->
name|set_path
argument_list|(
name|reporter_baton
argument_list|,
literal|""
argument_list|,
name|rev1
argument_list|,
name|svn_depth_infinity
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|reporter
operator|->
name|finish_report
argument_list|(
name|reporter_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Perform a diff between a repository path and a working-copy path.     PATH_OR_URL1 may be either a URL or a working copy path.  PATH2 is a    working copy path.  REVISION1 and REVISION2 are their respective    revisions.  If REVERSE is TRUE, the diff will be done in reverse.    If PEG_REVISION is specified, then PATH_OR_URL1 is the path in the peg    revision, and the actual repository path to be compared is    determined by following copy history.     All other options are the same as those passed to svn_client_diff6(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_repos_wc
parameter_list|(
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
name|svn_boolean_t
name|reverse
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|void
modifier|*
name|callback_baton
parameter_list|,
name|struct
name|diff_cmd_baton
modifier|*
name|cmd_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|scratch_pool
decl_stmt|;
specifier|const
name|char
modifier|*
name|url1
decl_stmt|,
modifier|*
name|anchor
decl_stmt|,
modifier|*
name|anchor_url
decl_stmt|,
modifier|*
name|target
decl_stmt|;
name|svn_revnum_t
name|rev
decl_stmt|;
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
name|svn_depth_t
name|diff_depth
decl_stmt|;
specifier|const
name|svn_ra_reporter3_t
modifier|*
name|reporter
decl_stmt|;
name|void
modifier|*
name|reporter_baton
decl_stmt|;
specifier|const
name|svn_delta_editor_t
modifier|*
name|diff_editor
decl_stmt|;
name|void
modifier|*
name|diff_edit_baton
decl_stmt|;
name|svn_boolean_t
name|rev2_is_base
init|=
operator|(
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_base
operator|)
decl_stmt|;
name|svn_boolean_t
name|server_supports_depth
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath_or_url1
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath2
decl_stmt|;
specifier|const
name|char
modifier|*
name|anchor_abspath
decl_stmt|;
name|svn_node_kind_t
name|kind1
decl_stmt|;
name|svn_node_kind_t
name|kind2
decl_stmt|;
name|svn_boolean_t
name|is_copy
decl_stmt|;
name|svn_revnum_t
name|cf_revision
decl_stmt|;
specifier|const
name|char
modifier|*
name|cf_repos_relpath
decl_stmt|;
specifier|const
name|char
modifier|*
name|cf_repos_root_url
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_path_is_url
argument_list|(
name|path2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_path_is_url
argument_list|(
name|path_or_url1
argument_list|)
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath_or_url1
argument_list|,
name|path_or_url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_url
argument_list|(
operator|&
name|url1
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath_or_url1
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|url1
operator|=
name|path_or_url1
expr_stmt|;
name|abspath_or_url1
operator|=
name|path_or_url1
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath2
argument_list|,
name|path2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Convert path_or_url1 to a URL to feed to do_diff. */
name|SVN_ERR
argument_list|(
name|svn_wc_get_actual_target2
argument_list|(
operator|&
name|anchor
argument_list|,
operator|&
name|target
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|path2
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Fetch the URL of the anchor directory. */
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|anchor_abspath
argument_list|,
name|anchor
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_url
argument_list|(
operator|&
name|anchor_url
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|anchor_abspath
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|anchor_url
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* If we are performing a pegged diff, we need to find out what our      actual URLs will be. */
if|if
condition|(
name|peg_revision
operator|->
name|kind
operator|!=
name|svn_opt_revision_unspecified
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_client__repos_locations
argument_list|(
operator|&
name|url1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|path_or_url1
argument_list|,
name|peg_revision
argument_list|,
name|revision1
argument_list|,
name|NULL
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reverse
condition|)
block|{
name|cmd_baton
operator|->
name|orig_path_1
operator|=
name|url1
expr_stmt|;
name|cmd_baton
operator|->
name|orig_path_2
operator|=
name|svn_path_url_add_component2
argument_list|(
name|anchor_url
argument_list|,
name|target
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cmd_baton
operator|->
name|orig_path_1
operator|=
name|svn_path_url_add_component2
argument_list|(
name|anchor_url
argument_list|,
name|target
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|cmd_baton
operator|->
name|orig_path_2
operator|=
name|url1
expr_stmt|;
block|}
block|}
comment|/* Open an RA session to URL1 to figure out its node kind. */
name|SVN_ERR
argument_list|(
name|svn_client_open_ra_session2
argument_list|(
operator|&
name|ra_session
argument_list|,
name|url1
argument_list|,
name|abspath2
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Resolve the revision to use for URL1. */
name|SVN_ERR
argument_list|(
name|svn_client__get_revision_number
argument_list|(
operator|&
name|rev
argument_list|,
name|NULL
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
operator|(
name|strcmp
argument_list|(
name|path_or_url1
argument_list|,
name|url1
argument_list|)
operator|==
literal|0
operator|)
condition|?
name|NULL
else|:
name|abspath_or_url1
argument_list|,
name|ra_session
argument_list|,
name|revision1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_check_path
argument_list|(
name|ra_session
argument_list|,
literal|""
argument_list|,
name|rev
argument_list|,
operator|&
name|kind1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Figure out the node kind of the local target. */
name|SVN_ERR
argument_list|(
name|svn_wc_read_kind2
argument_list|(
operator|&
name|kind2
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath2
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|cmd_baton
operator|->
name|ra_session
operator|=
name|ra_session
expr_stmt|;
name|cmd_baton
operator|->
name|anchor
operator|=
name|anchor
expr_stmt|;
if|if
condition|(
operator|!
name|reverse
condition|)
name|cmd_baton
operator|->
name|revnum1
operator|=
name|rev
expr_stmt|;
else|else
name|cmd_baton
operator|->
name|revnum2
operator|=
name|rev
expr_stmt|;
comment|/* Check if our diff target is a copied node. */
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_origin
argument_list|(
operator|&
name|is_copy
argument_list|,
operator|&
name|cf_revision
argument_list|,
operator|&
name|cf_repos_relpath
argument_list|,
operator|&
name|cf_repos_root_url
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath2
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Use the diff editor to generate the diff. */
name|SVN_ERR
argument_list|(
name|svn_ra_has_capability
argument_list|(
name|ra_session
argument_list|,
operator|&
name|server_supports_depth
argument_list|,
name|SVN_RA_CAPABILITY_DEPTH
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__get_diff_editor
argument_list|(
operator|&
name|diff_editor
argument_list|,
operator|&
name|diff_edit_baton
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|anchor_abspath
argument_list|,
name|target
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
operator|||
name|is_copy
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|rev2_is_base
argument_list|,
name|reverse
argument_list|,
name|server_supports_depth
argument_list|,
name|changelists
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
name|ra_session
argument_list|,
name|anchor_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|!=
name|svn_depth_infinity
condition|)
name|diff_depth
operator|=
name|depth
expr_stmt|;
else|else
name|diff_depth
operator|=
name|svn_depth_unknown
expr_stmt|;
if|if
condition|(
name|is_copy
condition|)
block|{
specifier|const
name|char
modifier|*
name|copyfrom_parent_url
decl_stmt|;
specifier|const
name|char
modifier|*
name|copyfrom_basename
decl_stmt|;
name|svn_depth_t
name|copy_depth
decl_stmt|;
name|cmd_baton
operator|->
name|repos_wc_diff_target_is_copy
operator|=
name|TRUE
expr_stmt|;
comment|/* We're diffing a locally copied/moved node.        * Describe the copy source to the reporter instead of the copy itself.        * Doing the latter would generate a single add_directory() call to the        * diff editor which results in an unexpected diff (the copy would        * be shown as deleted). */
if|if
condition|(
name|cf_repos_relpath
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
name|copyfrom_parent_url
operator|=
name|cf_repos_root_url
expr_stmt|;
name|copyfrom_basename
operator|=
literal|""
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|parent_relpath
decl_stmt|;
name|svn_relpath_split
argument_list|(
operator|&
name|parent_relpath
argument_list|,
operator|&
name|copyfrom_basename
argument_list|,
name|cf_repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
name|copyfrom_parent_url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|cf_repos_root_url
argument_list|,
name|parent_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_ra_reparent
argument_list|(
name|ra_session
argument_list|,
name|copyfrom_parent_url
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Tell the RA layer we want a delta to change our txn to URL1 */
name|SVN_ERR
argument_list|(
name|svn_ra_do_diff3
argument_list|(
name|ra_session
argument_list|,
operator|&
name|reporter
argument_list|,
operator|&
name|reporter_baton
argument_list|,
name|rev
argument_list|,
name|target
argument_list|,
name|diff_depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|TRUE
argument_list|,
comment|/* text_deltas */
name|url1
argument_list|,
name|diff_editor
argument_list|,
name|diff_edit_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Report the copy source. */
name|SVN_ERR
argument_list|(
name|svn_wc__node_get_depth
argument_list|(
operator|&
name|copy_depth
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy_depth
operator|==
name|svn_depth_unknown
condition|)
name|copy_depth
operator|=
name|svn_depth_infinity
expr_stmt|;
name|SVN_ERR
argument_list|(
name|reporter
operator|->
name|set_path
argument_list|(
name|reporter_baton
argument_list|,
literal|""
argument_list|,
name|cf_revision
argument_list|,
name|copy_depth
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|target
argument_list|,
name|copyfrom_basename
argument_list|)
operator|!=
literal|0
condition|)
name|SVN_ERR
argument_list|(
name|reporter
operator|->
name|link_path
argument_list|(
name|reporter_baton
argument_list|,
name|target
argument_list|,
name|svn_path_url_add_component2
argument_list|(
name|cf_repos_root_url
argument_list|,
name|cf_repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|,
name|cf_revision
argument_list|,
name|copy_depth
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Finish the report to generate the diff. */
name|SVN_ERR
argument_list|(
name|reporter
operator|->
name|finish_report
argument_list|(
name|reporter_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Tell the RA layer we want a delta to change our txn to URL1 */
name|SVN_ERR
argument_list|(
name|svn_ra_do_diff3
argument_list|(
name|ra_session
argument_list|,
operator|&
name|reporter
argument_list|,
operator|&
name|reporter_baton
argument_list|,
name|rev
argument_list|,
name|target
argument_list|,
name|diff_depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|TRUE
argument_list|,
comment|/* text_deltas */
name|url1
argument_list|,
name|diff_editor
argument_list|,
name|diff_edit_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Create a txn mirror of path2;  the diff editor will print          diffs in reverse.  :-)  */
name|SVN_ERR
argument_list|(
name|svn_wc_crawl_revisions5
argument_list|(
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath2
argument_list|,
name|reporter
argument_list|,
name|reporter_baton
argument_list|,
name|FALSE
argument_list|,
name|depth
argument_list|,
name|TRUE
argument_list|,
operator|(
operator|!
name|server_supports_depth
operator|)
argument_list|,
name|FALSE
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* notification is N/A */
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* This is basically just the guts of svn_client_diff[_peg]6(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|do_diff
parameter_list|(
specifier|const
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
parameter_list|,
name|struct
name|diff_cmd_baton
modifier|*
name|callback_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_boolean_t
name|is_repos1
decl_stmt|;
name|svn_boolean_t
name|is_repos2
decl_stmt|;
comment|/* Check if paths/revisions are urls/local. */
name|SVN_ERR
argument_list|(
name|check_paths
argument_list|(
operator|&
name|is_repos1
argument_list|,
operator|&
name|is_repos2
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_repos1
condition|)
block|{
if|if
condition|(
name|is_repos2
condition|)
block|{
comment|/* ### Ignores 'show_copies_as_adds'. */
name|SVN_ERR
argument_list|(
name|diff_repos_repos
argument_list|(
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|ctx
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* path_or_url2 is a working copy path */
block|{
name|SVN_ERR
argument_list|(
name|diff_repos_wc
argument_list|(
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|peg_revision
argument_list|,
name|path_or_url2
argument_list|,
name|revision2
argument_list|,
name|FALSE
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|changelists
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|callback_baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
comment|/* path_or_url1 is a working copy path */
block|{
if|if
condition|(
name|is_repos2
condition|)
block|{
name|SVN_ERR
argument_list|(
name|diff_repos_wc
argument_list|(
name|path_or_url2
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|,
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|TRUE
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|changelists
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|callback_baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* path_or_url2 is a working copy path */
block|{
if|if
condition|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_working
operator|&&
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_working
condition|)
block|{
specifier|const
name|char
modifier|*
name|abspath1
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath2
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath1
argument_list|,
name|path_or_url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath2
argument_list|,
name|path_or_url2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__arbitrary_nodes_diff
argument_list|(
name|abspath1
argument_list|,
name|abspath2
argument_list|,
name|depth
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|diff_wc_wc
argument_list|(
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|path_or_url2
argument_list|,
name|revision2
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|changelists
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Perform a diff between a repository path and a working-copy path.     PATH_OR_URL1 may be either a URL or a working copy path.  PATH2 is a    working copy path.  REVISION1 and REVISION2 are their respective    revisions.  If REVERSE is TRUE, the diff will be done in reverse.    If PEG_REVISION is specified, then PATH_OR_URL1 is the path in the peg    revision, and the actual repository path to be compared is    determined by following copy history.     All other options are the same as those passed to svn_client_diff6(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_summarize_repos_wc
parameter_list|(
name|svn_client_diff_summarize_func_t
name|summarize_func
parameter_list|,
name|void
modifier|*
name|summarize_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
name|svn_boolean_t
name|reverse
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|anchor
decl_stmt|,
modifier|*
name|target
decl_stmt|;
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
decl_stmt|;
name|void
modifier|*
name|callback_baton
decl_stmt|;
name|struct
name|diff_cmd_baton
name|cmd_baton
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_path_is_url
argument_list|(
name|path2
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_get_actual_target2
argument_list|(
operator|&
name|anchor
argument_list|,
operator|&
name|target
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|path2
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_diff_summarize_callbacks
argument_list|(
operator|&
name|callbacks
argument_list|,
operator|&
name|callback_baton
argument_list|,
name|target
argument_list|,
name|reverse
argument_list|,
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|diff_repos_wc
argument_list|(
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|peg_revision
argument_list|,
name|path2
argument_list|,
name|revision2
argument_list|,
name|reverse
argument_list|,
name|depth
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|changelists
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
operator|&
name|cmd_baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Perform a summary diff between two working-copy paths.     PATH1 and PATH2 are both working copy paths.  REVISION1 and    REVISION2 are their respective revisions.     All other options are the same as those passed to svn_client_diff6(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_summarize_wc_wc
parameter_list|(
name|svn_client_diff_summarize_func_t
name|summarize_func
parameter_list|,
name|void
modifier|*
name|summarize_baton
parameter_list|,
specifier|const
name|char
modifier|*
name|path1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|char
modifier|*
name|path2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
decl_stmt|;
name|void
modifier|*
name|callback_baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath1
decl_stmt|,
modifier|*
name|target1
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_path_is_url
argument_list|(
name|path1
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
operator|!
name|svn_path_is_url
argument_list|(
name|path2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Currently we support only the case where path1 and path2 are the      same path. */
if|if
condition|(
operator|(
name|strcmp
argument_list|(
name|path1
argument_list|,
name|path2
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
operator|!
operator|(
operator|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_base
operator|)
operator|&&
operator|(
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_working
operator|)
operator|)
operator|)
condition|)
return|return
name|unsupported_diff_error
argument_list|(
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Summarized diffs are only supported between a path's text-base "
literal|"and its working files at this time"
argument_list|)
argument_list|)
argument_list|)
return|;
comment|/* Find the node kind of PATH1 so that we know whether the diff drive will      be anchored at PATH1 or its parent dir. */
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath1
argument_list|,
name|path1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_read_kind2
argument_list|(
operator|&
name|kind
argument_list|,
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath1
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|target1
operator|=
operator|(
name|kind
operator|==
name|svn_node_dir
operator|)
condition|?
literal|""
else|:
name|svn_dirent_basename
argument_list|(
name|path1
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_diff_summarize_callbacks
argument_list|(
operator|&
name|callbacks
argument_list|,
operator|&
name|callback_baton
argument_list|,
name|target1
argument_list|,
name|FALSE
argument_list|,
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc_diff6
argument_list|(
name|ctx
operator|->
name|wc_ctx
argument_list|,
name|abspath1
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|FALSE
comment|/* show_copies_as_adds */
argument_list|,
name|FALSE
comment|/* use_git_diff_format */
argument_list|,
name|changelists
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Perform a diff summary between two repository paths. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|diff_summarize_repos_repos
parameter_list|(
name|svn_client_diff_summarize_func_t
name|summarize_func
parameter_list|,
name|void
modifier|*
name|summarize_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_ra_session_t
modifier|*
name|extra_ra_session
decl_stmt|;
specifier|const
name|svn_ra_reporter3_t
modifier|*
name|reporter
decl_stmt|;
name|void
modifier|*
name|reporter_baton
decl_stmt|;
specifier|const
name|svn_delta_editor_t
modifier|*
name|diff_editor
decl_stmt|;
name|void
modifier|*
name|diff_edit_baton
decl_stmt|;
specifier|const
name|svn_diff_tree_processor_t
modifier|*
name|diff_processor
decl_stmt|;
specifier|const
name|char
modifier|*
name|url1
decl_stmt|;
specifier|const
name|char
modifier|*
name|url2
decl_stmt|;
specifier|const
name|char
modifier|*
name|base_path
decl_stmt|;
name|svn_revnum_t
name|rev1
decl_stmt|;
name|svn_revnum_t
name|rev2
decl_stmt|;
name|svn_node_kind_t
name|kind1
decl_stmt|;
name|svn_node_kind_t
name|kind2
decl_stmt|;
specifier|const
name|char
modifier|*
name|anchor1
decl_stmt|;
specifier|const
name|char
modifier|*
name|anchor2
decl_stmt|;
specifier|const
name|char
modifier|*
name|target1
decl_stmt|;
specifier|const
name|char
modifier|*
name|target2
decl_stmt|;
name|svn_ra_session_t
modifier|*
name|ra_session
decl_stmt|;
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
decl_stmt|;
name|void
modifier|*
name|callback_baton
decl_stmt|;
comment|/* Prepare info for the repos repos diff. */
name|SVN_ERR
argument_list|(
name|diff_prepare_repos_repos
argument_list|(
operator|&
name|url1
argument_list|,
operator|&
name|url2
argument_list|,
operator|&
name|base_path
argument_list|,
operator|&
name|rev1
argument_list|,
operator|&
name|rev2
argument_list|,
operator|&
name|anchor1
argument_list|,
operator|&
name|anchor2
argument_list|,
operator|&
name|target1
argument_list|,
operator|&
name|target2
argument_list|,
operator|&
name|kind1
argument_list|,
operator|&
name|kind2
argument_list|,
operator|&
name|ra_session
argument_list|,
name|ctx
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up the repos_diff editor. */
name|SVN_ERR
argument_list|(
name|svn_client__get_diff_summarize_callbacks
argument_list|(
operator|&
name|callbacks
argument_list|,
operator|&
name|callback_baton
argument_list|,
name|target1
argument_list|,
name|FALSE
argument_list|,
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__wrap_diff_callbacks
argument_list|(
operator|&
name|diff_processor
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|TRUE
comment|/* walk_deleted_dirs */
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The repository can bring in a new working copy, but not delete      everything. Luckily our new diff handler can just be reversed. */
if|if
condition|(
name|kind2
operator|==
name|svn_node_none
condition|)
block|{
specifier|const
name|char
modifier|*
name|str_tmp
decl_stmt|;
name|svn_revnum_t
name|rev_tmp
decl_stmt|;
name|str_tmp
operator|=
name|url2
expr_stmt|;
name|url2
operator|=
name|url1
expr_stmt|;
name|url1
operator|=
name|str_tmp
expr_stmt|;
name|rev_tmp
operator|=
name|rev2
expr_stmt|;
name|rev2
operator|=
name|rev1
expr_stmt|;
name|rev1
operator|=
name|rev_tmp
expr_stmt|;
name|str_tmp
operator|=
name|anchor2
expr_stmt|;
name|anchor2
operator|=
name|anchor1
expr_stmt|;
name|anchor1
operator|=
name|str_tmp
expr_stmt|;
name|str_tmp
operator|=
name|target2
expr_stmt|;
name|target2
operator|=
name|target1
expr_stmt|;
name|target1
operator|=
name|str_tmp
expr_stmt|;
name|diff_processor
operator|=
name|svn_diff__tree_processor_reverse_create
argument_list|(
name|diff_processor
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
comment|/* Now, we open an extra RA session to the correct anchor      location for URL1.  This is used to get deleted path information.  */
name|SVN_ERR
argument_list|(
name|svn_client_open_ra_session2
argument_list|(
operator|&
name|extra_ra_session
argument_list|,
name|anchor1
argument_list|,
name|NULL
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_diff_editor2
argument_list|(
operator|&
name|diff_editor
argument_list|,
operator|&
name|diff_edit_baton
argument_list|,
name|extra_ra_session
argument_list|,
name|depth
argument_list|,
name|rev1
argument_list|,
name|FALSE
comment|/* text_deltas */
argument_list|,
name|diff_processor
argument_list|,
name|ctx
operator|->
name|cancel_func
argument_list|,
name|ctx
operator|->
name|cancel_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We want to switch our txn into URL2 */
name|SVN_ERR
argument_list|(
name|svn_ra_do_diff3
argument_list|(
name|ra_session
argument_list|,
operator|&
name|reporter
argument_list|,
operator|&
name|reporter_baton
argument_list|,
name|rev2
argument_list|,
name|target1
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|FALSE
comment|/* do not create text delta */
argument_list|,
name|url2
argument_list|,
name|diff_editor
argument_list|,
name|diff_edit_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Drive the reporter; do the diff. */
name|SVN_ERR
argument_list|(
name|reporter
operator|->
name|set_path
argument_list|(
name|reporter_baton
argument_list|,
literal|""
argument_list|,
name|rev1
argument_list|,
name|svn_depth_infinity
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_error_trace
argument_list|(
name|reporter
operator|->
name|finish_report
argument_list|(
name|reporter_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* This is basically just the guts of svn_client_diff_summarize[_peg]2(). */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|do_diff_summarize
parameter_list|(
name|svn_client_diff_summarize_func_t
name|summarize_func
parameter_list|,
name|void
modifier|*
name|summarize_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_boolean_t
name|is_repos1
decl_stmt|;
name|svn_boolean_t
name|is_repos2
decl_stmt|;
comment|/* Check if paths/revisions are urls/local. */
name|SVN_ERR
argument_list|(
name|check_paths
argument_list|(
operator|&
name|is_repos1
argument_list|,
operator|&
name|is_repos2
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_repos1
condition|)
block|{
if|if
condition|(
name|is_repos2
condition|)
name|SVN_ERR
argument_list|(
name|diff_summarize_repos_repos
argument_list|(
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|ctx
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|diff_summarize_repos_wc
argument_list|(
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|peg_revision
argument_list|,
name|path_or_url2
argument_list|,
name|revision2
argument_list|,
name|FALSE
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|changelists
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* ! is_repos1 */
block|{
if|if
condition|(
name|is_repos2
condition|)
name|SVN_ERR
argument_list|(
name|diff_summarize_repos_wc
argument_list|(
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|path_or_url2
argument_list|,
name|revision2
argument_list|,
name|peg_revision
argument_list|,
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|TRUE
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|changelists
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|revision1
operator|->
name|kind
operator|==
name|svn_opt_revision_working
operator|&&
name|revision2
operator|->
name|kind
operator|==
name|svn_opt_revision_working
condition|)
block|{
specifier|const
name|char
modifier|*
name|abspath1
decl_stmt|;
specifier|const
name|char
modifier|*
name|abspath2
decl_stmt|;
name|svn_wc_diff_callbacks4_t
modifier|*
name|callbacks
decl_stmt|;
name|void
modifier|*
name|callback_baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|target
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath1
argument_list|,
name|path_or_url1
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_dirent_get_absolute
argument_list|(
operator|&
name|abspath2
argument_list|,
name|path_or_url2
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_check_resolved_path
argument_list|(
name|abspath1
argument_list|,
operator|&
name|kind
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|kind
operator|==
name|svn_node_dir
condition|)
name|target
operator|=
literal|""
expr_stmt|;
else|else
name|target
operator|=
name|svn_dirent_basename
argument_list|(
name|path_or_url1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__get_diff_summarize_callbacks
argument_list|(
operator|&
name|callbacks
argument_list|,
operator|&
name|callback_baton
argument_list|,
name|target
argument_list|,
name|FALSE
argument_list|,
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client__arbitrary_nodes_diff
argument_list|(
name|abspath1
argument_list|,
name|abspath2
argument_list|,
name|depth
argument_list|,
name|callbacks
argument_list|,
name|callback_baton
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|diff_summarize_wc_wc
argument_list|(
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|path_or_url1
argument_list|,
name|revision1
argument_list|,
name|path_or_url2
argument_list|,
name|revision2
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|changelists
argument_list|,
name|ctx
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Initialize DIFF_CMD_BATON.diff_cmd and DIFF_CMD_BATON.options,  * according to OPTIONS and CONFIG.  CONFIG and OPTIONS may be null.  * Allocate the fields in POOL, which should be at least as long-lived  * as the pool DIFF_CMD_BATON itself is allocated in.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|set_up_diff_cmd_and_options
parameter_list|(
name|struct
name|diff_cmd_baton
modifier|*
name|diff_cmd_baton
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|options
parameter_list|,
name|apr_hash_t
modifier|*
name|config
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|diff_cmd
init|=
name|NULL
decl_stmt|;
comment|/* See if there is a diff command and/or diff arguments. */
if|if
condition|(
name|config
condition|)
block|{
name|svn_config_t
modifier|*
name|cfg
init|=
name|svn_hash_gets
argument_list|(
name|config
argument_list|,
name|SVN_CONFIG_CATEGORY_CONFIG
argument_list|)
decl_stmt|;
name|svn_config_get
argument_list|(
name|cfg
argument_list|,
operator|&
name|diff_cmd
argument_list|,
name|SVN_CONFIG_SECTION_HELPERS
argument_list|,
name|SVN_CONFIG_OPTION_DIFF_CMD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|options
operator|==
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|diff_extensions
decl_stmt|;
name|svn_config_get
argument_list|(
name|cfg
argument_list|,
operator|&
name|diff_extensions
argument_list|,
name|SVN_CONFIG_SECTION_HELPERS
argument_list|,
name|SVN_CONFIG_OPTION_DIFF_EXTENSIONS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_extensions
condition|)
name|options
operator|=
name|svn_cstring_split
argument_list|(
name|diff_extensions
argument_list|,
literal|" \t\n\r"
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|options
operator|==
name|NULL
condition|)
name|options
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|diff_cmd
condition|)
name|SVN_ERR
argument_list|(
name|svn_path_cstring_to_utf8
argument_list|(
operator|&
name|diff_cmd_baton
operator|->
name|diff_cmd
argument_list|,
name|diff_cmd
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|diff_cmd_baton
operator|->
name|diff_cmd
operator|=
name|NULL
expr_stmt|;
comment|/* If there was a command, arrange options to pass to it. */
if|if
condition|(
name|diff_cmd_baton
operator|->
name|diff_cmd
condition|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|argv
init|=
name|NULL
decl_stmt|;
name|int
name|argc
init|=
name|options
operator|->
name|nelts
decl_stmt|;
if|if
condition|(
name|argc
condition|)
block|{
name|int
name|i
decl_stmt|;
name|argv
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|argc
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
name|SVN_ERR
argument_list|(
name|svn_utf_cstring_to_utf8
argument_list|(
operator|&
name|argv
index|[
name|i
index|]
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|options
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_external
operator|.
name|argv
operator|=
name|argv
expr_stmt|;
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_external
operator|.
name|argc
operator|=
name|argc
expr_stmt|;
block|}
else|else
comment|/* No command, so arrange options for internal invocation instead. */
block|{
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_internal
operator|=
name|svn_diff_file_options_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_diff_file_options_parse
argument_list|(
name|diff_cmd_baton
operator|->
name|options
operator|.
name|for_internal
argument_list|,
name|options
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/*----------------------------------------------------------------------- */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Public Interfaces. ***/
end_comment

begin_comment
comment|/* Display context diffs between two PATH/REVISION pairs.  Each of    these inputs will be one of the following:     - a repository URL at a given revision.    - a working copy path, ignoring local mods.    - a working copy path, including local mods.     We can establish a matrix that shows the nine possible types of    diffs we expect to support.         ` .     DST ||  URL:rev   | WC:base    | WC:working |           ` .     ||            |            |            |       SRC     ` . ||            |            |            |       ============++============+============+============+        URL:rev    || (*)        | (*)        | (*)        |                   ||            |            |            |                   ||            |            |            |                   ||            |            |            |       ------------++------------+------------+------------+        WC:base    || (*)        |                         |                   ||            | New svn_wc_diff which   |                   ||            | is smart enough to      |                   ||            | handle two WC paths     |       ------------++------------+ and their related       +        WC:working || (*)        | text-bases and working  |                   ||            | files.  This operation  |                   ||            | is entirely local.      |                   ||            |                         |       ------------++------------+------------+------------+       * These cases require server communication. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_client_diff6
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|options
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
specifier|const
name|char
modifier|*
name|relative_to_dir
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|no_diff_added
parameter_list|,
name|svn_boolean_t
name|no_diff_deleted
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|ignore_content_type
parameter_list|,
name|svn_boolean_t
name|ignore_properties
parameter_list|,
name|svn_boolean_t
name|properties_only
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
name|svn_stream_t
modifier|*
name|outstream
parameter_list|,
name|svn_stream_t
modifier|*
name|errstream
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|diff_cmd_baton
name|diff_cmd_baton
init|=
block|{
literal|0
block|}
decl_stmt|;
name|svn_opt_revision_t
name|peg_revision
decl_stmt|;
if|if
condition|(
name|ignore_properties
operator|&&
name|properties_only
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot ignore properties and show only "
literal|"properties at the same time"
argument_list|)
argument_list|)
return|;
comment|/* We will never do a pegged diff from here. */
name|peg_revision
operator|.
name|kind
operator|=
name|svn_opt_revision_unspecified
expr_stmt|;
comment|/* setup callback and baton */
name|diff_cmd_baton
operator|.
name|orig_path_1
operator|=
name|path_or_url1
expr_stmt|;
name|diff_cmd_baton
operator|.
name|orig_path_2
operator|=
name|path_or_url2
expr_stmt|;
name|SVN_ERR
argument_list|(
name|set_up_diff_cmd_and_options
argument_list|(
operator|&
name|diff_cmd_baton
argument_list|,
name|options
argument_list|,
name|ctx
operator|->
name|config
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|diff_cmd_baton
operator|.
name|pool
operator|=
name|pool
expr_stmt|;
name|diff_cmd_baton
operator|.
name|outstream
operator|=
name|outstream
expr_stmt|;
name|diff_cmd_baton
operator|.
name|errstream
operator|=
name|errstream
expr_stmt|;
name|diff_cmd_baton
operator|.
name|header_encoding
operator|=
name|header_encoding
expr_stmt|;
name|diff_cmd_baton
operator|.
name|revnum1
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|diff_cmd_baton
operator|.
name|revnum2
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|diff_cmd_baton
operator|.
name|force_binary
operator|=
name|ignore_content_type
expr_stmt|;
name|diff_cmd_baton
operator|.
name|ignore_properties
operator|=
name|ignore_properties
expr_stmt|;
name|diff_cmd_baton
operator|.
name|properties_only
operator|=
name|properties_only
expr_stmt|;
name|diff_cmd_baton
operator|.
name|relative_to_dir
operator|=
name|relative_to_dir
expr_stmt|;
name|diff_cmd_baton
operator|.
name|use_git_diff_format
operator|=
name|use_git_diff_format
expr_stmt|;
name|diff_cmd_baton
operator|.
name|no_diff_added
operator|=
name|no_diff_added
expr_stmt|;
name|diff_cmd_baton
operator|.
name|no_diff_deleted
operator|=
name|no_diff_deleted
expr_stmt|;
name|diff_cmd_baton
operator|.
name|no_copyfrom_on_add
operator|=
name|show_copies_as_adds
expr_stmt|;
name|diff_cmd_baton
operator|.
name|wc_ctx
operator|=
name|ctx
operator|->
name|wc_ctx
expr_stmt|;
name|diff_cmd_baton
operator|.
name|ra_session
operator|=
name|NULL
expr_stmt|;
name|diff_cmd_baton
operator|.
name|anchor
operator|=
name|NULL
expr_stmt|;
return|return
name|do_diff
argument_list|(
operator|&
name|diff_callbacks
argument_list|,
operator|&
name|diff_cmd_baton
argument_list|,
name|ctx
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
operator|&
name|peg_revision
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|changelists
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client_diff_peg6
parameter_list|(
specifier|const
name|apr_array_header_t
modifier|*
name|options
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|start_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|end_revision
parameter_list|,
specifier|const
name|char
modifier|*
name|relative_to_dir
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
name|svn_boolean_t
name|no_diff_added
parameter_list|,
name|svn_boolean_t
name|no_diff_deleted
parameter_list|,
name|svn_boolean_t
name|show_copies_as_adds
parameter_list|,
name|svn_boolean_t
name|ignore_content_type
parameter_list|,
name|svn_boolean_t
name|ignore_properties
parameter_list|,
name|svn_boolean_t
name|properties_only
parameter_list|,
name|svn_boolean_t
name|use_git_diff_format
parameter_list|,
specifier|const
name|char
modifier|*
name|header_encoding
parameter_list|,
name|svn_stream_t
modifier|*
name|outstream
parameter_list|,
name|svn_stream_t
modifier|*
name|errstream
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|diff_cmd_baton
name|diff_cmd_baton
init|=
block|{
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|ignore_properties
operator|&&
name|properties_only
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_INCORRECT_PARAMS
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Cannot ignore properties and show only "
literal|"properties at the same time"
argument_list|)
argument_list|)
return|;
comment|/* setup callback and baton */
name|diff_cmd_baton
operator|.
name|orig_path_1
operator|=
name|path_or_url
expr_stmt|;
name|diff_cmd_baton
operator|.
name|orig_path_2
operator|=
name|path_or_url
expr_stmt|;
name|SVN_ERR
argument_list|(
name|set_up_diff_cmd_and_options
argument_list|(
operator|&
name|diff_cmd_baton
argument_list|,
name|options
argument_list|,
name|ctx
operator|->
name|config
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|diff_cmd_baton
operator|.
name|pool
operator|=
name|pool
expr_stmt|;
name|diff_cmd_baton
operator|.
name|outstream
operator|=
name|outstream
expr_stmt|;
name|diff_cmd_baton
operator|.
name|errstream
operator|=
name|errstream
expr_stmt|;
name|diff_cmd_baton
operator|.
name|header_encoding
operator|=
name|header_encoding
expr_stmt|;
name|diff_cmd_baton
operator|.
name|revnum1
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|diff_cmd_baton
operator|.
name|revnum2
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|diff_cmd_baton
operator|.
name|force_binary
operator|=
name|ignore_content_type
expr_stmt|;
name|diff_cmd_baton
operator|.
name|ignore_properties
operator|=
name|ignore_properties
expr_stmt|;
name|diff_cmd_baton
operator|.
name|properties_only
operator|=
name|properties_only
expr_stmt|;
name|diff_cmd_baton
operator|.
name|relative_to_dir
operator|=
name|relative_to_dir
expr_stmt|;
name|diff_cmd_baton
operator|.
name|use_git_diff_format
operator|=
name|use_git_diff_format
expr_stmt|;
name|diff_cmd_baton
operator|.
name|no_diff_added
operator|=
name|no_diff_added
expr_stmt|;
name|diff_cmd_baton
operator|.
name|no_diff_deleted
operator|=
name|no_diff_deleted
expr_stmt|;
name|diff_cmd_baton
operator|.
name|no_copyfrom_on_add
operator|=
name|show_copies_as_adds
expr_stmt|;
name|diff_cmd_baton
operator|.
name|wc_ctx
operator|=
name|ctx
operator|->
name|wc_ctx
expr_stmt|;
name|diff_cmd_baton
operator|.
name|ra_session
operator|=
name|NULL
expr_stmt|;
name|diff_cmd_baton
operator|.
name|anchor
operator|=
name|NULL
expr_stmt|;
return|return
name|do_diff
argument_list|(
operator|&
name|diff_callbacks
argument_list|,
operator|&
name|diff_cmd_baton
argument_list|,
name|ctx
argument_list|,
name|path_or_url
argument_list|,
name|path_or_url
argument_list|,
name|start_revision
argument_list|,
name|end_revision
argument_list|,
name|peg_revision
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|show_copies_as_adds
argument_list|,
name|use_git_diff_format
argument_list|,
name|changelists
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client_diff_summarize2
parameter_list|(
specifier|const
name|char
modifier|*
name|path_or_url1
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision1
parameter_list|,
specifier|const
name|char
modifier|*
name|path_or_url2
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|revision2
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_client_diff_summarize_func_t
name|summarize_func
parameter_list|,
name|void
modifier|*
name|summarize_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* We will never do a pegged diff from here. */
name|svn_opt_revision_t
name|peg_revision
decl_stmt|;
name|peg_revision
operator|.
name|kind
operator|=
name|svn_opt_revision_unspecified
expr_stmt|;
return|return
name|do_diff_summarize
argument_list|(
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|ctx
argument_list|,
name|path_or_url1
argument_list|,
name|path_or_url2
argument_list|,
name|revision1
argument_list|,
name|revision2
argument_list|,
operator|&
name|peg_revision
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|changelists
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_client_diff_summarize_peg2
parameter_list|(
specifier|const
name|char
modifier|*
name|path_or_url
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|peg_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|start_revision
parameter_list|,
specifier|const
name|svn_opt_revision_t
modifier|*
name|end_revision
parameter_list|,
name|svn_depth_t
name|depth
parameter_list|,
name|svn_boolean_t
name|ignore_ancestry
parameter_list|,
specifier|const
name|apr_array_header_t
modifier|*
name|changelists
parameter_list|,
name|svn_client_diff_summarize_func_t
name|summarize_func
parameter_list|,
name|void
modifier|*
name|summarize_baton
parameter_list|,
name|svn_client_ctx_t
modifier|*
name|ctx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|do_diff_summarize
argument_list|(
name|summarize_func
argument_list|,
name|summarize_baton
argument_list|,
name|ctx
argument_list|,
name|path_or_url
argument_list|,
name|path_or_url
argument_list|,
name|start_revision
argument_list|,
name|end_revision
argument_list|,
name|peg_revision
argument_list|,
name|depth
argument_list|,
name|ignore_ancestry
argument_list|,
name|changelists
argument_list|,
name|pool
argument_list|)
return|;
block|}
end_function

begin_function
name|svn_client_diff_summarize_t
modifier|*
name|svn_client_diff_summarize_dup
parameter_list|(
specifier|const
name|svn_client_diff_summarize_t
modifier|*
name|diff
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_client_diff_summarize_t
modifier|*
name|dup_diff
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|dup_diff
argument_list|)
argument_list|)
decl_stmt|;
operator|*
name|dup_diff
operator|=
operator|*
name|diff
expr_stmt|;
if|if
condition|(
name|diff
operator|->
name|path
condition|)
name|dup_diff
operator|->
name|path
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|diff
operator|->
name|path
argument_list|)
expr_stmt|;
return|return
name|dup_diff
return|;
block|}
end_function

end_unit


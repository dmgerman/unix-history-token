begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* changes.h --- FSX changed paths lists container  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_packed_data.h"
end_include

begin_include
include|#
directive|include
file|"changes.h"
end_include

begin_include
include|#
directive|include
file|"string_table.h"
end_include

begin_include
include|#
directive|include
file|"temp_serializer.h"
end_include

begin_comment
comment|/* These flags will be used with the FLAGS field in binary_change_t.  */
end_comment

begin_comment
comment|/* the change contains a text modification */
end_comment

begin_define
define|#
directive|define
name|CHANGE_TEXT_MOD
value|0x00001
end_define

begin_comment
comment|/* the change contains a property modification */
end_comment

begin_define
define|#
directive|define
name|CHANGE_PROP_MOD
value|0x00002
end_define

begin_comment
comment|/* the last part (rev_id) of node revision ID is a transaction ID */
end_comment

begin_define
define|#
directive|define
name|CHANGE_TXN_NODE
value|0x00004
end_define

begin_comment
comment|/* (flags& CHANGE_NODE_MASK)>> CHANGE_NODE_SHIFT extracts the node type */
end_comment

begin_define
define|#
directive|define
name|CHANGE_NODE_SHIFT
value|0x00003
end_define

begin_define
define|#
directive|define
name|CHANGE_NODE_MASK
value|0x00018
end_define

begin_comment
comment|/* node types according to svn_node_kind_t */
end_comment

begin_define
define|#
directive|define
name|CHANGE_NODE_NONE
value|0x00000
end_define

begin_define
define|#
directive|define
name|CHANGE_NODE_FILE
value|0x00008
end_define

begin_define
define|#
directive|define
name|CHANGE_NODE_DIR
value|0x00010
end_define

begin_define
define|#
directive|define
name|CHANGE_NODE_UNKNOWN
value|0x00018
end_define

begin_comment
comment|/* (flags& CHANGE_KIND_MASK)>> CHANGE_KIND_SHIFT extracts the change type */
end_comment

begin_define
define|#
directive|define
name|CHANGE_KIND_SHIFT
value|0x00005
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_MASK
value|0x000E0
end_define

begin_comment
comment|/* node types according to svn_fs_path_change_kind_t */
end_comment

begin_define
define|#
directive|define
name|CHANGE_KIND_MODIFY
value|0x00000
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_ADD
value|0x00020
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_DELETE
value|0x00040
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_REPLACE
value|0x00060
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_RESET
value|0x00080
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_MOVE
value|0x000A0
end_define

begin_define
define|#
directive|define
name|CHANGE_KIND_MOVEREPLACE
value|0x000C0
end_define

begin_comment
comment|/* Our internal representation of a change */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|binary_change_t
block|{
comment|/* define the kind of change and what specific information is present */
name|int
name|flags
decl_stmt|;
comment|/* Path of the change. */
name|apr_size_t
name|path
decl_stmt|;
comment|/* copy-from information.    * Not present if COPYFROM_REV is SVN_INVALID_REVNUM. */
name|svn_revnum_t
name|copyfrom_rev
decl_stmt|;
name|apr_size_t
name|copyfrom_path
decl_stmt|;
comment|/* Relevant parts of the node revision ID of the change.    * Empty, if REV_ID is not "used". */
name|svn_fs_x__id_t
name|noderev_id
decl_stmt|;
block|}
name|binary_change_t
typedef|;
end_typedef

begin_comment
comment|/* The actual container object.  Change lists are concatenated into CHANGES  * and and their begins and ends are stored in OFFSETS.  */
end_comment

begin_struct
struct|struct
name|svn_fs_x__changes_t
block|{
comment|/* The paths - either in 'builder' mode or finalized mode.    * The respective other pointer will be NULL. */
name|string_table_builder_t
modifier|*
name|builder
decl_stmt|;
name|string_table_t
modifier|*
name|paths
decl_stmt|;
comment|/* All changes of all change lists concatenated.    * Array elements are binary_change_t.structs (not pointer!) */
name|apr_array_header_t
modifier|*
name|changes
decl_stmt|;
comment|/* [Offsets[index] .. Offsets[index+1]) is the range in CHANGES that    * forms the contents of change list INDEX. */
name|apr_array_header_t
modifier|*
name|offsets
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Create and return a new container object, allocated in RESULT_POOL with  * an initial capacity of INITIAL_COUNT changes.  The PATH and BUILDER  * members must be initialized by the caller afterwards.  */
end_comment

begin_function
specifier|static
name|svn_fs_x__changes_t
modifier|*
name|changes_create_body
parameter_list|(
name|apr_size_t
name|initial_count
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_fs_x__changes_t
modifier|*
name|changes
init|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|changes
argument_list|)
argument_list|)
decl_stmt|;
name|changes
operator|->
name|changes
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
operator|(
name|int
operator|)
name|initial_count
argument_list|,
sizeof|sizeof
argument_list|(
name|binary_change_t
argument_list|)
argument_list|)
expr_stmt|;
name|changes
operator|->
name|offsets
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
literal|16
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|changes
operator|->
name|offsets
argument_list|,
name|int
argument_list|)
operator|=
literal|0
expr_stmt|;
return|return
name|changes
return|;
block|}
end_function

begin_function
name|svn_fs_x__changes_t
modifier|*
name|svn_fs_x__changes_create
parameter_list|(
name|apr_size_t
name|initial_count
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|)
block|{
name|svn_fs_x__changes_t
modifier|*
name|changes
init|=
name|changes_create_body
argument_list|(
name|initial_count
argument_list|,
name|result_pool
argument_list|)
decl_stmt|;
name|changes
operator|->
name|builder
operator|=
name|svn_fs_x__string_table_builder_create
argument_list|(
name|result_pool
argument_list|)
expr_stmt|;
return|return
name|changes
return|;
block|}
end_function

begin_comment
comment|/* Add CHANGE to the latest change list in CHANGES.  */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|append_change
parameter_list|(
name|svn_fs_x__changes_t
modifier|*
name|changes
parameter_list|,
name|svn_fs_x__change_t
modifier|*
name|change
parameter_list|)
block|{
name|binary_change_t
name|binary_change
init|=
block|{
literal|0
block|}
decl_stmt|;
name|svn_boolean_t
name|is_txn_id
decl_stmt|;
comment|/* CHANGE must be sufficiently complete */
name|SVN_ERR_ASSERT
argument_list|(
name|change
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|change
operator|->
name|path
operator|.
name|data
argument_list|)
expr_stmt|;
comment|/* Relevant parts of the revision ID of the change. */
name|binary_change
operator|.
name|noderev_id
operator|=
name|change
operator|->
name|noderev_id
expr_stmt|;
comment|/* define the kind of change and what specific information is present */
name|is_txn_id
operator|=
name|svn_fs_x__is_txn
argument_list|(
name|binary_change
operator|.
name|noderev_id
operator|.
name|change_set
argument_list|)
expr_stmt|;
name|binary_change
operator|.
name|flags
operator|=
operator|(
name|change
operator|->
name|text_mod
condition|?
name|CHANGE_TEXT_MOD
else|:
literal|0
operator|)
operator||
operator|(
name|change
operator|->
name|prop_mod
condition|?
name|CHANGE_PROP_MOD
else|:
literal|0
operator|)
operator||
operator|(
name|is_txn_id
condition|?
name|CHANGE_TXN_NODE
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|int
operator|)
name|change
operator|->
name|change_kind
operator|<<
name|CHANGE_KIND_SHIFT
operator|)
operator||
operator|(
operator|(
name|int
operator|)
name|change
operator|->
name|node_kind
operator|<<
name|CHANGE_NODE_SHIFT
operator|)
expr_stmt|;
comment|/* Path of the change. */
name|binary_change
operator|.
name|path
operator|=
name|svn_fs_x__string_table_builder_add
argument_list|(
name|changes
operator|->
name|builder
argument_list|,
name|change
operator|->
name|path
operator|.
name|data
argument_list|,
name|change
operator|->
name|path
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* copy-from information, if presence is indicated by FLAGS */
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|change
operator|->
name|copyfrom_rev
argument_list|)
condition|)
block|{
name|binary_change
operator|.
name|copyfrom_rev
operator|=
name|change
operator|->
name|copyfrom_rev
expr_stmt|;
name|binary_change
operator|.
name|copyfrom_path
operator|=
name|svn_fs_x__string_table_builder_add
argument_list|(
name|changes
operator|->
name|builder
argument_list|,
name|change
operator|->
name|copyfrom_path
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|binary_change
operator|.
name|copyfrom_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|binary_change
operator|.
name|copyfrom_path
operator|=
literal|0
expr_stmt|;
block|}
name|APR_ARRAY_PUSH
argument_list|(
name|changes
operator|->
name|changes
argument_list|,
name|binary_change_t
argument_list|)
operator|=
name|binary_change
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__changes_append_list
parameter_list|(
name|apr_size_t
modifier|*
name|list_index
parameter_list|,
name|svn_fs_x__changes_t
modifier|*
name|changes
parameter_list|,
name|apr_array_header_t
modifier|*
name|list
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* CHANGES must be in 'builder' mode */
name|SVN_ERR_ASSERT
argument_list|(
name|changes
operator|->
name|builder
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|changes
operator|->
name|paths
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* simply append the list and all changes */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|list
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
name|append_change
argument_list|(
name|changes
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|list
argument_list|,
name|i
argument_list|,
name|svn_fs_x__change_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
comment|/* terminate the list by storing the next changes offset */
name|APR_ARRAY_PUSH
argument_list|(
name|changes
operator|->
name|offsets
argument_list|,
name|int
argument_list|)
operator|=
name|changes
operator|->
name|changes
operator|->
name|nelts
expr_stmt|;
operator|*
name|list_index
operator|=
call|(
name|apr_size_t
call|)
argument_list|(
name|changes
operator|->
name|offsets
operator|->
name|nelts
operator|-
literal|2
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|apr_size_t
name|svn_fs_x__changes_estimate_size
parameter_list|(
specifier|const
name|svn_fs_x__changes_t
modifier|*
name|changes
parameter_list|)
block|{
comment|/* CHANGES must be in 'builder' mode */
if|if
condition|(
name|changes
operator|->
name|builder
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* string table code makes its own prediction,    * changes should be< 10 bytes each,    * some static overhead should be assumed */
return|return
name|svn_fs_x__string_table_builder_estimate_size
argument_list|(
name|changes
operator|->
name|builder
argument_list|)
operator|+
name|changes
operator|->
name|changes
operator|->
name|nelts
operator|*
literal|10
operator|+
literal|100
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__changes_get_list
parameter_list|(
name|apr_array_header_t
modifier|*
modifier|*
name|list
parameter_list|,
specifier|const
name|svn_fs_x__changes_t
modifier|*
name|changes
parameter_list|,
name|apr_size_t
name|idx
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|first
decl_stmt|;
name|int
name|last
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* CHANGES must be in 'finalized' mode */
name|SVN_ERR_ASSERT
argument_list|(
name|changes
operator|->
name|builder
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|changes
operator|->
name|paths
argument_list|)
expr_stmt|;
comment|/* validate index */
if|if
condition|(
name|idx
operator|+
literal|1
operator|>=
operator|(
name|apr_size_t
operator|)
name|changes
operator|->
name|offsets
operator|->
name|nelts
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CONTAINER_INDEX
argument_list|,
name|NULL
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
name|_
argument_list|(
literal|"Changes list index %%%s"
literal|" exceeds container size %%d"
argument_list|)
argument_list|,
name|APR_SIZE_T_FMT
argument_list|)
argument_list|,
name|idx
argument_list|,
name|changes
operator|->
name|offsets
operator|->
name|nelts
operator|-
literal|1
argument_list|)
return|;
comment|/* range of changes to return */
name|first
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|changes
operator|->
name|offsets
argument_list|,
operator|(
name|int
operator|)
name|idx
argument_list|,
name|int
argument_list|)
expr_stmt|;
name|last
operator|=
name|APR_ARRAY_IDX
argument_list|(
name|changes
operator|->
name|offsets
argument_list|,
operator|(
name|int
operator|)
name|idx
operator|+
literal|1
argument_list|,
name|int
argument_list|)
expr_stmt|;
comment|/* construct result */
operator|*
name|list
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
name|last
operator|-
name|first
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_fs_x__change_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|last
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|binary_change_t
modifier|*
name|binary_change
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|changes
operator|->
name|changes
argument_list|,
name|i
argument_list|,
name|binary_change_t
argument_list|)
decl_stmt|;
comment|/* convert BINARY_CHANGE into a standard FSX svn_fs_x__change_t */
name|svn_fs_x__change_t
modifier|*
name|change
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|change
argument_list|)
argument_list|)
decl_stmt|;
name|change
operator|->
name|path
operator|.
name|data
operator|=
name|svn_fs_x__string_table_get
argument_list|(
name|changes
operator|->
name|paths
argument_list|,
name|binary_change
operator|->
name|path
argument_list|,
operator|&
name|change
operator|->
name|path
operator|.
name|len
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|binary_change
operator|->
name|noderev_id
operator|.
name|change_set
operator|!=
name|SVN_FS_X__INVALID_CHANGE_SET
condition|)
name|change
operator|->
name|noderev_id
operator|=
name|binary_change
operator|->
name|noderev_id
expr_stmt|;
name|change
operator|->
name|change_kind
operator|=
call|(
name|svn_fs_path_change_kind_t
call|)
argument_list|(
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_KIND_MASK
operator|)
operator|>>
name|CHANGE_KIND_SHIFT
argument_list|)
expr_stmt|;
name|change
operator|->
name|text_mod
operator|=
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_TEXT_MOD
operator|)
operator|!=
literal|0
expr_stmt|;
name|change
operator|->
name|prop_mod
operator|=
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_PROP_MOD
operator|)
operator|!=
literal|0
expr_stmt|;
name|change
operator|->
name|node_kind
operator|=
call|(
name|svn_node_kind_t
call|)
argument_list|(
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_NODE_MASK
operator|)
operator|>>
name|CHANGE_NODE_SHIFT
argument_list|)
expr_stmt|;
name|change
operator|->
name|copyfrom_rev
operator|=
name|binary_change
operator|->
name|copyfrom_rev
expr_stmt|;
name|change
operator|->
name|copyfrom_known
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|binary_change
operator|->
name|copyfrom_rev
argument_list|)
condition|)
name|change
operator|->
name|copyfrom_path
operator|=
name|svn_fs_x__string_table_get
argument_list|(
name|changes
operator|->
name|paths
argument_list|,
name|binary_change
operator|->
name|copyfrom_path
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* add it to the result */
name|APR_ARRAY_PUSH
argument_list|(
operator|*
name|list
argument_list|,
name|svn_fs_x__change_t
operator|*
argument_list|)
operator|=
name|change
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__write_changes_container
parameter_list|(
name|svn_stream_t
modifier|*
name|stream
parameter_list|,
specifier|const
name|svn_fs_x__changes_t
modifier|*
name|changes
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|string_table_t
modifier|*
name|paths
init|=
name|changes
operator|->
name|paths
condition|?
name|changes
operator|->
name|paths
else|:
name|svn_fs_x__string_table_create
argument_list|(
name|changes
operator|->
name|builder
argument_list|,
name|scratch_pool
argument_list|)
decl_stmt|;
name|svn_packed__data_root_t
modifier|*
name|root
init|=
name|svn_packed__data_create_root
argument_list|(
name|scratch_pool
argument_list|)
decl_stmt|;
comment|/* one top-level stream for each array */
name|svn_packed__int_stream_t
modifier|*
name|offsets_stream
init|=
name|svn_packed__create_int_stream
argument_list|(
name|root
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
decl_stmt|;
name|svn_packed__int_stream_t
modifier|*
name|changes_stream
init|=
name|svn_packed__create_int_stream
argument_list|(
name|root
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
decl_stmt|;
comment|/* structure the CHANGES_STREAM such we can extract much of the redundancy    * from the binary_change_t structs */
name|svn_packed__create_int_substream
argument_list|(
name|changes_stream
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|svn_packed__create_int_substream
argument_list|(
name|changes_stream
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|svn_packed__create_int_substream
argument_list|(
name|changes_stream
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|svn_packed__create_int_substream
argument_list|(
name|changes_stream
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|svn_packed__create_int_substream
argument_list|(
name|changes_stream
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|svn_packed__create_int_substream
argument_list|(
name|changes_stream
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* serialize offsets array */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|changes
operator|->
name|offsets
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
name|svn_packed__add_uint
argument_list|(
name|offsets_stream
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|changes
operator|->
name|offsets
argument_list|,
name|i
argument_list|,
name|int
argument_list|)
argument_list|)
expr_stmt|;
comment|/* serialize changes array */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|changes
operator|->
name|changes
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|binary_change_t
modifier|*
name|change
init|=
operator|&
name|APR_ARRAY_IDX
argument_list|(
name|changes
operator|->
name|changes
argument_list|,
name|i
argument_list|,
name|binary_change_t
argument_list|)
decl_stmt|;
name|svn_packed__add_uint
argument_list|(
name|changes_stream
argument_list|,
name|change
operator|->
name|flags
argument_list|)
expr_stmt|;
name|svn_packed__add_uint
argument_list|(
name|changes_stream
argument_list|,
name|change
operator|->
name|path
argument_list|)
expr_stmt|;
name|svn_packed__add_int
argument_list|(
name|changes_stream
argument_list|,
name|change
operator|->
name|copyfrom_rev
argument_list|)
expr_stmt|;
name|svn_packed__add_uint
argument_list|(
name|changes_stream
argument_list|,
name|change
operator|->
name|copyfrom_path
argument_list|)
expr_stmt|;
name|svn_packed__add_int
argument_list|(
name|changes_stream
argument_list|,
name|change
operator|->
name|noderev_id
operator|.
name|change_set
argument_list|)
expr_stmt|;
name|svn_packed__add_uint
argument_list|(
name|changes_stream
argument_list|,
name|change
operator|->
name|noderev_id
operator|.
name|number
argument_list|)
expr_stmt|;
block|}
comment|/* write to disk */
name|SVN_ERR
argument_list|(
name|svn_fs_x__write_string_table
argument_list|(
name|stream
argument_list|,
name|paths
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_packed__data_write
argument_list|(
name|stream
argument_list|,
name|root
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__read_changes_container
parameter_list|(
name|svn_fs_x__changes_t
modifier|*
modifier|*
name|changes_p
parameter_list|,
name|svn_stream_t
modifier|*
name|stream
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|apr_size_t
name|i
decl_stmt|;
name|apr_size_t
name|count
decl_stmt|;
name|svn_fs_x__changes_t
modifier|*
name|changes
init|=
name|apr_pcalloc
argument_list|(
name|result_pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|changes
argument_list|)
argument_list|)
decl_stmt|;
name|svn_packed__data_root_t
modifier|*
name|root
decl_stmt|;
name|svn_packed__int_stream_t
modifier|*
name|offsets_stream
decl_stmt|;
name|svn_packed__int_stream_t
modifier|*
name|changes_stream
decl_stmt|;
comment|/* read from disk */
name|SVN_ERR
argument_list|(
name|svn_fs_x__read_string_table
argument_list|(
operator|&
name|changes
operator|->
name|paths
argument_list|,
name|stream
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_packed__data_read
argument_list|(
operator|&
name|root
argument_list|,
name|stream
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|offsets_stream
operator|=
name|svn_packed__first_int_stream
argument_list|(
name|root
argument_list|)
expr_stmt|;
name|changes_stream
operator|=
name|svn_packed__next_int_stream
argument_list|(
name|offsets_stream
argument_list|)
expr_stmt|;
comment|/* read offsets array */
name|count
operator|=
name|svn_packed__int_count
argument_list|(
name|offsets_stream
argument_list|)
expr_stmt|;
name|changes
operator|->
name|offsets
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
operator|(
name|int
operator|)
name|count
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
operator|++
name|i
control|)
name|APR_ARRAY_PUSH
argument_list|(
name|changes
operator|->
name|offsets
argument_list|,
name|int
argument_list|)
operator|=
operator|(
name|int
operator|)
name|svn_packed__get_uint
argument_list|(
name|offsets_stream
argument_list|)
expr_stmt|;
comment|/* read changes array */
name|count
operator|=
name|svn_packed__int_count
argument_list|(
name|svn_packed__first_int_substream
argument_list|(
name|changes_stream
argument_list|)
argument_list|)
expr_stmt|;
name|changes
operator|->
name|changes
operator|=
name|apr_array_make
argument_list|(
name|result_pool
argument_list|,
operator|(
name|int
operator|)
name|count
argument_list|,
sizeof|sizeof
argument_list|(
name|binary_change_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
operator|++
name|i
control|)
block|{
name|binary_change_t
name|change
decl_stmt|;
name|change
operator|.
name|flags
operator|=
operator|(
name|int
operator|)
name|svn_packed__get_uint
argument_list|(
name|changes_stream
argument_list|)
expr_stmt|;
name|change
operator|.
name|path
operator|=
operator|(
name|apr_size_t
operator|)
name|svn_packed__get_uint
argument_list|(
name|changes_stream
argument_list|)
expr_stmt|;
name|change
operator|.
name|copyfrom_rev
operator|=
operator|(
name|svn_revnum_t
operator|)
name|svn_packed__get_int
argument_list|(
name|changes_stream
argument_list|)
expr_stmt|;
name|change
operator|.
name|copyfrom_path
operator|=
operator|(
name|apr_size_t
operator|)
name|svn_packed__get_uint
argument_list|(
name|changes_stream
argument_list|)
expr_stmt|;
name|change
operator|.
name|noderev_id
operator|.
name|change_set
operator|=
name|svn_packed__get_int
argument_list|(
name|changes_stream
argument_list|)
expr_stmt|;
name|change
operator|.
name|noderev_id
operator|.
name|number
operator|=
name|svn_packed__get_uint
argument_list|(
name|changes_stream
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|changes
operator|->
name|changes
argument_list|,
name|binary_change_t
argument_list|)
operator|=
name|change
expr_stmt|;
block|}
operator|*
name|changes_p
operator|=
name|changes
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__serialize_changes_container
parameter_list|(
name|void
modifier|*
modifier|*
name|data
parameter_list|,
name|apr_size_t
modifier|*
name|data_len
parameter_list|,
name|void
modifier|*
name|in
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_fs_x__changes_t
modifier|*
name|changes
init|=
name|in
decl_stmt|;
name|svn_stringbuf_t
modifier|*
name|serialized
decl_stmt|;
comment|/* make a guesstimate on the size of the serialized data.  Erring on the    * low side will cause the serializer to re-alloc its buffer. */
name|apr_size_t
name|size
init|=
name|changes
operator|->
name|changes
operator|->
name|elt_size
operator|*
name|changes
operator|->
name|changes
operator|->
name|nelts
operator|+
name|changes
operator|->
name|offsets
operator|->
name|elt_size
operator|*
name|changes
operator|->
name|offsets
operator|->
name|nelts
operator|+
literal|10
operator|*
name|changes
operator|->
name|changes
operator|->
name|elt_size
operator|+
literal|100
decl_stmt|;
comment|/* serialize array header and all its elements */
name|svn_temp_serializer__context_t
modifier|*
name|context
init|=
name|svn_temp_serializer__init
argument_list|(
name|changes
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|changes
argument_list|)
argument_list|,
name|size
argument_list|,
name|pool
argument_list|)
decl_stmt|;
comment|/* serialize sub-structures */
name|svn_fs_x__serialize_string_table
argument_list|(
name|context
argument_list|,
operator|&
name|changes
operator|->
name|paths
argument_list|)
expr_stmt|;
name|svn_fs_x__serialize_apr_array
argument_list|(
name|context
argument_list|,
operator|&
name|changes
operator|->
name|changes
argument_list|)
expr_stmt|;
name|svn_fs_x__serialize_apr_array
argument_list|(
name|context
argument_list|,
operator|&
name|changes
operator|->
name|offsets
argument_list|)
expr_stmt|;
comment|/* return the serialized result */
name|serialized
operator|=
name|svn_temp_serializer__get
argument_list|(
name|context
argument_list|)
expr_stmt|;
operator|*
name|data
operator|=
name|serialized
operator|->
name|data
expr_stmt|;
operator|*
name|data_len
operator|=
name|serialized
operator|->
name|len
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__deserialize_changes_container
parameter_list|(
name|void
modifier|*
modifier|*
name|out
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|data_len
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_fs_x__changes_t
modifier|*
name|changes
init|=
operator|(
name|svn_fs_x__changes_t
operator|*
operator|)
name|data
decl_stmt|;
comment|/* de-serialize sub-structures */
name|svn_fs_x__deserialize_string_table
argument_list|(
name|changes
argument_list|,
operator|&
name|changes
operator|->
name|paths
argument_list|)
expr_stmt|;
name|svn_fs_x__deserialize_apr_array
argument_list|(
name|changes
argument_list|,
operator|&
name|changes
operator|->
name|changes
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_fs_x__deserialize_apr_array
argument_list|(
name|changes
argument_list|,
operator|&
name|changes
operator|->
name|offsets
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* done */
operator|*
name|out
operator|=
name|changes
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_fs_x__changes_get_list_func
parameter_list|(
name|void
modifier|*
modifier|*
name|out
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|apr_size_t
name|data_len
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|int
name|first
decl_stmt|;
name|int
name|last
decl_stmt|;
name|int
name|i
decl_stmt|;
name|apr_array_header_t
modifier|*
name|list
decl_stmt|;
name|apr_uint32_t
name|idx
init|=
operator|*
operator|(
name|apr_uint32_t
operator|*
operator|)
name|baton
decl_stmt|;
specifier|const
name|svn_fs_x__changes_t
modifier|*
name|container
init|=
name|data
decl_stmt|;
comment|/* resolve all the sub-container pointers we need */
specifier|const
name|string_table_t
modifier|*
name|paths
init|=
name|svn_temp_deserializer__ptr
argument_list|(
name|container
argument_list|,
operator|(
specifier|const
name|void
operator|*
specifier|const
operator|*
operator|)
operator|&
name|container
operator|->
name|paths
argument_list|)
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|serialized_offsets
init|=
name|svn_temp_deserializer__ptr
argument_list|(
name|container
argument_list|,
operator|(
specifier|const
name|void
operator|*
specifier|const
operator|*
operator|)
operator|&
name|container
operator|->
name|offsets
argument_list|)
decl_stmt|;
specifier|const
name|apr_array_header_t
modifier|*
name|serialized_changes
init|=
name|svn_temp_deserializer__ptr
argument_list|(
name|container
argument_list|,
operator|(
specifier|const
name|void
operator|*
specifier|const
operator|*
operator|)
operator|&
name|container
operator|->
name|changes
argument_list|)
decl_stmt|;
specifier|const
name|int
modifier|*
name|offsets
init|=
name|svn_temp_deserializer__ptr
argument_list|(
name|serialized_offsets
argument_list|,
operator|(
specifier|const
name|void
operator|*
specifier|const
operator|*
operator|)
operator|&
name|serialized_offsets
operator|->
name|elts
argument_list|)
decl_stmt|;
specifier|const
name|binary_change_t
modifier|*
name|changes
init|=
name|svn_temp_deserializer__ptr
argument_list|(
name|serialized_changes
argument_list|,
operator|(
specifier|const
name|void
operator|*
specifier|const
operator|*
operator|)
operator|&
name|serialized_changes
operator|->
name|elts
argument_list|)
decl_stmt|;
comment|/* validate index */
if|if
condition|(
name|idx
operator|+
literal|1
operator|>=
operator|(
name|apr_size_t
operator|)
name|serialized_offsets
operator|->
name|nelts
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_FS_CONTAINER_INDEX
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Changes list index %u exceeds container "
literal|"size %d"
argument_list|)
argument_list|,
operator|(
name|unsigned
operator|)
name|idx
argument_list|,
name|serialized_offsets
operator|->
name|nelts
operator|-
literal|1
argument_list|)
return|;
comment|/* range of changes to return */
name|first
operator|=
name|offsets
index|[
name|idx
index|]
expr_stmt|;
name|last
operator|=
name|offsets
index|[
name|idx
operator|+
literal|1
index|]
expr_stmt|;
comment|/* construct result */
name|list
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
name|last
operator|-
name|first
argument_list|,
sizeof|sizeof
argument_list|(
name|svn_fs_x__change_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|last
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|binary_change_t
modifier|*
name|binary_change
init|=
operator|&
name|changes
index|[
name|i
index|]
decl_stmt|;
comment|/* convert BINARY_CHANGE into a standard FSX svn_fs_x__change_t */
name|svn_fs_x__change_t
modifier|*
name|change
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|change
argument_list|)
argument_list|)
decl_stmt|;
name|change
operator|->
name|path
operator|.
name|data
operator|=
name|svn_fs_x__string_table_get_func
argument_list|(
name|paths
argument_list|,
name|binary_change
operator|->
name|path
argument_list|,
operator|&
name|change
operator|->
name|path
operator|.
name|len
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|change
operator|->
name|noderev_id
operator|=
name|binary_change
operator|->
name|noderev_id
expr_stmt|;
name|change
operator|->
name|change_kind
operator|=
call|(
name|svn_fs_path_change_kind_t
call|)
argument_list|(
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_KIND_MASK
operator|)
operator|>>
name|CHANGE_KIND_SHIFT
argument_list|)
expr_stmt|;
name|change
operator|->
name|text_mod
operator|=
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_TEXT_MOD
operator|)
operator|!=
literal|0
expr_stmt|;
name|change
operator|->
name|prop_mod
operator|=
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_PROP_MOD
operator|)
operator|!=
literal|0
expr_stmt|;
name|change
operator|->
name|node_kind
operator|=
call|(
name|svn_node_kind_t
call|)
argument_list|(
operator|(
name|binary_change
operator|->
name|flags
operator|&
name|CHANGE_NODE_MASK
operator|)
operator|>>
name|CHANGE_NODE_SHIFT
argument_list|)
expr_stmt|;
name|change
operator|->
name|copyfrom_rev
operator|=
name|binary_change
operator|->
name|copyfrom_rev
expr_stmt|;
name|change
operator|->
name|copyfrom_known
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|SVN_IS_VALID_REVNUM
argument_list|(
name|binary_change
operator|->
name|copyfrom_rev
argument_list|)
condition|)
name|change
operator|->
name|copyfrom_path
operator|=
name|svn_fs_x__string_table_get_func
argument_list|(
name|paths
argument_list|,
name|binary_change
operator|->
name|copyfrom_path
argument_list|,
name|NULL
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* add it to the result */
name|APR_ARRAY_PUSH
argument_list|(
name|list
argument_list|,
name|svn_fs_x__change_t
operator|*
argument_list|)
operator|=
name|change
expr_stmt|;
block|}
operator|*
name|out
operator|=
name|list
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * translate.c :  wc-specific eol/keyword substitution  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<apr_pools.h>
end_include

begin_include
include|#
directive|include
file|<apr_file_io.h>
end_include

begin_include
include|#
directive|include
file|<apr_strings.h>
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_subst.h"
end_include

begin_include
include|#
directive|include
file|"svn_io.h"
end_include

begin_include
include|#
directive|include
file|"svn_props.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"adm_files.h"
end_include

begin_include
include|#
directive|include
file|"translate.h"
end_include

begin_include
include|#
directive|include
file|"props.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_comment
comment|/* */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|read_handler_unsupported
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|apr_size_t
modifier|*
name|len
parameter_list|)
block|{
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|write_handler_unsupported
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|buffer
parameter_list|,
name|apr_size_t
modifier|*
name|len
parameter_list|)
block|{
name|SVN_ERR_MALFUNCTION
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__internal_translated_stream
parameter_list|(
name|svn_stream_t
modifier|*
modifier|*
name|stream
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|versioned_abspath
parameter_list|,
name|apr_uint32_t
name|flags
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_boolean_t
name|special
decl_stmt|;
name|svn_boolean_t
name|to_nf
init|=
name|flags
operator|&
name|SVN_WC_TRANSLATE_TO_NF
decl_stmt|;
name|svn_subst_eol_style_t
name|style
decl_stmt|;
specifier|const
name|char
modifier|*
name|eol
decl_stmt|;
name|apr_hash_t
modifier|*
name|keywords
decl_stmt|;
name|svn_boolean_t
name|repair_forced
init|=
name|flags
operator|&
name|SVN_WC_TRANSLATE_FORCE_EOL_REPAIR
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|versioned_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__get_translate_info
argument_list|(
operator|&
name|style
argument_list|,
operator|&
name|eol
argument_list|,
operator|&
name|keywords
argument_list|,
operator|&
name|special
argument_list|,
name|db
argument_list|,
name|versioned_abspath
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|special
condition|)
block|{
if|if
condition|(
name|to_nf
condition|)
return|return
name|svn_subst_read_specialfile
argument_list|(
name|stream
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
return|return
name|svn_subst_create_specialfile
argument_list|(
name|stream
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
return|;
block|}
if|if
condition|(
name|to_nf
condition|)
name|SVN_ERR
argument_list|(
name|svn_stream_open_readonly
argument_list|(
name|stream
argument_list|,
name|local_abspath
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
block|{
name|apr_file_t
modifier|*
name|file
decl_stmt|;
comment|/* We don't want the "open-exclusively" feature of the normal          svn_stream_open_writable interface. Do this manually. */
name|SVN_ERR
argument_list|(
name|svn_io_file_open
argument_list|(
operator|&
name|file
argument_list|,
name|local_abspath
argument_list|,
name|APR_CREATE
operator||
name|APR_WRITE
operator||
name|APR_BUFFERED
argument_list|,
name|APR_OS_DEFAULT
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|stream
operator|=
name|svn_stream_from_aprfile2
argument_list|(
name|file
argument_list|,
name|FALSE
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|svn_subst_translation_required
argument_list|(
name|style
argument_list|,
name|eol
argument_list|,
name|keywords
argument_list|,
name|special
argument_list|,
name|TRUE
argument_list|)
condition|)
block|{
if|if
condition|(
name|to_nf
condition|)
block|{
if|if
condition|(
name|style
operator|==
name|svn_subst_eol_style_native
condition|)
name|eol
operator|=
name|SVN_SUBST_NATIVE_EOL_STR
expr_stmt|;
elseif|else
if|if
condition|(
name|style
operator|==
name|svn_subst_eol_style_fixed
condition|)
name|repair_forced
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|style
operator|!=
name|svn_subst_eol_style_none
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_IO_UNKNOWN_EOL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
comment|/* Wrap the stream to translate to normal form */
operator|*
name|stream
operator|=
name|svn_subst_stream_translated
argument_list|(
operator|*
name|stream
argument_list|,
name|eol
argument_list|,
name|repair_forced
argument_list|,
name|keywords
argument_list|,
name|FALSE
comment|/* expand */
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* Enforce our contract. TO_NF streams are readonly */
name|svn_stream_set_write
argument_list|(
operator|*
name|stream
argument_list|,
name|write_handler_unsupported
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|stream
operator|=
name|svn_subst_stream_translated
argument_list|(
operator|*
name|stream
argument_list|,
name|eol
argument_list|,
name|TRUE
argument_list|,
name|keywords
argument_list|,
name|TRUE
argument_list|,
name|result_pool
argument_list|)
expr_stmt|;
comment|/* Enforce our contract. FROM_NF streams are write-only */
name|svn_stream_set_read
argument_list|(
operator|*
name|stream
argument_list|,
name|read_handler_unsupported
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__internal_translated_file
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|xlated_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|src_abspath
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|versioned_abspath
parameter_list|,
name|apr_uint32_t
name|flags
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_subst_eol_style_t
name|style
decl_stmt|;
specifier|const
name|char
modifier|*
name|eol
decl_stmt|;
name|apr_hash_t
modifier|*
name|keywords
decl_stmt|;
name|svn_boolean_t
name|special
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|src_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|versioned_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__get_translate_info
argument_list|(
operator|&
name|style
argument_list|,
operator|&
name|eol
argument_list|,
operator|&
name|keywords
argument_list|,
operator|&
name|special
argument_list|,
name|db
argument_list|,
name|versioned_abspath
argument_list|,
name|NULL
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|svn_subst_translation_required
argument_list|(
name|style
argument_list|,
name|eol
argument_list|,
name|keywords
argument_list|,
name|special
argument_list|,
name|TRUE
argument_list|)
operator|&&
operator|(
operator|!
operator|(
name|flags
operator|&
name|SVN_WC_TRANSLATE_FORCE_COPY
operator|)
operator|)
condition|)
block|{
comment|/* Translation would be a no-op, so return the original file. */
operator|*
name|xlated_abspath
operator|=
name|src_abspath
expr_stmt|;
block|}
else|else
comment|/* some translation (or copying) is necessary */
block|{
specifier|const
name|char
modifier|*
name|tmp_dir
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_vfile
decl_stmt|;
name|svn_boolean_t
name|repair_forced
init|=
operator|(
name|flags
operator|&
name|SVN_WC_TRANSLATE_FORCE_EOL_REPAIR
operator|)
operator|!=
literal|0
decl_stmt|;
name|svn_boolean_t
name|expand
init|=
operator|(
name|flags
operator|&
name|SVN_WC_TRANSLATE_TO_NF
operator|)
operator|==
literal|0
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|SVN_WC_TRANSLATE_USE_GLOBAL_TMP
condition|)
name|tmp_dir
operator|=
name|NULL
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_temp_wcroot_tempdir
argument_list|(
operator|&
name|tmp_dir
argument_list|,
name|db
argument_list|,
name|versioned_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_io_open_unique_file3
argument_list|(
name|NULL
argument_list|,
operator|&
name|tmp_vfile
argument_list|,
name|tmp_dir
argument_list|,
operator|(
name|flags
operator|&
name|SVN_WC_TRANSLATE_NO_OUTPUT_CLEANUP
operator|)
condition|?
name|svn_io_file_del_none
else|:
name|svn_io_file_del_on_pool_cleanup
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ### ugh. the repair behavior does NOT match the docstring. bleah.          ### all of these translation functions are crap and should go          ### away anyways. we'll just deprecate most of the functions and          ### properly document the survivors */
if|if
condition|(
name|expand
condition|)
block|{
comment|/* from normal form */
name|repair_forced
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
comment|/* to normal form */
if|if
condition|(
name|style
operator|==
name|svn_subst_eol_style_native
condition|)
name|eol
operator|=
name|SVN_SUBST_NATIVE_EOL_STR
expr_stmt|;
elseif|else
if|if
condition|(
name|style
operator|==
name|svn_subst_eol_style_fixed
condition|)
name|repair_forced
operator|=
name|TRUE
expr_stmt|;
elseif|else
if|if
condition|(
name|style
operator|!=
name|svn_subst_eol_style_none
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_IO_UNKNOWN_EOL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
name|SVN_ERR
argument_list|(
name|svn_subst_copy_and_translate4
argument_list|(
name|src_abspath
argument_list|,
name|tmp_vfile
argument_list|,
name|eol
argument_list|,
name|repair_forced
argument_list|,
name|keywords
argument_list|,
name|expand
argument_list|,
name|special
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|xlated_abspath
operator|=
name|tmp_vfile
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|void
name|svn_wc__eol_value_from_string
parameter_list|(
specifier|const
name|char
modifier|*
modifier|*
name|value
parameter_list|,
specifier|const
name|char
modifier|*
name|eol
parameter_list|)
block|{
if|if
condition|(
name|eol
operator|==
name|NULL
condition|)
operator|*
name|value
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
literal|"\n"
argument_list|,
name|eol
argument_list|)
condition|)
operator|*
name|value
operator|=
literal|"LF"
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
literal|"\r"
argument_list|,
name|eol
argument_list|)
condition|)
operator|*
name|value
operator|=
literal|"CR"
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
literal|"\r\n"
argument_list|,
name|eol
argument_list|)
condition|)
operator|*
name|value
operator|=
literal|"CRLF"
expr_stmt|;
else|else
operator|*
name|value
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__get_translate_info
parameter_list|(
name|svn_subst_eol_style_t
modifier|*
name|style
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|eol
parameter_list|,
name|apr_hash_t
modifier|*
modifier|*
name|keywords
parameter_list|,
name|svn_boolean_t
modifier|*
name|special
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_hash_t
modifier|*
name|props
parameter_list|,
name|svn_boolean_t
name|for_normalization
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|propval
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|props
operator|==
name|NULL
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__get_actual_props
argument_list|(
operator|&
name|props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eol
condition|)
block|{
name|propval
operator|=
name|svn_prop_get_value
argument_list|(
name|props
argument_list|,
name|SVN_PROP_EOL_STYLE
argument_list|)
expr_stmt|;
name|svn_subst_eol_style_from_value
argument_list|(
name|style
argument_list|,
name|eol
argument_list|,
name|propval
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|keywords
condition|)
block|{
name|propval
operator|=
name|svn_prop_get_value
argument_list|(
name|props
argument_list|,
name|SVN_PROP_KEYWORDS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|propval
operator|||
operator|*
name|propval
operator|==
literal|'\0'
condition|)
operator|*
name|keywords
operator|=
name|NULL
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__expand_keywords
argument_list|(
name|keywords
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|NULL
argument_list|,
name|propval
argument_list|,
name|for_normalization
argument_list|,
name|result_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|special
condition|)
block|{
name|propval
operator|=
name|svn_prop_get_value
argument_list|(
name|props
argument_list|,
name|SVN_PROP_SPECIAL
argument_list|)
expr_stmt|;
operator|*
name|special
operator|=
operator|(
name|propval
operator|!=
name|NULL
operator|)
expr_stmt|;
block|}
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__expand_keywords
parameter_list|(
name|apr_hash_t
modifier|*
modifier|*
name|keywords
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|wri_abspath
parameter_list|,
specifier|const
name|char
modifier|*
name|keyword_list
parameter_list|,
name|svn_boolean_t
name|for_normalization
parameter_list|,
name|apr_pool_t
modifier|*
name|result_pool
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_revnum_t
name|changed_rev
decl_stmt|;
name|apr_time_t
name|changed_date
decl_stmt|;
specifier|const
name|char
modifier|*
name|changed_author
decl_stmt|;
specifier|const
name|char
modifier|*
name|url
decl_stmt|;
specifier|const
name|char
modifier|*
name|repos_root_url
decl_stmt|;
if|if
condition|(
operator|!
name|for_normalization
condition|)
block|{
specifier|const
name|char
modifier|*
name|repos_relpath
decl_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|repos_relpath
argument_list|,
operator|&
name|repos_root_url
argument_list|,
name|NULL
argument_list|,
operator|&
name|changed_rev
argument_list|,
operator|&
name|changed_date
argument_list|,
operator|&
name|changed_author
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|repos_relpath
condition|)
name|url
operator|=
name|svn_path_url_add_component2
argument_list|(
name|repos_root_url
argument_list|,
name|repos_relpath
argument_list|,
name|scratch_pool
argument_list|)
expr_stmt|;
else|else
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_url
argument_list|(
operator|&
name|url
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|url
operator|=
literal|""
expr_stmt|;
name|changed_rev
operator|=
name|SVN_INVALID_REVNUM
expr_stmt|;
name|changed_date
operator|=
literal|0
expr_stmt|;
name|changed_author
operator|=
literal|""
expr_stmt|;
name|repos_root_url
operator|=
literal|""
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_subst_build_keywords3
argument_list|(
name|keywords
argument_list|,
name|keyword_list
argument_list|,
name|apr_psprintf
argument_list|(
name|scratch_pool
argument_list|,
literal|"%ld"
argument_list|,
name|changed_rev
argument_list|)
argument_list|,
name|url
argument_list|,
name|repos_root_url
argument_list|,
name|changed_date
argument_list|,
name|changed_author
argument_list|,
name|result_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|apr_hash_count
argument_list|(
operator|*
name|keywords
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|keywords
operator|=
name|NULL
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc__sync_flags_with_props
parameter_list|(
name|svn_boolean_t
modifier|*
name|did_set
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_status_t
name|status
decl_stmt|;
name|svn_node_kind_t
name|kind
decl_stmt|;
name|svn_wc__db_lock_t
modifier|*
name|lock
decl_stmt|;
name|apr_hash_t
modifier|*
name|props
init|=
name|NULL
decl_stmt|;
name|svn_boolean_t
name|had_props
decl_stmt|;
name|svn_boolean_t
name|props_mod
decl_stmt|;
if|if
condition|(
name|did_set
condition|)
operator|*
name|did_set
operator|=
name|FALSE
expr_stmt|;
comment|/* ### We'll consolidate these info gathering statements in a future          commit. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_info
argument_list|(
operator|&
name|status
argument_list|,
operator|&
name|kind
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|lock
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|had_props
argument_list|,
operator|&
name|props_mod
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We actually only care about the following flags on files, so just      early-out for all other types.       Also bail if there is no in-wc representation of the file. */
if|if
condition|(
name|kind
operator|!=
name|svn_node_file
operator|||
operator|(
name|status
operator|!=
name|svn_wc__db_status_normal
operator|&&
name|status
operator|!=
name|svn_wc__db_status_added
operator|)
condition|)
return|return
name|SVN_NO_ERROR
return|;
if|if
condition|(
name|props_mod
operator|||
name|had_props
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_props
argument_list|(
operator|&
name|props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|props
operator|=
name|NULL
expr_stmt|;
comment|/* If we get this far, we're going to change *something*, so just set      the flag appropriately. */
if|if
condition|(
name|did_set
condition|)
operator|*
name|did_set
operator|=
name|TRUE
expr_stmt|;
comment|/* Handle the read-write bit. */
if|if
condition|(
name|status
operator|!=
name|svn_wc__db_status_normal
operator|||
name|props
operator|==
name|NULL
operator|||
operator|!
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_NEEDS_LOCK
argument_list|)
operator|||
name|lock
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_io_set_file_read_write
argument_list|(
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Special case: If we have an uncommitted svn:needs-lock, we don't          set the file read_only just yet.  That happens upon commit. */
name|apr_hash_t
modifier|*
name|pristine_props
decl_stmt|;
if|if
condition|(
operator|!
name|props_mod
condition|)
name|pristine_props
operator|=
name|props
expr_stmt|;
elseif|else
if|if
condition|(
name|had_props
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_read_pristine_props
argument_list|(
operator|&
name|pristine_props
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|pristine_props
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|pristine_props
operator|&&
name|svn_hash_gets
argument_list|(
name|pristine_props
argument_list|,
name|SVN_PROP_NEEDS_LOCK
argument_list|)
condition|)
comment|/*&& props&& apr_hash_get(props, SVN_PROP_NEEDS_LOCK, APR_HASH_KEY_STRING) )*/
name|SVN_ERR
argument_list|(
name|svn_io_set_file_read_only
argument_list|(
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Windows doesn't care about the execute bit. */
ifndef|#
directive|ifndef
name|WIN32
if|if
condition|(
name|props
operator|==
name|NULL
operator|||
operator|!
name|svn_hash_gets
argument_list|(
name|props
argument_list|,
name|SVN_PROP_EXECUTABLE
argument_list|)
condition|)
block|{
comment|/* Turn off the execute bit */
name|SVN_ERR
argument_list|(
name|svn_io_set_file_executable
argument_list|(
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_io_set_file_executable
argument_list|(
name|local_abspath
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


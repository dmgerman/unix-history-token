begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * cleanup.c:  handle cleaning up workqueue items  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_escape
end_escape

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"svn_wc.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_io.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"wc.h"
end_include

begin_include
include|#
directive|include
file|"adm_files.h"
end_include

begin_include
include|#
directive|include
file|"lock.h"
end_include

begin_include
include|#
directive|include
file|"workqueue.h"
end_include

begin_include
include|#
directive|include
file|"private/svn_wc_private.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_escape
end_escape

begin_comment
comment|/*** Recursively do log things. ***/
end_comment

begin_comment
comment|/* */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|can_be_cleaned
parameter_list|(
name|int
modifier|*
name|wc_format
parameter_list|,
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|SVN_ERR
argument_list|(
name|svn_wc__internal_check_wc
argument_list|(
name|wc_format
argument_list|,
name|db
argument_list|,
name|local_abspath
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* a "version" of 0 means a non-wc directory */
if|if
condition|(
operator|*
name|wc_format
operator|==
literal|0
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_WC_NOT_WORKING_COPY
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'%s' is not a working copy directory"
argument_list|)
argument_list|,
name|svn_dirent_local_style
argument_list|(
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
return|;
if|if
condition|(
operator|*
name|wc_format
operator|<
name|SVN_WC__WC_NG_VERSION
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_WC_UNSUPPORTED_FORMAT
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Log format too old, please use "
literal|"Subversion 1.6 or earlier"
argument_list|)
argument_list|)
return|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* Dummy svn_wc_status_func4_t implementation */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|status_dummy_callback
parameter_list|(
name|void
modifier|*
name|baton
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
specifier|const
name|svn_wc_status3_t
modifier|*
name|status
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_comment
comment|/* */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|cleanup_internal
parameter_list|(
name|svn_wc__db_t
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|dir_abspath
parameter_list|,
name|svn_boolean_t
name|break_locks
parameter_list|,
name|svn_boolean_t
name|fix_recorded_timestamps
parameter_list|,
name|svn_boolean_t
name|vacuum_pristines
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|int
name|wc_format
decl_stmt|;
name|svn_boolean_t
name|is_wcroot
decl_stmt|;
specifier|const
name|char
modifier|*
name|lock_abspath
decl_stmt|;
comment|/* Can we even work with this directory?  */
name|SVN_ERR
argument_list|(
name|can_be_cleaned
argument_list|(
operator|&
name|wc_format
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We cannot obtain a lock on a directory that's within a locked      subtree, so always run cleanup from the lock owner. */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wclock_find_root
argument_list|(
operator|&
name|lock_abspath
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lock_abspath
condition|)
name|dir_abspath
operator|=
name|lock_abspath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_wclock_obtain
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
operator|-
literal|1
argument_list|,
name|break_locks
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Run our changes before the subdirectories. We may not have to recurse      if we blow away a subdir.  */
if|if
condition|(
name|wc_format
operator|>=
name|SVN_WC__HAS_WORK_QUEUE
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__wq_run
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_is_wcroot
argument_list|(
operator|&
name|is_wcroot
argument_list|,
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SVN_DEBUG
name|SVN_ERR
argument_list|(
name|svn_wc__db_verify
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Perform these operations if we lock the entire working copy.      Note that we really need to check a wcroot value and not      svn_wc__check_wcroot() as that function, will just return true      once we start sharing databases with externals.    */
if|if
condition|(
name|is_wcroot
operator|&&
name|vacuum_pristines
condition|)
block|{
comment|/* Cleanup the tmp area of the admin subdir, if running the log has not        removed it!  The logs have been run, so anything left here has no hope        of being useful. */
name|SVN_ERR
argument_list|(
name|svn_wc__adm_cleanup_tmp_area
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Remove unreferenced pristine texts */
name|SVN_ERR
argument_list|(
name|svn_wc__db_pristine_cleanup
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fix_recorded_timestamps
condition|)
block|{
comment|/* Instead of implementing a separate repair step here, use the standard          status walker's optimized implementation, which performs repairs when          there is a lock. */
name|SVN_ERR
argument_list|(
name|svn_wc__internal_walk_status
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|svn_depth_infinity
argument_list|,
name|FALSE
comment|/* get_all */
argument_list|,
name|FALSE
comment|/* no_ignore */
argument_list|,
name|FALSE
comment|/* ignore_text_mods */
argument_list|,
name|NULL
comment|/* ignore patterns */
argument_list|,
name|status_dummy_callback
argument_list|,
name|NULL
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* All done, toss the lock */
name|SVN_ERR
argument_list|(
name|svn_wc__db_wclock_release
argument_list|(
name|db
argument_list|,
name|dir_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

begin_function
name|svn_error_t
modifier|*
name|svn_wc_cleanup4
parameter_list|(
name|svn_wc_context_t
modifier|*
name|wc_ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|local_abspath
parameter_list|,
name|svn_boolean_t
name|break_locks
parameter_list|,
name|svn_boolean_t
name|fix_recorded_timestamps
parameter_list|,
name|svn_boolean_t
name|clear_dav_cache
parameter_list|,
name|svn_boolean_t
name|vacuum_pristines
parameter_list|,
name|svn_cancel_func_t
name|cancel_func
parameter_list|,
name|void
modifier|*
name|cancel_baton
parameter_list|,
name|svn_wc_notify_func2_t
name|notify_func
parameter_list|,
name|void
modifier|*
name|notify_baton
parameter_list|,
name|apr_pool_t
modifier|*
name|scratch_pool
parameter_list|)
block|{
name|svn_wc__db_t
modifier|*
name|db
decl_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|svn_dirent_is_absolute
argument_list|(
name|local_abspath
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR_ASSERT
argument_list|(
name|wc_ctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|break_locks
condition|)
block|{
comment|/* We'll handle everything manually.  */
comment|/* Close the existing database (if any) to avoid problems with          exclusive database usage */
name|SVN_ERR
argument_list|(
name|svn_wc__db_drop_root
argument_list|(
name|wc_ctx
operator|->
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_wc__db_open
argument_list|(
operator|&
name|db
argument_list|,
name|NULL
comment|/* ### config */
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|scratch_pool
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|db
operator|=
name|wc_ctx
operator|->
name|db
expr_stmt|;
name|SVN_ERR
argument_list|(
name|cleanup_internal
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|break_locks
argument_list|,
name|fix_recorded_timestamps
argument_list|,
name|vacuum_pristines
argument_list|,
name|cancel_func
argument_list|,
name|cancel_baton
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* The DAV cache suffers from flakiness from time to time, and the      pre-1.7 prescribed workarounds aren't as user-friendly in WC-NG. */
if|if
condition|(
name|clear_dav_cache
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_base_clear_dav_cache_recursive
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vacuum_pristines
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_vacuum
argument_list|(
name|db
argument_list|,
name|local_abspath
argument_list|,
name|scratch_pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* We're done with this DB, so proactively close it.  */
if|if
condition|(
name|break_locks
condition|)
name|SVN_ERR
argument_list|(
name|svn_wc__db_close
argument_list|(
name|db
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


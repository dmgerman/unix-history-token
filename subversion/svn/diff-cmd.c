begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * diff-cmd.c -- Display context diff of a file  *  * ====================================================================  *    Licensed to the Apache Software Foundation (ASF) under one  *    or more contributor license agreements.  See the NOTICE file  *    distributed with this work for additional information  *    regarding copyright ownership.  The ASF licenses this file  *    to you under the Apache License, Version 2.0 (the  *    "License"); you may not use this file except in compliance  *    with the License.  You may obtain a copy of the License at  *  *      http://www.apache.org/licenses/LICENSE-2.0  *  *    Unless required by applicable law or agreed to in writing,  *    software distributed under the License is distributed on an  *    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *    KIND, either express or implied.  See the License for the  *    specific language governing permissions and limitations  *    under the License.  * ====================================================================  */
end_comment

begin_comment
comment|/* ==================================================================== */
end_comment

begin_escape
end_escape

begin_comment
comment|/*** Includes. ***/
end_comment

begin_include
include|#
directive|include
file|"svn_pools.h"
end_include

begin_include
include|#
directive|include
file|"svn_client.h"
end_include

begin_include
include|#
directive|include
file|"svn_string.h"
end_include

begin_include
include|#
directive|include
file|"svn_dirent_uri.h"
end_include

begin_include
include|#
directive|include
file|"svn_path.h"
end_include

begin_include
include|#
directive|include
file|"svn_error_codes.h"
end_include

begin_include
include|#
directive|include
file|"svn_error.h"
end_include

begin_include
include|#
directive|include
file|"svn_types.h"
end_include

begin_include
include|#
directive|include
file|"svn_cmdline.h"
end_include

begin_include
include|#
directive|include
file|"svn_xml.h"
end_include

begin_include
include|#
directive|include
file|"svn_hash.h"
end_include

begin_include
include|#
directive|include
file|"cl.h"
end_include

begin_include
include|#
directive|include
file|"svn_private_config.h"
end_include

begin_escape
end_escape

begin_comment
comment|/*** Code. ***/
end_comment

begin_comment
comment|/* Convert KIND into a single character for display to the user. */
end_comment

begin_function
specifier|static
name|char
name|kind_to_char
parameter_list|(
name|svn_client_diff_summarize_kind_t
name|kind
parameter_list|)
block|{
switch|switch
condition|(
name|kind
condition|)
block|{
case|case
name|svn_client_diff_summarize_kind_modified
case|:
return|return
literal|'M'
return|;
case|case
name|svn_client_diff_summarize_kind_added
case|:
return|return
literal|'A'
return|;
case|case
name|svn_client_diff_summarize_kind_deleted
case|:
return|return
literal|'D'
return|;
default|default:
return|return
literal|' '
return|;
block|}
block|}
end_function

begin_comment
comment|/* Convert KIND into a word describing the kind to the user. */
end_comment

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|kind_to_word
parameter_list|(
name|svn_client_diff_summarize_kind_t
name|kind
parameter_list|)
block|{
switch|switch
condition|(
name|kind
condition|)
block|{
case|case
name|svn_client_diff_summarize_kind_modified
case|:
return|return
literal|"modified"
return|;
case|case
name|svn_client_diff_summarize_kind_added
case|:
return|return
literal|"added"
return|;
case|case
name|svn_client_diff_summarize_kind_deleted
case|:
return|return
literal|"deleted"
return|;
default|default:
return|return
literal|"none"
return|;
block|}
block|}
end_function

begin_comment
comment|/* Baton for summarize_xml and summarize_regular */
end_comment

begin_struct
struct|struct
name|summarize_baton_t
block|{
specifier|const
name|char
modifier|*
name|anchor
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Print summary information about a given change as XML, implements the  * svn_client_diff_summarize_func_t interface. The @a baton is a 'char *'  * representing the either the path to the working copy root or the url  * the path the working copy root corresponds to. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|summarize_xml
parameter_list|(
specifier|const
name|svn_client_diff_summarize_t
modifier|*
name|summary
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|summarize_baton_t
modifier|*
name|b
init|=
name|baton
decl_stmt|;
comment|/* Full path to the object being diffed.  This is created by taking the    * baton, and appending the target's relative path. */
specifier|const
name|char
modifier|*
name|path
init|=
name|b
operator|->
name|anchor
decl_stmt|;
name|svn_stringbuf_t
modifier|*
name|sb
init|=
name|svn_stringbuf_create_empty
argument_list|(
name|pool
argument_list|)
decl_stmt|;
comment|/* Tack on the target path, so we can differentiate between different parts    * of the output when we're given multiple targets. */
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|path
operator|=
name|svn_path_url_add_component2
argument_list|(
name|path
argument_list|,
name|summary
operator|->
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|path
operator|=
name|svn_dirent_join
argument_list|(
name|path
argument_list|,
name|summary
operator|->
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* Convert non-urls to local style, so that things like ""          show up as "." */
name|path
operator|=
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
name|svn_xml_make_open_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
name|svn_xml_protect_pcdata
argument_list|,
literal|"path"
argument_list|,
literal|"kind"
argument_list|,
name|svn_cl__node_kind_str_xml
argument_list|(
name|summary
operator|->
name|node_kind
argument_list|)
argument_list|,
literal|"item"
argument_list|,
name|kind_to_word
argument_list|(
name|summary
operator|->
name|summarize_kind
argument_list|)
argument_list|,
literal|"props"
argument_list|,
name|summary
operator|->
name|prop_changed
condition|?
literal|"modified"
else|:
literal|"none"
argument_list|,
name|SVN_VA_NULL
argument_list|)
expr_stmt|;
name|svn_xml_escape_cdata_cstring
argument_list|(
operator|&
name|sb
argument_list|,
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
literal|"path"
argument_list|)
expr_stmt|;
return|return
name|svn_cl__error_checked_fputs
argument_list|(
name|sb
operator|->
name|data
argument_list|,
name|stdout
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Print summary information about a given change, implements the  * svn_client_diff_summarize_func_t interface. */
end_comment

begin_function
specifier|static
name|svn_error_t
modifier|*
name|summarize_regular
parameter_list|(
specifier|const
name|svn_client_diff_summarize_t
modifier|*
name|summary
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|struct
name|summarize_baton_t
modifier|*
name|b
init|=
name|baton
decl_stmt|;
specifier|const
name|char
modifier|*
name|path
init|=
name|b
operator|->
name|anchor
decl_stmt|;
comment|/* Tack on the target path, so we can differentiate between different parts    * of the output when we're given multiple targets. */
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|path
operator|=
name|svn_path_url_add_component2
argument_list|(
name|path
argument_list|,
name|summary
operator|->
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|path
operator|=
name|svn_dirent_join
argument_list|(
name|path
argument_list|,
name|summary
operator|->
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
comment|/* Convert non-urls to local style, so that things like ""          show up as "." */
name|path
operator|=
name|svn_dirent_local_style
argument_list|(
name|path
argument_list|,
name|pool
argument_list|)
expr_stmt|;
block|}
comment|/* Note: This output format tries to look like the output of 'svn status',    *       thus the blank spaces where information that is not relevant to    *       a diff summary would go. */
name|SVN_ERR
argument_list|(
name|svn_cmdline_printf
argument_list|(
name|pool
argument_list|,
literal|"%c%c      %s\n"
argument_list|,
name|kind_to_char
argument_list|(
name|summary
operator|->
name|summarize_kind
argument_list|)
argument_list|,
name|summary
operator|->
name|prop_changed
condition|?
literal|'M'
else|:
literal|' '
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|svn_cmdline_fflush
argument_list|(
name|stdout
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* An svn_opt_subcommand_t to handle the 'diff' command.    This implements the `svn_opt_subcommand_t' interface. */
end_comment

begin_function
name|svn_error_t
modifier|*
name|svn_cl__diff
parameter_list|(
name|apr_getopt_t
modifier|*
name|os
parameter_list|,
name|void
modifier|*
name|baton
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|svn_cl__opt_state_t
modifier|*
name|opt_state
init|=
operator|(
operator|(
name|svn_cl__cmd_baton_t
operator|*
operator|)
name|baton
operator|)
operator|->
name|opt_state
decl_stmt|;
name|svn_client_ctx_t
modifier|*
name|ctx
init|=
operator|(
operator|(
name|svn_cl__cmd_baton_t
operator|*
operator|)
name|baton
operator|)
operator|->
name|ctx
decl_stmt|;
name|apr_array_header_t
modifier|*
name|options
decl_stmt|;
name|apr_array_header_t
modifier|*
name|targets
decl_stmt|;
name|svn_stream_t
modifier|*
name|outstream
decl_stmt|;
name|svn_stream_t
modifier|*
name|errstream
decl_stmt|;
specifier|const
name|char
modifier|*
name|old_target
decl_stmt|,
modifier|*
name|new_target
decl_stmt|;
name|apr_pool_t
modifier|*
name|iterpool
decl_stmt|;
name|svn_boolean_t
name|pegged_diff
init|=
name|FALSE
decl_stmt|;
name|svn_boolean_t
name|ignore_content_type
decl_stmt|;
name|svn_boolean_t
name|show_copies_as_adds
init|=
name|opt_state
operator|->
name|diff
operator|.
name|patch_compatible
operator|||
name|opt_state
operator|->
name|diff
operator|.
name|show_copies_as_adds
decl_stmt|;
name|svn_boolean_t
name|ignore_properties
init|=
name|opt_state
operator|->
name|diff
operator|.
name|patch_compatible
operator|||
name|opt_state
operator|->
name|diff
operator|.
name|ignore_properties
decl_stmt|;
name|int
name|i
decl_stmt|;
name|struct
name|summarize_baton_t
name|summarize_baton
decl_stmt|;
specifier|const
name|svn_client_diff_summarize_func_t
name|summarize_func
init|=
operator|(
name|opt_state
operator|->
name|xml
condition|?
name|summarize_xml
else|:
name|summarize_regular
operator|)
decl_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|extensions
condition|)
name|options
operator|=
name|svn_cstring_split
argument_list|(
name|opt_state
operator|->
name|extensions
argument_list|,
literal|" \t\n\r"
argument_list|,
name|TRUE
argument_list|,
name|pool
argument_list|)
expr_stmt|;
else|else
name|options
operator|=
name|NULL
expr_stmt|;
comment|/* Get streams representing stdout and stderr, which is where      we'll have the external 'diff' program print to. */
name|SVN_ERR
argument_list|(
name|svn_stream_for_stdout
argument_list|(
operator|&
name|outstream
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_stream_for_stderr
argument_list|(
operator|&
name|errstream
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|xml
condition|)
block|{
name|svn_stringbuf_t
modifier|*
name|sb
decl_stmt|;
comment|/* Check that the --summarize is passed as well. */
if|if
condition|(
operator|!
name|opt_state
operator|->
name|diff
operator|.
name|summarize
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_CL_ARG_PARSING_ERROR
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'--xml' option only valid with "
literal|"'--summarize' option"
argument_list|)
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_cl__xml_print_header
argument_list|(
literal|"diff"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|sb
operator|=
name|svn_stringbuf_create_empty
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|svn_xml_make_open_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
name|svn_xml_normal
argument_list|,
literal|"paths"
argument_list|,
name|SVN_VA_NULL
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__error_checked_fputs
argument_list|(
name|sb
operator|->
name|data
argument_list|,
name|stdout
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|SVN_ERR
argument_list|(
name|svn_cl__args_to_target_array_print_reserved
argument_list|(
operator|&
name|targets
argument_list|,
name|os
argument_list|,
name|opt_state
operator|->
name|targets
argument_list|,
name|ctx
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|opt_state
operator|->
name|old_target
operator|&&
operator|!
name|opt_state
operator|->
name|new_target
operator|&&
operator|(
name|targets
operator|->
name|nelts
operator|==
literal|2
operator|)
operator|&&
operator|(
name|svn_path_is_url
argument_list|(
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
literal|0
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
operator|||
name|svn_path_is_url
argument_list|(
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
literal|1
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
operator|)
operator|&&
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
operator|&&
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
block|{
comment|/* A 2-target diff where one or both targets are URLs. These are        * shorthands for some 'svn diff --old X --new Y' invocations. */
name|SVN_ERR
argument_list|(
name|svn_opt_parse_path
argument_list|(
operator|&
name|opt_state
operator|->
name|start_revision
argument_list|,
operator|&
name|old_target
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
literal|0
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_opt_parse_path
argument_list|(
operator|&
name|opt_state
operator|->
name|end_revision
argument_list|,
operator|&
name|new_target
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
literal|1
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
name|targets
operator|->
name|nelts
operator|=
literal|0
expr_stmt|;
comment|/* Set default start/end revisions based on target types, in the same        * manner as done for the corresponding '--old X --new Y' cases,        * (note that we have an explicit --new target) */
if|if
condition|(
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|=
name|svn_path_is_url
argument_list|(
name|old_target
argument_list|)
condition|?
name|svn_opt_revision_head
else|:
name|svn_opt_revision_working
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|=
name|svn_path_is_url
argument_list|(
name|new_target
argument_list|)
condition|?
name|svn_opt_revision_head
else|:
name|svn_opt_revision_working
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opt_state
operator|->
name|old_target
condition|)
block|{
name|apr_array_header_t
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|tmp2
decl_stmt|;
name|svn_opt_revision_t
name|old_rev
decl_stmt|,
name|new_rev
decl_stmt|;
comment|/* The 'svn diff --old=OLD[@OLDREV] [--new=NEW[@NEWREV]]          [PATH...]' case matches. */
name|tmp
operator|=
name|apr_array_make
argument_list|(
name|pool
argument_list|,
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|tmp
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
operator|(
name|opt_state
operator|->
name|old_target
operator|)
expr_stmt|;
name|APR_ARRAY_PUSH
argument_list|(
name|tmp
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
operator|=
operator|(
name|opt_state
operator|->
name|new_target
condition|?
name|opt_state
operator|->
name|new_target
else|:
name|opt_state
operator|->
name|old_target
operator|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__args_to_target_array_print_reserved
argument_list|(
operator|&
name|tmp2
argument_list|,
name|os
argument_list|,
name|tmp
argument_list|,
name|ctx
argument_list|,
name|FALSE
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Check if either or both targets were skipped (e.g. because they        * were .svn directories). */
if|if
condition|(
name|tmp2
operator|->
name|nelts
operator|<
literal|2
condition|)
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_CL_INSUFFICIENT_ARGS
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
name|SVN_ERR
argument_list|(
name|svn_opt_parse_path
argument_list|(
operator|&
name|old_rev
argument_list|,
operator|&
name|old_target
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|tmp2
argument_list|,
literal|0
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_rev
operator|.
name|kind
operator|!=
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|start_revision
operator|=
name|old_rev
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_opt_parse_path
argument_list|(
operator|&
name|new_rev
argument_list|,
operator|&
name|new_target
argument_list|,
name|APR_ARRAY_IDX
argument_list|(
name|tmp2
argument_list|,
literal|1
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_rev
operator|.
name|kind
operator|!=
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|end_revision
operator|=
name|new_rev
expr_stmt|;
comment|/* For URLs, default to HEAD. For WC paths, default to WORKING if        * new target is explicit; if new target is implicitly the same as        * old target, then default the old to BASE and new to WORKING. */
if|if
condition|(
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|=
name|svn_path_is_url
argument_list|(
name|old_target
argument_list|)
condition|?
name|svn_opt_revision_head
else|:
operator|(
name|opt_state
operator|->
name|new_target
condition|?
name|svn_opt_revision_working
else|:
name|svn_opt_revision_base
operator|)
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|=
name|svn_path_is_url
argument_list|(
name|new_target
argument_list|)
condition|?
name|svn_opt_revision_head
else|:
name|svn_opt_revision_working
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|opt_state
operator|->
name|new_target
condition|)
block|{
return|return
name|svn_error_create
argument_list|(
name|SVN_ERR_CL_ARG_PARSING_ERROR
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"'--new' option only valid with "
literal|"'--old' option"
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
name|svn_boolean_t
name|working_copy_present
decl_stmt|;
comment|/* The 'svn diff [-r N[:M]] [TARGET[@REV]...]' case matches. */
comment|/* Here each target is a pegged object. Find out the starting          and ending paths for each target. */
name|svn_opt_push_implicit_dot_target
argument_list|(
name|targets
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|old_target
operator|=
literal|""
expr_stmt|;
name|new_target
operator|=
literal|""
expr_stmt|;
name|SVN_ERR_W
argument_list|(
name|svn_cl__assert_homogeneous_target_type
argument_list|(
name|targets
argument_list|)
argument_list|,
name|_
argument_list|(
literal|"'svn diff [-r N[:M]] [TARGET[@REV]...]' does not support mixed "
literal|"target types. Try using the --old and --new options or one of "
literal|"the shorthand invocations listed in 'svn help diff'."
argument_list|)
argument_list|)
expr_stmt|;
name|working_copy_present
operator|=
operator|!
name|svn_path_is_url
argument_list|(
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
literal|0
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
operator|&&
name|working_copy_present
condition|)
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|=
name|svn_opt_revision_base
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|=
name|working_copy_present
condition|?
name|svn_opt_revision_working
else|:
name|svn_opt_revision_head
expr_stmt|;
comment|/* Determine if we need to do pegged diffs. */
if|if
condition|(
operator|(
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|!=
name|svn_opt_revision_base
operator|&&
name|opt_state
operator|->
name|start_revision
operator|.
name|kind
operator|!=
name|svn_opt_revision_working
operator|)
operator|||
operator|(
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|!=
name|svn_opt_revision_base
operator|&&
name|opt_state
operator|->
name|end_revision
operator|.
name|kind
operator|!=
name|svn_opt_revision_working
operator|)
condition|)
name|pegged_diff
operator|=
name|TRUE
expr_stmt|;
block|}
comment|/* Should we ignore the content-type when deciding what to diff? */
if|if
condition|(
name|opt_state
operator|->
name|force
condition|)
block|{
name|ignore_content_type
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ctx
operator|->
name|config
condition|)
block|{
name|SVN_ERR
argument_list|(
name|svn_config_get_bool
argument_list|(
name|svn_hash_gets
argument_list|(
name|ctx
operator|->
name|config
argument_list|,
name|SVN_CONFIG_CATEGORY_CONFIG
argument_list|)
argument_list|,
operator|&
name|ignore_content_type
argument_list|,
name|SVN_CONFIG_SECTION_MISCELLANY
argument_list|,
name|SVN_CONFIG_OPTION_DIFF_IGNORE_CONTENT_TYPE
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ignore_content_type
operator|=
name|FALSE
expr_stmt|;
block|}
name|svn_opt_push_implicit_dot_target
argument_list|(
name|targets
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|iterpool
operator|=
name|svn_pool_create
argument_list|(
name|pool
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|targets
operator|->
name|nelts
condition|;
operator|++
name|i
control|)
block|{
specifier|const
name|char
modifier|*
name|path
init|=
name|APR_ARRAY_IDX
argument_list|(
name|targets
argument_list|,
name|i
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|target1
decl_stmt|,
modifier|*
name|target2
decl_stmt|;
name|svn_pool_clear
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pegged_diff
condition|)
block|{
comment|/* We can't be tacking URLs onto base paths! */
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|path
argument_list|)
condition|)
return|return
name|svn_error_createf
argument_list|(
name|SVN_ERR_CL_ARG_PARSING_ERROR
argument_list|,
name|NULL
argument_list|,
name|_
argument_list|(
literal|"Path '%s' not relative to base URLs"
argument_list|)
argument_list|,
name|path
argument_list|)
return|;
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|old_target
argument_list|)
condition|)
name|target1
operator|=
name|svn_path_url_add_component2
argument_list|(
name|old_target
argument_list|,
name|svn_relpath_canonicalize
argument_list|(
name|path
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
else|else
name|target1
operator|=
name|svn_dirent_join
argument_list|(
name|old_target
argument_list|,
name|path
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|svn_path_is_url
argument_list|(
name|new_target
argument_list|)
condition|)
name|target2
operator|=
name|svn_path_url_add_component2
argument_list|(
name|new_target
argument_list|,
name|svn_relpath_canonicalize
argument_list|(
name|path
argument_list|,
name|iterpool
argument_list|)
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
else|else
name|target2
operator|=
name|svn_dirent_join
argument_list|(
name|new_target
argument_list|,
name|path
argument_list|,
name|iterpool
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|diff
operator|.
name|summarize
condition|)
block|{
name|summarize_baton
operator|.
name|anchor
operator|=
name|target1
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client_diff_summarize2
argument_list|(
name|target1
argument_list|,
operator|&
name|opt_state
operator|->
name|start_revision
argument_list|,
name|target2
argument_list|,
operator|&
name|opt_state
operator|->
name|end_revision
argument_list|,
name|opt_state
operator|->
name|depth
argument_list|,
operator|!
name|opt_state
operator|->
name|diff
operator|.
name|notice_ancestry
argument_list|,
name|opt_state
operator|->
name|changelists
argument_list|,
name|summarize_func
argument_list|,
operator|&
name|summarize_baton
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_client_diff6
argument_list|(
name|options
argument_list|,
name|target1
argument_list|,
operator|&
operator|(
name|opt_state
operator|->
name|start_revision
operator|)
argument_list|,
name|target2
argument_list|,
operator|&
operator|(
name|opt_state
operator|->
name|end_revision
operator|)
argument_list|,
name|NULL
argument_list|,
name|opt_state
operator|->
name|depth
argument_list|,
operator|!
name|opt_state
operator|->
name|diff
operator|.
name|notice_ancestry
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|no_diff_added
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|no_diff_deleted
argument_list|,
name|show_copies_as_adds
argument_list|,
name|ignore_content_type
argument_list|,
name|ignore_properties
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|properties_only
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|use_git_diff_format
argument_list|,
name|svn_cmdline_output_encoding
argument_list|(
name|pool
argument_list|)
argument_list|,
name|outstream
argument_list|,
name|errstream
argument_list|,
name|opt_state
operator|->
name|changelists
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|truepath
decl_stmt|;
name|svn_opt_revision_t
name|peg_revision
decl_stmt|;
comment|/* First check for a peg revision. */
name|SVN_ERR
argument_list|(
name|svn_opt_parse_path
argument_list|(
operator|&
name|peg_revision
argument_list|,
operator|&
name|truepath
argument_list|,
name|path
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set the default peg revision if one was not specified. */
if|if
condition|(
name|peg_revision
operator|.
name|kind
operator|==
name|svn_opt_revision_unspecified
condition|)
name|peg_revision
operator|.
name|kind
operator|=
name|svn_path_is_url
argument_list|(
name|path
argument_list|)
condition|?
name|svn_opt_revision_head
else|:
name|svn_opt_revision_working
expr_stmt|;
if|if
condition|(
name|opt_state
operator|->
name|diff
operator|.
name|summarize
condition|)
block|{
name|summarize_baton
operator|.
name|anchor
operator|=
name|truepath
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_client_diff_summarize_peg2
argument_list|(
name|truepath
argument_list|,
operator|&
name|peg_revision
argument_list|,
operator|&
name|opt_state
operator|->
name|start_revision
argument_list|,
operator|&
name|opt_state
operator|->
name|end_revision
argument_list|,
name|opt_state
operator|->
name|depth
argument_list|,
operator|!
name|opt_state
operator|->
name|diff
operator|.
name|notice_ancestry
argument_list|,
name|opt_state
operator|->
name|changelists
argument_list|,
name|summarize_func
argument_list|,
operator|&
name|summarize_baton
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|SVN_ERR
argument_list|(
name|svn_client_diff_peg6
argument_list|(
name|options
argument_list|,
name|truepath
argument_list|,
operator|&
name|peg_revision
argument_list|,
operator|&
name|opt_state
operator|->
name|start_revision
argument_list|,
operator|&
name|opt_state
operator|->
name|end_revision
argument_list|,
name|NULL
argument_list|,
name|opt_state
operator|->
name|depth
argument_list|,
operator|!
name|opt_state
operator|->
name|diff
operator|.
name|notice_ancestry
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|no_diff_added
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|no_diff_deleted
argument_list|,
name|show_copies_as_adds
argument_list|,
name|ignore_content_type
argument_list|,
name|ignore_properties
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|properties_only
argument_list|,
name|opt_state
operator|->
name|diff
operator|.
name|use_git_diff_format
argument_list|,
name|svn_cmdline_output_encoding
argument_list|(
name|pool
argument_list|)
argument_list|,
name|outstream
argument_list|,
name|errstream
argument_list|,
name|opt_state
operator|->
name|changelists
argument_list|,
name|ctx
argument_list|,
name|iterpool
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|opt_state
operator|->
name|xml
condition|)
block|{
name|svn_stringbuf_t
modifier|*
name|sb
init|=
name|svn_stringbuf_create_empty
argument_list|(
name|pool
argument_list|)
decl_stmt|;
name|svn_xml_make_close_tag
argument_list|(
operator|&
name|sb
argument_list|,
name|pool
argument_list|,
literal|"paths"
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__error_checked_fputs
argument_list|(
name|sb
operator|->
name|data
argument_list|,
name|stdout
argument_list|)
argument_list|)
expr_stmt|;
name|SVN_ERR
argument_list|(
name|svn_cl__xml_print_footer
argument_list|(
literal|"diff"
argument_list|,
name|pool
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|svn_pool_destroy
argument_list|(
name|iterpool
argument_list|)
expr_stmt|;
return|return
name|SVN_NO_ERROR
return|;
block|}
end_function

end_unit


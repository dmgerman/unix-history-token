begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * DVI previewer for X.  *  * Eric Cooper, CMU, September 1985.  *  * Code derived from dvi-imagen.c.  *  * Modified for X.10 by Bob Scheifler, MIT LCS, January 1986.  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dv_c
init|=
literal|"$Header: dv.c,v 10.5 86/02/01 15:44:22 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"dvi.h"
end_include

begin_include
include|#
directive|include
file|"pxl.h"
end_include

begin_comment
comment|/* These are probably site dependent */
end_comment

begin_define
define|#
directive|define
name|FONT_DIRECTORY
value|"/usr/lib/tex/fonts"
end_define

begin_define
define|#
directive|define
name|FONT_SUFFIX
value|".%dpxl"
end_define

begin_define
define|#
directive|define
name|PAPER_WIDTH
value|ROUNDUP(17*pixels_per_inch,shrink_factor*2)
end_define

begin_define
define|#
directive|define
name|PAPER_HEIGHT
value|ROUNDUP(11*pixels_per_inch,shrink_factor)
end_define

begin_define
define|#
directive|define
name|X_PAGE_OFFSET
value|ROUNDUP(pixels_per_inch,shrink_factor)
end_define

begin_define
define|#
directive|define
name|Y_PAGE_OFFSET
value|ROUNDUP(pixels_per_inch,shrink_factor)
end_define

begin_define
define|#
directive|define
name|pixel_round
parameter_list|(
name|x
parameter_list|)
value|((long) (conv * (double) (x) + 0.5))
end_define

begin_define
define|#
directive|define
name|dvi_round
parameter_list|(
name|x
parameter_list|)
value|((long) ((double) (x) / conv + 0.5))
end_define

begin_define
define|#
directive|define
name|one
parameter_list|(
name|fp
parameter_list|)
value|num (fp, 1)
end_define

begin_define
define|#
directive|define
name|two
parameter_list|(
name|fp
parameter_list|)
value|num (fp, 2)
end_define

begin_define
define|#
directive|define
name|stwo
parameter_list|(
name|fp
parameter_list|)
value|snum(fp, 2)
end_define

begin_define
define|#
directive|define
name|four
parameter_list|(
name|fp
parameter_list|)
value|num (fp, 4)
end_define

begin_define
define|#
directive|define
name|sfour
parameter_list|(
name|fp
parameter_list|)
value|snum(fp, 4)
end_define

begin_typedef
typedef|typedef
name|unsigned
name|char
name|ubyte
typedef|;
end_typedef

begin_struct
struct|struct
name|frame
block|{
name|long
name|pxl_h
decl_stmt|,
name|dvi_h
decl_stmt|,
name|pxl_v
decl_stmt|,
name|dvi_v
decl_stmt|,
name|w
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|z
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|frame
modifier|*
name|stack
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|stackp
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PXL_H
value|stack[stackp].pxl_h
end_define

begin_define
define|#
directive|define
name|PXL_V
value|stack[stackp].pxl_v
end_define

begin_define
define|#
directive|define
name|DVI_H
value|stack[stackp].dvi_h
end_define

begin_define
define|#
directive|define
name|DVI_V
value|stack[stackp].dvi_v
end_define

begin_define
define|#
directive|define
name|WW
value|stack[stackp].w
end_define

begin_define
define|#
directive|define
name|XX
value|stack[stackp].x
end_define

begin_define
define|#
directive|define
name|YY
value|stack[stackp].y
end_define

begin_define
define|#
directive|define
name|ZZ
value|stack[stackp].z
end_define

begin_define
define|#
directive|define
name|DBG_BITMAP
value|0x1
end_define

begin_define
define|#
directive|define
name|DBG_DVI
value|0x2
end_define

begin_define
define|#
directive|define
name|DBG_ALL
value|(DBG_BITMAP|DBG_DVI)
end_define

begin_comment
comment|/*  * Command line flags.  */
end_comment

begin_decl_stmt
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|list_fonts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pixels_per_inch
init|=
literal|300
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|shrink_factor
init|=
literal|4
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|dvi_file
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* user's file */
end_comment

begin_decl_stmt
name|int
name|font_not_found
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|font
modifier|*
name|current_font
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ptr into circular list of fonts */
end_comment

begin_define
define|#
directive|define
name|MAX_OPEN_FONTS
value|12
end_define

begin_decl_stmt
name|int
name|n_open_fonts
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* for LRU management of fonts */
end_comment

begin_comment
comment|/*  * DVI preamble and postamble information.  */
end_comment

begin_decl_stmt
name|char
name|job_id
index|[
literal|300
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|total_pages
decl_stmt|,
name|maxstack
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|current_page
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|double
name|fraction
decl_stmt|,
name|conv
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|numerator
decl_stmt|,
name|denominator
decl_stmt|,
name|magnification
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Offset in DVI file of last page, set in read_postamble().  */
end_comment

begin_decl_stmt
name|long
name|last_page_offset
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Table of page offsets in DVI file, indexed by page number - 1.  * Initialized in prepare_pages().  */
end_comment

begin_decl_stmt
name|long
modifier|*
name|page_offset
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|xdvi_width
value|15
end_define

begin_define
define|#
directive|define
name|xdvi_height
value|15
end_define

begin_define
define|#
directive|define
name|xdvi_x_hot
value|7
end_define

begin_define
define|#
directive|define
name|xdvi_y_hot
value|7
end_define

begin_decl_stmt
specifier|static
name|short
name|xdvi_bits
index|[]
init|=
block|{
literal|0x0080
block|,
literal|0x01c0
block|,
literal|0x03e0
block|,
literal|0x06b0
block|,
literal|0x0c98
block|,
literal|0x188c
block|,
literal|0x3086
block|,
literal|0x7fff
block|,
literal|0x3086
block|,
literal|0x188c
block|,
literal|0x0c98
block|,
literal|0x06b0
block|,
literal|0x03e0
block|,
literal|0x01c0
block|,
literal|0x0080
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Window
name|win
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|forepix
decl_stmt|,
name|backpix
decl_stmt|,
name|highpix
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|screen_w
decl_stmt|,
name|screen_h
decl_stmt|,
name|page_w
decl_stmt|,
name|page_h
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|min_x
decl_stmt|,
name|max_x
decl_stmt|,
name|min_y
decl_stmt|,
name|max_y
decl_stmt|,
name|base_x
decl_stmt|,
name|base_y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|smin_x
decl_stmt|,
name|smax_x
decl_stmt|,
name|smin_y
decl_stmt|,
name|smax_y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|redisplay
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
name|unsigned
name|long
name|num
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|long
name|snum
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|char
name|reverse_byte
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|malloc
argument_list|()
decl_stmt|,
modifier|*
name|calloc
argument_list|()
decl_stmt|,
modifier|*
name|index
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
modifier|*
name|prog
decl_stmt|,
modifier|*
name|file
decl_stmt|;
name|char
modifier|*
name|display
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|option
decl_stmt|;
name|OpaqueFrame
name|frame
decl_stmt|;
name|int
name|reverse
init|=
literal|0
decl_stmt|;
name|int
name|bwidth
init|=
literal|2
decl_stmt|;
name|char
modifier|*
name|fore_color
decl_stmt|;
name|char
modifier|*
name|back_color
decl_stmt|;
name|char
modifier|*
name|high_color
decl_stmt|;
name|char
modifier|*
name|brdr_color
decl_stmt|;
name|char
modifier|*
name|mous_color
decl_stmt|;
name|char
modifier|*
name|geometry
init|=
name|NULL
decl_stmt|,
name|def
index|[
literal|32
index|]
decl_stmt|;
name|int
name|backmap
decl_stmt|,
name|bdrmap
decl_stmt|,
name|mouspix
decl_stmt|;
name|Color
name|cdef
decl_stmt|;
name|prog
operator|=
operator|*
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"ReverseVideo"
argument_list|)
operator|)
operator|&&
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|reverse
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"BorderWidth"
argument_list|)
condition|)
name|bwidth
operator|=
name|atoi
argument_list|(
name|option
argument_list|)
expr_stmt|;
name|fore_color
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"ForeGround"
argument_list|)
expr_stmt|;
name|back_color
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"BackGround"
argument_list|)
expr_stmt|;
name|high_color
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"Highlight"
argument_list|)
expr_stmt|;
name|brdr_color
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"Border"
argument_list|)
expr_stmt|;
name|mous_color
operator|=
name|XGetDefault
argument_list|(
name|prog
argument_list|,
literal|"Mouse"
argument_list|)
expr_stmt|;
name|file
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|argc
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-d"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|debug
operator|=
name|isdigit
argument_list|(
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
argument_list|)
condition|?
name|atoi
argument_list|(
operator|&
name|argv
index|[
literal|0
index|]
index|[
literal|2
index|]
argument_list|)
else|:
name|DBG_ALL
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-l"
argument_list|)
operator|==
literal|0
condition|)
name|list_fonts
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-s"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|shrink_factor
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|shrink_factor
operator|<=
literal|0
condition|)
goto|goto
name|usage
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-p"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|pixels_per_inch
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
name|pixels_per_inch
operator|<=
literal|0
condition|)
goto|goto
name|usage
goto|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-rv"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reverse
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-fg"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|fore_color
operator|=
operator|*
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-bg"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|back_color
operator|=
operator|*
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-hl"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|high_color
operator|=
operator|*
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-bd"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|brdr_color
operator|=
operator|*
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-ms"
argument_list|)
operator|==
literal|0
operator|&&
name|argc
operator|>
literal|1
condition|)
block|{
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|mous_color
operator|=
operator|*
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|argv
operator|==
literal|'='
condition|)
block|{
name|geometry
operator|=
operator|*
name|argv
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
operator|*
name|argv
operator|!=
literal|'-'
condition|)
block|{
if|if
condition|(
name|index
argument_list|(
operator|*
name|argv
argument_list|,
literal|':'
argument_list|)
operator|!=
name|NULL
condition|)
name|display
operator|=
operator|*
name|argv
expr_stmt|;
else|else
name|file
operator|=
operator|*
name|argv
expr_stmt|;
block|}
else|else
block|{
name|usage
label|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: xdvi [-s<shrink>] [-p<pixels>] [-l] [-rv] [-fg<color>] [-bg<color>] [-hl<color>] [-bd<color>] [-ms<color>] [=<geometry>] [host:display] dvi_file\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|argv
operator|++
expr_stmt|;
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
goto|goto
name|usage
goto|;
if|if
condition|(
operator|(
name|dvi_file
operator|=
name|fopen
argument_list|(
name|file
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|int
name|n
init|=
name|strlen
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|char
modifier|*
name|dvi_name
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|file
operator|+
name|n
operator|-
sizeof|sizeof
argument_list|(
literal|".dvi"
argument_list|)
operator|+
literal|1
argument_list|,
literal|".dvi"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|perror
argument_list|(
name|file
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dvi_name
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|n
operator|+
sizeof|sizeof
argument_list|(
literal|".dvi"
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|dvi_name
argument_list|,
literal|"%s.dvi"
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dvi_file
operator|=
name|fopen
argument_list|(
name|dvi_name
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|perror
argument_list|(
name|dvi_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|process_preamble
argument_list|()
expr_stmt|;
name|find_postamble
argument_list|()
expr_stmt|;
name|read_postamble
argument_list|()
expr_stmt|;
name|prepare_pages
argument_list|()
expr_stmt|;
name|init_page
argument_list|()
expr_stmt|;
if|if
condition|(
name|XOpenDisplay
argument_list|(
name|display
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't open display %s!\n"
argument_list|,
name|display
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reverse
condition|)
block|{
name|forepix
operator|=
name|WhitePixel
expr_stmt|;
name|highpix
operator|=
name|WhitePixel
expr_stmt|;
name|backpix
operator|=
name|BlackPixel
expr_stmt|;
name|backmap
operator|=
name|BlackPixmap
expr_stmt|;
name|bdrmap
operator|=
name|WhitePixmap
expr_stmt|;
name|mouspix
operator|=
name|WhitePixel
expr_stmt|;
block|}
else|else
block|{
name|forepix
operator|=
name|BlackPixel
expr_stmt|;
name|highpix
operator|=
name|BlackPixel
expr_stmt|;
name|backpix
operator|=
name|WhitePixel
expr_stmt|;
name|backmap
operator|=
name|WhitePixmap
expr_stmt|;
name|bdrmap
operator|=
name|BlackPixmap
expr_stmt|;
name|mouspix
operator|=
name|BlackPixel
expr_stmt|;
block|}
if|if
condition|(
name|DisplayCells
argument_list|()
operator|>
literal|2
condition|)
block|{
if|if
condition|(
name|fore_color
operator|&&
name|XParseColor
argument_list|(
name|fore_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|forepix
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
if|if
condition|(
name|back_color
operator|&&
name|XParseColor
argument_list|(
name|back_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|backpix
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|backmap
operator|=
name|XMakeTile
argument_list|(
name|backpix
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|high_color
operator|&&
name|XParseColor
argument_list|(
name|high_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|highpix
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
if|if
condition|(
name|brdr_color
operator|&&
name|XParseColor
argument_list|(
name|brdr_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|bdrmap
operator|=
name|XMakeTile
argument_list|(
name|cdef
operator|.
name|pixel
argument_list|)
expr_stmt|;
if|if
condition|(
name|mous_color
operator|&&
name|XParseColor
argument_list|(
name|mous_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|mouspix
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
block|}
name|frame
operator|.
name|bdrwidth
operator|=
name|bwidth
expr_stmt|;
name|frame
operator|.
name|height
operator|=
name|page_h
expr_stmt|;
if|if
condition|(
name|frame
operator|.
name|height
operator|+
operator|(
name|bwidth
operator|<<
literal|1
operator|)
operator|>
name|DisplayHeight
argument_list|()
condition|)
name|frame
operator|.
name|height
operator|=
name|DisplayHeight
argument_list|()
operator|-
operator|(
name|bwidth
operator|<<
literal|1
operator|)
expr_stmt|;
name|frame
operator|.
name|width
operator|=
name|page_w
expr_stmt|;
if|if
condition|(
name|frame
operator|.
name|width
operator|+
operator|(
name|bwidth
operator|<<
literal|1
operator|)
operator|>
name|DisplayWidth
argument_list|()
condition|)
name|frame
operator|.
name|width
operator|=
name|DisplayWidth
argument_list|()
operator|-
operator|(
name|bwidth
operator|<<
literal|1
operator|)
expr_stmt|;
name|frame
operator|.
name|border
operator|=
name|bdrmap
expr_stmt|;
name|frame
operator|.
name|background
operator|=
name|backmap
expr_stmt|;
name|frame
operator|.
name|x
operator|=
literal|0
expr_stmt|;
name|frame
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|sprintf
argument_list|(
name|def
argument_list|,
literal|"=%dx%d+0+0"
argument_list|,
name|frame
operator|.
name|width
argument_list|,
name|frame
operator|.
name|height
argument_list|)
expr_stmt|;
name|win
operator|=
name|XCreate
argument_list|(
literal|"DVI Previewer"
argument_list|,
name|prog
argument_list|,
name|geometry
argument_list|,
name|def
argument_list|,
operator|&
name|frame
argument_list|,
literal|50
argument_list|,
literal|50
argument_list|)
expr_stmt|;
name|screen_h
operator|=
name|frame
operator|.
name|height
expr_stmt|;
name|screen_w
operator|=
name|frame
operator|.
name|width
expr_stmt|;
name|XMapWindow
argument_list|(
name|win
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|win
argument_list|,
name|KeyPressed
operator||
name|ButtonPressed
operator||
name|ExposeWindow
operator||
name|ExposeRegion
argument_list|)
expr_stmt|;
name|XDefineCursor
argument_list|(
name|win
argument_list|,
name|XCreateCursor
argument_list|(
name|xdvi_width
argument_list|,
name|xdvi_height
argument_list|,
name|xdvi_bits
argument_list|,
name|xdvi_bits
argument_list|,
name|xdvi_x_hot
argument_list|,
name|xdvi_y_hot
argument_list|,
name|mouspix
argument_list|,
name|backpix
argument_list|,
name|GXcopy
argument_list|)
argument_list|)
expr_stmt|;
name|do_pages
argument_list|()
expr_stmt|;
name|stop_output
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* **      process_preamble reads the information in the preamble and stores **      it into global variables for later use. */
end_comment

begin_macro
name|process_preamble
argument_list|()
end_macro

begin_block
block|{
name|ubyte
name|k
decl_stmt|;
if|if
condition|(
name|one
argument_list|(
name|dvi_file
argument_list|)
operator|!=
name|PRE
condition|)
name|error
argument_list|(
literal|"xdvi: DVI file doesn't start with preamble"
argument_list|)
expr_stmt|;
if|if
condition|(
name|one
argument_list|(
name|dvi_file
argument_list|)
operator|!=
literal|2
condition|)
name|error
argument_list|(
literal|"xdvi: Wrong version of DVI output for this program"
argument_list|)
expr_stmt|;
name|numerator
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|denominator
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|magnification
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|fraction
operator|=
operator|(
operator|(
operator|(
name|double
operator|)
name|numerator
operator|*
name|magnification
operator|)
operator|/
operator|(
operator|(
name|double
operator|)
name|denominator
operator|*
literal|1000.
operator|)
operator|)
expr_stmt|;
name|define_conv
argument_list|()
expr_stmt|;
name|k
operator|=
name|one
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|fread
argument_list|(
name|job_id
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|k
argument_list|,
name|dvi_file
argument_list|)
expr_stmt|;
name|job_id
index|[
name|k
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
end_block

begin_macro
name|define_conv
argument_list|()
end_macro

begin_block
block|{
name|conv
operator|=
operator|(
operator|(
name|fraction
operator|*
name|pixels_per_inch
operator|)
operator|/
literal|100000
operator|)
operator|/
operator|(
literal|2.54
operator|*
name|shrink_factor
operator|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* **      find_postamble locates the beginning of the postamble **	and leaves the file ready to start reading at that location. */
end_comment

begin_macro
name|find_postamble
argument_list|()
end_macro

begin_block
block|{
name|ubyte
name|byte
decl_stmt|;
name|long
name|offset
init|=
operator|-
literal|4
decl_stmt|;
comment|/* At least 4 TRAILERS */
do|do
block|{
name|offset
operator|-=
literal|1
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|byte
operator|=
name|one
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|byte
operator|==
name|TRAILER
condition|)
do|;
if|if
condition|(
name|byte
operator|!=
literal|2
condition|)
name|error
argument_list|(
literal|"xdvi: Wrong version of DVI output for this program"
argument_list|)
expr_stmt|;
name|offset
operator|-=
literal|4
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
name|offset
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
name|sfour
argument_list|(
name|dvi_file
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* **      read_postamble reads the information in the postamble, **	storing it into global variables. **      It also takes care of reading in all of the PXL files for the fonts **      used in the job. */
end_comment

begin_macro
name|read_postamble
argument_list|()
end_macro

begin_block
block|{
name|ubyte
name|cmnd
decl_stmt|;
name|int
name|page_width
decl_stmt|,
name|page_height
decl_stmt|;
if|if
condition|(
name|one
argument_list|(
name|dvi_file
argument_list|)
operator|!=
name|POST
condition|)
name|error
argument_list|(
literal|"xdvi: Postamble doesn't begin with POST"
argument_list|)
expr_stmt|;
name|last_page_offset
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|numerator
operator|!=
name|four
argument_list|(
name|dvi_file
argument_list|)
operator|||
name|denominator
operator|!=
name|four
argument_list|(
name|dvi_file
argument_list|)
operator|||
name|magnification
operator|!=
name|four
argument_list|(
name|dvi_file
argument_list|)
condition|)
name|error
argument_list|(
literal|"xdvi: Postamble doesn't match preamble"
argument_list|)
expr_stmt|;
name|page_height
operator|=
name|pixel_round
argument_list|(
name|four
argument_list|(
name|dvi_file
argument_list|)
argument_list|)
expr_stmt|;
name|page_width
operator|=
name|pixel_round
argument_list|(
name|four
argument_list|(
name|dvi_file
argument_list|)
argument_list|)
expr_stmt|;
name|maxstack
operator|=
name|two
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|total_pages
operator|=
name|two
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
do|do
block|{
switch|switch
condition|(
name|cmnd
operator|=
name|one
argument_list|(
name|dvi_file
argument_list|)
condition|)
block|{
case|case
name|FNTDEF1
case|:
case|case
name|FNTDEF2
case|:
case|case
name|FNTDEF3
case|:
case|case
name|FNTDEF4
case|:
name|define_font
argument_list|(
name|cmnd
argument_list|)
expr_stmt|;
break|break;
case|case
name|POSTPOST
case|:
break|break;
default|default:
name|error
argument_list|(
literal|"xdvi: Non-fntdef cmnd found in postamble"
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|cmnd
operator|!=
name|POSTPOST
condition|)
do|;
if|if
condition|(
name|font_not_found
condition|)
name|error
argument_list|(
literal|"xdvi: Not all PXL files were found"
argument_list|)
expr_stmt|;
name|list_fonts
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_macro
name|prepare_pages
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|stack
operator|=
operator|(
expr|struct
name|frame
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|frame
argument_list|)
operator|*
operator|(
name|maxstack
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|stack
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|"xdvi: Can't allocate stack space (%d frames)"
argument_list|,
name|maxstack
argument_list|)
expr_stmt|;
name|page_offset
operator|=
operator|(
name|long
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|total_pages
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|page_offset
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|"xdvi: Can't allocate page directory (%d pages)"
argument_list|,
name|total_pages
argument_list|)
expr_stmt|;
name|i
operator|=
name|total_pages
expr_stmt|;
name|page_offset
index|[
operator|--
name|i
index|]
operator|=
name|last_page_offset
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
name|last_page_offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Follow back pointers through pages in the DVI file, 	 * storing the offsets in the page_offset table. 	 */
while|while
condition|(
name|i
operator|>
literal|0
condition|)
block|{
name|num
argument_list|(
name|dvi_file
argument_list|,
literal|1
operator|+
literal|4
operator|+
operator|(
literal|9
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
name|page_offset
index|[
operator|--
name|i
index|]
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* **      define_font reads the rest of the fntdef command and then reads in **      the specified PXL file, adding it to the global linked-list holding **      all of the fonts used in the job. */
end_comment

begin_macro
name|define_font
argument_list|(
argument|cmnd
argument_list|)
end_macro

begin_decl_stmt
name|ubyte
name|cmnd
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|font
modifier|*
name|fontp
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|unmodsize
decl_stmt|;
name|float
name|realsize
decl_stmt|;
name|int
name|size
decl_stmt|;
name|long
name|checksum
decl_stmt|;
name|fontp
operator|=
operator|(
expr|struct
name|font
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
sizeof|sizeof
argument_list|(
expr|struct
name|font
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fontp
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|"xdvi: Can't allocate memory for font"
argument_list|)
expr_stmt|;
name|fontp
operator|->
name|TeXnumber
operator|=
name|num
argument_list|(
name|dvi_file
argument_list|,
name|cmnd
operator|-
name|FNTDEF1
operator|+
literal|1
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|fontp
operator|->
name|scale
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|fontp
operator|->
name|design
operator|=
name|four
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|len
operator|=
name|one
argument_list|(
name|dvi_file
argument_list|)
operator|+
name|one
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|fontp
operator|->
name|fontname
operator|=
name|malloc
argument_list|(
name|len
operator|+
literal|10
argument_list|)
expr_stmt|;
comment|/* leave space for magnification */
name|fread
argument_list|(
name|fontp
operator|->
name|fontname
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|,
name|len
argument_list|,
name|dvi_file
argument_list|)
expr_stmt|;
name|fontp
operator|->
name|fontname
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fontp
operator|->
name|file
operator|=
name|NULL
expr_stmt|;
comment|/* **	In the actual implementation, scaled-size/design-size hasn't been **	stored with sufficient precision, hence the messing around to find **	its actual value. */
name|realsize
operator|=
operator|(
name|magnification
operator|/
literal|1000.
operator|)
operator|*
operator|(
operator|(
name|float
operator|)
name|fontp
operator|->
name|scale
operator|/
name|fontp
operator|->
name|design
operator|)
expr_stmt|;
name|unmodsize
operator|=
operator|(
name|realsize
operator|*
literal|1000
operator|)
operator|+
literal|0.5
expr_stmt|;
comment|/* a real hack to correct for rounding in some cases */
switch|switch
condition|(
name|unmodsize
condition|)
block|{
case|case
literal|1095
case|:
name|realsize
operator|=
literal|1.095445
expr_stmt|;
comment|/* stephalf */
break|break;
case|case
literal|1315
case|:
name|realsize
operator|=
literal|1.314534
expr_stmt|;
comment|/* stepihalf */
break|break;
case|case
literal|2074
case|:
name|realsize
operator|=
literal|2.0736
expr_stmt|;
comment|/* stepiv */
break|break;
case|case
literal|2488
case|:
name|realsize
operator|=
literal|2.48832
expr_stmt|;
comment|/* stepv */
break|break;
case|case
literal|2986
case|:
name|realsize
operator|=
literal|2.985984
expr_stmt|;
comment|/* stepiv */
break|break;
block|}
comment|/* 	 * the remaining magnification steps are represented 	 * with sufficient accuracy already 	 */
name|size
operator|=
operator|(
name|realsize
operator|*
name|pixels_per_inch
operator|*
literal|5
operator|)
operator|+
literal|0.5
expr_stmt|;
name|sprintf
argument_list|(
operator|&
name|fontp
operator|->
name|fontname
index|[
name|len
index|]
argument_list|,
name|FONT_SUFFIX
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|open_pxl_file
argument_list|(
name|fontp
argument_list|)
condition|)
return|return;
name|read_glyphs
argument_list|(
name|fontp
argument_list|)
expr_stmt|;
if|if
condition|(
name|current_font
operator|==
name|NULL
condition|)
block|{
name|fontp
operator|->
name|next
operator|=
name|fontp
expr_stmt|;
name|fontp
operator|->
name|prev
operator|=
name|fontp
expr_stmt|;
block|}
else|else
block|{
name|fontp
operator|->
name|next
operator|=
name|current_font
expr_stmt|;
name|fontp
operator|->
name|prev
operator|=
name|current_font
operator|->
name|prev
expr_stmt|;
name|current_font
operator|->
name|prev
operator|->
name|next
operator|=
name|fontp
expr_stmt|;
name|current_font
operator|->
name|prev
operator|=
name|fontp
expr_stmt|;
block|}
name|current_font
operator|=
name|fontp
expr_stmt|;
block|}
end_block

begin_macro
name|open_pxl_file
argument_list|(
argument|font
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|font
modifier|*
name|font
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|filename
index|[
literal|300
index|]
decl_stmt|;
specifier|extern
name|int
name|errno
decl_stmt|;
if|if
condition|(
name|font
operator|->
name|file
operator|==
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|filename
argument_list|,
literal|"%s/%s"
argument_list|,
name|FONT_DIRECTORY
argument_list|,
name|font
operator|->
name|fontname
argument_list|)
expr_stmt|;
if|if
condition|(
name|n_open_fonts
operator|==
name|MAX_OPEN_FONTS
condition|)
name|close_lru
argument_list|()
expr_stmt|;
name|font
operator|->
name|file
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|->
name|file
operator|==
name|NULL
condition|)
block|{
name|font_not_found
operator|=
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"%s [not found]\n"
argument_list|,
name|font
operator|->
name|fontname
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|n_open_fonts
operator|+=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|list_fonts
condition|)
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|font
operator|->
name|fontname
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|read_pxl_bitmap
argument_list|(
argument|ch
argument_list|,
argument|g
argument_list|)
end_macro

begin_decl_stmt
name|ubyte
name|ch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|struct
name|glyph
modifier|*
name|g
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|bitmap
modifier|*
name|bitmap
decl_stmt|;
specifier|register
name|int
name|file_bytes_wide
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|bitmap
operator|=
operator|&
name|g
operator|->
name|bitmap
expr_stmt|;
comment|/* in file, bitmap rows are multiples of 32 bits wide */
name|file_bytes_wide
operator|=
name|ROUNDUP
argument_list|(
name|bitmap
operator|->
name|w
argument_list|,
name|BITS_PER_LONG
argument_list|)
operator|*
name|BYTES_PER_LONG
expr_stmt|;
comment|/* width must be multiple of 16 bits for raster_op */
name|bitmap
operator|->
name|bytes_wide
operator|=
name|ROUNDUP
argument_list|(
name|bitmap
operator|->
name|w
argument_list|,
name|BITS_PER_SHORT
argument_list|)
operator|*
name|BYTES_PER_SHORT
expr_stmt|;
name|ptr
operator|=
name|bitmap
operator|->
name|bits
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|bitmap
operator|->
name|h
operator|*
name|bitmap
operator|->
name|bytes_wide
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|"xdvi: Can't allocate bitmap for character %d of font %s (%d by %d)"
argument_list|,
name|ch
argument_list|,
name|current_font
operator|->
name|fontname
argument_list|,
name|bitmap
operator|->
name|h
argument_list|,
name|bitmap
operator|->
name|w
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|open_pxl_file
argument_list|(
name|current_font
argument_list|)
condition|)
name|error
argument_list|(
literal|"xdvi: Can't find font file %s"
argument_list|,
name|current_font
operator|->
name|fontname
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|current_font
operator|->
name|file
argument_list|,
name|g
operator|->
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bitmap
operator|->
name|h
condition|;
name|i
operator|+=
literal|1
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|file_bytes_wide
condition|;
name|j
operator|+=
literal|1
control|)
if|if
condition|(
name|j
operator|<
name|bitmap
operator|->
name|bytes_wide
condition|)
operator|*
name|ptr
operator|++
operator|=
name|reverse_byte
index|[
name|one
argument_list|(
name|current_font
operator|->
name|file
argument_list|)
index|]
expr_stmt|;
else|else
name|one
argument_list|(
name|current_font
operator|->
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|shrink_factor
operator|!=
literal|1
condition|)
name|shrink_bitmap
argument_list|(
name|bitmap
argument_list|,
name|shrink_factor
argument_list|,
name|shrink_factor
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
operator|&
name|DBG_BITMAP
condition|)
name|print_char
argument_list|(
name|ch
argument_list|,
name|g
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Find font #n and move it to the head of the list.  */
end_comment

begin_macro
name|change_font
argument_list|(
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|long
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|font
modifier|*
name|fontp
decl_stmt|;
name|fontp
operator|=
name|current_font
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|fontp
operator|->
name|TeXnumber
operator|==
name|n
condition|)
break|break;
name|fontp
operator|=
name|fontp
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|fontp
operator|==
name|current_font
condition|)
name|error
argument_list|(
literal|"xdvi: Non-existent font #%d"
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|current_font
operator|==
name|fontp
condition|)
return|return;
name|fontp
operator|->
name|prev
operator|->
name|next
operator|=
name|fontp
operator|->
name|next
expr_stmt|;
name|fontp
operator|->
name|next
operator|->
name|prev
operator|=
name|fontp
operator|->
name|prev
expr_stmt|;
name|fontp
operator|->
name|next
operator|=
name|current_font
expr_stmt|;
name|fontp
operator|->
name|prev
operator|=
name|current_font
operator|->
name|prev
expr_stmt|;
name|current_font
operator|->
name|prev
operator|->
name|next
operator|=
name|fontp
expr_stmt|;
name|current_font
operator|->
name|prev
operator|=
name|fontp
expr_stmt|;
name|current_font
operator|=
name|fontp
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Close the PXL file for the least recently used font.  */
end_comment

begin_macro
name|close_lru
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|font
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|current_font
operator|->
name|prev
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|f
operator|->
name|file
operator|!=
name|NULL
condition|)
break|break;
name|f
operator|=
name|f
operator|->
name|prev
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|current_font
operator|->
name|prev
condition|)
name|error
argument_list|(
literal|"xdvi: Can't find an open PXL file to close"
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f
operator|->
name|file
argument_list|)
expr_stmt|;
name|f
operator|->
name|file
operator|=
name|NULL
expr_stmt|;
name|n_open_fonts
operator|-=
literal|1
expr_stmt|;
block|}
end_block

begin_macro
name|reset_fonts
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|font
modifier|*
name|f
decl_stmt|;
specifier|register
name|struct
name|glyph
modifier|*
name|g
decl_stmt|;
name|f
operator|=
name|current_font
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|open_pxl_file
argument_list|(
name|f
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
operator|&
name|f
operator|->
name|glyph
index|[
literal|0
index|]
init|;
name|g
operator|<
operator|&
name|f
operator|->
name|glyph
index|[
name|MAXCHARS
index|]
condition|;
name|g
operator|+=
literal|1
control|)
block|{
if|if
condition|(
name|g
operator|->
name|bitmap
operator|.
name|bits
condition|)
name|free
argument_list|(
name|g
operator|->
name|bitmap
operator|.
name|bits
argument_list|)
expr_stmt|;
block|}
name|read_glyphs
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|f
operator|=
name|f
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|current_font
condition|)
break|break;
block|}
block|}
end_block

begin_expr_stmt
name|read_glyphs
argument_list|(
name|fontp
argument_list|)
specifier|register
expr|struct
name|font
operator|*
name|fontp
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|struct
name|glyph
modifier|*
name|g
decl_stmt|;
name|long
name|checksum
decl_stmt|,
name|magnify
decl_stmt|,
name|design_size
decl_stmt|,
name|font_dir_ptr
decl_stmt|,
name|pxl_id_word
decl_stmt|;
comment|/* seek to trailer info */
name|fseek
argument_list|(
name|fontp
operator|->
name|file
argument_list|,
operator|(
name|long
operator|)
operator|-
operator|(
literal|5
operator|*
name|BYTES_PER_LONG
operator|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|four
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
expr_stmt|;
name|magnify
operator|=
name|four
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
expr_stmt|;
name|design_size
operator|=
name|four
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
expr_stmt|;
name|font_dir_ptr
operator|=
name|sfour
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
operator|*
literal|4
expr_stmt|;
name|pxl_id_word
operator|=
name|four
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|lint
name|magnify
operator|=
name|design_size
operator|=
name|pxl_id_word
operator|=
name|magnify
expr_stmt|;
endif|#
directive|endif
comment|/* seek to font directory */
name|fseek
argument_list|(
name|fontp
operator|->
name|file
argument_list|,
name|font_dir_ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|g
operator|=
operator|&
name|fontp
operator|->
name|glyph
index|[
literal|0
index|]
init|;
name|g
operator|<
operator|&
name|fontp
operator|->
name|glyph
index|[
name|MAXCHARS
index|]
condition|;
name|g
operator|+=
literal|1
control|)
block|{
name|g
operator|->
name|bitmap
operator|.
name|bits
operator|=
name|NULL
expr_stmt|;
name|g
operator|->
name|bitmap
operator|.
name|w
operator|=
name|two
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
expr_stmt|;
comment|/* leave this for shrink_bitmap */
name|g
operator|->
name|bitmap
operator|.
name|h
operator|=
name|two
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
expr_stmt|;
comment|/* leave this for shrink_bitmap */
name|g
operator|->
name|x
operator|=
name|stwo
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
operator|/
name|shrink_factor
expr_stmt|;
name|g
operator|->
name|y
operator|=
name|stwo
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
operator|/
name|shrink_factor
expr_stmt|;
name|g
operator|->
name|addr
operator|=
name|four
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
operator|*
literal|4
expr_stmt|;
comment|/* 		**  The TFM-width word is kind of funny in the units 		**  it is expressed in.  It works this way: 		** 		**  If a glyph has width 'w' in a font with design-size 		**  'd' (both in same units), the TFM-width word is 		** 		**                    (w/d) * 2^20 		** 		**  Therefore, in order to find the glyph width in 		**  DVI units (1 / 2^16 points), we take the design-size 		**  'd' (in DVI's), the magnification 'm' of the PXL file 		**  and the TFM-width word 't' to the width (in DVI's) 		**  as follows: 		** 		**                     dmt 		**                w = ----- 		**                    2^20 		** 		**  But the magnification of the PXL file is just the 		**  scaled size 's' over the design size, so the final 		**  expression for the width is 		** 		**                     st 		**                w = ---- 		**                    2^20 		** 		*/
name|g
operator|->
name|dvi_adv
operator|=
operator|(
operator|(
name|double
operator|)
name|fontp
operator|->
name|scale
operator|*
name|four
argument_list|(
name|fontp
operator|->
name|file
argument_list|)
operator|)
operator|/
operator|(
literal|1
operator|<<
literal|20
operator|)
expr_stmt|;
name|g
operator|->
name|pxl_adv
operator|=
name|pixel_round
argument_list|(
name|g
operator|->
name|dvi_adv
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|nope
parameter_list|(
name|str
parameter_list|)
value|error("xdvi: %s not implemented", str)
end_define

begin_define
define|#
directive|define
name|correct
parameter_list|()
value|(PXL_H = pixel_round(DVI_H))
end_define

begin_macro
name|do_pages
argument_list|()
end_macro

begin_block
block|{
name|ubyte
name|ch
decl_stmt|;
name|min_x
operator|=
literal|0
expr_stmt|;
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|screen_h
expr_stmt|;
name|base_x
operator|=
name|min_x
expr_stmt|;
name|base_y
operator|=
name|min_y
expr_stmt|;
name|current_page
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|ch
operator|=
name|one
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|debug
operator|&
name|DBG_DVI
condition|)
name|print_dvi
argument_list|(
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|<=
name|SETCHAR0
operator|+
literal|127
condition|)
block|{
name|set_char
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|DVI_H
operator|+=
name|current_font
operator|->
name|glyph
index|[
name|ch
index|]
operator|.
name|dvi_adv
expr_stmt|;
name|PXL_H
operator|+=
name|current_font
operator|->
name|glyph
index|[
name|ch
index|]
operator|.
name|pxl_adv
expr_stmt|;
name|correct
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FNTNUM0
operator|<=
name|ch
operator|&&
name|ch
operator|<=
name|FNTNUM0
operator|+
literal|63
condition|)
block|{
name|change_font
argument_list|(
call|(
name|unsigned
name|long
call|)
argument_list|(
name|ch
operator|-
name|FNTNUM0
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|long
name|a
decl_stmt|,
name|b
decl_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SET1
case|:
name|nope
argument_list|(
literal|"SET1"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SETRULE
case|:
name|a
operator|=
name|sfour
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|b
operator|=
name|sfour
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|>
literal|0
operator|&&
name|b
operator|>
literal|0
condition|)
block|{
name|correct
argument_list|()
expr_stmt|;
name|set_rule
argument_list|(
name|pixel_round
argument_list|(
name|a
argument_list|)
argument_list|,
name|pixel_round
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|DVI_H
operator|+=
name|b
expr_stmt|;
name|PXL_H
operator|=
name|pixel_round
argument_list|(
name|DVI_H
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUT1
case|:
name|nope
argument_list|(
literal|"PUT1"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUTRULE
case|:
name|a
operator|=
name|sfour
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|b
operator|=
name|sfour
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|>
literal|0
operator|&&
name|b
operator|>
literal|0
condition|)
block|{
name|correct
argument_list|()
expr_stmt|;
name|set_rule
argument_list|(
name|pixel_round
argument_list|(
name|a
argument_list|)
argument_list|,
name|pixel_round
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|NOP
case|:
break|break;
case|case
name|BOP
case|:
name|num
argument_list|(
name|dvi_file
argument_list|,
literal|11
operator|*
literal|4
argument_list|)
expr_stmt|;
name|stackp
operator|=
literal|0
expr_stmt|;
name|DVI_H
operator|=
name|dvi_round
argument_list|(
name|X_PAGE_OFFSET
argument_list|)
expr_stmt|;
name|PXL_H
operator|=
name|X_PAGE_OFFSET
expr_stmt|;
name|DVI_V
operator|=
name|dvi_round
argument_list|(
name|Y_PAGE_OFFSET
argument_list|)
expr_stmt|;
name|PXL_V
operator|=
name|Y_PAGE_OFFSET
expr_stmt|;
name|WW
operator|=
name|XX
operator|=
name|YY
operator|=
name|ZZ
operator|=
literal|0
expr_stmt|;
name|begin_page
argument_list|()
expr_stmt|;
break|break;
case|case
name|EOP
case|:
if|if
condition|(
name|stackp
operator|>
literal|0
condition|)
name|error
argument_list|(
literal|"Stack not empty at EOP (%d)"
argument_list|,
name|stackp
argument_list|)
expr_stmt|;
name|end_page
argument_list|()
expr_stmt|;
if|if
condition|(
name|ftell
argument_list|(
name|dvi_file
argument_list|)
operator|>
name|last_page_offset
condition|)
return|return;
break|break;
case|case
name|PUSH
case|:
name|stackp
operator|++
expr_stmt|;
if|if
condition|(
name|stackp
operator|>
name|maxstack
condition|)
name|error
argument_list|(
literal|"xdvi: More PUSHes than were promised"
argument_list|)
expr_stmt|;
name|stack
index|[
name|stackp
index|]
operator|=
name|stack
index|[
name|stackp
operator|-
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|POP
case|:
name|stackp
operator|--
expr_stmt|;
if|if
condition|(
name|stackp
operator|<
literal|0
condition|)
name|error
argument_list|(
literal|"xdvi: More POPs than PUSHes"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RIGHT1
case|:
case|case
name|RIGHT2
case|:
case|case
name|RIGHT3
case|:
case|case
name|RIGHT4
case|:
name|DVI_H
operator|+=
name|snum
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|RIGHT1
operator|+
literal|1
argument_list|)
expr_stmt|;
name|PXL_H
operator|=
name|pixel_round
argument_list|(
name|DVI_H
argument_list|)
expr_stmt|;
break|break;
case|case
name|X0
case|:
case|case
name|X1
case|:
case|case
name|X2
case|:
case|case
name|X3
case|:
case|case
name|X4
case|:
if|if
condition|(
name|ch
operator|!=
name|X0
condition|)
name|XX
operator|=
name|snum
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|X0
argument_list|)
expr_stmt|;
name|DVI_H
operator|+=
name|XX
expr_stmt|;
name|PXL_H
operator|+=
name|pixel_round
argument_list|(
name|XX
argument_list|)
expr_stmt|;
name|correct
argument_list|()
expr_stmt|;
break|break;
case|case
name|W0
case|:
case|case
name|W1
case|:
case|case
name|W2
case|:
case|case
name|W3
case|:
case|case
name|W4
case|:
if|if
condition|(
name|ch
operator|!=
name|W0
condition|)
name|WW
operator|=
name|snum
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|W0
argument_list|)
expr_stmt|;
name|DVI_H
operator|+=
name|WW
expr_stmt|;
name|PXL_H
operator|=
name|pixel_round
argument_list|(
name|DVI_H
argument_list|)
expr_stmt|;
break|break;
case|case
name|Y0
case|:
case|case
name|Y1
case|:
case|case
name|Y2
case|:
case|case
name|Y3
case|:
case|case
name|Y4
case|:
if|if
condition|(
name|ch
operator|!=
name|Y0
condition|)
name|YY
operator|=
name|snum
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|Y0
argument_list|)
expr_stmt|;
name|DVI_V
operator|+=
name|YY
expr_stmt|;
name|PXL_V
operator|=
name|pixel_round
argument_list|(
name|DVI_V
argument_list|)
expr_stmt|;
break|break;
case|case
name|Z0
case|:
case|case
name|Z1
case|:
case|case
name|Z2
case|:
case|case
name|Z3
case|:
case|case
name|Z4
case|:
if|if
condition|(
name|ch
operator|!=
name|Z0
condition|)
name|ZZ
operator|=
name|snum
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|Z0
argument_list|)
expr_stmt|;
name|DVI_V
operator|+=
name|ZZ
expr_stmt|;
name|PXL_V
operator|=
name|pixel_round
argument_list|(
name|DVI_V
argument_list|)
expr_stmt|;
break|break;
case|case
name|DOWN1
case|:
case|case
name|DOWN2
case|:
case|case
name|DOWN3
case|:
case|case
name|DOWN4
case|:
name|DVI_V
operator|+=
name|snum
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|DOWN1
operator|+
literal|1
argument_list|)
expr_stmt|;
name|PXL_V
operator|=
name|pixel_round
argument_list|(
name|DVI_V
argument_list|)
expr_stmt|;
break|break;
case|case
name|FNT1
case|:
case|case
name|FNT2
case|:
case|case
name|FNT3
case|:
case|case
name|FNT4
case|:
name|change_font
argument_list|(
name|num
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|FNT1
operator|+
literal|1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|XXX1
case|:
case|case
name|XXX2
case|:
case|case
name|XXX3
case|:
case|case
name|XXX4
case|:
name|a
operator|=
name|num
argument_list|(
name|dvi_file
argument_list|,
name|ch
operator|-
name|XXX1
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|>
literal|0
condition|)
name|special
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|a
argument_list|)
expr_stmt|;
break|break;
case|case
name|FNTDEF1
case|:
case|case
name|FNTDEF2
case|:
case|case
name|FNTDEF3
case|:
case|case
name|FNTDEF4
case|:
name|fseek
argument_list|(
name|dvi_file
argument_list|,
call|(
name|long
call|)
argument_list|(
literal|12
operator|+
name|ch
operator|-
name|FNTDEF1
operator|+
literal|1
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|a
operator|=
name|one
argument_list|(
name|dvi_file
argument_list|)
operator|+
name|one
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
operator|(
name|long
operator|)
name|a
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRE
case|:
name|error
argument_list|(
literal|"xdvi: Shouldn't happen: PRE encountered."
argument_list|)
expr_stmt|;
break|break;
case|case
name|POST
case|:
name|error
argument_list|(
literal|"xdvi: Shouldn't happen: POST encountered."
argument_list|)
expr_stmt|;
break|break;
case|case
name|POSTPOST
case|:
name|error
argument_list|(
literal|"xdvi: Shouldn't happen: POSTPOST encountered."
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
literal|"xdvi: Unknown op-code %d, offset %d"
argument_list|,
name|ch
argument_list|,
name|ftell
argument_list|(
name|dvi_file
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* end switch*/
block|}
comment|/* end else (ch not a SETCHAR or FNTNUM) */
block|}
comment|/* end for */
block|}
end_block

begin_macro
name|set_char
argument_list|(
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|ubyte
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|struct
name|glyph
modifier|*
name|g
decl_stmt|;
name|g
operator|=
operator|&
name|current_font
operator|->
name|glyph
index|[
name|ch
index|]
expr_stmt|;
if|if
condition|(
name|g
operator|->
name|bitmap
operator|.
name|bits
operator|==
name|NULL
condition|)
name|read_pxl_bitmap
argument_list|(
name|ch
argument_list|,
name|g
argument_list|)
expr_stmt|;
name|put_bitmap
argument_list|(
operator|&
name|g
operator|->
name|bitmap
argument_list|,
operator|(
name|PXL_H
operator|-
name|g
operator|->
name|x
operator|)
argument_list|,
operator|(
name|PXL_V
operator|-
name|g
operator|->
name|y
operator|)
argument_list|,
name|forepix
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|set_rule
argument_list|(
argument|h
argument_list|,
argument|w
argument_list|)
end_macro

begin_decl_stmt
name|long
name|h
decl_stmt|,
name|w
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* (w,h) specifies lower left corner of rule box */
name|put_rectangle
argument_list|(
name|PXL_H
argument_list|,
name|PXL_V
operator|-
name|h
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|forepix
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|begin_page
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|debug
condition|)
return|return;
if|if
condition|(
operator|!
name|redisplay
condition|)
name|clear_page
argument_list|()
expr_stmt|;
name|put_border
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|page_w
argument_list|,
name|page_h
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|end_page
argument_list|()
end_macro

begin_block
block|{
name|int
name|ch
decl_stmt|,
name|arg
decl_stmt|,
name|sign
decl_stmt|,
name|number
decl_stmt|,
name|next_page
decl_stmt|;
name|XEvent
name|event
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|int
name|nbytes
decl_stmt|;
ifdef|#
directive|ifdef
name|lint
name|number
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|debug
condition|)
block|{
if|if
condition|(
operator|++
name|current_page
operator|==
name|total_pages
condition|)
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|redisplay
condition|)
block|{
name|min_x
operator|=
name|smin_x
expr_stmt|;
name|max_x
operator|=
name|smax_x
expr_stmt|;
name|min_y
operator|=
name|smin_y
expr_stmt|;
name|max_y
operator|=
name|smax_y
expr_stmt|;
name|redisplay
operator|=
literal|0
expr_stmt|;
block|}
name|arg
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|XNextEvent
argument_list|(
operator|&
name|event
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|.
name|type
condition|)
block|{
case|case
name|ExposeWindow
case|:
name|screen_h
operator|=
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|height
expr_stmt|;
name|screen_w
operator|=
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|width
expr_stmt|;
name|max_x
operator|=
name|min_x
operator|+
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|min_y
operator|+
name|screen_h
expr_stmt|;
name|string
operator|=
literal|"\f"
expr_stmt|;
name|nbytes
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ExposeRegion
case|:
name|smin_x
operator|=
name|min_x
expr_stmt|;
name|smax_x
operator|=
name|max_x
expr_stmt|;
name|smin_y
operator|=
name|min_y
expr_stmt|;
name|smax_y
operator|=
name|max_y
expr_stmt|;
name|min_x
operator|=
name|min_x
operator|+
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|x
expr_stmt|;
name|min_y
operator|=
name|min_y
operator|+
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|y
expr_stmt|;
name|max_x
operator|=
name|min_x
operator|+
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|width
expr_stmt|;
name|max_y
operator|=
name|min_y
operator|+
operator|(
operator|(
name|XExposeEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|height
expr_stmt|;
name|redisplay
operator|=
literal|1
expr_stmt|;
name|string
operator|=
literal|"\f"
expr_stmt|;
name|nbytes
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ButtonPressed
case|:
block|{
name|short
name|detail
init|=
operator|(
operator|(
name|XButtonPressedEvent
operator|*
operator|)
operator|(
operator|&
name|event
operator|)
operator|)
operator|->
name|detail
decl_stmt|;
switch|switch
condition|(
name|detail
operator|&
name|ValueMask
condition|)
block|{
case|case
name|LeftButton
case|:
if|if
condition|(
name|detail
operator|&
name|ShiftMask
condition|)
name|string
operator|=
literal|"l"
expr_stmt|;
else|else
name|string
operator|=
literal|"b"
expr_stmt|;
name|nbytes
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|MiddleButton
case|:
if|if
condition|(
name|detail
operator|&
name|ShiftMask
condition|)
name|string
operator|=
literal|"u"
expr_stmt|;
else|else
name|string
operator|=
literal|"d"
expr_stmt|;
name|nbytes
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|RightButton
case|:
if|if
condition|(
name|detail
operator|&
name|ShiftMask
condition|)
name|string
operator|=
literal|"r"
expr_stmt|;
else|else
name|string
operator|=
literal|"f"
expr_stmt|;
name|nbytes
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
name|KeyPressed
case|:
name|string
operator|=
name|XLookupMapping
argument_list|(
operator|&
name|event
argument_list|,
operator|&
name|nbytes
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|nbytes
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|nbytes
operator|>
literal|1
condition|)
goto|goto
name|bad
goto|;
switch|switch
condition|(
name|ch
operator|=
operator|*
name|string
condition|)
block|{
case|case
literal|'q'
case|:
case|case
literal|'\003'
case|:
comment|/* control-C */
case|case
literal|'\004'
case|:
comment|/* control-D */
name|stop_output
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
case|case
literal|'f'
case|:
case|case
literal|' '
case|:
comment|/* scroll forward */
name|min_x
operator|=
literal|0
expr_stmt|;
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|screen_h
expr_stmt|;
name|next_page
operator|=
name|current_page
operator|+
literal|1
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
case|case
literal|'b'
case|:
case|case
literal|'\b'
case|:
comment|/* scroll backward */
name|min_x
operator|=
literal|0
expr_stmt|;
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|screen_h
expr_stmt|;
name|next_page
operator|=
name|current_page
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
if|if
condition|(
name|min_y
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
name|min_y
operator|-=
name|screen_h
expr_stmt|;
if|if
condition|(
name|min_y
operator|<
literal|0
condition|)
name|min_y
operator|=
literal|0
expr_stmt|;
name|base_y
operator|=
name|min_y
expr_stmt|;
name|max_y
operator|=
name|min_y
operator|+
name|screen_h
expr_stmt|;
name|next_page
operator|=
name|current_page
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
if|if
condition|(
name|min_y
operator|>=
name|page_h
operator|-
name|screen_h
condition|)
goto|goto
name|bad
goto|;
name|min_y
operator|+=
name|screen_h
expr_stmt|;
if|if
condition|(
name|min_y
operator|>
name|page_h
operator|-
name|screen_h
condition|)
name|min_y
operator|=
name|page_h
operator|-
name|screen_h
expr_stmt|;
if|if
condition|(
name|min_y
operator|<
literal|0
condition|)
name|min_y
operator|=
literal|0
expr_stmt|;
name|base_y
operator|=
name|min_y
expr_stmt|;
name|max_y
operator|=
name|min_y
operator|+
name|screen_h
expr_stmt|;
name|next_page
operator|=
name|current_page
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
if|if
condition|(
name|min_x
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
name|min_x
operator|-=
name|screen_w
expr_stmt|;
if|if
condition|(
name|min_x
operator|<
literal|0
condition|)
name|min_x
operator|=
literal|0
expr_stmt|;
name|base_x
operator|=
name|min_x
expr_stmt|;
name|max_x
operator|=
name|min_x
operator|+
name|screen_w
expr_stmt|;
name|next_page
operator|=
name|current_page
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
name|min_x
operator|>=
name|page_w
operator|-
name|screen_w
condition|)
goto|goto
name|bad
goto|;
name|min_x
operator|+=
name|screen_w
expr_stmt|;
if|if
condition|(
name|min_x
operator|>
name|page_w
operator|-
name|screen_w
condition|)
name|min_x
operator|=
name|page_w
operator|-
name|screen_w
expr_stmt|;
if|if
condition|(
name|min_x
operator|<
literal|0
condition|)
name|min_x
operator|=
literal|0
expr_stmt|;
name|base_x
operator|=
name|min_x
expr_stmt|;
name|max_x
operator|=
name|min_x
operator|+
name|screen_w
expr_stmt|;
name|next_page
operator|=
name|current_page
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
operator|!
name|arg
condition|)
block|{
name|int
name|shrink
init|=
name|shrink_factor
decl_stmt|;
name|long
name|fac1
decl_stmt|,
name|fac2
decl_stmt|;
name|shrink_factor
operator|=
literal|1
expr_stmt|;
name|fac1
operator|=
name|ROUNDUP
argument_list|(
name|PAPER_WIDTH
argument_list|,
name|screen_w
argument_list|)
expr_stmt|;
name|fac2
operator|=
name|ROUNDUP
argument_list|(
name|PAPER_HEIGHT
argument_list|,
name|screen_h
argument_list|)
expr_stmt|;
if|if
condition|(
name|fac1
operator|<
name|fac2
condition|)
name|number
operator|=
name|fac2
expr_stmt|;
else|else
name|number
operator|=
name|fac1
expr_stmt|;
name|shrink_factor
operator|=
name|shrink
expr_stmt|;
block|}
if|if
condition|(
name|number
operator|<=
literal|0
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|number
operator|!=
name|shrink_factor
condition|)
block|{
name|shrink_factor
operator|=
name|number
expr_stmt|;
name|min_x
operator|=
literal|0
expr_stmt|;
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|screen_h
expr_stmt|;
name|init_page
argument_list|()
expr_stmt|;
name|define_conv
argument_list|()
expr_stmt|;
name|reset_fonts
argument_list|()
expr_stmt|;
block|}
case|case
literal|'\f'
case|:
comment|/* redisplay current page */
name|next_page
operator|=
name|current_page
expr_stmt|;
break|break;
case|case
literal|'\r'
case|:
case|case
literal|'\n'
case|:
comment|/* go to relative page */
name|min_x
operator|=
literal|0
expr_stmt|;
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|screen_h
expr_stmt|;
name|next_page
operator|=
name|current_page
operator|+
operator|(
name|arg
condition|?
name|number
else|:
literal|1
operator|)
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
comment|/* go to absolute page */
name|min_x
operator|=
literal|0
expr_stmt|;
name|min_y
operator|=
literal|0
expr_stmt|;
name|max_x
operator|=
name|screen_w
expr_stmt|;
name|max_y
operator|=
name|screen_h
expr_stmt|;
name|next_page
operator|=
operator|(
name|arg
condition|?
name|number
else|:
name|total_pages
operator|)
operator|-
literal|1
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
if|if
condition|(
operator|!
name|arg
condition|)
block|{
name|arg
operator|=
literal|1
expr_stmt|;
name|sign
operator|=
literal|1
expr_stmt|;
name|number
operator|=
literal|0
expr_stmt|;
block|}
name|number
operator|=
literal|10
operator|*
name|number
operator|+
name|sign
operator|*
operator|(
name|ch
operator|-
literal|'0'
operator|)
expr_stmt|;
continue|continue;
case|case
literal|'-'
case|:
if|if
condition|(
operator|!
name|arg
condition|)
block|{
name|arg
operator|=
literal|1
expr_stmt|;
name|sign
operator|=
operator|-
literal|1
expr_stmt|;
name|number
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
else|else
goto|goto
name|bad
goto|;
default|default:
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
literal|0
operator|<=
name|next_page
operator|&&
name|next_page
operator|<
name|total_pages
condition|)
block|{
name|current_page
operator|=
name|next_page
expr_stmt|;
name|fseek
argument_list|(
name|dvi_file
argument_list|,
name|page_offset
index|[
name|current_page
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|bad
label|:
name|XFeep
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|arg
operator|=
literal|0
expr_stmt|;
comment|/* throw away numeric argument */
continue|continue;
block|}
block|}
end_block

begin_macro
name|special
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|long
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|cmd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cmd
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
name|nbytes
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|"xdvi: Can't allocate memory for special (%d bytes)"
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nbytes
condition|;
name|i
operator|+=
literal|1
control|)
name|cmd
index|[
name|i
index|]
operator|=
name|getc
argument_list|(
name|dvi_file
argument_list|)
expr_stmt|;
name|cmd
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"special ``%s'' not implemented\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* ** **      Read size bytes from the FILE fp, constructing them into a **      signed/unsigned integer. ** */
end_comment

begin_function
name|unsigned
name|long
name|num
parameter_list|(
name|fp
parameter_list|,
name|size
parameter_list|)
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|long
name|x
decl_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|+=
literal|1
control|)
name|x
operator|=
name|x
operator|*
literal|0x100
operator|+
operator|(
name|unsigned
operator|)
name|getc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_function
name|long
name|snum
parameter_list|(
name|fp
parameter_list|,
name|size
parameter_list|)
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|register
name|int
name|size
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|long
name|x
decl_stmt|;
name|x
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|x
operator|&
literal|0x80
condition|)
name|x
operator|-=
literal|0x100
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|+=
literal|1
control|)
name|x
operator|=
name|x
operator|*
literal|0x100
operator|+
operator|(
name|unsigned
operator|)
name|getc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
return|return
operator|(
name|x
operator|)
return|;
block|}
end_function

begin_macro
name|stop_output
argument_list|(
argument|sig
argument_list|)
end_macro

begin_block
block|{
name|exit
argument_list|(
name|sig
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* VARARGS1 */
end_comment

begin_macro
name|error
argument_list|(
argument|message
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|,
argument|f
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|message
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|message
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|init_page
argument_list|()
end_macro

begin_block
block|{
name|page_h
operator|=
name|PAPER_HEIGHT
expr_stmt|;
name|page_w
operator|=
name|PAPER_WIDTH
expr_stmt|;
block|}
end_block

begin_macro
name|clear_page
argument_list|()
end_macro

begin_block
block|{
name|XClear
argument_list|(
name|win
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|put_border
argument_list|(
argument|x
argument_list|,
argument|y
argument_list|,
argument|w
argument_list|,
argument|h
argument_list|,
argument|t
argument_list|)
end_macro

begin_decl_stmt
name|long
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|,
name|t
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|put_rectangle
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|t
argument_list|,
name|highpix
argument_list|)
expr_stmt|;
name|put_rectangle
argument_list|(
name|x
argument_list|,
name|y
argument_list|,
name|t
argument_list|,
name|h
argument_list|,
name|highpix
argument_list|)
expr_stmt|;
name|put_rectangle
argument_list|(
name|x
argument_list|,
name|y
operator|+
name|h
operator|-
name|t
argument_list|,
name|w
argument_list|,
name|t
argument_list|,
name|highpix
argument_list|)
expr_stmt|;
name|put_rectangle
argument_list|(
name|x
operator|+
name|w
operator|-
name|t
argument_list|,
name|y
argument_list|,
name|t
argument_list|,
name|h
argument_list|,
name|highpix
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|put_rectangle
argument_list|(
argument|x
argument_list|,
argument|y
argument_list|,
argument|w
argument_list|,
argument|h
argument_list|,
argument|pix
argument_list|)
end_macro

begin_decl_stmt
name|long
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pix
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|x
operator|<
name|max_x
operator|&&
name|x
operator|+
name|w
operator|>=
name|min_x
operator|&&
name|y
operator|<
name|max_y
operator|&&
name|y
operator|+
name|h
operator|>=
name|min_y
condition|)
name|XPixSet
argument_list|(
name|win
argument_list|,
name|x
operator|-
name|base_x
argument_list|,
name|y
operator|-
name|base_y
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|pix
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|put_bitmap
argument_list|(
name|bitmap
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|pix
argument_list|)
specifier|register
expr|struct
name|bitmap
operator|*
name|bitmap
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|long
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pix
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|x
operator|<
name|max_x
operator|&&
name|x
operator|+
name|bitmap
operator|->
name|w
operator|>=
name|min_x
operator|&&
name|y
operator|<
name|max_y
operator|&&
name|y
operator|+
name|bitmap
operator|->
name|h
operator|>=
name|min_y
condition|)
name|XBitmapBitsPut
argument_list|(
name|win
argument_list|,
name|x
operator|-
name|base_x
argument_list|,
name|y
operator|-
name|base_y
argument_list|,
name|bitmap
operator|->
name|w
argument_list|,
name|bitmap
operator|->
name|h
argument_list|,
operator|(
name|char
operator|*
operator|)
name|bitmap
operator|->
name|bits
argument_list|,
name|pix
argument_list|,
name|backpix
argument_list|,
name|NULL
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|sample
argument_list|(
name|bitmap
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|)
specifier|register
expr|struct
name|bitmap
operator|*
name|bitmap
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|w
decl_stmt|,
name|h
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|endp
decl_stmt|;
specifier|register
name|int
name|b
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|,
name|m
decl_stmt|,
name|n
decl_stmt|;
name|ptr
operator|=
name|bitmap
operator|->
name|bits
operator|+
operator|(
name|y
operator|*
name|bitmap
operator|->
name|bytes_wide
operator|)
operator|+
operator|(
name|x
operator|/
name|BITS_PER_BYTE
operator|)
expr_stmt|;
name|endp
operator|=
name|bitmap
operator|->
name|bits
operator|+
operator|(
name|bitmap
operator|->
name|h
operator|*
name|bitmap
operator|->
name|bytes_wide
operator|)
expr_stmt|;
name|b
operator|=
operator|(
literal|1
operator|<<
operator|(
name|x
operator|%
name|BITS_PER_BYTE
operator|)
operator|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|h
operator|&&
name|ptr
operator|<
name|endp
condition|;
name|i
operator|+=
literal|1
operator|,
name|ptr
operator|+=
name|bitmap
operator|->
name|bytes_wide
control|)
for|for
control|(
name|m
operator|=
name|b
operator|,
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|w
condition|;
name|j
operator|+=
literal|1
operator|,
name|m
operator|<<=
literal|1
control|)
if|if
condition|(
operator|*
name|ptr
operator|&
name|m
condition|)
name|n
operator|+=
literal|1
expr_stmt|;
return|return
operator|(
name|n
operator|>=
operator|(
name|i
operator|*
name|w
operator|)
operator|/
literal|3
operator|)
return|;
block|}
end_block

begin_expr_stmt
name|shrink_bitmap
argument_list|(
name|bitmap
argument_list|,
name|x_factor
argument_list|,
name|y_factor
argument_list|)
specifier|register
expr|struct
name|bitmap
operator|*
name|bitmap
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|x_factor
decl_stmt|,
name|y_factor
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|shrunk_bits
decl_stmt|;
name|int
name|shrunk_height
decl_stmt|,
name|shrunk_width
decl_stmt|,
name|shrunk_bytes_wide
decl_stmt|;
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|b
decl_stmt|,
name|m
decl_stmt|;
name|shrunk_height
operator|=
name|ROUNDUP
argument_list|(
name|bitmap
operator|->
name|h
argument_list|,
name|y_factor
argument_list|)
expr_stmt|;
name|shrunk_width
operator|=
name|ROUNDUP
argument_list|(
name|bitmap
operator|->
name|w
argument_list|,
name|x_factor
argument_list|)
expr_stmt|;
name|shrunk_bytes_wide
operator|=
name|ROUNDUP
argument_list|(
name|shrunk_width
argument_list|,
name|BITS_PER_SHORT
argument_list|)
operator|*
name|BYTES_PER_SHORT
expr_stmt|;
comment|/* width must be multiple of 16 bits for raster_op */
name|ptr
operator|=
name|shrunk_bits
operator|=
name|calloc
argument_list|(
operator|(
name|unsigned
operator|)
name|shrunk_height
operator|*
name|shrunk_bytes_wide
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|"Can't allocate shrunken bitmap (%d by %d)"
argument_list|,
name|shrunk_height
argument_list|,
name|shrunk_width
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|bitmap
operator|->
name|h
condition|;
name|y
operator|+=
name|y_factor
control|)
block|{
name|b
operator|=
literal|0
expr_stmt|;
name|m
operator|=
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
name|cp
operator|=
name|ptr
expr_stmt|;
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|bitmap
operator|->
name|w
condition|;
name|x
operator|+=
name|x_factor
control|)
block|{
if|if
condition|(
name|sample
argument_list|(
name|bitmap
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|x_factor
argument_list|,
name|y_factor
argument_list|)
condition|)
operator|*
name|ptr
operator||=
name|m
expr_stmt|;
else|else
operator|*
name|ptr
operator|&=
operator|~
name|m
expr_stmt|;
name|b
operator|+=
literal|1
expr_stmt|;
name|m
operator|<<=
literal|1
expr_stmt|;
if|if
condition|(
name|b
operator|%
name|BITS_PER_BYTE
operator|==
literal|0
condition|)
block|{
name|b
operator|=
literal|0
expr_stmt|;
name|m
operator|=
operator|(
literal|1
operator|<<
literal|0
operator|)
expr_stmt|;
name|ptr
operator|+=
literal|1
expr_stmt|;
block|}
block|}
name|ptr
operator|=
name|cp
operator|+
name|shrunk_bytes_wide
expr_stmt|;
block|}
name|free
argument_list|(
name|bitmap
operator|->
name|bits
argument_list|)
expr_stmt|;
name|bitmap
operator|->
name|bits
operator|=
name|shrunk_bits
expr_stmt|;
name|bitmap
operator|->
name|h
operator|=
name|shrunk_height
expr_stmt|;
name|bitmap
operator|->
name|w
operator|=
name|shrunk_width
expr_stmt|;
name|bitmap
operator|->
name|bytes_wide
operator|=
name|shrunk_bytes_wide
expr_stmt|;
block|}
end_block

begin_macro
name|print_char
argument_list|(
argument|ch
argument_list|,
argument|g
argument_list|)
end_macro

begin_decl_stmt
name|ubyte
name|ch
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|glyph
modifier|*
name|g
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"char %d"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
if|if
condition|(
name|isprint
argument_list|(
name|ch
argument_list|)
condition|)
name|printf
argument_list|(
literal|" (%c)"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"x = %d, y = %d, pxl = %d, dvi = %d\n"
argument_list|,
name|g
operator|->
name|x
argument_list|,
name|g
operator|->
name|y
argument_list|,
name|g
operator|->
name|pxl_adv
argument_list|,
name|g
operator|->
name|dvi_adv
argument_list|)
expr_stmt|;
name|print_bitmap
argument_list|(
operator|&
name|g
operator|->
name|bitmap
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|print_bitmap
argument_list|(
name|bitmap
argument_list|)
specifier|register
expr|struct
name|bitmap
operator|*
name|bitmap
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ptr
decl_stmt|;
specifier|register
name|int
name|x
decl_stmt|,
name|y
decl_stmt|,
name|i
decl_stmt|;
name|ptr
operator|=
name|bitmap
operator|->
name|bits
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
return|return;
name|printf
argument_list|(
literal|"w = %d, h = %d, bytes wide = %d\n"
argument_list|,
name|bitmap
operator|->
name|w
argument_list|,
name|bitmap
operator|->
name|h
argument_list|,
name|bitmap
operator|->
name|bytes_wide
argument_list|)
expr_stmt|;
for|for
control|(
name|y
operator|=
literal|0
init|;
name|y
operator|<
name|bitmap
operator|->
name|h
condition|;
name|y
operator|+=
literal|1
control|)
block|{
for|for
control|(
name|x
operator|=
literal|0
init|;
name|x
operator|<
name|bitmap
operator|->
name|bytes_wide
condition|;
name|x
operator|+=
literal|1
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BITS_PER_BYTE
condition|;
name|i
operator|+=
literal|1
control|)
if|if
condition|(
operator|*
name|ptr
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
name|putchar
argument_list|(
literal|'@'
argument_list|)
expr_stmt|;
else|else
name|putchar
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|1
expr_stmt|;
block|}
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|print_dvi
argument_list|(
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|ubyte
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"%4d %4d "
argument_list|,
name|PXL_H
argument_list|,
name|PXL_V
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|<=
name|SETCHAR0
operator|+
literal|127
condition|)
block|{
name|printf
argument_list|(
literal|"SETCHAR%-3d"
argument_list|,
name|ch
operator|-
name|SETCHAR0
argument_list|)
expr_stmt|;
if|if
condition|(
name|isprint
argument_list|(
name|ch
argument_list|)
condition|)
name|printf
argument_list|(
literal|" (%c)"
argument_list|,
name|ch
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FNTNUM0
operator|<=
name|ch
operator|&&
name|ch
operator|<=
name|FNTNUM0
operator|+
literal|63
condition|)
block|{
name|printf
argument_list|(
literal|"FNTNUM%d"
argument_list|,
name|ch
operator|-
name|FNTNUM0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SET1
case|:
name|printf
argument_list|(
literal|"SET1"
argument_list|)
expr_stmt|;
break|break;
case|case
name|SETRULE
case|:
name|printf
argument_list|(
literal|"SETRULE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUT1
case|:
name|printf
argument_list|(
literal|"PUT1"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUTRULE
case|:
name|printf
argument_list|(
literal|"PUTRULE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NOP
case|:
name|printf
argument_list|(
literal|"NOP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|BOP
case|:
name|printf
argument_list|(
literal|"BOP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EOP
case|:
name|printf
argument_list|(
literal|"EOP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUSH
case|:
name|printf
argument_list|(
literal|"PUSH"
argument_list|)
expr_stmt|;
break|break;
case|case
name|POP
case|:
name|printf
argument_list|(
literal|"POP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|RIGHT1
case|:
case|case
name|RIGHT2
case|:
case|case
name|RIGHT3
case|:
case|case
name|RIGHT4
case|:
name|printf
argument_list|(
literal|"RIGHT%d"
argument_list|,
name|ch
operator|-
name|RIGHT1
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|X0
case|:
case|case
name|X1
case|:
case|case
name|X2
case|:
case|case
name|X3
case|:
case|case
name|X4
case|:
name|printf
argument_list|(
literal|"X%d"
argument_list|,
name|ch
operator|-
name|X0
argument_list|)
expr_stmt|;
break|break;
case|case
name|W0
case|:
case|case
name|W1
case|:
case|case
name|W2
case|:
case|case
name|W3
case|:
case|case
name|W4
case|:
name|printf
argument_list|(
literal|"W%d"
argument_list|,
name|ch
operator|-
name|W0
argument_list|)
expr_stmt|;
break|break;
case|case
name|Y0
case|:
case|case
name|Y1
case|:
case|case
name|Y2
case|:
case|case
name|Y3
case|:
case|case
name|Y4
case|:
name|printf
argument_list|(
literal|"Y%d"
argument_list|,
name|ch
operator|-
name|Y0
argument_list|)
expr_stmt|;
break|break;
case|case
name|Z0
case|:
case|case
name|Z1
case|:
case|case
name|Z2
case|:
case|case
name|Z3
case|:
case|case
name|Z4
case|:
name|printf
argument_list|(
literal|"Z%d"
argument_list|,
name|ch
operator|-
name|Z0
argument_list|)
expr_stmt|;
break|break;
case|case
name|DOWN1
case|:
case|case
name|DOWN2
case|:
case|case
name|DOWN3
case|:
case|case
name|DOWN4
case|:
name|printf
argument_list|(
literal|"DOWN%d"
argument_list|,
name|ch
operator|-
name|DOWN1
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|FNT1
case|:
case|case
name|FNT2
case|:
case|case
name|FNT3
case|:
case|case
name|FNT4
case|:
name|printf
argument_list|(
literal|"FNT%d"
argument_list|,
name|ch
operator|-
name|FNT1
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|XXX1
case|:
case|case
name|XXX2
case|:
case|case
name|XXX3
case|:
case|case
name|XXX4
case|:
name|printf
argument_list|(
literal|"XXX%d"
argument_list|,
name|ch
operator|-
name|XXX1
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|FNTDEF1
case|:
case|case
name|FNTDEF2
case|:
case|case
name|FNTDEF3
case|:
case|case
name|FNTDEF4
case|:
name|printf
argument_list|(
literal|"FNTDEF%d"
argument_list|,
name|ch
operator|-
name|FNTDEF1
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRE
case|:
name|printf
argument_list|(
literal|"PRE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|POST
case|:
name|printf
argument_list|(
literal|"POST"
argument_list|)
expr_stmt|;
break|break;
case|case
name|POSTPOST
case|:
name|printf
argument_list|(
literal|"POSTPOST"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
literal|"xdvi: Unknown op-code %d, offset %d"
argument_list|,
name|ch
argument_list|,
name|ftell
argument_list|(
name|dvi_file
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* end switch*/
block|}
comment|/* end else (ch not a SETCHAR or FNTNUM) */
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


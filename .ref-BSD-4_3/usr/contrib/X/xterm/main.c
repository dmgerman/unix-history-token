begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/* Copyright    Massachusetts Institute of Technology    1984, 1985	*/
end_comment

begin_comment
comment|/* ptyx.c */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_ptyx_c
init|=
literal|"$Header: main.c,v 10.44 86/05/16 10:17:20 jg Exp $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|"ptyx.h"
end_include

begin_include
include|#
directive|include
file|<grp.h>
end_include

begin_include
include|#
directive|include
file|<ttyent.h>
end_include

begin_include
include|#
directive|include
file|<utmp.h>
end_include

begin_decl_stmt
name|char
modifier|*
name|xterm_name
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* argv[0] */
end_comment

begin_decl_stmt
name|Terminal
name|term
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* master data structure for client */
end_comment

begin_decl_stmt
name|int
name|am_slave
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* set to 1 if running as a slave process */
end_comment

begin_decl_stmt
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true causes error messages to be displayed */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ptydev
init|=
literal|"/dev/ptyxx"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|ttydev
init|=
literal|"/dev/ttyxx"
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|"../cursors/xterm.cursor"
end_include

begin_include
include|#
directive|include
file|"../cursors/xterm_mask.cursor"
end_include

begin_include
include|#
directive|include
file|"icon.ic"
end_include

begin_include
include|#
directive|include
file|"icon_mask.ic"
end_include

begin_function_decl
specifier|static
name|int
name|reapchild
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
modifier|*
modifier|*
name|command_to_exec
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|win_name
init|=
operator|(
name|char
operator|*
operator|)
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sgttyb
name|d_sg
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0177
block|,
name|CKILL
block|,
name|EVENP
operator||
name|ODDP
operator||
name|ECHO
operator||
name|XTABS
operator||
name|CRMOD
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tchars
name|d_tc
init|=
block|{
name|CINTR
block|,
name|CQUIT
block|,
name|CSTART
block|,
name|CSTOP
block|,
name|CEOF
block|,
name|CBRK
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|ltchars
name|d_ltc
init|=
block|{
name|CSUSP
block|,
name|CDSUSP
block|,
name|CRPRNT
block|,
name|CFLUSH
block|,
name|CWERASE
block|,
name|CLNEXT
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|d_disipline
init|=
name|NTTYDISC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|d_lmode
init|=
name|LCRTBS
operator||
name|LCRTERA
operator||
name|LCRTKIL
operator||
name|LCTLECH
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|no_dev_tty
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|loginflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dologinflag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|sun
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|TIOCCONS
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|SunConsole
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|TIOCCONS
end_endif

begin_endif
endif|#
directive|endif
endif|sun
end_endif

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|ind
decl_stmt|;
name|char
modifier|*
name|strind
decl_stmt|,
modifier|*
name|strind1
decl_stmt|,
modifier|*
name|strscan
argument_list|()
decl_stmt|;
name|char
modifier|*
name|fn
init|=
literal|"vtsingle"
decl_stmt|;
name|char
modifier|*
name|fb
init|=
literal|"vtbold"
decl_stmt|;
name|short
name|fnflag
init|=
literal|0
decl_stmt|;
comment|/* True iff -fn option used */
name|short
name|fbflag
init|=
literal|0
decl_stmt|;
comment|/* True iff -fb option used */
name|char
modifier|*
name|getty
init|=
name|NULL
decl_stmt|;
name|int
name|reverse
init|=
literal|0
decl_stmt|,
name|multiscroll
init|=
literal|0
decl_stmt|;
name|int
name|border
init|=
literal|1
decl_stmt|,
name|tek
init|=
literal|0
decl_stmt|;
name|int
name|borderwidth
init|=
literal|2
decl_stmt|;
name|int
name|bitmapicon
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|JUMPSCROLL
name|int
name|jumpscroll
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
endif|JUMPSCROLL
name|int
name|slave
init|=
literal|0
decl_stmt|;
comment|/* if non-zero, run as slave */
name|char
name|passedPty
index|[
literal|2
index|]
decl_stmt|;
comment|/* name if pty if slave */
name|char
modifier|*
name|fore_color
decl_stmt|;
name|char
modifier|*
name|back_color
decl_stmt|;
name|char
modifier|*
name|brdr_color
decl_stmt|;
name|char
modifier|*
name|curs_color
decl_stmt|;
name|char
modifier|*
name|mous_color
decl_stmt|;
name|char
name|display
index|[
literal|256
index|]
decl_stmt|;
name|char
modifier|*
name|getenv
parameter_list|()
function_decl|;
name|char
modifier|*
name|option
decl_stmt|;
name|char
modifier|*
name|geometry
decl_stmt|,
modifier|*
name|def
init|=
literal|"=80x24+1+1"
decl_stmt|;
name|xterm_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|display
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* 	 * go get options out of default file 	 */
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"BodyFont"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|fn
operator|=
name|option
expr_stmt|;
name|fnflag
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"BoldFont"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|fb
operator|=
name|option
expr_stmt|;
name|fbflag
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"InternalBorder"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|border
operator|=
name|atoi
argument_list|(
name|option
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"BorderWidth"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|borderwidth
operator|=
name|atoi
argument_list|(
name|option
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"BitmapIcon"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|bitmapicon
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"ReverseVideo"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|reverse
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"Tektronix"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|tek
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|JUMPSCROLL
if|if
condition|(
operator|(
name|option
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"JumpScroll"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
if|if
condition|(
name|strcmp
argument_list|(
name|option
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|jumpscroll
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
endif|JUMPSCROLL
name|fore_color
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"Foreground"
argument_list|)
expr_stmt|;
name|back_color
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"Background"
argument_list|)
expr_stmt|;
name|brdr_color
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"Border"
argument_list|)
expr_stmt|;
name|curs_color
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"Cursor"
argument_list|)
expr_stmt|;
name|mous_color
operator|=
name|XGetDefault
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"Mouse"
argument_list|)
expr_stmt|;
comment|/* parse command line */
for|for
control|(
name|ind
operator|=
literal|1
init|;
name|ind
operator|<
name|argc
condition|;
name|ind
operator|++
control|)
block|{
if|if
condition|(
name|argv
index|[
name|ind
index|]
index|[
literal|0
index|]
operator|==
literal|'='
condition|)
block|{
name|geometry
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
name|strind
operator|=
name|index
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|strind
operator|!=
name|NULL
condition|)
block|{
name|strncpy
argument_list|(
name|display
argument_list|,
name|argv
index|[
name|ind
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|display
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|strind
operator|=
operator|(
name|char
operator|*
operator|)
name|index
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|strind
operator|==
name|NULL
condition|)
name|Syntax
argument_list|()
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-L"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
name|tt
index|[
literal|32
index|]
decl_stmt|;
name|int
name|mode
init|=
name|O_RDWR
operator||
name|O_NDELAY
decl_stmt|;
name|loginflag
operator|=
literal|1
expr_stmt|;
name|getty
operator|=
name|argv
index|[
name|argc
operator|-
literal|1
index|]
expr_stmt|;
name|argc
operator|-=
literal|1
expr_stmt|;
name|strcpy
argument_list|(
name|tt
argument_list|,
literal|"/dev/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|tt
argument_list|,
name|getty
argument_list|)
expr_stmt|;
name|chown
argument_list|(
name|tt
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|tt
argument_list|,
literal|0622
argument_list|)
expr_stmt|;
if|if
condition|(
name|open
argument_list|(
name|tt
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|consolepr
argument_list|(
literal|"open failed\n"
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|vhangup
argument_list|()
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|open
argument_list|(
name|tt
argument_list|,
name|mode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-S"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sscanf
argument_list|(
name|argv
index|[
name|ind
index|]
operator|+
literal|2
argument_list|,
literal|"%c%c%d"
argument_list|,
name|passedPty
argument_list|,
name|passedPty
operator|+
literal|1
argument_list|,
operator|&
name|slave
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
operator|<=
literal|0
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|am_slave
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-e"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|command_to_exec
operator|=
name|argv
operator|+
name|ind
expr_stmt|;
break|break;
block|}
comment|/* Switch to set up Tektronix-shaped (4096x3128 -> 512x390) window 	     * with characters sized to fit 39 lines of 85 characters each */
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-t"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tek
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|fnflag
condition|)
name|fn
operator|=
literal|"6x10"
expr_stmt|;
if|if
condition|(
operator|!
name|fbflag
condition|)
name|fb
operator|=
literal|"6x10"
expr_stmt|;
name|def
operator|=
literal|"85x39+1+1"
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-fn"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|fn
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
name|fnflag
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-fb"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|fb
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
name|fbflag
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-fg"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|fore_color
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-bg"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|back_color
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-bd"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|brdr_color
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-cr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|curs_color
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-ms"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|mous_color
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-l"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|dologinflag
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-d"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|debug
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-b"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|border
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-bw"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-w"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|borderwidth
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-rv"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-r"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reverse
operator|=
literal|1
expr_stmt|;
comment|/* backwards from usual definition */
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-s"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|multiscroll
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-i"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bitmapicon
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|JUMPSCROLL
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-j"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|jumpscroll
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
endif|JUMPSCROLL
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-n"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|ind
operator|>=
name|argc
condition|)
name|Syntax
argument_list|()
expr_stmt|;
name|win_name
operator|=
name|argv
index|[
name|ind
index|]
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|sun
ifdef|#
directive|ifdef
name|TIOCCONS
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|ind
index|]
argument_list|,
literal|"-C"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|SunConsole
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
endif|TIOCCONS
endif|#
directive|endif
endif|sun
name|Syntax
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|fnflag
operator|&&
operator|!
name|fbflag
condition|)
name|fb
operator|=
name|fn
expr_stmt|;
if|if
condition|(
operator|!
name|fnflag
operator|&&
name|fbflag
condition|)
name|fn
operator|=
name|fb
expr_stmt|;
ifdef|#
directive|ifdef
name|JUMPSCROLL
if|if
condition|(
name|tek
condition|)
name|jumpscroll
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
endif|JUMPSCROLL
name|Serve
argument_list|(
name|display
argument_list|,
name|fn
argument_list|,
name|fb
argument_list|,
name|geometry
argument_list|,
name|def
argument_list|,
name|getty
argument_list|,
name|slave
argument_list|,
name|passedPty
argument_list|,
name|border
argument_list|,
name|borderwidth
argument_list|,
name|tek
argument_list|,
name|reverse
argument_list|,
name|multiscroll
argument_list|,
name|bitmapicon
argument_list|,
name|fore_color
argument_list|,
name|back_color
argument_list|,
name|brdr_color
argument_list|,
name|curs_color
argument_list|,
name|mous_color
ifdef|#
directive|ifdef
name|JUMPSCROLL
argument_list|,
name|jumpscroll
endif|#
directive|endif
endif|JUMPSCROLL
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|Syntax
argument_list|()
end_macro

begin_block
block|{
specifier|static
name|char
modifier|*
name|ustring
index|[]
init|=
block|{
literal|"Usage: xterm [-rv] [-fn normal_font] [-fb bold_font]\n"
block|,
literal|"\t[=[width]x[height][[+-]xoff[[+-]yoff]]] [-bw bdr_width]\n"
block|,
literal|"\t[-fg color] [-bg color] [-bd color] [-cr color] [-ms color]\n"
block|,
literal|"\t[[[host]:vs]] [-d] [-s] [-t] [-i] [-j] [-e command_to_exec]\n"
block|,
literal|"\t[-n window_name]\n\n"
block|,
literal|"Fonts must be of fixed width and of same size;\n"
block|,
literal|"If only one font is specified, it will be used for normal and bold text\n"
block|,
ifdef|#
directive|ifdef
name|JUMPSCROLL
literal|"The -j option enables jump scroll\n"
block|,
endif|#
directive|endif
literal|"The -s option enables asynchronous scrolling\n"
block|,
literal|"The -t option enables Tektronics 4010 emulation\n"
block|,
literal|"The -i option enables bitmap icons\n"
block|,
literal|"The -d option turns debugging on (error messages printed)\n"
block|,
literal|"The -n option sets the window name\n"
block|,
literal|"The -b option specifies the inner padding\n"
block|,
literal|"Default is: xterm -fn vtsingle -fb vtbold =80x24 :0\n"
block|,
literal|0
block|}
decl_stmt|;
name|char
modifier|*
modifier|*
name|us
init|=
name|ustring
decl_stmt|;
while|while
condition|(
operator|*
name|us
condition|)
name|fputs
argument_list|(
operator|*
name|us
operator|++
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|char
modifier|*
name|strscan
parameter_list|(
name|search
parameter_list|,
name|what
parameter_list|)
comment|/*    Returns pointer to first char ins search which is also in what, else NULL.  */
name|char
modifier|*
name|search
decl_stmt|,
decl|*
name|what
decl_stmt|;
end_function

begin_block
block|{
name|int
name|i
decl_stmt|,
name|len
init|=
name|strlen
argument_list|(
name|what
argument_list|)
decl_stmt|;
name|char
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
operator|(
name|search
operator|++
operator|)
operator|)
operator|!=
name|NULL
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|c
operator|==
name|what
index|[
name|i
index|]
condition|)
return|return
operator|(
operator|--
name|search
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_block

begin_macro
name|Serve
argument_list|(
argument|disp
argument_list|,
argument|fn
argument_list|,
argument|fb
argument_list|,
argument|geometry
argument_list|,
argument|def
argument_list|,
argument|getty
argument_list|,
argument|slave
argument_list|,
argument|passedPty
argument_list|,
argument|border
argument_list|,
argument|borderwidth
argument_list|,
argument|tek
argument_list|,
argument|reverse
argument_list|,
argument|multiscroll
argument_list|,
argument|bitmapicon
argument_list|,
argument|fore_color
argument_list|,
argument|back_color
argument_list|,
argument|brdr_color
argument_list|,
argument|curs_color
argument_list|,
argument|mous_color
ifdef|#
directive|ifdef
name|JUMPSCROLL
argument_list|,
argument|jumpscroll
endif|#
directive|endif
endif|JUMPSCROLL
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|disp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* host of display to serve */
end_comment

begin_decl_stmt
name|char
modifier|*
name|fn
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fontname of normal characters */
end_comment

begin_decl_stmt
name|char
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* fontname of bold characters */
end_comment

begin_decl_stmt
name|char
modifier|*
name|getty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true iff child should be getty */
end_comment

begin_decl_stmt
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true if should run as slave (contains file # of pty) */
end_comment

begin_decl_stmt
name|char
modifier|*
name|passedPty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* name of pty to use if slave */
end_comment

begin_decl_stmt
name|char
modifier|*
name|geometry
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* user supplied geometry spec */
end_comment

begin_decl_stmt
name|char
modifier|*
name|def
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* default geometry spec */
end_comment

begin_decl_stmt
name|int
name|border
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* inner border in pixels */
end_comment

begin_decl_stmt
name|int
name|borderwidth
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* outer border in pixels */
end_comment

begin_decl_stmt
name|int
name|tek
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true ==> Tektronics emulation */
end_comment

begin_decl_stmt
name|int
name|reverse
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true ==> black background, white characters */
end_comment

begin_decl_stmt
name|int
name|multiscroll
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true ==> asynchronous full-screen scrolling */
end_comment

begin_decl_stmt
name|int
name|bitmapicon
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true ==> bitmap icons rather than text icon */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|JUMPSCROLL
end_ifdef

begin_decl_stmt
name|int
name|jumpscroll
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* true ==> fast multi-line scrolling */
end_comment

begin_endif
endif|#
directive|endif
endif|JUMPSCROLL
end_endif

begin_decl_stmt
name|char
modifier|*
name|fore_color
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* text color */
end_comment

begin_decl_stmt
name|char
modifier|*
name|back_color
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* background color */
end_comment

begin_decl_stmt
name|char
modifier|*
name|brdr_color
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* border color */
end_comment

begin_decl_stmt
name|char
modifier|*
name|curs_color
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* text cursor color */
end_comment

begin_decl_stmt
name|char
modifier|*
name|mous_color
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* mouse cursor color */
end_comment

begin_block
block|{
name|int
name|pty
decl_stmt|;
comment|/* fildes for pty of client */
name|XEvent
name|reply
decl_stmt|;
name|XEvent
modifier|*
name|rep
init|=
operator|&
name|reply
decl_stmt|;
name|int
name|aborted
init|=
literal|0
decl_stmt|;
name|int
name|Select_mask
decl_stmt|,
name|select_mask
init|=
literal|0
decl_stmt|;
name|int
name|maxplus1
decl_stmt|;
name|short
name|toggled
init|=
name|NULL
decl_stmt|;
name|Screen
modifier|*
name|screen
init|=
operator|&
name|term
operator|.
name|screen
decl_stmt|;
name|int
name|Xsocket
decl_stmt|;
name|int
name|pty_mask
decl_stmt|,
name|X_mask
decl_stmt|;
specifier|extern
name|int
name|errno
decl_stmt|;
name|int
name|mode
init|=
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|TIOCSWINSZ
name|struct
name|winsize
name|ws
decl_stmt|;
endif|#
directive|endif
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|reapchild
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* open a terminal for client */
name|get_terminal
argument_list|(
name|disp
argument_list|,
operator|&
name|term
argument_list|,
name|fn
argument_list|,
name|fb
argument_list|,
name|geometry
argument_list|,
name|def
argument_list|,
name|border
argument_list|,
name|borderwidth
argument_list|,
operator|(
name|int
operator|)
name|getty
argument_list|,
name|slave
argument_list|,
name|reverse
argument_list|,
name|multiscroll
argument_list|,
name|bitmapicon
argument_list|,
name|tek
argument_list|,
name|fore_color
argument_list|,
name|back_color
argument_list|,
name|brdr_color
argument_list|,
name|curs_color
argument_list|,
name|mous_color
ifdef|#
directive|ifdef
name|JUMPSCROLL
argument_list|,
name|jumpscroll
endif|#
directive|endif
endif|JUMPSCROLL
argument_list|)
expr_stmt|;
name|Xsocket
operator|=
name|screen
operator|->
name|display
operator|->
name|fd
expr_stmt|;
name|spawn
argument_list|(
name|disp
argument_list|,
operator|&
name|pty
argument_list|,
name|Xsocket
argument_list|,
name|screen
argument_list|,
name|getty
argument_list|,
name|slave
argument_list|,
name|passedPty
argument_list|)
expr_stmt|;
if|if
condition|(
name|slave
condition|)
block|{
comment|/* Write window id so master end can read and use */
name|write
argument_list|(
name|pty
argument_list|,
operator|&
name|screen
operator|->
name|window
argument_list|,
sizeof|sizeof
argument_list|(
name|screen
operator|->
name|window
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|pty
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|respond
operator|=
name|term
operator|.
name|buf
operator|.
name|fildes
operator|=
name|pty
expr_stmt|;
ifdef|#
directive|ifdef
name|TIOCSWINSZ
comment|/* tell tty how big window is */
name|ws
operator|.
name|ws_row
operator|=
name|screen
operator|->
name|max_row
operator|+
literal|1
expr_stmt|;
name|ws
operator|.
name|ws_col
operator|=
name|screen
operator|->
name|max_col
operator|+
literal|1
expr_stmt|;
name|ws
operator|.
name|ws_xpixel
operator|=
name|screen
operator|->
name|width
expr_stmt|;
name|ws
operator|.
name|ws_ypixel
operator|=
name|screen
operator|->
name|height
expr_stmt|;
name|ioctl
argument_list|(
name|screen
operator|->
name|respond
argument_list|,
name|TIOCSWINSZ
argument_list|,
operator|&
name|ws
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Initialize Tektronix graphics mode parameters */
name|TekErase
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
name|screen
operator|->
name|TekEmu
operator|=
name|tek
expr_stmt|;
name|screen
operator|->
name|cur_x
operator|=
name|screen
operator|->
name|cur_y
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
name|screen
operator|->
name|cur_Y
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|TekGMode
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|TekAMode
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|TekPMode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|pty
argument_list|,
name|FIONBIO
argument_list|,
operator|&
name|mode
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
name|pty_mask
operator|=
literal|1
operator|<<
name|pty
expr_stmt|;
name|X_mask
operator|=
literal|1
operator|<<
name|Xsocket
expr_stmt|;
name|Select_mask
operator|=
name|pty_mask
operator||
name|X_mask
expr_stmt|;
name|maxplus1
operator|=
operator|(
name|pty
operator|<
name|Xsocket
operator|)
condition|?
operator|(
literal|1
operator|+
name|Xsocket
operator|)
else|:
operator|(
literal|1
operator|+
name|pty
operator|)
expr_stmt|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"debugging on\n"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|aborted
condition|)
block|{
ifdef|#
directive|ifdef
name|JUMPSCROLL
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|JUMPSCROLL
if|if
condition|(
name|toggled
condition|)
block|{
name|CursorToggle
argument_list|(
name|screen
argument_list|,
name|toggled
argument_list|)
expr_stmt|;
name|toggled
operator|=
name|NULL
expr_stmt|;
block|}
name|select_mask
operator|=
name|Select_mask
expr_stmt|;
name|XFlush
argument_list|()
expr_stmt|;
while|while
condition|(
name|select
argument_list|(
name|maxplus1
argument_list|,
operator|&
name|select_mask
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EINTR
condition|)
name|Error
argument_list|()
expr_stmt|;
block|}
block|}
else|else
name|select_mask
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|select_mask
operator|&
name|pty_mask
operator|||
name|aborted
condition|)
block|{
if|if
condition|(
operator|!
name|toggled
condition|)
block|{
name|CursorToggle
argument_list|(
name|screen
argument_list|,
name|toggled
argument_list|)
expr_stmt|;
name|toggled
operator|=
literal|1
expr_stmt|;
block|}
do|do
block|{
name|aborted
operator|=
call|(
modifier|*
name|screen
operator|->
name|mode
call|)
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|screen
operator|->
name|display
operator|->
name|qlen
operator|==
literal|0
operator|&&
name|term
operator|.
name|buf
operator|.
name|cnt
operator|>
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|select_mask
operator|&
name|X_mask
operator|||
name|aborted
condition|)
block|{
ifdef|#
directive|ifdef
name|JUMPSCROLL
if|if
condition|(
name|screen
operator|->
name|scroll_amt
condition|)
name|FlushScroll
argument_list|(
name|screen
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|JUMPSCROLL
name|XPending
argument_list|()
expr_stmt|;
do|do
block|{
name|XNextEvent
argument_list|(
operator|&
name|reply
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|reply
operator|.
name|type
condition|)
block|{
case|case
name|KeyPressed
case|:
name|Input
argument_list|(
operator|&
name|term
operator|.
name|keyboard
argument_list|,
operator|&
name|term
operator|.
name|screen
argument_list|,
operator|(
name|XKeyPressedEvent
operator|*
operator|)
name|rep
argument_list|)
expr_stmt|;
break|break;
case|case
name|ExposeWindow
case|:
if|if
condition|(
name|bitmapicon
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|window
operator|==
name|screen
operator|->
name|iconwindow
condition|)
block|{
name|RefreshIcon
argument_list|(
name|screen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|toggled
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ScreenResize
argument_list|(
name|screen
argument_list|,
operator|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|width
argument_list|,
operator|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|height
argument_list|,
operator|&
name|term
operator|.
name|flags
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|TabReset
argument_list|(
name|term
operator|.
name|tabs
argument_list|)
expr_stmt|;
name|XClear
argument_list|(
name|screen
operator|->
name|window
argument_list|)
expr_stmt|;
name|ScrnRefresh
argument_list|(
name|screen
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|TekEmu
condition|)
name|TekRefresh
argument_list|(
operator|&
name|term
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ExposeRegion
case|:
if|if
condition|(
operator|(
operator|(
name|XExposeWindowEvent
operator|*
operator|)
name|rep
operator|)
operator|->
name|detail
operator|==
name|ExposeCopy
operator|&&
name|screen
operator|->
name|incopy
operator|<=
literal|0
condition|)
block|{
name|screen
operator|->
name|incopy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrolls
operator|>
literal|0
condition|)
name|screen
operator|->
name|scrolls
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|HandleExposure
argument_list|(
name|screen
argument_list|,
operator|&
name|reply
argument_list|)
condition|)
name|toggled
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|ExposeCopy
case|:
if|if
condition|(
name|screen
operator|->
name|incopy
operator|<=
literal|0
operator|&&
name|screen
operator|->
name|scrolls
operator|>
literal|0
condition|)
name|screen
operator|->
name|scrolls
operator|--
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|scrolls
condition|)
name|screen
operator|->
name|incopy
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|screen
operator|->
name|incopy
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ButtonPressed
case|:
case|case
name|ButtonReleased
case|:
if|if
condition|(
name|screen
operator|->
name|incopy
condition|)
name|CopyWait
argument_list|(
name|screen
argument_list|)
expr_stmt|;
if|if
condition|(
name|HandleButtons
argument_list|(
operator|&
name|term
argument_list|,
operator|&
name|reply
argument_list|,
name|pty
argument_list|)
condition|)
name|toggled
operator|=
literal|1
expr_stmt|;
break|break;
comment|/* 			 *  Enter window is being handled just to give xterm 			 *  a kick in the pants when the mouse gets in the 			 *  window in case it was swapped out.  Of course, 			 *  one might thrash... 			 */
case|case
name|EnterWindow
case|:
break|break;
default|default:
break|break;
block|}
block|}
do|while
condition|(
name|screen
operator|->
name|display
operator|->
name|qlen
operator|>
literal|0
condition|)
do|;
block|}
block|}
block|}
end_block

begin_expr_stmt
name|RefreshIcon
argument_list|(
name|screen
argument_list|)
specifier|register
name|Screen
operator|*
name|screen
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|XBitmapBitsPut
argument_list|(
name|screen
operator|->
name|iconwindow
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|icon_width
argument_list|,
name|icon_height
argument_list|,
name|icon_bits
argument_list|,
name|screen
operator|->
name|foreground
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|screen
operator|->
name|iconmask
argument_list|,
name|GXcopy
argument_list|,
name|AllPlanes
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|get_pty
argument_list|(
argument|pty
argument_list|,
argument|pty_name
argument_list|)
end_macro

begin_comment
comment|/*    opens a pty, storing fildes in pty    and it's identifying character in pty_name.  */
end_comment

begin_decl_stmt
name|int
modifier|*
name|pty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|pty_name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|devindex
decl_stmt|,
name|letter
init|=
literal|0
decl_stmt|;
name|int
name|fd
decl_stmt|;
extern|extern errno;
if|if
condition|(
name|debug
condition|)
block|{
name|fd
operator|=
name|open
argument_list|(
literal|"xterm.debug.log"
argument_list|,
name|O_WRONLY
operator||
name|O_CREAT
operator||
name|O_TRUNC
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
name|dup2
argument_list|(
name|fd
argument_list|,
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|letter
operator|<
literal|4
condition|)
block|{
name|ttydev
index|[
literal|8
index|]
operator|=
name|ptydev
index|[
literal|8
index|]
operator|=
literal|"pqrs"
index|[
name|letter
operator|++
index|]
expr_stmt|;
name|devindex
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|devindex
operator|<
literal|16
condition|)
block|{
name|ptydev
index|[
literal|9
index|]
operator|=
operator|*
name|pty_name
operator|=
literal|"0123456789abcdef"
index|[
name|devindex
operator|++
index|]
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|pty
operator|=
name|open
argument_list|(
name|ptydev
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|debug
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"pty %d code %d\n"
argument_list|,
name|devindex
operator|-
literal|1
argument_list|,
name|errno
argument_list|)
expr_stmt|;
continue|continue;
block|}
goto|goto
name|got_pty
goto|;
block|}
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Not enough available pty's\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|11
argument_list|)
expr_stmt|;
name|got_pty
label|:
if|if
condition|(
name|debug
condition|)
block|{
name|close
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|get_terminal
argument_list|(
argument|disp
argument_list|,
argument|term
argument_list|,
argument|fn
argument_list|,
argument|fb
argument_list|,
argument|geometry
argument_list|,
argument|def
argument_list|,
argument|border
argument_list|,
argument|borderwidth
argument_list|,
argument|do_warp
argument_list|,
argument|slave
argument_list|,
argument|reverse
argument_list|,
argument|multiscroll
argument_list|,
argument|bitmapicon
argument_list|,
argument|tek
argument_list|,
argument|fore_color
argument_list|,
argument|back_color
argument_list|,
argument|brdr_color
argument_list|,
argument|curs_color
argument_list|,
argument|mous_color
ifdef|#
directive|ifdef
name|JUMPSCROLL
argument_list|,
argument|jumpscroll
endif|#
directive|endif
endif|JUMPSCROLL
argument_list|)
end_macro

begin_comment
comment|/*   * sets up X and initializes the terminal structure except for term.buf.fildes.  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|disp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|register
name|Terminal
modifier|*
name|term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fn
decl_stmt|,
modifier|*
name|fb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|geometry
decl_stmt|,
modifier|*
name|def
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|border
decl_stmt|,
name|borderwidth
decl_stmt|,
name|do_warp
decl_stmt|,
name|reverse
decl_stmt|,
name|multiscroll
decl_stmt|,
name|bitmapicon
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|tek
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|JUMPSCROLL
end_ifdef

begin_decl_stmt
name|int
name|jumpscroll
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|JUMPSCROLL
end_endif

begin_decl_stmt
name|char
modifier|*
name|fore_color
decl_stmt|,
modifier|*
name|back_color
decl_stmt|,
modifier|*
name|brdr_color
decl_stmt|,
modifier|*
name|curs_color
decl_stmt|,
modifier|*
name|mous_color
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
name|FontInfo
modifier|*
name|fInfo
decl_stmt|;
specifier|register
name|Keyboard
modifier|*
name|keyboard
decl_stmt|;
specifier|register
name|Screen
modifier|*
name|screen
decl_stmt|;
name|Buffer
modifier|*
name|buf
decl_stmt|;
name|double
name|scale_x
decl_stmt|,
name|scale_y
decl_stmt|;
name|Color
name|cdef
decl_stmt|;
name|int
name|pixels
index|[
literal|2
index|]
decl_stmt|;
name|int
name|try
init|=
literal|10
decl_stmt|;
name|OpaqueFrame
name|twindow
decl_stmt|;
name|keyboard
operator|=
operator|&
name|term
operator|->
name|keyboard
expr_stmt|;
name|screen
operator|=
operator|&
name|term
operator|->
name|screen
expr_stmt|;
name|buf
operator|=
operator|&
name|term
operator|->
name|buf
expr_stmt|;
name|term
operator|->
name|flags
operator|=
name|WRAPAROUND
operator||
name|SMOOTHSCROLL
expr_stmt|;
name|keyboard
operator|->
name|flags
operator|=
name|NULL
expr_stmt|;
name|keyboard
operator|->
name|offset
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|cnt
operator|=
literal|0
expr_stmt|;
name|buf
operator|->
name|ptr
operator|=
operator|&
name|buf
operator|->
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|TabReset
argument_list|(
name|term
operator|->
name|tabs
argument_list|)
expr_stmt|;
while|while
condition|(
name|try
operator|--
condition|)
if|if
condition|(
operator|(
name|screen
operator|->
name|display
operator|=
name|XOpenDisplay
argument_list|(
name|disp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|loginflag
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"No such display server %s\n"
argument_list|,
name|disp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
break|break;
if|if
condition|(
name|try
operator|<=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't connect to display server %s\n"
argument_list|,
name|disp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|111
argument_list|)
expr_stmt|;
block|}
name|screen
operator|->
name|foreground
operator|=
name|BlackPixel
expr_stmt|;
name|screen
operator|->
name|background
operator|=
name|WhitePixel
expr_stmt|;
name|screen
operator|->
name|cursorcolor
operator|=
name|BlackPixel
expr_stmt|;
name|screen
operator|->
name|mousecolor
operator|=
name|BlackPixel
expr_stmt|;
name|screen
operator|->
name|xorplane
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
operator|(
name|fore_color
operator|||
name|back_color
operator|||
name|curs_color
operator|)
condition|)
block|{
if|if
condition|(
name|tek
condition|)
block|{
if|if
condition|(
name|curs_color
operator|&&
name|XParseColor
argument_list|(
name|curs_color
argument_list|,
operator|&
name|cdef
argument_list|)
condition|)
block|{
if|if
condition|(
name|XGetColorCells
argument_list|(
literal|0
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
operator|&
name|screen
operator|->
name|xorplane
argument_list|,
name|pixels
argument_list|)
condition|)
block|{
name|screen
operator|->
name|background
operator|=
name|pixels
index|[
literal|0
index|]
expr_stmt|;
name|screen
operator|->
name|foreground
operator|=
name|pixels
index|[
literal|1
index|]
expr_stmt|;
name|screen
operator|->
name|cursorcolor
operator|=
name|screen
operator|->
name|background
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|cursorcolor
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|XGetColorCells
argument_list|(
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
operator|&
name|screen
operator|->
name|xorplane
argument_list|,
operator|&
name|screen
operator|->
name|background
argument_list|)
condition|)
block|{
name|screen
operator|->
name|foreground
operator|=
name|screen
operator|->
name|background
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|screen
operator|->
name|cursorcolor
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
block|}
if|if
condition|(
name|screen
operator|->
name|background
operator|!=
name|WhitePixel
condition|)
block|{
if|if
condition|(
name|back_color
operator|==
name|NULL
operator|||
operator|!
name|XParseColor
argument_list|(
name|back_color
argument_list|,
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|cdef
operator|.
name|pixel
operator|=
name|WhitePixel
expr_stmt|;
name|XQueryColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|cursorcolor
operator|!=
name|screen
operator|->
name|foreground
condition|)
block|{
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|foreground
operator||
name|screen
operator|->
name|xorplane
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fore_color
operator|==
name|NULL
operator|||
operator|!
name|XParseColor
argument_list|(
name|fore_color
argument_list|,
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|cdef
operator|.
name|pixel
operator|=
name|BlackPixel
expr_stmt|;
name|XQueryColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
name|cdef
operator|.
name|pixel
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|XStoreColor
argument_list|(
operator|&
name|cdef
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|fore_color
operator|&&
name|XParseColor
argument_list|(
name|fore_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|screen
operator|->
name|foreground
operator|=
name|screen
operator|->
name|foreground
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|reverse
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|back_color
operator|&&
name|XParseColor
argument_list|(
name|back_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
block|{
name|screen
operator|->
name|background
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
name|reverse
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|curs_color
operator|&&
name|XParseColor
argument_list|(
name|curs_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|screen
operator|->
name|cursorcolor
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
else|else
name|screen
operator|->
name|cursorcolor
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
block|}
block|}
name|screen
operator|->
name|border
operator|=
name|border
expr_stmt|;
name|screen
operator|->
name|borderwidth
operator|=
name|borderwidth
expr_stmt|;
name|screen
operator|->
name|fnt_norm
operator|=
name|screen
operator|->
name|fnt_bold
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|fInfo
operator|=
name|XOpenFont
argument_list|(
name|fn
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Could not open font %s!\n"
argument_list|,
name|xterm_name
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fn
condition|)
name|screen
operator|->
name|fnt_norm
operator|=
name|fInfo
operator|->
name|id
expr_stmt|;
if|if
condition|(
name|fb
condition|)
name|screen
operator|->
name|fnt_bold
operator|=
name|XOpenFont
argument_list|(
name|fb
argument_list|)
operator|->
name|id
expr_stmt|;
name|screen
operator|->
name|f_width
operator|=
name|fInfo
operator|->
name|width
expr_stmt|;
name|screen
operator|->
name|f_height
operator|=
name|fInfo
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|brdr_color
operator|&&
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
name|XParseColor
argument_list|(
name|brdr_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|screen
operator|->
name|bordertile
operator|=
name|XMakeTile
argument_list|(
name|cdef
operator|.
name|pixel
argument_list|)
expr_stmt|;
else|else
name|screen
operator|->
name|bordertile
operator|=
name|BlackPixmap
expr_stmt|;
name|screen
operator|->
name|cursor
operator|=
name|XStoreBitmap
argument_list|(
name|xterm_width
argument_list|,
name|xterm_height
argument_list|,
name|xterm_bits
argument_list|)
expr_stmt|;
name|screen
operator|->
name|mask
operator|=
name|XStoreBitmap
argument_list|(
name|xterm_mask_width
argument_list|,
name|xterm_mask_height
argument_list|,
name|xterm_mask_bits
argument_list|)
expr_stmt|;
if|if
condition|(
name|mous_color
operator|&&
name|DisplayCells
argument_list|()
operator|>
literal|2
operator|&&
name|XParseColor
argument_list|(
name|mous_color
argument_list|,
operator|&
name|cdef
argument_list|)
operator|&&
name|XGetHardwareColor
argument_list|(
operator|&
name|cdef
argument_list|)
condition|)
name|screen
operator|->
name|mousecolor
operator|=
name|cdef
operator|.
name|pixel
expr_stmt|;
else|else
name|screen
operator|->
name|mousecolor
operator|=
name|screen
operator|->
name|cursorcolor
expr_stmt|;
name|screen
operator|->
name|curs
operator|=
name|XStoreCursor
argument_list|(
name|screen
operator|->
name|cursor
argument_list|,
name|screen
operator|->
name|mask
argument_list|,
literal|5
argument_list|,
literal|8
argument_list|,
name|screen
operator|->
name|mousecolor
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
name|screen
operator|->
name|rcurs
operator|=
name|XStoreCursor
argument_list|(
name|screen
operator|->
name|cursor
argument_list|,
name|screen
operator|->
name|mask
argument_list|,
literal|5
argument_list|,
literal|8
argument_list|,
name|screen
operator|->
name|background
argument_list|,
name|screen
operator|->
name|mousecolor
argument_list|,
name|GXcopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|reverse
condition|)
block|{
comment|/* reverse is black background with white chars */
name|term
operator|->
name|flags
operator||=
name|REVERSE_VIDEO
expr_stmt|;
name|screen
operator|->
name|cursorcolor
operator|=
name|screen
operator|->
name|background
expr_stmt|;
name|screen
operator|->
name|background
operator|=
name|screen
operator|->
name|foreground
expr_stmt|;
name|screen
operator|->
name|foreground
operator|=
name|screen
operator|->
name|cursorcolor
expr_stmt|;
if|if
condition|(
name|screen
operator|->
name|bordertile
operator|==
name|BlackPixmap
condition|)
name|screen
operator|->
name|bordertile
operator|=
name|WhitePixmap
expr_stmt|;
block|}
name|screen
operator|->
name|bgndtile
operator|=
name|XMakeTile
argument_list|(
name|screen
operator|->
name|background
argument_list|)
expr_stmt|;
name|twindow
operator|.
name|bdrwidth
operator|=
name|screen
operator|->
name|borderwidth
expr_stmt|;
name|twindow
operator|.
name|border
operator|=
name|screen
operator|->
name|bordertile
expr_stmt|;
name|twindow
operator|.
name|background
operator|=
name|screen
operator|->
name|bgndtile
expr_stmt|;
name|screen
operator|->
name|window
operator|=
name|XCreateTerm
argument_list|(
literal|"Terminal Emulator"
argument_list|,
name|xterm_name
argument_list|,
name|geometry
argument_list|,
name|def
argument_list|,
operator|&
name|twindow
argument_list|,
literal|12
argument_list|,
literal|8
argument_list|,
name|screen
operator|->
name|border
operator|*
literal|2
argument_list|,
name|screen
operator|->
name|border
operator|*
literal|2
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|height
argument_list|,
name|fInfo
argument_list|,
name|fInfo
operator|->
name|width
argument_list|,
name|fInfo
operator|->
name|height
argument_list|)
expr_stmt|;
name|screen
operator|->
name|width
operator|=
name|twindow
operator|.
name|width
operator|-
name|border
operator|*
literal|2
expr_stmt|;
name|screen
operator|->
name|height
operator|=
name|twindow
operator|.
name|height
operator|-
name|border
operator|*
literal|2
expr_stmt|;
comment|/* Reset variables used by ANSI emulation. */
name|screen
operator|->
name|ansi
operator|.
name|a_type
operator|=
literal|0
expr_stmt|;
comment|/* New sequence.	*/
name|screen
operator|->
name|ansi
operator|.
name|a_pintro
operator|=
literal|0
expr_stmt|;
comment|/* New sequence.	*/
name|screen
operator|->
name|ansi
operator|.
name|a_final
operator|=
literal|0
expr_stmt|;
comment|/* New sequence.	*/
name|screen
operator|->
name|gsets
index|[
literal|0
index|]
operator|=
literal|'B'
expr_stmt|;
comment|/* ASCII_G		*/
name|screen
operator|->
name|gsets
index|[
literal|1
index|]
operator|=
literal|'B'
expr_stmt|;
name|screen
operator|->
name|gsets
index|[
literal|2
index|]
operator|=
literal|'<'
expr_stmt|;
comment|/* DEC supplemental.	*/
name|screen
operator|->
name|gsets
index|[
literal|3
index|]
operator|=
literal|'<'
expr_stmt|;
name|screen
operator|->
name|curgl
operator|=
literal|0
expr_stmt|;
comment|/* G0 => GL.		*/
name|screen
operator|->
name|curgr
operator|=
literal|2
expr_stmt|;
comment|/* G2 => GR.		*/
name|screen
operator|->
name|curss
operator|=
literal|0
expr_stmt|;
comment|/* No single shift.	*/
name|screen
operator|->
name|rx8bit
operator|=
literal|0
expr_stmt|;
comment|/* 7 bit.		*/
name|screen
operator|->
name|tx8bit
operator|=
literal|0
expr_stmt|;
comment|/* 7 bit.		*/
name|screen
operator|->
name|mode
operator|=
name|ANSInormal
expr_stmt|;
comment|/* Reset Tektronix alpha mode */
name|screen
operator|->
name|TekGMode
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|TekAMode
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_x
operator|=
name|screen
operator|->
name|cur_y
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|cur_X
operator|=
name|screen
operator|->
name|cur_Y
operator|=
literal|0
expr_stmt|;
name|scale_x
operator|=
name|screen
operator|->
name|width
operator|/
literal|4096.0
expr_stmt|;
name|scale_y
operator|=
name|screen
operator|->
name|height
operator|/
literal|3128.0
expr_stmt|;
name|screen
operator|->
name|TekScale
operator|=
name|scale_x
expr_stmt|;
if|if
condition|(
name|scale_y
operator|<
name|scale_x
condition|)
name|screen
operator|->
name|TekScale
operator|=
name|scale_y
expr_stmt|;
if|if
condition|(
name|bitmapicon
condition|)
block|{
name|screen
operator|->
name|iconwindow
operator|=
name|XCreateWindow
argument_list|(
name|RootWindow
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|icon_width
argument_list|,
name|icon_height
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XTileRelative
argument_list|(
name|screen
operator|->
name|iconwindow
argument_list|)
expr_stmt|;
name|XSetIconWindow
argument_list|(
name|screen
operator|->
name|window
argument_list|,
name|screen
operator|->
name|iconwindow
argument_list|)
expr_stmt|;
name|screen
operator|->
name|iconmask
operator|=
name|XStoreBitmap
argument_list|(
name|icon_mask_width
argument_list|,
name|icon_mask_height
argument_list|,
name|icon_mask_bits
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|iconwindow
argument_list|,
name|ExposeWindow
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reverse
condition|)
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|window
argument_list|,
name|screen
operator|->
name|rcurs
argument_list|)
expr_stmt|;
else|else
name|XDefineCursor
argument_list|(
name|screen
operator|->
name|window
argument_list|,
name|screen
operator|->
name|curs
argument_list|)
expr_stmt|;
name|XStoreName
argument_list|(
name|screen
operator|->
name|window
argument_list|,
operator|(
name|win_name
operator|!=
operator|(
name|char
operator|*
operator|)
literal|0
condition|?
name|win_name
else|:
operator|(
name|do_warp
condition|?
literal|"login"
else|:
operator|(
name|slave
condition|?
literal|"xtermslave"
else|:
operator|(
name|command_to_exec
condition|?
name|command_to_exec
index|[
literal|0
index|]
else|:
literal|"xterm"
operator|)
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
name|XSetResizeHint
argument_list|(
name|screen
operator|->
name|window
argument_list|,
literal|2
operator|*
name|border
argument_list|,
literal|2
operator|*
name|border
argument_list|,
name|fInfo
operator|->
name|width
argument_list|,
name|fInfo
operator|->
name|height
argument_list|)
expr_stmt|;
name|XMapWindow
argument_list|(
name|screen
operator|->
name|window
argument_list|)
expr_stmt|;
name|XSelectInput
argument_list|(
name|screen
operator|->
name|window
argument_list|,
name|KeyPressed
operator||
name|ExposeWindow
operator||
name|EnterWindow
operator||
name|ButtonPressed
operator||
name|ButtonReleased
operator||
name|ExposeRegion
operator||
name|ExposeCopy
argument_list|)
expr_stmt|;
if|if
condition|(
name|do_warp
condition|)
name|XWarpMouse
argument_list|(
name|screen
operator|->
name|window
argument_list|,
name|screen
operator|->
name|width
operator|>>
literal|1
argument_list|,
name|screen
operator|->
name|height
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|screen
operator|->
name|cur_col
operator|=
name|screen
operator|->
name|cur_row
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|max_col
operator|=
name|screen
operator|->
name|width
operator|/
name|fInfo
operator|->
name|width
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|top_marg
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|bot_marg
operator|=
name|screen
operator|->
name|max_row
operator|=
name|screen
operator|->
name|height
operator|/
name|fInfo
operator|->
name|height
operator|-
literal|1
expr_stmt|;
name|screen
operator|->
name|sc
operator|.
name|row
operator|=
name|screen
operator|->
name|sc
operator|.
name|col
operator|=
name|screen
operator|->
name|sc
operator|.
name|flags
operator|=
name|NULL
expr_stmt|;
comment|/* allocate memory for screen buffer */
name|screen
operator|->
name|buf
operator|=
operator|(
name|ScrnBuf
operator|)
name|Allocate
argument_list|(
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|screen
operator|->
name|do_wrap
operator|=
name|NULL
expr_stmt|;
name|screen
operator|->
name|scrolls
operator|=
name|screen
operator|->
name|incopy
operator|=
literal|0
expr_stmt|;
name|screen
operator|->
name|multiscroll
operator|=
name|multiscroll
expr_stmt|;
ifdef|#
directive|ifdef
name|JUMPSCROLL
if|if
condition|(
name|screen
operator|->
name|jumpscroll
operator|=
name|jumpscroll
condition|)
name|term
operator|->
name|flags
operator|&=
operator|~
name|SMOOTHSCROLL
expr_stmt|;
endif|#
directive|endif
endif|JUMPSCROLL
comment|/* display initial cursor */
name|CursorToggle
argument_list|(
name|screen
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|spawn
argument_list|(
argument|display
argument_list|,
argument|pty
argument_list|,
argument|Xsocket
argument_list|,
argument|screen
argument_list|,
argument|getty
argument_list|,
argument|slave
argument_list|,
argument|passedPty
argument_list|)
end_macro

begin_comment
comment|/*   *  Inits pty and tty and forks a login process. Returns fd for pty in pty.  *  Does not close fd Xsocket.  *  If getty,  execs getty rather than csh and uses std fd's rather  *  than opening a pty/tty pair.  *  If slave, the pty named in passedPty is already open for use  */
end_comment

begin_decl_stmt
name|int
modifier|*
name|pty
decl_stmt|,
name|Xsocket
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Screen
modifier|*
name|screen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|getty
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* if true execs /etc/getty - Xwindow */
end_comment

begin_decl_stmt
name|int
name|slave
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|passedPty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|display
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|index1
decl_stmt|,
name|tty
decl_stmt|;
name|char
name|pty_name
decl_stmt|;
name|int
name|discipline
decl_stmt|;
name|unsigned
name|lmode
decl_stmt|;
name|struct
name|tchars
name|tc
decl_stmt|;
name|struct
name|ltchars
name|ltc
decl_stmt|;
name|struct
name|sgttyb
name|sg
decl_stmt|;
name|char
name|termcap
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|newtc
index|[
literal|1024
index|]
decl_stmt|;
name|char
name|prog
index|[
literal|256
index|]
decl_stmt|;
name|char
name|numbuf
index|[
literal|10
index|]
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|index
argument_list|()
decl_stmt|,
modifier|*
name|strindex
argument_list|()
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|char
modifier|*
modifier|*
name|envnew
decl_stmt|;
comment|/* new environment */
name|struct
name|passwd
modifier|*
name|getpwuid
parameter_list|()
function_decl|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|char
name|logindev
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|TermName
init|=
literal|"xterm"
decl_stmt|;
name|int
name|ldisc
init|=
literal|0
decl_stmt|;
comment|/* be real paranoid about getting some usable entry */
if|if
condition|(
name|tgetent
argument_list|(
name|termcap
argument_list|,
name|TermName
argument_list|)
operator|==
literal|1
operator|||
operator|(
name|TermName
operator|=
literal|"vt102"
operator|,
name|tgetent
argument_list|(
name|termcap
argument_list|,
name|TermName
argument_list|)
operator|)
operator|==
literal|1
operator|||
operator|(
name|TermName
operator|=
literal|"ansi"
operator|,
name|tgetent
argument_list|(
name|termcap
argument_list|,
name|TermName
argument_list|)
operator|)
operator|==
literal|1
condition|)
block|{
comment|/* update termcap string */
comment|/* first do columns */
if|if
condition|(
operator|(
name|ptr
operator|=
name|strindex
argument_list|(
name|termcap
argument_list|,
literal|"co#"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't find co# in termcap string %s\n"
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strncpy
argument_list|(
name|newtc
argument_list|,
name|termcap
argument_list|,
name|ptr
operator|-
name|termcap
operator|+
literal|3
argument_list|)
expr_stmt|;
name|newtc
index|[
name|ptr
operator|-
name|termcap
operator|+
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sprintf
argument_list|(
name|numbuf
argument_list|,
literal|"%d\0"
argument_list|,
name|screen
operator|->
name|max_col
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|newtc
argument_list|,
name|numbuf
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|index
argument_list|(
name|ptr
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|newtc
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|termcap
argument_list|,
name|newtc
argument_list|,
sizeof|sizeof
argument_list|(
name|termcap
argument_list|)
argument_list|)
expr_stmt|;
comment|/* now do lines */
if|if
condition|(
operator|(
name|ptr
operator|=
name|strindex
argument_list|(
name|termcap
argument_list|,
literal|"li#"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Can't find li# in termcap string %s\n"
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|strncpy
argument_list|(
name|newtc
argument_list|,
name|termcap
argument_list|,
name|ptr
operator|-
name|termcap
operator|+
literal|3
argument_list|)
expr_stmt|;
name|newtc
index|[
name|ptr
operator|-
name|termcap
operator|+
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
name|sprintf
argument_list|(
name|numbuf
argument_list|,
literal|"%d\0"
argument_list|,
name|screen
operator|->
name|max_row
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|newtc
argument_list|,
name|numbuf
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|index
argument_list|(
name|ptr
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|newtc
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|TermName
argument_list|,
literal|"xterm"
argument_list|)
operator|!=
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xterm: can't find xterm termcap entry, using %s instead!\n"
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xterm: can't find any usable termcap entry!\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|getty
condition|)
block|{
name|strcpy
argument_list|(
name|logindev
argument_list|,
literal|"/dev/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|logindev
argument_list|,
name|getty
argument_list|)
expr_stmt|;
name|logindev
index|[
literal|5
index|]
operator|=
literal|'p'
expr_stmt|;
operator|*
name|pty
operator|=
name|open
argument_list|(
name|logindev
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|slave
condition|)
block|{
operator|*
name|pty
operator|=
name|slave
expr_stmt|;
name|ptydev
index|[
literal|8
index|]
operator|=
name|ttydev
index|[
literal|8
index|]
operator|=
name|passedPty
index|[
literal|0
index|]
expr_stmt|;
name|ptydev
index|[
literal|9
index|]
operator|=
name|ttydev
index|[
literal|9
index|]
operator|=
name|passedPty
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|ENXIO
condition|)
name|Error
argument_list|()
expr_stmt|;
else|else
block|{
name|no_dev_tty
operator|=
literal|1
expr_stmt|;
name|sg
operator|=
name|d_sg
expr_stmt|;
name|tc
operator|=
name|d_tc
expr_stmt|;
name|discipline
operator|=
name|d_disipline
expr_stmt|;
name|ltc
operator|=
name|d_ltc
expr_stmt|;
name|lmode
operator|=
name|d_lmode
expr_stmt|;
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|close
argument_list|(
name|index1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* get a copy of the current terminal's state */
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGETP
argument_list|,
operator|&
name|sg
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGETC
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|tc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGETD
argument_list|,
operator|&
name|discipline
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCGLTC
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|ltc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCLGET
argument_list|,
operator|&
name|lmode
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
comment|/* close all std file descriptors */
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|close
argument_list|(
name|index1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
block|}
name|get_pty
argument_list|(
name|pty
argument_list|,
operator|&
name|pty_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pty
operator|!=
name|Xsocket
operator|+
literal|1
condition|)
block|{
name|dup2
argument_list|(
operator|*
name|pty
argument_list|,
name|Xsocket
operator|+
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
operator|*
name|pty
argument_list|)
expr_stmt|;
operator|*
name|pty
operator|=
name|Xsocket
operator|+
literal|1
expr_stmt|;
block|}
name|ttydev
index|[
literal|9
index|]
operator|=
name|pty_name
expr_stmt|;
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
name|ttydev
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|Error
argument_list|()
expr_stmt|;
comment|/* change ownership of tty to real group and user id */
name|chown
argument_list|(
name|ttydev
argument_list|,
name|getuid
argument_list|()
argument_list|,
name|tty_gid
argument_list|(
name|getgid
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|/* change protection of tty */
name|chmod
argument_list|(
name|ttydev
argument_list|,
literal|0620
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty
operator|!=
name|Xsocket
operator|+
literal|2
condition|)
block|{
name|dup2
argument_list|(
name|tty
argument_list|,
name|Xsocket
operator|+
literal|2
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
name|tty
operator|=
name|Xsocket
operator|+
literal|2
expr_stmt|;
block|}
comment|/* set the new terminal's state to be the old one's  		   with minor modifications for efficiency */
name|sg
operator|.
name|sg_flags
operator|&=
operator|~
operator|(
name|ALLDELAY
operator||
name|XTABS
operator||
name|CBREAK
operator||
name|RAW
operator|)
expr_stmt|;
name|sg
operator|.
name|sg_flags
operator||=
name|ECHO
operator||
name|CRMOD
expr_stmt|;
comment|/* make sure speed is set on pty so that editors work right*/
name|sg
operator|.
name|sg_ispeed
operator|=
name|B9600
expr_stmt|;
name|sg
operator|.
name|sg_ospeed
operator|=
name|B9600
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|sg
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSETC
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|tc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|discipline
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCSLTC
argument_list|,
operator|(
name|int
operator|*
operator|)
operator|&
name|ltc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCLSET
argument_list|,
operator|&
name|lmode
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|sun
ifdef|#
directive|ifdef
name|TIOCCONS
if|if
condition|(
name|SunConsole
condition|)
block|{
name|int
name|on
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|tty
argument_list|,
name|TIOCCONS
argument_list|,
operator|&
name|on
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
block|}
endif|#
directive|endif
endif|TIOCCONS
endif|#
directive|endif
endif|sun
name|close
argument_list|(
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|dup2
argument_list|(
name|tty
argument_list|,
name|index1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|slave
operator|&&
operator|(
name|screen
operator|->
name|pid
operator|=
name|fork
argument_list|()
operator|)
operator|==
operator|-
literal|1
condition|)
name|Error
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|slave
operator|&&
name|screen
operator|->
name|pid
operator|==
literal|0
condition|)
block|{
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
name|int
name|pgrp
init|=
name|getpid
argument_list|()
decl_stmt|;
name|close
argument_list|(
name|Xsocket
argument_list|)
expr_stmt|;
name|close
argument_list|(
operator|*
name|pty
argument_list|)
expr_stmt|;
if|if
condition|(
name|getty
operator|==
name|NULL
condition|)
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGCHLD
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* copy the environment before Setenving */
while|while
condition|(
name|environ
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
name|i
operator|++
expr_stmt|;
name|envnew
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|i
operator|+
literal|4
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|envnew
index|[
name|i
index|]
operator|=
name|environ
index|[
name|i
index|]
expr_stmt|;
name|environ
operator|=
name|envnew
expr_stmt|;
name|Setenv
argument_list|(
literal|"TERM="
argument_list|,
name|TermName
argument_list|)
expr_stmt|;
name|Setenv
argument_list|(
literal|"TERMCAP="
argument_list|,
name|newtc
argument_list|)
expr_stmt|;
comment|/* put the display into the environment of the shell*/
if|if
condition|(
name|display
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
name|Setenv
argument_list|(
literal|"DISPLAY="
argument_list|,
name|screen
operator|->
name|display
operator|->
name|displayname
argument_list|)
expr_stmt|;
name|pw
operator|=
name|getpwuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSPGRP
argument_list|,
operator|&
name|pgrp
argument_list|)
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|open
argument_list|(
name|ttyname
argument_list|(
literal|0
argument_list|)
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|setpgrp
argument_list|(
literal|0
argument_list|,
name|pgrp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dologinflag
condition|)
comment|/* login */
name|utrelog
argument_list|(
literal|1
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|screen
operator|->
name|display
operator|->
name|displayname
argument_list|)
expr_stmt|;
name|setgid
argument_list|(
name|getgid
argument_list|()
argument_list|)
expr_stmt|;
name|setuid
argument_list|(
name|getuid
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|command_to_exec
condition|)
block|{
name|execvp
argument_list|(
name|command_to_exec
index|[
literal|0
index|]
argument_list|,
name|command_to_exec
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
if|if
condition|(
name|getty
condition|)
block|{
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/etc/getty"
argument_list|,
literal|"+"
argument_list|,
literal|"Xwindow"
argument_list|,
name|getty
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_DFL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pw
operator|->
name|pw_shell
operator|==
literal|'\0'
condition|)
name|pw
operator|->
name|pw_shell
operator|=
literal|"/bin/sh"
expr_stmt|;
comment|/* make sure line discipline gets set */
name|ldisc
operator|=
literal|0
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|ldisc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|pw
operator|->
name|pw_shell
argument_list|,
literal|"/bin/csh"
argument_list|)
condition|)
block|{
name|ldisc
operator|=
name|NTTYDISC
expr_stmt|;
name|ioctl
argument_list|(
literal|0
argument_list|,
name|TIOCSETD
argument_list|,
operator|&
name|ldisc
argument_list|)
expr_stmt|;
block|}
name|ptr
operator|=
name|rindex
argument_list|(
name|pw
operator|->
name|pw_shell
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|==
name|NULL
condition|)
name|ptr
operator|=
name|pw
operator|->
name|pw_shell
expr_stmt|;
else|else
name|ptr
operator|++
expr_stmt|;
if|if
condition|(
name|dologinflag
condition|)
block|{
name|prog
index|[
literal|0
index|]
operator|=
literal|'-'
expr_stmt|;
name|strcpy
argument_list|(
operator|&
name|prog
index|[
literal|1
index|]
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|prog
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
name|pw
operator|->
name|pw_shell
argument_list|,
name|prog
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: Could not exec %s!\n"
argument_list|,
name|pw
operator|->
name|pw_shell
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|Cleanup
argument_list|(
literal|121
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGHUP
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTTOU
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* so that TIOCSWINSZ doesn't block */
if|if
condition|(
operator|(
name|tty
operator|=
name|open
argument_list|(
name|no_dev_tty
condition|?
literal|"/dev/null"
else|:
literal|"/dev/tty"
argument_list|,
name|O_RDWR
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
condition|)
name|Error
argument_list|()
expr_stmt|;
for|for
control|(
name|index1
operator|=
literal|0
init|;
name|index1
operator|<
literal|3
condition|;
name|index1
operator|++
control|)
name|dup2
argument_list|(
name|tty
argument_list|,
name|index1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tty
operator|>
literal|2
condition|)
name|close
argument_list|(
name|tty
argument_list|)
expr_stmt|;
comment|/* set ids to user's */
comment|/* 	setgid (getgid ()); 	setuid (getuid ()); 		setregid (getegid (), getgid ()); 		setreuid (geteuid (), getuid ()); 	*/
block|}
end_block

begin_expr_stmt
specifier|static
name|reapchild
argument_list|()
block|{
specifier|extern
name|Terminal
name|term
block|;
specifier|register
name|long
name|pgrp
block|;
expr|union
name|wait
name|status
block|;
name|int
name|pid
block|;
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"Exiting\n"
argument_list|)
expr_stmt|;
name|pid
operator|=
name|wait3
argument_list|(
operator|&
name|status
argument_list|,
name|WNOHANG
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
operator|!
name|pid
condition|)
return|return;
end_if

begin_if
if|if
condition|(
name|pid
operator|!=
name|term
operator|.
name|screen
operator|.
name|pid
condition|)
return|return;
end_if

begin_if
if|if
condition|(
name|dologinflag
condition|)
name|utrelog
argument_list|(
literal|0
argument_list|,
literal|""
argument_list|,
literal|""
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
name|Cleanup
argument_list|(
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
unit|}  consolepr
operator|(
name|string
operator|)
name|char
operator|*
name|string
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|extern
name|int
name|errno
decl_stmt|;
specifier|extern
name|char
modifier|*
name|sys_errlist
index|[]
decl_stmt|;
name|int
name|oerrno
decl_stmt|;
name|int
name|f
decl_stmt|;
name|oerrno
operator|=
name|errno
expr_stmt|;
name|f
operator|=
name|open
argument_list|(
literal|"/dev/console"
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
literal|"xterm: "
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
name|string
argument_list|,
name|strlen
argument_list|(
name|string
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
literal|": "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
name|sys_errlist
index|[
name|oerrno
index|]
argument_list|,
name|strlen
argument_list|(
name|sys_errlist
index|[
name|oerrno
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|=
name|open
argument_list|(
literal|"/dev/tty"
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
name|ioctl
argument_list|(
name|f
argument_list|,
name|TIOCNOTTY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|TTYGRPNAME
value|"tty"
end_define

begin_macro
name|tty_gid
argument_list|(
argument|default_gid
argument_list|)
end_macro

begin_decl_stmt
name|int
name|default_gid
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|group
modifier|*
name|getgrnam
argument_list|()
decl_stmt|,
modifier|*
name|gr
decl_stmt|;
name|int
name|gid
init|=
name|default_gid
decl_stmt|;
name|gr
operator|=
name|getgrnam
argument_list|(
name|TTYGRPNAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|!=
operator|(
expr|struct
name|group
operator|*
operator|)
literal|0
condition|)
name|gid
operator|=
name|gr
operator|->
name|gr_gid
expr_stmt|;
name|endgrent
argument_list|()
expr_stmt|;
return|return
operator|(
name|gid
operator|)
return|;
block|}
end_block

begin_macro
name|utrelog
argument_list|(
argument|io
argument_list|,
argument|user
argument_list|,
argument|display
argument_list|)
end_macro

begin_decl_stmt
name|int
name|io
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|user
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|display
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|utmp
name|ut
decl_stmt|;
name|struct
name|ttyent
modifier|*
name|ty
decl_stmt|;
specifier|register
name|int
name|s
decl_stmt|;
name|long
name|slot
decl_stmt|;
name|int
name|ufd
decl_stmt|;
name|char
modifier|*
name|colon
decl_stmt|;
if|if
condition|(
name|io
operator|==
literal|1
condition|)
block|{
name|strncpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
operator|&
name|ttydev
index|[
literal|5
index|]
argument_list|,
sizeof|sizeof
name|ut
operator|.
name|ut_line
argument_list|)
expr_stmt|;
name|colon
operator|=
name|index
argument_list|(
name|display
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|colon
condition|)
operator|*
name|colon
operator|=
literal|'\0'
expr_stmt|;
name|strncpy
argument_list|(
name|ut
operator|.
name|ut_host
argument_list|,
name|display
argument_list|,
sizeof|sizeof
name|ut
operator|.
name|ut_host
argument_list|)
expr_stmt|;
if|if
condition|(
name|colon
condition|)
operator|*
name|colon
operator|=
literal|':'
expr_stmt|;
name|strncpy
argument_list|(
name|ut
operator|.
name|ut_name
argument_list|,
name|user
argument_list|,
sizeof|sizeof
name|ut
operator|.
name|ut_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|ut
operator|.
name|ut_time
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_line
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_name
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ut
operator|.
name|ut_host
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ut
operator|.
name|ut_time
operator|=
literal|0
expr_stmt|;
name|chown
argument_list|(
name|ttydev
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|chmod
argument_list|(
name|ttydev
argument_list|,
literal|0666
argument_list|)
expr_stmt|;
block|}
name|setttyent
argument_list|()
expr_stmt|;
name|slot
operator|=
literal|0
expr_stmt|;
name|s
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|ty
operator|=
name|getttyent
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|ty
operator|->
name|ty_name
argument_list|,
operator|&
name|ttydev
index|[
literal|5
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|slot
operator|=
name|s
expr_stmt|;
break|break;
block|}
block|}
name|endttyent
argument_list|()
expr_stmt|;
if|if
condition|(
name|slot
operator|>
literal|0
operator|&&
operator|(
name|ufd
operator|=
name|open
argument_list|(
literal|"/etc/utmp"
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
operator|)
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|lseek
argument_list|(
name|ufd
argument_list|,
name|slot
operator|*
sizeof|sizeof
name|ut
argument_list|,
literal|0
argument_list|)
operator|<
literal|0L
operator|||
name|write
argument_list|(
name|ufd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ut
argument_list|,
sizeof|sizeof
name|ut
argument_list|)
operator|!=
sizeof|sizeof
name|ut
condition|)
block|{
name|close
argument_list|(
name|ufd
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|close
argument_list|(
name|ufd
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

end_unit


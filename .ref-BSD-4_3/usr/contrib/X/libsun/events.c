begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_events_c
init|=
literal|"$Header: events.c,v 10.2 86/02/01 16:20:48 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|sun
end_ifdef

begin_comment
comment|/*  * The Sun X drivers are a product of Sun Microsystems, Inc. and are provided  * for unrestricted use provided that this legend is included on all tape  * media and as a part of the software program in whole or part.  Users  * may copy or modify these drivers without charge, but are not authorized  * to license or distribute them to anyone else except as part of a product or  * program developed by the user.  *   * THE SUN X DRIVERS ARE PROVIDED AS IS WITH NO WARRANTIES OF ANY KIND  * INCLUDING THE WARRANTIES OF DESIGN, MERCHANTIBILITY AND FITNESS FOR A  * PARTICULAR PURPOSE, OR ARISING FROM A COURSE OF DEALING, USAGE OR TRADE  * PRACTICE.  *  * The Sun X Drivers are provided with no support and without any obligation  * on the part of Sun Microsystems, Inc. to assist in their use, correction,  * modification or enhancement.  *   * SUN MICROSYSTEMS, INC. SHALL HAVE NO LIABILITY WITH RESPECT TO THE  * INFRINGEMENT OF COPYRIGHTS, TRADE SECRETS OR ANY PATENTS BY THE SUN X  * DRIVERS OR ANY PART THEREOF.  *   * In no event will Sun Microsystems, Inc. be liable for any lost revenue  * or profits or other special, indirect and consequential damages, even if  * Sun has been advised of the possibility of such damages.  *   * Sun Microsystems, Inc.  * 2550 Garcia Avenue  * Mountain View, California  94043  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)events.c 2.1 86/01/28 Copyright 1986 Sun Micro"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*-  * Copyright (c) 1986 by Sun Microsystems,  Inc.  */
end_comment

begin_comment
comment|/*  *	ToDo:  *		Up events  *		Shiftlock support  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|"../X/X.h"
end_include

begin_include
include|#
directive|include
file|"../X/vsinput.h"
end_include

begin_include
include|#
directive|include
file|"../X/Xdev.h"
end_include

begin_include
include|#
directive|include
file|<sundev/kbd.h>
end_include

begin_include
include|#
directive|include
file|<sunwindow/win_input.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|event_is_ascii
end_ifndef

begin_define
define|#
directive|define
name|event_is_ascii
parameter_list|(
name|e
parameter_list|)
value|(e->ie_code>= ASCII_FIRST&& e->ie_code<= ASCII_LAST)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|event_is_meta
end_ifndef

begin_define
define|#
directive|define
name|event_is_meta
parameter_list|(
name|e
parameter_list|)
value|(e->ie_code>= META_FIRST&& e->ie_code<= META_LAST)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Should be qevent.h */
end_comment

begin_define
define|#
directive|define
name|VSE_LEFT_BUTTON
value|0
end_define

begin_define
define|#
directive|define
name|VSE_MIDDLE_BUTTON
value|1
end_define

begin_define
define|#
directive|define
name|VSE_RIGHT_BUTTON
value|2
end_define

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|state_mask
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|vsdev
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|DEVICE
modifier|*
name|CurrentDevice
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_expr_stmt
name|ProcessInput
argument_list|(
name|ev
argument_list|)
specifier|register
name|vsEvent
operator|*
name|ev
expr_stmt|;
end_expr_stmt

begin_block
block|{
comment|/*NOTREACHED*/
block|}
end_block

begin_include
include|#
directive|include
file|"lk201.h"
end_include

begin_function
specifier|static
name|int
name|SunToXKeyCode
parameter_list|(
name|s
parameter_list|)
name|int
name|s
decl_stmt|;
block|{
specifier|register
name|int
name|ret
init|=
name|LK201
index|[
name|s
operator|&
literal|0177
index|]
decl_stmt|;
name|char
modifier|*
name|c
init|=
literal|"^."
decl_stmt|;
name|char
modifier|*
name|f
init|=
literal|"."
decl_stmt|;
name|c
index|[
literal|1
index|]
operator|=
operator|(
name|s
operator|&
literal|0177
operator|)
operator||
literal|0100
expr_stmt|;
name|f
index|[
literal|0
index|]
operator|=
operator|(
name|s
operator|&
literal|0177
operator|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert from a Sun event to an X event  */
end_comment

begin_function
specifier|static
name|int
name|ConvertEvent
parameter_list|(
name|se
parameter_list|,
name|xe
parameter_list|)
name|struct
name|inputevent
modifier|*
name|se
decl_stmt|;
name|vsEvent
modifier|*
name|xe
decl_stmt|;
block|{
comment|/* Map the coordinates */
name|xe
operator|->
name|vse_x
operator|=
name|se
operator|->
name|ie_locx
expr_stmt|;
name|xe
operator|->
name|vse_y
operator|=
name|se
operator|->
name|ie_locy
expr_stmt|;
comment|/* Map the time stamps */
name|xe
operator|->
name|vse_time
operator|=
operator|(
name|se
operator|->
name|ie_time
operator|.
name|tv_usec
operator|/
literal|10000
operator|+
name|se
operator|->
name|ie_time
operator|.
name|tv_sec
operator|)
expr_stmt|;
comment|/* Set direction */
name|xe
operator|->
name|vse_direction
operator|=
operator|(
name|win_inputposevent
argument_list|(
name|se
argument_list|)
condition|?
name|VSE_KBTDOWN
else|:
name|VSE_KBTUP
operator|)
expr_stmt|;
comment|/* Sort out the event codes */
if|if
condition|(
name|event_is_ascii
argument_list|(
name|se
argument_list|)
condition|)
block|{
comment|/* ASCII keystroke */
name|int
name|key
init|=
name|SunToXKeyCode
argument_list|(
name|se
operator|->
name|ie_code
argument_list|)
decl_stmt|;
name|xe
operator|->
name|vse_key
operator|=
operator|(
name|key
operator|&
literal|0377
operator|)
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|state_mask
operator|=
operator|(
name|state_mask
operator|&
operator|~
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
operator||
operator|(
name|key
operator|&
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|event_is_meta
argument_list|(
name|se
argument_list|)
condition|)
block|{
comment|/* META keystroke - map to ASCII for now */
name|int
name|key
init|=
name|SunToXKeyCode
argument_list|(
name|se
operator|->
name|ie_code
operator|-
name|META_FIRST
operator|+
name|ASCII_FIRST
argument_list|)
operator||
name|MetaMask
decl_stmt|;
name|xe
operator|->
name|vse_key
operator|=
operator|(
name|key
operator|&
literal|0377
operator|)
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|state_mask
operator|=
operator|(
name|state_mask
operator|&
operator|~
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
operator||
operator|(
name|key
operator|&
operator|(
name|ControlMask
operator||
name|MetaMask
operator||
name|ShiftMask
operator||
name|ShiftLockMask
operator|)
operator|)
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|se
operator|->
name|ie_code
condition|)
block|{
case|case
name|LOC_MOVE
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
comment|/* XXX - should query shift state here but ... */
name|xe
operator|->
name|vse_type
operator|=
name|VSE_MMOTION
expr_stmt|;
break|break;
case|case
name|MS_LEFT
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_LEFT_BUTTON
expr_stmt|;
comment|/* XXX - should query shift state here */
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|state_mask
operator|&=
operator|~
name|LeftMask
expr_stmt|;
else|else
name|state_mask
operator||=
name|LeftMask
expr_stmt|;
goto|goto
name|ShiftKeys
goto|;
case|case
name|MS_MIDDLE
case|:
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_key
operator|=
name|VSE_MIDDLE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|state_mask
operator|&=
operator|~
name|MiddleMask
expr_stmt|;
else|else
name|state_mask
operator||=
name|MiddleMask
expr_stmt|;
goto|goto
name|ShiftKeys
goto|;
case|case
name|MS_RIGHT
case|:
name|xe
operator|->
name|vse_key
operator|=
name|VSE_RIGHT_BUTTON
expr_stmt|;
name|xe
operator|->
name|vse_device
operator|=
name|VSE_MOUSE
expr_stmt|;
name|xe
operator|->
name|vse_type
operator|=
name|VSE_BUTTON
expr_stmt|;
if|if
condition|(
name|xe
operator|->
name|vse_direction
operator|==
name|VSE_KBTUP
condition|)
name|state_mask
operator|&=
operator|~
name|RightMask
expr_stmt|;
else|else
name|state_mask
operator||=
name|RightMask
expr_stmt|;
name|ShiftKeys
label|:
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|CAPSMASK
condition|)
name|state_mask
operator||=
name|ShiftLockMask
expr_stmt|;
else|else
name|state_mask
operator|&=
operator|~
name|ShiftMask
expr_stmt|;
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|SHIFTMASK
condition|)
name|state_mask
operator||=
name|ShiftMask
expr_stmt|;
else|else
name|state_mask
operator|&=
operator|~
name|ShiftMask
expr_stmt|;
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|CTRLMASK
condition|)
name|state_mask
operator||=
name|ControlMask
expr_stmt|;
else|else
name|state_mask
operator|&=
operator|~
name|ControlMask
expr_stmt|;
ifdef|#
directive|ifdef
name|META_SHIFT_MASK
if|if
condition|(
name|se
operator|->
name|ie_shiftmask
operator|&
name|META_SHIFT_MASK
condition|)
name|state_mask
operator||=
name|MetaMask
expr_stmt|;
else|else
name|state_mask
operator|&=
operator|~
name|MetaMask
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
comment|/* Ignore it */
break|break;
block|}
return|return
operator|(
name|state_mask
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|INPBUFSIZE
value|128
end_define

begin_comment
comment|/*  * Read pending input events  */
end_comment

begin_macro
name|InputReader
argument_list|()
end_macro

begin_block
block|{
name|struct
name|inputevent
name|sunevents
index|[
name|INPBUFSIZE
index|]
decl_stmt|;
name|int
name|n
decl_stmt|,
name|m
decl_stmt|;
specifier|static
name|int
name|last_mask
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|read
argument_list|(
name|vsdev
argument_list|,
name|sunevents
argument_list|,
name|INPBUFSIZE
operator|*
sizeof|sizeof
name|sunevents
index|[
literal|0
index|]
argument_list|)
operator|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EWOULDBLOCK
condition|)
block|{
comment|/* 	 * Error reading events  	 */
comment|/* XXX_DO_SOMETHING(); */
return|return;
block|}
for|for
control|(
name|n
operator|/=
sizeof|sizeof
name|sunevents
index|[
literal|0
index|]
operator|,
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|n
condition|;
name|m
operator|++
control|)
block|{
name|vsEvent
name|Xevent
decl_stmt|,
name|Sevent
decl_stmt|;
name|int
name|mask
decl_stmt|;
name|mask
operator|=
name|ConvertEvent
argument_list|(
operator|&
operator|(
name|sunevents
index|[
name|m
index|]
operator|)
argument_list|,
operator|&
name|Xevent
argument_list|)
expr_stmt|;
name|SetCursorPosition
argument_list|(
operator|(
name|vsCursor
operator|*
operator|)
operator|&
name|Xevent
argument_list|)
expr_stmt|;
comment|/* XXX - tacky */
if|if
condition|(
name|mask
operator|!=
name|last_mask
condition|)
block|{
name|last_mask
operator|^=
name|mask
expr_stmt|;
name|Sevent
operator|.
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
name|Sevent
operator|.
name|vse_x
operator|=
name|Xevent
operator|.
name|vse_x
expr_stmt|;
name|Sevent
operator|.
name|vse_y
operator|=
name|Xevent
operator|.
name|vse_y
expr_stmt|;
name|Sevent
operator|.
name|vse_time
operator|=
name|Xevent
operator|.
name|vse_time
expr_stmt|;
name|Sevent
operator|.
name|vse_device
operator|=
name|VSE_DKB
expr_stmt|;
if|if
condition|(
name|last_mask
operator|&
name|ShiftMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|ShiftMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0256
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_mask
operator|&
name|ControlMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|ControlMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0257
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_mask
operator|&
name|ShiftLockMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|ShiftLockMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0260
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last_mask
operator|&
name|MetaMask
condition|)
block|{
if|if
condition|(
name|mask
operator|&
name|MetaMask
condition|)
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTDOWN
expr_stmt|;
else|else
name|Sevent
operator|.
name|vse_direction
operator|=
name|VSE_KBTUP
expr_stmt|;
name|Sevent
operator|.
name|vse_key
operator|=
literal|0261
expr_stmt|;
name|Deal_with_input
argument_list|(
operator|&
name|Sevent
argument_list|)
expr_stmt|;
block|}
name|last_mask
operator|=
name|mask
expr_stmt|;
block|}
if|if
condition|(
name|Xevent
operator|.
name|vse_type
operator|==
name|VSE_MMOTION
condition|)
block|{
specifier|register
name|vsBox
modifier|*
name|b
init|=
name|CurrentDevice
operator|->
name|mbox
decl_stmt|;
specifier|register
name|vsCursor
modifier|*
name|m
init|=
name|CurrentDevice
operator|->
name|mouse
decl_stmt|;
comment|/* 	     * Has it left the box?  	     */
if|if
condition|(
name|m
operator|->
name|y
operator|>=
name|b
operator|->
name|bottom
operator|||
name|m
operator|->
name|y
operator|<
name|b
operator|->
name|top
operator|||
name|m
operator|->
name|x
operator|>=
name|b
operator|->
name|right
operator|||
name|m
operator|->
name|x
operator|<
name|b
operator|->
name|left
condition|)
block|{
name|b
operator|->
name|bottom
operator|=
literal|0
expr_stmt|;
name|Deal_with_movement
argument_list|()
expr_stmt|;
block|}
block|}
else|else
name|Deal_with_input
argument_list|(
operator|&
name|Xevent
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_endif
endif|#
directive|endif
endif|sun
end_endif

end_unit


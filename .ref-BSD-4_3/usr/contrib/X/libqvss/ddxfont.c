begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* font.c	Reads a font from a file and stores it on the workstation  *  *	GetFont		Takes a font name and stores it  *	FreeFont	Frees the storage taken by a font  *  * Modification History  *  *	Carver 8601.13 Fix reference to ../libvs100/param.h to be param.h  *  *      Jones  8510.15 Fix ``memory leak'' -- deallocate leftarry in FreeFont  *  * 	Carver 8510.03 Increased the allocation size of the left array buffer  *		       by 1 word.  Fixes boundary problem.  */
end_comment

begin_include
include|#
directive|include
file|"ddxqvss.h"
end_include

begin_include
include|#
directive|include
file|"param.h"
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ddxfontdir
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|ddxfontsuffix
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Xalloc
argument_list|()
decl_stmt|,
modifier|*
name|strcpy
argument_list|()
decl_stmt|,
modifier|*
name|strcat
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|CHARPERFONT
value|256
end_define

begin_function
name|FONT
modifier|*
name|GetFont
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|char
name|fontname
index|[
literal|256
index|]
decl_stmt|;
name|int
name|fontfile
decl_stmt|;
name|FontData
name|font
decl_stmt|;
define|#
directive|define
name|chars
value|((BitMap *) font.f_characters)
name|int
name|fontsize
decl_stmt|,
name|leftsize
decl_stmt|,
name|width
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|char
modifier|*
name|fontarea
decl_stmt|;
specifier|register
name|short
modifier|*
name|leftarea
decl_stmt|,
modifier|*
name|leftarray
decl_stmt|;
specifier|register
name|FONT
modifier|*
name|fd
decl_stmt|;
specifier|register
name|FontPriv
modifier|*
name|fpriv
decl_stmt|;
name|int
name|tablesize
init|=
operator|(
name|CHARPERFONT
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
decl_stmt|;
comment|/* 8510.03 Carver */
name|strcpy
argument_list|(
name|fontname
argument_list|,
name|ddxfontdir
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|fontname
argument_list|,
name|ddxfontsuffix
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fontfile
operator|=
name|open
argument_list|(
name|fontname
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|&&
operator|(
name|errno
operator|!=
name|ENOENT
operator|||
operator|(
name|fontfile
operator|=
name|open
argument_list|(
name|name
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
operator|-
literal|1
operator|)
condition|)
block|{
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|font
argument_list|,
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|FontData
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|fontsize
operator|=
name|BitmapSize
argument_list|(
name|chars
operator|->
name|bm_width
argument_list|,
name|chars
operator|->
name|bm_height
argument_list|)
expr_stmt|;
name|fontarea
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|fontsize
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fontfile
argument_list|,
operator|(
name|long
operator|)
name|font
operator|.
name|f_characters
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
name|fontarea
argument_list|,
name|fontsize
argument_list|)
operator|!=
name|fontsize
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|leftarea
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|tablesize
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|leftarea
argument_list|,
name|tablesize
argument_list|)
expr_stmt|;
name|leftarray
operator|=
operator|(
name|short
operator|*
operator|)
name|Xalloc
argument_list|(
name|tablesize
argument_list|)
expr_stmt|;
if|if
condition|(
name|font
operator|.
name|f_fixedWidth
operator|==
literal|0
condition|)
block|{
name|leftsize
operator|=
operator|(
name|font
operator|.
name|f_lastChar
operator|-
name|font
operator|.
name|f_firstChar
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|fontfile
argument_list|,
operator|(
name|long
operator|)
name|font
operator|.
name|f_leftArray
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|fontfile
argument_list|,
operator|&
name|leftarea
index|[
name|font
operator|.
name|f_firstChar
index|]
argument_list|,
name|leftsize
argument_list|)
operator|!=
name|leftsize
condition|)
block|{
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarray
argument_list|)
expr_stmt|;
name|errno
operator|=
name|EINVAL
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
else|else
block|{
comment|/* if fixed with font, generate leftarray for use later */
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|font
operator|.
name|f_firstChar
init|;
name|i
operator|<=
name|font
operator|.
name|f_lastChar
operator|+
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|leftarea
index|[
name|i
index|]
operator|=
name|j
expr_stmt|;
name|j
operator|+=
name|font
operator|.
name|f_fixedWidth
expr_stmt|;
block|}
block|}
name|bcopy
argument_list|(
name|leftarea
argument_list|,
name|leftarray
argument_list|,
name|tablesize
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fontfile
argument_list|)
expr_stmt|;
name|fd
operator|=
operator|(
name|FONT
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FONT
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|->
name|height
operator|=
name|chars
operator|->
name|bm_height
expr_stmt|;
name|fd
operator|->
name|first
operator|=
name|font
operator|.
name|f_firstChar
expr_stmt|;
name|fd
operator|->
name|last
operator|=
name|font
operator|.
name|f_lastChar
expr_stmt|;
name|fd
operator|->
name|base
operator|=
name|font
operator|.
name|f_baseline
expr_stmt|;
name|fd
operator|->
name|space
operator|=
name|font
operator|.
name|f_spaceIndex
expr_stmt|;
name|fd
operator|->
name|space
operator|+=
name|fd
operator|->
name|first
expr_stmt|;
name|fpriv
operator|=
operator|(
name|FontPriv
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FontPriv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|->
name|avg_width
operator|=
name|font
operator|.
name|f_fixedWidth
condition|)
block|{
name|fd
operator|->
name|fixed
operator|=
literal|1
expr_stmt|;
name|fpriv
operator|->
name|maxwidth
operator|=
name|fd
operator|->
name|avg_width
expr_stmt|;
block|}
else|else
name|fd
operator|->
name|fixed
operator|=
literal|0
expr_stmt|;
name|fd
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|fd
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|fpriv
expr_stmt|;
name|fpriv
operator|->
name|widths
operator|=
name|leftarea
expr_stmt|;
name|fpriv
operator|->
name|leftarray
operator|=
name|leftarray
expr_stmt|;
if|if
condition|(
operator|(
name|fpriv
operator|->
name|strike
operator|=
operator|(
name|BITMAP
operator|*
operator|)
name|Xalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|BITMAP
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|fontarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarea
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|leftarray
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fd
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|fpriv
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|fpriv
operator|->
name|wpitch
operator|=
operator|(
operator|(
operator|(
name|chars
operator|->
name|bm_width
operator|+
literal|15
operator|)
operator|>>
literal|3
operator|)
operator|&
operator|~
literal|1
operator|)
expr_stmt|;
name|fpriv
operator|->
name|strike
operator|->
name|width
operator|=
name|chars
operator|->
name|bm_width
expr_stmt|;
name|fpriv
operator|->
name|strike
operator|->
name|height
operator|=
name|chars
operator|->
name|bm_height
expr_stmt|;
name|fpriv
operator|->
name|strike
operator|->
name|refcnt
operator|=
literal|1
expr_stmt|;
name|fpriv
operator|->
name|strike
operator|->
name|data
operator|=
operator|(
name|caddr_t
operator|)
name|fontarea
expr_stmt|;
comment|/* 	 * compute line table for font to eliminate multiply to find beginning 	 * of line. 	 */
name|fpriv
operator|->
name|fltable
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|Xalloc
argument_list|(
name|chars
operator|->
name|bm_height
operator|*
sizeof|sizeof
argument_list|(
name|caddr_t
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chars
operator|->
name|bm_height
condition|;
name|i
operator|++
control|)
name|fpriv
operator|->
name|fltable
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|fontarea
operator|)
operator|+
name|i
operator|*
name|fpriv
operator|->
name|wpitch
expr_stmt|;
name|fd
operator|->
name|name
operator|=
operator|(
name|char
operator|*
operator|)
name|Xalloc
argument_list|(
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|fd
operator|->
name|name
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fpriv
operator|->
name|maxwidth
operator|=
literal|0
expr_stmt|;
comment|/* convert the leftarray to the width table */
for|for
control|(
name|i
operator|=
name|fd
operator|->
name|first
init|;
name|i
operator|<=
name|fd
operator|->
name|last
condition|;
name|i
operator|++
control|)
block|{
name|width
operator|=
name|fpriv
operator|->
name|leftarray
index|[
name|i
operator|+
literal|1
index|]
operator|-
name|fpriv
operator|->
name|leftarray
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|width
operator|>
name|fpriv
operator|->
name|maxwidth
condition|)
name|fpriv
operator|->
name|maxwidth
operator|=
name|width
expr_stmt|;
if|if
condition|(
name|width
operator|<
literal|0
condition|)
block|{
name|width
operator|=
literal|0
expr_stmt|;
comment|/* font sanity check */
name|DeviceError
argument_list|(
literal|"Bad font leftarray!\n"
argument_list|)
expr_stmt|;
block|}
name|fpriv
operator|->
name|widths
index|[
name|i
index|]
operator|=
name|width
expr_stmt|;
block|}
name|fd
operator|->
name|avg_width
operator|=
operator|(
operator|(
name|fpriv
operator|->
name|leftarray
index|[
name|fd
operator|->
name|last
index|]
operator|-
name|fpriv
operator|->
name|leftarray
index|[
name|fd
operator|->
name|first
index|]
operator|)
operator|/
operator|(
name|fd
operator|->
name|last
operator|-
name|fd
operator|->
name|first
operator|)
operator|)
expr_stmt|;
comment|/*	striketobitmaps(fd);*/
return|return
operator|(
name|fd
operator|)
return|;
undef|#
directive|undef
name|chars
block|}
end_function

begin_expr_stmt
name|FreeFont
argument_list|(
name|font
argument_list|)
specifier|register
name|FONT
operator|*
name|font
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|FontPriv
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|FDATA
argument_list|(
name|font
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DoStrikeArray
if|if
condition|(
name|data
operator|->
name|chrs
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
operator|->
name|chrs
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|data
operator|->
name|leftarray
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
operator|->
name|leftarray
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|widths
condition|)
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
operator|->
name|widths
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|data
operator|->
name|fltable
argument_list|)
expr_stmt|;
name|FreeBitmap
argument_list|(
name|data
operator|->
name|strike
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|data
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|font
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|caddr_t
operator|)
name|font
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*   * this routine converts strike format into an array of bitmaps   */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DoStrikeArray
end_ifdef

begin_macro
name|striketobitmaps
argument_list|(
argument|fn
argument_list|)
end_macro

begin_decl_stmt
name|FONT
modifier|*
name|fn
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|FontPriv
modifier|*
name|fp
init|=
name|FDATA
argument_list|(
name|fn
argument_list|)
decl_stmt|;
name|int
name|fheight
init|=
name|fn
operator|->
name|height
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|long
modifier|*
name|bits
decl_stmt|;
specifier|register
name|int
name|tmp
decl_stmt|;
name|int
name|length
init|=
operator|(
name|fn
operator|->
name|last
operator|-
name|fn
operator|->
name|first
operator|+
literal|1
operator|)
operator|*
name|fheight
operator|*
sizeof|sizeof
argument_list|(
name|long
argument_list|)
decl_stmt|;
if|if
condition|(
name|fp
operator|->
name|maxwidth
operator|>
literal|32
condition|)
return|return;
name|fp
operator|->
name|chrs
operator|=
name|bits
operator|=
operator|(
name|long
operator|*
operator|)
name|Xalloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|bits
argument_list|,
name|length
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|fn
operator|->
name|first
init|;
name|i
operator|<=
name|fn
operator|->
name|last
condition|;
name|i
operator|++
control|)
block|{
specifier|register
name|w
operator|=
name|fp
operator|->
name|widths
index|[
name|i
index|]
expr_stmt|;
specifier|register
name|offset
operator|=
name|fp
operator|->
name|leftarray
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|w
operator|<
literal|0
condition|)
name|w
operator|=
literal|0
expr_stmt|;
comment|/* sanity check for bad fonts */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|fheight
condition|;
name|j
operator|++
control|)
block|{
specifier|register
name|char
modifier|*
name|base
init|=
name|fp
operator|->
name|fltable
index|[
name|j
index|]
decl_stmt|;
name|tmp
operator|=
name|extzv
argument_list|(
name|base
argument_list|,
name|offset
argument_list|,
name|w
argument_list|)
expr_stmt|;
operator|*
name|bits
operator|=
name|tmp
expr_stmt|;
name|bits
operator|+=
literal|1
expr_stmt|;
block|}
block|}
return|return;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<X/mit-copyright.h>
end_include

begin_comment
comment|/*  * XPR - process xwd(1) files for the LN03 or LA100 printer  *  * Author: Michael R. Gretzinger, MIT Project Athena  * Copyright (C) 1985, Massachusetts Institute of Technology  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_xpr_c
init|=
literal|"$Header: xpr.c,v 10.4 86/02/01 16:03:38 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"lncmd.h"
end_include

begin_include
include|#
directive|include
file|"XWDFile.h"
end_include

begin_decl_stmt
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|device
block|{
name|LN01
block|,
name|LN03
block|,
name|LA100
block|}
enum|;
end_enum

begin_enum
enum|enum
name|orientation
block|{
name|PORTRAIT
block|,
name|LANDSCAPE
block|}
enum|;
end_enum

begin_define
define|#
directive|define
name|W_MAX
value|2400
end_define

begin_define
define|#
directive|define
name|H_MAX
value|3150
end_define

begin_define
define|#
directive|define
name|W_MARGIN
value|75
end_define

begin_define
define|#
directive|define
name|H_MARGIN
value|37
end_define

begin_define
define|#
directive|define
name|W_PAGE
value|2550
end_define

begin_define
define|#
directive|define
name|H_PAGE
value|3225
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|NOINLINE
end_ifdef

begin_define
define|#
directive|define
name|min
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(((x)<(y))?(x):(y))
end_define

begin_endif
endif|#
directive|endif
endif|NOINLINE
end_endif

begin_define
define|#
directive|define
name|F_PORTRAIT
value|1
end_define

begin_define
define|#
directive|define
name|F_LANDSCAPE
value|2
end_define

begin_define
define|#
directive|define
name|F_DUMP
value|4
end_define

begin_define
define|#
directive|define
name|F_NOSIXOPT
value|8
end_define

begin_define
define|#
directive|define
name|F_APPEND
value|16
end_define

begin_define
define|#
directive|define
name|F_NOFF
value|32
end_define

begin_define
define|#
directive|define
name|F_REPORT
value|64
end_define

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|XWDFileHeader
name|win
decl_stmt|;
specifier|register
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
decl|[]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|iw
decl_stmt|;
specifier|register
name|int
name|ih
decl_stmt|;
specifier|register
name|int
name|sixel_count
decl_stmt|;
name|char
modifier|*
name|w_name
decl_stmt|;
name|char
modifier|*
name|filename
decl_stmt|;
name|char
modifier|*
name|output_filename
decl_stmt|;
name|int
name|scale
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|,
name|flags
decl_stmt|,
name|split
decl_stmt|;
name|int
name|left
decl_stmt|,
name|top
decl_stmt|;
name|int
name|top_margin
decl_stmt|,
name|left_margin
decl_stmt|;
name|int
name|wpad
decl_stmt|,
name|hpad
decl_stmt|;
name|char
modifier|*
name|header
decl_stmt|,
modifier|*
name|trailer
decl_stmt|;
name|enum
name|orientation
name|orientation
decl_stmt|;
name|enum
name|device
name|device
decl_stmt|;
name|parse_args
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|scale
argument_list|,
operator|&
name|width
argument_list|,
operator|&
name|height
argument_list|,
operator|&
name|left
argument_list|,
operator|&
name|top
argument_list|,
operator|&
name|device
argument_list|,
operator|&
name|flags
argument_list|,
operator|&
name|split
argument_list|,
operator|&
name|header
argument_list|,
operator|&
name|trailer
argument_list|)
expr_stmt|;
comment|/* read in window header */
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|win
argument_list|,
sizeof|sizeof
name|win
argument_list|)
expr_stmt|;
name|w_name
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|win
operator|.
name|header_size
operator|-
sizeof|sizeof
name|win
argument_list|)
expr_stmt|;
name|read
argument_list|(
literal|0
argument_list|,
name|w_name
argument_list|,
name|win
operator|.
name|header_size
operator|-
sizeof|sizeof
name|win
argument_list|)
expr_stmt|;
comment|/* calculate orientation and scale */
name|setup_layout
argument_list|(
name|device
argument_list|,
name|win
operator|.
name|pixmap_width
argument_list|,
name|win
operator|.
name|pixmap_height
argument_list|,
name|flags
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|header
argument_list|,
name|trailer
argument_list|,
operator|&
name|scale
argument_list|,
operator|&
name|orientation
argument_list|)
expr_stmt|;
comment|/* calculate w and h cell count */
name|wpad
operator|=
operator|(
literal|16
operator|-
operator|(
name|win
operator|.
name|pixmap_width
operator|&
literal|15
operator|)
operator|)
operator|&
literal|15
expr_stmt|;
name|iw
operator|=
name|win
operator|.
name|pixmap_width
expr_stmt|;
name|ih
operator|=
operator|(
name|win
operator|.
name|pixmap_height
operator|+
literal|5
operator|)
operator|/
literal|6
expr_stmt|;
name|hpad
operator|=
operator|(
name|ih
operator|*
literal|6
operator|)
operator|-
name|win
operator|.
name|pixmap_height
expr_stmt|;
comment|/* build pixcells from input file */
name|sixel_count
operator|=
name|iw
operator|*
name|ih
expr_stmt|;
name|sixmap
operator|=
operator|(
name|unsigned
name|char
argument_list|(
operator|*
argument_list|)
index|[]
operator|)
name|malloc
argument_list|(
name|sixel_count
argument_list|)
expr_stmt|;
name|build_sixmap
argument_list|(
name|iw
argument_list|,
name|ih
argument_list|,
name|sixmap
argument_list|,
name|wpad
argument_list|,
name|hpad
argument_list|)
expr_stmt|;
comment|/* output commands and sixel graphics */
if|if
condition|(
name|device
operator|==
name|LN03
condition|)
block|{
comment|/*	ln03_grind_fonts(sixmap, iw, ih, scale,&pixmap); */
name|ln03_setup
argument_list|(
name|iw
argument_list|,
name|ih
argument_list|,
name|orientation
argument_list|,
name|scale
argument_list|,
name|left
argument_list|,
name|top
argument_list|,
operator|&
name|left_margin
argument_list|,
operator|&
name|top_margin
argument_list|,
name|flags
argument_list|,
name|header
argument_list|,
name|trailer
argument_list|)
expr_stmt|;
name|ln03_output_sixels
argument_list|(
name|sixmap
argument_list|,
name|iw
argument_list|,
name|ih
argument_list|,
operator|(
name|flags
operator|&
name|F_NOSIXOPT
operator|)
argument_list|,
name|split
argument_list|,
name|scale
argument_list|,
name|top_margin
argument_list|,
name|left_margin
argument_list|)
expr_stmt|;
name|ln03_finish
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|device
operator|==
name|LA100
condition|)
block|{
name|la100_setup
argument_list|(
name|iw
argument_list|,
name|ih
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|la100_output_sixels
argument_list|(
name|sixmap
argument_list|,
name|iw
argument_list|,
name|ih
argument_list|,
operator|(
name|flags
operator|&
name|F_NOSIXOPT
operator|)
argument_list|)
expr_stmt|;
name|la100_finish
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: device not supported\n"
argument_list|)
expr_stmt|;
block|}
comment|/* print some statistics */
if|if
condition|(
name|flags
operator|&
name|F_REPORT
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Name: %s\n"
argument_list|,
name|w_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Width: %d, Height: %d\n"
argument_list|,
name|win
operator|.
name|pixmap_width
argument_list|,
name|win
operator|.
name|pixmap_height
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Orientation: %s, Scale: %d\n"
argument_list|,
operator|(
name|orientation
operator|==
name|PORTRAIT
operator|)
condition|?
literal|"Portrait"
else|:
literal|"Landscape"
argument_list|,
name|scale
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|F_DUMP
condition|)
name|dump_sixmap
argument_list|(
name|sixmap
argument_list|,
name|iw
argument_list|,
name|ih
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|parse_args
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
name|scale
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|left
argument_list|,
name|top
argument_list|,
name|device
argument_list|,
name|flags
argument_list|,
name|split
argument_list|,
name|header
argument_list|,
name|trailer
argument_list|)
specifier|register
name|int
name|argc
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|scale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|width
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|left
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|top
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|device
modifier|*
name|device
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|split
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|header
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|trailer
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|output_filename
decl_stmt|;
specifier|register
name|int
name|f
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|int
name|pos
decl_stmt|;
name|double
name|atof
parameter_list|()
function_decl|;
name|int
name|atoi
parameter_list|()
function_decl|;
name|output_filename
operator|=
name|NULL
expr_stmt|;
operator|*
name|device
operator|=
name|LN03
expr_stmt|;
comment|/* default */
operator|*
name|flags
operator|=
literal|0
expr_stmt|;
operator|*
name|split
operator|=
literal|1
expr_stmt|;
operator|*
name|width
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|height
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|top
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|left
operator|=
operator|-
literal|1
expr_stmt|;
operator|*
name|header
operator|=
name|NULL
expr_stmt|;
operator|*
name|trailer
operator|=
name|NULL
expr_stmt|;
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
while|while
condition|(
name|argc
operator|>
literal|0
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
name|len
operator|=
name|strlen
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|argv
index|[
literal|0
index|]
index|[
literal|1
index|]
condition|)
block|{
case|case
literal|'a'
case|:
comment|/* -append<filename> */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-append"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|output_filename
operator|=
operator|*
name|argv
expr_stmt|;
operator|*
name|flags
operator||=
name|F_APPEND
expr_stmt|;
block|}
break|break;
case|case
literal|'d'
case|:
comment|/* -device {ln03 | la100} | -dump */
if|if
condition|(
name|len
operator|<=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: ambiguous option: \"%s\"\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-device"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"ln03"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|device
operator|=
name|LN03
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"la100"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|device
operator|=
name|LA100
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: device \"%s\" not supported\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-dump"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|flags
operator||=
name|F_DUMP
expr_stmt|;
block|}
break|break;
case|case
literal|'h'
case|:
comment|/* -height<inches> */
if|if
condition|(
name|len
operator|<=
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: ambiguous option: \"%s\"\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-height"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|height
operator|=
call|(
name|int
call|)
argument_list|(
literal|300.0
operator|*
name|atof
argument_list|(
operator|*
name|argv
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-header"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|header
operator|=
operator|*
name|argv
expr_stmt|;
block|}
break|break;
case|case
literal|'l'
case|:
comment|/* -landscape | -left<inches> */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-landscape"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|flags
operator||=
name|F_LANDSCAPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-left"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|left
operator|=
call|(
name|int
call|)
argument_list|(
literal|300.0
operator|*
name|atof
argument_list|(
operator|*
name|argv
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'n'
case|:
comment|/* -nosixopt | -noff */
if|if
condition|(
name|len
operator|<=
literal|3
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: ambiguous option: \"%s\"\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-nosixopt"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|flags
operator||=
name|F_NOSIXOPT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-noff"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|flags
operator||=
name|F_NOFF
expr_stmt|;
block|}
break|break;
case|case
literal|'o'
case|:
comment|/* -output<filename> */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-output"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
name|output_filename
operator|=
operator|*
name|argv
expr_stmt|;
block|}
break|break;
case|case
literal|'p'
case|:
comment|/* -portrait */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-portrait"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|flags
operator||=
name|F_PORTRAIT
expr_stmt|;
block|}
break|break;
case|case
literal|'r'
case|:
comment|/* -report */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-report"
argument_list|,
name|len
argument_list|)
condition|)
block|{
operator|*
name|flags
operator||=
name|F_REPORT
expr_stmt|;
block|}
break|break;
case|case
literal|'s'
case|:
comment|/* -scale<scale> | -split<n-pages> */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-scale"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|scale
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-split"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|split
operator|=
name|atoi
argument_list|(
operator|*
name|argv
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
comment|/* -top<inches> */
if|if
condition|(
name|len
operator|<=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: ambigous option: \"%s\"\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-top"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|top
operator|=
call|(
name|int
call|)
argument_list|(
literal|300.0
operator|*
name|atof
argument_list|(
operator|*
name|argv
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-trailer"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|trailer
operator|=
operator|*
name|argv
expr_stmt|;
block|}
break|break;
case|case
literal|'w'
case|:
comment|/* -width<inches> */
if|if
condition|(
operator|!
name|bcmp
argument_list|(
operator|*
name|argv
argument_list|,
literal|"-width"
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
operator|*
name|width
operator|=
call|(
name|int
call|)
argument_list|(
literal|300.0
operator|*
name|atof
argument_list|(
operator|*
name|argv
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|argc
operator|--
expr_stmt|;
name|argv
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|>
literal|0
condition|)
block|{
name|f
operator|=
name|open
argument_list|(
operator|*
name|argv
argument_list|,
name|O_RDONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: error opening \"%s\" for input\n"
argument_list|,
operator|*
name|argv
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|""
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dup2
argument_list|(
name|f
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
comment|/*	if (output_filename == NULL) { 	    output_filename = (char *)malloc(strlen(*argv)+10); 	    build_output_filename(*argv, *device, output_filename); 	} */
block|}
if|if
condition|(
name|output_filename
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|*
name|flags
operator|&
name|F_APPEND
operator|)
condition|)
block|{
name|f
operator|=
name|open
argument_list|(
name|output_filename
argument_list|,
name|O_CREAT
operator||
name|O_WRONLY
operator||
name|O_TRUNC
argument_list|,
literal|0664
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|f
operator|=
name|open
argument_list|(
name|output_filename
argument_list|,
name|O_WRONLY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|f
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"xwd2: error opening \"%s\" for output\n"
argument_list|,
name|output_filename
argument_list|)
expr_stmt|;
name|perror
argument_list|(
literal|"xwd2"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|flags
operator|&
name|F_APPEND
condition|)
block|{
name|pos
operator|=
name|lseek
argument_list|(
name|f
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* get eof position */
if|if
condition|(
operator|*
name|flags
operator|&
name|F_NOFF
condition|)
name|pos
operator|-=
literal|3
expr_stmt|;
comment|/* set position before trailing */
comment|/*     formfeed and reset */
name|lseek
argument_list|(
name|f
argument_list|,
name|pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set pointer */
block|}
name|dup2
argument_list|(
name|f
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|setup_layout
argument_list|(
name|device
argument_list|,
name|win_width
argument_list|,
name|win_height
argument_list|,
name|flags
argument_list|,
name|width
argument_list|,
name|height
argument_list|,
name|header
argument_list|,
name|trailer
argument_list|,
name|scale
argument_list|,
name|orientation
argument_list|)
expr|enum
name|device
name|device
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|win_width
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|win_height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|width
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|height
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|header
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|trailer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|scale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|orientation
modifier|*
name|orientation
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|w_scale
decl_stmt|;
specifier|register
name|int
name|h_scale
decl_stmt|;
specifier|register
name|int
name|iscale
init|=
operator|*
name|scale
decl_stmt|;
specifier|register
name|int
name|w_max
decl_stmt|;
specifier|register
name|int
name|h_max
decl_stmt|;
if|if
condition|(
name|header
operator|!=
name|NULL
condition|)
name|win_height
operator|+=
literal|75
expr_stmt|;
if|if
condition|(
name|trailer
operator|!=
name|NULL
condition|)
name|win_height
operator|+=
literal|75
expr_stmt|;
comment|/* check maximum width and height; set orientation and scale*/
if|if
condition|(
name|device
operator|==
name|LN03
condition|)
block|{
if|if
condition|(
operator|(
name|win_width
operator|<
name|win_height
operator|||
operator|(
name|flags
operator|&
name|F_PORTRAIT
operator|)
operator|)
operator|&&
operator|!
operator|(
name|flags
operator|&
name|F_LANDSCAPE
operator|)
condition|)
block|{
operator|*
name|orientation
operator|=
name|PORTRAIT
expr_stmt|;
name|w_max
operator|=
operator|(
name|width
operator|>
literal|0
operator|)
condition|?
name|width
else|:
name|W_MAX
expr_stmt|;
name|h_max
operator|=
operator|(
name|height
operator|>
literal|0
operator|)
condition|?
name|height
else|:
name|H_MAX
expr_stmt|;
name|w_scale
operator|=
name|w_max
operator|/
name|win_width
expr_stmt|;
name|h_scale
operator|=
name|h_max
operator|/
name|win_height
expr_stmt|;
operator|*
name|scale
operator|=
name|min
argument_list|(
name|w_scale
argument_list|,
name|h_scale
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|*
name|orientation
operator|=
name|LANDSCAPE
expr_stmt|;
name|w_max
operator|=
operator|(
name|width
operator|>
literal|0
operator|)
condition|?
name|width
else|:
name|H_MAX
expr_stmt|;
name|h_max
operator|=
operator|(
name|height
operator|>
literal|0
operator|)
condition|?
name|height
else|:
name|W_MAX
expr_stmt|;
name|w_scale
operator|=
name|w_max
operator|/
name|win_width
expr_stmt|;
name|h_scale
operator|=
name|h_max
operator|/
name|win_height
expr_stmt|;
operator|*
name|scale
operator|=
name|min
argument_list|(
name|w_scale
argument_list|,
name|h_scale
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* device == LA100 */
operator|*
name|orientation
operator|=
name|PORTRAIT
expr_stmt|;
operator|*
name|scale
operator|=
name|W_MAX
operator|/
name|win_width
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|scale
operator|==
literal|0
condition|)
operator|*
name|scale
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|*
name|scale
operator|>
literal|6
condition|)
operator|*
name|scale
operator|=
literal|6
expr_stmt|;
if|if
condition|(
name|iscale
operator|>
literal|0
operator|&&
name|iscale
operator|<
operator|*
name|scale
condition|)
operator|*
name|scale
operator|=
name|iscale
expr_stmt|;
block|}
end_block

begin_expr_stmt
name|dump_sixmap
argument_list|(
name|sixmap
argument_list|,
name|iw
argument_list|,
name|ih
argument_list|)
specifier|register
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
index|[]
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|c
decl_stmt|;
name|c
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|sixmap
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Sixmap:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ih
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iw
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%02X "
argument_list|,
operator|*
name|c
operator|++
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|build_sixmap
argument_list|(
argument|iw
argument_list|,
argument|ih
argument_list|,
argument|sixmap
argument_list|,
argument|wpad
argument_list|,
argument|hpad
argument_list|)
end_macro

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
decl|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|wpad
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|hpad
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|iwb
decl_stmt|,
name|iww
decl_stmt|;
name|int
name|rsize
decl_stmt|,
name|cc
decl_stmt|;
name|int
name|w
decl_stmt|,
name|maxw
decl_stmt|;
name|struct
name|iovec
name|linevec
index|[
literal|6
index|]
decl_stmt|;
name|unsigned
name|char
name|line
index|[
literal|6
index|]
index|[
literal|150
index|]
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|c
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|m
decl_stmt|;
specifier|register
name|int
name|sixel
decl_stmt|;
specifier|static
name|int
name|mask
index|[]
init|=
block|{
operator|~
literal|1
block|,
operator|~
literal|2
block|,
operator|~
literal|4
block|,
operator|~
literal|8
block|,
operator|~
literal|16
block|,
operator|~
literal|32
block|,
operator|~
literal|64
block|,
operator|~
literal|128
block|}
decl_stmt|;
name|c
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|sixmap
expr_stmt|;
name|iwb
operator|=
operator|(
name|iw
operator|+
name|wpad
operator|)
operator|/
literal|8
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
literal|5
condition|;
name|i
operator|++
control|)
block|{
name|linevec
index|[
name|i
index|]
operator|.
name|iov_base
operator|=
operator|(
name|caddr_t
operator|)
name|line
index|[
name|i
index|]
expr_stmt|;
name|linevec
index|[
name|i
index|]
operator|.
name|iov_len
operator|=
name|iwb
expr_stmt|;
block|}
while|while
condition|(
operator|--
name|ih
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|ih
operator|>
literal|0
operator|||
name|hpad
operator|==
literal|0
condition|)
block|{
name|rsize
operator|=
name|iwb
operator|*
literal|6
expr_stmt|;
while|while
condition|(
name|rsize
operator|>
literal|0
condition|)
block|{
name|cc
operator|=
name|readv
argument_list|(
literal|0
argument_list|,
name|linevec
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
break|break;
name|rsize
operator|-=
name|cc
expr_stmt|;
block|}
block|}
else|else
block|{
name|i
operator|=
literal|6
operator|-
name|hpad
expr_stmt|;
name|rsize
operator|=
name|iwb
operator|*
name|i
expr_stmt|;
while|while
condition|(
name|rsize
operator|>
literal|0
condition|)
block|{
name|cc
operator|=
name|readv
argument_list|(
literal|0
argument_list|,
name|linevec
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
break|break;
name|rsize
operator|-=
name|cc
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iwb
condition|;
name|j
operator|++
control|)
name|line
index|[
name|i
index|]
index|[
name|j
index|]
operator|=
literal|0xFF
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|NOINLINE
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iw
condition|;
name|i
operator|++
control|)
block|{
name|sixel
operator|=
name|extzv
argument_list|(
name|line
index|[
literal|0
index|]
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sixel
operator||=
name|extzv
argument_list|(
name|line
index|[
literal|1
index|]
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|sixel
operator||=
name|extzv
argument_list|(
name|line
index|[
literal|2
index|]
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|sixel
operator||=
name|extzv
argument_list|(
name|line
index|[
literal|3
index|]
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|<<
literal|3
expr_stmt|;
name|sixel
operator||=
name|extzv
argument_list|(
name|line
index|[
literal|4
index|]
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|<<
literal|4
expr_stmt|;
name|sixel
operator||=
name|extzv
argument_list|(
name|line
index|[
literal|5
index|]
argument_list|,
name|i
argument_list|,
literal|1
argument_list|)
operator|<<
literal|5
expr_stmt|;
operator|*
name|c
operator|++
operator|=
name|sixel
expr_stmt|;
block|}
else|#
directive|else
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|w
operator|=
name|iw
init|;
name|w
operator|>
literal|0
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<=
literal|7
condition|;
name|j
operator|++
control|)
block|{
name|m
operator|=
name|mask
index|[
name|j
index|]
expr_stmt|;
name|k
operator|=
operator|-
name|j
expr_stmt|;
name|sixel
operator|=
operator|(
operator|(
name|line
index|[
literal|0
index|]
index|[
name|i
index|]
operator|&
operator|~
name|m
operator|)
operator|<<
name|k
operator|++
operator|)
expr_stmt|;
name|sixel
operator||=
operator|(
operator|(
name|line
index|[
literal|1
index|]
index|[
name|i
index|]
operator|&
operator|~
name|m
operator|)
operator|<<
name|k
operator|++
operator|)
expr_stmt|;
name|sixel
operator||=
operator|(
operator|(
name|line
index|[
literal|2
index|]
index|[
name|i
index|]
operator|&
operator|~
name|m
operator|)
operator|<<
name|k
operator|++
operator|)
expr_stmt|;
name|sixel
operator||=
operator|(
operator|(
name|line
index|[
literal|3
index|]
index|[
name|i
index|]
operator|&
operator|~
name|m
operator|)
operator|<<
name|k
operator|++
operator|)
expr_stmt|;
name|sixel
operator||=
operator|(
operator|(
name|line
index|[
literal|4
index|]
index|[
name|i
index|]
operator|&
operator|~
name|m
operator|)
operator|<<
name|k
operator|++
operator|)
expr_stmt|;
name|sixel
operator||=
operator|(
operator|(
name|line
index|[
literal|5
index|]
index|[
name|i
index|]
operator|&
operator|~
name|m
operator|)
operator|<<
name|k
operator|)
expr_stmt|;
operator|*
name|c
operator|++
operator|=
name|sixel
expr_stmt|;
if|if
condition|(
operator|--
name|w
operator|==
literal|0
condition|)
break|break;
block|}
block|}
endif|#
directive|endif
block|}
block|}
end_block

begin_expr_stmt
name|build_output_filename
argument_list|(
name|name
argument_list|,
name|device
argument_list|,
name|oname
argument_list|)
specifier|register
name|char
operator|*
name|name
operator|,
operator|*
name|oname
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|enum
name|device
name|device
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|name
operator|&&
operator|*
name|name
operator|!=
literal|'.'
condition|)
operator|*
name|oname
operator|++
operator|=
operator|*
name|name
operator|++
expr_stmt|;
switch|switch
condition|(
name|device
condition|)
block|{
case|case
name|LN03
case|:
name|bcopy
argument_list|(
literal|".ln03"
argument_list|,
name|oname
argument_list|,
literal|6
argument_list|)
expr_stmt|;
break|break;
case|case
name|LA100
case|:
name|bcopy
argument_list|(
literal|".la100"
argument_list|,
name|oname
argument_list|,
literal|7
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_block

begin_macro
name|ln03_grind_fonts
argument_list|(
argument|sixmap
argument_list|,
argument|iw
argument_list|,
argument|ih
argument_list|,
argument|scale
argument_list|,
argument|pixmap
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
decl|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pixmap
argument_list|(
operator|*
operator|*
name|pixmap
argument_list|)
decl|[]
decl_stmt|;
end_decl_stmt

begin_block
block|{ }
end_block

begin_macro
name|ln03_setup
argument_list|(
argument|iw
argument_list|,
argument|ih
argument_list|,
argument|orientation
argument_list|,
argument|scale
argument_list|,
argument|left
argument_list|,
argument|top
argument_list|,
argument|left_margin
argument_list|,
argument|top_margin
argument_list|,
argument|flags
argument_list|,
argument|header
argument_list|,
argument|trailer
argument_list|)
end_macro

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|enum
name|orientation
name|orientation
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scale
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|left
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|top
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|left_margin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|top_margin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|flags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|header
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|trailer
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|lm
decl_stmt|,
name|tm
decl_stmt|,
name|xm
decl_stmt|;
name|char
name|fontname
index|[
literal|6
index|]
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
init|=
name|buf
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|F_APPEND
operator|)
condition|)
block|{
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_RIS
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|2
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_SSU
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|5
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_PUM_SET
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
name|LN_PUM_SET
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|orientation
operator|==
name|PORTRAIT
condition|)
block|{
name|lm
operator|=
operator|(
name|left
operator|>
literal|0
operator|)
condition|?
name|left
else|:
operator|(
operator|(
operator|(
name|W_MAX
operator|-
name|scale
operator|*
name|iw
operator|)
operator|/
literal|2
operator|)
operator|+
name|W_MARGIN
operator|)
expr_stmt|;
name|tm
operator|=
operator|(
name|top
operator|>
literal|0
operator|)
condition|?
name|top
else|:
operator|(
operator|(
operator|(
name|H_MAX
operator|-
name|scale
operator|*
name|ih
operator|*
literal|6
operator|)
operator|/
literal|2
operator|)
operator|+
name|H_MARGIN
operator|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_PFS
argument_list|,
literal|"?20"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|7
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_DECOPM_SET
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
name|LN_DECOPM_SET
operator|-
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_DECSLRM
argument_list|,
name|lm
argument_list|,
name|W_PAGE
operator|-
name|lm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lm
operator|=
operator|(
name|left
operator|>
literal|0
operator|)
condition|?
name|left
else|:
operator|(
operator|(
operator|(
name|H_MAX
operator|-
name|scale
operator|*
name|iw
operator|)
operator|/
literal|2
operator|)
operator|+
name|H_MARGIN
operator|)
expr_stmt|;
name|tm
operator|=
operator|(
name|top
operator|>
literal|0
operator|)
condition|?
name|top
else|:
operator|(
operator|(
operator|(
name|W_MAX
operator|-
name|scale
operator|*
name|ih
operator|*
literal|6
operator|)
operator|/
literal|2
operator|)
operator|+
name|W_MARGIN
operator|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_PFS
argument_list|,
literal|"?21"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|7
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_DECOPM_SET
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
name|LN_DECOPM_SET
operator|-
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_DECSLRM
argument_list|,
name|lm
argument_list|,
name|H_PAGE
operator|-
name|lm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|header
operator|!=
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_VPA
argument_list|,
name|tm
operator|-
literal|100
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|header
argument_list|)
expr_stmt|;
name|xm
operator|=
operator|(
operator|(
operator|(
name|scale
operator|*
name|iw
operator|)
operator|-
operator|(
name|i
operator|*
literal|30
operator|)
operator|)
operator|/
literal|2
operator|)
operator|+
name|lm
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_HPA
argument_list|,
name|xm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_SGR
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|header
argument_list|,
name|bp
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|i
expr_stmt|;
block|}
if|if
condition|(
name|trailer
operator|!=
name|NULL
condition|)
block|{
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_VPA
argument_list|,
name|tm
operator|+
operator|(
name|scale
operator|*
name|ih
operator|*
literal|6
operator|)
operator|+
literal|75
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|trailer
argument_list|)
expr_stmt|;
name|xm
operator|=
operator|(
operator|(
operator|(
name|scale
operator|*
name|iw
operator|)
operator|-
operator|(
name|i
operator|*
literal|30
operator|)
operator|)
operator|/
literal|2
operator|)
operator|+
name|lm
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_HPA
argument_list|,
name|xm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_SGR
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|trailer
argument_list|,
name|bp
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|i
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_HPA
argument_list|,
name|lm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_VPA
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_SIXEL_GRAPHICS
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"1;1"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
comment|/* Pixel aspect ratio */
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|bp
operator|-
name|buf
argument_list|)
expr_stmt|;
operator|*
name|top_margin
operator|=
name|tm
expr_stmt|;
operator|*
name|left_margin
operator|=
name|lm
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|LN03_RESET
value|"\033c"
end_define

begin_macro
name|ln03_finish
argument_list|()
end_macro

begin_block
block|{
name|write
argument_list|(
literal|1
argument_list|,
name|LN03_RESET
argument_list|,
sizeof|sizeof
name|LN03_RESET
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|la100_setup
argument_list|(
argument|iw
argument_list|,
argument|ih
argument_list|,
argument|scale
argument_list|)
end_macro

begin_block
block|{
name|unsigned
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|bp
decl_stmt|;
name|int
name|lm
decl_stmt|,
name|tm
decl_stmt|;
name|bp
operator|=
name|buf
expr_stmt|;
name|lm
operator|=
operator|(
operator|(
literal|80
operator|-
call|(
name|int
call|)
argument_list|(
operator|(
name|double
operator|)
name|iw
operator|/
literal|6.6
argument_list|)
operator|)
operator|/
literal|2
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|lm
operator|<
literal|1
condition|)
name|lm
operator|=
literal|1
expr_stmt|;
name|tm
operator|=
operator|(
operator|(
literal|66
operator|-
call|(
name|int
call|)
argument_list|(
operator|(
name|double
operator|)
name|ih
operator|/
literal|2
argument_list|)
operator|)
operator|/
literal|2
operator|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|tm
operator|<
literal|1
condition|)
name|tm
operator|=
literal|1
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\033[%d;%ds"
argument_list|,
name|lm
argument_list|,
literal|81
operator|-
name|lm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\033[?7l"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|5
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\033[%dd"
argument_list|,
name|tm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\033[%d`"
argument_list|,
name|lm
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\033P0q"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|bp
operator|-
name|buf
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|LA100_RESET
value|"\033[1;80s\033[?7h"
end_define

begin_macro
name|la100_finish
argument_list|()
end_macro

begin_block
block|{
name|write
argument_list|(
literal|1
argument_list|,
name|LA100_RESET
argument_list|,
sizeof|sizeof
name|LA100_RESET
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|ln03_alter_background
argument_list|(
argument|sixmap
argument_list|,
argument|iw
argument_list|,
argument|ih
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
decl|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|size
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|c
decl_stmt|,
modifier|*
name|stopc
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|startc
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|c
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|sixmap
expr_stmt|;
name|stopc
operator|=
name|c
operator|+
operator|(
name|iw
operator|*
name|ih
operator|)
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|c
operator|<
name|stopc
condition|)
block|{
switch|switch
condition|(
operator|*
name|c
condition|)
block|{
case|case
literal|0x08
case|:
case|case
literal|0x11
case|:
case|case
literal|0x04
case|:
case|case
literal|0x22
case|:
case|case
literal|0x20
case|:
case|case
literal|0x21
case|:
case|case
literal|0x24
case|:
case|case
literal|0x00
case|:
if|if
condition|(
name|n
operator|==
literal|0
condition|)
name|startc
operator|=
name|c
expr_stmt|;
name|n
operator|++
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|n
operator|>=
literal|2
condition|)
block|{
while|while
condition|(
name|n
operator|--
operator|>
literal|0
condition|)
operator|*
name|startc
operator|++
operator|=
literal|0x00
expr_stmt|;
block|}
else|else
block|{
name|n
operator|=
literal|0
expr_stmt|;
block|}
break|break;
block|}
name|c
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|ln03_output_sixels
argument_list|(
argument|sixmap
argument_list|,
argument|iw
argument_list|,
argument|ih
argument_list|,
argument|nosixopt
argument_list|,
argument|split
argument_list|,
argument|scale
argument_list|,
argument|top_margin
argument_list|,
argument|left_margin
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
decl|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nosixopt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|split
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|top_margin
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|left_margin
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|bp
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|j
decl_stmt|;
specifier|register
name|int
name|k
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|c
decl_stmt|;
specifier|register
name|int
name|lastc
decl_stmt|;
specifier|register
name|int
name|count
decl_stmt|;
name|char
name|snum
index|[
literal|6
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|snp
decl_stmt|;
name|bp
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|iw
operator|*
name|ih
operator|+
literal|512
argument_list|)
expr_stmt|;
name|buf
operator|=
name|bp
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|lastc
operator|=
operator|-
literal|1
expr_stmt|;
name|c
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|sixmap
expr_stmt|;
name|split
operator|=
name|ih
operator|/
name|split
expr_stmt|;
comment|/* number of lines per page */
name|iw
operator|--
expr_stmt|;
comment|/* optimization */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ih
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<=
name|iw
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nosixopt
condition|)
block|{
if|if
condition|(
operator|*
name|c
operator|==
name|lastc
operator|&&
name|j
operator|<
name|iw
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|c
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|count
operator|>=
literal|3
condition|)
block|{
name|bp
operator|--
expr_stmt|;
name|count
operator|++
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'!'
expr_stmt|;
name|snp
operator|=
name|snum
expr_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|k
operator|=
name|count
operator|/
literal|10
expr_stmt|;
operator|*
name|snp
operator|++
operator|=
name|count
operator|-
operator|(
name|k
operator|*
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|count
operator|=
name|k
expr_stmt|;
block|}
while|while
condition|(
operator|--
name|snp
operator|>=
name|snum
condition|)
operator|*
name|bp
operator|++
operator|=
operator|*
name|snp
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
operator|(
operator|~
name|lastc
operator|&
literal|0x3F
operator|)
operator|+
literal|0x3F
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|lastc
operator|=
operator|(
operator|~
name|lastc
operator|&
literal|0x3F
operator|)
operator|+
literal|0x3F
expr_stmt|;
do|do
block|{
operator|*
name|bp
operator|++
operator|=
name|lastc
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
block|}
block|}
name|lastc
operator|=
operator|*
name|c
operator|++
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
operator|(
operator|~
name|lastc
operator|&
literal|0x3F
operator|)
operator|+
literal|0x3F
expr_stmt|;
block|}
operator|*
name|bp
operator|++
operator|=
literal|'-'
expr_stmt|;
comment|/* New line */
name|lastc
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
name|split
operator|)
operator|==
literal|0
operator|&&
name|i
operator|!=
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_ST
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
name|LN_ST
operator|-
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'\f'
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_VPA
argument_list|,
name|top_margin
operator|+
operator|(
name|i
operator|*
literal|6
operator|*
name|scale
operator|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_HPA
argument_list|,
name|left_margin
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_SIXEL_GRAPHICS
argument_list|,
literal|9
argument_list|,
literal|0
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"\"1;1"
argument_list|)
expr_stmt|;
name|bp
operator|+=
literal|4
expr_stmt|;
block|}
block|}
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_ST
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
name|LN_ST
operator|-
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'\f'
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|bp
operator|-
name|buf
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|la100_output_sixels
argument_list|(
argument|sixmap
argument_list|,
argument|iw
argument_list|,
argument|ih
argument_list|)
end_macro

begin_decl_stmt
name|unsigned
name|char
argument_list|(
operator|*
name|sixmap
argument_list|)
decl|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|iw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ih
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|bp
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|j
decl_stmt|,
name|k
decl_stmt|;
specifier|register
name|unsigned
name|char
modifier|*
name|c
decl_stmt|;
specifier|register
name|int
name|lastc
decl_stmt|;
specifier|register
name|int
name|count
decl_stmt|;
name|char
name|snum
index|[
literal|6
index|]
decl_stmt|;
name|bp
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|iw
operator|*
name|ih
operator|+
literal|512
argument_list|)
expr_stmt|;
name|buf
operator|=
name|bp
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|lastc
operator|=
operator|-
literal|1
expr_stmt|;
name|c
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|sixmap
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ih
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iw
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|c
operator|==
name|lastc
operator|&&
operator|(
name|j
operator|+
literal|1
operator|)
operator|<
name|iw
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|c
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|count
operator|>=
literal|2
condition|)
block|{
name|bp
operator|-=
literal|2
expr_stmt|;
name|count
operator|=
literal|2
operator|*
operator|(
name|count
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'!'
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|snum
index|[
name|k
operator|++
index|]
operator|=
operator|(
name|count
operator|%
literal|10
operator|)
operator|+
literal|'0'
expr_stmt|;
name|count
operator|/=
literal|10
expr_stmt|;
block|}
while|while
condition|(
operator|--
name|k
operator|>=
literal|0
condition|)
operator|*
name|bp
operator|++
operator|=
name|snum
index|[
name|k
index|]
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
operator|(
operator|~
name|lastc
operator|&
literal|0x3F
operator|)
operator|+
literal|0x3F
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|lastc
operator|=
operator|(
operator|~
name|lastc
operator|&
literal|0x3F
operator|)
operator|+
literal|0x3F
expr_stmt|;
do|do
block|{
operator|*
name|bp
operator|++
operator|=
name|lastc
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
name|lastc
expr_stmt|;
block|}
do|while
condition|(
operator|--
name|count
operator|>
literal|0
condition|)
do|;
block|}
name|lastc
operator|=
operator|(
operator|~
operator|*
name|c
operator|&
literal|0x3F
operator|)
operator|+
literal|0x3F
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
name|lastc
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
name|lastc
expr_stmt|;
name|lastc
operator|=
operator|*
name|c
operator|++
expr_stmt|;
block|}
operator|*
name|bp
operator|++
operator|=
literal|'-'
expr_stmt|;
comment|/* New line */
name|lastc
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|bp
argument_list|,
name|LN_ST
argument_list|)
expr_stmt|;
name|bp
operator|+=
sizeof|sizeof
name|LN_ST
operator|-
literal|1
expr_stmt|;
operator|*
name|bp
operator|++
operator|=
literal|'\f'
expr_stmt|;
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|bp
operator|-
name|buf
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


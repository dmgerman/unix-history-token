begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid_Xttylib_c
init|=
literal|"$Header: Xttylib.c,v 10.6 86/02/01 15:42:48 tony Rel $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* This version has a single reverse-video argument instead of colors.  It    really only works well on monochrome displays */
end_comment

begin_comment
comment|/* Library of routines to create a terminal emulator window  *  * Routines in this library are:  *  *	CreateTTYWindow		Creates a new instance of a terminal window  *	DestroyTTYWindow	Destroys a terminal window  *	TTYPutString		Puts a string in a terminal window  *	TTYPutChar		Puts a character in a terminal window  *	TTYPrintf		Does a printf in a terminal window  *	TTYGetString		Gets s string from a terminal window  *	TTYGetChar		Gets a char from a terminal window  *	SetStdout		Flushes stdout and assigns it to a window  *	ResetStdout		Resets stdout to its inital value  *  * The terminal window created responds to exactly the same character  * sequences as xterm (not surprising).  Creating a window automatically  * maps it  *  * These routines pass around a pointer to a TTYWindow:  *  * typedef struct _TTYWindow {  * 	Window w;		The window id  *	int pid;		The pid of the subprocess xterm  *	short file;		The file id of the tty to read/write characters to/from  * } TTYWindow;  *  *  * The SetStdout routine is highly useful in conjunction with curses  * since curses always writes to stdout.  */
end_comment

begin_include
include|#
directive|include
file|<X/Xlib.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<sgtty.h>
end_include

begin_include
include|#
directive|include
file|"Xtty.h"
end_include

begin_function
name|TTYWindow
modifier|*
name|CreateTTYWindow
parameter_list|(
name|cols
parameter_list|,
name|lines
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|normFont
parameter_list|,
name|boldFont
parameter_list|,
name|bwidth
parameter_list|,
name|reverse
parameter_list|)
name|int
name|lines
decl_stmt|,
name|cols
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|bwidth
decl_stmt|,
name|reverse
decl_stmt|;
name|char
modifier|*
name|normFont
decl_stmt|,
decl|*
name|boldFont
decl_stmt|;
end_function

begin_block
block|{
name|TTYWindow
modifier|*
name|t
decl_stmt|;
if|if
condition|(
operator|(
name|t
operator|=
operator|(
name|TTYWindow
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|TTYWindow
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|Start_slave_xterm
argument_list|(
name|t
argument_list|,
name|lines
argument_list|,
name|cols
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|normFont
argument_list|,
name|boldFont
argument_list|,
name|bwidth
argument_list|,
name|reverse
argument_list|)
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Couldn't start slave xterm\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|t
return|;
block|}
end_block

begin_decl_stmt
name|int
name|ttyMasterPty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|keepMasterOpen
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|Start_slave_xterm
parameter_list|(
name|t
parameter_list|,
name|lines
parameter_list|,
name|cols
parameter_list|,
name|x
parameter_list|,
name|y
parameter_list|,
name|normFont
parameter_list|,
name|boldFont
parameter_list|,
name|bwidth
parameter_list|,
name|reverse
parameter_list|)
name|TTYWindow
modifier|*
name|t
decl_stmt|;
name|int
name|lines
decl_stmt|,
name|cols
decl_stmt|,
name|x
decl_stmt|,
name|y
decl_stmt|,
name|bwidth
decl_stmt|,
name|reverse
decl_stmt|;
name|char
modifier|*
name|normFont
decl_stmt|,
decl|*
name|boldFont
decl_stmt|;
end_function

begin_block
block|{
define|#
directive|define
name|BUFSIZE
value|20
name|char
name|ttyName
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|char
name|Sbuf
index|[
name|BUFSIZE
index|]
decl_stmt|,
name|sizeBuf
index|[
name|BUFSIZE
index|]
decl_stmt|,
name|wdBuf
index|[
name|BUFSIZE
index|]
decl_stmt|,
name|inputBuffer
index|[
name|BUFSIZE
index|]
decl_stmt|;
name|int
name|bytesRead
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|boldFont
operator|==
name|NULL
condition|)
name|boldFont
operator|=
name|normFont
expr_stmt|;
name|ttyMasterPty
operator|=
name|GetPty
argument_list|(
name|ttyName
argument_list|)
expr_stmt|;
if|if
condition|(
name|ttyMasterPty
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|t
operator|->
name|pid
operator|=
name|vfork
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|t
operator|->
name|pid
operator|==
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|Sbuf
argument_list|,
literal|"-S%c%c%d"
argument_list|,
name|ttyName
index|[
literal|8
index|]
argument_list|,
name|ttyName
index|[
literal|9
index|]
argument_list|,
name|ttyMasterPty
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|sizeBuf
argument_list|,
literal|"=%dx%d+%d+%d"
argument_list|,
name|cols
argument_list|,
name|lines
argument_list|,
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|wdBuf
argument_list|,
literal|"%d"
argument_list|,
name|bwidth
argument_list|)
expr_stmt|;
name|execlp
argument_list|(
literal|"xterm"
argument_list|,
literal|"xterm"
argument_list|,
name|Sbuf
argument_list|,
literal|"-fn"
argument_list|,
name|normFont
argument_list|,
literal|"-fb"
argument_list|,
name|boldFont
argument_list|,
name|sizeBuf
argument_list|,
literal|"-bw"
argument_list|,
name|wdBuf
argument_list|,
name|reverse
condition|?
literal|"-rv"
else|:
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|keepMasterOpen
condition|)
name|close
argument_list|(
name|ttyMasterPty
argument_list|)
expr_stmt|;
comment|/* Open the slave end of the pty */
name|ttyName
index|[
literal|5
index|]
operator|=
literal|'t'
expr_stmt|;
comment|/* Change /dev/pty?? to /dev/tty?? */
name|t
operator|->
name|file
operator|=
name|open
argument_list|(
name|ttyName
argument_list|,
name|O_RDWR
argument_list|,
literal|0777
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|file
operator|<
literal|0
condition|)
block|{
comment|/* Couldn't open the tty--better get rid of the process */
name|kill
argument_list|(
name|t
operator|->
name|pid
argument_list|,
name|SIGINT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Read the windowid from the pty */
name|len
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|bytesRead
operator|=
name|read
argument_list|(
name|t
operator|->
name|file
argument_list|,
name|inputBuffer
operator|+
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|Window
argument_list|)
operator|-
name|len
argument_list|)
operator|)
operator|>
literal|0
condition|)
name|len
operator|+=
name|bytesRead
expr_stmt|;
comment|/* Flush the rest of the garbahge */
name|ioctl
argument_list|(
name|t
operator|->
name|file
argument_list|,
name|TIOCFLUSH
argument_list|,
operator|(
expr|struct
name|sgttyb
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
comment|/* the data consists of a binary window ID */
name|t
operator|->
name|w
operator|=
operator|*
operator|(
name|Window
operator|*
operator|)
name|inputBuffer
expr_stmt|;
block|}
return|return
literal|1
return|;
undef|#
directive|undef
name|BUFSIZE
block|}
end_block

begin_function
name|int
name|GetPty
parameter_list|(
name|name
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|register
name|int
name|devindex
decl_stmt|,
name|letter
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|strcpy
argument_list|(
name|name
argument_list|,
literal|"/dev/ptyp0"
argument_list|)
expr_stmt|;
for|for
control|(
name|letter
operator|=
literal|0
init|;
name|letter
operator|<
literal|4
condition|;
name|letter
operator|++
control|)
block|{
name|name
index|[
literal|8
index|]
operator|=
literal|"pqrs"
index|[
name|letter
index|]
expr_stmt|;
for|for
control|(
name|devindex
operator|=
literal|0
init|;
name|devindex
operator|<
literal|16
condition|;
name|devindex
operator|++
control|)
block|{
name|name
index|[
literal|9
index|]
operator|=
literal|"0123456789abcdef"
index|[
name|devindex
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|name
argument_list|,
name|O_RDWR
argument_list|)
operator|)
operator|>=
literal|0
condition|)
return|return
name|fd
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_macro
name|DestroyTTYWindow
argument_list|(
argument|t
argument_list|)
end_macro

begin_decl_stmt
name|TTYWindow
modifier|*
name|t
decl_stmt|;
end_decl_stmt

begin_block
block|{
comment|/* close the tty; this should cause the xterm to terminate with an I/O error */
name|close
argument_list|(
name|t
operator|->
name|file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|t
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TTYPutString
argument_list|(
argument|t
argument_list|,
argument|str
argument_list|)
end_macro

begin_decl_stmt
name|TTYWindow
modifier|*
name|t
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|write
argument_list|(
name|t
operator|->
name|file
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TTYPutChar
argument_list|(
argument|t
argument_list|,
argument|ch
argument_list|)
end_macro

begin_decl_stmt
name|TTYWindow
modifier|*
name|t
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|ch
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|write
argument_list|(
name|t
operator|->
name|file
argument_list|,
operator|&
name|ch
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|TTYPrintf
argument_list|(
argument|t
argument_list|,
argument|format
argument_list|,
argument|args
argument_list|)
end_macro

begin_decl_stmt
name|TTYWindow
modifier|*
name|t
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|format
decl_stmt|;
end_decl_stmt

begin_block
block|{
define|#
directive|define
name|TTY_BUFSIZE
value|2048
name|char
name|buffer
index|[
name|TTY_BUFSIZE
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|_iobuf
name|_strbuf
decl_stmt|;
name|_strbuf
operator|.
name|_flag
operator|=
name|_IOWRT
operator|+
name|_IOSTRG
expr_stmt|;
name|_strbuf
operator|.
name|_ptr
operator|=
name|buffer
expr_stmt|;
name|_strbuf
operator|.
name|_cnt
operator|=
name|TTY_BUFSIZE
expr_stmt|;
name|_doprnt
argument_list|(
name|format
argument_list|,
operator|&
name|args
argument_list|,
operator|&
name|_strbuf
argument_list|)
expr_stmt|;
name|_strbuf
operator|.
name|_cnt
operator|++
expr_stmt|;
comment|/* Be sure there's room for the \0 */
name|putc
argument_list|(
literal|'\0'
argument_list|,
operator|&
name|_strbuf
argument_list|)
expr_stmt|;
name|TTYPutString
argument_list|(
name|t
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|TTY_BUFSIZE
block|}
end_block

begin_expr_stmt
specifier|static
name|initial_stdout
operator|=
operator|-
literal|1
expr_stmt|;
end_expr_stmt

begin_macro
name|SetStdout
argument_list|(
argument|t
argument_list|)
end_macro

begin_decl_stmt
name|TTYWindow
modifier|*
name|t
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|initial_stdout
operator|==
operator|-
literal|1
condition|)
name|initial_stdout
operator|=
name|stdout
operator|->
name|_file
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|stdout
operator|->
name|_file
operator|=
name|t
operator|->
name|file
expr_stmt|;
block|}
end_block

begin_macro
name|ResetStdout
argument_list|()
end_macro

begin_block
block|{
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|stdout
operator|->
name|_file
operator|=
name|initial_stdout
expr_stmt|;
name|initial_stdout
operator|=
operator|-
literal|1
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|CMASK
value|0377
end_define

begin_function
name|int
name|TTYGetChar
parameter_list|(
name|t
parameter_list|)
name|TTYWindow
modifier|*
name|t
decl_stmt|;
block|{
name|char
name|c
decl_stmt|;
if|if
condition|(
name|read
argument_list|(
name|t
operator|->
name|file
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
operator|>
literal|0
condition|)
return|return
operator|(
name|c
operator|&
name|CMASK
operator|)
return|;
else|else
return|return
operator|(
name|EOF
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|TTYGetString
parameter_list|(
name|t
parameter_list|,
name|str
parameter_list|,
name|n
parameter_list|)
specifier|register
name|TTYWindow
modifier|*
name|t
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|cs
decl_stmt|;
name|cs
operator|=
name|str
expr_stmt|;
while|while
condition|(
operator|--
name|n
operator|>
literal|0
operator|&&
name|read
argument_list|(
name|t
operator|->
name|file
argument_list|,
name|cs
argument_list|,
literal|1
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|cs
operator|++
operator|==
literal|'\n'
condition|)
break|break;
block|}
if|if
condition|(
name|cs
operator|==
name|str
condition|)
return|return
name|NULL
return|;
operator|*
name|cs
operator|=
literal|'\0'
expr_stmt|;
return|return
name|str
return|;
block|}
end_function

end_unit


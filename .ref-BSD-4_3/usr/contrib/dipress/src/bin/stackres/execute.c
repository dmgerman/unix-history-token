begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* execute.c  *  * Copyright (c) 1984, 1985 Xerox Corp.  *  *  Define the functions used in parse.c.  *  * Execute the RES file and leave the correct parameters on the stack.  *  */
end_comment

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<iptokens.h>
end_include

begin_include
include|#
directive|include
file|"stack.h"
end_include

begin_define
define|#
directive|define
name|RES_header
value|"Interpress/Xerox/2.1/RasterEncoding/1.0 "
end_define

begin_define
define|#
directive|define
name|len_RES_header
value|40
end_define

begin_define
define|#
directive|define
name|err0
value|"(%d) execute: Bad RES header, got %s\n"
end_define

begin_define
define|#
directive|define
name|err1
value|"(%d) execute: roll moveFirst> depth, %d> %d!\n"
end_define

begin_define
define|#
directive|define
name|err2
value|"(%d) execute: unknown operator subtype, got %d!\n"
end_define

begin_define
define|#
directive|define
name|err3
value|"(%d) execute: unknown operator, type=%d!\n"
end_define

begin_define
define|#
directive|define
name|err4
value|"(%d) execute: unknown sequence, type=%d, length=%d!\n"
end_define

begin_define
define|#
directive|define
name|err5
value|"(%d) execute: sequenceInsertFile not implemented!\n"
end_define

begin_comment
comment|/* Defined elsewhere. */
end_comment

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|long
name|filepos
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|FILE
modifier|*
name|fp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Defined in this module. */
end_comment

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
name|decompressID
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
name|decompressOP
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
name|imagedata
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|unsigned
name|char
modifier|*
name|popidentifier
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|double
name|popdouble
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*  * Public procedures defined for "parse" module.  *  */
end_comment

begin_macro
name|header
argument_list|(
argument|string
argument_list|,
argument|resheader
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
name|RES_header
argument_list|)
operator|!=
literal|0
condition|)
name|error
argument_list|(
name|err0
argument_list|,
name|filepos
argument_list|,
name|string
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_makevec
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|,
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|depth
operator|=
name|popint
argument_list|()
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
operator|(
name|depth
operator|+
literal|1
operator|)
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
comment|/* null terminated array */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|array
index|[
name|depth
operator|-
name|n
operator|-
literal|1
index|]
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|array
index|[
name|depth
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|free
argument_list|(
name|array
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_pop
argument_list|()
end_macro

begin_block
block|{
name|free
argument_list|(
name|pop
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_copy
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|,
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|temp1
decl_stmt|,
modifier|*
modifier|*
name|temp2
decl_stmt|;
name|depth
operator|=
name|popint
argument_list|()
expr_stmt|;
name|temp1
operator|=
name|malloc
argument_list|(
name|depth
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|temp2
operator|=
name|malloc
argument_list|(
name|depth
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|temp1
index|[
name|depth
operator|-
name|n
operator|-
literal|1
index|]
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|temp2
index|[
name|n
index|]
operator|=
name|duplicate
argument_list|(
name|temp1
index|[
name|n
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|push
argument_list|(
name|temp1
index|[
name|n
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|push
argument_list|(
name|temp2
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_dup
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|newptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|newptr
operator|=
name|duplicate
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_roll
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|,
name|depth
decl_stmt|,
name|moveFirst
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|temp
decl_stmt|;
name|moveFirst
operator|=
name|popint
argument_list|()
expr_stmt|;
name|depth
operator|=
name|popint
argument_list|()
expr_stmt|;
if|if
condition|(
name|moveFirst
operator|>
name|depth
condition|)
name|error
argument_list|(
name|err1
argument_list|,
name|filepos
argument_list|,
name|moveFirst
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|temp
operator|=
name|malloc
argument_list|(
name|depth
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|temp
index|[
name|depth
operator|-
name|n
operator|-
literal|1
index|]
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|moveFirst
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|push
argument_list|(
name|temp
index|[
name|n
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|moveFirst
condition|;
name|n
operator|++
control|)
name|push
argument_list|(
name|temp
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|temp
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_exch
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|temp1
decl_stmt|,
modifier|*
name|temp2
decl_stmt|;
name|temp1
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|temp2
operator|=
name|pop
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|temp1
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|temp2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_nop
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_translate
argument_list|()
end_macro

begin_block
block|{
name|double
name|x
decl_stmt|,
name|y
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|y
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|x
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
literal|1.0
argument_list|,
literal|0.0
argument_list|,
name|x
argument_list|,
literal|0.0
argument_list|,
literal|1.0
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_rotate
argument_list|()
end_macro

begin_block
block|{
name|double
name|angle
decl_stmt|,
name|cosA
decl_stmt|,
name|sinA
decl_stmt|,
name|pi
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|angle
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|angle
operator|=
literal|3.1415926
operator|*
name|angle
operator|/
literal|180.
expr_stmt|;
name|cosA
operator|=
name|cos
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|sinA
operator|=
name|sin
argument_list|(
name|angle
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|cosA
argument_list|,
operator|-
name|sinA
argument_list|,
literal|0.0
argument_list|,
name|sinA
argument_list|,
name|cosA
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_scale
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|double
name|s
decl_stmt|;
name|s
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|s
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|s
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_scale2
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|double
name|sx
decl_stmt|,
name|sy
decl_stmt|;
name|sy
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|sx
operator|=
name|popdouble
argument_list|()
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|sx
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
literal|0.0
argument_list|,
name|sy
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_concat
argument_list|()
end_macro

begin_block
block|{
name|double
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|nptr
decl_stmt|,
modifier|*
name|mptr
decl_stmt|;
name|double
modifier|*
name|m
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|nptr
operator|=
name|pop
argument_list|(
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mptr
operator|=
name|pop
argument_list|(
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|n
operator|=
name|gettransformation
argument_list|(
name|nptr
argument_list|)
expr_stmt|;
name|m
operator|=
name|gettransformation
argument_list|(
name|mptr
argument_list|)
expr_stmt|;
name|a
operator|=
name|m
index|[
literal|0
index|]
operator|*
name|n
index|[
literal|0
index|]
operator|+
name|m
index|[
literal|3
index|]
operator|*
name|n
index|[
literal|1
index|]
expr_stmt|;
name|b
operator|=
name|m
index|[
literal|1
index|]
operator|*
name|n
index|[
literal|0
index|]
operator|+
name|m
index|[
literal|4
index|]
operator|*
name|n
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|=
name|m
index|[
literal|2
index|]
operator|*
name|n
index|[
literal|0
index|]
operator|+
name|m
index|[
literal|5
index|]
operator|*
name|n
index|[
literal|1
index|]
operator|+
name|n
index|[
literal|2
index|]
expr_stmt|;
name|d
operator|=
name|m
index|[
literal|0
index|]
operator|*
name|n
index|[
literal|3
index|]
operator|+
name|m
index|[
literal|3
index|]
operator|*
name|n
index|[
literal|4
index|]
expr_stmt|;
name|e
operator|=
name|m
index|[
literal|1
index|]
operator|*
name|n
index|[
literal|3
index|]
operator|+
name|m
index|[
literal|4
index|]
operator|*
name|n
index|[
literal|4
index|]
expr_stmt|;
name|f
operator|=
name|m
index|[
literal|2
index|]
operator|*
name|n
index|[
literal|3
index|]
operator|+
name|m
index|[
literal|5
index|]
operator|*
name|n
index|[
literal|4
index|]
operator|+
name|n
index|[
literal|5
index|]
expr_stmt|;
name|ptr
operator|=
name|maketransformation
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|nptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_makepixelarray
argument_list|()
end_macro

begin_block
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|9
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|6
index|]
operator|=
name|pop
argument_list|(
name|type_vector
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* samples */
name|array
index|[
literal|5
index|]
operator|=
name|pop
argument_list|(
name|type_transformation
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* m */
name|array
index|[
literal|4
index|]
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* samplesInterleaved */
name|array
index|[
literal|3
index|]
operator|=
name|pop
argument_list|(
name|type_number
operator||
name|type_vector
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* maxSampleValue */
name|array
index|[
literal|2
index|]
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* samplesPerPixel */
name|array
index|[
literal|1
index|]
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* yPixels */
name|array
index|[
literal|0
index|]
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* xPixels */
name|array
index|[
literal|7
index|]
operator|=
name|makeselect
argument_list|(
name|getint
argument_list|(
name|array
index|[
literal|2
index|]
argument_list|)
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
comment|/* select == all samples */
name|array
index|[
literal|8
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
comment|/* null terminated list */
name|ptr
operator|=
name|makepixelarray
argument_list|(
name|array
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
literal|9
condition|;
name|n
operator|++
control|)
name|free
argument_list|(
name|array
index|[
name|n
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_extractpixelarray
argument_list|()
end_macro

begin_block
block|{
name|int
name|depth
decl_stmt|;
name|unsigned
name|char
modifier|*
name|oldptr
decl_stmt|,
modifier|*
name|newptr
decl_stmt|,
modifier|*
name|select
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|select
operator|=
name|pop
argument_list|(
name|type_vector
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|oldptr
operator|=
name|pop
argument_list|(
name|type_pixelarray
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|array
operator|=
name|getpixelarray
argument_list|(
name|oldptr
argument_list|)
expr_stmt|;
name|array
index|[
literal|7
index|]
operator|=
name|select
expr_stmt|;
name|newptr
operator|=
name|makepixelarray
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|select
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|oldptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_do
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|int
name|type
decl_stmt|,
name|subtype
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|3
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|pop
argument_list|(
name|type_operator
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* operator to do */
name|array
index|[
literal|1
index|]
operator|=
name|pop
argument_list|(
name|type_vector
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* vector argument */
name|array
index|[
literal|2
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
switch|switch
condition|(
name|getsubtype
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
case|case
name|subtype_decompressop
case|:
name|type
operator|=
name|type_vector
expr_stmt|;
name|subtype
operator|=
name|subtype_samples
expr_stmt|;
break|break;
case|case
name|subtype_colorop
case|:
name|type
operator|=
name|type_color
expr_stmt|;
name|subtype
operator|=
name|subtype_operator
expr_stmt|;
break|break;
case|case
name|subtype_colormodelop
case|:
name|type
operator|=
name|type_operator
expr_stmt|;
name|subtype
operator|=
name|subtype_colorop
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
name|err2
argument_list|,
name|filepos
argument_list|,
name|getsubtype
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_finddecompressor
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|popidentifier
argument_list|(
literal|"decompressionOps/"
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makeoperator
argument_list|(
name|array
argument_list|,
name|subtype_decompressop
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_makegray
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|pop
argument_list|(
name|type_number
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makecolor
argument_list|(
name|array
argument_list|,
name|subtype_value
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_findcolor
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|popidentifier
argument_list|(
literal|"colors/"
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makecolor
argument_list|(
name|array
argument_list|,
name|subtype_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_findcoloroperator
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|popidentifier
argument_list|(
literal|"colorOps/"
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makeoperator
argument_list|(
name|array
argument_list|,
name|subtype_colorop
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_findcolormodeloperator
argument_list|()
end_macro

begin_block
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|popidentifier
argument_list|(
literal|"colorModelOps/"
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makeoperator
argument_list|(
name|array
argument_list|,
name|subtype_colormodelop
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|op_beginblock
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_endblock
argument_list|()
end_macro

begin_block
block|{   }
end_block

begin_macro
name|op_unknown
argument_list|(
argument|op
argument_list|)
end_macro

begin_decl_stmt
name|int
name|op
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|error
argument_list|(
name|err3
argument_list|,
name|filepos
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_comment
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|fseek
argument_list|(
name|fp
argument_list|,
operator|(
name|long
operator|)
name|nbytes
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_continued
argument_list|(
argument|nbytes
argument_list|,
argument|last
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|,
name|last
decl_stmt|;
end_decl_stmt

begin_block
block|{
switch|switch
condition|(
name|last
condition|)
block|{
case|case
name|sequenceAdaptivePixelVector
case|:
case|case
name|sequenceCompressedPixelVector
case|:
case|case
name|sequencePackedPixelVector
case|:
case|case
name|sequenceLargeVector
case|:
name|extendpixel
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
break|break;
case|case
name|sequenceComment
case|:
name|fseek
argument_list|(
name|fp
argument_list|,
operator|(
name|long
operator|)
name|nbytes
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|sequenceInteger
case|:
case|case
name|sequenceRational
case|:
name|extendnumber
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
break|break;
case|case
name|sequenceString
case|:
case|case
name|sequenceIdentifier
case|:
name|extendstring
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
argument_list|(
name|err4
argument_list|,
name|filepos
argument_list|,
name|last
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|seq_insertfile
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|error
argument_list|(
name|err5
argument_list|,
name|filepos
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_largevector
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|b
decl_stmt|;
name|long
name|bytepos
decl_stmt|,
name|bytelength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|b
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
comment|/* read the number of bytes/integer. */
name|bytepos
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|bytelength
operator|=
name|nbytes
operator|-
literal|1
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|makeintegers
argument_list|(
name|b
argument_list|,
name|bytepos
argument_list|,
name|bytelength
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_integers
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|bytelength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_adaptivepixel
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushpixel
argument_list|(
name|nbytes
argument_list|,
literal|"adaptive"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_compressedpixel
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushpixel
argument_list|(
name|nbytes
argument_list|,
literal|"compressed"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_packedpixel
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushpixel
argument_list|(
name|nbytes
argument_list|,
literal|"packed"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_identifier
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushstring
argument_list|(
name|nbytes
argument_list|,
name|subtype_identifier
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_string
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushstring
argument_list|(
name|nbytes
argument_list|,
name|subtype_string
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_unknown
argument_list|(
argument|type
argument_list|,
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|type
decl_stmt|,
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|error
argument_list|(
name|err4
argument_list|,
name|filepos
argument_list|,
name|type
argument_list|,
name|nbytes
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_integer
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushinteger
argument_list|(
name|nbytes
argument_list|,
name|subtype_integer
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|seq_rational
argument_list|(
argument|nbytes
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nbytes
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|pushinteger
argument_list|(
name|nbytes
argument_list|,
name|subtype_rational
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|shortnum
argument_list|(
argument|number
argument_list|)
end_macro

begin_decl_stmt
name|int
name|number
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|unsigned
name|char
name|value
index|[
literal|2
index|]
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|value
index|[
literal|0
index|]
operator|=
operator|(
name|number
operator|>>
literal|8
operator|)
operator|&
literal|0377
expr_stmt|;
name|value
index|[
literal|1
index|]
operator|=
name|number
operator|&
literal|0377
expr_stmt|;
name|ptr
operator|=
name|makenumber
argument_list|(
literal|2
argument_list|,
name|value
argument_list|,
name|subtype_integer
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Private procedures to this module.  *  */
end_comment

begin_expr_stmt
specifier|static
name|pushinteger
argument_list|(
argument|nbytes
argument_list|,
argument|subtype
argument_list|)
name|int
name|nbytes
operator|,
name|subtype
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|unsigned
name|char
modifier|*
name|array
decl_stmt|;
name|array
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|array
index|[
name|n
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|ptr
operator|=
name|makenumber
argument_list|(
name|nbytes
argument_list|,
name|array
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pushstring
argument_list|(
argument|nbytes
argument_list|,
argument|subtype
argument_list|)
name|int
name|nbytes
operator|,
name|subtype
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|;
name|string
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|nbytes
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|string
index|[
name|n
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|string
index|[
name|nbytes
index|]
operator|=
operator|(
name|char
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makestring
argument_list|(
name|string
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|string
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|pushpixel
argument_list|(
argument|nbytes
argument_list|,
argument|compression
argument_list|)
name|int
name|nbytes
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|compression
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|unsigned
name|char
modifier|*
name|decompressID
parameter_list|()
function_decl|;
specifier|extern
name|unsigned
name|char
modifier|*
name|decompressOP
parameter_list|()
function_decl|;
specifier|extern
name|unsigned
name|char
modifier|*
name|imagedata
parameter_list|()
function_decl|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|idvec
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|idvec
operator|=
name|decompressID
argument_list|(
name|compression
argument_list|)
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|3
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|decompressOP
argument_list|(
name|idvec
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
name|imagedata
argument_list|(
name|nbytes
argument_list|)
expr_stmt|;
name|array
index|[
literal|2
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_samples
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|idvec
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|decompressID
parameter_list|(
name|compression
parameter_list|)
name|char
modifier|*
name|compression
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|3
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|makestring
argument_list|(
literal|"xerox"
argument_list|,
name|subtype_identifier
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
name|makestring
argument_list|(
name|compression
argument_list|,
name|subtype_identifier
argument_list|)
expr_stmt|;
name|array
index|[
literal|2
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|decompressOP
parameter_list|(
name|idvec
parameter_list|)
name|unsigned
name|char
modifier|*
name|idvec
decl_stmt|;
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|makeidentifier
argument_list|(
name|idvec
argument_list|,
literal|"decompressionOps/"
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makeoperator
argument_list|(
name|array
argument_list|,
name|subtype_decompressop
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|imagedata
parameter_list|(
name|nbytes
parameter_list|)
name|int
name|nbytes
decl_stmt|;
block|{
name|long
name|bytepos
decl_stmt|,
name|bytelength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|array
decl_stmt|;
name|bytepos
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|bytelength
operator|=
name|nbytes
expr_stmt|;
name|array
operator|=
name|malloc
argument_list|(
literal|2
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
name|array
index|[
literal|0
index|]
operator|=
name|makeintegers
argument_list|(
literal|2
argument_list|,
name|bytepos
argument_list|,
name|bytelength
argument_list|)
expr_stmt|;
name|array
index|[
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|ptr
operator|=
name|makevector
argument_list|(
name|array
argument_list|,
name|type_vector
argument_list|,
name|subtype_integers
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|bytelength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|array
argument_list|)
expr_stmt|;
return|return
operator|(
name|ptr
operator|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|popint
argument_list|()
block|{
name|int
name|result
block|;
name|unsigned
name|char
operator|*
name|ptr
block|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
block|;
name|result
operator|=
name|getint
argument_list|(
name|ptr
argument_list|)
block|;
name|free
argument_list|(
name|ptr
argument_list|)
block|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_expr_stmt

begin_function
specifier|static
name|double
name|popdouble
parameter_list|()
block|{
name|double
name|result
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
name|getdouble
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|popidentifier
parameter_list|(
name|prefix
parameter_list|)
name|char
modifier|*
name|prefix
decl_stmt|;
comment|/* should end with '/' character */
block|{
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|composite
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_vector
argument_list|,
name|subtype_general
argument_list|)
expr_stmt|;
name|composite
operator|=
name|makeidentifier
argument_list|(
name|ptr
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
return|return
operator|(
name|composite
operator|)
return|;
block|}
end_function

begin_expr_stmt
specifier|static
name|extendpixel
argument_list|(
argument|nbytes
argument_list|)
name|int
name|nbytes
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|,
name|depth
decl_stmt|;
name|long
name|bytepos
decl_stmt|,
name|bytelength
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
modifier|*
name|samplesarray
decl_stmt|,
modifier|*
modifier|*
name|integersarray
decl_stmt|;
name|unsigned
name|char
modifier|*
name|newptr
decl_stmt|,
modifier|*
modifier|*
name|newarray
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_vector
argument_list|,
name|subtype_samples
argument_list|)
expr_stmt|;
name|samplesarray
operator|=
name|getvector
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|depth
operator|=
name|getdepth
argument_list|(
name|samplesarray
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|integersarray
operator|=
name|getvector
argument_list|(
name|samplesarray
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|newarray
operator|=
name|malloc
argument_list|(
operator|(
name|depth
operator|+
literal|2
operator|)
operator|*
expr|sizeof
operator|(
name|unsigned
name|char
operator|*
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|depth
condition|;
name|n
operator|++
control|)
name|newarray
index|[
name|n
index|]
operator|=
name|integersarray
index|[
name|n
index|]
expr_stmt|;
name|bytepos
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
name|bytelength
operator|=
name|nbytes
expr_stmt|;
name|newarray
index|[
name|depth
index|]
operator|=
name|makeintegers
argument_list|(
literal|2
argument_list|,
name|bytepos
argument_list|,
name|bytelength
argument_list|)
expr_stmt|;
name|newarray
index|[
name|depth
operator|+
literal|1
index|]
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0
expr_stmt|;
name|samplesarray
index|[
literal|1
index|]
operator|=
name|makevector
argument_list|(
name|newarray
argument_list|,
name|type_vector
argument_list|,
name|subtype_integers
argument_list|)
expr_stmt|;
name|newptr
operator|=
name|makevector
argument_list|(
name|samplesarray
argument_list|,
name|type_vector
argument_list|,
name|subtype_samples
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|fp
argument_list|,
name|bytelength
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newarray
index|[
name|depth
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samplesarray
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|samplesarray
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|integersarray
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newarray
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|extendnumber
argument_list|(
argument|nbytes
argument_list|)
name|int
name|nbytes
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|,
name|len
decl_stmt|;
name|unsigned
name|char
modifier|*
name|number
decl_stmt|,
modifier|*
name|newnumber
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|newptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_number
argument_list|,
name|subtype_integer
operator||
name|subtype_rational
argument_list|)
expr_stmt|;
name|number
operator|=
name|getnumber
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|len
operator|=
name|getnumlen
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|newnumber
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
name|nbytes
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|len
condition|;
name|n
operator|++
control|)
name|newnumber
index|[
name|n
index|]
operator|=
name|number
index|[
name|n
index|]
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|newnumber
index|[
name|n
operator|+
name|len
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|newptr
operator|=
name|makenumber
argument_list|(
name|len
operator|+
name|nbytes
argument_list|,
name|newnumber
argument_list|,
name|getsubtype
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newnumber
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|extendstring
argument_list|(
argument|nbytes
argument_list|)
name|int
name|nbytes
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|n
decl_stmt|,
name|len
decl_stmt|;
name|char
modifier|*
name|string
decl_stmt|,
modifier|*
name|newstring
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|newptr
decl_stmt|;
name|ptr
operator|=
name|pop
argument_list|(
name|type_string
argument_list|,
name|subtype_identifier
operator||
name|subtype_string
argument_list|)
expr_stmt|;
name|string
operator|=
name|getstring
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|string
argument_list|)
expr_stmt|;
name|newstring
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|len
operator|+
name|nbytes
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|newstring
argument_list|,
name|string
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|nbytes
condition|;
name|n
operator|++
control|)
name|newstring
index|[
name|n
operator|+
name|len
index|]
operator|=
name|getc
argument_list|(
name|fp
argument_list|)
operator|&
literal|0377
expr_stmt|;
name|newstring
index|[
name|len
operator|+
name|nbytes
index|]
operator|=
operator|(
name|char
operator|)
literal|0
expr_stmt|;
name|newptr
operator|=
name|makestring
argument_list|(
name|newstring
argument_list|,
name|getsubtype
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|newstring
argument_list|)
expr_stmt|;
name|push
argument_list|(
name|newptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Change Log  *  * K. Knox,  1-Apr-85 23:45:46, Created first version.  * K. Knox, 13-May-85 10:25:25, Fixed bugs in calls to maketransformation.  * K. Knox, 13-May-85 10:25:25, Fixed bug in angle calculation in op_rotate.  *  *  *  */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************  *  *	parser --	parses device independent troff commands and calls  *			appropriate action routines  *  *	John Mellor-Crummey (Xerox Corp)  *  *	Copyright 1985 Xerox Corporation  *  ******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"deviceinfo.h"
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* constant and macro definitions */
end_comment

begin_include
include|#
directive|include
file|"externs.h"
end_include

begin_comment
comment|/* declarations for global variables */
end_comment

begin_comment
comment|/*-----------------------------------------------------------------------------  * ditroffToIpress --	parses the input file calling routines to perform  *			requested operations  *---------------------------------------------------------------------------*/
end_comment

begin_expr_stmt
name|ditroffToIpress
argument_list|(
name|fptr
argument_list|)
specifier|register
name|FILE
operator|*
name|fptr
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|char
name|buffer
index|[
name|BUFFERSIZE
index|]
decl_stmt|;
name|int
name|c1
decl_stmt|,
name|c2
decl_stmt|;
name|int
name|cmd
decl_stmt|;
name|int
name|flag
init|=
literal|1
decl_stmt|;
while|while
condition|(
operator|(
name|cmd
operator|=
name|getc
argument_list|(
name|fptr
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|cmdPointSize
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|setPointSize
argument_list|(
name|internalSize
argument_list|(
name|c1
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdFont
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|setFont
argument_list|(
name|fontNumber
argument_list|(
name|c1
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdChar
case|:
if|if
condition|(
name|flag
operator|=
operator|(
operator|(
name|cmd
operator|=
name|getc
argument_list|(
name|fptr
argument_list|)
operator|)
operator|!=
name|EOF
operator|)
condition|)
name|outputChar
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|cmd
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdSpecChar
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|buffer
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|outputString
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdAbsHoriz
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|hMov
argument_list|(
name|c1
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdRelHoriz
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|hInc
argument_list|(
name|c1
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdAbsVert
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|vMov
argument_list|(
name|c1
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdRelVert
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|vInc
argument_list|(
name|c1
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdEol
case|:
comment|/* ignore arguments, call routine for newline */
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|c1
argument_list|,
operator|&
name|c2
argument_list|)
operator|==
literal|2
operator|)
expr_stmt|;
name|newLine
argument_list|()
expr_stmt|;
break|break;
case|case
name|cmdWordSep
case|:
break|break;
case|case
name|cmdNewPage
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|newpage
argument_list|(
name|c1
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdPushEnv
case|:
name|pushCurrentEnv
argument_list|()
expr_stmt|;
break|break;
case|case
name|cmdPopEnv
case|:
name|popSavedEnv
argument_list|()
expr_stmt|;
break|break;
case|case
name|cmdCharString
case|:
operator|(
name|void
operator|)
name|fgets
argument_list|(
name|buffer
argument_list|,
name|BUFFERSIZE
argument_list|,
name|fptr
argument_list|)
expr_stmt|;
comment|/* no op -- this command causes no conversion 			 * not expected in ditroff output 			 */
break|break;
case|case
name|cmdComment
case|:
name|skipToNextLine
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdDraw
case|:
name|drawCommand
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
name|skipToNextLine
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
break|break;
case|case
name|cmdDevice
case|:
name|deviceCommand
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
name|skipToNextLine
argument_list|(
name|fptr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'\n'
case|:
name|linenumber
operator|++
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|isdigit
argument_list|(
name|cmd
argument_list|)
condition|)
block|{
comment|/* command is 2 digit horizontal displacement 				 * followed by a char 				 */
if|if
condition|(
name|flag
operator|=
operator|(
operator|(
name|c1
operator|=
name|getc
argument_list|(
name|fptr
argument_list|)
operator|)
operator|!=
name|EOF
operator|)
condition|)
block|{
name|hInc
argument_list|(
name|c1
operator|-
literal|'0'
operator|+
literal|10
operator|*
operator|(
name|cmd
operator|-
literal|'0'
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
operator|=
operator|(
operator|(
name|c1
operator|=
name|getc
argument_list|(
name|fptr
argument_list|)
operator|)
operator|!=
name|EOF
operator|)
condition|)
name|outputChar
argument_list|(
operator|(
name|unsigned
name|int
operator|)
name|c1
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
elseif|else
if|if
condition|(
name|white
argument_list|(
name|cmd
argument_list|)
operator|||
operator|(
name|cmd
operator|==
literal|'\0'
operator|)
condition|)
break|break;
comment|/* handle trash in stream */
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"unrecognized character in input %o %c"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|cmd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|cmd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|flag
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"error in input for ditroff command %c"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|cmd
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  *	drawCommand --	process ditroff draw commands  *---------------------------------------------------------------------------*/
end_comment

begin_expr_stmt
name|drawCommand
argument_list|(
name|fptr
argument_list|)
specifier|register
name|FILE
operator|*
name|fptr
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|c1
decl_stmt|,
name|c2
decl_stmt|,
name|c3
decl_stmt|,
name|c4
decl_stmt|;
name|int
name|cmd
decl_stmt|,
name|flag
decl_stmt|;
name|char
name|buffer
index|[
name|BUFFERSIZE
index|]
decl_stmt|;
if|if
condition|(
name|flag
operator|=
operator|(
operator|(
name|cmd
operator|=
name|getc
argument_list|(
name|fptr
argument_list|)
operator|)
operator|!=
name|EOF
operator|)
condition|)
block|{
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|drawLine
case|:
comment|/* draw from current x,y to c1,c2 */
comment|/* read termination point */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|c1
argument_list|,
operator|&
name|c2
argument_list|)
operator|==
literal|2
operator|)
condition|)
name|drawline
argument_list|(
name|c1
argument_list|,
name|c2
argument_list|)
expr_stmt|;
break|break;
case|case
name|drawCircle
case|:
comment|/* draw circle of diameter c1 with current x,y */
comment|/* leftmost position on circle */
comment|/* read circle diameter */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
block|{
name|c2
operator|=
operator|(
name|c1
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|outputflag
condition|)
comment|/* won't be printed anyway */
break|break;
name|gobj_size
argument_list|(
name|hor_pos
argument_list|,
name|ver_pos
operator|-
name|c2
argument_list|,
name|hor_pos
operator|+
name|c1
argument_list|,
name|ver_pos
operator|+
name|c2
argument_list|)
expr_stmt|;
name|bitmapDrawCircle
argument_list|(
name|c1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|drawEllipse
case|:
comment|/* draw ellipse with axes c1,c2 with current x,y */
comment|/* leftmost point on ellipse */
comment|/* read height and width */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d %d"
argument_list|,
operator|&
name|c1
argument_list|,
operator|&
name|c2
argument_list|)
operator|==
literal|2
operator|)
condition|)
block|{
name|c3
operator|=
operator|(
name|c2
operator|+
literal|1
operator|)
operator|/
literal|2
expr_stmt|;
if|if
condition|(
operator|!
name|outputflag
condition|)
comment|/* won't be printed anyway */
break|break;
name|gobj_size
argument_list|(
name|hor_pos
argument_list|,
name|ver_pos
operator|-
name|c3
argument_list|,
name|hor_pos
operator|+
name|c1
argument_list|,
name|ver_pos
operator|+
name|c3
argument_list|)
expr_stmt|;
name|bitmapDrawEllipse
argument_list|(
name|c1
argument_list|,
name|c2
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|drawArc
case|:
comment|/* draw counter-clockwise arc with current x,y */
comment|/* as start, c1,c2 represent relative x,y */
comment|/* offset to center, c3,c4 represent relative */
comment|/* x,y offset from center to ending point on arc */
comment|/* read relative coords to current point: xc yc xt yt */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d %d %d %d"
argument_list|,
operator|&
name|c1
argument_list|,
operator|&
name|c2
argument_list|,
operator|&
name|c3
argument_list|,
operator|&
name|c4
argument_list|)
operator|==
literal|4
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|outputflag
condition|)
comment|/* won't be printed anyway */
break|break;
name|g_sizearc
argument_list|(
name|hor_pos
argument_list|,
name|ver_pos
argument_list|,
name|c1
argument_list|,
name|c2
argument_list|,
name|c3
argument_list|,
name|c4
argument_list|)
expr_stmt|;
name|bitmapDrawArc
argument_list|(
name|c1
argument_list|,
name|c2
argument_list|,
name|c3
argument_list|,
name|c4
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|drawWigglyLine
case|:
comment|/* read the rest of the command line  containing a 			 * list of x,y pairs into a buffer  			 */
operator|(
name|void
operator|)
name|fgets
argument_list|(
name|buffer
argument_list|,
name|BUFFERSIZE
argument_list|,
name|fptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|outputflag
condition|)
comment|/* won't be printed anyway */
break|break;
name|g_sizeWigglyLine
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|bitmapDrawWigglyLine
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
break|break;
default|default:
name|flag
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|flag
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"ill formed draw command"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  *	deviceCommand --	process ditroff device commands  *---------------------------------------------------------------------------*/
end_comment

begin_expr_stmt
name|deviceCommand
argument_list|(
name|fptr
argument_list|)
specifier|register
name|FILE
operator|*
name|fptr
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|flag
decl_stmt|,
name|n
decl_stmt|;
name|int
name|c1
decl_stmt|;
name|char
name|st
index|[
literal|20
index|]
decl_stmt|;
name|char
name|buffer
index|[
literal|80
index|]
decl_stmt|;
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|st
argument_list|)
operator|==
literal|1
operator|)
condition|)
block|{
switch|switch
condition|(
operator|*
name|st
condition|)
block|{
case|case
name|deviceInit
case|:
name|initDevice
argument_list|()
expr_stmt|;
name|readDeviceInitInfo
argument_list|()
expr_stmt|;
break|break;
case|case
name|deviceName
case|:
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%s"
argument_list|,
name|devicename
argument_list|)
operator|==
literal|1
operator|)
expr_stmt|;
break|break;
case|case
name|deviceResolution
case|:
comment|/* expect only resolution in spots per inch */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|spotsPerInch
argument_list|)
operator|==
literal|1
operator|)
condition|)
name|setScale
argument_list|(
name|spotsPerInch
argument_list|)
expr_stmt|;
break|break;
case|case
name|devicePause
case|:
comment|/* ignore device pauses */
break|break;
case|case
name|deviceStop
case|:
name|resetDevice
argument_list|()
expr_stmt|;
break|break;
case|case
name|deviceTrailer
case|:
comment|/* a no op */
break|break;
case|case
name|deviceFont
case|:
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d %s"
argument_list|,
operator|&
name|n
argument_list|,
name|buffer
argument_list|)
operator|==
literal|2
operator|)
condition|)
name|loadFont
argument_list|(
name|n
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|deviceHeight
case|:
comment|/* a no op */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
break|break;
case|case
name|deviceSlant
case|:
comment|/* a no op */
if|if
condition|(
name|flag
operator|=
operator|(
name|fscanf
argument_list|(
name|fptr
argument_list|,
literal|"%d"
argument_list|,
operator|&
name|c1
argument_list|)
operator|==
literal|1
operator|)
condition|)
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|flag
condition|)
name|reportError
argument_list|(
name|QUIT
argument_list|,
literal|"ill formed device command"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*-----------------------------------------------------------------------------  *	skipToNextLine	--	eat any trailing junk and newline  *---------------------------------------------------------------------------*/
end_comment

begin_macro
name|skipToNextLine
argument_list|(
argument|fptr
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|fptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|n
decl_stmt|;
while|while
condition|(
operator|(
name|n
operator|=
name|getc
argument_list|(
name|fptr
argument_list|)
operator|)
operator|!=
literal|'\n'
condition|)
if|if
condition|(
name|n
operator|==
name|EOF
condition|)
return|return;
name|linenumber
operator|++
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|SERVER
end_define

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"../common/response_codes.h"
end_include

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
name|ser_line
index|[
literal|256
index|]
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|actfp
decl_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: getactive filename\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|server_init
argument_list|(
name|SERVER_HOST
argument_list|)
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"getactive: Can't get active file from server.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|put_server
argument_list|(
literal|"LIST"
argument_list|)
expr_stmt|;
comment|/* tell server we want the active file */
operator|(
name|void
operator|)
name|get_server
argument_list|(
name|ser_line
argument_list|,
sizeof|sizeof
argument_list|(
name|ser_line
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ser_line
operator|!=
name|CHAR_OK
condition|)
block|{
comment|/* and then see if that's ok */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"getactive: Can't get active file from server.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Server said: %s\n"
argument_list|,
name|ser_line
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|actfp
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
comment|/* and get ready */
while|while
condition|(
name|get_server
argument_list|(
name|ser_line
argument_list|,
sizeof|sizeof
argument_list|(
name|ser_line
argument_list|)
argument_list|)
operator|>=
literal|0
condition|)
block|{
comment|/* while */
if|if
condition|(
name|ser_line
index|[
literal|0
index|]
operator|==
literal|'.'
condition|)
comment|/* there's another line */
break|break;
comment|/* get it and write it to */
if|if
condition|(
name|actfp
operator|!=
name|NULL
condition|)
block|{
comment|/* the temporary active file */
name|fputs
argument_list|(
name|ser_line
argument_list|,
name|actfp
argument_list|)
expr_stmt|;
name|putc
argument_list|(
literal|'\n'
argument_list|,
name|actfp
argument_list|)
expr_stmt|;
block|}
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|actfp
argument_list|)
expr_stmt|;
name|close_server
argument_list|()
expr_stmt|;
block|}
end_function

end_unit


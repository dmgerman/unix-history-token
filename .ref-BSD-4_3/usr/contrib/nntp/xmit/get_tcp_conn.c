begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_include
include|#
directive|include
file|"get_tcp_conn.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ** Take the name of an internet host in ASCII (this may either be its ** official host name or internet number (with or without enclosing ** backets [])), and return the internet address number in 32 bit quantity. ** ** returns FAIL for failure to find the host name in the local database, ** or for a bad internet address spec. */
end_comment

begin_function
name|u_long
name|name_to_address
parameter_list|(
name|host
parameter_list|)
specifier|register
name|char
modifier|*
name|host
decl_stmt|;
block|{
if|if
condition|(
name|host
operator|==
operator|(
name|char
operator|*
operator|)
name|NULL
condition|)
return|return
operator|(
name|FAIL
operator|)
return|;
comment|/* 	** Is this an ASCII internet address? (either of [10.0.0.78] or 	** 10.0.0.78). 	*/
if|if
condition|(
operator|*
name|host
operator|==
literal|'['
operator|||
name|isdigit
argument_list|(
operator|*
name|host
argument_list|)
condition|)
block|{
name|u_long
name|host_address
decl_stmt|;
name|char
name|namebuf
index|[
literal|128
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|cp
init|=
name|namebuf
decl_stmt|;
comment|/* 		** strip brackets [] or anything else we don't want. 		*/
while|while
condition|(
operator|*
name|host
operator|&&
name|cp
operator|<
operator|&
name|namebuf
index|[
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
index|]
condition|)
block|{
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|host
argument_list|)
operator|||
operator|*
name|host
operator|==
literal|'.'
condition|)
operator|*
name|cp
operator|++
operator|=
operator|*
name|host
operator|++
expr_stmt|;
else|else
name|host
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|host_address
operator|=
name|inet_addr
argument_list|(
name|namebuf
argument_list|)
operator|)
operator|==
name|FAIL
condition|)
return|return
operator|(
name|FAIL
operator|)
return|;
comment|/* malformed internet address spec */
return|return
operator|(
name|host_address
operator|)
return|;
block|}
else|else
block|{
name|struct
name|hostent
modifier|*
name|hstp
init|=
name|gethostbyname
argument_list|(
name|host
argument_list|)
decl_stmt|;
if|if
condition|(
name|hstp
operator|==
name|NULL
condition|)
return|return
operator|(
name|FAIL
operator|)
return|;
comment|/* no such host */
return|return
operator|(
operator|*
operator|(
name|u_long
operator|*
operator|)
name|hstp
operator|->
name|h_addr
operator|)
return|;
comment|/* we assume... */
block|}
block|}
end_function

begin_comment
comment|/* ** given a host name (either name or internet address) and service name ** (or port number) (both in ASCII), give us a TCP connection to the ** requested service at the requested host (or give us FAIL). */
end_comment

begin_macro
name|get_tcp_conn
argument_list|(
argument|host
argument_list|,
argument|serv
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|host
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|serv
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|u_short
name|port
decl_stmt|;
name|struct
name|in_addr
name|host_address
decl_stmt|;
if|if
condition|(
operator|(
name|host_address
operator|.
name|s_addr
operator|=
name|name_to_address
argument_list|(
name|host
argument_list|)
operator|)
operator|==
name|FAIL
condition|)
block|{
return|return
operator|(
name|NOHOST
operator|)
return|;
block|}
if|if
condition|(
name|isdigit
argument_list|(
operator|*
name|serv
argument_list|)
condition|)
block|{
name|port
operator|=
name|htons
argument_list|(
call|(
name|u_short
call|)
argument_list|(
name|atoi
argument_list|(
name|serv
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|servent
modifier|*
name|srvp
init|=
name|getservbyname
argument_list|(
name|serv
argument_list|,
literal|"tcp"
argument_list|)
decl_stmt|;
if|if
condition|(
name|srvp
operator|==
name|NULL
condition|)
block|{
return|return
operator|(
name|NOSERVICE
operator|)
return|;
block|}
name|port
operator|=
operator|(
name|u_short
operator|)
name|srvp
operator|->
name|s_port
expr_stmt|;
block|}
return|return
operator|(
name|mkconn
argument_list|(
operator|&
name|host_address
argument_list|,
name|port
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|SOCK_STREAM
argument_list|)
operator|)
return|;
block|}
end_block

begin_comment
comment|/* ** create a socket and connect it to a remote host on the specified ** port by the specified protocol. Return FAIL if something goes ** wrong somewhere. Since these are exclusively system calls, ** errno will have the correct error in it. */
end_comment

begin_macro
name|mkconn
argument_list|(
argument|host_address
argument_list|,
argument|port
argument_list|,
argument|protocol
argument_list|,
argument|proto_type
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|in_addr
modifier|*
name|host_address
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_short
name|port
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|protocol
decl_stmt|,
name|proto_type
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|skt
decl_stmt|;
name|struct
name|sockaddr_in
name|sadr
decl_stmt|;
name|sadr
operator|.
name|sin_family
operator|=
operator|(
name|u_short
operator|)
name|AF_INET
expr_stmt|;
comment|/* Only internet for now */
name|sadr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|host_address
operator|->
name|s_addr
expr_stmt|;
name|sadr
operator|.
name|sin_port
operator|=
operator|(
name|u_short
operator|)
name|port
expr_stmt|;
if|if
condition|(
operator|(
name|skt
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|proto_type
argument_list|,
name|protocol
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
operator|(
name|FAIL
operator|)
return|;
if|if
condition|(
name|connect
argument_list|(
name|skt
argument_list|,
operator|&
name|sadr
argument_list|,
sizeof|sizeof
argument_list|(
name|sadr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|int
name|save
init|=
name|errno
decl_stmt|;
name|close
argument_list|(
name|skt
argument_list|)
expr_stmt|;
name|errno
operator|=
name|save
expr_stmt|;
return|return
operator|(
name|FAIL
operator|)
return|;
block|}
return|return
operator|(
name|skt
operator|)
return|;
block|}
end_block

end_unit


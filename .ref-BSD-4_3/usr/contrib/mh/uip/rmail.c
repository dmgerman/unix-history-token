begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* rmail.c - replacement for /bin/rmail */
end_comment

begin_comment
comment|/* This program has a long, long history.  It started as UCB's rmail, and    was then modified by OBrien@Rand-Unix to run with MMDF.  Then DpK@Brl    re-wrote it, and SmB@Unc hacked it up a bit.  After that    MRose.UCI@Rand-Relay upgraded it to use the nifty MF (mail filtering)    system.  Finally, the latter stripped it down to work with MH.     This program should be used ONLY if you have both "mts mh" and "uucp on"    set in your MH configuration.  */
end_comment

begin_include
include|#
directive|include
file|"../h/mh.h"
end_include

begin_include
include|#
directive|include
file|"../h/addrsbr.h"
end_include

begin_include
include|#
directive|include
file|"../zotnet/mf.h"
end_include

begin_include
include|#
directive|include
file|"../zotnet/tws.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"../zotnet/mts.h"
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_define
define|#
directive|define
name|ADDROK
value|0
end_define

begin_comment
comment|/* okay to use post to deliver message */
end_comment

begin_define
define|#
directive|define
name|UUCP
value|1
end_define

begin_comment
comment|/* okay to use uux to deliver message */
end_comment

begin_define
define|#
directive|define
name|RETURN
value|2
end_define

begin_comment
comment|/* message loses */
end_comment

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
name|int
name|pbroke
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* broken-pipe flag */
end_comment

begin_decl_stmt
name|int
name|rtnflag
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* note was sent back */
end_comment

begin_decl_stmt
name|char
name|date
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* date of origination from uucp header */
end_comment

begin_decl_stmt
name|char
name|from
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* accumulated path of sender */
end_comment

begin_decl_stmt
name|char
name|origsys
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* originating system */
end_comment

begin_decl_stmt
name|char
name|origpath
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* path from us to originating system */
end_comment

begin_decl_stmt
name|char
name|usrfrm
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* the 822 version of from[] */
end_comment

begin_decl_stmt
name|char
name|Mailsys
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* address of the mail agent */
end_comment

begin_decl_stmt
name|char
name|overseer
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* address of the watchdog */
end_comment

begin_decl_stmt
name|char
name|mmdf
index|[
name|BUFSIZ
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* filtered mail file */
end_comment

begin_decl_stmt
name|char
modifier|*
name|rtnmessage
index|[]
init|=
block|{
literal|"	Your message has been intercepted trying to access\n"
block|,
literal|"a restricted access host (e.g. an ARPANET host).  A copy\n"
block|,
literal|"of your message has been sent to the system administrators.\n"
block|,
literal|"The text of your message follows.\n\n"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|rtnbegin
index|[]
init|=
literal|" ---------------- Returned Mail Follows --------------\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|rtnend
index|[]
init|=
literal|"  --------------- End of Returned Mail ---------------\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|oopsmessage
index|[]
init|=
block|{
literal|"\n\n\tThe system administrators (%s) have been informed of\n"
block|,
literal|"the problem, but have not been given a copy of your message.\n\n"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|fromf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* UUCP "From lines */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|msgf
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* message text */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|pipef
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* output for "post" or "uux" */
end_comment

begin_function_decl
name|int
name|pipeser
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|cpyback
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|fromptr
decl_stmt|,
name|fromwhom
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|linebuf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|sys
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|invo_name
operator|=
name|r1bindex
argument_list|(
operator|*
name|argv
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|m_foil
argument_list|(
name|NULLCP
argument_list|)
expr_stmt|;
name|mts_init
argument_list|(
name|invo_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"usage: %s user [user ...]"
argument_list|,
name|invo_name
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|umask
argument_list|(
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setgid
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|setuid
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|Mailsys
argument_list|,
literal|"%s@%s"
argument_list|,
name|Mailer
argument_list|,
name|LocalName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|Overseer
operator|==
name|NULL
condition|)
name|Overseer
operator|=
name|Mailsys
expr_stmt|;
if|if
condition|(
name|index
argument_list|(
name|Overseer
argument_list|,
literal|'@'
argument_list|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|overseer
argument_list|,
literal|"%s@%s"
argument_list|,
name|Overseer
argument_list|,
name|LocalName
argument_list|()
argument_list|)
expr_stmt|;
name|Overseer
operator|=
name|overseer
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|mktemp
argument_list|(
name|Errtmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|freopen
argument_list|(
name|Errtmp
argument_list|,
literal|"w"
argument_list|,
name|stderr
argument_list|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|Errtmp
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dup2
argument_list|(
name|fileno
argument_list|(
name|stderr
argument_list|)
argument_list|,
name|fileno
argument_list|(
name|stdout
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|mktemp
argument_list|(
name|Msgtmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|msgf
operator|=
name|fdopen
argument_list|(
name|creat
argument_list|(
name|Msgtmp
argument_list|,
name|Tmpmode
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|Msgtmp
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|mktemp
argument_list|(
name|Fromtmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fromf
operator|=
name|fdopen
argument_list|(
name|creat
argument_list|(
name|Fromtmp
argument_list|,
name|Tmpmode
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|Fromtmp
argument_list|,
literal|"unable to create"
argument_list|)
expr_stmt|;
comment|/*
comment|*/
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|linebuf
argument_list|,
sizeof|sizeof
name|linebuf
argument_list|,
name|stdin
argument_list|)
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|strncmp
argument_list|(
name|linebuf
argument_list|,
literal|"From "
argument_list|,
literal|5
argument_list|)
operator|&&
name|strncmp
argument_list|(
name|linebuf
argument_list|,
literal|">From "
argument_list|,
literal|6
argument_list|)
condition|)
break|break;
if|if
condition|(
name|linebuf
index|[
literal|0
index|]
operator|!=
literal|'>'
condition|)
name|fputs
argument_list|(
literal|">"
argument_list|,
name|fromf
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|linebuf
argument_list|,
name|fromf
argument_list|)
expr_stmt|;
name|cp
operator|=
name|index
argument_list|(
name|linebuf
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|fromptr
operator|=
operator|++
name|cp
expr_stmt|;
name|cp
operator|=
name|index
argument_list|(
name|cp
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
operator|*
name|cp
operator|++
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|fromwhom
argument_list|,
name|fromptr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|date
argument_list|,
name|cp
argument_list|,
literal|24
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|cp
operator|+
literal|1
argument_list|,
literal|'r'
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|fromwhom
argument_list|,
literal|'!'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|rindex
argument_list|(
name|fromwhom
argument_list|,
literal|'!'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|origsys
argument_list|,
name|p
operator|+
literal|1
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|origsys
argument_list|,
name|fromwhom
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
name|fromwhom
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
literal|"!"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|fromwhom
argument_list|,
name|cp
operator|+
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|sys
argument_list|,
name|SystemName
argument_list|()
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
name|sys
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|origsys
argument_list|,
name|sys
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
literal|"!"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|cp
argument_list|,
literal|"remote from "
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
operator|(
name|void
operator|)
name|sscanf
argument_list|(
name|cp
argument_list|,
literal|"remote from %s"
argument_list|,
name|sys
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
name|sys
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|origsys
argument_list|,
name|sys
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
literal|"!"
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
block|}
if|if
condition|(
name|fromwhom
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
name|adios
argument_list|(
name|NULLCP
argument_list|,
literal|"no from line"
argument_list|)
expr_stmt|;
comment|/*
comment|*/
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|origpath
argument_list|,
name|from
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|from
argument_list|,
name|fromwhom
argument_list|)
expr_stmt|;
name|get_mmdf_addr
argument_list|(
name|from
argument_list|,
name|usrfrm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|usrfrm
argument_list|,
literal|'<'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|usrfrm
argument_list|,
operator|++
name|cp
argument_list|)
expr_stmt|;
comment|/* sigh */
if|if
condition|(
operator|(
name|cp
operator|=
name|rindex
argument_list|(
name|usrfrm
argument_list|,
literal|'>'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|usrfrm
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|usrfrm
argument_list|,
literal|"%s!%s%%%s@%s%c"
argument_list|,
name|SystemName
argument_list|()
argument_list|,
name|from
argument_list|,
name|UucpChan
argument_list|()
argument_list|,
name|LocalName
argument_list|()
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|linebuf
argument_list|,
name|msgf
argument_list|)
expr_stmt|;
if|if
condition|(
name|txtcpy
argument_list|(
name|stdin
argument_list|,
name|msgf
argument_list|)
operator|==
name|NOTOK
condition|)
name|fputs
argument_list|(
literal|"\n  *** Problem during receipt from UUCP ***\n"
argument_list|,
name|msgf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|freopen
argument_list|(
name|Msgtmp
argument_list|,
literal|"r"
argument_list|,
name|msgf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|freopen
argument_list|(
name|Fromtmp
argument_list|,
literal|"r"
argument_list|,
name|fromf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|Fromtmp
argument_list|)
expr_stmt|;
name|mmdf
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|cpyback
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|argv
operator|++
init|;
operator|--
name|argc
operator|>
literal|0
condition|;
control|)
block|{
name|rewind
argument_list|(
name|fromf
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|msgf
argument_list|)
expr_stmt|;
name|rtnflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|deliver
argument_list|(
operator|*
name|argv
operator|++
argument_list|)
operator|==
name|NOTOK
operator|&&
operator|!
name|rtnflag
condition|)
name|cpyback
operator|++
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpyback
condition|)
block|{
name|rcpy
argument_list|()
expr_stmt|;
name|zcpy
argument_list|()
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|Msgtmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mmdf
index|[
literal|0
index|]
condition|)
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mmdf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|Errtmp
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|deliver
argument_list|(
argument|to
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|to
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|replyval
decl_stmt|;
name|char
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
switch|switch
condition|(
name|adrcheck
argument_list|(
name|to
argument_list|)
condition|)
block|{
case|case
name|ADDROK
case|:
if|if
condition|(
name|mmdf
index|[
literal|0
index|]
operator|==
name|NULL
operator|&&
name|filter
argument_list|()
operator|==
name|NOTOK
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|mmdf
argument_list|,
name|Msgtmp
argument_list|)
expr_stmt|;
name|replyval
operator|=
name|xpost
argument_list|(
name|to
argument_list|,
name|mmdf
argument_list|)
expr_stmt|;
break|break;
case|case
name|UUCP
case|:
if|if
condition|(
operator|(
name|replyval
operator|=
name|xuucp
argument_list|(
name|to
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
break|break;
if|if
condition|(
operator|(
name|replyval
operator|=
name|txtcpy
argument_list|(
name|fromf
argument_list|,
name|pipef
argument_list|)
operator|)
operator|!=
name|NOTOK
condition|)
name|replyval
operator|=
name|txtcpy
argument_list|(
name|msgf
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|i
operator|=
operator|(
name|pclose
argument_list|(
name|pipef
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|replyval
operator|!=
name|NOTOK
condition|)
name|replyval
operator|=
operator|(
name|i
operator|!=
literal|0
condition|?
name|NOTOK
else|:
name|OK
operator|)
expr_stmt|;
break|break;
comment|/*
comment|*/
case|case
name|RETURN
case|:
name|rtnflag
operator|++
expr_stmt|;
switch|switch
condition|(
name|adrcheck
argument_list|(
name|from
argument_list|)
condition|)
block|{
case|case
name|ADDROK
case|:
case|case
name|RETURN
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/rmailXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|tmpfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pipef
operator|=
name|fdopen
argument_list|(
name|creat
argument_list|(
name|tmpfil
argument_list|,
name|Tmpmode
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"Date: %s\nFrom: %s\n"
argument_list|,
name|dtimenow
argument_list|()
argument_list|,
name|Mailsys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"To: %s\ncc: %s\n"
argument_list|,
name|from
argument_list|,
name|Overseer
argument_list|)
expr_stmt|;
name|rtnmesg
argument_list|(
name|to
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pipef
argument_list|)
expr_stmt|;
name|replyval
operator|=
name|xpost
argument_list|(
name|from
argument_list|,
name|tmpfil
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
break|break;
case|case
name|UUCP
case|:
if|if
condition|(
operator|(
name|replyval
operator|=
name|xuucp
argument_list|(
name|from
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
break|break;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"To: %s\ncc: %s\n"
argument_list|,
name|from
argument_list|,
name|Overseer
argument_list|)
expr_stmt|;
name|rtnmesg
argument_list|(
name|to
argument_list|)
expr_stmt|;
name|i
operator|=
operator|(
name|pclose
argument_list|(
name|pipef
argument_list|)
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|replyval
operator|!=
name|NOTOK
condition|)
name|replyval
operator|=
operator|(
name|i
operator|!=
literal|0
condition|?
name|NOTOK
else|:
name|OK
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|Syscpy
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/rmailXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|tmpfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pipef
operator|=
name|fdopen
argument_list|(
name|creat
argument_list|(
name|tmpfil
argument_list|,
name|Tmpmode
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"Date: %s\nFrom: %s\n"
argument_list|,
name|dtimenow
argument_list|()
argument_list|,
name|Mailsys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"To: %s\ncc: %s\n"
argument_list|,
name|usrfrm
argument_list|,
name|Overseer
argument_list|)
expr_stmt|;
name|rtnmesg
argument_list|(
name|to
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pipef
argument_list|)
expr_stmt|;
name|replyval
operator|=
name|xpost
argument_list|(
name|Overseer
argument_list|,
name|tmpfil
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
return|return
name|replyval
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|adrcheck
argument_list|(
argument|adr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|adr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
name|host
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|struct
name|mailname
modifier|*
name|mp
decl_stmt|;
if|if
condition|(
operator|(
name|cp
operator|=
name|getname
argument_list|(
name|adr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|RETURN
return|;
name|mp
operator|=
name|getm
argument_list|(
name|cp
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|,
name|AD_HOST
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
while|while
condition|(
name|getname
argument_list|(
literal|""
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|mp
operator|==
name|NULL
condition|)
return|return
name|RETURN
return|;
name|type
operator|=
name|mp
operator|->
name|m_type
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|host
argument_list|,
name|mp
operator|->
name|m_host
argument_list|)
expr_stmt|;
name|mnfree
argument_list|(
name|mp
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
operator|->
name|m_mbox
operator|==
name|NULL
condition|)
return|return
name|RETURN
return|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|LOCALHOST
case|:
return|return
name|ADDROK
return|;
case|case
name|UUCPHOST
case|:
return|return
operator|(
name|strcmp
argument_list|(
name|host
argument_list|,
name|SystemName
argument_list|()
argument_list|)
condition|?
name|UUCP
else|:
name|ADDROK
operator|)
return|;
default|default:
if|if
condition|(
name|lookup
argument_list|(
name|origsys
argument_list|,
name|Okhosts
argument_list|)
operator|==
name|OK
condition|)
return|return
name|ADDROK
return|;
return|return
operator|(
name|okhost
argument_list|(
name|host
argument_list|)
operator|==
name|NOTOK
condition|?
name|RETURN
else|:
name|ADDROK
operator|)
return|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|okhost
argument_list|(
argument|host
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|host
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|lookup
argument_list|(
name|origsys
argument_list|,
name|Okhosts
argument_list|)
operator|==
name|OK
operator|||
name|lookup
argument_list|(
name|host
argument_list|,
name|Okhosts
argument_list|)
operator|==
name|OK
operator|||
name|lookup
argument_list|(
name|host
argument_list|,
name|Okdests
argument_list|)
operator|==
name|OK
condition|?
name|OK
else|:
name|NOTOK
operator|)
return|;
block|}
end_block

begin_macro
name|lookup
argument_list|(
argument|what
argument_list|,
argument|where
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|what
decl_stmt|,
modifier|*
name|where
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|cp
decl_stmt|,
name|entry
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|lookf
decl_stmt|;
if|if
condition|(
operator|(
name|lookf
operator|=
name|fopen
argument_list|(
name|where
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
while|while
condition|(
name|fgets
argument_list|(
name|entry
argument_list|,
sizeof|sizeof
name|entry
argument_list|,
name|lookf
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|cp
operator|=
name|entry
expr_stmt|;
while|while
condition|(
operator|*
name|cp
operator|!=
literal|'\n'
operator|&&
operator|*
name|cp
operator|!=
literal|' '
operator|&&
operator|*
name|cp
operator|!=
literal|'\t'
condition|)
name|cp
operator|++
expr_stmt|;
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|uleq
argument_list|(
name|what
argument_list|,
name|entry
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|lookf
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|lookf
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|rtnmesg
argument_list|(
argument|badadr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|badadr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"Subject: Illegal Address (%s)\n\n"
argument_list|,
name|badadr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|rtnmessage
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|fputs
argument_list|(
name|rtnmessage
index|[
name|i
index|]
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|rtnbegin
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|fromf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|txtcpy
argument_list|(
name|fromf
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|msgf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|txtcpy
argument_list|(
name|msgf
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|rtnend
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|txtcpy
argument_list|(
argument|frm
argument_list|,
argument|to
argument_list|)
end_macro

begin_decl_stmt
name|FILE
modifier|*
name|frm
decl_stmt|,
modifier|*
name|to
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|nread
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
while|while
condition|(
operator|!
name|pbroke
operator|&&
operator|(
name|nread
operator|=
name|fread
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|buffer
argument_list|)
argument_list|,
name|BUFSIZ
argument_list|,
name|frm
argument_list|)
operator|)
operator|>
literal|0
condition|)
operator|(
name|void
operator|)
name|fwrite
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|buffer
argument_list|)
argument_list|,
name|nread
argument_list|,
name|to
argument_list|)
expr_stmt|;
return|return
operator|(
name|ferror
argument_list|(
name|frm
argument_list|)
condition|?
name|NOTOK
else|:
name|OK
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|xpost
argument_list|(
argument|addr
argument_list|,
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|addr
decl_stmt|,
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|,
name|child_id
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|child_id
operator|=
name|fork
argument_list|()
operator|)
operator|==
name|NOTOK
operator|&&
name|i
operator|<
literal|5
condition|;
name|i
operator|++
control|)
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|child_id
condition|)
block|{
case|case
name|NOTOK
case|:
return|return
name|NOTOK
return|;
case|case
name|OK
case|:
name|execlp
argument_list|(
name|postproc
argument_list|,
name|r1bindex
argument_list|(
name|postproc
argument_list|,
literal|'/'
argument_list|)
argument_list|,
literal|"-deliver"
argument_list|,
name|addr
argument_list|,
name|file
argument_list|,
name|NULLCP
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to exec "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|postproc
argument_list|)
expr_stmt|;
name|_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
default|default:
return|return
operator|(
name|pidwait
argument_list|(
name|child_id
argument_list|,
name|OK
argument_list|)
condition|?
name|NOTOK
else|:
name|OK
operator|)
return|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|xuucp
argument_list|(
argument|to
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|to
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|cp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|cmdstr
index|[
name|BUFSIZ
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|buffer
argument_list|,
name|to
argument_list|)
expr_stmt|;
if|if
condition|(
name|cp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|'!'
argument_list|)
condition|)
operator|*
name|cp
operator|++
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"internal error -- %s has no host\n"
argument_list|,
name|to
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|cmdstr
argument_list|,
literal|"uux -p %s!rmail \\(%s\\)"
argument_list|,
name|buffer
argument_list|,
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pipef
operator|=
name|popen
argument_list|(
name|cmdstr
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
operator|(
name|void
operator|)
name|signal
argument_list|(
name|SIGPIPE
argument_list|,
name|pipeser
argument_list|)
expr_stmt|;
name|pbroke
operator|=
literal|0
expr_stmt|;
return|return
name|OK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BSD42
end_ifdef

begin_comment
comment|/* ARGSUSED */
end_comment

begin_endif
endif|#
directive|endif
endif|BSD42
end_endif

begin_function
specifier|static
name|int
name|pipeser
parameter_list|(
name|i
parameter_list|)
name|int
name|i
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|BSD42
operator|(
name|void
operator|)
name|signal
argument_list|(
name|i
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|BSD42
name|pbroke
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|rcpy
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/rmailXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|tmpfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pipef
operator|=
name|fdopen
argument_list|(
name|creat
argument_list|(
name|tmpfil
argument_list|,
name|Tmpmode
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"Date: %s\nFrom: %s\n"
argument_list|,
name|dtimenow
argument_list|()
argument_list|,
name|Mailsys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"To: %s\n"
argument_list|,
name|usrfrm
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"\nProblems sending mail:\n\n"
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|Errtmp
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ferror
argument_list|(
name|pipef
argument_list|)
condition|)
break|break;
name|fputs
argument_list|(
name|buffer
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"\tunknown problem\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|oopsmessage
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|pipef
argument_list|,
name|oopsmessage
index|[
name|i
index|]
argument_list|,
name|Overseer
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|rtnbegin
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|fromf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|txtcpy
argument_list|(
name|fromf
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|rewind
argument_list|(
name|msgf
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|txtcpy
argument_list|(
name|msgf
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|fputs
argument_list|(
name|rtnend
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pipef
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|xpost
argument_list|(
name|usrfrm
argument_list|,
name|tmpfil
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|zcpy
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/rmailXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|tmpfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pipef
operator|=
name|fdopen
argument_list|(
name|creat
argument_list|(
name|tmpfil
argument_list|,
name|Tmpmode
argument_list|)
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"Date: %s\nFrom: %s\n"
argument_list|,
name|dtimenow
argument_list|()
argument_list|,
name|Mailsys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"To: %s\n"
argument_list|,
name|Mailsys
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"\nProblems sending mail for %s (aka %s):\n\n"
argument_list|,
name|from
argument_list|,
name|usrfrm
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|Errtmp
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
name|fp
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ferror
argument_list|(
name|pipef
argument_list|)
condition|)
break|break;
name|fputs
argument_list|(
name|buffer
argument_list|,
name|pipef
argument_list|)
expr_stmt|;
name|i
operator|=
literal|1
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"\tunknown problem\n"
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|pipef
argument_list|,
literal|"\tunable to open %s\n"
argument_list|,
name|Errtmp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|pipef
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|xpost
argument_list|(
name|Mailsys
argument_list|,
name|tmpfil
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|filter
argument_list|()
end_macro

begin_block
block|{
name|int
name|i
decl_stmt|,
name|fd
decl_stmt|,
name|td
decl_stmt|;
name|char
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|mmdfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|out
decl_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/rmailXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|tmpfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|tmpfil
argument_list|,
name|Tmpmode
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|tmpfil
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
operator|(
name|out
operator|=
name|fdopen
argument_list|(
name|fd
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|td
operator|=
name|dup
argument_list|(
name|fd
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"From %s %s\n"
argument_list|,
name|from
argument_list|,
name|date
argument_list|)
expr_stmt|;
if|if
condition|(
name|txtcpy
argument_list|(
name|msgf
argument_list|,
name|out
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|td
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|td
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|mmdfil
argument_list|,
literal|"/tmp/mmdfXXXXXX"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|mmdfil
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|creat
argument_list|(
name|mmdfil
argument_list|,
name|Tmpmode
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|td
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|mmdfil
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close
argument_list|(
name|td
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
comment|/*
comment|*/
switch|switch
condition|(
name|i
operator|=
name|uucp2mmdf
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|TRUE
argument_list|)
condition|)
block|{
case|case
name|OK
case|:
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|mmdf
argument_list|,
name|mmdfil
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mmdf
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|close
argument_list|(
name|td
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|!=
name|OK
condition|?
name|NOTOK
else|:
name|OK
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|get_mmdf_addr
argument_list|(
argument|addr
argument_list|,
argument|to
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|addr
decl_stmt|,
modifier|*
name|to
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|adrx
modifier|*
name|adrxp
decl_stmt|;
operator|*
name|to
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|adrxp
operator|=
name|seekadrx
argument_list|(
name|addr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|addr_convert
argument_list|(
name|adrxp
argument_list|,
name|to
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
while|while
condition|(
name|seekadrx
argument_list|(
name|NULLCP
argument_list|)
condition|)
continue|continue;
block|}
end_block

end_unit


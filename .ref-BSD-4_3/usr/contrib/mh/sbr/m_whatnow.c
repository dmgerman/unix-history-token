begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* m_whatnow.c - exec whatnowproc */
end_comment

begin_include
include|#
directive|include
file|"../h/mh.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_macro
name|m_whatnow
argument_list|(
argument|ed
argument_list|,
argument|nedit
argument_list|,
argument|use
argument_list|,
argument|file
argument_list|,
argument|altmsg
argument_list|,
argument|dist
argument_list|,
argument|mp
argument_list|,
argument|text
argument_list|,
argument|inplace
argument_list|,
argument|cwd
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|msgs
modifier|*
name|mp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|ed
decl_stmt|,
modifier|*
name|file
decl_stmt|,
modifier|*
name|altmsg
decl_stmt|,
modifier|*
name|text
decl_stmt|,
modifier|*
name|cwd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|nedit
decl_stmt|,
name|use
decl_stmt|,
name|dist
decl_stmt|,
name|inplace
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|found
decl_stmt|,
name|k
decl_stmt|,
name|msgnum
decl_stmt|,
name|vecp
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
modifier|*
name|vec
index|[
name|MAXARGS
index|]
decl_stmt|;
name|vecp
operator|=
literal|0
expr_stmt|;
name|vec
index|[
name|vecp
operator|++
index|]
operator|=
name|r1bindex
argument_list|(
name|whatnowproc
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|vec
index|[
name|vecp
index|]
operator|=
name|NULL
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhdraft"
argument_list|,
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|mp
condition|)
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhfolder"
argument_list|,
name|mp
operator|->
name|foldpath
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|unputenv
argument_list|(
literal|"mhfolder"
argument_list|)
expr_stmt|;
if|if
condition|(
name|altmsg
condition|)
if|if
condition|(
name|mp
operator|==
name|NULL
operator|||
operator|*
name|altmsg
operator|==
literal|'/'
operator|||
name|cwd
operator|==
name|NULL
condition|)
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhaltmsg"
argument_list|,
name|altmsg
argument_list|)
expr_stmt|;
else|else
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%s/%s"
argument_list|,
name|mp
operator|->
name|foldpath
argument_list|,
name|altmsg
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhaltmsg"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|unputenv
argument_list|(
literal|"mhaltmsg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
operator|=
name|getenv
argument_list|(
literal|"mhaltmsg"
argument_list|)
condition|)
comment|/* XXX */
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"editalt"
argument_list|,
name|bp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|dist
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhdist"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|nedit
condition|)
operator|(
name|void
operator|)
name|unputenv
argument_list|(
literal|"mheditor"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mheditor"
argument_list|,
name|ed
condition|?
name|ed
else|:
operator|(
name|ed
operator|=
name|m_find
argument_list|(
literal|"editor"
argument_list|)
operator|)
condition|?
name|ed
else|:
name|sysed
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|use
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhuse"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unputenv
argument_list|(
literal|"mhmessages"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unputenv
argument_list|(
literal|"mhannotate"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|unputenv
argument_list|(
literal|"mhinplace"
argument_list|)
expr_stmt|;
if|if
condition|(
name|text
operator|&&
name|mp
operator|&&
operator|!
operator|(
name|mp
operator|->
name|msgflags
operator|&
name|READONLY
operator|)
condition|)
block|{
name|found
operator|=
literal|0
expr_stmt|;
name|bp
operator|=
name|buffer
expr_stmt|;
for|for
control|(
name|msgnum
operator|=
name|mp
operator|->
name|lowmsg
init|;
name|msgnum
operator|<=
name|mp
operator|->
name|hghmsg
condition|;
name|msgnum
operator|++
control|)
if|if
condition|(
name|mp
operator|->
name|msgstats
index|[
name|msgnum
index|]
operator|&
name|SELECTED
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"%s%s"
argument_list|,
name|found
condition|?
literal|" "
else|:
literal|""
argument_list|,
name|m_name
argument_list|(
name|msgnum
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
name|msgnum
operator|+
literal|1
init|;
name|k
operator|<=
name|mp
operator|->
name|hghmsg
operator|&&
name|mp
operator|->
name|msgstats
index|[
name|k
index|]
operator|&
name|SELECTED
condition|;
name|k
operator|++
control|)
continue|continue;
if|if
condition|(
operator|--
name|k
operator|>
name|msgnum
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|bp
argument_list|,
literal|"-%s"
argument_list|,
name|m_name
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|strlen
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
name|msgnum
operator|=
name|k
operator|+
literal|1
expr_stmt|;
name|found
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|found
condition|)
block|{
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhmessages"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhannotate"
argument_list|,
name|text
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"%d"
argument_list|,
name|inplace
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putenv
argument_list|(
literal|"mhinplace"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
block|}
name|m_update
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|cwd
condition|)
operator|(
name|void
operator|)
name|chdir
argument_list|(
name|cwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|vec
index|[
literal|0
index|]
argument_list|,
literal|"whatnow"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|WhatNow
argument_list|(
name|vecp
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|done
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|execvp
argument_list|(
name|whatnowproc
argument_list|,
name|vec
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"unable to exec "
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|whatnowproc
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* bb_wtmail.c - write mail to a BBoard */
end_comment

begin_include
include|#
directive|include
file|"util.h"
end_include

begin_include
include|#
directive|include
file|"mmdf.h"
end_include

begin_include
include|#
directive|include
file|"ch.h"
end_include

begin_include
include|#
directive|include
file|"bboards.h"
end_include

begin_include
include|#
directive|include
file|"tws.h"
end_include

begin_include
include|#
directive|include
file|<pwd.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_comment
comment|/*
comment|*/
end_comment

begin_decl_stmt
name|int
name|err_fd
init|=
name|NOTOK
decl_stmt|;
end_decl_stmt

begin_function_decl
name|int
name|dist_address
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|int
name|errno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|bbrduid
decl_stmt|,
name|bbrdgid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|channelname
decl_stmt|,
name|channelinfo
index|[
name|LINESIZE
index|]
decl_stmt|,
name|bbrdaddr
index|[
name|LINESIZE
index|]
decl_stmt|,
name|bbrdfrom
index|[
name|LINESIZE
index|]
decl_stmt|,
name|bbrdheader
index|[
name|LINESIZE
index|]
decl_stmt|,
name|bbrdhome
index|[
name|LINESIZE
index|]
decl_stmt|,
name|bbrdtime
index|[
name|LINESIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|qu_msgfile
decl_stmt|,
name|delim1
index|[]
decl_stmt|,
name|delim2
index|[]
decl_stmt|,
name|locname
index|[]
decl_stmt|,
name|sitesignature
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|bboard
modifier|*
name|curbb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ll_struct
modifier|*
name|logptr
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|char
modifier|*
name|index
argument_list|()
decl_stmt|,
modifier|*
name|rindex
argument_list|()
decl_stmt|,
modifier|*
name|sprintf
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|struct
name|passwd
modifier|*
name|getpwnam
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|bb_init
argument_list|(
argument|chanptr
argument_list|)
end_macro

begin_decl_stmt
name|Chan
modifier|*
name|chanptr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|uid
decl_stmt|,
name|eid
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_init(chanptr=%s)"
argument_list|,
name|chanptr
operator|->
name|ch_spec
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|channelname
operator|=
name|chanptr
operator|->
name|ch_spec
expr_stmt|;
ifndef|#
directive|ifndef
name|notdef
name|sprintf
argument_list|(
name|channelinfo
argument_list|,
literal|"vmth%s*"
argument_list|,
name|channelname
argument_list|)
expr_stmt|;
else|#
directive|else
else|notdef
comment|/* the following is probably a BAD idea */
if|if
condition|(
name|chanptr
operator|->
name|ch_host
operator|==
name|NULL
condition|)
name|channelinfo
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
comment|/* local delivery ONLY */
else|else
name|sprintf
argument_list|(
name|channelinfo
argument_list|,
literal|"vmth%s*"
argument_list|,
name|chanptr
operator|->
name|ch_host
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|notdef
if|if
condition|(
operator|(
name|pw
operator|=
name|getpwnam
argument_list|(
name|BBOARDS
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|err_abrt
argument_list|(
name|RP_BHST
argument_list|,
literal|"no passwd entry for '%s'"
argument_list|,
name|BBOARDS
argument_list|)
expr_stmt|;
name|bbrduid
operator|=
name|pw
operator|->
name|pw_uid
expr_stmt|;
name|bbrdgid
operator|=
name|pw
operator|->
name|pw_gid
expr_stmt|;
name|sprintf
argument_list|(
name|bbrdfrom
argument_list|,
literal|"%s@%s"
argument_list|,
name|pw
operator|->
name|pw_name
argument_list|,
name|locname
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"distributing as '%s'"
argument_list|,
name|bbrdfrom
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sprintf
argument_list|(
name|bbrdhome
argument_list|,
name|pw
operator|->
name|pw_dir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|setbbent
argument_list|()
condition|)
name|err_abrt
argument_list|(
name|RP_BHST
argument_list|,
literal|"setbbent() failed"
argument_list|)
expr_stmt|;
name|getwho
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|eid
argument_list|)
expr_stmt|;
if|if
condition|(
name|eid
operator|!=
literal|0
condition|)
name|err_abrt
argument_list|(
name|RP_BHST
argument_list|,
literal|"not running as root"
argument_list|)
expr_stmt|;
return|return
name|RP_OK
return|;
block|}
end_block

begin_macro
name|bb_end
argument_list|(
argument|result
argument_list|)
end_macro

begin_decl_stmt
name|short
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_end(result=0%o)"
argument_list|,
name|result
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|RP_OK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|bb_sbinit
argument_list|()
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_sbinit()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|RP_OK
return|;
block|}
end_block

begin_macro
name|bb_sbend
argument_list|()
end_macro

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_sbend()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|RP_OK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|bb_winit
argument_list|(
argument|info
argument_list|,
argument|sender
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|info
decl_stmt|,
modifier|*
name|sender
decl_stmt|;
end_decl_stmt

begin_block
block|{
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_winit(info='%s',sender='%s')"
argument_list|,
name|info
argument_list|,
name|sender
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|RP_OK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|bb_wtadr
argument_list|(
argument|host
argument_list|,
argument|adr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|host
decl_stmt|,
modifier|*
name|adr
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|count
decl_stmt|,
name|result
decl_stmt|;
name|int
name|i
decl_stmt|,
name|md
decl_stmt|,
name|offset
decl_stmt|,
name|qd
decl_stmt|,
name|size
decl_stmt|;
name|long
name|start
decl_stmt|,
name|stop
decl_stmt|,
name|pos
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|,
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_wtadr(host=%s,adr=%s)"
argument_list|,
name|host
argument_list|,
name|adr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|make_lower
argument_list|(
name|adr
argument_list|,
name|adr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|curbb
operator|=
name|getbbnam
argument_list|(
name|adr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|RP_USER
return|;
name|sprintf
argument_list|(
name|bbrdaddr
argument_list|,
literal|"local-%s-request@%s"
argument_list|,
name|curbb
operator|->
name|bb_name
argument_list|,
name|locname
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"=> BBoard %s: file='%s' info='%s addr='%s'"
argument_list|,
name|curbb
operator|->
name|bb_name
argument_list|,
name|curbb
operator|->
name|bb_file
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|,
name|bbrdaddr
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|curbb
operator|->
name|bb_file
operator|==
name|NULL
operator|||
operator|*
name|curbb
operator|->
name|bb_file
operator|==
name|NULL
condition|)
return|return
name|RP_AOK
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"begin local delivery..."
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printx
argument_list|(
literal|"\r\nperforming local delivery to file %s...\n"
argument_list|,
name|curbb
operator|->
name|bb_file
argument_list|)
expr_stmt|;
name|qu_rtinit
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|qd
operator|=
name|dup
argument_list|(
name|qu_fileno
argument_list|()
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGFAT
argument_list|,
literal|"unable to dup qu_fileno()"
argument_list|)
expr_stmt|;
return|return
name|RP_LIO
return|;
block|}
if|if
condition|(
operator|(
name|md
operator|=
name|mbx_open
argument_list|(
name|curbb
operator|->
name|bb_file
argument_list|,
name|bbrduid
argument_list|,
name|bbrdgid
argument_list|,
name|BBMODE
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|close
argument_list|(
name|qd
argument_list|)
expr_stmt|;
return|return
name|RP_FOPEN
return|;
block|}
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mbx_init
argument_list|()
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|qd
argument_list|)
expr_stmt|;
name|mbx_close
argument_list|(
name|curbb
operator|->
name|bb_file
argument_list|,
name|md
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|pos
operator|=
name|lseek
argument_list|(
name|md
argument_list|,
literal|0L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|count
operator|=
name|strlen
argument_list|(
name|delim1
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|md
argument_list|,
name|delim1
argument_list|,
name|count
argument_list|)
operator|!=
name|count
condition|)
block|{
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"error writing delim1"
argument_list|)
expr_stmt|;
name|i
operator|=
name|NOTOK
expr_stmt|;
goto|goto
name|clean_up
goto|;
block|}
name|start
operator|=
name|lseek
argument_list|(
name|md
argument_list|,
literal|0L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|size
operator|=
literal|0
expr_stmt|;
name|count
operator|=
name|strlen
argument_list|(
name|bbrdheader
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|md
argument_list|,
name|bbrdheader
argument_list|,
name|count
argument_list|)
operator|!=
name|count
condition|)
block|{
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"error writing BBoard information"
argument_list|)
expr_stmt|;
name|i
operator|=
name|NOTOK
expr_stmt|;
goto|goto
name|clean_up
goto|;
block|}
for|for
control|(
name|cp
operator|=
name|bbrhdheader
init|;
operator|*
name|cp
condition|;
name|cp
operator|++
operator|,
name|size
operator|++
control|)
if|if
condition|(
operator|*
name|cp
operator|==
literal|'\n'
condition|)
name|size
operator|++
expr_stmt|;
comment|/*
comment|*/
while|while
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|qd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|offset
operator|=
literal|0
init|;
operator|(
name|offset
operator|=
name|strindex
argument_list|(
name|delim1
argument_list|,
name|buffer
argument_list|)
operator|)
operator|>=
literal|0
condition|;
name|buffer
index|[
name|offset
index|]
operator|++
control|)
continue|continue;
for|for
control|(
name|offset
operator|=
literal|0
init|;
operator|(
name|offset
operator|=
name|strindex
argument_list|(
name|delim2
argument_list|,
name|buffer
argument_list|)
operator|)
operator|>=
literal|0
condition|;
name|buffer
index|[
name|offset
index|]
operator|++
control|)
continue|continue;
if|if
condition|(
name|write
argument_list|(
name|md
argument_list|,
name|buffer
argument_list|,
name|i
argument_list|)
operator|!=
name|i
condition|)
block|{
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"error writing to file '%s'"
argument_list|,
name|curbb
operator|->
name|bb_file
argument_list|)
expr_stmt|;
name|i
operator|=
name|NOTOK
expr_stmt|;
goto|goto
name|clean_up
goto|;
block|}
for|for
control|(
name|offset
operator|=
literal|0
operator|,
name|cp
operator|=
name|buffer
init|;
name|offset
operator|<
name|i
condition|;
name|offset
operator|++
operator|,
name|size
operator|++
control|)
if|if
condition|(
operator|*
name|cp
operator|++
operator|==
literal|'\n'
condition|)
name|size
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<
literal|0
condition|)
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"error reading from message file '%s'"
argument_list|,
name|qu_msgfile
argument_list|)
expr_stmt|;
name|clean_up
label|:
empty_stmt|;
name|close
argument_list|(
name|qd
argument_list|)
expr_stmt|;
name|stop
operator|=
name|lseek
argument_list|(
name|md
argument_list|,
literal|0L
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|count
operator|=
name|strlen
argument_list|(
name|delim2
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|md
argument_list|,
name|delim2
argument_list|,
name|count
argument_list|)
operator|!=
name|count
condition|)
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"error writing delim2"
argument_list|)
expr_stmt|;
name|map_write
argument_list|(
name|curbb
operator|->
name|bb_file
argument_list|,
name|md
argument_list|,
name|curbb
operator|->
name|bb_maxima
argument_list|,
name|start
argument_list|,
name|stop
argument_list|,
name|pos
argument_list|,
name|size
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"end local delivery..."
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|result
operator|=
name|mbx_close
argument_list|(
name|curbb
operator|->
name|bb_file
argument_list|,
name|md
argument_list|)
expr_stmt|;
return|return
operator|(
name|i
operator|<
literal|0
condition|?
name|RP_FIO
else|:
name|result
operator|)
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|bb_txtcpy
argument_list|()
end_macro

begin_block
block|{
name|short
name|result
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"bb_txtcpy()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|curbb
operator|->
name|bb_dist
operator|==
name|NULL
operator|||
operator|*
name|curbb
operator|->
name|bb_dist
operator|==
name|NULL
operator|||
name|channelinfo
index|[
literal|0
index|]
operator|==
name|NULL
condition|)
return|return
name|RP_MOK
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"begin distribution..."
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|curbb
operator|->
name|bb_file
operator|==
name|NULL
operator|||
operator|*
name|curbb
operator|->
name|bb_file
operator|==
name|NULL
condition|)
name|printx
argument_list|(
literal|"\r\n"
argument_list|)
expr_stmt|;
name|printx
argument_list|(
literal|"\rperforming remote distribution\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|dist_init
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|result
operator|=
name|dist_adrs
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|result
operator|=
name|dist_text
argument_list|()
argument_list|)
operator|||
name|rp_isbad
argument_list|(
name|result
operator|=
name|dist_end
argument_list|()
argument_list|)
condition|)
return|return
name|dist_lose
argument_list|(
name|result
argument_list|)
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"end distribution..."
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|err_fd
operator|!=
name|NOTOK
condition|)
name|dist_lose
argument_list|(
name|RP_MOK
argument_list|)
expr_stmt|;
else|else
name|printx
argument_list|(
literal|"\rmessage distributed\n"
argument_list|)
expr_stmt|;
return|return
name|RP_MOK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* dist_    BBoard distribution routines */
end_comment

begin_macro
name|dist_init
argument_list|()
end_macro

begin_block
block|{
name|short
name|result
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"dist_init()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_init
argument_list|()
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_init() failed [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_sbinit
argument_list|()
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_sbinit() failed [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_winit
argument_list|(
name|chnlname
argument_list|,
name|chnlinfo
argument_list|,
name|bbrdaddr
argument_list|)
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_winit('%s','%s','%s') failed [%s]"
argument_list|,
name|chnlname
argument_list|,
name|chnlinfo
argument_list|,
name|bbrdaddr
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
return|return
name|result
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|dist_adrs
argument_list|()
end_macro

begin_block
block|{
name|short
name|result
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"dist_adrs()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|getbbdist
argument_list|(
name|curbb
argument_list|,
name|dist_address
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|RP_NO
argument_list|,
name|LLOGTMP
argument_list|,
literal|"getbbdist failed: %s"
argument_list|,
name|getbberr
argument_list|()
argument_list|)
return|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_waend
argument_list|()
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_waend() failed [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
return|return
name|result
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|dist_address
argument_list|(
argument|addr
argument_list|,
argument|host
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|addr
decl_stmt|,
modifier|*
name|host
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|short
name|result
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"dist_address(addr='%s',host='%s')"
argument_list|,
name|addr
argument_list|,
name|host
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printx
argument_list|(
literal|"\rperforming distribution to %s@%s...\n"
argument_list|,
name|addr
argument_list|,
name|host
argument_list|)
expr_stmt|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_wadr
argument_list|(
name|host
argument_list|,
name|addr
argument_list|)
argument_list|)
condition|)
block|{
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_wadr('%s','%s') failed [%s]"
argument_list|,
name|host
argument_list|,
name|addr
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
condition|)
block|{
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_rrply() failed [%s] getting status of '%s@%s'"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|,
name|addr
argument_list|,
name|host
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
switch|switch
condition|(
name|rp_gval
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
condition|)
block|{
case|case
name|RP_AOK
case|:
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"address '%s@%s' [%s] -- %s"
argument_list|,
name|addr
argument_list|,
name|host
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|OK
return|;
case|case
name|RP_NO
case|:
case|case
name|RP_USER
case|:
case|case
name|RP_NDEL
case|:
case|case
name|RP_AGN
case|:
case|case
name|RP_NOOP
case|:
name|dist_log
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|,
name|LLOGTMP
argument_list|,
literal|"address '%s@%s' [%s] -- %s"
argument_list|,
name|addr
argument_list|,
name|host
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
comment|/* fail-soft */
default|default:
name|dist_log
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|,
name|LLOGFAT
argument_list|,
literal|"unexpected reply [%s] -- %s"
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|dist_text
argument_list|()
end_macro

begin_block
block|{
name|short
name|result
decl_stmt|;
name|int
name|i
decl_stmt|,
name|qd
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"dist_text()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|qu_rtinit
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|qd
operator|=
name|dup
argument_list|(
name|qu_fileno
argument_list|()
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|dist_log
argument_list|(
name|RP_LIO
argument_list|,
name|LLOGFAT
argument_list|,
literal|"unable to dup qu_fileno()"
argument_list|)
return|;
while|while
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|qd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_wtxt
argument_list|(
name|buffer
argument_list|,
name|i
argument_list|)
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_wtxt() failed [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
name|close
argument_list|(
name|qd
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
return|return
name|dist_log
argument_list|(
name|RP_FIO
argument_list|,
name|LLOGTMP
argument_list|,
literal|"error reading from message file '%s'"
argument_list|,
name|qu_msgfile
argument_list|)
return|;
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_wtend
argument_list|()
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_wtend() failed [%s]"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
return|return
name|result
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|dist_end
argument_list|()
end_macro

begin_block
block|{
name|short
name|result
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|rp_bufstruct
name|reply
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"dist_end()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|rp_isbad
argument_list|(
name|result
operator|=
name|mm_rrply
argument_list|(
operator|&
name|reply
argument_list|,
operator|&
name|len
argument_list|)
argument_list|)
condition|)
return|return
name|dist_log
argument_list|(
name|result
argument_list|,
name|LLOGFAT
argument_list|,
literal|"mm_rrply() failed [%s] getting final status"
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
return|;
switch|switch
condition|(
name|rp_gval
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
condition|)
block|{
case|case
name|RP_OK
case|:
case|case
name|RP_MOK
case|:
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGGEN
argument_list|,
literal|"message [%s] -- %s"
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|mm_sbend
argument_list|()
expr_stmt|;
name|mm_end
argument_list|(
name|OK
argument_list|)
expr_stmt|;
return|return
name|result
return|;
case|case
name|RP_NO
case|:
case|case
name|RP_NDEL
case|:
case|case
name|RP_AGN
case|:
case|case
name|RP_NOOP
case|:
return|return
name|dist_log
argument_list|(
name|RP_NO
argument_list|,
name|LLOGTMP
argument_list|,
literal|"not delivered [%s] -- %s"
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
return|;
default|default:
return|return
name|dist_log
argument_list|(
name|RP_RPLY
argument_list|,
name|LLOGFAT
argument_list|,
literal|"unexpected final reply [%s] -- %s"
argument_list|,
name|rp_valstr
argument_list|(
name|reply
operator|.
name|rp_val
argument_list|)
argument_list|,
name|reply
operator|.
name|rp_line
argument_list|)
return|;
block|}
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_macro
name|dist_lose
argument_list|(
argument|result
argument_list|)
end_macro

begin_decl_stmt
name|short
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|qd
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|qp
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"dist_lose(result=0%o)"
argument_list|,
name|result
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
name|mm_end
argument_list|(
name|NOTOK
argument_list|)
expr_stmt|;
name|printx
argument_list|(
literal|"\rerrors during distribution: "
argument_list|)
expr_stmt|;
if|if
condition|(
name|domsg
condition|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
literal|"ch_bboards(%d) distribution for %s failed [%s]\n"
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|curbb
operator|->
name|bb_name
argument_list|,
name|rp_valstr
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ml_init
argument_list|(
name|NO
argument_list|,
name|NO
argument_list|,
name|sitesignature
argument_list|,
literal|"Re-distribution Failure"
argument_list|)
operator|!=
name|OK
operator|||
name|ml_adr
argument_list|(
name|bbrdaddr
argument_list|)
operator|!=
name|OK
operator|||
name|ml_cc
argument_list|()
operator|!=
name|OK
operator|||
name|ml_adr
argument_list|(
name|bbrdfrom
argument_list|)
operator|!=
name|OK
operator|||
name|ml_aend
argument_list|()
operator|!=
name|OK
operator|||
name|ml_tinit
argument_list|()
operator|!=
name|OK
condition|)
goto|goto
name|ml_err
goto|;
name|ml_txt
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|err_fd
operator|!=
name|NOTOK
condition|)
block|{
name|lseek
argument_list|(
name|err_fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|qp
operator|=
name|fdopen
argument_list|(
name|err_fd
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ml_txt
argument_list|(
literal|"unable to fdopen() for diagnostic copy\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|err_fd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ml_file
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|qp
argument_list|)
expr_stmt|;
block|}
name|err_fd
operator|=
name|NOTOK
expr_stmt|;
block|}
name|qu_rtinit
argument_list|(
literal|0L
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|qd
operator|=
name|dup
argument_list|(
name|qu_fileno
argument_list|()
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
name|ml_txt
argument_list|(
literal|"unable to dup qu_fileno() for message copy\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|qp
operator|=
name|fdopen
argument_list|(
name|qd
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ml_txt
argument_list|(
literal|"unable to fdopen() for message copy\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|qd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ml_txt
argument_list|(
literal|"\n  --Message Follows--\n"
argument_list|)
expr_stmt|;
name|ml_file
argument_list|(
name|qp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|qp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ml_end
argument_list|(
name|OK
argument_list|)
operator|!=
name|OK
condition|)
block|{
name|char
modifier|*
name|cp
decl_stmt|;
name|ml_err
label|:
empty_stmt|;
if|if
condition|(
name|cp
operator|=
name|index
argument_list|(
name|buffer
argument_list|,
literal|'\n'
argument_list|)
condition|)
operator|*
name|cp
operator|=
name|NULL
expr_stmt|;
name|printx
argument_list|(
literal|"unable to post advisory.\n"
argument_list|)
expr_stmt|;
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGFAT
argument_list|,
literal|"unable to post failure notice"
argument_list|)
expr_stmt|;
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGFAT
argument_list|,
literal|"info: %s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
block|}
else|else
name|printx
argument_list|(
literal|"advisory posted.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|domsg
condition|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
return|return
name|RP_MOK
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* VARARGS3 */
end_comment

begin_macro
name|dist_log
argument_list|(
argument|result
argument_list|,
argument|level
argument_list|,
argument|fmt
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|,
argument|c
argument_list|,
argument|d
argument_list|,
argument|e
argument_list|)
end_macro

begin_decl_stmt
name|short
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|fmt
decl_stmt|,
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|,
modifier|*
name|c
decl_stmt|,
modifier|*
name|d
decl_stmt|,
modifier|*
name|e
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
name|char
name|buffer
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|tmpfil
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|level
argument_list|,
name|fmt
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|buffer
argument_list|,
name|fmt
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|,
name|d
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|buffer
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|printx
argument_list|(
literal|"\rerror: %s"
argument_list|,
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|err_fd
operator|==
name|NOTOK
condition|)
block|{
name|unlink
argument_list|(
name|mktemp
argument_list|(
name|strcpy
argument_list|(
name|tmpfil
argument_list|,
literal|"/tmp/bboardsXXXXXX"
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err_fd
operator|=
name|creat
argument_list|(
name|tmpfil
argument_list|,
literal|0600
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|result
return|;
name|close
argument_list|(
name|err_fd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err_fd
operator|=
name|open
argument_list|(
name|tmpfil
argument_list|,
literal|2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|result
return|;
name|unlink
argument_list|(
name|tmpfil
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|err_fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|strlen
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|err_fd
argument_list|,
name|buffer
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_block

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* mbx_	    local mailbox routines */
end_comment

begin_macro
name|mbx_init
argument_list|()
end_macro

begin_block
block|{
name|int
name|fd
decl_stmt|,
name|clear
decl_stmt|;
name|char
name|name
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGBTR
argument_list|,
literal|"mbx_init()"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|fd
operator|=
name|mbx_Xopen
argument_list|(
name|curbb
operator|->
name|bb_info
argument_list|,
name|bbrduid
argument_list|,
name|bbrdgid
argument_list|,
name|BBMODE
argument_list|,
operator|&
name|clear
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ETXTBSY
condition|)
block|{
name|printx
argument_list|(
literal|"\runable to lock %s\n"
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
name|ll_err
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"unable to lock %s"
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
return|return
name|RP_LOCK
return|;
block|}
name|printx
argument_list|(
literal|"\runable to open '%s'"
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
name|ll_log
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"unable to open '%s'"
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
return|return
name|RP_FOPN
return|;
block|}
if|if
condition|(
operator|(
name|fp
operator|=
name|fdopen
argument_list|(
name|fd
argument_list|,
literal|"w"
argument_list|)
operator|)
operator|==
operator|(
name|FILE
operator|*
operator|)
name|NULL
condition|)
block|{
name|printx
argument_list|(
literal|"\runable to fdopen '%s'"
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
name|ll_err
argument_list|(
name|logptr
argument_list|,
name|LLOGTMP
argument_list|,
literal|"unable to fdopen '%s'"
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
name|mbx_close
argument_list|(
name|curbb
operator|->
name|bb_info
argument_list|,
name|fd
argument_list|)
expr_stmt|;
return|return
name|RP_LIO
return|;
block|}
name|strcpy
argument_list|(
name|name
argument_list|,
name|curbb
operator|->
name|bb_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|curbb
operator|=
name|getbbnam
argument_list|(
name|name
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printx
argument_list|(
literal|"\runable to get information on BBoard %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ll_err
argument_list|(
name|logptr
argument_list|,
name|LLOGFAT
argument_list|,
literal|"unable to get info on %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|lkfclose
argument_list|(
name|fp
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
return|return
name|RP_LIO
return|;
block|}
name|strcpy
argument_list|(
name|bbrdtime
argument_list|,
name|dtimenow
argument_list|()
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|bbrdheader
argument_list|,
literal|"BBoard-ID: %d\nBB-Posted: %s\n"
argument_list|,
operator|++
name|curbb
operator|->
name|bb_maxima
argument_list|,
name|bbrdtime
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%d\n%s\n"
argument_list|,
name|curbb
operator|->
name|bb_maxima
argument_list|,
name|bbrdtime
argument_list|)
expr_stmt|;
name|lkfclose
argument_list|(
name|fp
argument_list|,
name|curbb
operator|->
name|bb_info
argument_list|)
expr_stmt|;
return|return
name|RP_OK
return|;
block|}
end_block

end_unit


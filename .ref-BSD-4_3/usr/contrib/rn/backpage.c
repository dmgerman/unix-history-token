begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Header: backpage.c,v 4.3 85/05/01 11:36:03 lwall Exp $  *  * $Log:	backpage.c,v $  * Revision 4.3  85/05/01  11:36:03  lwall  * Baseline for release with 4.3bsd.  *   */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"intrp.h"
end_include

begin_include
include|#
directive|include
file|"final.h"
end_include

begin_include
include|#
directive|include
file|"INTERN.h"
end_include

begin_include
include|#
directive|include
file|"backpage.h"
end_include

begin_decl_stmt
name|ART_LINE
name|maxindx
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_function_decl
name|long
name|lseek
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|void
name|backpage_init
parameter_list|()
block|{
name|char
modifier|*
name|varyname
decl_stmt|;
name|varyname
operator|=
name|filexp
argument_list|(
name|VARYNAME
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|creat
argument_list|(
name|varyname
argument_list|,
literal|0600
argument_list|)
argument_list|)
expr_stmt|;
name|varyfd
operator|=
name|open
argument_list|(
name|varyname
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|UNLINK
argument_list|(
name|varyname
argument_list|)
expr_stmt|;
if|if
condition|(
name|varyfd
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
argument|cantopen
argument_list|,
argument|varyname
argument_list|)
name|FLUSH
expr_stmt|;
name|sig_catcher
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* virtual array read */
end_comment

begin_function
name|ART_POS
name|vrdary
parameter_list|(
name|indx
parameter_list|)
name|ART_LINE
name|indx
decl_stmt|;
block|{
name|int
name|subindx
decl_stmt|;
name|long
name|offset
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|indx
operator|>
name|maxindx
condition|)
block|{
name|printf
argument_list|(
literal|"vrdary(%ld)> %ld\n"
argument_list|,
argument|(long)indx
argument_list|,
argument|(long)maxindx
argument_list|)
name|FLUSH
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
if|if
condition|(
name|indx
operator|<
literal|0
condition|)
return|return
literal|0
return|;
name|subindx
operator|=
name|indx
operator|%
name|VARYSIZE
expr_stmt|;
name|offset
operator|=
operator|(
name|indx
operator|-
name|subindx
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|varybuf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|!=
name|oldoffset
condition|)
block|{
if|if
condition|(
name|oldoffset
operator|>=
literal|0
condition|)
block|{
ifndef|#
directive|ifndef
name|lint
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|varyfd
argument_list|,
name|oldoffset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|varyfd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|varybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|varybuf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|lint
block|}
ifndef|#
directive|ifndef
name|lint
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|varyfd
argument_list|,
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|varyfd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|varybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|varybuf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|lint
name|oldoffset
operator|=
name|offset
expr_stmt|;
block|}
return|return
name|varybuf
index|[
name|subindx
index|]
return|;
block|}
end_function

begin_comment
comment|/* write to virtual array */
end_comment

begin_function
name|void
name|vwtary
parameter_list|(
name|indx
parameter_list|,
name|newvalue
parameter_list|)
name|ART_LINE
name|indx
decl_stmt|;
name|ART_POS
name|newvalue
decl_stmt|;
block|{
name|int
name|subindx
decl_stmt|;
name|long
name|offset
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|indx
operator|<
literal|0
condition|)
name|printf
argument_list|(
literal|"vwtary(%ld)\n"
argument_list|,
argument|(long)indx
argument_list|)
name|FLUSH
expr_stmt|;
if|if
condition|(
operator|!
name|indx
condition|)
name|maxindx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|indx
operator|>
name|maxindx
condition|)
block|{
if|if
condition|(
name|indx
operator|!=
name|maxindx
operator|+
literal|1
condition|)
name|printf
argument_list|(
literal|"indx skipped %d-%d\n"
argument_list|,
argument|maxindx+
literal|1
argument_list|,
argument|indx-
literal|1
argument_list|)
name|FLUSH
expr_stmt|;
name|maxindx
operator|=
name|indx
expr_stmt|;
block|}
endif|#
directive|endif
name|subindx
operator|=
name|indx
operator|%
name|VARYSIZE
expr_stmt|;
name|offset
operator|=
operator|(
name|indx
operator|-
name|subindx
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|varybuf
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|!=
name|oldoffset
condition|)
block|{
if|if
condition|(
name|oldoffset
operator|>=
literal|0
condition|)
block|{
ifndef|#
directive|ifndef
name|lint
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|varyfd
argument_list|,
name|oldoffset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|varyfd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|varybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|varybuf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|lint
block|}
ifndef|#
directive|ifndef
name|lint
operator|(
name|void
operator|)
name|lseek
argument_list|(
name|varyfd
argument_list|,
name|offset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|varyfd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|varybuf
argument_list|,
sizeof|sizeof
argument_list|(
name|varybuf
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|lint
name|oldoffset
operator|=
name|offset
expr_stmt|;
block|}
name|varybuf
index|[
name|subindx
index|]
operator|=
name|newvalue
expr_stmt|;
block|}
end_function

end_unit


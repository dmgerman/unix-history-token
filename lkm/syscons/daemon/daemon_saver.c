begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1997 Sandro Sigala, Brescia, Italy.  * Copyright (c) 1997 Chris Shenton  * Copyright (c) 1995 S ren Schmidt  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  *	$Id: daemon_saver.c,v 1.6 1997/07/15 14:49:16 yokota Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/exec.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/lkm.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<i386/include/pc/display.h>
end_include

begin_include
include|#
directive|include
file|<saver.h>
end_include

begin_define
define|#
directive|define
name|CONSOLE_VECT
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
define|\
value|((u_short*)(Crtat + (y)*cur_console->xsize + (x)))
end_define

begin_define
define|#
directive|define
name|DAEMON_MAX_WIDTH
value|32
end_define

begin_define
define|#
directive|define
name|DAEMON_MAX_HEIGHT
value|19
end_define

begin_expr_stmt
name|MOD_MISC
argument_list|(
name|daemon_saver
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|message
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|messagelen
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Who is the author of this ASCII pic? */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|daemon_pic
index|[]
init|=
block|{
literal|"             ,        ,"
block|,
literal|"            /(        )`"
block|,
literal|"            \\ \\___   / |"
block|,
literal|"            /- _  `-/  '"
block|,
literal|"           (/\\/ \\ \\   /\\"
block|,
literal|"           / /   | `    \\"
block|,
literal|"           O O   ) /    |"
block|,
literal|"           `-^--'`<     '"
block|,
literal|"          (_.)  _  )   /"
block|,
literal|"           `.___/`    /"
block|,
literal|"             `-----' /"
block|,
literal|"<----.     __ / __   \\"
block|,
literal|"<----|====O)))==) \\) /===="
block|,
literal|"<----'    `--' `.__,' \\"
block|,
literal|"             |        |"
block|,
literal|"              \\       /       /\\"
block|,
literal|"         ______( (_  / \\______/"
block|,
literal|"       ,'  ,-----'   |"
block|,
literal|"       `--{__________)"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|daemon_attr
index|[]
init|=
block|{
literal|"             R        R"
block|,
literal|"            RR        RR"
block|,
literal|"            R RRRR   R R"
block|,
literal|"            RR W  RRR  R"
block|,
literal|"           RWWW W R   RR"
block|,
literal|"           W W   W R    R"
block|,
literal|"           B B   W R    R"
block|,
literal|"           WWWWWWRR     R"
block|,
literal|"          RRRR  R  R   R"
block|,
literal|"           RRRRRRR    R"
block|,
literal|"             RRRRRRR R"
block|,
literal|"YYYYYY     RR R RR   R"
block|,
literal|"YYYYYYYYYYRRRRYYR RR RYYYY"
block|,
literal|"YYYYYY    RRRR RRRRRR R"
block|,
literal|"             R        R"
block|,
literal|"              R       R       RR"
block|,
literal|"         CCCCCCR RR  R RRRRRRRR"
block|,
literal|"       CC  CCCCCCC   C"
block|,
literal|"       CCCCCCCCCCCCCCC"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Reverse a graphics character, or return unaltered if no mirror;  * should do alphanumerics too, but I'm too lazy.<cshenton@it.hq.nasa.gov>  */
end_comment

begin_function
specifier|static
name|char
name|xflip_symbol
parameter_list|(
name|char
name|symbol
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|lchars
index|[]
init|=
literal|"`'(){}[]\\/<>"
decl_stmt|;
specifier|static
specifier|const
name|char
name|rchars
index|[]
init|=
literal|"'`)(}{][/\\><"
decl_stmt|;
name|int
name|pos
decl_stmt|;
for|for
control|(
name|pos
operator|=
literal|0
init|;
name|lchars
index|[
name|pos
index|]
operator|!=
literal|'\0'
condition|;
name|pos
operator|++
control|)
if|if
condition|(
name|lchars
index|[
name|pos
index|]
operator|==
name|symbol
condition|)
return|return
name|rchars
index|[
name|pos
index|]
return|;
return|return
name|symbol
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_daemon
parameter_list|(
name|int
name|xpos
parameter_list|,
name|int
name|ypos
parameter_list|,
name|int
name|dxdir
parameter_list|,
name|int
name|xoff
parameter_list|,
name|int
name|yoff
parameter_list|,
name|int
name|xlen
parameter_list|,
name|int
name|ylen
parameter_list|)
block|{
name|int
name|y
decl_stmt|;
if|if
condition|(
name|xlen
operator|<=
literal|0
condition|)
return|return;
for|for
control|(
name|y
operator|=
name|yoff
init|;
name|y
operator|<
name|ylen
condition|;
name|y
operator|++
control|)
name|fillw
argument_list|(
operator|(
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
operator|)
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|CONSOLE_VECT
argument_list|(
name|xpos
operator|+
name|xoff
argument_list|,
name|ypos
operator|+
name|y
argument_list|)
argument_list|,
name|xlen
operator|-
name|xoff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|draw_daemon
parameter_list|(
name|int
name|xpos
parameter_list|,
name|int
name|ypos
parameter_list|,
name|int
name|dxdir
parameter_list|,
name|int
name|xoff
parameter_list|,
name|int
name|yoff
parameter_list|,
name|int
name|xlen
parameter_list|,
name|int
name|ylen
parameter_list|)
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|px
decl_stmt|;
name|int
name|attr
decl_stmt|;
for|for
control|(
name|y
operator|=
name|yoff
init|;
name|y
operator|<
name|ylen
condition|;
name|y
operator|++
control|)
block|{
if|if
condition|(
name|dxdir
operator|<
literal|0
condition|)
name|px
operator|=
name|xoff
expr_stmt|;
else|else
name|px
operator|=
name|DAEMON_MAX_WIDTH
operator|-
name|xlen
expr_stmt|;
if|if
condition|(
name|px
operator|>=
name|strlen
argument_list|(
name|daemon_pic
index|[
name|y
index|]
argument_list|)
condition|)
continue|continue;
for|for
control|(
name|x
operator|=
name|xoff
init|;
operator|(
name|x
operator|<
name|xlen
operator|)
operator|&&
operator|(
name|daemon_pic
index|[
name|y
index|]
index|[
name|px
index|]
operator|!=
literal|'\0'
operator|)
condition|;
name|x
operator|++
operator|,
name|px
operator|++
control|)
block|{
switch|switch
condition|(
name|daemon_attr
index|[
name|y
index|]
index|[
name|px
index|]
condition|)
block|{
case|case
literal|'R'
case|:
name|attr
operator|=
operator|(
name|FG_LIGHTRED
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|'Y'
case|:
name|attr
operator|=
operator|(
name|FG_YELLOW
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|attr
operator|=
operator|(
name|FG_LIGHTBLUE
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|'W'
case|:
name|attr
operator|=
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|attr
operator|=
operator|(
name|FG_CYAN
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
default|default:
name|attr
operator|=
operator|(
name|FG_WHITE
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|dxdir
operator|<
literal|0
condition|)
block|{
comment|/* Moving left */
operator|*
name|CONSOLE_VECT
argument_list|(
name|xpos
operator|+
name|x
argument_list|,
name|ypos
operator|+
name|y
argument_list|)
operator|=
name|scr_map
index|[
name|daemon_pic
index|[
name|y
index|]
index|[
name|px
index|]
index|]
operator||
name|attr
expr_stmt|;
block|}
else|else
block|{
comment|/* Moving right */
operator|*
name|CONSOLE_VECT
argument_list|(
name|xpos
operator|+
name|DAEMON_MAX_WIDTH
operator|-
name|px
operator|-
literal|1
argument_list|,
name|ypos
operator|+
name|y
argument_list|)
operator|=
name|scr_map
index|[
name|xflip_symbol
argument_list|(
name|daemon_pic
index|[
name|y
index|]
index|[
name|px
index|]
argument_list|)
index|]
operator||
name|attr
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|clear_string
parameter_list|(
name|int
name|xpos
parameter_list|,
name|int
name|ypos
parameter_list|,
name|int
name|xoff
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|int
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<=
literal|0
condition|)
return|return;
name|fillw
argument_list|(
operator|(
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
operator|)
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|CONSOLE_VECT
argument_list|(
name|xpos
operator|+
name|xoff
argument_list|,
name|ypos
argument_list|)
argument_list|,
name|len
operator|-
name|xoff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|draw_string
parameter_list|(
name|int
name|xpos
parameter_list|,
name|int
name|ypos
parameter_list|,
name|int
name|xoff
parameter_list|,
name|char
modifier|*
name|s
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|x
decl_stmt|;
for|for
control|(
name|x
operator|=
name|xoff
init|;
name|x
operator|<
name|len
condition|;
name|x
operator|++
control|)
operator|*
name|CONSOLE_VECT
argument_list|(
name|xpos
operator|+
name|x
argument_list|,
name|ypos
argument_list|)
operator|=
name|scr_map
index|[
name|s
index|[
name|x
index|]
index|]
operator||
operator|(
name|FG_LIGHTGREEN
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|daemon_saver
parameter_list|(
name|int
name|blank
parameter_list|)
block|{
specifier|static
name|int
name|txpos
init|=
literal|10
decl_stmt|,
name|typos
init|=
literal|10
decl_stmt|;
specifier|static
name|int
name|txdir
init|=
operator|-
literal|1
decl_stmt|,
name|tydir
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|int
name|dxpos
init|=
literal|0
decl_stmt|,
name|dypos
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|dxdir
init|=
literal|1
decl_stmt|,
name|dydir
init|=
literal|1
decl_stmt|;
specifier|static
name|int
name|moved_daemon
init|=
literal|0
decl_stmt|;
specifier|static
name|int
name|xoff
decl_stmt|,
name|yoff
decl_stmt|,
name|toff
decl_stmt|;
specifier|static
name|int
name|xlen
decl_stmt|,
name|ylen
decl_stmt|,
name|tlen
decl_stmt|;
name|scr_stat
modifier|*
name|scp
init|=
name|cur_console
decl_stmt|;
name|int
name|min
decl_stmt|,
name|max
decl_stmt|;
if|if
condition|(
name|blank
condition|)
block|{
if|if
condition|(
name|scrn_blanked
operator|==
literal|0
condition|)
block|{
comment|/* clear the screen and set the border color */
name|fillw
argument_list|(
operator|(
operator|(
name|FG_LIGHTGREY
operator||
name|BG_BLACK
operator|)
operator|<<
literal|8
operator|)
operator||
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|Crtat
argument_list|,
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ysize
argument_list|)
expr_stmt|;
name|set_border
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|xlen
operator|=
name|ylen
operator|=
name|tlen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|scrn_blanked
operator|++
operator|<
literal|2
condition|)
return|return;
name|scrn_blanked
operator|=
literal|1
expr_stmt|;
name|clear_daemon
argument_list|(
name|dxpos
argument_list|,
name|dypos
argument_list|,
name|dxdir
argument_list|,
name|xoff
argument_list|,
name|yoff
argument_list|,
name|xlen
argument_list|,
name|ylen
argument_list|)
expr_stmt|;
name|clear_string
argument_list|(
name|txpos
argument_list|,
name|typos
argument_list|,
name|toff
argument_list|,
operator|(
name|char
operator|*
operator|)
name|message
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|moved_daemon
condition|)
block|{
comment|/* 			 * The daemon picture may be off the screen, if 			 * screen size is chagened while the screen 			 * saver is inactive. Make sure the origin of 			 * the picture is between min and max. 			 */
if|if
condition|(
name|scp
operator|->
name|xsize
operator|<=
name|DAEMON_MAX_WIDTH
condition|)
block|{
comment|/* 				 * If the screen width is too narrow, we 				 * allow part of the picture go off 				 * the screen so that the daemon won't 				 * flip too often. 				 */
name|min
operator|=
name|scp
operator|->
name|xsize
operator|-
name|DAEMON_MAX_WIDTH
operator|-
literal|10
expr_stmt|;
name|max
operator|=
literal|10
expr_stmt|;
block|}
else|else
block|{
name|min
operator|=
literal|0
expr_stmt|;
name|max
operator|=
name|scp
operator|->
name|xsize
operator|-
name|DAEMON_MAX_WIDTH
expr_stmt|;
block|}
if|if
condition|(
name|dxpos
operator|<=
name|min
condition|)
block|{
name|dxpos
operator|=
name|min
expr_stmt|;
name|dxdir
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dxpos
operator|>=
name|max
condition|)
block|{
name|dxpos
operator|=
name|max
expr_stmt|;
name|dxdir
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|scp
operator|->
name|ysize
operator|<=
name|DAEMON_MAX_HEIGHT
condition|)
block|{
name|min
operator|=
name|scp
operator|->
name|ysize
operator|-
name|DAEMON_MAX_HEIGHT
operator|-
literal|10
expr_stmt|;
name|max
operator|=
literal|10
expr_stmt|;
block|}
else|else
block|{
name|min
operator|=
literal|0
expr_stmt|;
name|max
operator|=
name|scp
operator|->
name|ysize
operator|-
name|DAEMON_MAX_HEIGHT
expr_stmt|;
block|}
if|if
condition|(
name|dypos
operator|<=
name|min
condition|)
block|{
name|dypos
operator|=
name|min
expr_stmt|;
name|dydir
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dypos
operator|>=
name|max
condition|)
block|{
name|dypos
operator|=
name|max
expr_stmt|;
name|dydir
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|moved_daemon
operator|=
operator|-
literal|1
expr_stmt|;
name|dxpos
operator|+=
name|dxdir
expr_stmt|;
name|dypos
operator|+=
name|dydir
expr_stmt|;
comment|/* clip the picture */
name|xoff
operator|=
literal|0
expr_stmt|;
name|xlen
operator|=
name|DAEMON_MAX_WIDTH
expr_stmt|;
if|if
condition|(
name|dxpos
operator|+
name|xlen
operator|<=
literal|0
condition|)
name|xlen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dxpos
operator|<
literal|0
condition|)
name|xoff
operator|=
operator|-
name|dxpos
expr_stmt|;
if|if
condition|(
name|dxpos
operator|>=
name|scp
operator|->
name|xsize
condition|)
name|xlen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dxpos
operator|+
name|xlen
operator|>
name|scp
operator|->
name|xsize
condition|)
name|xlen
operator|=
name|scp
operator|->
name|xsize
operator|-
name|dxpos
expr_stmt|;
name|yoff
operator|=
literal|0
expr_stmt|;
name|ylen
operator|=
name|DAEMON_MAX_HEIGHT
expr_stmt|;
if|if
condition|(
name|dypos
operator|+
name|ylen
operator|<=
literal|0
condition|)
name|ylen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dypos
operator|<
literal|0
condition|)
name|yoff
operator|=
operator|-
name|dypos
expr_stmt|;
if|if
condition|(
name|dypos
operator|>=
name|scp
operator|->
name|ysize
condition|)
name|ylen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|dypos
operator|+
name|ylen
operator|>
name|scp
operator|->
name|ysize
condition|)
name|ylen
operator|=
name|scp
operator|->
name|ysize
operator|-
name|dypos
expr_stmt|;
block|}
if|if
condition|(
name|scp
operator|->
name|xsize
operator|<=
name|messagelen
condition|)
block|{
name|min
operator|=
name|scp
operator|->
name|xsize
operator|-
name|messagelen
operator|-
literal|10
expr_stmt|;
name|max
operator|=
literal|10
expr_stmt|;
block|}
else|else
block|{
name|min
operator|=
literal|0
expr_stmt|;
name|max
operator|=
name|scp
operator|->
name|xsize
operator|-
name|messagelen
expr_stmt|;
block|}
if|if
condition|(
name|txpos
operator|<=
name|min
condition|)
block|{
name|txpos
operator|=
name|min
expr_stmt|;
name|txdir
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|txpos
operator|>=
name|max
condition|)
block|{
name|txpos
operator|=
name|max
expr_stmt|;
name|txdir
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|typos
operator|<=
literal|0
condition|)
block|{
name|typos
operator|=
literal|0
expr_stmt|;
name|tydir
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|typos
operator|>=
name|scp
operator|->
name|ysize
operator|-
literal|1
condition|)
block|{
name|typos
operator|=
name|scp
operator|->
name|ysize
operator|-
literal|1
expr_stmt|;
name|tydir
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|txpos
operator|+=
name|txdir
expr_stmt|;
name|typos
operator|+=
name|tydir
expr_stmt|;
name|toff
operator|=
literal|0
expr_stmt|;
name|tlen
operator|=
name|messagelen
expr_stmt|;
if|if
condition|(
name|txpos
operator|+
name|tlen
operator|<=
literal|0
condition|)
name|tlen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|txpos
operator|<
literal|0
condition|)
name|toff
operator|=
operator|-
name|txpos
expr_stmt|;
if|if
condition|(
name|txpos
operator|>=
name|scp
operator|->
name|xsize
condition|)
name|tlen
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|txpos
operator|+
name|tlen
operator|>
name|scp
operator|->
name|xsize
condition|)
name|tlen
operator|=
name|scp
operator|->
name|xsize
operator|-
name|txpos
expr_stmt|;
name|draw_daemon
argument_list|(
name|dxpos
argument_list|,
name|dypos
argument_list|,
name|dxdir
argument_list|,
name|xoff
argument_list|,
name|yoff
argument_list|,
name|xlen
argument_list|,
name|ylen
argument_list|)
expr_stmt|;
name|draw_string
argument_list|(
name|txpos
argument_list|,
name|typos
argument_list|,
name|toff
argument_list|,
operator|(
name|char
operator|*
operator|)
name|message
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|scrn_blanked
operator|>
literal|0
condition|)
block|{
name|set_border
argument_list|(
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
name|scrn_blanked
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|daemon_saver_load
parameter_list|(
name|struct
name|lkm_table
modifier|*
name|lkmtp
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|messagelen
operator|=
name|strlen
argument_list|(
name|hostname
argument_list|)
operator|+
literal|3
operator|+
name|strlen
argument_list|(
name|ostype
argument_list|)
operator|+
literal|1
operator|+
name|strlen
argument_list|(
name|osrelease
argument_list|)
expr_stmt|;
name|message
operator|=
name|malloc
argument_list|(
name|messagelen
operator|+
literal|1
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|message
argument_list|,
literal|"%s - %s %s"
argument_list|,
name|hostname
argument_list|,
name|ostype
argument_list|,
name|osrelease
argument_list|)
expr_stmt|;
name|err
operator|=
name|add_scrn_saver
argument_list|(
name|daemon_saver
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
name|free
argument_list|(
name|message
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|daemon_saver_unload
parameter_list|(
name|struct
name|lkm_table
modifier|*
name|lkmtp
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|remove_scrn_saver
argument_list|(
name|daemon_saver
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|free
argument_list|(
name|message
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|daemon_saver_mod
parameter_list|(
name|struct
name|lkm_table
modifier|*
name|lkmtp
parameter_list|,
name|int
name|cmd
parameter_list|,
name|int
name|ver
parameter_list|)
block|{
name|MOD_DISPATCH
argument_list|(
name|daemon_saver
argument_list|,
name|lkmtp
argument_list|,
name|cmd
argument_list|,
name|ver
argument_list|,
name|daemon_saver_load
argument_list|,
name|daemon_saver_unload
argument_list|,
name|lkm_nullcmd
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


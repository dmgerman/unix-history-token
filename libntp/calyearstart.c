begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * calyearstart - determine the NTP time at midnight of January 1 in  *		  the year of the given date.  */
end_comment

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_assert.h"
end_include

begin_comment
comment|/*  * Juergen Perlinger, 2010-05-02  *  * Redone in terms of the calendar functions. It's rather simple:  * - expand the NTP time stamp  * - split into days and seconds since midnight, dropping the partial day  * - get full number of days before year start in NTP epoch  * - convert to seconds, truncated to 32 bits.  */
end_comment

begin_function
name|u_int32
name|calyearstart
parameter_list|(
name|u_int32
name|ntptime
parameter_list|,
specifier|const
name|time_t
modifier|*
name|pivot
parameter_list|)
block|{
name|u_int32
name|ndays
decl_stmt|;
comment|/* elapsed days since NTP starts */
name|vint64
name|vlong
decl_stmt|;
name|ntpcal_split
name|split
decl_stmt|;
name|vlong
operator|=
name|ntpcal_ntp_to_ntp
argument_list|(
name|ntptime
argument_list|,
name|pivot
argument_list|)
expr_stmt|;
name|split
operator|=
name|ntpcal_daysplit
argument_list|(
operator|&
name|vlong
argument_list|)
expr_stmt|;
name|ndays
operator|=
name|ntpcal_rd_to_ystart
argument_list|(
name|split
operator|.
name|hi
operator|+
name|DAY_NTP_STARTS
argument_list|)
operator|-
name|DAY_NTP_STARTS
expr_stmt|;
return|return
call|(
name|u_int32
call|)
argument_list|(
name|ndays
operator|*
name|SECSPERDAY
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * calmonthstart - get NTP time at midnight of the first day of the  * current month.  */
end_comment

begin_function
name|u_int32
name|calmonthstart
parameter_list|(
name|u_int32
name|ntptime
parameter_list|,
specifier|const
name|time_t
modifier|*
name|pivot
parameter_list|)
block|{
name|u_int32
name|ndays
decl_stmt|;
comment|/* elapsed days since NTP starts */
name|vint64
name|vlong
decl_stmt|;
name|ntpcal_split
name|split
decl_stmt|;
name|vlong
operator|=
name|ntpcal_ntp_to_ntp
argument_list|(
name|ntptime
argument_list|,
name|pivot
argument_list|)
expr_stmt|;
name|split
operator|=
name|ntpcal_daysplit
argument_list|(
operator|&
name|vlong
argument_list|)
expr_stmt|;
name|ndays
operator|=
name|ntpcal_rd_to_mstart
argument_list|(
name|split
operator|.
name|hi
operator|+
name|DAY_NTP_STARTS
argument_list|)
operator|-
name|DAY_NTP_STARTS
expr_stmt|;
return|return
call|(
name|u_int32
call|)
argument_list|(
name|ndays
operator|*
name|SECSPERDAY
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * calweekstart - get NTP time at midnight of the last monday on or  * before the current date.  */
end_comment

begin_function
name|u_int32
name|calweekstart
parameter_list|(
name|u_int32
name|ntptime
parameter_list|,
specifier|const
name|time_t
modifier|*
name|pivot
parameter_list|)
block|{
name|u_int32
name|ndays
decl_stmt|;
comment|/* elapsed days since NTP starts */
name|vint64
name|vlong
decl_stmt|;
name|ntpcal_split
name|split
decl_stmt|;
name|vlong
operator|=
name|ntpcal_ntp_to_ntp
argument_list|(
name|ntptime
argument_list|,
name|pivot
argument_list|)
expr_stmt|;
name|split
operator|=
name|ntpcal_daysplit
argument_list|(
operator|&
name|vlong
argument_list|)
expr_stmt|;
name|ndays
operator|=
name|ntpcal_weekday_le
argument_list|(
name|split
operator|.
name|hi
operator|+
name|DAY_NTP_STARTS
argument_list|,
name|CAL_MONDAY
argument_list|)
operator|-
name|DAY_NTP_STARTS
expr_stmt|;
return|return
call|(
name|u_int32
call|)
argument_list|(
name|ndays
operator|*
name|SECSPERDAY
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * caldaystart - get NTP time at midnight of the current day.  */
end_comment

begin_function
name|u_int32
name|caldaystart
parameter_list|(
name|u_int32
name|ntptime
parameter_list|,
specifier|const
name|time_t
modifier|*
name|pivot
parameter_list|)
block|{
name|vint64
name|vlong
decl_stmt|;
name|ntpcal_split
name|split
decl_stmt|;
name|vlong
operator|=
name|ntpcal_ntp_to_ntp
argument_list|(
name|ntptime
argument_list|,
name|pivot
argument_list|)
expr_stmt|;
name|split
operator|=
name|ntpcal_daysplit
argument_list|(
operator|&
name|vlong
argument_list|)
expr_stmt|;
return|return
name|ntptime
operator|-
name|split
operator|.
name|lo
return|;
block|}
end_function

end_unit


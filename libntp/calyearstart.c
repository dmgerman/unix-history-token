begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * calyearstart - determine the NTP time at midnight of January 1 in  *		  the year of the given date.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"ntp_types.h"
end_include

begin_include
include|#
directive|include
file|"ntp_calendar.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_assert.h"
end_include

begin_comment
comment|/*  * Juergen Perlinger, 2008-11-12  * Use the result of 'caljulian' to get the delta from the time stamp to the  * beginning of the year. Do not make a second trip through 'caltontp' after  * fixing the date, apart for invariant tests.  */
end_comment

begin_function
name|u_long
name|calyearstart
parameter_list|(
name|u_long
name|ntp_time
parameter_list|)
block|{
name|struct
name|calendar
name|jt
decl_stmt|;
name|ntp_u_int32_t
name|delta
decl_stmt|;
name|caljulian
argument_list|(
name|ntp_time
argument_list|,
operator|&
name|jt
argument_list|)
expr_stmt|;
comment|/* 	* Now we have days since yearstart (unity-based) and the time in that 	* day. Simply merge these together to seconds and subtract that from 	* input time. That's faster than going through the calendar stuff 	* again... 	*/
name|delta
operator|=
operator|(
name|ntp_u_int32_t
operator|)
name|jt
operator|.
name|yearday
operator|*
name|SECSPERDAY
operator|+
operator|(
name|ntp_u_int32_t
operator|)
name|jt
operator|.
name|hour
operator|*
name|MINSPERHR
operator|*
name|SECSPERMIN
operator|+
operator|(
name|ntp_u_int32_t
operator|)
name|jt
operator|.
name|minute
operator|*
name|SECSPERMIN
operator|+
operator|(
name|ntp_u_int32_t
operator|)
name|jt
operator|.
name|second
operator|-
name|SECSPERDAY
expr_stmt|;
comment|/* yearday is unity-based... */
if|#
directive|if
name|ISC_CHECK_INVARIANT
comment|/* 	 * check that this computes properly: do a roundtrip! That's the only 	 * sensible test here, but it's a rather expensive invariant... 	 */
name|jt
operator|.
name|yearday
operator|=
literal|0
expr_stmt|;
name|jt
operator|.
name|month
operator|=
literal|1
expr_stmt|;
name|jt
operator|.
name|monthday
operator|=
literal|1
expr_stmt|;
name|jt
operator|.
name|hour
operator|=
literal|0
expr_stmt|;
name|jt
operator|.
name|minute
operator|=
literal|0
expr_stmt|;
name|jt
operator|.
name|second
operator|=
literal|0
expr_stmt|;
name|NTP_INVARIANT
argument_list|(
call|(
name|ntp_u_int32_t
call|)
argument_list|(
name|caltontp
argument_list|(
operator|&
name|jt
argument_list|)
operator|+
name|delta
argument_list|)
operator|==
operator|(
name|ntp_u_int32_t
operator|)
name|ntp_time
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* The NTP time stamps (l_fp) count seconds unsigned mod 2**32, so we 	 * have to calculate this in the proper way! 	 */
return|return
call|(
name|ntp_u_int32_t
call|)
argument_list|(
name|ntp_time
operator|-
name|delta
argument_list|)
return|;
block|}
end_function

end_unit


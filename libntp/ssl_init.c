begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ssl_init.c	Common OpenSSL initialization code for the various  *		programs which use it.  *  * Moved from ntpd/ntp_crypto.c crypto_setup()  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<ntp.h>
end_include

begin_include
include|#
directive|include
file|<ntp_debug.h>
end_include

begin_include
include|#
directive|include
file|<lib_strbuf.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL
end_ifdef

begin_include
include|#
directive|include
file|"openssl/err.h"
end_include

begin_include
include|#
directive|include
file|"openssl/evp.h"
end_include

begin_function_decl
name|void
name|atexit_ssl_cleanup
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|ssl_init_done
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ssl_init
parameter_list|(
name|void
parameter_list|)
block|{
name|init_lib
argument_list|()
expr_stmt|;
if|if
condition|(
name|ssl_init_done
condition|)
return|return;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
name|OpenSSL_add_all_algorithms
argument_list|()
expr_stmt|;
name|atexit
argument_list|(
operator|&
name|atexit_ssl_cleanup
argument_list|)
expr_stmt|;
name|ssl_init_done
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|atexit_ssl_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ssl_init_done
condition|)
return|return;
name|ssl_init_done
operator|=
name|FALSE
expr_stmt|;
name|EVP_cleanup
argument_list|()
expr_stmt|;
name|ERR_free_strings
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ssl_check_version
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|(
name|SSLeay
argument_list|()
operator|^
name|OPENSSL_VERSION_NUMBER
operator|)
operator|&
operator|~
literal|0xff0L
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_WARNING
argument_list|,
literal|"OpenSSL version mismatch. Built against %lx, you have %lx"
argument_list|,
operator|(
name|u_long
operator|)
name|OPENSSL_VERSION_NUMBER
argument_list|,
name|SSLeay
argument_list|()
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"OpenSSL version mismatch. Built against %lx, you have %lx\n"
argument_list|,
operator|(
name|u_long
operator|)
name|OPENSSL_VERSION_NUMBER
argument_list|,
name|SSLeay
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|INIT_SSL
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL */
end_comment

begin_comment
comment|/*  * keytype_from_text	returns OpenSSL NID for digest by name, and  *			optionally the associated digest length.  *  * Used by ntpd authreadkeys(), ntpq and ntpdc keytype()  */
end_comment

begin_function
name|int
name|keytype_from_text
parameter_list|(
specifier|const
name|char
modifier|*
name|text
parameter_list|,
name|size_t
modifier|*
name|pdigest_len
parameter_list|)
block|{
name|int
name|key_type
decl_stmt|;
name|u_int
name|digest_len
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL
specifier|const
name|u_long
name|max_digest_len
init|=
name|MAX_MAC_LEN
operator|-
sizeof|sizeof
argument_list|(
name|keyid_t
argument_list|)
decl_stmt|;
name|u_char
name|digest
index|[
name|EVP_MAX_MD_SIZE
index|]
decl_stmt|;
name|char
modifier|*
name|upcased
decl_stmt|;
name|char
modifier|*
name|pch
decl_stmt|;
name|EVP_MD_CTX
name|ctx
decl_stmt|;
comment|/* 	 * OpenSSL digest short names are capitalized, so uppercase the 	 * digest name before passing to OBJ_sn2nid().  If it is not 	 * recognized but begins with 'M' use NID_md5 to be consistent 	 * with past behavior. 	 */
name|INIT_SSL
argument_list|()
expr_stmt|;
name|LIB_GETBUF
argument_list|(
name|upcased
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|upcased
argument_list|,
name|text
argument_list|,
name|LIB_BUFLENGTH
argument_list|)
expr_stmt|;
for|for
control|(
name|pch
operator|=
name|upcased
init|;
literal|'\0'
operator|!=
operator|*
name|pch
condition|;
name|pch
operator|++
control|)
operator|*
name|pch
operator|=
operator|(
name|char
operator|)
name|toupper
argument_list|(
operator|*
name|pch
argument_list|)
expr_stmt|;
name|key_type
operator|=
name|OBJ_sn2nid
argument_list|(
name|upcased
argument_list|)
expr_stmt|;
else|#
directive|else
name|key_type
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|key_type
operator|&&
literal|'m'
operator|==
name|tolower
argument_list|(
name|text
index|[
literal|0
index|]
argument_list|)
condition|)
name|key_type
operator|=
name|NID_md5
expr_stmt|;
if|if
condition|(
operator|!
name|key_type
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|NULL
operator|!=
name|pdigest_len
condition|)
block|{
ifdef|#
directive|ifdef
name|OPENSSL
name|EVP_DigestInit
argument_list|(
operator|&
name|ctx
argument_list|,
name|EVP_get_digestbynid
argument_list|(
name|key_type
argument_list|)
argument_list|)
expr_stmt|;
name|EVP_DigestFinal
argument_list|(
operator|&
name|ctx
argument_list|,
name|digest
argument_list|,
operator|&
name|digest_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|digest_len
operator|>
name|max_digest_len
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"key type %s %u octet digests are too big, max %lu\n"
argument_list|,
name|keytype_name
argument_list|(
name|key_type
argument_list|)
argument_list|,
name|digest_len
argument_list|,
name|max_digest_len
argument_list|)
expr_stmt|;
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"key type %s %u octet digests are too big, max %lu"
argument_list|,
name|keytype_name
argument_list|(
name|key_type
argument_list|)
argument_list|,
name|digest_len
argument_list|,
name|max_digest_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|#
directive|else
name|digest_len
operator|=
literal|16
expr_stmt|;
endif|#
directive|endif
operator|*
name|pdigest_len
operator|=
name|digest_len
expr_stmt|;
block|}
return|return
name|key_type
return|;
block|}
end_function

begin_comment
comment|/*  * keytype_name		returns OpenSSL short name for digest by NID.  *  * Used by ntpq and ntpdc keytype()  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|keytype_name
parameter_list|(
name|int
name|nid
parameter_list|)
block|{
specifier|static
specifier|const
name|char
name|unknown_type
index|[]
init|=
literal|"(unknown key type)"
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
ifdef|#
directive|ifdef
name|OPENSSL
name|INIT_SSL
argument_list|()
expr_stmt|;
name|name
operator|=
name|OBJ_nid2sn
argument_list|(
name|nid
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|==
name|name
condition|)
name|name
operator|=
name|unknown_type
expr_stmt|;
else|#
directive|else
comment|/* !OPENSSL follows */
if|if
condition|(
name|NID_md5
operator|==
name|nid
condition|)
name|name
operator|=
literal|"MD5"
expr_stmt|;
else|else
name|name
operator|=
name|unknown_type
expr_stmt|;
endif|#
directive|endif
return|return
name|name
return|;
block|}
end_function

begin_comment
comment|/*  * Use getpassphrase() if configure.ac detected it, as Suns that  * have it truncate the password in getpass() to 8 characters.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_GETPASSPHRASE
end_ifdef

begin_define
define|#
directive|define
name|getpass
parameter_list|(
name|str
parameter_list|)
value|getpassphrase(str)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * getpass_keytype() -- shared between ntpq and ntpdc, only vaguely  *			related to the rest of ssl_init.c.  */
end_comment

begin_function
name|char
modifier|*
name|getpass_keytype
parameter_list|(
name|int
name|keytype
parameter_list|)
block|{
name|char
name|pass_prompt
index|[
literal|64
operator|+
literal|11
operator|+
literal|1
index|]
decl_stmt|;
comment|/* 11 for " Password: " */
name|snprintf
argument_list|(
name|pass_prompt
argument_list|,
sizeof|sizeof
argument_list|(
name|pass_prompt
argument_list|)
argument_list|,
literal|"%.64s Password: "
argument_list|,
name|keytype_name
argument_list|(
name|keytype
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|getpass
argument_list|(
name|pass_prompt
argument_list|)
return|;
block|}
end_function

end_unit


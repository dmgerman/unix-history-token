begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * audio.c - audio interface for reference clock audio drivers  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|<config.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SYS_AUDIOIO_H
argument_list|)
operator|||
name|defined
argument_list|(
name|HAVE_SUN_AUDIOIO_H
argument_list|)
operator|||
expr|\
name|defined
argument_list|(
name|HAVE_SYS_SOUNDCARD_H
argument_list|)
operator|||
name|defined
argument_list|(
name|HAVE_MACHINE_SOUNDCARD_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|"audio.h"
end_include

begin_include
include|#
directive|include
file|"ntp_stdlib.h"
end_include

begin_include
include|#
directive|include
file|"ntp_syslog.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_UNISTD_H
end_ifdef

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"ntp_string.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_AUDIOIO_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/audioio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SYS_AUDIOIO_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SUN_AUDIOIO_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sun/audioio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SUN_AUDIOIO_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_IOCTL_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SYS_IOCTL_H */
end_comment

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_MACHINE_SOUNDCARD_H
end_ifdef

begin_include
include|#
directive|include
file|<machine/soundcard.h>
end_include

begin_define
define|#
directive|define
name|PCM_STYLE_SOUND
end_define

begin_else
else|#
directive|else
end_else

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_SOUNDCARD_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/soundcard.h>
end_include

begin_define
define|#
directive|define
name|PCM_STYLE_SOUND
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
end_ifdef

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Global variables  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_AUDIOIO_H
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|audio_device
name|device
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* audio device ident */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SYS_AUDIOIO_H */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
end_ifdef

begin_define
define|#
directive|define
name|INIT_FILE
value|"/etc/ntp.audio"
end_define

begin_decl_stmt
name|int
name|agc
init|=
name|SOUND_MIXER_WRITE_RECLEV
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* or IGAIN or LINE */
end_comment

begin_decl_stmt
name|int
name|monitor
init|=
name|SOUND_MIXER_WRITE_VOLUME
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* or OGAIN */
end_comment

begin_decl_stmt
name|int
name|devmask
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|recmask
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|cf_c_dev
index|[
literal|100
index|]
decl_stmt|,
name|cf_i_dev
index|[
literal|100
index|]
decl_stmt|,
name|cf_agc
index|[
literal|100
index|]
decl_stmt|,
name|cf_monitor
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|const
name|char
modifier|*
name|m_names
index|[
name|SOUND_MIXER_NRDEVICES
index|]
init|=
name|SOUND_DEVICE_NAMES
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* not PCM_STYLE_SOUND */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|audio_info
name|info
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* audio device info */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not PCM_STYLE_SOUND */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ctl_fd
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* audio control file descriptor */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
end_ifdef

begin_decl_stmt
specifier|static
name|void
name|audio_config_read
name|P
argument_list|(
operator|(
name|int
operator|,
name|char
operator|*
operator|*
operator|,
name|char
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mixer_name
name|P
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|mixer_name
parameter_list|(
specifier|const
name|char
modifier|*
name|m_name
parameter_list|,
name|int
name|m_mask
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SOUND_MIXER_NRDEVICES
condition|;
operator|++
name|i
control|)
if|if
condition|(
operator|(
operator|(
literal|1
operator|<<
name|i
operator|)
operator|&
name|m_mask
operator|)
operator|&&
operator|!
name|strcmp
argument_list|(
name|m_names
index|[
name|i
index|]
argument_list|,
name|m_name
argument_list|)
condition|)
break|break;
return|return
operator|(
name|SOUND_MIXER_NRDEVICES
operator|==
name|i
operator|)
condition|?
operator|-
literal|1
else|:
name|i
return|;
block|}
end_function

begin_comment
comment|/*  * Check:  *  * /etc/ntp.audio#	where # is the unit number  * /etc/ntp.audio.#	where # is the unit number  * /etc/ntp.audio  *  * for contents of the form:  *  * idev /dev/input_device  * cdev /dev/control_device  * agc pcm_input_device {igain,line,line1,...}  * monitor pcm_monitor_device {ogain,...}  *  * The device names for the "agc" and "monitor" keywords  * can be found by running either the "mixer" program or the  * util/audio-pcm program.  *  * Great hunks of this subroutine were swiped from refclock_oncore.c  */
end_comment

begin_function
specifier|static
name|void
name|audio_config_read
parameter_list|(
name|int
name|unit
parameter_list|,
name|char
modifier|*
modifier|*
name|c_dev
parameter_list|,
comment|/* Control device */
name|char
modifier|*
modifier|*
name|i_dev
comment|/* input device */
parameter_list|)
block|{
name|FILE
modifier|*
name|fd
decl_stmt|;
name|char
name|device
index|[
literal|20
index|]
decl_stmt|,
name|line
index|[
literal|100
index|]
decl_stmt|,
name|ab
index|[
literal|100
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"%s%d"
argument_list|,
name|INIT_FILE
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|fopen
argument_list|(
name|device
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"audio_config_read:<%s> NO\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"%s.%d"
argument_list|,
name|INIT_FILE
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|fopen
argument_list|(
name|device
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"audio_config_read:<%s> NO\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|device
argument_list|,
literal|"%s.%d"
argument_list|,
name|INIT_FILE
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|fopen
argument_list|(
name|device
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"audio_config_read:<%s> NO\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
name|printf
argument_list|(
literal|"audio_config_read: reading<%s>\n"
argument_list|,
name|device
argument_list|)
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|line
argument_list|,
sizeof|sizeof
name|line
argument_list|,
name|fd
argument_list|)
condition|)
block|{
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|cc
decl_stmt|,
modifier|*
name|ca
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Remove comments */
if|if
condition|(
operator|(
name|cp
operator|=
name|strchr
argument_list|(
name|line
argument_list|,
literal|'#'
argument_list|)
operator|)
condition|)
operator|*
name|cp
operator|=
literal|'\0'
expr_stmt|;
comment|/* Remove any trailing spaces */
for|for
control|(
name|i
operator|=
name|strlen
argument_list|(
name|line
argument_list|)
init|;
name|i
operator|>
literal|0
operator|&&
name|isascii
argument_list|(
operator|(
name|int
operator|)
name|line
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|(
name|int
operator|)
name|line
index|[
name|i
operator|-
literal|1
index|]
argument_list|)
condition|;
control|)
name|line
index|[
operator|--
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* Remove leading space */
for|for
control|(
name|cc
operator|=
name|line
init|;
operator|*
name|cc
operator|&&
name|isascii
argument_list|(
operator|(
name|int
operator|)
operator|*
name|cc
argument_list|)
operator|&&
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|cc
argument_list|)
condition|;
name|cc
operator|++
control|)
continue|continue;
comment|/* Stop if nothing left */
if|if
condition|(
operator|!
operator|*
name|cc
condition|)
continue|continue;
comment|/* Uppercase the command and find the arg */
for|for
control|(
name|ca
operator|=
name|cc
init|;
operator|*
name|ca
condition|;
name|ca
operator|++
control|)
block|{
if|if
condition|(
name|isascii
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ca
argument_list|)
condition|)
block|{
if|if
condition|(
name|islower
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ca
argument_list|)
condition|)
block|{
operator|*
name|ca
operator|=
name|toupper
argument_list|(
operator|*
name|ca
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ca
argument_list|)
operator|||
operator|(
operator|*
name|ca
operator|==
literal|'='
operator|)
condition|)
break|break;
block|}
block|}
comment|/* Remove space (and possible =) leading the arg */
for|for
control|(
init|;
operator|*
name|ca
operator|&&
name|isascii
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ca
argument_list|)
operator|&&
operator|(
name|isspace
argument_list|(
operator|(
name|int
operator|)
operator|*
name|ca
argument_list|)
operator|||
operator|(
operator|*
name|ca
operator|==
literal|'='
operator|)
operator|)
condition|;
name|ca
operator|++
control|)
continue|continue;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|cc
argument_list|,
literal|"IDEV"
argument_list|,
operator|(
name|size_t
operator|)
literal|4
argument_list|)
condition|)
block|{
name|sscanf
argument_list|(
name|ca
argument_list|,
literal|"%s"
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cf_i_dev
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"idev<%s>\n"
argument_list|,
name|ab
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|cc
argument_list|,
literal|"CDEV"
argument_list|,
operator|(
name|size_t
operator|)
literal|4
argument_list|)
condition|)
block|{
name|sscanf
argument_list|(
name|ca
argument_list|,
literal|"%s"
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cf_c_dev
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cdev<%s>\n"
argument_list|,
name|ab
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|cc
argument_list|,
literal|"AGC"
argument_list|,
operator|(
name|size_t
operator|)
literal|3
argument_list|)
condition|)
block|{
name|sscanf
argument_list|(
name|ca
argument_list|,
literal|"%s"
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cf_agc
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"agc<%s> %d\n"
argument_list|,
name|ab
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|cc
argument_list|,
literal|"MONITOR"
argument_list|,
operator|(
name|size_t
operator|)
literal|7
argument_list|)
condition|)
block|{
name|sscanf
argument_list|(
name|ca
argument_list|,
literal|"%s"
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cf_monitor
argument_list|,
name|ab
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"monitor<%s> %d\n"
argument_list|,
name|ab
argument_list|,
name|mixer_name
argument_list|(
name|ab
argument_list|,
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PCM_STYLE_SOUND */
end_comment

begin_comment
comment|/*  * audio_init - open and initialize audio device  *  * This code works with SunOS 4.x, Solaris 2.x, and PCM; however, it is  * believed generic and applicable to other systems with a minor twid  * or two. All it does is open the device, set the buffer size (Solaris  * only), preset the gain and set the input port. It assumes that the  * codec sample rate (8000 Hz), precision (8 bits), number of channels  * (1) and encoding (ITU-T G.711 mu-law companded) have been set by  * default.  */
end_comment

begin_function
name|int
name|audio_init
parameter_list|(
name|char
modifier|*
name|dname
parameter_list|,
comment|/* device name */
name|int
name|bufsiz
parameter_list|,
comment|/* buffer size */
name|int
name|unit
comment|/* device unit (0-3) */
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
define|#
directive|define
name|ACTL_DEV
value|"/dev/mixer%d"
name|char
name|actl_dev
index|[
literal|30
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_STRUCT_SND_SIZE
name|struct
name|snd_size
name|s_size
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|AIOGFMT
name|snd_chan_param
name|s_c_p
decl_stmt|;
endif|#
directive|endif
endif|#
directive|endif
name|int
name|fd
decl_stmt|;
name|int
name|rval
decl_stmt|;
name|char
modifier|*
name|actl
init|=
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
name|actl_dev
else|#
directive|else
literal|"/dev/audioctl"
endif|#
directive|endif
decl_stmt|;
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|actl_dev
argument_list|,
name|ACTL_DEV
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|audio_config_read
argument_list|(
name|unit
argument_list|,
operator|&
name|actl
argument_list|,
operator|&
name|dname
argument_list|)
expr_stmt|;
comment|/* If we have values for cf_c_dev or cf_i_dev, use them. */
if|if
condition|(
operator|*
name|cf_c_dev
condition|)
name|dname
operator|=
name|cf_c_dev
expr_stmt|;
if|if
condition|(
operator|*
name|cf_i_dev
condition|)
name|actl
operator|=
name|cf_i_dev
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * Open audio device. Do not complain if not there. 	 */
name|fd
operator|=
name|open
argument_list|(
name|dname
argument_list|,
name|O_RDWR
operator||
name|O_NONBLOCK
argument_list|,
literal|0777
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
operator|(
name|fd
operator|)
return|;
comment|/* 	 * Open audio control device. 	 */
name|ctl_fd
operator|=
name|open
argument_list|(
name|actl
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_fd
operator|<
literal|0
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"audio_init: invalid control device<%s>\n"
argument_list|,
name|actl
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|ctl_fd
operator|)
return|;
block|}
comment|/* 	 * Set audio device parameters. 	 */
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
name|printf
argument_list|(
literal|"audio_init:<%s> bufsiz %d\n"
argument_list|,
name|dname
argument_list|,
name|bufsiz
argument_list|)
expr_stmt|;
name|rval
operator|=
name|fd
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_STRUCT_SND_SIZE
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|AIOGSIZE
argument_list|,
operator|&
name|s_size
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"audio_init: AIOGSIZE: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"audio_init: orig: play_size %d, rec_size %d\n"
argument_list|,
name|s_size
operator|.
name|play_size
argument_list|,
name|s_size
operator|.
name|rec_size
argument_list|)
expr_stmt|;
name|s_size
operator|.
name|play_size
operator|=
name|s_size
operator|.
name|rec_size
operator|=
name|bufsiz
expr_stmt|;
name|printf
argument_list|(
literal|"audio_init: want: play_size %d, rec_size %d\n"
argument_list|,
name|s_size
operator|.
name|play_size
argument_list|,
name|s_size
operator|.
name|rec_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|AIOSSIZE
argument_list|,
operator|&
name|s_size
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"audio_init: AIOSSIZE: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"audio_init: set:  play_size %d, rec_size %d\n"
argument_list|,
name|s_size
operator|.
name|play_size
argument_list|,
name|s_size
operator|.
name|rec_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_STRUCT_SND_SIZE */
ifdef|#
directive|ifdef
name|AIOGFMT
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|AIOGFMT
argument_list|,
operator|&
name|s_c_p
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"audio_init: AIOGFMT: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"audio_init: play_rate %lu, rec_rate %lu, play_format %#lx, rec_format %#lx\n"
argument_list|,
name|s_c_p
operator|.
name|play_rate
argument_list|,
name|s_c_p
operator|.
name|rec_rate
argument_list|,
name|s_c_p
operator|.
name|play_format
argument_list|,
name|s_c_p
operator|.
name|rec_format
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Grab the device and record masks */
if|if
condition|(
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_READ_DEVMASK
argument_list|,
operator|&
name|devmask
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_READ_DEVMASK: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_READ_RECMASK
argument_list|,
operator|&
name|recmask
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_READ_RECMASK: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* validate and set any specified config file stuff */
if|if
condition|(
operator|*
name|cf_agc
condition|)
block|{
name|int
name|i
decl_stmt|;
name|i
operator|=
name|mixer_name
argument_list|(
name|cf_agc
argument_list|,
name|recmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
name|agc
operator|=
name|MIXER_WRITE
argument_list|(
name|i
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"input %s not in recmask %#x\n"
argument_list|,
name|cf_agc
argument_list|,
name|recmask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|cf_monitor
condition|)
block|{
name|int
name|i
decl_stmt|;
comment|/* devmask */
name|i
operator|=
name|mixer_name
argument_list|(
name|cf_monitor
argument_list|,
name|devmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
condition|)
name|monitor
operator|=
name|MIXER_WRITE
argument_list|(
name|i
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"monitor %s not in devmask %#x\n"
argument_list|,
name|cf_monitor
argument_list|,
name|devmask
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* not PCM_STYLE_SOUND */
name|AUDIO_INITINFO
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
name|info
operator|.
name|play
operator|.
name|gain
operator|=
name|AUDIO_MAX_GAIN
expr_stmt|;
name|info
operator|.
name|play
operator|.
name|port
operator|=
name|AUDIO_SPEAKER
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SYS_AUDIOIO_H
name|info
operator|.
name|record
operator|.
name|buffer_size
operator|=
name|bufsiz
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SYS_AUDIOIO_H */
name|rval
operator|=
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
operator|(
name|int
operator|)
name|AUDIO_SETINFO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|<
literal|0
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"audio: invalid control device parameters\n"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|ctl_fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
name|rval
operator|=
name|fd
expr_stmt|;
endif|#
directive|endif
comment|/* not PCM_STYLE_SOUND */
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * audio_gain - adjust codec gains and port  */
end_comment

begin_function
name|int
name|audio_gain
parameter_list|(
name|int
name|gain
parameter_list|,
comment|/* volume level (gain) 0-255 */
name|int
name|mongain
parameter_list|,
comment|/* input to output mix (monitor gain) 0-255 */
name|int
name|port
comment|/* selected I/O port: 1 mic/2 line in */
parameter_list|)
block|{
name|int
name|rval
decl_stmt|;
specifier|static
name|int
name|o_mongain
init|=
operator|-
literal|1
decl_stmt|;
specifier|static
name|int
name|o_port
init|=
operator|-
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
name|int
name|l
decl_stmt|,
name|r
decl_stmt|;
name|rval
operator|=
literal|0
expr_stmt|;
name|r
operator|=
name|l
operator|=
literal|100
operator|*
name|gain
operator|/
literal|255
expr_stmt|;
comment|/* Normalize to 0-100 */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"audio_gain: gain %d/%d\n"
argument_list|,
name|gain
argument_list|,
name|l
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* figure out what channel(s) to use. just nuke right for now. */
name|r
operator|=
literal|0
expr_stmt|;
comment|/* setting to zero nicely mutes the channel */
name|l
operator||=
name|r
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|2
condition|)
block|{
name|rval
operator|=
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_WRITE_LINE
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rval
operator|=
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_WRITE_MIC
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rval
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"audio_gain: agc write: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
if|if
condition|(
name|o_mongain
operator|!=
name|mongain
condition|)
block|{
name|r
operator|=
name|l
operator|=
literal|100
operator|*
name|mongain
operator|/
literal|255
expr_stmt|;
comment|/* Normalize to 0-100 */
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"audio_gain: mongain %d/%d\n"
argument_list|,
name|mongain
argument_list|,
name|l
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|l
operator||=
name|r
operator|<<
literal|8
expr_stmt|;
name|rval
operator|=
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_WRITE_VOLUME
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"audio_gain: mongain write: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
name|o_mongain
operator|=
name|mongain
expr_stmt|;
block|}
if|if
condition|(
name|o_port
operator|!=
name|port
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"audio_gain: port %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|l
operator|=
operator|(
literal|1
operator|<<
operator|(
operator|(
name|port
operator|==
literal|2
operator|)
condition|?
name|SOUND_MIXER_LINE
else|:
name|SOUND_MIXER_MIC
operator|)
operator|)
expr_stmt|;
name|rval
operator|=
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_WRITE_RECSRC
argument_list|,
operator|&
name|l
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|==
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"SOUND_MIXER_WRITE_RECSRC: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_READ_RECSRC
argument_list|,
operator|&
name|l
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_WRITE_RECSRC: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"audio_gain: recsrc is %d\n"
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|o_port
operator|=
name|port
expr_stmt|;
block|}
else|#
directive|else
comment|/* not PCM_STYLE_SOUND */
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
operator|(
name|int
operator|)
name|AUDIO_GETINFO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|info
argument_list|)
expr_stmt|;
name|info
operator|.
name|record
operator|.
name|encoding
operator|=
name|AUDIO_ENCODING_ULAW
expr_stmt|;
name|info
operator|.
name|record
operator|.
name|error
operator|=
literal|0
expr_stmt|;
name|info
operator|.
name|record
operator|.
name|gain
operator|=
name|gain
expr_stmt|;
if|if
condition|(
name|o_mongain
operator|!=
name|mongain
condition|)
name|o_mongain
operator|=
name|info
operator|.
name|monitor_gain
operator|=
name|mongain
expr_stmt|;
if|if
condition|(
name|o_port
operator|!=
name|port
condition|)
name|o_port
operator|=
name|info
operator|.
name|record
operator|.
name|port
operator|=
name|port
expr_stmt|;
name|rval
operator|=
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
operator|(
name|int
operator|)
name|AUDIO_SETINFO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
name|rval
operator|<
literal|0
condition|)
block|{
name|msyslog
argument_list|(
name|LOG_ERR
argument_list|,
literal|"audio_gain: %m"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rval
operator|)
return|;
block|}
name|rval
operator|=
name|info
operator|.
name|record
operator|.
name|error
expr_stmt|;
endif|#
directive|endif
comment|/* not PCM_STYLE_SOUND */
return|return
operator|(
name|rval
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * audio_show - display audio parameters  *  * This code doesn't really do anything, except satisfy curiousity and  * verify the ioctl's work.  */
end_comment

begin_function
name|void
name|audio_show
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PCM_STYLE_SOUND
name|int
name|recsrc
init|=
literal|0
decl_stmt|;
name|printf
argument_list|(
literal|"audio_show: ctl_fd %d\n"
argument_list|,
name|ctl_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
name|SOUND_MIXER_READ_RECSRC
argument_list|,
operator|&
name|recsrc
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|printf
argument_list|(
literal|"SOUND_MIXER_READ_RECSRC: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not PCM_STYLE_SOUND */
ifdef|#
directive|ifdef
name|HAVE_SYS_AUDIOIO_H
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
operator|(
name|int
operator|)
name|AUDIO_GETDEV
argument_list|,
operator|&
name|device
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"audio: name %s, version %s, config %s\n"
argument_list|,
name|device
operator|.
name|name
argument_list|,
name|device
operator|.
name|version
argument_list|,
name|device
operator|.
name|config
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SYS_AUDIOIO_H */
name|ioctl
argument_list|(
name|ctl_fd
argument_list|,
operator|(
name|int
operator|)
name|AUDIO_GETINFO
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|info
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"audio: rate %d, chan %d, prec %d, code %d, gain %d, mon %d, port %d\n"
argument_list|,
name|info
operator|.
name|record
operator|.
name|sample_rate
argument_list|,
name|info
operator|.
name|record
operator|.
name|channels
argument_list|,
name|info
operator|.
name|record
operator|.
name|precision
argument_list|,
name|info
operator|.
name|record
operator|.
name|encoding
argument_list|,
name|info
operator|.
name|record
operator|.
name|gain
argument_list|,
name|info
operator|.
name|monitor_gain
argument_list|,
name|info
operator|.
name|record
operator|.
name|port
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"audio: samples %d, eof %d, pause %d, error %d, waiting %d, balance %d\n"
argument_list|,
name|info
operator|.
name|record
operator|.
name|samples
argument_list|,
name|info
operator|.
name|record
operator|.
name|eof
argument_list|,
name|info
operator|.
name|record
operator|.
name|pause
argument_list|,
name|info
operator|.
name|record
operator|.
name|error
argument_list|,
name|info
operator|.
name|record
operator|.
name|waiting
argument_list|,
name|info
operator|.
name|record
operator|.
name|balance
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* not PCM_STYLE_SOUND */
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|int
name|audio_bs
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_{SYS_AUDIOIO,SUN_AUDIOIO,MACHINE_SOUNDCARD,SYS_SOUNDCARD}_H */
end_comment

end_unit

